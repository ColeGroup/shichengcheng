define("smartCity3D2@1.0.2",["lodash","react","react-dom"],(function(t,e,i){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=30)}([function(t,e,i){var n=i(26);i(27).THREE=n,t.exports=n},function(t,e,i){"use strict";(function(t,n,r){i.d(e,"o",(function(){return li})),i.d(e,"e",(function(){return ze})),i.d(e,"j",(function(){return ro})),i.d(e,"s",(function(){return ns})),i.d(e,"r",(function(){return Vl})),i.d(e,"p",(function(){return yo})),i.d(e,"t",(function(){return ac})),i.d(e,"b",(function(){return O})),i.d(e,"a",(function(){return hi})),i.d(e,"f",(function(){return wi})),i.d(e,"q",(function(){return $l})),i.d(e,"d",(function(){return $i})),i.d(e,"g",(function(){return un})),i.d(e,"h",(function(){return Xr})),i.d(e,"n",(function(){return Bs})),i.d(e,"c",(function(){return sl})),i.d(e,"i",(function(){return So})),i.d(e,"k",(function(){return Ro})),i.d(e,"l",(function(){return Do})),i.d(e,"m",(function(){return xo}));
/*!
 * maptalks v1.0.0-alpha.17
 * LICENSE : BSD-3-Clause
 * (c) 2016-2021 maptalks.org
 */
var o=["MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"],a=["FeatureCollection","Feature","Point","LineString","Polygon"].concat(o),s=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],l=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],c={lineWidth:1,lineOpacity:1,lineDx:1,lineDy:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},h=["lineColor","polygonFill","markerFill","markerLineColor","textFill"],u="[object process]"===Object.prototype.toString.call(void 0!==t?t:0)&&!t.versions.electron&&!t.versions.nw&&!t.versions["node-webkit"],d={};if(!u){var p=navigator.userAgent.toLowerCase(),f=document.documentElement,m="ActiveXObject"in window,g=-1!==p.indexOf("webkit"),y=-1!==p.indexOf("phantom"),_=-1!==p.search("android [23]"),v=-1!==p.indexOf("chrome"),x=-1!==p.indexOf("gecko")&&!g&&!window.opera&&!m,b="undefined"!=typeof orientation||-1!==p.indexOf("mobile"),w=!window.PointerEvent&&window.MSPointerEvent,M=window.PointerEvent&&navigator.pointerEnabled||w,T=m&&"transition"in f.style,S="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!_,E="MozPerspective"in f.style,C="OTransition"in f.style,A=(T||S||E)&&!C&&!y,P=0;v&&(P=p.match(/chrome\/([\d.]+)/)[1]);var L,I=!y&&(M||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch);try{var R=document.createElement("canvas"),D=R.getContext("webgl")||R.getContext("experimental-webgl");L=D&&D instanceof WebGLRenderingContext}catch(t){L=!1}var k=window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI;d={ie:m,ielt9:m&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:g,gecko:x,android:-1!==p.indexOf("android"),android23:_,chrome:v,chromeVersion:P,safari:!v&&-1!==p.indexOf("safari"),phantomjs:y,ie3d:T,webkit3d:S,gecko3d:E,opera12:C,any3d:A,mobile:b,mobileWebkit:b&&g,mobileWebkit3d:b&&S,mobileOpera:b&&window.opera,mobileGecko:b&&x,touch:!!I,msPointer:!!w,pointer:!!M,retina:k>1,devicePixelRatio:k,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:m&&9===document.documentMode,ie10:m&&10===document.documentMode,webgl:L}}var O=d;function z(){return Date.now()}function B(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)t[n]=i[n]}return t}function F(t){return null==t}function N(t){return"number"==typeof t&&!isNaN(t)}function j(t){return(0|t)===t}function G(t){return"object"==typeof t&&!!t}function U(t){return!F(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function V(t){return!F(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}var H=Object.prototype.hasOwnProperty;function Z(t,e){return H.call(t,e)}var W,q,X=Math.PI/180;function Y(t){return t*X}function $(t){return t/X}function J(t){return t.length>4&&".svg"===t.slice(-4)?1:"data:image/svg+xml"===t.slice(0,"data:image/svg+xml".length)?2:0}function K(t,e){u&&K.node?K.node(t,e):t.src=e[0]}!function(){if(u)return W=function(t){return setTimeout(t,16)},void(q=clearTimeout);var t,e;function i(t){return setTimeout(t,1e3/30)}function n(t){return window["webkit"+t]||window["moz"+t]||window["ms"+t]}"undefined"!=typeof window?(t=window.requestAnimationFrame||n("RequestAnimationFrame")||i,e=window.cancelAnimationFrame||n("CancelAnimationFrame")||n("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)}):(t=i,e=clearTimeout),W=function(e){return t(e)},q=function(t){t&&e(t)}}();var Q=0;function tt(){return Q++}var et=tt;function it(t){return t&&U(t)?JSON.parse(t):t}function nt(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];if(i)for(var n=0,r=i.length;n<r;n++)t.push(i[n])}return t.length}function rt(t,e){var i=e.indexOf(t);i>-1&&e.splice(i,1)}function ot(t,e,i){if(!Array.isArray(t))return i?e.call(i,t):e(t);for(var n,r,o=[],a=0,s=t.length;a<s;a++)F(n=t[a])?o.push(null):Array.isArray(n)?o.push(ot(n,e,i)):(r=i?e.call(i,n):e(n),o.push(r));return o}function at(t,e){return void 0===t?e:t}function st(t){return Math.sign?Math.sign(t):0===(t=+t)||isNaN(t)?Number(t):t>0?1:-1}function lt(t){if(Math.log2)return Math.log2(t);var e=Math.log(t)*Math.LOG2E,i=Math.round(e);return Math.abs(i-e)<1e-14?i:e}function ct(t,e,i){return t*(1-i)+e*i}function ht(t,e,i){if(t===i||t===e)return t;var n=i-e;return((t-e)%n+n)%n+e}function ut(t,e,i){return Math.min(i,Math.max(e,t))}function dt(t){return Array.isArray(t)&&t.length>0}var pt=/^([a-z][a-z\d+\-.]*:)?\/\//i;var ft=/^url\((['"])(.+)\1\)$/i,mt=/^url\(([^'"].*[^'"])\)$/i;function gt(t){return U(t)?mt.test(t)?1:ft.test(t)?2:3:0}function yt(t){var e=gt(t);return 3===e?t:1===e?mt.exec(t)[1]:2===e?ft.exec(t)[2]:t}function _t(t){if("undefined"!=typeof window&&window.btoa)return window.btoa(t);for(var e,i,n=String(t),r="",o=0,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";n.charAt(0|o)||(a="=",o%1);r+=a.charAt(63&e>>8-o%1*8)){if((i=n.charCodeAt(o+=3/4))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");e=e<<8|i}return r}function vt(t,e){for(var i=atob(t),n=new ArrayBuffer(i.length),r=new Uint8Array(n),o=0;o<i.length;o++)r[o]=255&i.charCodeAt(o);return new Blob([n],{type:e})}function xt(t,e,i,n){var r=i-t,o=n-e;return Math.atan2(o,r)}var bt="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";function wt(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;for(var i in t)if("center"===i){if(!e[i]||!Mt(t[i][0],e[i][0])||!Mt(t[i][1],e[i][1]))return!1}else if(t[i]!==e[i])return!1;return!0}function Mt(t,e,i){return null==i&&(i=1e-6),t>=e-i&&t<=e+i}function Tt(t,e,i,n){t||(t=100),e||(e=4);var r=this;return e*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout((function o(){if(0===e)return r.show(),void(i&&(n?i.call(n):i()));e%2==0?r.hide():r.show(),e--,r._flashTimeout=setTimeout(o,t)}),t),this}function St(t,e){for(var i=0;i<t.stops.length;i++)if(e===t.stops[i][0])return t.stops[i][1];return t.default}function Et(t,e){for(var i=0;i<t.stops.length&&!(e<t.stops[i][0]);i++);return t.stops[Math.max(i-1,0)][1]}function Ct(t,e){for(var i=void 0!==t.base?t.base:1,n=0;!(n>=t.stops.length||e<=t.stops[n][0]);)n++;return 0===n?t.stops[n][1]:n===t.stops.length?t.stops[n-1][1]:function t(e,i,n,r,o,a){return"function"==typeof o?function(){var s=o.apply(void 0,arguments),l=a.apply(void 0,arguments);return t(e,i,n,r,s,l)}:o.length?function(t,e,i,n,r,o){for(var a=[],s=0;s<r.length;s++)a[s]=Pt(t,e,i,n,r[s],o[s]);return a}(e,i,n,r,o,a):Pt(e,i,n,r,o,a)}(e,i,t.stops[n-1][0],t.stops[n][0],t.stops[n-1][1],t.stops[n][1])}function At(t,e){return i=e,n=t.default,void 0!==i?i:void 0!==n?n:void 0!==r?r:null;var i,n,r}function Pt(t,e,i,n,r,o){var a,s=n-i,l=t-i;return r*(1-(a=1===e?l/s:(Math.pow(e,l)-1)/(Math.pow(e,s)-1)))+o*a}function Lt(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function It(t){for(var e in t)if(Lt(t[e]))return!0;return!1}function Rt(t){return Ot(t,"exponential")}function Dt(t,e){if(!t)return null;var i=!1;if(Array.isArray(t)){for(var n,r=[],o=0;o<t.length;o++)(n=Dt(t[o],e))?(r.push(n),i=!0):r.push(t[o]);return i?r:t}var a,s={__fn_types_loaded:!0},l=[];for(a in t)t.hasOwnProperty(a)&&l.push(a);for(var c=function(t){Object.defineProperty(s,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=Rt(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})},h=0,u=l.length;h<u;h++)Lt(t[a=l[h]])?(i=!0,s["_"+a]=t[a],c(a)):s[a]=t[a];return i?s:t}function kt(t){if(!t||!t.stops)return[];for(var e=[],i=0,n=t.stops.length;i<n;i++)e.push(t.stops[i][1]);return e}function Ot(t,e){if(!Lt(t))return function(){return t};var i=!0,n=!0,r=(t=JSON.parse(JSON.stringify(t))).stops;if(r)for(var o=0;o<r.length;o++)if(Lt(r[o][1])){var a=Ot(r[o][1],e);i=i&&a.isZoomConstant,n=n&&a.isFeatureConstant,r[o]=[r[o][0],a]}var s=function t(e,i){var n,r,o;if(Lt(e)){var a,s=e.stops&&"object"==typeof e.stops[0][0],l=s||void 0!==e.property,c=s||!l,h=e.type||i||"exponential";if("exponential"===h)a=Ct;else if("interval"===h)a=Et;else if("categorical"===h)a=St;else{if("identity"!==h)throw new Error('Unknown function type "'+h+'"');a=At}if(s){for(var u={},d=[],p=0;p<e.stops.length;p++){var f=e.stops[p];void 0===u[f[0].zoom]&&(u[f[0].zoom]={zoom:f[0].zoom,type:e.type,property:e.property,default:e.default,stops:[]}),u[f[0].zoom].stops.push([f[0].value,f[1]])}for(var m in u)d.push([u[m].zoom,t(u[m])]);n=function(t,i){var n=Ct({stops:d,base:e.base},t)(t,i);return"function"==typeof n?n(t,i):n},r=!1,o=!1}else c?(n=function(t){var i=a(e,t);return"function"==typeof i?i(t):i},r=!0,o=!1):(n=function(t,i){var n=a(e,i?i[e.property]:null);return"function"==typeof n?n(t,i):n},r=!1,o=!0)}else n=function(){return e},r=!0,o=!0;return n.isZoomConstant=o,n.isFeatureConstant=r,n}(t,e);return s.isZoomConstant=i&&s.isZoomConstant,s.isFeatureConstant=n&&s.isFeatureConstant,s}var zt=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function Bt(t){return new Function("f","var p = (f && f.properties || {}); return "+Ft(t))}function Ft(t){if(!t)return"true";var e=t[0];return t.length<=1?"any"===e?"false":"true":"("+("=="===e?jt(t[1],t[2],"===",!1):"!="===e?jt(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?jt(t[1],t[2],e,!0):"any"===e?Gt(t.slice(1),"||"):"all"===e?Gt(t.slice(1),"&&"):"none"===e?Ht(Gt(t.slice(1),"||")):"in"===e?Ut(t[1],t.slice(2)):"!in"===e?Ht(Ut(t[1],t.slice(2))):"has"===e?Vt(t[1]):"!has"===e?Ht(Vt(t[1])):"true")+")"}function Nt(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function jt(t,e,i,n){var r=Nt(t),o="$type"===t?zt.indexOf(e):JSON.stringify(e);return(n?"typeof "+r+"=== typeof "+o+"&&":"")+r+i+o}function Gt(t,e){return t.map(Ft).join(e)}function Ut(t,e){"$type"===t&&(e=e.map((function(t){return zt.indexOf(t)})));var i=JSON.stringify(e.sort(Zt)),n=Nt(t);return e.length<=200?i+".indexOf("+n+") !== -1":"function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }("+n+", "+i+",0,"+(e.length-1)+")"}function Vt(t){return"$id"===t?'"id" in f':JSON.stringify(t)+" in p"}function Ht(t){return"!("+t+")"}function Zt(t,e){return t<e?-1:t>e?1:0}function Wt(t){var e=t._toJSON(),i=e.feature;return i.type=zt.indexOf(i.geometry.type),i.subType=e.subType,i}function qt(t){if(!Array.isArray(t))return qt([t]);for(var e=[],i=0;i<t.length;i++){var n=void 0;n=!0===t[i].filter?function(){return!0}:Bt(t[i].filter),e.push(Xt({},t[i],{filter:n}))}return e}function Xt(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)t[n]=i[n]}return t}var Yt=[],$t={};function Jt(t,e){return Dt(t,(function(){var t=e.getMap();return function(t,e,i){return t[0]=e,t[1]=i,t}(Yt,t.getZoom(),B({},e.getProperties(),function(t,e,i,n){return t["{bearing}"]=e,t["{pitch}"]=i,t["{zoom}"]=n,t}($t,t.getBearing(),t.getPitch(),t.getZoom())))}))}function Kt(t){var e={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===e.stroke["stroke-width"]&&(e.stroke["stroke-opacity"]=0),e}function Qt(t,e,i){if(!t.markerPath)return null;var n=1,r=Kt(t);N(t.markerOpacity)&&(n=t.markerOpacity),N(t.opacity)&&(n*=t.opacity);var o={};if(r){for(var a in r.stroke)r.stroke.hasOwnProperty(a)&&(F(r.stroke[a])||(o[a]=r.stroke[a]));for(var s in r.fill)r.fill.hasOwnProperty(s)&&(F(r.fill[s])||(o[s]=r.fill[s]))}for(var l,c=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath],h=[],u=0;u<c.length;u++)(l=B({},l=U(c[u])?{path:c[u]}:c[u],o)).d=l.path,delete l.path,h.push(l);var d=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];n<1&&d.push('opacity="'+n+'"'),t.markerPathWidth&&t.markerPathHeight&&d.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),d.push('preserveAspectRatio="none"'),e&&d.push('width="'+e+'"'),i&&d.push('height="'+i+'"'),d.push("><defs></defs>");for(var p=0;p<h.length;p++){var f="<path ";for(var m in h[p])h[p].hasOwnProperty(m)&&(f+=" "+m+'="'+h[p][m]+'"');f+="></path>",d.push(f)}return d.push("</svg>"),"data:image/svg+xml;base64,"+_t(d.join(" "))}function te(t,e){if(!t)return[];var i=t;Array.isArray(t)||(i=[t]);for(var n,r,o,a,c=[],h=s,u=i.length-1;u>=0;u--)if(t=i[u]){e&&(t=ee(t));for(var d=0;d<h.length;d++)if(Lt(n=t[h[d]])&&(n=kt(n)),n){Array.isArray(n)||(n=[n]);for(var p=0;p<n.length;p++)"url("===n[p].slice(0,4)&&(n[p]=yt(n[p])),r=l[d],c.push([n[p],t[r[0]],t[r[1]]])}if("path"===t.markerType&&t.markerPath)if(o=Lt(t.markerWidth)?200:t.markerWidth,a=Lt(t.markerHeight)?200:t.markerHeight,Lt(t.markerPath)){n=kt(t.markerPath);for(var f=t.markerPath,m=0;m<n.length;m++)t.markerPath=n[m],c.push([Qt(t),o,a]);t.markerPath=f}else c.push([Qt(t),o,a])}return c}function ee(t){if(!t)return null;var e=t;if(u)return e;for(var i,n=s,r=0,o=n.length;r<o;r++)(i=e[n[r]])&&(e[n[r]]=ie(i));return e}function ie(t){if(Lt(t)){for(var e=t.stops,i=0;i<e.length;i++)e[i][1]=ie(e[i][1]);return t}return"url("===t.slice(0,4)&&(t=yt(t)),t}function ne(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function re(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var oe=function(){function t(t,e){if(F(t)||F(e)?F(t.x)||F(t.y)?Array.isArray(t)&&(this.x=+t[0],this.y=+t[1]):(this.x=+t.x,this.y=+t.y):(this.x=+t,this.y=+e),this._isNaN())throw new Error("Position is NaN")}var e=t.prototype;return e.set=function(t,e){return this.x=t,this.y=e,this},e.abs=function(){return new this.constructor(Math.abs(this.x),Math.abs(this.y))},e._abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},e._round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},e.round=function(){return new this.constructor(Math.round(this.x),Math.round(this.y))},e._ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},e.ceil=function(){return new this.constructor(Math.ceil(this.x),Math.ceil(this.y))},e.distanceTo=function(t){var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)},e.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e._floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},e.floor=function(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))},e.copy=function(){return new this.constructor(this.x,this.y)},e._add=function(t,e){return F(t.x)?F(t[0])?(this.x+=t,this.y+=e):(this.x+=t[0],this.y+=t[1]):(this.x+=t.x,this.y+=t.y),this},e.add=function(t,e){var i,n;return F(t.x)?F(t[0])?(i=this.x+t,n=this.y+e):(i=this.x+t[0],n=this.y+t[1]):(i=this.x+t.x,n=this.y+t.y),new this.constructor(i,n)},e._sub=function(t,e){return F(t.x)?F(t[0])?(this.x-=t,this.y-=e):(this.x-=t[0],this.y-=t[1]):(this.x-=t.x,this.y-=t.y),this},e._substract=function(){return this._sub.apply(this,arguments)},e.sub=function(t,e){var i,n;return F(t.x)?F(t[0])?(i=this.x-t,n=this.y-e):(i=this.x-t[0],n=this.y-t[1]):(i=this.x-t.x,n=this.y-t.y),new this.constructor(i,n)},e.substract=function(){return this.sub.apply(this,arguments)},e.multi=function(t){return new this.constructor(this.x*t,this.y*t)},e._multi=function(t){return this.x*=t,this.y*=t,this},e.div=function(t){return this.multi(1/t)},e._div=function(t){return this._multi(1/t)},e.equals=function(t){return t instanceof this.constructor&&(this.x===t.x&&this.y===t.y)},e._isNaN=function(){return isNaN(this.x)||isNaN(this.y)},e.isZero=function(){return 0===this.x&&0===this.y},e.toArray=function(){return[this.x,this.y]},e.toFixed=function(t){return new this.constructor(this.x.toFixed(t),this.y.toFixed(t))},e.toJSON=function(){return{x:this.x,y:this.y}},t}(),ae=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.closeTo=function(t,e){return e||(e=0),this.x>=t.x-e&&this.x<=t.x+e&&this.y>=t.y-e&&this.y<=t.y+e},i.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},i.unit=function(){return this.copy()._unit()},i._unit=function(){return this._div(this.mag()),this},i.perp=function(){return this.copy()._perp()},i._perp=function(){var t=this.y;return this.y=this.x,this.x=-t,this},i.angleWith=function(t){return this.angleWithSep(t.x,t.y)},i.angleWithSep=function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},i._rotate=function(t){var e=Math.cos(t),i=Math.sin(t),n=e*this.x-i*this.y,r=i*this.x+e*this.y;return this.x=n,this.y=r,this},i.rotate=function(t){return this.copy()._rotate(t)},e}(oe),se=function(){function t(t,e){N(t)&&N(e)?(this.width=t,this.height=e):N(t.width)?(this.width=t.width,this.height=t.height):Array.isArray(t)&&(this.width=t[0],this.height=t[1])}var e=t.prototype;return e.copy=function(){return new t(this.width,this.height)},e.add=function(e,i){var n,r;return e instanceof t?(n=this.width+e.width,r=this.height+e.height):(n=this.width+e,r=this.height+i),new t(n,r)},e.equals=function(t){return this.width===t.width&&this.height===t.height},e.multi=function(e){return new t(this.width*e,this.height*e)},e._multi=function(t){return this.width*=t,this.height*=t,this},e._round=function(){return this.width=Math.round(this.width),this.height=Math.round(this.height),this},e.toPoint=function(){return new ae(this.width,this.height)},e.toArray=function(){return[this.width,this.height]},e.toJSON=function(){return{width:this.width,height:this.height}},t}(),le=u?function(t){return t[0]}:function(t){for(var e=document.documentElement.style,i=0;i<t.length;i++)if(t[i]in e)return t[i];return!1},ce=le(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),he=le(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),ue=le(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]),de=le(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]);function pe(t,e){var i=document.createElement(t);return e&&Ae(i,e),i}function fe(t,e,i){var n=pe(t);return e&&Se(n,e),i&&i.appendChild(n),n}function me(t){if(!t)return this;if(O.ielt9||O.ie9){var e=pe("div");e.appendChild(t),e.innerHTML="",e=null}else t.parentNode&&t.parentNode.removeChild(t);return this}function ge(t,e,i,n){if(!(t&&t.addEventListener&&e&&i))return this;for(var r=function(e){e||(e=window.event),i.call(n||t,e)},o=e.split(" "),a=o.length-1;a>=0;a--){var s=o[a];if(s)t["Z__"+s]||(t["Z__"+s]=[]),_e(t,s,i)>=0&&ye(t,s,i),t["Z__"+s].push({callback:r,src:i}),O.ie?t.addEventListener(s,r,!1):t.addEventListener(s,r,{capture:!1,passive:!1})}return this}function ye(t,e,i){function n(e,i){"mousewheel"===e&&O.gecko&&(e="DOMMouseScroll"),t.removeEventListener(e,i,!1)}if(!t||!t.removeEventListener||!e)return this;for(var r=e.split(" "),o=r.length-1;o>=0;o--){var a=r[o];if(a){if(!i&&t["Z__"+a]){for(var s=t["Z__"+a],l=0,c=s.length;l<c;l++)n(s[l].callback);return delete t["Z__"+a],this}var h=_e(t,a,i);if(h<0)return this;n(a,t["Z__"+a][h].callback),t["Z__"+a].splice(h,1)}}return this}function _e(t,e,i){if(!t||!t["Z__"+e]||!i)return-1;for(var n=t["Z__"+e],r=0,o=n.length;r<o;r++)if(n[r].src===i)return r;return-1}function ve(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this}function xe(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this}function be(t){return t.onselectstart=function(){return!1},t.ondragstart=function(){return!1},t.setAttribute("unselectable","on"),this}function we(t,e){return t?(O.any3d?Le(t,e):(t.style.left=e.x+"px",t.style.top=e.y+"px"),e):null}function Me(t){var e=window.getComputedStyle(t),i=[parseInt(e["padding-left"]),parseInt(e["padding-top"])],n=t.getBoundingClientRect(),r=t.offsetWidth,o=t.offsetHeight,a=r?n.width/r:1,s=o?n.height/o:1;return t.__position=[n.left+i[0],n.top+i[1],a,s],t.__position}function Te(t,e){t||(t=window.event);var i=e.__position;return i||(i=Me(e)),new ae((t.clientX-i[0]-e.clientLeft)/i[2],(t.clientY-i[1]-e.clientTop)/i[3])}function Se(t,e){var i,n,r,o=t.style.cssText;return n=";",(r=(i=o).length-n.length)>=0&&i.indexOf(n,r)===r||(o+=";"),t.style.cssText=o+e,this}function Ee(t,e){if(void 0!==t.classList)return t.classList.contains(e);var i=Pe(t);return i.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(i)}function Ce(t,e){if(void 0===t.classList||Ee(t,e)){var i=Pe(t);Ae(t,(i?i+" ":"")+e)}else for(var n=je(e),r=0,o=n.length;r<o;r++)t.classList.add(n[r]);return this}function Ae(t,e){return F(t.className.baseVal)?t.className=e:t.className.baseVal=e,this}function Pe(t){return F(t.className.baseVal)?t.className:t.className.baseVal}function Le(t,e){var i=e||new ae(0,0);return t.style[ce]=O.any3d?"translate3d("+i.x+"px,"+i.y+"px,0px)":"translate("+i.x+"px,"+i.y+"px)",this}function Ie(t){return/<[a-z\][\s\S]*>/i.test(t)}function Re(t,e){var i=De(t);U(e)?i.innerHTML=e:i.appendChild(e);var n=new se(i.clientWidth,i.clientHeight);return me(i),n}function De(t){var e=document.createElement(t);return e.style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(e),e}var ke=ge,Oe=ye,ze=Object.freeze({TRANSFORM:ce,TRANSFORMORIGIN:he,TRANSITION:ue,CSSFILTER:de,createEl:pe,createElOn:fe,removeDomNode:me,addDomEvent:ge,removeDomEvent:ye,listensDomEvent:_e,preventDefault:ve,stopPropagation:xe,preventSelection:be,offsetDom:we,computeDomPosition:Me,getEventContainerPoint:Te,setStyle:Se,hasClass:Ee,addClass:Ce,setClass:Ae,getClass:Pe,setOpacity:function(t,e){return t.style.opacity=e,this},setTransform:Le,setTransformMatrix:function(t,e){var i="matrix("+(U(e)?e:e.join())+")";return t.style[ce]!==i&&(t.style[ce]=i),this},removeTransform:function(t){return t.style[ce]&&(t.style[ce]=""),this},isHTML:Ie,measureDom:Re,getDomRuler:De,on:ke,off:Oe});function Be(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}var Fe=/[\b\t\r\v\f]/gim;function Ne(t){return U(t)?t.replace(Fe,""):t}function je(t){return Be(t).split(/\s+/)}var Ge="undefined"!=typeof document?document.createElement("canvas").getContext("2d"):null;function Ue(t,e){return Ue.node?Ue.node(t,e):(Ge.font=e,Ge.measureText(t).width)}function Ve(t,e,i){var n=Ue(t,e);return new se(n,i||14)}function He(t,e,i,n){if(!t||0===t.length)return[{text:"",width:0}];var r=F(n)?Ue(t,e):n,o=r/t.length,a=Math.floor(i/o/2);if(o>=i||a<=0)return[{text:"",width:i}];if(r<=i)return[{text:t,width:r}];for(var s=[],l=t.substring(0,a),c=o*a,h=a,u=t.length;h<u;h++){var d=t[h],p=Ue(l+d);p>=i?(s.push({text:l,width:c}),l=t.substring(h,a+h),h+=a-1,c=o*a):(l+=d,c=p),h>=u-1&&(c=Ue(l),s.push({text:l,width:c}))}return s}var Ze=/\{([\w_]+)\}/g;function We(t,e){return U(t)?t.replace(Ze,(function(t,i){if(!e)return"";var n=e[i];return F(n)?"":Array.isArray(n)?n.join():n})):t}function qe(t,e){var i=e.textMaxHeight||0,n=$e(t,e);return i&&i<n.size.height&&(n.size.height=i),n}function Xe(t,e,i){var n=t.width,r=t.height;return new ae("left"===e?-n:"right"===e?0:-n/2,"top"===i?-r:"bottom"===i?0:-r/2)}function Ye(t){return t.textFont?t.textFont:(t.textStyle&&"normal"!==t.textStyle?t.textStyle+" ":"")+(t.textWeight&&"normal"!==t.textWeight?t.textWeight+" ":"")+t.textSize+"px "+(t.textFaceName?'"'===t.textFaceName[0]?t.textFaceName:'"'+t.textFaceName+'"':"monospace")}function $e(t,e){var i=Ye(e),n=e.textLineSpacing||0,r=Ve(t,i,e.textSize),o=r.width,a=r.height,s=e.textWrapCharacter,l=[],c=e.textWrapWidth;(!c||c>o)&&(c=o),U(t)||(t+="");var h=0;if(s&&t.indexOf(s)>=0)for(var u=t.split(s),d=0,p=u.length;d<p;d++){var f=u[d],m=Ue(f,i);if(m>c)for(var g=He(f,i,c,m),y=0,_=g.length;y<_;y++){var v=g[y].width;v>h&&(h=v),l.push({text:g[y].text,size:new se(v,a)})}else m>h&&(h=m),l.push({text:f,size:new se(m,a)})}else if(o>c)for(var x=He(t,i,c,o),b=0;b<x.length;b++){var w=x[b].width;w>h&&(h=w),l.push({text:x[b].text,size:new se(w,a)})}else o>h&&(h=o),l.push({text:t,size:r});var M=l.length;return{total:M,size:new se(h,a*M+n*(M-1)),rows:l,rawSize:r}}function Je(t){var e=0,i=t&&t.length||0;if(!i)return e;for(var n=0;n<i;n++)e=(e<<5)-e+t.charCodeAt(n),e&=e;return e}function Ke(t){return t&&t.colorStops}function Qe(t){var e=[t.type];if(t.places&&e.push(t.places.join()),t.colorStops){for(var i=[],n=t.colorStops.length-1;n>=0;n--)i.push(t.colorStops[n].join());e.push(i.join(","))}return e.join("_")}function ti(t,e){if(!t)return 1;var i=[];if(Array.isArray(t)){for(var n=0;n<t.length;n++)i.push(ti(t[n],e));return i.sort().join(",")}var r=Object.keys(t).sort().reduce((function(i,n){return e&&0!==n.indexOf(e)||(i[n]=t[n]),i}),{});return Je(JSON.stringify(r))}function ei(t,e){function i(t,e){F(t.opacity)?t.opacity=e:t.opacity*=e}var n;if(Array.isArray(t)){n=[];for(var r=0;r<t.length;r++){var o=B({},t[r]);i(o,e),n.push(o)}}else i(n=B({},t),e);return n}function ii(t){var e=Array.prototype.slice.call(arguments,1);if(e&&e.length||(e=[{}]),Array.isArray(t)){for(var i,n,r=[],o=0,a=t.length;o<a;o++){i=t[o],n={};for(var s=0,l=e.length;s<l;s++)Array.isArray(e[s])?F(e[s][o])?B(n,i||{}):B(n,i,e[s][o]):B(n,i,e[s]?e[s]:{});r.push(n)}return r}var c=[{},t];return c.push.apply(c,e),B.apply(this,c)}function ni(t){if(t.symbol&&(t=[t]),Array.isArray(t))return t;var e=t.$root,i=t.$iconset;if(t=t.style,e||i){e&&"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),i&&"/"===i[i.length-1]&&(i=i.substring(0,i.length-1));ri(t,(function(t){return"{$root}"===t?e:"{$iconset}"===t?i:null}))}return t}function ri(t,e){for(var i=0;i<t.length;i++){var n=t[i].symbol;n&&ai(n,e)}}var oi=/(\{\$root\}|\{\$iconset\})/g;function ai(t,e){for(var i in t)t.hasOwnProperty(i)&&"textName"!==i&&(U(t[i])&&t[i].length>2?t[i]=t[i].replace(oi,e):Lt(t[i])?t[i]=si(t[i],e):G(t[i])&&ai(t[i],e))}function si(t,e){var i=t.default;U(i)&&(t.default=i.replace(oi,e));for(var n=t.stops,r=0;r<n.length;r++)Array.isArray(n[r])&&(U(n[r][1])?n[r][1]=n[r][1].replace(oi,e):Lt(n[r][1])&&(n[r][1]=si(n[r][1],e)));return t}var li=Object.freeze({now:z,extend:B,isNil:F,isNumber:N,isInteger:j,isObject:G,isString:U,isFunction:V,hasOwn:Z,join:function(t,e){return t.join?t.join(e||","):Array.prototype.join.call(t,e||",")},isEmpty:function(t){var e;for(e in t)return!1;return!e},toRadian:Y,toDegree:$,IS_NODE:u,get requestAnimFrame(){return W},get cancelAnimFrame(){return q},isSVG:J,loadImage:K,UID:tt,GUID:et,parseJSON:it,pushIn:nt,removeFromArray:rt,forEachCoord:ot,getValueOrDefault:at,sign:st,log2:lt,interpolate:ct,wrap:ht,clamp:ut,isArrayHasData:dt,isURL:function(t){return pt.test(t)},isCssUrl:gt,extractCssUrl:yt,btoa:_t,b64toBlob:vt,computeDegree:xt,emptyImageUrl:bt,equalMapView:wt,flash:Tt,_defaults:function(t,e){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=i[n],o=Object.getOwnPropertyDescriptor(e,r);o&&o.configurable&&void 0===t[r]&&Object.defineProperty(t,r,o)}return t},translateToSVGStyles:Kt,getMarkerPathBase64:Qt,getExternalResources:te,convertResourceUrl:ee,isGradient:Ke,getGradientStamp:Qe,getSymbolStamp:function(t,e){return ti(t,e)},getSymbolHash:ti,lowerSymbolOpacity:ei,extendSymbol:ii,parseStyleRootPath:ni,convertStylePath:ri,parseSymbolPath:ai}),ci=function(){function t(t,e){this.max=t,this.onRemove=e,this.reset()}var e=t.prototype;return e.reset=function(){for(var t in this.data)this.onRemove(this.data[t]);return this.data={},this.order=[],this},e.clear=function(){this.reset(),delete this.onRemove},e.add=function(t,e){if(this.has(t))this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t);else if(this.data[t]=e,this.order.push(t),this.order.length>this.max){var i=this.getAndRemove(this.order[0]);i&&this.onRemove(i)}return this},e.has=function(t){return t in this.data},e.keys=function(){return this.order},e.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e},e.get=function(t){return this.has(t)?this.data[t]:null},e.remove=function(t){if(!this.has(t))return this;var e=this.data[t];return delete this.data[t],this.onRemove(e),this.order.splice(this.order.indexOf(t),1),this},e.setMaxSize=function(t){for(this.max=t;this.order.length>this.max;){var e=this.getAndRemove(this.order[0]);e&&this.onRemove(e)}return this},t}(),hi={jsonp:function(t,e){var i="_maptalks_jsonp_"+tt();t.match(/\?/)?t+="&callback="+i:t+="?callback="+i;var n=document.createElement("script");return n.type="text/javascript",n.src=t,window[i]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[i]},document.getElementsByTagName("head")[0].appendChild(n),this},get:function(t,e,i){if(V(e)){var n=i;i=e,e=n}if(u&&hi.get.node)return hi.get.node(t,i,e);var r=hi._getClient(i);if(r.open("GET",t,!0),e){for(var o in e.headers)r.setRequestHeader(o,e.headers[o]);r.withCredentials="include"===e.credentials,e.responseType&&(r.responseType=e.responseType)}return r.send(null),r},post:function(t,e,i){var n;if(U(t)){if(V(e)){var r=i;i=e,e=r}n=(e=e||{}).postData}else{var o=i;n=e,t=(e=t).url,i=o}if(u&&hi.post.node)return e.url=t,hi.post.node(e,n,i);var a=hi._getClient(i);if(a.open("POST",e.url,!0),e.headers||(e.headers={}),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in a)for(var s in e.headers)e.headers.hasOwnProperty(s)&&a.setRequestHeader(s,e.headers[s]);return U(n)||(n=JSON.stringify(n)),a.send(n),a},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){var e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=hi._wrapCallback(e,t),e},getArrayBuffer:function(t,e,i){if(V(e)){var n=i;i=e,e=n}return e||(e={}),e.responseType="arraybuffer",hi.get(t,e,i)},getImage:function(t,e,i){return hi.getArrayBuffer(e,i,(function(e,i){if(e)t.onerror&&t.onerror(e);else if(i){var n=window.URL||window.webkitURL,r=t.onload;t.onload=function(){r&&r(),n.revokeObjectURL(t.src)};var o=new Blob([new Uint8Array(i.data)],{type:i.contentType});t.cacheControl=i.cacheControl,t.expires=i.expires,t.src=i.data.byteLength?n.createObjectURL(o):bt}}))},getJSON:function(t,e,i){if(V(e)){var n=i;i=e,e=n}var r=function(t,e){var n=e?it(e):null;i(t,n)};return e&&e.jsonp?hi.jsonp(t,r):hi.get(t,e,r)}},ui=!1,di=null,pi=Math.PI/180,fi={setHitTesting:function(t){ui=t},createCanvas:function(t,e,i){var n;return u?n=new i(t,e):((n=pe("canvas")).width=t,n.height=e),n},prepareCanvasFont:function(t,e){t.textBaseline="top",t.font=Ye(e);var i=e.textFill;i||(i="#000"),t.fillStyle=fi.getRgba(i,e.textOpacity)},prepareCanvas:function(t,e,i,n){if(e){var r=e.lineWidth;F(r)||t.lineWidth===r||(t.lineWidth=r);var o=e.linePatternFile,a=e.lineColor||"#000";if(n)t.strokeStyle="#000";else if(o&&i){var s;(e.linePatternDx||e.linePatternDy)&&(s=[e.linePatternDx,e.linePatternDy]),fi._setStrokePattern(t,o,r,s,i),e.lineDasharray=[]}else Ke(a)?e.lineGradientExtent?t.strokeStyle=fi._createGradient(t,a,e.lineGradientExtent):t.strokeStyle="#000":t.strokeStyle=a;e.lineJoin&&(t.lineJoin=e.lineJoin),e.lineCap&&(t.lineCap=e.lineCap),t.setLineDash&&dt(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var l=e.polygonPatternFile,c=e.polygonFill||"rgba(255,255,255,0)";if(n)t.fillStyle="#000";else if(l&&i){var h=gi(l),u=i.getImage([h,null,null]);if(u||(u=i.getImage([h+"-texture",null,r])),J(h)&&u instanceof Image&&(O.edge||O.ie)){var d=u.width||20,p=u.height||20,f=fi.createCanvas(d,p);fi.image(f.getContext("2d"),u,0,0,d,p),u=f}u?(t.fillStyle=t.createPattern(u,"repeat"),(e.polygonPatternDx||e.polygonPatternDy)&&(t.fillStyle.polygonPatternOffset=[e.polygonPatternDx,e.polygonPatternDy])):"undefined"!=typeof console&&console.warn("img not found for",h)}else Ke(c)?e.polygonGradientExtent?t.fillStyle=fi._createGradient(t,c,e.polygonGradientExtent):t.fillStyle="rgba(255,255,255,0)":t.fillStyle=c}},_createGradient:function(t,e,i){var n=null,r=e.places,o=i.getMin(),a=i.getMax(),s=i.getWidth(),l=i.getHeight();if(e.type&&"linear"!==e.type){if("radial"===e.type){if(r){if(6!==r.length)throw new Error("A radial gradient's places should have 6 numbers.");r=[o.x+r[0]*s,o.y+r[1]*l,s*r[2],o.x+r[3]*s,o.y+r[4]*l,s*r[5]]}else{var c=i.getCenter()._round();r=[c.x,c.y,Math.abs(c.x-o.x),c.x,c.y,0]}n=t.createRadialGradient.apply(t,r)}}else{if(r){if(4!==r.length)throw new Error("A linear gradient's places should have 4 numbers.");r=[o.x+r[0]*s,o.y+r[1]*l,o.x+r[2]*s,o.y+r[3]*l]}else r=[o.x,o.y,a.x,o.y];n=t.createLinearGradient.apply(t,r)}return e.colorStops.forEach((function(t){n.addColorStop.apply(n,t)})),n},_setStrokePattern:function(t,e,i,n,r){var o,a=gi(e);if(u)o=r.getImage([a,null,i]);else{var s=a+"-texture-"+i;if(!(o=r.getImage(s))){var l=r.getImage([a,null,null]);if(l){var c;c=l.width&&l.height?Math.round(l.width*i/l.height):i;var h=fi.createCanvas(c,i,t.canvas.constructor);fi.image(h.getContext("2d"),l,0,0,c,i),r.addResource([s,null,i],h),o=h}}}o?(t.strokeStyle=t.createPattern(o,"repeat"),t.strokeStyle.linePatternOffset=n):"undefined"!=typeof console&&console.warn("img not found for",a)},clearRect:function(t,e,i,n,r){t.canvas._drawn=!1,t.clearRect(e,i,n,r)},fillCanvas:function(t,e,i,n){if(ui&&(e=1),t.canvas._drawn=!0,0!==e){var r,o=fi._isPattern(t.fillStyle),a=t.fillStyle&&t.fillStyle.polygonPatternOffset,s=a?a[0]:0,l=a?a[1]:0;F(e)&&(e=1),e<1&&(r=t.globalAlpha,t.globalAlpha*=e),o&&(i=i||0,n=n||0,t.translate(i+s,n+l)),t.fill(),o&&t.translate(-i-s,-n-l),e<1&&(t.globalAlpha=r)}},getRgba:function(t,e){return F(e)&&(e=1),"#"!==t[0]?t:(7===t.length?(i=parseInt(t.substring(1,3),16),n=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16)):(i=17*parseInt(t.substring(1,2),16),n=17*parseInt(t.substring(2,3),16),r=17*parseInt(t.substring(3,4),16)),"rgba("+i+","+n+","+r+","+e+")");var i,n,r},image:function(t,e,i,n,r,o){t.canvas._drawn=!0;try{N(r)&&N(o)?t.drawImage(e,i,n,r,o):t.drawImage(e,i,n)}catch(t){console&&(console.warn("error when drawing image on canvas:",t),console.warn(e))}},text:function(t,e,i,n,r){fi._textOnMultiRow(t,r.rows,n,i,r.size,r.rawSize)},_textOnMultiRow:function(t,e,i,n,r,o){for(var a,s,l=Xe(r,i.textHorizontalAlignment,i.textVerticalAlignment),c=o.height+i.textLineSpacing,h=n.add(0,l.y),u=i.textMaxHeight,d=0,p=0,f=e.length;p<f&&(a=e[p].text,s=Xe(e[p].size,i.textHorizontalAlignment,i.textVerticalAlignment),fi._textOnLine(t,a,h.add(s.x,p*c),i.textHaloRadius,i.textHaloFill,i.textHaloOpacity),!(u>0&&(d+=c)+o.height>=u));p++);},_textOnLine:function(t,e,i,n,r,o){ui&&(o=1);var a,s,l=0!==o&&0!==n;t.textBaseline="top";var c=t.shadowBlur,h=t.shadowOffsetX,u=t.shadowOffsetY;if(l){var d=t.globalAlpha;t.globalAlpha*=o,t.miterLimit=2,t.lineJoin="round",t.lineCap="round",t.lineWidth=2*n,t.strokeStyle=r,t.strokeText(e,i.x,i.y+1),t.miterLimit=10,t.globalAlpha=d,a=t.globalCompositeOperation,t.globalCompositeOperation="destination-out",s=t.fillStyle,t.fillStyle="#000"}c&&l&&(t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0),fi.fillText(t,e,i),a&&(t.globalCompositeOperation=a,fi.fillText(t,e,i,s),c&&(t.shadowBlur=c,t.shadowOffsetX=h,t.shadowOffsetY=u))},fillText:function(t,e,i,n){t.canvas._drawn=!0,n&&(t.fillStyle=n),t.fillText(e,i.x,i.y+1)},_stroke:function(t,e,i,n){if(ui&&(e=1),t.canvas._drawn=!0,0!==e){var r,o=t.strokeStyle&&t.strokeStyle.linePatternOffset,a=o?o[0]:0,s=o?o[1]:0,l=fi._isPattern(t.strokeStyle)&&(!F(i)&&!F(n)||!F(a)&&!F(s));F(e)&&(e=1),e<1&&(r=t.globalAlpha,t.globalAlpha*=e),l&&(i=i||0,n=n||0,t.translate(i+a,n+s)),t.stroke(),l&&t.translate(-i-a,-n-s),e<1&&(t.globalAlpha=r)}},_path:function(t,e,i,n,r){if(dt(e))for(var o,a,s=dt(i),l=!0!==r&&fi._isPattern(t.strokeStyle),c=0,h=e.length;c<h;c++)if(o=e[c],!s||t.setLineDash)t.lineTo(o.x,o.y),l&&c>0&&(u(e[c-1],o),t.beginPath(),t.moveTo(o.x,o.y));else if(s){if(c===h-1)break;a=e[c+1],mi(t,o,a,i)}function u(e,i){var r=xt(e.x,e.y,i.x,i.y);t.save();var o=Math.cos(r);Math.abs(o)<1e-7?t.translate(e.x-t.lineWidth/2,e.y):t.translate(e.x,e.y-t.lineWidth/2/o),t.rotate(r),fi._stroke(t,n),t.restore()}},path:function(t,e,i,n,r){dt(e)&&(t.beginPath(),t.moveTo(e[0].x,e[0].y),fi._path(t,e,r,i),fi._stroke(t,i))},_multiClip:function(t,e){if(e&&0!==e.length)for(var i=0,n=(e=e[0]).length;i<n;i++){var r=e[i],o=r.x,a=r.y;0===i?t.moveTo(o,a):t.lineTo(o,a),i===n-1&&(o=e[0].x,a=e[0].y,t.lineTo(o,a))}},polygon:function(t,e,i,n,r,o){if(t.isMultiClip)fi._multiClip(t,e);else if(dt(e)){var a=fi._isPattern(t.strokeStyle),s=dt(r)&&!t.setLineDash||a&&!o;dt(e[0])||(e=[e]);var l,c,h,d=t;if(e.length>1&&!u&&(di||(di=fi.createCanvas(1,1)),t.canvas._drawn=!1,di.width=t.canvas.width,di.height=t.canvas.height,yi(t=di.getContext("2d"),d)),s){for(t.save(),c=0,h=e.length;c<h;c++)dt(e[c])&&(fi._ring(t,e[c],null,0,!0),l=n,c>0&&(t.globalCompositeOperation="destination-out",l=1),fi.fillCanvas(t,l,e[c][0].x,e[c][0].y),c>0?t.globalCompositeOperation="source-over":h>1&&(t.fillStyle="#fff"),fi._stroke(t,0));t.restore()}for(c=0,h=e.length;c<h;c++)dt(e[c])&&(o?(fi.paintSmoothLine(t,e[c],i,o,!0),t.closePath()):fi._ring(t,e[c],r,i),s||(l=n,c>0&&(t.globalCompositeOperation="destination-out",l=1),fi.fillCanvas(t,l,e[c][0].x,e[c][0].y),c>0?t.globalCompositeOperation="source-over":h>1&&(t.fillStyle="#fff")),fi._stroke(t,i));e.length>1&&!u&&(d.drawImage(di,0,0),d.canvas._drawn=t.canvas._drawn,yi(d,t))}},_ring:function(t,e,i,n,r){var o=fi._isPattern(t.strokeStyle);r||!o||e[0].equals(e[e.length-1])||(e=e.concat([e[0]])),t.beginPath(),t.moveTo(e[0].x,e[0].y),fi._path(t,e,i,n,r),o||t.closePath()},paintSmoothLine:function(t,e,i,n,r,o,a){if(e)if(e.length<=2||!n)fi.path(t,e,i);else{var s,l=e.length,c=r?l:l-1;t.beginPath(),t.moveTo(e[0].x,e[0].y),void 0!==a&&(c-=Math.max(c-o-1,0));for(var h=0;h<c;h++){var u=e[h].x,d=e[h].y,p=void 0,f=void 0,m=void 0,g=void 0,y=void 0,_=void 0;h-1<0?r?(p=e[c-1].x,f=e[c-1].y):(p=e[h+1].x,f=e[h+1].y):(p=e[h-1].x,f=e[h-1].y),h+1<l?(m=e[h+1].x,g=e[h+1].y):(m=e[h+1-l].x,g=e[h+1-l].y),h+2<l?(y=e[h+2].x,_=e[h+2].y):r?(y=e[h+2-l].x,_=e[h+2-l].y):(y=e[h].x,_=e[h].y);var v=b(p,f,u,d,m,g,y,_,n,h===c-1?a:1);if(h===c-1&&a>=0&&a<1){t.bezierCurveTo(v[0],v[1],v[2],v[3],v[4],v[5]),e.splice(c-1,l-(c-1)-1);var x=new ae(v[4],v[5]);x.prevCtrlPoint=new ae(v[2],v[3]),e.push(x),l=e.length}else t.bezierCurveTo(v[0],v[1],v[2],v[3],m,g);e[h].nextCtrlPoint=v.slice(0,2),e[h].prevCtrlPoint=s?s.slice(2):null,s=v}!r&&e[1].prevCtrlPoint&&(e[0].nextCtrlPoint=e[1].prevCtrlPoint,delete e[0].prevCtrlPoint),e[l-1].prevCtrlPoint||(e[l-1].prevCtrlPoint=e[l-2].nextCtrlPoint),fi._stroke(t,i)}function b(t,e,i,n,r,o,a,s,l,c){var h=(t+i)/2,u=(e+n)/2,d=(i+r)/2,p=(n+o)/2,f=(r+a)/2,m=(o+s)/2,g=Math.sqrt((i-t)*(i-t)+(n-e)*(n-e)),y=Math.sqrt((r-i)*(r-i)+(o-n)*(o-n)),_=g/(g+y),v=y/(y+Math.sqrt((a-r)*(a-r)+(s-o)*(s-o))),x=h+(d-h)*_,b=u+(p-u)*_,w=d+(f-d)*v,M=p+(m-p)*v,T=x+(d-x)*l+i-x,S=b+(p-b)*l+n-b,E=w+(d-w)*l+r-w,C=M+(p-M)*l+o-M,A=[T,S,E,C];return c<1?function(t,e,i,n,r,o,a,s,l,c){var h=1-t,u=1-e,d=i*u*u+2*r*e*u+a*e*e,p=r*u*u+2*a*e*u+l*e*e,f=n*u*u+2*o*e*u+s*e*e,m=o*u*u+2*s*e*u+c*e*e;return[(i*h*h+2*r*t*h+a*t*t)*u+(r*h*h+2*a*t*h+l*t*t)*e,(n*h*h+2*o*t*h+s*t*t)*u+(o*h*h+2*s*t*h+c*t*t)*e,d*h+p*t,f*h+m*t,d*u+p*e,f*u+m*e]}(0,c,i,n,T,S,E,C,r,o):A}},_arcBetween:function(t,e,i,n){var r=n,o=e.distanceTo(i),a=o/2/Math.sin(r/2),s=Math.asin((i.y-e.y)/o);e.x>i.x&&(s=Math.PI-s);var l=s-(90*pi-r/2),c=Math.cos(l)*a,h=Math.sin(l)*a,u=e.x+c,d=e.y+h,p=Math.asin((i.y-d)/a);u>i.x&&(p=Math.PI-p);var f=p+r;return t.beginPath(),t.arc(u,d,a,p,f),[u,d]},_lineTo:function(t,e){t.lineTo(e.x,e.y)},bezierCurveAndFill:function(t,e,i,n){t.beginPath();var r=e[0];t.moveTo(r.x,r.y);var o=[t];o.push.apply(o,e.splice(1)),fi._bezierCurveTo.apply(fi,o),fi.fillCanvas(t,n),fi._stroke(t,i)},_bezierCurveTo:function(t,e,i,n){t.bezierCurveTo(e.x,e.y,i.x,i.y,n.x,n.y)},ellipse:function(t,e,i,n,r,o,a){var s,l,c,h,u,d,p,f,m;t.beginPath(),i===n&&i===r?t.arc(e.x,e.y,i,0,2*Math.PI):t.ellipse?n!==r?(t.ellipse(e.x,e.y,i,n,0,180*pi,360*pi,!1),t.ellipse(e.x,e.y,i,r,0,0,180*pi,!1)):t.ellipse(e.x,e.y,i,n,0,0,360*pi,!1):(s=e.x,l=e.y,p=(c=i)*(d=.5522848),f=(h=n)*d,m=(u=r)*d,t.moveTo(s-c,l),t.bezierCurveTo(s-c,l-f,s-p,l-h,s,l-h),t.bezierCurveTo(s+p,l-h,s+c,l-f,s+c,l),t.bezierCurveTo(s+c,l+m,s+p,l+u,s,l+u),t.bezierCurveTo(s-p,l+u,s-c,l+m,s-c,l),t.closePath()),fi.fillCanvas(t,a,e.x-i,e.y-n),fi._stroke(t,o,e.x-i,e.y-n)},rectangle:function(t,e,i,n,r){var o=e.x,a=e.y;t.beginPath(),t.rect(o,a,i.width,i.height),fi.fillCanvas(t,r,o,a),fi._stroke(t,n,o,a)},sector:function(t,e,i,n,r,o){var a=pi,s=n[0],l=n[1];function c(t,e,i,n,s,l){var c=a*-l,h=a*-s;t.beginPath(),t.moveTo(e,i),t.arc(e,i,n,c,h),t.lineTo(e,i),fi.fillCanvas(t,o,e-n,i-n),fi._stroke(t,r,e-n,i-n)}c(t,e.x,e.y,i,s,l)},_isPattern:function(t){return!U(t)&&!("addColorStop"in t)},drawCross:function(t,e,i,n,r){t.canvas._drawn=!0,t.strokeStyle=r,t.lineWidth=n,t.beginPath(),t.moveTo(e-5,i),t.lineTo(e+5,i),t.moveTo(e,i-5),t.lineTo(e,i+5),t.stroke()},copy:function(t,e){var i=e||pe("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0),i},pixelRect:function(t,e,i,n){var r=t.lineWidth,o=t.globalAlpha;if(r>0&&i>0)t.fillStyle!==t.strokeStyle&&(t.fillStyle=t.strokeStyle),i<1&&(t.globalAlpha*=i);else{if(!(n>0))return;n<1&&(t.globalAlpha*=n)}t.canvas._drawn=!0,t.fillRect(e[0],e[1],1,1),t.globalAlpha!==o&&(t.globalAlpha=o)}};function mi(t,e,i,n){var r=e.x,o=e.y,a=i.x,s=i.y,l=n,c=function(t,e){return t<=e},h=function(t,e){return t>=e},u=function(t,e){return Math.min(t,e)},d=function(t,e){return Math.max(t,e)},p={thereYet:h,cap:u},f={thereYet:h,cap:u};o-s>0&&(f.thereYet=c,f.cap=d),r-a>0&&(p.thereYet=c,p.cap=d),t.moveTo(r,o);for(var m,g,y=r,_=o,v=0,x=!0;!p.thereYet(y,a)||!f.thereYet(_,s);)m=Math.atan2(s-o,a-r),g=l[v],y=p.cap(a,y+Math.cos(m)*g),_=f.cap(s,_+Math.sin(m)*g),x?t.lineTo(y,_):t.moveTo(y,_),v=(v+1)%l.length,x=!x}function gi(t){return"data:image/"===t.substring(0,"data:image/".length)?t:yt(t)}function yi(t,e){t.filter=e.filter,t.fillStyle=e.fillStyle,t.globalAlpha=e.globalAlpha,t.lineCap=e.lineCap,t.lineDashOffset=e.lineDashOffset,t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth,t.shadowBlur=e.shadowBlur,t.shadowColor=e.shadowColor,t.shadowOffsetX=e.shadowOffsetX,t.shadowOffsetY=e.shadowOffsetY,t.strokeStyle=e.strokeStyle}var _i="undefined"!=typeof window?window:void 0!==n?n:"undefined"!=typeof self?self:{};function vi(t,e){return t(e={exports:{}},e.exports),e.exports}var xi=vi((function(t){!function(e){function i(t){if(t){var e=this;t((function(t){e.resolve(t)}),(function(t){e.reject(t)}))}}function n(t,e){if("function"==typeof t.y)try{var i=t.y.call(s,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.resolve(e)}function o(t,e){if("function"==typeof t.n)try{var i=t.n.call(s,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.reject(e)}var a,s,l="fulfilled",c="undefined",h=function(){function t(){for(;i.length-n;){try{i[n]()}catch(t){e.console&&e.console.error(t)}i[n++]=s,n==o&&(i.splice(0,o),n=0)}}var i=[],n=0,o=1024,a=function(){if(typeof MutationObserver!==c){var e=document.createElement("div");return new MutationObserver(t).observe(e,{attributes:!0}),function(){e.setAttribute("a",0)}}return typeof r!==c?function(){r(t)}:function(){setTimeout(t,0)}}();return function(t){i.push(t),i.length-n==1&&a()}}();i.prototype={resolve:function(t){if(this.state===a){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));var e=this;if(t&&("function"==typeof t||"object"==typeof t))try{var i=!0,r=t.then;if("function"==typeof r)return void r.call(t,(function(t){i&&(i=!1,e.resolve(t))}),(function(t){i&&(i=!1,e.reject(t))}))}catch(t){return void(i&&this.reject(t))}this.state=l,this.v=t,e.c&&h((function(){for(var i=0,r=e.c.length;r>i;i++)n(e.c[i],t)}))}},reject:function(t){if(this.state===a){this.state="rejected",this.v=t;var n=this.c;n?h((function(){for(var e=0,i=n.length;i>e;e++)o(n[e],t)})):!i.suppressUncaughtRejectionError&&e.console&&e.console.log("You upset Zousan. Please catch rejections: ",t,t?t.stack:null)}},then:function(t,e){var r=new i,s={y:t,n:e,p:r};if(this.state===a)this.c?this.c.push(s):this.c=[s];else{var c=this.state,u=this.v;h((function(){c===l?n(s,u):o(s,u)}))}return r},catch:function(t){return this.then(null,t)},finally:function(t){return this.then(t,t)},timeout:function(t,e){e=e||"Timeout";var n=this;return new i((function(i,r){setTimeout((function(){r(Error(e))}),t),n.then((function(t){i(t)}),(function(t){r(t)}))}))}},i.resolve=function(t){var e=new i;return e.resolve(t),e},i.reject=function(t){var e=new i;return e.reject(t),e},i.all=function(t){function e(e,a){e&&"function"==typeof e.then||(e=i.resolve(e)),e.then((function(e){n[a]=e,++r==t.length&&o.resolve(n)}),(function(t){o.reject(t)}))}for(var n=[],r=0,o=new i,a=0;a<t.length;a++)e(t[a],a);return t.length||o.resolve(n),o},t.exports&&(t.exports=i),e.define&&e.define.amd&&e.define([],(function(){return i})),e.Zousan=i,i.soon=h}(_i)})),bi="undefined"!=typeof Promise?Promise:xi,wi=function(t){return function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.on=function(t,e,i){if(!t)return this;if(!U(t))return this._switch("on",t,e);if(!e)return this;this._eventMap||(this._eventMap={});var n,r,o=t.toLowerCase().split(" ");i||(i=this);for(var a=0,s=o.length;a<s;a++){n=o[a],(r=this._eventMap[n])||(r=[],this._eventMap[n]=r);var l=r.length;if(l>0)for(var c=0;c<l;c++)if(e===r[c].handler&&r[c].context===i)return this;r.push({handler:e,context:i})}return this},i.addEventListener=function(){return this.on.apply(this,arguments)},i.once=function(t,e,i){if(!U(t)){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=this._wrapOnceHandler(r,t[r],i));return this._switch("on",n)}for(var o=t.split(" "),a=0,s=o.length;a<s;a++)this.on(o[a],this._wrapOnceHandler(o[a],e,i));return this},i.off=function(t,e,i){if(!this._eventMap||!t)return this;if(!U(t))return this._switch("off",t,e);if(!e)return this;var n,r,o,a=t.split(" ");i||(i=this);for(var s=0,l=a.length;s<l;s++){if(o="Z__"+(n=a[s].toLowerCase()),!(r=this._eventMap[n]))return this;for(var c=r.length-1;c>=0;c--){var h=r[c];e!==h.handler&&e!==h.handler[o]||h.context!==i||(delete h.handler[o],r.splice(c,1))}r.length||delete this._eventMap[n]}return this},i.removeEventListener=function(){return this.off.apply(this,arguments)},i.listens=function(t,e,i){if(!this._eventMap||!U(t))return 0;var n=this._eventMap[t.toLowerCase()];if(!n||!n.length)return 0;if(!e)return n.length;for(var r=0,o=n.length;r<o;r++)if(e===n[r].handler&&(F(i)||n[r].context===i))return 1;return 0},i.getListeningEvents=function(){return this._eventMap?Object.keys(this._eventMap):[]},i.copyEventListeners=function(t){var e,i=t._eventMap;if(!i)return this;for(var n in i)for(var r=0,o=(e=i[n]).length;r<o;r++)this.on(n,e[r].handler,e[r].context);return this},i.fire=function(){return this._eventParent?this._eventParent.fire.apply(this._eventParent,arguments):this._fire.apply(this,arguments)},i._wrapOnceHandler=function(t,e,i){var n=this,r="Z__"+t,o=!1,a=function s(){o||(delete a[r],o=!0,i?e.apply(i,arguments):e.apply(this,arguments),n.off(t,s,this))};return a[r]=e,a},i._switch=function(t,e,i){for(var n in e)e.hasOwnProperty(n)&&this[t](n,e[n],i);return this},i._clearListeners=function(t){this._eventMap&&U(t)&&(this._eventMap[t.toLowerCase()]&&(this._eventMap[t]=null))},i._clearAllListeners=function(){this._eventMap=null},i._setEventParent=function(t){return this._eventParent=t,this},i._setEventTarget=function(t){return this._eventTarget=t,this},i._fire=function(t,e){if(!this._eventMap)return this;var i=this._eventMap[t.toLowerCase()];if(!i)return this;e||(e={}),e.type=t,e.target=this._eventTarget||this;for(var n,r,o=i.slice(0),a=0,s=o.length;a<s;a++)o[a]&&(n=o[a].context,!0,r=B({},e),!1===(n?o[a].handler.call(n,r):o[a].handler(r))&&e.domEvent&&xe(e.domEvent));return this},e}(t)},Mi=function(){function t(t){this.target=t}var e=t.prototype;return e.enable=function(){return this._enabled||(this._enabled=!0,this.addHooks()),this},e.disable=function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},e.enabled=function(){return!!this._enabled},e.remove=function(){this.disable(),delete this.target,delete this.dom},t}(),Ti=wi(Mi),Si=function(){function t(t){if(!this||!this.setOptions)throw new Error('Class instance is being created without "new" operator.');this.setOptions(t),this.callInitHooks()}var e=t.prototype;return e.callInitHooks=function(){var t=Object.getPrototypeOf(this);return this._visitInitHooks(t),this},e.setOptions=function(t){if(this.hasOwnProperty("options")||(this.options=this.options?Object.create(this.options):{}),!t)return this;for(var e in t)this.options[e]=t[e];return this},e.config=function(t){if(!t){var e={};for(var i in this.options)this.options.hasOwnProperty(i)&&(e[i]=this.options[i]);return e}if(2===arguments.length){var n={};n[t]=arguments[1],t=n}for(var r in t)this.options[r]=t[r],this[r]&&this[r]instanceof Ti&&(t[r]?this[r].enable():this[r].disable());return this.onConfig(t),this},e.onConfig=function(){},e._visitInitHooks=function(t){if(!this._initHooksCalled){var e=Object.getPrototypeOf(t);e._visitInitHooks&&e._visitInitHooks.call(this,e),this._initHooksCalled=!0;var i=t._initHooks;if(i&&i!==e._initHooks)for(var n=0;n<i.length;n++)i[n].call(this)}},t.addInitHook=function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];var r="function"==typeof t?t:function(){this[t].apply(this,i)},o=this.prototype,a=Object.getPrototypeOf(o);return o._initHooks&&o._initHooks!==a._initHooks||(o._initHooks=[]),o._initHooks.push(r),this},t.include=function(){for(var t=0;t<arguments.length;t++)B(this.prototype,t<0||arguments.length<=t?void 0:arguments[t]);return this},t.mergeOptions=function(t){var e=this.prototype,i=Object.getPrototypeOf(e);return e.options&&e.options!==i.options||(e.options=e.options?Object.create(e.options):{}),B(e.options,t),this},t}(),Ei={},Ci=function(t){return function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.registerJSONType=function(t){return t?(Ei[t]=this,this):this},e.getJSONClass=function(t){return t?Ei[t]:null},e.prototype.getJSONType=function(){if(void 0===this._jsonType){var t=Object.getPrototypeOf(this).constructor;for(var e in Ei)if(Ei[e]===t){this._jsonType=e;break}}if(!this._jsonType)throw new Error("Found an unregistered geometry class!");return this._jsonType},e}(t)},Ai=vi((function(t,e){t.exports=function(){function t(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function e(t,e){return t<e?-1:t>e?1:0}return function(i,n,r,o,a){!function e(i,n,r,o,a){for(;o>r;){if(o-r>600){var s=o-r+1,l=n-r+1,c=Math.log(s),h=.5*Math.exp(2*c/3),u=.5*Math.sqrt(c*h*(s-h)/s)*(l-s/2<0?-1:1),d=Math.max(r,Math.floor(n-l*h/s+u)),p=Math.min(o,Math.floor(n+(s-l)*h/s+u));e(i,n,d,p,a)}var f=i[n],m=r,g=o;for(t(i,r,n),a(i[o],f)>0&&t(i,r,o);m<g;){for(t(i,m,g),m++,g--;a(i[m],f)<0;)m++;for(;a(i[g],f)>0;)g--}0===a(i[r],f)?t(i,r,g):(g++,t(i,g,o)),g<=n&&(r=g+1),n<=g&&(o=g-1)}}(i,n,r||0,o||i.length-1,a||e)}}()})),Pi=Ii,Li=Ii;function Ii(t,e){if(!(this instanceof Ii))return new Ii(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function Ri(t,e,i){if(!i)return e.indexOf(t);for(var n=0;n<e.length;n++)if(i(t,e[n]))return n;return-1}function Di(t,e){ki(t,0,t.children.length,e,t)}function ki(t,e,i,n,r){r||(r=Ui(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var o,a=e;a<i;a++)o=t.children[a],Oi(r,t.leaf?n(o):o);return r}function Oi(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function zi(t,e){return t.minX-e.minX}function Bi(t,e){return t.minY-e.minY}function Fi(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function Ni(t){return t.maxX-t.minX+(t.maxY-t.minY)}function ji(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function Gi(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function Ui(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Vi(t,e,i,n,r){for(var o,a=[e,i];a.length;)(i=a.pop())-(e=a.pop())<=n||(o=e+Math.ceil((i-e)/n/2)*n,Ai(t,o,e,i,r),a.push(e,o,o,i))}Ii.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,i=[],n=this.toBBox;if(!Gi(t,e))return i;for(var r,o,a,s,l=[];e;){for(r=0,o=e.children.length;r<o;r++)a=e.children[r],Gi(t,s=e.leaf?n(a):a)&&(e.leaf?i.push(a):ji(t,s)?this._all(a,i):l.push(a));e=l.pop()}return i},collides:function(t){var e=this.data,i=this.toBBox;if(!Gi(t,e))return!1;for(var n,r,o,a,s=[];e;){for(n=0,r=e.children.length;n<r;n++)if(o=e.children[n],Gi(t,a=e.leaf?i(o):o)){if(e.leaf||ji(t,a))return!0;s.push(o)}e=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,i=t.length;e<i;e++)this.insert(t[e]);return this}var n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var r=this.data;this.data=n,n=r}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=Ui([]),this},remove:function(t,e){if(!t)return this;for(var i,n,r,o,a=this.data,s=this.toBBox(t),l=[],c=[];a||l.length;){if(a||(a=l.pop(),n=l[l.length-1],i=c.pop(),o=!0),a.leaf&&-1!==(r=Ri(t,a.children,e)))return a.children.splice(r,1),l.push(a),this._condense(l),this;o||a.leaf||!ji(a,s)?n?(i++,a=n.children[i],o=!1):a=null:(l.push(a),c.push(i),i=0,n=a,a=a.children[0])}return this},toBBox:function(t){return t},compareMinX:zi,compareMinY:Bi,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var i=[];t;)t.leaf?e.push.apply(e,t.children):i.push.apply(i,t.children),t=i.pop();return e},_build:function(t,e,i,n){var r,o=i-e+1,a=this._maxEntries;if(o<=a)return Di(r=Ui(t.slice(e,i+1)),this.toBBox),r;n||(n=Math.ceil(Math.log(o)/Math.log(a)),a=Math.ceil(o/Math.pow(a,n-1))),(r=Ui([])).leaf=!1,r.height=n;var s,l,c,h,u=Math.ceil(o/a),d=u*Math.ceil(Math.sqrt(a));for(Vi(t,e,i,d,this.compareMinX),s=e;s<=i;s+=d)for(Vi(t,s,c=Math.min(s+d-1,i),u,this.compareMinY),l=s;l<=c;l+=u)h=Math.min(l+u-1,c),r.children.push(this._build(t,l,h,n-1));return Di(r,this.toBBox),r},_chooseSubtree:function(t,e,i,n){for(var r,o,a,s,l,c,h,u,d,p;n.push(e),!e.leaf&&n.length-1!==i;){for(h=u=1/0,r=0,o=e.children.length;r<o;r++)l=Fi(a=e.children[r]),d=t,p=a,(c=(Math.max(p.maxX,d.maxX)-Math.min(p.minX,d.minX))*(Math.max(p.maxY,d.maxY)-Math.min(p.minY,d.minY))-l)<u?(u=c,h=l<h?l:h,s=a):c===u&&l<h&&(h=l,s=a);e=s||e.children[0]}return e},_insert:function(t,e,i){var n=this.toBBox,r=i?t:n(t),o=[],a=this._chooseSubtree(r,this.data,e,o);for(a.children.push(t),Oi(a,r);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(r,o,e)},_split:function(t,e){var i=t[e],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);var o=this._chooseSplitIndex(i,r,n),a=Ui(i.children.splice(o,i.children.length-o));a.height=i.height,a.leaf=i.leaf,Di(i,this.toBBox),Di(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(i,a)},_splitRoot:function(t,e){this.data=Ui([t,e]),this.data.height=t.height+1,this.data.leaf=!1,Di(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,i){var n,r,o,a,s,l,c,h,u,d,p,f,m,g;for(l=c=1/0,n=e;n<=i-e;n++)r=ki(t,0,n,this.toBBox),o=ki(t,n,i,this.toBBox),u=r,d=o,p=void 0,f=void 0,m=void 0,g=void 0,p=Math.max(u.minX,d.minX),f=Math.max(u.minY,d.minY),m=Math.min(u.maxX,d.maxX),g=Math.min(u.maxY,d.maxY),a=Math.max(0,m-p)*Math.max(0,g-f),s=Fi(r)+Fi(o),a<l?(l=a,h=n,c=s<c?s:c):a===l&&s<c&&(c=s,h=n);return h},_chooseSplitAxis:function(t,e,i){var n=t.leaf?this.compareMinX:zi,r=t.leaf?this.compareMinY:Bi;this._allDistMargin(t,e,i,n)<this._allDistMargin(t,e,i,r)&&t.children.sort(n)},_allDistMargin:function(t,e,i,n){t.children.sort(n);var r,o,a=this.toBBox,s=ki(t,0,e,a),l=ki(t,i-e,i,a),c=Ni(s)+Ni(l);for(r=e;r<i-e;r++)o=t.children[r],Oi(s,t.leaf?a(o):o),c+=Ni(s);for(r=i-e-1;r>=e;r--)o=t.children[r],Oi(l,t.leaf?a(o):o),c+=Ni(l);return c},_adjustParentBBoxes:function(t,e,i){for(var n=i;n>=0;n--)Oi(e[n],t)},_condense:function(t){for(var e,i=t.length-1;i>=0;i--)0===t[i].children.length?i>0?(e=t[i-1].children).splice(e.indexOf(t[i]),1):this.clear():Di(t[i],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}},Pi.default=Li;var Hi={},Zi=function(){function t(){this._tree=Pi(9,["[0]","[1]","[2]","[3]"])}var e=t.prototype;return e.collides=function(t){return Hi.minX=t[0],Hi.minY=t[1],Hi.maxX=t[2],Hi.maxY=t[3],this._tree.collides(Hi)},e.insertBox=function(t){return this._tree.insert(t),this},e.bulkInsertBox=function(t){return this._tree.load(t),this},e.clear=function(){return this._tree.clear(),this},t}();function Wi(t){return function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHandler=function(t,e){if(!e)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;var i=this[t]=new e(this);return this._handlers.push(i),this.options[t]&&i.enable(),this},i.removeHandler=function(t){if(!t)return this;var e=this[t];if(e){var i=this._handlers.indexOf(e);i>=0&&this._handlers.splice(i,1),this[t].remove(),delete this[t]}return this},i._clearHandlers=function(){for(var t=0,e=this._handlers.length;t<e;t++)this._handlers[t].remove();this._handlers=[]},e}(t)}var qi={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},Xi={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},Yi=function(t){function e(e,i){var n;return void 0===i&&(i={}),(n=t.call(this,null)||this).dom=e,n.options=i,n}ne(e,t);var i=e.prototype;return i.enable=function(){return this.dom?(this._onMouseDown=function(t){return this.onMouseDown(t)},ke(this.dom,"touchstart mousedown",this._onMouseDown,this),this):this},i.disable=function(){return this.dom?(this._offEvents(),Oe(this.dom,"touchstart mousedown",this._onMouseDown),delete this._onMouseDown,this):this},i.onMouseDown=function(t){if((this.options.rightclick||2!==t.button)&&!(t.touches&&t.touches.length>1||this.options.cancelOn&&!0===this.options.cancelOn(t))){var e=this.dom;e.setCapture?e.setCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP),e.ondragstart=function(){return!1},delete this.moved;var i=t.touches?t.touches[0]:t;this.startPos=new ae(i.clientX,i.clientY),ke(document,qi[t.type],this.onMouseMove,this),ke(document,Xi[t.type],this.onMouseUp,this),this.options.ignoreMouseleave||ke(this.dom,"mouseleave",this.onMouseUp,this),this.fire("mousedown",{domEvent:t,mousePos:new ae(i.clientX,i.clientY)})}},i.onMouseMove=function(t){if(t.touches&&t.touches.length>1)this.moved&&(this.interupted=!0,this.onMouseUp(t));else{var e=t.touches?t.touches[0]:t,i=new ae(e.clientX,e.clientY).sub(this.startPos);(i.x||i.y)&&(this.moved?this.fire("dragging",{domEvent:t,mousePos:new ae(e.clientX,e.clientY)}):(this.fire("dragstart",{domEvent:t,mousePos:this.startPos.copy()}),this.moved=!0))}},i.onMouseUp=function(t){var e=t.changedTouches?t.changedTouches[0]:t;this._offEvents();var i={domEvent:t};N(e.clientX)&&(i.mousePos=new ae(parseInt(e.clientX,0),parseInt(e.clientY,0))),this.moved&&(i.interupted=this.interupted,this.fire("dragend",i),delete this.interupted,delete this.moved),this.fire("mouseup",i)},i._offEvents=function(){var t=this.dom;if(Oe(t,"mouseleave",this.onMouseUp,this),"undefined"!=typeof document&&"undefined"!=typeof window){for(var e in qi)Oe(document,qi[e],this.onMouseMove,this),Oe(document,Xi[e],this.onMouseUp,this);t.releaseCapture?t.releaseCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP)}},e}(Ti),$i=function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.toNumberArrays=function(t){return Array.isArray(t)?ot(t,(function(t){return[t.x,t.y]})):[t.x,t.y]},e.toCoordinates=function(t){if(N(t[0])&&N(t[1]))return new e(t);for(var i=[],n=0,r=t.length;n<r;n++){var o=t[n];Array.isArray(o)?N(o[0])?i.push(new e(o)):i.push(e.toCoordinates(o)):i.push(new e(o))}return i},e}(oe),Ji=function(){function t(t,e){this.type=t,this.properties=e}return t.createProj4=function(e){return new t("proj4",{proj:e})},t.fromProjectionCode=function(e){return e&&t[e=e.toUpperCase().replace(":","")]||null},t}();Ji.WGS84=Ji.createProj4("+proj=longlat +datum=WGS84 +no_defs"),Ji.EPSG4326=Ji.WGS84,Ji.EPSG3857=Ji.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),Ji.IDENTITY=Ji.createProj4("+proj=identity +no_defs"),Ji.CGCS2000=Ji.createProj4("+proj=longlat +datum=CGCS2000"),Ji.EPSG4490=Ji.CGCS2000,Ji.BD09LL=Ji.createProj4("+proj=longlat +datum=BD09"),Ji.GCJ02=Ji.createProj4("+proj=longlat +datum=GCJ02");var Ki,Qi=new ae(0,0),tn=new $i(0,0),en=new $i(0,0),nn=new $i(0,0),rn=new $i(0,0),on=new $i(0,0),an=new $i(0,0),sn=new $i(0,0),ln=new $i(0,0),cn=[],hn=[],un=function(){function t(t,e,i,n){this._clazz=$i;var r=arguments.length,o=r>0?arguments[r-1]:null;o&&o.unproject&&(this.projection=arguments[r-1]),this._dirty=!0,this._initialize(t,e,i,n)}var e=t.prototype;return e._initialize=function(t,e,i,n){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!F(t)){var r=this.projection;N(t)&&N(e)&&N(i)&&N(n)?r?this.set(t,e,i,n):this.set(Math.min(t,i),Math.min(e,n),Math.max(t,i),Math.max(e,n)):Array.isArray(t)?r?this.set(t[0],t[1],t[2],t[3]):this.set(Math.min(t[0],t[2]),Math.min(t[1],t[3]),Math.max(t[0],t[2]),Math.max(t[1],t[3])):N(t.x)&&N(e.x)&&N(t.y)&&N(e.y)?r?this.set(t.x,t.y,e.x,e.y):(t.x>e.x?(this.xmin=e.x,this.xmax=t.x):(this.xmin=t.x,this.xmax=e.x),t.y>e.y?(this.ymin=e.y,this.ymax=t.y):(this.ymin=t.y,this.ymax=e.y)):N(t.xmin)&&N(t.xmax)&&N(t.ymin)&&N(t.ymax)&&this.set(t.xmin,t.ymin,t.xmax,t.ymax)}},e._add=function(t){return this._dirty=!0,F(t.x)?F(t.xmin)?F(t[0])||(this.xmin+=t[0],this.ymin+=t[1],this.xmax+=t[0],this.ymax+=t[1]):(this.xmin+=t.xmin,this.ymin+=t.ymin,this.xmax+=t.xmax,this.ymax+=t.ymax):(this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y),this},e.add=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._add.apply(t,arguments)},e._scale=function(t){return this._dirty=!0,this.xmin*=t,this.ymin*=t,this.xmax*=t,this.ymax*=t,this},e._sub=function(t){return this._dirty=!0,F(t.x)?F(t.xmin)?F(t[0])||(this.xmin-=t[0],this.ymin-=t[1],this.xmax-=t[0],this.ymax-=t[1]):(this.xmin-=t.xmin,this.ymin-=t.ymin,this.xmax-=t.xmax,this.ymax-=t.ymax):(this.xmin-=t.x,this.ymin-=t.y,this.xmax-=t.x,this.ymax-=t.y),this},e._substract=function(){return this._sub.apply(this,arguments)},e.sub=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._sub.apply(t,arguments)},e.substract=function(){return this.sub.apply(this,arguments)},e.round=function(){return new this.constructor(Math.round(this.xmin),Math.round(this.ymin),Math.round(this.xmax),Math.round(this.ymax),this.projection)},e._round=function(){return this._dirty=!0,this.xmin=Math.round(this.xmin),this.ymin=Math.round(this.ymin),this.xmax=Math.round(this.xmax),this.ymax=Math.round(this.ymax),this},e.getMin=function(t){return t?(t.set(this.xmin,this.ymin),t):new this._clazz(this.xmin,this.ymin)},e.getMax=function(t){return t?(t.set(this.xmax,this.ymax),t):new this._clazz(this.xmax,this.ymax)},e.getCenter=function(t){var e=(this.xmin+this.xmax)/2,i=(this.ymin+this.ymax)/2;return t?(t.set(e,i),t):new this._clazz(e,i)},e.isValid=function(){return!(F(this.xmin)||F(this.ymin)||F(this.xmax)||F(this.ymax))},e.equals=function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},e.intersects=function(t){this._project(this),this._project(t);var e=Math.max(this.pxmin,t.pxmin),i=Math.max(this.pymin,t.pymin),n=Math.min(this.pxmax,t.pxmax),r=Math.min(this.pymax,t.pymax),o=!(e>n||i>r);return o},e.within=function(t){return this._project(this),this._project(t),this.pxmin>=t.pxmin&&this.pxmax<=t.pxmax&&this.pymin>=t.pymin&&this.pymax<=t.pymax},e.contains=function(t){if(!t)return!1;this._project(this);var e=this.projection;if(e)if(void 0!==t.x){var i=tn;Array.isArray(t)?(i.x=t[0],i.y=t[1]):(i.x=t.x,i.y=t.y),t=e.project(i,i)}else void 0!==t.xmin&&this._project(t);return(t.x||t.pxmin||0)>=this.pxmin&&(t.x||t.pxmax||0)<=this.pxmax&&(t.y||t.pymin||0)>=this.pymin&&(t.y||t.pymax||0)<=this.pymax},e.getWidth=function(){return Math.abs(this.xmax-this.xmin)},e.getHeight=function(){return Math.abs(this.ymax-this.ymin)},e.getSize=function(){return new se(this.getWidth(),this.getHeight())},e.set=function(t,e,i,n){return this.xmin=t,this.ymin=e,this.xmax=i,this.ymax=n,this._dirty=!0,this},e.__combine=function(t){var e,i,n,r;void 0!==t.x&&(Ki.xmin=Ki.xmax=t.x,Ki.ymin=Ki.ymax=t.y,t=Ki),this._project(t),this._project(this),N(this.pxmin)?(e=Math.min(this.pxmin,t.pxmin),i=Math.min(this.pymin,t.pymin),n=Math.max(this.pxmax,t.pxmax),r=Math.max(this.pymax,t.pymax)):(e=t.pxmin,i=t.pymin,n=t.pxmax,r=t.pymax);var o=this.projection;if(o){en.set(e,i),nn.set(n,r);var a=o.unproject(en,en),s=o.unproject(nn,nn);e=a.x,i=a.y,n=s.x,r=s.y}return hn[0]=e,hn[1]=i,hn[2]=n,hn[3]=r,hn},e._combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return this.set(e[0],e[1],e[2],e[3]),this._dirty=!0,this},e.combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3],this.projection)},e.intersection=function(t){if(!this.intersects(t))return null;rn.x=Math.max(this.pxmin,t.pxmin),rn.y=Math.max(this.pymin,t.pymin),on.x=Math.min(this.pxmax,t.pxmax),on.y=Math.min(this.pymax,t.pymax);var e=rn,i=on,n=this.projection;return n&&(e=n.unproject(e,e),i=n.unproject(i,i)),new this.constructor(e,i,n)},e.expand=function(t){var e,i;return N(t)?e=i=t:(e=t.width||t.x||t[0]||0,i=t.height||t.y||t[1]||0),new this.constructor(this.xmin-e,this.ymin-i,this.xmax+e,this.ymax+i,this.projection)},e._expand=function(t){var e,i;return N(t)?e=i=t:(e=t.width||t.x||t[0]||0,i=t.height||t.y||t[1]||0),this.xmin-=e,this.ymin-=i,this.xmax+=e,this.ymax+=i,this._dirty=!0,this},e.toJSON=function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},e.toArray=function(t){var e=this.xmin,i=this.ymin,n=this.xmax,r=this.ymax;return t?(t[0].x=e,t[0].y=r,t[1].x=n,t[1].y=r,t[2].x=n,t[2].y=i,t[3].x=e,t[3].y=i,t[4].x=e,t[4].y=r,t):[new this._clazz([e,r]),new this._clazz([n,r]),new this._clazz([n,i]),new this._clazz([e,i]),new this._clazz([e,r])]},e.toString=function(){return this.xmin+","+this.ymin+","+this.xmax+","+this.ymax},e.copy=function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)},e.convertTo=function(t,e){if(!this.isValid())return null;var i,n=e||new this.constructor;return e&&n.set(null,null,null,null),this._clazz===$i?i=an:this._clazz===ae&&(i=Qi),i.x=this.xmin,i.y=this.ymax,n._combine(t(i)),i.x=this.xmax,n._combine(t(i)),i.y=this.ymin,n._combine(t(i)),i.x=this.xmin,n._combine(t(i)),n},e._project=function(t){if(t&&t.isValid()){var e=this.projection;if(e){if(t._dirty){sn.set(t.xmax,t.ymin),ln.set(t.xmin,t.ymax),cn[0]=sn,cn[1]=ln;var i=e.projectCoords(cn),n=i[0],r=i[1];t.pxmin=Math.min(n.x,r.x),t.pymin=Math.min(n.y,r.y),t.pxmax=Math.max(n.x,r.x),t.pymax=Math.max(n.y,r.y)}delete t._dirty}else t.pxmin=t.xmin,t.pxmax=t.xmax,t.pymin=t.ymin,t.pymax=t.ymax}else t&&(t.pxmin=t.pxmax=t.pymin=t.pymax=null)},t}();Ki=new un(0,0,0,0);var dn,pn=function(t){function e(e,i,n,r){var o;return(o=t.call(this,e,i,n,r)||this)._clazz=ae,o}return ne(e,t),e}(un),fn=function(){function t(t){this.matrix=t}var e=t.prototype;return e.transform=function(t,e,i){var n=this.matrix[0]*(t.x-this.matrix[2])/e,r=-this.matrix[1]*(t.y-this.matrix[3])/e;return i?(i.x=n,i.y=r,i):new ae(n,r)},e.untransform=function(t,e,i){var n=t.x*e/this.matrix[0]+this.matrix[2],r=t.y*e/-this.matrix[1]+this.matrix[3];return i?(i.x=n,i.y=r,i):new $i(n,r)},t}(),mn={project:function(){},unproject:function(){},projectCoords:function(t){var e=this;if(!t)return[];if(!Array.isArray(t))return this.project(t);if(0===t.length)return[];if(!this.isSphere())return ot(t,this.project,this);if(Array.isArray(t[0]))return t.map((function(t){return e.projectCoords(t)}));for(var i,n,r,o,a,s,l=this.getCircum(),c=this.getSphereExtent(),h=c.sx,u=c.sy,d=t[0],p=[this.project(d)],f=1,m=t.length;f<m;f++)o=(r=t[f]).x-d.x,a=r.y-d.y,s=this.project(r),Math.abs(o)>180&&(void 0===i&&(i=r.x>d.x),i&&(s._add(-l.x*st(o)*h,0),r._add(-360*st(o),0))),Math.abs(a)>90&&(void 0===n&&(n=r.y<d.y),n&&(s._add(0,-l.y*st(a)*u),r._add(0,-180*st(a)))),d=r,p.push(s);return p},unprojectCoords:function(t){return t?Array.isArray(t)?ot(t,this.unproject,this):this.unproject(t):[]},isSphere:function(){return!!this.sphere},isOutSphere:function(t){return!!this.isSphere()&&!this.getSphereExtent().contains(t)},wrapCoord:function(t){if(!this.isSphere())return t;var e=this.getSphereExtent(),i=new $i(t);return e.contains(i)||(i.x=ht(t.x,e.xmin,e.xmax),i.y=ht(t.y,e.ymin,e.ymax)),i},getCircum:function(){if(!this.circum&&this.isSphere()){var t=this.getSphereExtent();this.circum={x:t.getWidth(),y:t.getHeight()}}return this.circum},getSphereExtent:function(){if(!this.extent&&this.isSphere()){var t=this.project(new $i(180,90)),e=this.project(new $i(-180,-90));this.extent=new un(e,t,this),this.extent.sx=t.x>e.x?1:-1,this.extent.sy=t.y>e.y?1:-1}return this.extent}},gn={measureLength:function(t,e){if(!Array.isArray(t))return this.measureLenBetween(t,e);for(var i=0,n=0,r=t.length;n<r-1;n++)i+=this.measureLenBetween(t[n],t[n+1]);return i}},yn=B({measure:"IDENTITY",measureLenBetween:function(t,e){if(!t||!e)return 0;try{return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}catch(t){return 0}},measureArea:function(t){if(!Array.isArray(t))return 0;for(var e=0,i=0,n=t.length;i<n;i++){var r=t[i],o=null;o=i===n-1?t[0]:t[i+1],e+=r.x*o.y-r.y*o.x}return Math.abs(e/2)},locate:function(t,e,i){return t=new $i(t.x,t.y),this._locate(t,e,i)},_locate:function(t,e,i){return t?(e||(e=0),i||(i=0),e||i?(t.x=t.x+e,t.y=t.y+i,t):t):null},rotate:function(t,e,i){return t=new $i(t.x,t.y),this._rotate(t,e,i)},_rotate:(dn=new ae(0,0),function(t,e,i){return dn.x=t.x-e.x,dn.y=t.y-e.y,dn._rotate(i*Math.PI/180),t.x=e.x+dn.x,t.y=e.y+dn.y,t})},gn),_n=function(){function t(t){this.radius=t}var e=t.prototype;return e.measureLenBetween=function(t,e){if(!t||!e)return 0;var i=Y(t.y),n=Y(e.y),r=i-n,o=Y(t.x)-Y(e.x);return i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(i)*Math.cos(n)*Math.pow(Math.sin(o/2),2))),i*=this.radius,Math.round(1e5*i)/1e5},e.measureArea=function(t){var e,i=Y(this.radius),n=0,r=t,o=r.length;if(o<3)return 0;for(e=0;e<o-1;e++){var a=r[e],s=r[e+1];n+=a.x*i*Math.cos(Y(a.y))*s.y*i-s.x*i*Math.cos(Y(s.y))*a.y*i}return o=r[e],r=r[0],n+=o.x*i*Math.cos(Y(o.y))*r.y*i-r.x*i*Math.cos(Y(r.y))*o.y*i,.5*Math.abs(n)},e.locate=function(t,e,i){return t=new $i(t.x,t.y),this._locate(t,e,i)},e._locate=function(t,e,i){if(!t)return null;if(e||(e=0),i||(i=0),!e&&!i)return t;var n,r,o=Y(t.y);if(0!==i){var a=Math.abs(i);r=ht(180*(o+=2*Math.sin(a/(2*this.radius))*(i>0?1:-1))/Math.PI,-90,90)}else r=t.y;if(0!==e){var s=Math.abs(e),l=Y(t.x);n=ht(180*(l+=2*Math.sqrt(Math.pow(Math.sin(s/(2*this.radius)),2)/Math.pow(Math.cos(o),2))*(e>0?1:-1))/Math.PI,-180,180)}else n=t.x;return t.x=n,t.y=r,t},e.rotate=function(t,e,i){return t=new $i(t),this._rotate(t,e,i)},e._rotate=function(t,e,i){var n=function(t,e,i){void 0===i&&(i={});var n;n=i.final?vn(e,t):vn(t,e);return n>180?-(360-n):n}(e,t)-i,r=this.measureLenBetween(e,t);return t.x=e.x,t.y=e.y,function(t,e,i,n){var r=e/n,o=t.x*Math.PI/180,a=Y(t.y),s=Y(i),l=r*Math.cos(s),c=a+l;Math.abs(c)>Math.PI/2&&(c=c>0?Math.PI-c:-Math.PI-c);var h=Math.log(Math.tan(c/2+Math.PI/4)/Math.tan(a/2+Math.PI/4)),u=Math.abs(h)>1e-11?l/h:Math.cos(a),d=r*Math.sin(s)/u,p=o+d;return t.x=(180*p/Math.PI+540)%360-180,t.y=180*c/Math.PI,t}(t,r,n,this.radius)},t}();function vn(t,e){var i=Y(t.y),n=Y(e.y),r=Y(e.x-t.x);r>Math.PI&&(r-=2*Math.PI),r<-Math.PI&&(r+=2*Math.PI);var o=Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(i/2+Math.PI/4));return($(Math.atan2(r,o))+360)%360}var xn=B({measure:"EPSG:4326",sphere:new _n(6378137),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},gn),bn=B({measure:"BAIDU",sphere:new _n(6370996.81),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},gn),wn=xn,Mn={};function Tn(t){Mn[t.measure]=t}Tn(yn),Tn(xn),Tn(bn);var Sn={getInstance:function(t){if(!t)return wn;for(var e in Mn)if(Z(Mn,e)){var i=Mn[e].measure;if(!i)continue;if(t.toLowerCase()===i.toLowerCase())return Mn[e]}return null}},En=B({},mn,{code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:6378137*Math.PI/180,maxLatitude:85.0511287798,project:function(t,e){var i=this.rad,n=this.metersPerDegree,r=this.maxLatitude,o=t.x,a=Math.max(Math.min(r,t.y),-r),s=o*n,l=(0===a?0:Math.log(Math.tan((90+a)*i/2))/i)*n;return e?(e.x=s,e.y=l,e):new $i(s,l)},unproject:function(t,e){var i,n=this.rad,r=this.metersPerDegree,o=t.x/r,a=t.y;0===a?i=0:(i=a/r,i=(2*Math.atan(Math.exp(i*n))-Math.PI/2)/n),Math.abs(Math.abs(o)-180)<1e-7&&(o=180*st(o)),Math.abs(Math.abs(i)-this.maxLatitude)<1e-7&&(i=st(i)*this.maxLatitude);var s=ht(o,-180,180),l=ht(i,-this.maxLatitude,this.maxLatitude);return e?(e.x=s,e.y=l,e):new $i(s,l)}},xn),Cn=B({},mn,{code:"EPSG:4326",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new $i(t)},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new $i(t)}},xn),An=B({},Cn,{code:"EPSG:4490"}),Pn=B({},mn,{code:"BAIDU",project:function(t,e){return this.convertLL2MC(t,e)},unproject:function(t,e){return this.convertMC2LL(t,e)}},bn,{EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(t,e){for(var i,n=0,r=this.MCBAND.length;n<r;n++)if(Math.abs(t.y)>=this.MCBAND[n]){i=this.MC2LL[n];break}return this.convertor(t,i,e)},convertLL2MC:function(t,e){var i,n,r;t.x=this.getLoop(t.x,-180,180),t.y=this.getRange(t.y,-74,74);var o=new $i(t.x,t.y);for(n=0,r=this.LLBAND.length;n<r;n++)if(o.y>=this.LLBAND[n]){i=this.LL2MC[n];break}if(!i)for(n=this.LLBAND.length-1;n>=0;n--)if(o.y<=-this.LLBAND[n]){i=this.LL2MC[n];break}return this.convertor(t,i,e)},convertor:function(t,e,i){if(!t||!e)return null;var n=e[0]+e[1]*Math.abs(t.x),r=Math.abs(t.y)/e[9],o=e[2]+e[3]*r+e[4]*r*r+e[5]*r*r*r+e[6]*r*r*r*r+e[7]*r*r*r*r*r+e[8]*r*r*r*r*r*r;return n*=t.x<0?-1:1,o*=t.y<0?-1:1,i?(i.x=n,i.y=o,i):new $i(n,o)},toRadians:function(t){return Math.PI*t/180},toDegrees:function(t){return 180*t/Math.PI},getRange:function(t,e,i){return null!=e&&(t=Math.max(t,e)),null!=i&&(t=Math.min(t,i)),t},getLoop:function(t,e,i){if(t===1/0)return i;if(t===-1/0)return e;for(;t>i;)t-=i-e;for(;t<e;)t+=i-e;return t}}),Ln=B({},mn,{code:"IDENTITY",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()}},yn),In=En,Rn=Object.freeze({EPSG3857:En,DEFAULT:In,EPSG4326:Cn,EPSG4490:An,BAIDU:Pn,IDENTITY:Ln,Common:mn}),Dn=function(t){return function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.registerRenderer=function(t,e){var i=this.prototype,n=Object.getPrototypeOf(i);return i._rendererClasses&&i._rendererClasses!==n._rendererClasses||(i._rendererClasses=i._rendererClasses?Object.create(i._rendererClasses):{}),i._rendererClasses[t.toLowerCase()]=e,this},e.getRendererClass=function(t){var e=this.prototype;return e._rendererClasses?e._rendererClasses[t.toLowerCase()]:null},e}(t)},kn=function(t){function e(e){var i;return(i=t.call(this)||this).layer=e,i._painted=!1,i._drawTime=0,i.setToRedraw(),i}ne(e,t);var i=e.prototype;return i.render=function(t){this.prepareRender(),this.getMap()&&this.layer.isVisible()&&(this.resources||(this.resources=new On),this.checkAndDraw(this._tryToDraw,t))},i.checkAndDraw=function(t){for(var e=this,i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];if(this.checkResources){var o=this.checkResources();o.length>0?(this._loadingResource=!0,this.loadResources(o).then((function(){e._loadingResource=!1,e.layer&&(e.layer.fire("resourceload"),e.setToRedraw())}))):t.call.apply(t,[this].concat(n))}else t.call.apply(t,[this].concat(n))},i.testIfNeedRedraw=function(){var t=this.getMap();return!this._loadingResource&&(!!this._toRedraw||!(t.isInteracting()&&!this.drawOnInteracting)&&!!this.needToRedraw())},i.needToRedraw=function(){var t=this.getMap();return!(!t.isInteracting()&&!t.getRenderer().isViewChanged())&&!(!t.getPitch()&&t.isMoving()&&!t.isZooming()&&!t.isRotating()&&!this.layer.options.forceRenderOnMoving)},i.onSkipDrawOnInteracting=function(){},i.isLoadingResource=function(){return this._loadingResource},i.isRenderComplete=function(){return!!this._renderComplete},i.mustRenderOnInteracting=function(){return!this._painted},i.setToRedraw=function(){return this._toRedraw=!0,this},i.setCanvasUpdated=function(){return this._canvasUpdated=!0,this},i.isCanvasUpdated=function(){return!!this._canvasUpdated},i.remove=function(){this.onRemove(),delete this._loadingResource,delete this.southWest,delete this.canvas,delete this.context,delete this.canvasExtent2D,delete this._extent2D,delete this.resources,delete this.layer},i.onRemove=function(){},i.onAdd=function(){},i.getMap=function(){return this.layer?this.layer.getMap():null},i.getCanvasImage=function(){var t=this.getMap();if(this._canvasUpdated=!1,this._renderZoom!==t.getZoom()||!this.canvas||!this._extent2D)return null;if(this.isBlank())return null;if(this.layer.isEmpty&&this.layer.isEmpty())return null;var e=t._pointToContainerPoint(this.southWest)._add(0,-t.height);return{image:this.canvas,layer:this.layer,point:e}},i.clear=function(){this.clearCanvas()},i.isBlank=function(){return!this._painted},i.show=function(){this.setToRedraw()},i.hide=function(){this.clear(),this.setToRedraw()},i.setZIndex=function(){this.setToRedraw()},i.hitDetect=function(t){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this.isBlank()||this._errorThrown)return!1;var e=this.getMap(),i=e.getDevicePixelRatio(),n=e.getSize();if(t.x<0||t.x>n.width*i||t.y<0||t.y>n.height*i)return!1;try{if(this.context.getImageData(i*t.x,i*t.y,1,1).data[3]>0)return!0}catch(t){return this._errorThrown||(console&&console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",t),this._errorThrown=!0),!1}return!1},i.loadResources=function(t){this.resources||(this.resources=new On);var e=this.resources,i=[];if(dt(t))for(var n={},r=t.length-1;r>=0;r--){var o=t[r];o&&o.length&&!n[o.join("-")]&&(n[o.join("-")]=1,e.isResourceLoaded(o,!0)||i.push(new bi(this._promiseResource(o))))}return bi.all(i)},i.prepareRender=function(){delete this._renderComplete;var t=this.getMap();this._renderZoom=t.getZoom(),this.canvasExtent2D=this._extent2D=t._get2DExtent(),this.southWest=t._containerPointToPoint(new ae(0,t.height))},i.createCanvas=function(){if(!this.canvas){var t=this.getMap(),e=t.getSize(),i=t.getDevicePixelRatio(),n=i*e.width,r=i*e.height;if(this.layer._canvas){var o=this.layer._canvas;o.width=n,o.height=r,o.style&&(o.style.width=e.width+"px",o.style.height=e.height+"px"),this.canvas=this.layer._canvas}else this.canvas=fi.createCanvas(n,r,t.CanvasClass);this.onCanvasCreate()}},i.onCanvasCreate=function(){},i.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=this.canvas.getContext("2d"),this.context)){this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation);var t=this.getMap().getDevicePixelRatio();1!==t&&this.context.scale(t,t)}},i.resetCanvasTransform=function(){if(this.context){var t=this.getMap().getDevicePixelRatio();this.context.setTransform(t,0,0,t,0,0)}},i.resizeCanvas=function(t){var e=this.canvas;if(e){var i=t||this.getMap().getSize(),n=this.getMap().getDevicePixelRatio();e.width===n*i.width&&e.height===n*i.height||(e.height=n*i.height,e.width=n*i.width,1!==n&&this.context&&this.context.scale(n,n),this.layer._canvas&&e.style&&(e.style.width=i.width+"px",e.style.height=i.height+"px"))}},i.clearCanvas=function(){this.context&&fi.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},i.prepareCanvas=function(){this.canvas?(this.resetCanvasTransform(),this.clearCanvas(),this.resizeCanvas()):(this.createCanvas(),this.createContext(),this.layer.onCanvasCreate(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})),delete this._maskExtent;var t=this.layer.getMask();if(!t)return this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null;var e=this._maskExtent=t._getMaskPainter().get2DExtent();return e.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context,gl:this.gl}),e},i.clipCanvas=function(t){var e=this.layer.getMask();if(!e)return!1;var i=this.southWest,n=this.getMap();this.southWest=n._containerPointToPoint(new ae(0,n.height)),t.save();var r=n.getDevicePixelRatio();if(1!==r&&(t.save(),t.scale(r,r)),e.getGeometries){t.isMultiClip=!0;var o=e.getGeometries()||[];t.beginPath(),o.forEach((function(e){e._getMaskPainter().paint(null,t)})),t.stroke(),delete t.isMultiClip}else{e._getMaskPainter().paint(null,t)}return 1!==r&&t.restore(),t.clip(),this.southWest=i,!0},i.getViewExtent=function(){return{extent:this._extent2D,maskExtent:this._maskExtent,zoom:this._renderZoom,southWest:this.southWest}},i.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context,gl:this.gl}),this.setCanvasUpdated())},i.getEvents=function(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotating:this.onDragRotating,_dragrotateend:this.onDragRotateEnd,_spatialreferencechange:this.onSpatialReferenceChange}},i.onZoomStart=function(){},i.onZoomEnd=function(){this.setToRedraw()},i.onZooming=function(){},i.onMoveStart=function(){},i.onMoving=function(){},i.onMoveEnd=function(){this.setToRedraw()},i.onResize=function(){delete this._extent2D,this.resizeCanvas(),this.setToRedraw()},i.onDragRotateStart=function(){},i.onDragRotating=function(){},i.onDragRotateEnd=function(){this.setToRedraw()},i.onSpatialReferenceChange=function(){},i.getDrawTime=function(){return this._drawTime},i._tryToDraw=function(t){this._toRedraw=!1,!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty()?this._renderComplete=!0:this._drawAndRecord(t)},i._drawAndRecord=function(t){if(this.getMap()){var e=this._painted;this._painted=!0;var i=z();this.draw(t),i=z()-i,this._drawTime=e?i:i/2,e&&this.layer&&this.layer.options.logDrawTime&&console.log(this.layer.getId(),"frameTimeStamp:",t,"drawTime:",this._drawTime)}},i._promiseResource=function(t){var e=this,i=this.resources,n=this.layer.options.crossOrigin,r=this.layer.options.renderer||"";return function(o){if(i.isResourceLoaded(t,!0))o(t);else{var a=new Image;F(n)?"canvas"!==r&&(a.crossOrigin=""):a.crossOrigin=n,J(t[0])&&!u&&(t[1]&&(t[1]*=2),t[2]&&(t[2]*=2)),a.onload=function(){e._cacheResource(t,a),o(t)},a.onabort=function(e){console&&console.warn("image loading aborted: "+t[0]),e&&console&&console.warn(e),o(t)},a.onerror=function(e){e&&"undefined"!=typeof console&&console.warn(e),i.markErrorResource(t),o(t)},K(a,t)}}},i._cacheResource=function(t,e){if(this.layer&&this.resources){var i=t[1],n=t[2];if(this.layer.options.cacheSvgOnCanvas&&1===J(t[0])&&(O.edge||O.ie)){F(i)&&(i=e.width||this.layer.options.defaultIconSize[0]),F(n)&&(n=e.height||this.layer.options.defaultIconSize[1]);var r=fi.createCanvas(i,n);fi.image(r.getContext("2d"),e,0,0,i,n),e=r}this.resources.addResource(t,e)}},e}(Si),On=function(){function t(){this.resources={},this._errors={}}var e=t.prototype;return e.addResource=function(t,e){this.resources[t[0]]={image:e,width:+t[1],height:+t[2],refCnt:0}},e.isResourceLoaded=function(t,e){if(!t)return!1;var i=this._getImgUrl(t);if(this._errors[i])return!0;var n=this.resources[i];return!!n&&!(e&&J(t[0])&&(+t[1]>n.width||+t[2]>n.height))},e.login=function(t){var e=this.resources[t];e&&e.refCnt++},e.logout=function(t){var e=this.resources[t];e&&e.refCnt--<=0&&delete this.resources[t]},e.getImage=function(t){var e=this._getImgUrl(t);return!this.isResourceLoaded(t)||this._errors[e]?null:this.resources[e].image},e.markErrorResource=function(t){this._errors[this._getImgUrl(t)]=1},e.merge=function(t){if(!t)return this;for(var e in t.resources){var i=t.resources[e];this.addResource([e,i.width,i.height],i.image)}return this},e.forEach=function(t){if(!this.resources)return this;for(var e in this.resources)Z(this.resources,e)&&t(e,this.resources[e]);return this},e._getImgUrl=function(t){return Array.isArray(t)?t[0]:t},t}();var zn=new ae(0,0);function Bn(t,e,i,n,r,o,a){var s,l,c,h,u,d,p=zn.set(e,i),f=t.set(p.x,p.y,p.x+o,p.y+a);return f._add(r),n&&(l=n,c=(s=f).xmin,h=s.ymin,u=s.xmax,d=s.ymax,Zn.set(c,h,u,d),Zn.convertTo((function(t){return t._rotate(l)}),s)),f}var Fn=[];function Nn(t,e){var i=Hn(Fn,e),n=Vn(e,i[0],i[1]);return Bn(t,e.markerDx||0,e.markerDy||0,Wn(e),n,i[0],i[1])}function jn(t){return"rectangle"===t?"right":"middle"}function Gn(t){return"bar"===t||"pie"===t||"pin"===t?"top":"rectangle"===t?"bottom":"middle"}var Un=new se(0,0);function Vn(t,e,i){var n=2*(t.shadowBlur||0)+0;Un.width=e,Un.height=i;var r=t.markerType,o=Xe(Un,t.markerHorizontalAlignment||jn(r),t.markerVerticalAlignment||Gn(r));return o.x!==-e/2&&(o.x-=st(o.x+e/2)*n),o.y!==-i/2&&(o.y-=st(o.y+i/2)*n),o}function Hn(t,e){var i=e.markerLineWidth||1,n=2*(e.shadowBlur||0),r=Math.round(e.markerWidth+i+2*n+0),o=Math.round(e.markerHeight+i+2*n+0);return t[0]=r,t[1]=o,t}var Zn=new pn;function Wn(t,e){void 0===e&&(e="markerRotation");var i=t[e];return N(i)?-i*Math.PI/180:0}function qn(t,e,i){var n=e.markerFile,r=i?i.getImage(n):null,o=e.markerWidth||(r?r.width:0),a=e.markerHeight||(r?r.height:0);Un.width=o,Un.height=a;var s=Xe(Un,e.markerHorizontalAlignment||"middle",e.markerVerticalAlignment||"top");return Bn(t,e.markerDx||0,e.markerDy||0,Wn(e),s,o,a)}function Xn(t,e,i){var n=i.size,r=Xe(n,e.textHorizontalAlignment,e.textVerticalAlignment);if(e.textHaloRadius){var o=e.textHaloRadius;n=n.add(2*o,2*o)}return Bn(t,e.textDx||0,e.textDy||0,Wn(e,"textRotation"),r,n.width,n.height)}var Yn=new pn;function $n(t,e,i,n){var r=t||new pn;if(Array.isArray(e)){for(var o=e,a=0;a<o.length;a++)$n(r,o[a],i,n[a]);return r}return Jn(e)&&r._combine(Xn(Yn,e,n)),Kn(e)&&r._combine(qn(Yn,e,i)),Qn(e)&&r._combine(Nn(Yn,e)),tr(e)&&r._combine(qn(Yn,e)),r}function Jn(t){return!!t&&!F(t.textName)}function Kn(t){return!!t&&!F(t.markerFile)}function Qn(t){return!!t&&!(!F(t.markerFile)||F(t.markerType)||"path"===t.markerType)}function tr(t){return!!t&&!(!F(t.markerFile)||"path"!==t.markerType)}var er,ir=["markerWidth","markerHeight","markerHorizontalAlignment","markerVerticalAlignment","markerDx","markerDy","textName","textSize","textDx","textDy","textVerticalAlignment","textHorizontalAlignment","textRotation"],nr=["textName","markerType","markerFile","textHaloRadius"];function rr(t,e,i,n){for(var r,o=[],a=0,s=0,l=t.length;s<l-1;s++)(r=or(t[s],t[s+1],e,s,i,n))&&(o[a]=o[a]||[],o[a].push({point:r[0],index:s}),r[1]===t[s+1]&&s!==l-2||(o[a].push({point:r[1],index:s+1}),a++));return o}function or(t,e,i,n,r,o){var a,s,l,c=n?er:lr(t,i),h=lr(e,i);for(er=h;;){if(!(c|h))return[t,e];if(c&h)return!1;if(o)return[t,e];l=lr(s=sr(t,e,a=c||h,i,r),i),a===c?(t=s,c=l):(e=s,h=l)}}function ar(t,e,i){var n,r,o,a,s,l,c,h,u,d=[1,4,2,8];for(r=0,c=t.length;r<c;r++)t[r]._code=lr(t[r],e);for(a=0;a<4;a++){for(h=d[a],n=[],r=0,o=(c=t.length)-1;r<c;o=r++)s=t[r],l=t[o],s._code&h?l._code&h||((u=sr(l,s,h,e,i))._code=lr(u,e),n.push(u)):(l._code&h&&((u=sr(l,s,h,e,i))._code=lr(u,e),n.push(u)),n.push(s));t=n}return t}function sr(t,e,i,n,r){var o,a,s=e.x-t.x,l=e.y-t.y,c=n.getMin(),h=n.getMax();8&i?(o=t.x+s*(h.y-t.y)/l,a=h.y):4&i?(o=t.x+s*(c.y-t.y)/l,a=c.y):2&i?(o=h.x,a=t.y+l*(h.x-t.x)/s):1&i&&(o=c.x,a=t.y+l*(c.x-t.x)/s);var u=new ae(o,a);return r&&u._round(),u}function lr(t,e){var i=0;return t.x<e.getMin().x?i|=1:t.x>e.getMax().x&&(i|=2),t.y<e.getMin().y?i|=4:t.y>e.getMax().y&&(i|=8),i}function cr(t,e,i,n){t=new ae(t);var r,o,a,s=Math.abs(i.x-e.x),l=Math.abs(i.y-e.y),c=Math.sqrt(Math.abs(s*s-l*l));return s>=l?(r=new ae(e.x-c,e.y),o=new ae(e.x+c,e.y),a=2*s):(r=new ae(e.x,e.y-c),o=new ae(e.x,e.y+c),a=2*l),t.distanceTo(r)+t.distanceTo(o)<=a+2*n}var hr=function(){function t(){}var e=t.prototype;return e.getMap=function(){return this.geometry.getMap()},e.getPainter=function(){return this.painter},e.isDynamicSize=function(){return!1},t.testColor=function(t){return!(!t||!U(t))&&h.indexOf(t)>=0},t}(),ur=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i._prepareContext=function(t){if(Lt(this.symbol.opacity)?this._opacityFn||(this._opacityFn=Rt(this.symbol.opacity)):delete this._opacityFn,N(this.symbol.opacity))t.globalAlpha!==this.symbol.opacity&&(t.globalAlpha=this.symbol.opacity);else if(this._opacityFn){var e=this.getMap();t.globalAlpha=this._opacityFn(e.getZoom())}else 1!==t.globalAlpha&&(t.globalAlpha=1)},i.prepareCanvas=function(t,e,i){fi.prepareCanvas(t,e,i,this.getPainter().isHitTesting())},i.remove=function(){},i.setZIndex=function(){},i.show=function(){},i.hide=function(){},i._defineStyle=function(t){return Jt(t,this.geometry)},e}(hr);function dr(t,e,i,n){var r,o=pr(i),a=i,s=a.markerType.toLowerCase(),l=fr(s,a.markerWidth,a.markerHeight),c=o.lineOpacity,h=o.polygonOpacity;Ke(o.polygonFill)&&(Ke(o.polygonFill)&&(r||(r=function(t,e,i){var n=new pn;return n._combine(t),n.xmin+=-e/2,n.ymin+=-i/2,n.xmax+=e/2,n.ymax+=i/2,n}(e,a.markerWidth,a.markerHeight)),o.polygonGradientExtent=r));fi.prepareCanvas(t,o,n);var u=a.markerWidth,d=a.markerHeight,p=a.markerLineWidth/2;if("ellipse"===s)fi.ellipse(t,e,u/2,d/2,d/2,c,h);else if("cross"===s||"x"===s){for(var f=l.length-1;f>=0;f--)l[f]._add(e);fi.path(t,l.slice(0,2),c),fi.path(t,l.slice(2,4),c)}else if("diamond"===s||"bar"===s||"square"===s||"rectangle"===s||"triangle"===s){"bar"===s?e=e.add(0,-p):"rectangle"===s&&(e=e.add(p,p));for(var m=l.length-1;m>=0;m--)l[m]._add(e);fi.polygon(t,l,c,h)}else if("pin"===s){e=e.add(0,-p);for(var g=l.length-1;g>=0;g--)l[g]._add(e);var y=t.lineCap;t.lineCap="round",fi.bezierCurveAndFill(t,l,c,h),t.lineCap=y}else{if("pie"!==s)throw new Error("unsupported markerType: "+s);e=e.add(0,p);var _=180*Math.atan(u/2/d)/Math.PI,v=t.lineCap;t.lineCap="round",fi.sector(t,e,d,[90-_,90+_],c,h),t.lineCap=v}return t.canvas}function pr(t){var e={lineColor:t.markerLineColor,linePatternFile:t.markerLinePatternFile,lineWidth:t.markerLineWidth,lineOpacity:t.markerLineOpacity,lineDasharray:t.markerLineDasharray,lineCap:"butt",lineJoin:"round",polygonFill:t.markerFill,polygonPatternFile:t.markerFillPatternFile,polygonOpacity:t.markerFillOpacity};return 0===e.lineWidth&&(e.lineOpacity=0),e}function fr(t,e,i){var n,r,o,a,s=i/2,l=e/2;if("triangle"===t)return[n=new ae(0,0-s),r=new ae(0-l,0+s),o=new ae(0+l,0+s)];if("cross"===t)return[n=new ae(0-l,0),r=new ae(0+l,0),o=new ae(0,0-s),a=new ae(0,0+s)];if("diamond"===t)return[n=new ae(0-l,0),r=new ae(0,0-s),o=new ae(0+l,0),a=new ae(0,0+s)];if("square"===t)return[n=new ae(0-l,0+s),r=new ae(0+l,0+s),o=new ae(0+l,0-s),a=new ae(0-l,0-s)];if("rectangle"===t)return r=(n=new ae(0,0)).add(e,0),o=n.add(e,i),a=n.add(0,i),[n,r,o,a];if("x"===t)return[n=new ae(0-l,0+s),r=new ae(0+l,0-s),o=new ae(0+l,0+s),a=new ae(0-l,0-s)];if("bar"===t)return[n=new ae(0-l,0-i),r=new ae(0+l,0-i),o=new ae(0+l,0),a=new ae(0-l,0)];if("pin"===t){var c=i*Math.atan(l/s);return[n=new ae(0,0),r=new ae(0-c,0-i),o=new ae(0+c,0-i),a=new ae(0,0)]}return[]}var mr,gr=new ae(0,0),yr=new ae(0,0),_r=new ae(0,0),vr=new ae(0,0),xr=function(t){function e(e,i,n){var r;return(r=t.call(this)||this).symbol=e,r.geometry=i,r.painter=n,r}ne(e,t);var i=e.prototype;return i.get2DExtent=function(){for(var t=this.getMap(),e=t.getGLZoom(),i=new pn,n=this._getRenderPoints()[0],r=n.length-1;r>=0;r--)n[r]&&i._combine(t._pointToPoint(n[r],e));return i},i.isDynamicSize=function(){var t=this.symbol;return Lt(t.markerWidth)||Lt(t.markerHeight)||Lt(t.textSize)},i._rotateExtent=function(t,e){return t.convertTo((function(t){return t._rotate(e)}))},i._getRenderPoints=function(){var t=this.getPainter().isSpriting()?"center":this.getPlacement();return this.getPainter().getRenderPoints(t)},i._getRenderContainerPoints=function(t){var e=this.getPainter();if(e.isSpriting())return this._getRenderPoints()[0];var i,n=this.geometry,r=this.getDxDy();if(n._cPoint&&!t){var o=t?_r:vr;o.set(n._cPoint.x,n._cPoint.y);var a=e.containerOffset;o._sub(a);var s=r.x,l=r.y;(s||l)&&o._add(s||0,l||0),i=[o]}else{var c=this._getRenderPoints()[0];i=this.painter._pointContainerPoints(c,r.x,r.y,t,!0,this.getPlacement())}if(!i||!Array.isArray(i[0]))return i;for(var h=[],u=0,d=i.length;u<d;u++)for(var p=0,f=i[u].length;p<f;p++)h.push(i[u][p]);return h},i.getPlacement=function(){return this.symbol.markerPlacement},i.getRotation=function(){return Wn(this.style)},i.getDxDy=function(){var t=this.style,e=t.markerDx,i=t.markerDy;return new ae(e,i)},i._getRotationAt=function(t){var e=this.getRotation();e||(e=0);var i=this._getRenderPoints()[1];if(!i||!i[t])return e;var n=this.getMap(),r=i[t][0],o=i[t][1];if(n.isTransforming()){var a=n.getGLZoom();return r=n._pointToContainerPoint(i[t][0],a,0,gr),o=n._pointToContainerPoint(i[t][1],a,0,yr),e+xt(r.x,r.y,o.x,o.y)}return e+-xt(r.x,r.y,o.x,o.y)},i._rotate=function(t,e,i){if(i){var n=this.getDxDy(),r=e.sub(n);return t.save(),t.translate(r.x,r.y),t.rotate(i),n}return null},e}(ur),br=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getPlacement=function(){return"point"},i.getDxDy=function(){return new ae(0,0)},i.symbolize=function(t){var e=this.geometry,i=e.getLayer();if(e.options.debug||!i||i.options.debug){var n=this.getMap();if(n&&!n.isZooming()){var r=i.options.debugOutline;t.strokeStyle=r,t.fillStyle=r;var o=e.getContainerExtent().toArray();fi.polygon(t,[o],1,0);for(var a=this._getRenderContainerPoints(),s=this.geometry.getId(),l=fr("cross",10,10),c=0;c<a.length;c++){var h=a[c];F(s)||fi.fillText(t,s,h.add(8,-4),r);for(var u=[],d=0;d<l.length;d++)u.push(l[d].add(h));fi.path(t,u.slice(0,2),1),fi.path(t,u.slice(2,4),1)}}}},e}(xr),wr=new se(1,1),Mr=function(t){function e(e,i,n){var r;return(r=t.call(this,e,i,n)||this).style=r._defineStyle(r.translate()),r}ne(e,t),e.test=function(t){return Kn(t)};var i=e.prototype;return i.symbolize=function(t,e){var i=this.style;if(this.painter.isHitTesting()||0!==i.markerWidth&&0!==i.markerHeight&&0!==i.markerOpacity){var n=this._getRenderContainerPoints();if(dt(n)){var r=this._getImage(e);if(r){this._prepareContext(t);var o,a=i.markerWidth,s=i.markerHeight;if(!N(a)||!N(s)){a=r.width,s=r.height,i.markerWidth=a,i.markerHeight=s;var l=i.markerFile;e.isResourceLoaded(l)||e.addResource(l,r);var c=this.getPainter();c.isSpriting()||c.removeCache()}"path"!==this.symbol.markerType&&N(i.markerOpacity)&&i.markerOpacity<1&&(o=t.globalAlpha,t.globalAlpha*=i.markerOpacity),wr.width=a,wr.height=s;for(var h=Xe(wr,i.markerHorizontalAlignment,i.markerVerticalAlignment),u=0,d=n.length;u<d;u++){var p=n[u],f=this.getRotation()?this._rotate(t,p,this._getRotationAt(u)):null;f&&(p=f),fi.image(t,r,p.x+h.x,p.y+h.y,a,s),f&&t.restore()}void 0!==o&&(t.globalAlpha=o)}else"undefined"!=typeof console&&console.warn("no img found for "+(this.style.markerFile||this._url[0]))}}},i._getImage=function(t){return function(t,e){return t&&t.getImage(e)||null}(t,this.style.markerFile)},i.getFixedExtent=function(t){return this._fixedExtent=this._fixedExtent||new pn,qn(this._fixedExtent,this.style,t)},i.translate=function(){var t=this.symbol;return{markerFile:t.markerFile,markerOpacity:at(t.markerOpacity,1),markerWidth:at(t.markerWidth,null),markerHeight:at(t.markerHeight,null),markerRotation:at(t.markerRotation,0),markerDx:at(t.markerDx,0),markerDy:at(t.markerDy,0),markerHorizontalAlignment:at(t.markerHorizontalAlignment,"middle"),markerVerticalAlignment:at(t.markerVerticalAlignment,"top")}},e}(xr),Tr=new $i(0,0),Sr=new $i(0,0),Er=function(t){function e(e,i,n){var r;return(r=t.call(this)||this).symbol=e,r.geometry=i,r.painter=n,"Point"===i.type?re(r):(r.style=r._defineStyle(r.translate()),r)}ne(e,t),e.test=function(t,e){if(!t)return!1;if(e&&"Point"===e.type)return!1;for(var i in t){var n=i.slice(0,4);if("line"===n||"poly"===n)return!0}return!1};var i=e.prototype;return i.symbolize=function(t,e){var i=this.style;if(0!==i.polygonOpacity||0!==i.lineOpacity||this.painter.isHitTesting()){var n=this._getPaintParams();if(n){this._prepareContext(t);var r=Ke(i.lineColor),o="Polygon"===this.geometry.getJSONType()||"LineString"===this.geometry.type;!r||!i.lineColor.places&&o||(i.lineGradientExtent=this.geometry.getContainerExtent()._expand(i.lineWidth)),Ke(i.polygonFill)&&(i.polygonGradientExtent=this.geometry.getContainerExtent());var a=n[0];if("Polygon"===this.geometry.getJSONType()&&a.length>0&&Array.isArray(a[0][0])||"LineString"===this.geometry.type&&a.length>0&&Array.isArray(a[0]))for(var s=0;s<a.length;s++){this.prepareCanvas(t,i,e),r&&o&&!i.lineColor.places&&this._createGradient(t,a[s],i.lineColor);var l=[t,a[s]];n.length>1&&l.push.apply(l,n.slice(1)),l.push(i.lineOpacity,i.polygonOpacity,i.lineDasharray),this.geometry._paintOn.apply(this.geometry,l)}else{this.prepareCanvas(t,i,e),r&&o&&!i.lineColor.places&&this._createGradient(t,a,i.lineColor);var c=[t];c.push.apply(c,n),c.push(i.lineOpacity,i.polygonOpacity,i.lineDasharray),this.geometry._paintOn.apply(this.geometry,c)}t.setLineDash&&Array.isArray(i.lineDasharray)&&t.setLineDash([])}}},i.get2DExtent=function(){var t=this.getMap(),e=this.geometry._getPrjExtent();if(!e)return null;this._extMin&&this._extMax||(this._extMin=new $i(0,0),this._extMax=new $i(0,0)),this._extMin.x=e.xmin,this._extMin.y=e.ymin,this._extMax.x=e.xmax,this._extMax.y=e.ymax;var i=t._prjToPoint(this._extMin,void 0,Tr),n=t._prjToPoint(this._extMax,void 0,Sr);return this._pxExtent?this._pxExtent.set(Math.min(i.x,n.x),Math.min(i.y,n.y),Math.max(i.x,n.x),Math.max(i.y,n.y)):this._pxExtent=new pn(i,n),this._pxExtent},i.getFixedExtent=function(){var t=this.style.lineWidth/2;return new pn(-t,-t,t,t)},i._getPaintParams=function(){return this.getPainter().getPaintParams(this.style.lineDx,this.style.lineDy)},i.translate=function(){var t=this.symbol,e={lineColor:at(t.lineColor,"#000"),lineWidth:at(t.lineWidth,2),lineOpacity:at(t.lineOpacity,1),lineDasharray:at(t.lineDasharray,[]),lineCap:at(t.lineCap,"butt"),lineJoin:at(t.lineJoin,"miter"),linePatternFile:at(t.linePatternFile,null),lineDx:at(t.lineDx,0),lineDy:at(t.lineDy,0),polygonFill:at(t.polygonFill,null),polygonOpacity:at(t.polygonOpacity,1),polygonPatternFile:at(t.polygonPatternFile,null),polygonPatternDx:at(t.polygonPatternDx,0),polygonPatternDy:at(t.polygonPatternDy,0),linePatternDx:at(t.linePatternDx,0),linePatternDy:at(t.linePatternDy,0)};return 0===e.lineWidth&&(e.lineOpacity=0),"LineString"!==this.geometry.type||e.polygonFill||(e.polygonFill=e.lineColor),e},i._createGradient=function(t,e,i){if(Array.isArray(e)&&e.length){var n=e.length,r=t.createLinearGradient(e[0].x,e[0].y,e[n-1].x,e[n-1].y);i.colorStops.forEach((function(t){r.addColorStop.apply(r,t)})),t.strokeStyle=r}},e}(ur),Cr=function(t){function e(e,i,n){var r,o=(r=t.call(this,e,i,n)||this).translate();return r._dynamic=It(o),r.style=r._defineStyle(o),0===r.style.textWrapWidth?re(r):(r.strokeAndFill=r._defineStyle(r.translateLineAndFill(r.style)),r)}ne(e,t),e.test=function(t){return Jn(t)};var i=e.prototype;return i.symbolize=function(t,e){if(this.painter.isHitTesting()||0!==this.style.textSize&&(this.style.textOpacity||this.style.textHaloRadius&&this.style.textHaloOpacity)&&0!==this.style.textWrapWidth){var i=this._getRenderContainerPoints();if(dt(i)){var n=this.style,r=this.strokeAndFill,o=We(this.style.textName,this.geometry.getProperties());this._dynamic&&delete this._textDesc;var a=this._textDesc=this._textDesc||qe(o,this.style);this._prepareContext(t),this.prepareCanvas(t,r,e),fi.prepareCanvasFont(t,n);for(var s=0,l=i.length;s<l;s++){var c=i[s],h=this.getRotation()?this._rotate(t,c,this._getRotationAt(s)):null;h&&(c=h),fi.text(t,o,c,n,a),h&&t.restore()}}}},i.getPlacement=function(){return this.symbol.textPlacement},i.getRotation=function(){var t=this.style.textRotation;return N(t)?-t*Math.PI/180:null},i.getDxDy=function(){var t=this.style;return new ae(t.textDx,t.textDy)},i.getFixedExtent=function(){var t=this.geometry.getTextDesc();return this._fixedExtent=this._fixedExtent||new pn,Xn(this._fixedExtent,this.style,t)},i.translate=function(){var t=this.symbol,e={textName:t.textName,textFaceName:at(t.textFaceName,"monospace"),textWeight:at(t.textWeight,"normal"),textStyle:at(t.textStyle,"normal"),textSize:at(t.textSize,14),textFont:at(t.textFont,null),textFill:at(t.textFill,"#000"),textOpacity:at(t.textOpacity,1),textHaloFill:at(t.textHaloFill,"#ffffff"),textHaloRadius:at(t.textHaloRadius,0),textHaloOpacity:at(t.textHaloOpacity,1),textWrapWidth:at(t.textWrapWidth,null),textWrapCharacter:at(t.textWrapCharacter,"\n"),textLineSpacing:at(t.textLineSpacing,0),textDx:at(t.textDx,0),textDy:at(t.textDy,0),textHorizontalAlignment:at(t.textHorizontalAlignment,"middle"),textVerticalAlignment:at(t.textVerticalAlignment,"middle"),textAlign:at(t.textAlign,"center"),textRotation:at(t.textRotation,0),textMaxWidth:at(t.textMaxWidth,0),textMaxHeight:at(t.textMaxHeight,0)};return e.textMaxWidth>0&&(!e.textWrapWidth||e.textWrapWidth>e.textMaxWidth)&&(e.textWrapWidth||(e.textMaxHeight=1),e.textWrapWidth=e.textMaxWidth),e},i.translateLineAndFill=function(t){return{lineColor:t.textHaloRadius?t.textHaloFill:t.textFill,lineWidth:t.textHaloRadius,lineOpacity:t.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.textFill,polygonOpacity:t.textOpacity}},e}(xr),Ar=[],Pr=function(t){function e(e,i,n){var r,o=(r=t.call(this,e,i,n)||this).translate();return r._dynamic=It(o),r.style=r._defineStyle(o),r.strokeAndFill=r._defineStyle(pr(r.style)),r.padding=0,r}ne(e,t),e.test=function(t){return Qn(t)};var i=e.prototype;return i.symbolize=function(t,e){var i=this.style;if(this.painter.isHitTesting()||0!==i.markerWidth&&0!==i.markerHeight&&(0!==i.polygonOpacity||0!==i.lineOpacity)){var n=this._getRenderContainerPoints();dt(n)&&(this._prepareContext(t),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this._dynamic||!1===this.geometry.getLayer().options.cacheVectorOnCanvas?this._drawMarkers(t,n,e):this._drawMarkersWithCache(t,n,e))}},i._drawMarkers=function(t,e,i){for(var n=e.length-1;n>=0;n--){var r=e[n],o=this.getRotation()?this._rotate(t,r,this._getRotationAt(n)):null;o&&(r=o),this._drawVectorMarker(t,r,i),o&&t.restore()}},i._drawMarkersWithCache=function(t,e,i){var n=this._stampSymbol(),r=i.getImage(n);r||(r=this._createMarkerImage(t,i),i.addResource([n,r.width,r.height],r));for(var o=Vn(this.style,r.width,r.height),a=e.length-1;a>=0;a--){var s=e[a],l=this.getRotation()?this._rotate(t,s,this._getRotationAt(a)):null;l&&(s=l),fi.image(t,r,s.x+o.x,s.y+o.y),l&&t.restore()}},i._createMarkerImage=function(t,e){var i=t.canvas.constructor,n=Hn(Ar,this.style),r=fi.createCanvas(n[0],n[1],i),o=this._getCacheImageAnchor(n[0],n[1]),a=r.getContext("2d");return this._drawVectorMarker(a,o,e),r},i._stampSymbol=function(){return this._stamp||(this._stamp=Je([this.style.markerType,Ke(this.style.markerFill)?Qe(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,Ke(this.style.markerLineColor)?Qe(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight,this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment].join("_"))),this._stamp},i._getCacheImageAnchor=function(t,e){var i=2*(this.symbol.shadowBlur||0)+this.padding,n=this.style.markerType;return"bar"===n||"pie"===n||"pin"===n?new ae(t/2,e-i):"rectangle"===n?new ae(i,i):new ae(t/2,e/2)},i._getGraidentExtent=function(t){var e=new pn,i=this.getDxDy(),n=this.getFixedExtent();if(Array.isArray(t))for(var r=t.length-1;r>=0;r--)e._combine(t[r]);else e._combine(t);return e.xmin+=n.xmin-i.x,e.ymin+=n.ymin-i.y,e.xmax+=n.xmax-i.x,e.ymax+=n.ymax-i.y,e},i._drawVectorMarker=function(t,e,i){dr(t,e,this.style,i)},i.getFixedExtent=function(){return this._fixedExtent=this._fixedExtent||new pn,Nn(this._fixedExtent,this.style)},i.translate=function(){var t=this.symbol,e={markerType:at(t.markerType,"ellipse"),markerFill:at(t.markerFill,"#00f"),markerFillOpacity:at(t.markerFillOpacity,1),markerFillPatternFile:at(t.markerFillPatternFile,null),markerLineColor:at(t.markerLineColor,"#000"),markerLineWidth:at(t.markerLineWidth,1),markerLineOpacity:at(t.markerLineOpacity,1),markerLineDasharray:at(t.markerLineDasharray,[]),markerLinePatternFile:at(t.markerLinePatternFile,null),markerDx:at(t.markerDx,0),markerDy:at(t.markerDy,0),markerWidth:at(t.markerWidth,10),markerHeight:at(t.markerHeight,10),markerRotation:at(t.markerRotation,0)},i=e.markerType,n=jn(i),r=Gn(i);return e.markerHorizontalAlignment=at(t.markerHorizontalAlignment,n),e.markerVerticalAlignment=at(t.markerVerticalAlignment,r),N(t.markerOpacity)&&(N(t.markerFillOpacity)&&(e.markerFillOpacity*=t.markerOpacity),N(t.markerLineOpacity)&&(e.markerLineOpacity*=t.markerOpacity)),e},e}(xr),Lr=function(t){function e(e,i,n){var r;F(e.markerWidth)&&(e.markerWidth=80),F(e.markerHeight)&&(e.markerHeight=80),e=B(e,(r=t.call(this,e,i,n)||this).translate());var o=r.style=r._defineStyle(e);return O.gecko?r._url=[Qt(o,o.markerWidth,o.markerHeight),o.markerWidth,o.markerHeight]:r._url=[Qt(o),o.markerWidth,o.markerHeight],r}ne(e,t),e.test=function(t){return tr(t)};var i=e.prototype;return i._prepareContext=function(){},i._getImage=function(t){var e=this;if(t&&t.isResourceLoaded(this._url))return t.getImage(this._url);var i=this.painter,n=new Image;return n.onload=function(){var t=i.getLayer()&&i.getLayer().getRenderer();t&&t.setToRedraw()},n.onerror=function(i){i&&"undefined"!=typeof console&&console.warn(i),t.markErrorResource(e._url)},n.src=this._url[0],t&&t.addResource(this._url,n),n},e}(Mr),Ir={lineWidth:1,polygonFill:"#fff",polygonOpacity:.5},Rr=function(t){function e(e,i,n){var r;return(r=t.call(this,e,i,n)||this).style=i.getLayer().options.drawAltitude,r.style&&G(r.style)||(r.style={lineWidth:2}),r.style.lineWidth||(r.style.lineWidth=0),r.dxdy=r._defineStyle({dx:e.textDx||e.markerDx,dy:e.textDy||e.markerDy}),r}ne(e,t),e.test=function(t,e){if(!e.getLayer())return!1;var i=e.getJSONType();return"Marker"===i||"LineString"===i};var i=e.prototype;return i.symbolize=function(t){var e=this.geometry.getLayer();if(e.options.drawAltitude){var i=this.geometry.getProperties();if(i&&i[e.options.altitudeProperty]){var n=this._getStyle();if(this._prepareContext(t),"LineString"===this.geometry.type){var r=this._getPaintParams(n.lineDx,n.lineDy);if(!r)return;var o=this.getPainter().getPaintParams(n.lineDx,n.lineDy,!0)[0];this._drawLineAltitude(t,r[0],o)}else{var a=this._getRenderContainerPoints(),s=this._getRenderContainerPoints(!0);if(!a||0===a.length)return;this._drawMarkerAltitude(t,a[0],s[0])}}}},i.getDxDy=function(){var t=this.dxdy;return new ae(t.dx||0,t.dy||0)},i.get2DExtent=function(){return"LineString"===this.geometry.type?Er.prototype.get2DExtent.apply(this):t.prototype.get2DExtent.call(this)},i.getPlacement=function(){return"point"},i._getPaintParams=function(t,e){return this.getPainter().getPaintParams(t||0,e||0)},i._drawMarkerAltitude=function(t,e,i){var n=this._getStyle();this.prepareCanvas(t,n),fi.path(t,[e,i],n.lineOpacity,null,n.lineDasharray)},i._drawLineAltitude=function(t,e,i){var n=this._getStyle();if(e.length>0&&Array.isArray(e[0]))for(var r=0;r<e.length;r++)this._drawLine(t,e[r],i[r]);else this._drawLine(t,e,i);t.setLineDash&&Array.isArray(n.lineDasharray)&&t.setLineDash([])},i._drawLine=function(t,e,i){var n=this._getStyle();this.prepareCanvas(t,n);for(var r=0,o=e.length-1;r<o;r++)fi.polygon(t,[e[r],e[r+1],i[r+1],i[r]],n.lineOpacity,n.polygonOpacity,n.lineDasharray)},i._getStyle=function(){var t=this.geometry.getLayer().options.drawAltitude;return G(t)||(t=Ir),t.lineWidth||(t.lineWidth=0,t.lineOpacity=0),t},e}(xr),Dr=[Rr,Er,Mr,Lr,Pr,Cr],kr=new ae(0,0),Or=new pn,zr=new pn,Br=new pn,Fr={minx:1/0,miny:1/0,maxx:-1/0,maxy:-1/0},Nr=function(t){function e(e){var i;return(i=t.call(this)||this).geometry=e,i.symbolizers=i._createSymbolizers(),i._altAtGLZoom=i._getGeometryAltitude(),i}ne(e,t);var i=e.prototype;return i.getMap=function(){return this.geometry.getMap()},i.getLayer=function(){return this.geometry.getLayer()},i._createSymbolizers=function(){var t=this.getSymbol(),e=[],i=Dr,n=t;Array.isArray(t)||(n=[t]);for(var r=n.length-1;r>=0;r--)for(var o=n[r],a=i.length-1;a>=0;a--)if(i[a].test(o,this.geometry)){var s=new i[a](o,this.geometry,this);e.push(s),s instanceof xr&&(this._hasPoint=!0)}if(!e.length&&console){var l=this.geometry.getId();console.warn("invalid symbol for geometry("+(this.geometry?this.geometry.getType()+(l?":"+l:""):"")+") to draw : "+JSON.stringify(t))}return this._debugSymbolizer=new br(t,this.geometry,this),e},i.hasPoint=function(){return!!this._hasPoint},i.getRenderPoints=function(t){return this._renderPoints||(this._renderPoints={}),t||(t="center"),this._renderPoints[t]||(this._renderPoints[t]=this.geometry._getRenderPoints(t)),this._renderPoints[t]},i.getPaintParams=function(t,e,i){var n,r,o,a,s,l=this.getLayer()._getRenderer().mapStateCache,c=this.getMap();l&&!this._hitPoint?(n=l.resolution,r=l.pitch,o=l.bearing,a=l.glScale,s=l.containerExtent):(n=c.getResolution(),r=c.getPitch(),o=c.getBearing(),a=c.getGLScale(),s=c.getContainerExtent());var h=this.geometry,u=n,d=0!==r,p=0!==o,f=this._cachedParams,m=h._paintAsPath&&h._paintAsPath();if(m&&this._unsimpledParams&&u<=this._unsimpledParams._res)f=this._unsimpledParams;else if(!f||f._res!==n||this._pitched!==d&&h._redrawWhenPitch()||this._rotated!==p&&h._redrawWhenRotate()){if(!(f=h._getPaintParams()))return null;f._res=u,!h._simplified&&m&&(this._unsimpledParams||(this._unsimpledParams=f),u>this._unsimpledParams._res&&(this._unsimpledParams._res=u)),this._cachedParams=f}if(!f)return null;this._pitched=d,this._rotated=p;var g=a,y=[],_=f[0],v=s,x=this._pointContainerPoints(_,t,e,i,this._hitPoint&&!v.contains(this._hitPoint));if(!x)return null;y.push(x);for(var b=1,w=f.length;b<w;b++)N(f[b])||f[b]instanceof se?N(f[b])?y.push(f[b]/g):y.push(f[b].multi(1/g)):y.push(f[b]);return y},i._pointContainerPoints=function(t,e,i,n,r,o){if(this._aboveCamera())return null;var a,s,l=this.getLayer()._getRenderer().mapStateCache,c=this.getMap(),h=this.containerOffset;a=l?l.glZoom:c.getGLZoom();var u=this.getLayer().options.roundPoint,d=1/0,p=1/0,f=-1/0,m=-1/0;function g(t,n){void 0===t&&(t=[]),void 0===n&&(n=[]);for(var r=c._pointsToContainerPoints(t,a,n),o=0,s=r.length;o<s;o++){var l=r[o];l._sub(h),(e||i)&&l._add(e||0,i||0),u&&(l.x=Math.ceil(l.x),l.y=Math.ceil(l.y)),d=Math.min(l.x,d),p=Math.min(l.y,p),f=Math.max(l.x,f),m=Math.max(l.y,m)}return r}var y=this.getAltitude();if(Array.isArray(t)){var _,v=this.geometry,x=(_=!r&&v.options.enableClip?this._clip(t,y):{points:t,altitude:y}).points;y=_.altitude,n&&(y=0);var b=y;s=[];for(var w=[],M=N(y),T=0,S=x.length;T<S;T++){var E=x[T];if(Array.isArray(E)){if(M){var C=g(E,y);s.push(C);continue}for(var A=[],P=0,L=E.length;P<L;P++)Array.isArray(y)&&(b=y[T]?y[T][P]:0),A.push(b);var I=g(E,A);s.push(I)}else Array.isArray(y)&&(b="vertex-last"===o?y[y.length-1-T]:"line"===o?(y[T]+y[T+1])/2:y[T]),w.push(b)}w.length&&(s=g(x,w))}else t instanceof ae&&(n&&(y=0),s=c._pointToContainerPoint(t,a,y)._sub(h),(e||i)&&s._add(e,i));return Fr.minx=d,Fr.miny=p,Fr.maxx=f,Fr.maxy=m,this._containerBbox=Fr,s},i._clip=function(t,e){var i=this.getMap(),n=this.geometry,r=this.getSymbol().lineWidth;N(r)||(r=4);var o,a,s,l=this.getLayer()._getRenderer().mapStateCache;l?(o=l._2DExtent,a=l.glExtent,s=l.pitch):(o=i._get2DExtent(),a=i._get2DExtent(i.getGLZoom()),s=i.getPitch());var c=o._expand(r);if(s>0&&e){var h=i.cameraLookAt,u=i.cameraPosition;kr.set(u.x,u.y),c=c._combine(kr._add(st(h[0]-u[0]),st(h[1]-u[1])))}var d=t;if(this.get2DExtent(null,Br).within(c))return{points:d,altitude:e};var p=a._expand(r*i._glScale),f=n.options.smoothness;if(n.getShell&&this.geometry.getHoles&&!f)if(Array.isArray(t[0])){d=[];for(var m=0;m<t.length;m++){var g=ar(t[m],p);g.length&&d.push(g)}}else d=ar(t,p);else if("LineString"===n.getJSONType()&&!f){if(Array.isArray(t[0])){d=[];for(var y=0;y<t.length;y++)nt(d,rr(t[y],p,!1,!!f))}else d=rr(t,p,!1,!!f);return this._interpolateSegAlt(d,t,e)}return{points:d,altitude:e}},i._interpolateSegAlt=function(t,e,i){if(!Array.isArray(i)){var n=function(t){return t.point};return{points:t.map((function(t){return Array.isArray(t)?t.map(n):t.point})),altitude:i}}var r=function t(e,i,n){if(!Array.isArray(n))return e;for(var r=[],o=0,a=e.length;o<a;o++)if(Array.isArray(e[o]))r.push(t(e[o],i,n));else{var s=e[o];if(s.point.equals(i[s.index]))s.altitude=n[s.index],r.push(s);else{var l=void 0,c=void 0;0===s.index?(l=s.index,c=s.index+1):(l=s.index-1,c=s.index);var h=s.point.distanceTo(i[c]),u=h/(h+i[l].distanceTo(s.point)),d=ct(n[l],n[c],1-u);s.altitude=d,r.push(s)}}return r}(t,e,i);return i=[],{points:r.map((function(t){if(Array.isArray(t)){var e=[],n=t.map((function(t){return e.push(t.altitude),t.point}));return i.push(e),n}return i.push(t.altitude),t.point})),altitude:i}},i.getSymbol=function(){return this.geometry._getInternalSymbol()},i.paint=function(t,e,i){if(this.symbolizers){var n=this.getLayer()._getRenderer();if(n&&(n.context||e)){var r=n.mapStateCache||{};if(this.geometry._isCheck||!t||t.intersects(this.get2DExtent(n.resources,Or))){var o=this.getMap(),a=this.getMinAltitude(),s=o.getFrustumAltitude();if(!(a&&s&&s<a)){this.containerOffset=i||r.offset||o._pointToContainerPoint(n.southWest)._add(0,-o.height),this._beforePaint();for(var l=e||n.context,c=[l,n.resources],h=this.symbolizers.length-1;h>=0;h--)this._prepareShadow(l,this.symbolizers[h].symbol),this.symbolizers[h].symbolize.apply(this.symbolizers[h],c);this._afterPaint(),this._painted=!0,this._debugSymbolizer.symbolize.apply(this._debugSymbolizer,c)}}}}},i.getSprite=function(t,e){if("Point"!==this.geometry.type)return null;if(this._spriting=!0,!this._sprite&&this.symbolizers.length>0){var i=new pn;this.symbolizers.forEach((function(e){var n=e.getFixedExtent(t);i._combine(n)}));var n,r=i.getMin().multi(-1),o=e||(this.getMap()?this.getMap().CanvasClass:null),a=fi.createCanvas(i.getWidth(),i.getHeight(),o);this._renderPoints&&(n=this._renderPoints);for(var s=a.getContext("2d"),l=[s,t],c=this.symbolizers.length-1;c>=0;c--){var h=this.symbolizers[c].getDxDy();this._renderPoints={center:[[r.add(h)]]},this._prepareShadow(s,this.symbolizers[c].symbol),this.symbolizers[c].symbolize.apply(this.symbolizers[c],l)}n&&(this._renderPoints=n),this._sprite={canvas:a,offset:i.getCenter()}}return this._spriting=!1,this._sprite},i.isSpriting=function(){return!!this._spriting},i.hitTest=function(t,e){if((!e||e<.5)&&(e=.5),!mr){var i=this.getMap()?this.getMap().CanvasClass:null;mr=fi.createCanvas(1,1,i)}fi.setHitTesting(!0),mr.width=mr.height=2*e;var n=mr.getContext("2d");this._hitPoint=t.sub(e,e);try{this.paint(null,n,this._hitPoint)}catch(t){throw t}finally{fi.setHitTesting(!1)}delete this._hitPoint;for(var r=n.getImageData(0,0,mr.width,mr.height).data,o=3,a=r.length;o<a;o+=4)if(r[o]>0)return!0;return!1},i.isHitTesting=function(){return!!this._hitPoint},i._prepareShadow=function(t,e){e.shadowBlur?(t.shadowBlur=this.isHitTesting()?0:e.shadowBlur,t.shadowColor=e.shadowColor||"#000",t.shadowOffsetX=e.shadowOffsetX||0,t.shadowOffsetY=e.shadowOffsetY||0):t.shadowBlur&&(t.shadowBlur=null,t.shadowColor=null,t.shadowOffsetX=null,t.shadowOffsetY=null)},i._eachSymbolizer=function(t,e){if(this.symbolizers){e||(e=this);for(var i=this.symbolizers.length-1;i>=0;i--)t.apply(e,[this.symbolizers[i]])}},i.get2DExtent=function(t,e){this._verifyProjection();var i=this.getMap();t=t||this.getLayer()._getRenderer().resources;var n=i.getZoom(),r=this._isDynamicSize();if(this._extent2D&&this._extent2D._zoom===n&&this._fixedExtent||(this._extent2D&&this._extent2D._zoom!==n&&delete this._extent2D,this.symbolizers&&(this._extent2D||(this._extent2D=this._computeExtent2D(new pn),this._extent2D._zoom=n),this._fixedExtent||(this._fixedExtent=this._computeFixedExtent(t,new pn)))),!this._extent2D)return r&&delete this._fixedExtent,null;var o=this._fixedExtent,a=o.xmin,s=o.ymin,l=o.xmax,c=o.ymax;return r&&delete this._fixedExtent,zr.set(a,-c,l,-s),e?(e.set(this._extent2D.xmin,this._extent2D.ymin,this._extent2D.xmax,this._extent2D.ymax),e._add(zr),e):this._extent2D.add(zr)},i._computeExtent2D=function(t){for(var e=this.symbolizers.length-1;e>=0;e--){var i=this.symbolizers[e];t._combine(i.get2DExtent())}return t},i._computeFixedExtent=function(t,e){for(var i=this.symbolizers.length-1;i>=0;i--){var n=this.symbolizers[i];n.getFixedExtent&&e._combine(n.getFixedExtent(t))}return e},i._isDynamicSize=function(){for(var t=this.symbolizers.length-1;t>=0;t--){if(this.symbolizers[t].isDynamicSize())return!0}return!1},i._aboveCamera=function(){var t=this.getMinAltitude(),e=this.getMap().getFrustumAltitude();return t&&e&&e<t},i.getFixedExtent=function(){var t=this.getMap().getZoom();return this._isDynamicSize()?this._computeFixedExtent(null,new pn):(this._extent2D&&this._extent2D._zoom===t||this.get2DExtent(null,zr),this._fixedExtent)},i.setZIndex=function(t){this._eachSymbolizer((function(e){e.setZIndex(t)}))},i.show=function(){this._painted?(this.removeCache(),this._eachSymbolizer((function(t){t.show()}))):this.getLayer().isCanvasRender()||this.paint()},i.hide=function(){this._eachSymbolizer((function(t){t.hide()}))},i.repaint=function(){this._altAtGLZoom=this._getGeometryAltitude(),this.removeCache();var t=this.getLayer();if(t){var e=t.getRenderer();e&&e.setToRedraw()&&e.setToRedraw()}},i.refreshSymbol=function(){this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers()},i.remove=function(){this.removeCache(),this._removeSymbolizers()},i._removeSymbolizers=function(){this._eachSymbolizer((function(t){delete t.painter,t.remove()})),delete this.symbolizers},i.removeCache=function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,delete this._extent2D,delete this._fixedExtent,delete this._cachedParams,delete this._unsimpledParams},i.getAltitude=function(){return this.geometry.getAltitude()!==this._propAlt&&(this._altAtGLZoom=this._getGeometryAltitude()),this._altAtGLZoom?this._altAtGLZoom:0},i.getMinAltitude=function(){return this.minAltitude?this.minAltitude:0},i.getMaxAltitude=function(){return this.maxAltitude?this.maxAltitude:0},i._getGeometryAltitude=function(){var t=this;if(!this.getMap())return 0;var e=this.geometry.getAltitude();if(this._propAlt=e,!e)return this.minAltitude=this.maxAltitude=0,0;var i=this.geometry.getCenter();return i?Array.isArray(e)?(this.minAltitude=Number.MAX_VALUE,this.maxAltitude=Number.MIN_VALUE,e.map((function(e){var n=t._meterToPoint(i,e);return n<t.minAltitude&&(t.minAltitude=n),n>t.maxAltitude&&(t.maxAltitude=n),n}))):(this.minAltitude=this.maxAltitude=this._meterToPoint(i,e),this.minAltitude):0},i._meterToPoint=function(t,e){var i=this.getMap(),n=i.getGLZoom();return i.distanceToPoint(e,0,n,t).x*st(e)},i._verifyProjection=function(){var t=this.geometry._getProjection();this._projCode&&this._projCode!==t.code&&this.removeCache(),this._projCode=t.code},i._beforePaint=function(){},i._afterPaint=function(){},e}(Si);var jr=new pn,Gr=function(t){function e(e,i){var n;return(n=t.call(this)||this).geometry=e,n.isMask=i,n}ne(e,t);var i=e.prototype;return i._eachPainter=function(t){for(var e,i=this.geometry.getGeometries(),n=0,r=i.length;n<r&&(!(e=this.isMask?i[n]._getMaskPainter():i[n]._getPainter())||!e||!1!==t.call(this,e));n++);},i.paint=function(t){this.geometry&&this._eachPainter((function(e){e.paint(t)}))},i.get2DExtent=function(t,e){e&&e.set(null,null,null,null);var i=e||new pn;return this._eachPainter((function(e){i=i._combine(e.get2DExtent(t,jr))})),i},i.remove=function(){var t=arguments;this._eachPainter((function(e){e.remove.apply(e,t)}))},i.setZIndex=function(){var t=arguments;this._eachPainter((function(e){e.setZIndex.apply(e,t)}))},i.show=function(){var t=arguments;this._eachPainter((function(e){e.show.apply(e,t)}))},i.hide=function(){var t=arguments;this._eachPainter((function(e){e.hide.apply(e,t)}))},i.repaint=function(){var t=arguments;this._eachPainter((function(e){e.repaint.apply(e,t)}))},i.refreshSymbol=function(){var t=arguments;this._eachPainter((function(e){e.refreshSymbol.apply(e,t)}))},i.hasPoint=function(){var t=!1;return this._eachPainter((function(e){return!e.hasPoint()||(t=!0,!1)})),t},i.getMinAltitude=function(){var t=!0,e=0;return this._eachPainter((function(i){var n=i.getMinAltitude();(t||n<e)&&(t=!1,e=n)})),e},i.getMaxAltitude=function(){var t=0;return this._eachPainter((function(e){var i=e.getMaxAltitude();i>t&&(t=i)})),t},e}(Si),Ur={"EPSG:3857":{resolutions:function(){for(var t=[],e=12756274*Math.PI,i=0;i<23;i++)t[i]=e/(256*Math.pow(2,i));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],e=0;e<23;e++)t[e]=180/(128*Math.pow(2,e));return t}()},BAIDU:{resolutions:function(){for(var t=Math.pow(2,18),e=[],i=0;i<23;i++)e[i]=t,t*=.5;return e}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}},IDENTITY:{resolutions:function(){for(var t=Math.pow(2,8),e=[],i=0;i<23;i++)e[i]=t,t*=.5;return e}(),fullExtent:{top:2e5,left:-2e5,bottom:-2e5,right:2e5}}};Ur["EPSG:4490"]=Ur["EPSG:4326"];var Vr=function(){function t(t){void 0===t&&(t={}),this.options=t,this._initSpatialRef()}t.getProjectionInstance=function(t){if(!t)return null;if(G(t))return t;for(var e in t=(t+"").toLowerCase(),Rn)if(Z(Rn,e)){var i=Rn[e].code;if(i&&i.toLowerCase()===t)return Rn[e]}return null},t.equals=function(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;if(t.projection!==e.projection)return!1;var i=t.fullExtent,n=e.fullExtent;if(i&&!n||!i&&n)return!1;if(i&&n&&(i.top!==n.top||i.bottom!==n.bottom||i.left!==n.left||i.right!==n.right))return!1;var r=t.resolutions,o=e.resolutions;if(r&&o){if(r.length!==o.length)return!1;for(var a=0;a<r.length;a++)if(r[a]!==o[a])return!1}else if(r||o)return!1;return!0};var e=t.prototype;return e._initSpatialRef=function(){var e=this.options.projection;if(!(e=e?t.getProjectionInstance(e):In))throw new Error("must provide a valid projection in map's spatial reference.");(e=B({},mn,e)).measureLength||B(e,Sn.DEFAULT),this._projection=e;var i,n=this.options.resolutions;if(!n&&(e.code&&(i=Ur[e.code])&&(n=i.resolutions,this.isEPSG="IDENTITY"!==e.code),!n))throw new Error("must provide valid resolutions in map's spatial reference.");this._resolutions=n,this._pyramid=!0;for(var r=0;r<n.length;r++)if(n[r]&&n[r-1]&&n[r]/n[r-1]==2){this._pyramid=!1;break}var o=this.options.fullExtent;if(!o&&(e.code&&(i=Ur[e.code])&&(o=i.fullExtent),!o))throw new Error("must provide a valid fullExtent in map's spatial reference.");if(F(o.left)?(this._fullExtent=new un(o),o.left=o.xmin,o.right=o.xmax,o.top=o.ymax,o.bottom=o.ymin):this._fullExtent=new un(new $i(o.left,o.top),new $i(o.right,o.bottom)),F(o.top)||F(o.bottom)||F(o.left)||F(o.right))throw new Error("must provide valid top/bottom/left/right in fullExtent.");B(this._fullExtent,o),this._projection.fullExtent=o;var a=o.right>=o.left?1:-1,s=o.top>=o.bottom?-1:1;this._transformation=new fn([a,s,0,0])},e.getResolutions=function(){return this._resolutions||[]},e.getResolution=function(t){var e=0|t;e<0?e=0:e>this._resolutions.length-1&&(e=this._resolutions.length-1);var i=this._resolutions[e];return e!==t&&t>0&&e<this._resolutions.length-1?i+(this._resolutions[e+1]-i)*(t-e):i},e.getProjection=function(){return this._projection},e.getFullExtent=function(){return this._fullExtent},e.getTransformation=function(){return this._transformation},e.getMinZoom=function(){for(var t=0;t<this._resolutions.length;t++)if(!F(this._resolutions[t]))return t;return 0},e.getMaxZoom=function(){for(var t=this._resolutions.length-1;t>=0;t--)if(!F(this._resolutions[t]))return t;return this._resolutions.length-1},e.getZoomDirection=function(){return st(this._resolutions[this.getMinZoom()]-this._resolutions[this.getMaxZoom()])},e.toJSON=function(){return this.json||(this.json={resolutions:this._resolutions,fullExtent:{top:this._fullExtent.top,left:this._fullExtent.left,bottom:this._fullExtent.bottom,right:this._fullExtent.right},projection:this._projection.code}),this.json},e.isPyramid=function(){return this._pyramid},t}(),Hr=new ae(0,0),Zr=new pn,Wr=function(t){function e(e){var i,n=B({},e),r=n.symbol,o=n.properties,a=n.id;return delete n.symbol,delete n.id,delete n.properties,i=t.call(this,n)||this,r?i.setSymbol(r):i._genSizeSymbol(),o&&i.setProperties(o),F(a)||i.setId(a),i}ne(e,t);var i=e.prototype;return i.getFirstCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[0].getFirstCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[0]}while(Array.isArray(e)&&e.length>0);return e},i.getLastCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[t.length-1].getLastCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[e.length-1]}while(Array.isArray(e)&&e.length>0);return e},i.addTo=function(t,e){return t.addGeometry(this,e),this},i.getLayer=function(){return this._layer?this._layer:null},i.getMap=function(){return this._layer?this._layer.getMap():null},i.getId=function(){return this._id},i.setId=function(t){var e=this.getId();return this._id=t,this._fireEvent("idchange",{old:e,new:t}),this},i.getProperties=function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},i.setProperties=function(t){var e=this.properties;return this.properties=G(t)?B({},t):t,this._repaint(),this._fireEvent("propertieschange",{old:e,new:t}),this},i.getType=function(){return this.type},i.getSymbol=function(){var t=this._symbol;return t?Array.isArray(t)?ii(t):B({},t):null},i.setSymbol=function(t){return this._symbol=this._prepareSymbol(t),this.onSymbolChanged(),this._symbolHash=ti(t),this},i.getSymbolHash=function(){return this._symbolHash},i.updateSymbol=function(t){if(!t)return this;var e=this._getSymbol();if(Array.isArray(e)){if(!Array.isArray(t))throw new Error("Parameter of updateSymbol is not an array.");for(var i=0;i<t.length;i++)Jn(t[i])&&delete this._textDesc,e[i]&&t[i]&&(e[i]=ii(e[i],t[i]))}else{if(Array.isArray(t))throw new Error("Geometry's symbol is not an array to update.");Jn(e)&&delete this._textDesc,e=ii(e||this._getInternalSymbol(),t)}return this._eventSymbolProperties=t,this.setSymbol(e)},i.getTextContent=function(){var t=this._getInternalSymbol();if(Array.isArray(t)){for(var e=[],i=!1,n=0;n<t.length;n++)e[n]=We(t[n]&&t[n].textName,this.getProperties()),F(e[n])||(i=!0);return i?e:null}return We(t&&t.textName,this.getProperties())},i.getTextDesc=function(){if(!this._textDesc){var t=this.getTextContent();if(!t)return null;var e=this._sizeSymbol;Array.isArray(e)?this._textDesc=e.map((function(e,i){return qe(t[i],e)})):this._textDesc=qe(t,e)}return this._textDesc},i.getCenter=function(){return this._computeCenter(this._getMeasurer())},i.getExtent=function(){var t=this._getPrjExtent(),e=this._getProjection();if(t&&e){var i=e.unproject(new $i(t.xmin,t.ymin)),n=e.unproject(new $i(t.xmax,t.ymax));return new un(i,n,e)}return this._computeExtent(this._getMeasurer())},i.getContainerExtent=function(t){var e=this.get2DExtent();if(!e||!e.isValid())return null;var i=this.getMap(),n=this.getCenter(),r=i.getGLZoom(),o=this.getMinAltitude(),a=i.distanceToPoint(o,0,r,n).x*st(o),s=e.convertTo((function(t){return i._pointToContainerPoint(t,r,a,Hr)}),t),l=this.getMaxAltitude();if(l!==o){l=i.distanceToPoint(l,0,r,n).x*st(l);var c=e.convertTo((function(t){return i._pointToContainerPoint(t,r,l,Hr)}),Zr);s._combine(c)}var h=this.getLayer();if(h&&"LineString"===this.type&&l&&h.options.drawAltitude){var u=e.convertTo((function(t){return i._pointToContainerPoint(t,r,0,Hr)}),Zr);s._combine(u)}return s&&s._add(this._getFixedExtent()),this.options.smoothness&&s._expand(.15*s.getWidth()),s},i._getFixedExtent=function(){this._fixedExtent||(this._fixedExtent=new pn);var t=this._sizeSymbol,e=(t&&t.lineWidth||1)/2;return this._fixedExtent.set(-e,-e,e,e),this._fixedExtent},i.get2DExtent=function(){var t=this.getMap();if(!t)return null;if(this._extent2d)return this._extent2d;var e=this._getPrjExtent();if(!e.isValid())return null;var i=e.getMin(),n=e.getMax(),r=t.getGLZoom();return t._prjToPoint(i,r,i),t._prjToPoint(n,r,n),this._extent2d=new pn(i,n),this._extent2d.z=t.getZoom(),this._extent2d},i.getSize=function(){var t=this.getContainerExtent();return t?t.getSize():null},i.containsPoint=function(t,e){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return t instanceof $i&&(t=this.getMap().coordToContainerPoint(t)),this._containsPoint(t,e)},i._containsPoint=function(t,e){var i=this._getPainter();return!!i&&(F(e)&&this._hitTestTolerance&&(e=this._hitTestTolerance()),i.hitTest(t,e))},i.show=function(){if(this.options.visible=!0,this.getMap()){var t=this._getPainter();t&&t.show(),this._fireEvent("show")}return this},i.hide=function(){if(this.options.visible=!1,this.getMap()){this.onHide();var t=this._getPainter();t&&t.hide(),this._fireEvent("hide")}return this},i.isVisible=function(){if(!this.options.visible)return!1;var t=this._getInternalSymbol();if(!t)return!0;if(Array.isArray(t)){if(!t.length)return!0;for(var e=0,i=t.length;e<i;e++)if(F(t[e].opacity)||t[e].opacity>0)return!0;return!1}return F(t.opacity)||G(t.opacity)||N(t.opacity)&&t.opacity>0},i.getZIndex=function(){return this.options.zIndex||0},i.setZIndex=function(t){var e=this.options.zIndex;return this.options.zIndex=t,this._fireEvent("zindexchange",{old:e,new:t}),this},i.setZIndexSilently=function(t){return this.options.zIndex=t,this},i.bringToFront=function(){var t=this.getLayer();if(!t||!t.getGeoMaxZIndex)return this;var e=t.getGeoMaxZIndex();return this.setZIndex(e+1),this},i.bringToBack=function(){var t=this.getLayer();if(!t||!t.getGeoMinZIndex)return this;var e=t.getGeoMinZIndex();return this.setZIndex(e-1),this},i.translate=function(t,e){if(F(t))return this;var i=new $i(t,e);if(0===i.x&&0===i.y)return this;var n=this.getCoordinates();if(n)if(Array.isArray(n)){var r=ot(n,(function(t){return t.add(i)}));this.setCoordinates(r)}else this.setCoordinates(n.add(i));return this},i.flash=function(t,e,i,n){return Tt.call(this,t,e,i,n)},i.copy=function(){var t=this.toJSON(),i=e.fromJSON(t);return i.options.visible=!0,i},i.remove=function(){return this.getLayer()?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},i.toGeoJSONGeometry=function(){return this._exportGeoJSONGeometry()},i.toGeoJSON=function(t){t||(t={});var e={type:"Feature",geometry:null};if(F(t.geometry)||t.geometry){var i=this._exportGeoJSONGeometry();e.geometry=i}var n,r=this.getId();return F(r)||(e.id=r),(F(t.properties)||t.properties)&&(n=this._exportProperties()),e.properties=n,e},i.toJSON=function(t){t||(t={});var e=this._toJSON(t);return B(e,this._exportGraphicOptions(t)),e},i.getLength=function(){return this._computeGeodesicLength(this._getMeasurer())},i.getArea=function(){return this._computeGeodesicArea(this._getMeasurer())},i.rotate=function(t,e){if("GeometryCollection"===this.type)return this.getGeometries().forEach((function(i){return i.rotate(t,e)})),this;e=e?new $i(e):this.getCenter();var i=this._getMeasurer(),n=this.getCoordinates();if(!Array.isArray(n)){if(e.x!==n.x||e.y!==n.y){var r=i._rotate(n,e,t);this.setCoordinates(r)}return this}return ot(n,(function(n){return i._rotate(n,e,t)})),this.setCoordinates(n),this},i._getConnectPoints=function(){return[this.getCenter()]},i._initOptions=function(t){var e=B({},t),i=e.symbol,n=e.properties,r=e.id;delete e.symbol,delete e.id,delete e.properties,this.setOptions(e),i&&this.setSymbol(i),n&&this.setProperties(n),F(r)||this.setId(r)},i._bindLayer=function(t){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=t,this._clearCache()},i._prepareSymbol=function(t){if(Array.isArray(t)){for(var e=[],i=0;i<t.length;i++)e.push(ee(this._checkAndCopySymbol(t[i])));return e}return t?ee(t=this._checkAndCopySymbol(t)):null},i._checkAndCopySymbol=function(t){var e={};for(var i in t)c[i]&&U(t[i])?e[i]=+t[i]:e[i]=t[i];return e},i._getSymbol=function(){return this._symbol},i._setExternSymbol=function(t){return this._eventSymbolProperties=t,this._symbol||delete this._textDesc,this._externSymbol=this._prepareSymbol(t),this.onSymbolChanged(),this},i._getInternalSymbol=function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},i._getPrjExtent=function(){var t=this._getProjection();return this._verifyProjection(),!this._extent&&t&&(this._extent=this._computePrjExtent(t)),this._extent},i._unbind=function(){var t=this.getLayer();t&&(this._animPlayer&&this._animPlayer.finish(),this._clearHandlers(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),t.onRemoveGeometry&&t.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},i._getInternalId=function(){return this._internalId},i._setInternalId=function(t){this._internalId=t},i._getMeasurer=function(){return this._getProjection()?this._getProjection():Vr.getProjectionInstance(this.options.defaultProjection)},i._getProjection=function(){var t=this.getMap();return t?t.getProjection():null},i._verifyProjection=function(){var t=this._getProjection();this._projCode&&t&&this._projCode!==t.code&&this._clearProjection(),this._projCode=t?t.code:this._projCode},i._getExternalResources=function(){return te(this._getInternalSymbol())},i._getPainter=function(){var t=this.getLayer();if(!this._painter&&t)if(-1!==o.indexOf(this.type)){if(t.constructor.getCollectionPainterClass){var e=t.constructor.getCollectionPainterClass();e&&(this._painter=new e(this))}}else if(t.constructor.getPainterClass){var i=t.constructor.getPainterClass();i&&(this._painter=new i(this))}return this._painter},i._getMaskPainter=function(){return this._maskPainter||(this._maskPainter=this.getGeometries&&this.getGeometries()?new Gr(this,!0):new Nr(this)),this._maskPainter},i._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter},i._paint=function(t){if(this._painter){if(this._dirtyCoords){delete this._dirtyCoords;var e=this._getProjection();e&&(this._pcenter=e.project(this._coordinates),this._clearCache())}this._painter.paint(t)}},i._clearCache=function(){delete this._extent,delete this._extent2d},i._clearProjection=function(){delete this._extent,delete this._extent2d},i._repaint=function(){this._painter&&this._painter.repaint()},i.onHide=function(){this.closeMenu(),this.closeInfoWindow()},i.onShapeChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("shapechange")},i.onPositionChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("positionchange")},i.onSymbolChanged=function(){this._painter&&this._painter.refreshSymbol();var t={};this._eventSymbolProperties?(t.properties=B({},this._eventSymbolProperties),delete this._eventSymbolProperties):delete this._textDesc,this._genSizeSymbol(),this._fireEvent("symbolchange",t)},i._genSizeSymbol=function(){var t=this._getInternalSymbol();if(t)if(Array.isArray(t)){this._sizeSymbol=[];for(var e=!1,i=0;i<t.length;i++){var n=this._sizeSymbol[i]=this._getSizeSymbol(t[i]);!e&&n&&n._dynamic&&(e=!0)}this._sizeSymbol._dynamic=e}else this._sizeSymbol=this._getSizeSymbol(t);else delete this._sizeSymbol},i._getSizeSymbol=function(t){var e;return Lt(t.lineWidth)?(e=Jt({lineWidth:t.lineWidth},this))._dynamic=!0:e={lineWidth:t.lineWidth},e},i.onConfig=function(t){var e;t.properties&&(e=t.properties,delete t.properties);var i=!1;for(var n in t)if(t.hasOwnProperty(n)){var r=n.slice(0,5);if("arrow"===r||"smoot"===r){i=!0;break}}e?(this.setProperties(e),this._repaint()):i&&this._repaint()},i._setParent=function(t){t&&(this._parent=t)},i._getParent=function(){return this._parent},i._fireEvent=function(t,e){this.getLayer()&&this.getLayer()._onGeometryEvent&&(e||(e={}),e.type=t,e.target=this,this.getLayer()._onGeometryEvent(e)),this.fire(t,e)},i._toJSON=function(t){return{feature:this.toGeoJSON(t)}},i._exportGraphicOptions=function(t){var e={};return(F(t.options)||t.options)&&(e.options=this.config()),(F(t.symbol)||t.symbol)&&(e.symbol=this.getSymbol()),(F(t.infoWindow)||t.infoWindow)&&this._infoWinOptions&&(e.infoWindow=this._infoWinOptions),e},i._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=$i.toNumberArrays(t);return{type:this.getType(),coordinates:e}},i._exportProperties=function(){var t=null,e=this.getProperties();return F(e)||(t=G(e)?B({},e):e),t},i.getAltitude=function(){var t=this.getLayer();if(!t)return 0;var e=t.options,i=this.getProperties(),n=e.enableAltitude&&i?i[e.altitudeProperty]:0,r=t.getAltitude?t.getAltitude():0;return Array.isArray(n)?n.map((function(t){return t+r})):n+r},i._genMinMaxAlt=function(){var t=this,e=this.getAltitude();Array.isArray(e)?(this._minAlt=Number.MAX_VALUE,this._maxAlt=Number.MIN_VALUE,e.forEach((function(e){var i=e;i<t._minAlt&&(t._minAlt=i),i>t._maxAlt&&(t._maxAlt=i)}))):this._minAlt=this._maxAlt=e},i.getMinAltitude=function(){return void 0===this._minAlt&&this._genMinMaxAlt(),this._minAlt?this._minAlt:0},i.getMaxAltitude=function(){return void 0===this._maxAlt&&this._genMinMaxAlt(),this._maxAlt?this._maxAlt:0},e}(Ci(wi(Wi(Si))));Wr.mergeOptions({id:null,visible:!0,interactive:!0,editable:!0,cursor:null,defaultProjection:"EPSG:4326"});var qr={attribution:null,minZoom:null,maxZoom:null,visible:!0,opacity:1,globalCompositeOperation:null,renderer:"canvas",debugOutline:"#0f0",cssFilter:null,forceRenderOnMoving:!1,forceRenderOnZooming:!1,forceRenderOnRotating:!1,collision:!1,collisionScope:"layer",hitDetect:!O.mobile},Xr=function(t){function e(e,i){var n,r;return i&&(r=i.canvas,delete i.canvas),(n=t.call(this,i)||this)._canvas=r,n.setId(e),i&&(n.setZIndex(i.zIndex),i.mask&&n.setMask(Wr.fromJSON(i.mask))),n}ne(e,t);var i=e.prototype;return i.load=function(){if(!this.getMap())return this;if(this.onLoad()){this._initRenderer();var t=this.getZIndex();F(t)||(this._renderer.setZIndex(t),this.isCanvasRender()||this._renderer.render()),this.onLoadEnd()}return this},i.getId=function(){return this._id},i.setId=function(t){var e=this._id;return F(t)||(t+=""),this._id=t,this.fire("idchange",{old:e,new:t}),this},i.addTo=function(t){return t.addLayer(this),this},i.setZIndex=function(t){return this._zIndex=t,F(t)?delete this.options.zIndex:this.options.zIndex=t,this.map&&this.map._sortLayersByZIndex(),this._renderer&&this._renderer.setZIndex(t),this},i.getZIndex=function(){return this._zIndex||0},i.getMinZoom=function(){var t=this.getMap(),e=this.options.minZoom;return t?Math.max(t.getMinZoom(),e||0):e},i.getMaxZoom=function(){var t=this.getMap(),e=this.options.maxZoom;return t?Math.min(t.getMaxZoom(),F(e)?1/0:e):e},i.getOpacity=function(){return this.options.opacity},i.setOpacity=function(t){return this.config("opacity",t),this},i.isCanvasRender=function(){var t=this._getRenderer();return t&&t instanceof kn},i.getMap=function(){return this.map?this.map:null},i.getProjection=function(){var t=this.getMap();return t?t.getProjection():null},i.bringToFront=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[t.length-1];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i+1),this},i.bringToBack=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[0];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i-1),this},i.show=function(){var t=this;if(!this.options.visible){this.options.visible=!0;var e=this.getRenderer();e&&e.show();var i=this.getMap();e&&i?i.once("renderend",(function(){t.fire("show")})):this.fire("show")}return this},i.hide=function(){var t=this;if(this.options.visible){this.options.visible=!1;var e=this.getRenderer();e&&e.hide();var i=this.getMap();e&&i?i.once("renderend",(function(){t.fire("hide")})):this.fire("hide")}return this},i.isVisible=function(){if(N(this.options.opacity)&&this.options.opacity<=0)return!1;var t=this.getMap();if(t){var e=t.getZoom();if(!F(this.options.maxZoom)&&this.options.maxZoom<e||!F(this.options.minZoom)&&this.options.minZoom>e)return!1}return F(this.options.visible)&&(this.options.visible=!0),this.options.visible},i.remove=function(){return this.map&&this.map.removeLayer(this),this},i.getMask=function(){return this._mask},i.setMask=function(t){if(!("Point"===t.type&&t._isVectorMarker()||"Polygon"===t.type||"MultiPolygon"===t.type))throw new Error("Mask for a layer must be a marker with vector marker symbol or a Polygon(MultiPolygon).");if(t._bindLayer(this),"Point"===t.type?t.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):t.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),this._mask=t,this.options.mask=t.toJSON(),!this.getMap()||this.getMap().isZooming())return this;var e=this._getRenderer();return e&&e.setToRedraw&&this._getRenderer().setToRedraw(),this},i.removeMask=function(){if(delete this._mask,delete this.options.mask,!this.getMap()||this.getMap().isZooming())return this;var t=this._getRenderer();return t&&t.setToRedraw&&this._getRenderer().setToRedraw(),this},i.onLoad=function(){return!0},i.onLoadEnd=function(){},i.isLoaded=function(){return!!this._loaded},i.getCollisionIndex=function(){if("layer"===this.options.collisionScope)return this._collisionIndex||(this._collisionIndex=new Zi),this._collisionIndex;var t=this.getMap();return t?t.getCollisionIndex():null},i.clearCollisionIndex=function(){return"layer"===this.options.collisionScope&&this._collisionIndex&&this._collisionIndex.clear(),this},i.getRenderer=function(){return this._getRenderer()},i.onConfig=function(t){if(N(t.opacity)||t.cssFilter){var e=this.getRenderer();e&&e.setToRedraw()}},i.onAdd=function(){},i.onRendererCreate=function(){},i.onCanvasCreate=function(){},i.onRemove=function(){},i._bindMap=function(t,e){t&&(this.map=t,F(e)||this.setZIndex(e),this._switchEvents("on",this),this.onAdd(),this.fire("add"))},i._initRenderer=function(){var t=this.options.renderer;if(this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);if(!e)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+t);this._renderer=new e(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer),this._renderer.onAdd&&this._renderer.onAdd(),this.onRendererCreate(),this.fire("renderercreate",{renderer:this._renderer})}},i._doRemove=function(){this._loaded=!1,this.onRemove(),this._switchEvents("off",this),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this.map,delete this._collisionIndex},i._switchEvents=function(t,e){e&&e.getEvents&&this.getMap()[t](e.getEvents(),e)},i._getRenderer=function(){return this._renderer},i._getLayerList=function(){return this.map?this.map._layers:[]},i._getMask2DExtent=function(){if(!this._mask||!this.getMap())return null;var t=this._mask._getMaskPainter();return t?t.get2DExtent():null},e}(Ci(wi(Dn(Si))));Xr.mergeOptions(qr);var Yr=Xr.prototype.fire;Xr.prototype.fire=function(t,e){return"layerload"===t&&(this._loaded=!0),this.map&&(e||(e={}),e.type=t,e.target=this,this.map._onLayerEvent(e)),Yr.apply(this,arguments)};var $r,Jr,Kr,Qr,to,eo,io=new $i(0,0),no={maxVisualPitch:70,maxPitch:80,centerCross:!1,zoomInCenter:!1,zoomOrigin:null,zoomAnimation:!u,zoomAnimationDuration:330,panAnimation:!u,panAnimationDuration:600,zoomable:!0,enableInfoWindow:!0,hitDetect:!O.mobile,hitDetectLimit:5,fpsOnInteracting:25,layerCanvasLimitOnInteracting:-1,maxZoom:null,minZoom:null,maxExtent:null,fixCenterOnResize:!0,checkSize:!0,checkSizeInterval:1e3,renderer:"canvas",cascadePitches:[10,60],renderable:!0},ro=function(t){function e(i,n){var r;if(!n)throw new Error("Invalid options when creating map.");if(!n.center)throw new Error("Invalid center when creating map.");var o=B({},n),a=o.zoom;delete o.zoom;var s=new $i(o.center);delete o.center;var l=o.baseLayer;delete o.baseLayer;var c=o.layers;return delete o.layers,(r=t.call(this,o)||this).VERSION=e.VERSION,Object.defineProperty(re(re(r)),"id",{value:tt(),writable:!1}),r._loaded=!1,r._initContainer(i),r._panels={},r._baseLayer=null,r._layers=[],r._zoomLevel=a,r._center=s,r.setSpatialReference(o.spatialReference||o.view),r.setMaxExtent(o.maxExtent),r._mapViewPoint=new ae(0,0),r._initRenderer(),r._updateMapSize(r._getContainerDomSize()),l&&r.setBaseLayer(l),c&&r.addLayer(c),r._Load(),r}ne(e,t),e.addOnLoadHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(i),this};var i=e.prototype;return i.isLoaded=function(){return!!this._loaded},i.getContainer=function(){return this._containerDOM},i.getSpatialReference=function(){return this._spatialReference},i.setSpatialReference=function(t){var e=this.options.spatialReference;return this._loaded&&Vr.equals(e,t)||this._updateSpatialReference(t,e),this},i._updateSpatialReference=function(t,e){if(t=B({},t),this._center=this.getCenter(),this.options.spatialReference=t,this._spatialReference=new Vr(t),this.options.spatialReference&&V(this.options.spatialReference.projection)){var i=this._spatialReference.getProjection();this.options.spatialReference.projection=i.code}return this._resetMapStatus(),this._fireEvent("spatialreferencechange",{old:e,new:B({},this.options.spatialReference)}),this},i.onConfig=function(t){var e=t.spatialReference||t.view;return F(e)||this._updateSpatialReference(e,null),this},i.getProjection=function(){return this._spatialReference?this._spatialReference.getProjection():null},i.getFullExtent=function(){return this._spatialReference?this._spatialReference.getFullExtent():null},i.setCursor=function(t){return delete this._cursor,this._trySetCursor(t),this._cursor=t,this},i.resetCursor=function(){return this.setCursor(null)},i.getCenter=function(){return this._loaded&&this._prjCenter?this.getProjection().unproject(this._prjCenter):this._center},i.setCenter=function(t){if(!t)return this;t=new $i(t);var e=this.getProjection().project(t);return this._verifyExtent(e)?this._loaded?(this.onMoveStart(),this._setPrjCenter(e),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this):(this._center=t,this):this},i.getSize=function(){return F(this.width)||F(this.height)?this._getContainerDomSize():new se(this.width,this.height)},i.getContainerExtent=function(){var t=this.height,e=this.getPitch(),i=this.options.maxVisualPitch;return i&&e>i&&(t=this._getVisualHeight(i)),new pn(0,this.height-t,this.width,this.height)},i._getVisualHeight=function(t){t=t||.01;var e=(90-this.getPitch())*Math.PI/180,i=this.getFov()*Math.PI/180;t*=Math.PI/180;var n=this.cameraCenterDistance/this.getGLScale(),r=Math.tan(i/2),o=n*r/(1/Math.tan(t)-r)/Math.sin(t),a=n*(Math.sin(e)*o/(n+Math.cos(e)*o));return this.height/2+a},i.getExtent=function(){return this._pointToExtent(this._get2DExtent())},i.getProjExtent=function(){var t=this._get2DExtent();return new un(this._pointToPrj(t.getMin()),this._pointToPrj(t.getMax()))},i.getPrjExtent=function(){return this.getProjExtent()},i.getMaxExtent=function(){return this.options.maxExtent?new un(this.options.maxExtent,this.getProjection()):null},i.setMaxExtent=function(t){if(t){var e=new un(t,this.getProjection());this.options.maxExtent=e,this._verifyExtent(this._getPrjCenter())||this._panTo(this._prjMaxExtent().getCenter());var i=this.getProjection();this._prjMaxExtent=e.convertTo((function(t){return i.project(t)}))}else delete this.options.maxExtent,delete this._prjMaxExtent;return this},i.getZoom=function(){return this._zoomLevel},i.getZoomForScale=function(t,e,i){var n=this.getZoom();if(F(e)&&(e=n),1===t&&e===n)return n;var r=this._getResolution(e)/t,o=this.getZoomFromRes(r);if(i)return o;return this.getSpatialReference().getZoomDirection()<0?Math.ceil(o-1e-6):Math.floor(o+1e-6)},i.getZoomFromRes=function(t){var e=this._getResolutions(),i=this._getResolution(this.getMinZoom()),n=this._getResolution(this.getMaxZoom());if(i<=n){if(t<=i)return this.getMinZoom();if(t>=n)return this.getMaxZoom()}else{if(t>=i)return this.getMinZoom();if(t<=n)return this.getMaxZoom()}for(var r=e.length,o=0;o<r-1;o++)if(e[o]){var a=e[o+1]-e[o],s=t-e[o];if(st(a)===st(s)&&Math.abs(a)>=Math.abs(s))return o+s/a}return r-1},i.setZoom=function(t,e){return void 0===e&&(e={animation:!0}),isNaN(t)||F(t)||(t=+t,this._loaded&&this.options.zoomAnimation&&e.animation?this._zoomAnimation(t):this._zoom(t)),this},i.getMaxZoom=function(){return F(this.options.maxZoom)?this.getMaxNativeZoom():this.options.maxZoom},i.setMaxZoom=function(t){var e=this.getMaxNativeZoom();return t>e&&(t=e),null!==t&&t<this._zoomLevel&&(this.setZoom(t),t=+t),this.options.maxZoom=t,this},i.getMinZoom=function(){return F(this.options.minZoom)?this._spatialReference.getMinZoom():this.options.minZoom},i.setMinZoom=function(t){if(null!==t){t=+t;var e=this._spatialReference.getMinZoom();t<e&&(t=e),t>this._zoomLevel&&this.setZoom(t)}return this.options.minZoom=t,this},i.getMaxNativeZoom=function(){var t=this.getSpatialReference();return t?t.getMaxZoom():null},i.getGLZoom=function(){return this.getMaxNativeZoom()/2},i.getGLScale=function(t){return F(t)&&(t=this.getZoom()),this._getResolution(t)/this._getResolution(this.getGLZoom())},i.zoomIn=function(){return this.setZoom(this.getZoom()+1)},i.zoomOut=function(){return this.setZoom(this.getZoom()-1)},i.isZooming=function(){return!!this._zooming},i.isInteracting=function(){return this.isZooming()||this.isMoving()||this.isRotating()},i.setCenterAndZoom=function(t,e){return F(e)||this._zoomLevel===e?this.setCenter(t):(this.setCenter(t),this.setZoom(e,{animation:!1})),this},i.getFitZoom=function(t,e){var i=this;if(!(t&&t instanceof un))return this._zoomLevel;if(t.xmin===t.xmax&&t.ymin===t.ymax)return this.getMaxZoom();var n=this.getSize(),r=t.convertTo((function(t){return i.coordToPoint(t)})),o=r.getWidth(),a=r.getHeight(),s=n.width/o,l=n.height/a,c=this.getSpatialReference().getZoomDirection()<0?Math.max(s,l):Math.min(s,l);return this.getZoomForScale(c,null,e)},i.getView=function(){return{center:this.getCenter().toArray(),zoom:this.getZoom(),pitch:this.getPitch(),bearing:this.getBearing()}},i.setView=function(t){return t?(t.center&&this.setCenter(t.center),null===t.zoom||isNaN(+t.zoom)||this.setZoom(+t.zoom,{animation:!1}),null===t.pitch||isNaN(+t.pitch)||this.setPitch(+t.pitch),null===t.pitch||isNaN(+t.bearing)||this.setBearing(+t.bearing),this):this},i.getResolution=function(t){return this._getResolution(t)},i.getScale=function(t){var e=F(t)?this.getZoom():t,i=this._getResolution(this.getMaxNativeZoom());return this._getResolution(e)/i},i.fitExtent=function(t,e,i,n){if(void 0===i&&(i={}),!t)return this;t=new un(t,this.getProjection());var r=this.getFitZoom(t)+(e||0),o=t.getCenter();return void 0===i.animation||i.animation?this._animateTo({center:o,zoom:r},{duration:i.duration||this.options.zoomAnimationDuration,easing:i.easing||"out"},n):this.setCenterAndZoom(o,r)},i.getBaseLayer=function(){return this._baseLayer},i.setBaseLayer=function(t){var e=!1;if(this._baseLayer&&(e=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),!t)return delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this;return this._baseLayer=t,t._bindMap(this,-1),this._baseLayer.on("layerload",(function(){this._fireEvent("baselayerload"),e&&(e=!1,this._fireEvent("baselayerchangeend"))}),this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this},i.removeBaseLayer=function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},i.getLayers=function(t){return this._getLayers((function(e){return!(e===this._baseLayer||e.getId().indexOf("_maptalks__internal_layer_")>=0)&&(!t||t(e))}))},i.getLayer=function(t){if(!t)return null;var e=this._layerCache?this._layerCache[t]:null;if(e)return e;var i=this.getBaseLayer();return i&&i.getId()===t?i:null},i.addLayer=function(t){if(!t)return this;if(!Array.isArray(t))return t=Array.prototype.slice.call(arguments,0),this.addLayer(t);this._layerCache||(this._layerCache={});for(var e=this._layers,i=0,n=t.length;i<n;i++){var r=t[i],o=r.getId();if(F(o))throw new Error("Invalid id for the layer: "+o);if(r.getMap()!==this){if(this._layerCache[o])throw new Error("Duplicate layer id in the map: "+o);this._layerCache[o]=r,r._bindMap(this),e.push(r),this._loaded&&r.load()}}return this._sortLayersByZIndex(),this._fireEvent("addlayer",{layers:t}),this},i.removeLayer=function(t){if(!t)return this;if(!Array.isArray(t))return this.removeLayer([t]);for(var e=[],i=0,n=t.length;i<n;i++){var r=t[i];if(r instanceof Xr||(r=this.getLayer(r)),r){var o=r.getMap();if(o&&o===this){e.push(r),this._removeLayer(r,this._layers),this._loaded&&r._doRemove();var a=r.getId();this._layerCache&&delete this._layerCache[a]}}}if(e.length>0){var s=this.getRenderer();s&&s.setLayerCanvasUpdated(),this.once("frameend",(function(){e.forEach((function(t){t.fire("remove")}))}))}return this._fireEvent("removelayer",{layers:t}),this},i.sortLayers=function(t){if(!t||!Array.isArray(t))return this;for(var e=[],i=Number.MAX_VALUE,n=0,r=t.length;n<r;n++){var o=t[n];if(U(t[n])&&(o=this.getLayer(o)),!(o instanceof Xr&&o.getMap()&&o.getMap()===this))throw new Error("It must be a layer added to this map to order.");o.getZIndex()<i&&(i=o.getZIndex()),e.push(o)}for(var a=0,s=e.length;a<s;a++)e[a].setZIndex(i+a);return this},i.toDataURL=function(t){t||(t={});var e=t.mimeType;e||(e="image/png");var i=t.save,n=this._getRenderer();if(n&&n.toDataURL){var r=t.fileName;r||(r="export");var o=n.toDataURL(e,t.quality||.92);if(i&&o){var a;if("undefined"!=typeof Blob&&"undefined"!=typeof atob){var s=vt(o.replace(/^data:image\/(png|jpeg|jpg|webp);base64,/,""),e);a=URL.createObjectURL(s)}else a=o;var l=document.createElement("a");l.download=r,l.href=a,document.body.appendChild(l),l.click(),document.body.removeChild(l)}return o}return null},i.coordToPoint=function(t,e,i){return this.coordinateToPoint(t,e,i)},i.pointToCoord=function(t,e,i){return this.pointToCoordinate(t,e,i)},i.coordToViewPoint=function(t,e,i){return this.coordinateToViewPoint(t,e,i)},i.viewPointToCoord=function(t,e){return this.viewPointToCoordinate(t,e)},i.coordToContainerPoint=function(t,e,i){return this.coordinateToContainerPoint(t,e,i)},i.containerPointToCoord=function(t,e){return this.containerPointToCoordinate(t,e)},i.containerPointToViewPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._sub(this.getViewPoint())},i.viewPointToContainerPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._add(this.getViewPoint())},i.checkSize=function(){var t=z()-this._initTime<1500&&0===this.width||0===this.height,e=this._getContainerDomSize(),i=this.height,n=this.width;if(e.width===n&&e.height===i)return this;var r=this.getCenter();if(this.options.fixCenterOnResize)this._updateMapSize(e);else{var o=this._getVisualHeight(this.getPitch()),a=new ae(0,this.height-o),s=this._containerPointToPrj(a);this._updateMapSize(e);var l=this._getVisualHeight(this.getPitch()),c=new ae(0,this.height-l);this._setPrjCoordAtContainerPoint(s,c),this._mapViewCoord=this._getPrjCenter()}var h=0===e.width||0===e.height||0===n||0===i;return(t||h)&&(this._eventSilence=!0,this.setCenter(r),delete this._eventSilence),this._fireEvent("resize"),this},i.locate=function(t,e,i){return this.getProjection()._locate(new $i(t),e,i)},i.getMainPanel=function(){return this._getRenderer().getMainPanel()},i.getPanels=function(){return this._panels},i.remove=function(){var t=this;if(this.isRemoved())return this;this._fireEvent("removestart"),this._removeDomEvents(),this._clearHandlers(),this.removeBaseLayer();for(var e=this.getLayers(),i=0;i<e.length;i++)e[i].remove();return this._getRenderer()&&this._getRenderer().remove(),this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&Array.prototype.slice.call(this._containerDOM.childNodes,0).filter((function(t){return"maptalks-wrapper"===t.className})).forEach((function(e){return t._containerDOM.removeChild(e)})),delete this._panels,delete this._containerDOM,delete this.renderer,this._fireEvent("removeend"),this._clearAllListeners(),this},i.isRemoved=function(){return!this._containerDOM},i.isMoving=function(){return!!this._moving},i.onMoveStart=function(t){var e=this._getPrjCenter();this._originCenter&&!this._verifyExtent(e)||(this._originCenter=e),this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(t?t.domEvent:null,"movestart"))},i.onMoving=function(t){this._fireEvent("moving",this._parseEvent(t?t.domEvent:null,"moving"))},i.onMoveEnd=function(t){if(this._moving=!1,this._trySetCursor("default"),this._fireEvent("moveend",t&&t.domEvent?this._parseEvent(t.domEvent,"moveend"):t),!this._verifyExtent(this._getPrjCenter())&&this._originCenter){var e=this._originCenter;this._panTo(e)}},i.onDragRotateStart=function(t){this._dragRotating=!0,this._fireEvent("dragrotatestart",this._parseEvent(t?t.domEvent:null,"dragrotatestart"))},i.onDragRotating=function(t){this._fireEvent("dragrotating",this._parseEvent(t?t.domEvent:null,"dragrotating"))},i.onDragRotateEnd=function(t){this._dragRotating=!1,this._fireEvent("dragrotateend",this._parseEvent(t?t.domEvent:null,"dragrotateend"))},i.isDragRotating=function(){return!!this._dragRotating},i.isOffscreen=function(t,e){void 0===e&&(e=0);var i=this.width+e,n=this.height+e,r=t.xmin,o=t.ymin,a=t.xmax,s=t.ymax;return Array.isArray(t)&&(r=t[0],o=t[1],a=t[2],s=t[3]),a<e||r>=i||s<e||o>n},i.getRenderer=function(){return this._getRenderer()},i.getDevicePixelRatio=function(){return this.options.devicePixelRatio||O.devicePixelRatio||1},i._initContainer=function(t){if(U(t)){if(this._containerDOM=document.getElementById(t),!this._containerDOM)throw new Error("Invalid container when creating map: '"+t+"'")}else this._containerDOM=t,u&&(this.CanvasClass=this._containerDOM.constructor);if(this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&"maptalks-wrapper"===this._containerDOM.childNodes[0].className)throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.")},i._trySetCursor=function(t){return this._cursor||this._priorityCursor||(t||(t="default"),this._setCursorToPanel(t)),this},i._setPriorityCursor=function(t){if(t)this._priorityCursor=t,this._setCursorToPanel(t);else{var e=!1;this._priorityCursor&&(e=!0),delete this._priorityCursor,e&&this.setCursor(this._cursor)}return this},i._setCursorToPanel=function(t){var e=this.getMainPanel();e&&e.style&&e.style.cursor!==t&&(e.style.cursor=t)},i._removeLayer=function(t,e){if(t&&e){var i=e.indexOf(t);i>-1&&e.splice(i,1)}},i._sortLayersByZIndex=function(){if(this._layers){for(var t=0,e=this._layers.length;t<e;t++)this._layers[t]._order=t,this._layers[t].sortLayersByZIndex&&this._layers[t].sortLayersByZIndex();this._layers.sort((function(t,e){var i=t.getZIndex()-e.getZIndex();return 0===i?t._order-e._order:i}))}},i._fireEvent=function(t,e){this._eventSilence||(this.fire("_"+t,e),this.fire(t,e))},i._Load=function(){this._resetMapStatus(),this.options.pitch&&(this.setPitch(this.options.pitch),delete this.options.pitch),this.options.bearing&&(this.setBearing(this.options.bearing),delete this.options.bearing),this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=z()},i._initRenderer=function(){var t=this.options.renderer,i=e.getRendererClass(t);this._renderer=new i(this),this._renderer.load()},i._getRenderer=function(){return this._renderer},i._loadAllLayers=function(){this._baseLayer&&this._baseLayer.load(),this._eachLayer((function(t){t&&t.load()}),this.getLayers())},i._getLayers=function(t){for(var e=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,i=[],n=0;n<e.length;n++)t&&!t.call(this,e[n])||i.push(e[n]);return i},i._eachLayer=function(t){if(!(arguments.length<2)){var e=Array.prototype.slice.call(arguments,1);e&&!Array.isArray(e)&&(e=[e]);for(var i=[],n=0,r=e.length;n<r;n++)i=i.concat(e[n]);for(var o=0,a=i.length;o<a;o++)t.call(t,i[o])}},i._onLayerEvent=function(t){t&&"idchange"===t.type&&(delete this._layerCache[t.old],this._layerCache[t.new]=t.target)},i._resetMapStatus=function(){var t=this.getMaxZoom(),e=this.getMinZoom(),i=this._spatialReference.getMaxZoom(),n=this._spatialReference.getMinZoom();(F(t)||-1===t||t>i)&&this.setMaxZoom(i),(F(e)||-1===e||e<n)&&this.setMinZoom(n),(t=this.getMaxZoom())<(e=this.getMinZoom())&&this.setMaxZoom(e),(F(this._zoomLevel)||this._zoomLevel>t)&&(this._zoomLevel=t),this._zoomLevel<e&&(this._zoomLevel=e),delete this._prjCenter;var r=this.getProjection();this._prjCenter=r.project(this._center),this._calcMatrices();var o=this._getRenderer();o&&o.resetContainer()},i._getContainerDomSize=function(){if(!this._containerDOM)return null;var t,e,i=this._containerDOM;if(F(i.width)||F(i.height)){if(F(i.clientWidth)||F(i.clientHeight))throw new Error("can not get size of container");t=parseInt(i.clientWidth,0),e=parseInt(i.clientHeight,0)}else{t=i.width,e=i.height;var n=this.getDevicePixelRatio();1!==n&&i.layer&&(t/=n,e/=n)}return new se(t,e)},i._updateMapSize=function(t){return this.width=t.width,this.height=t.height,this._getRenderer().updateMapSize(t),this._calcMatrices(),this},i._getPrjCenter=function(){return this._prjCenter},i._setPrjCenter=function(t){this._prjCenter=t,this.isInteracting()&&!this.isMoving()&&(this._mapViewCoord=t),this._calcMatrices()},i._setPrjCoordAtContainerPoint=function(t,e){if(e.x===this.width/2&&e.y===this.height/2)return this;var i=this._containerPointToPoint(e)._sub(this._prjToPoint(this._getPrjCenter())),n=this._pointToPrj(this._prjToPoint(t).sub(i));return this._setPrjCenter(n),this},i._verifyExtent=function(t){if(!t)return!1;var e=this._prjMaxExtent;return!e||e.contains(t)},i._offsetCenterByPixel=function(t){var e=new ae(this.width/2-t.x,this.height/2-t.y),i=this._containerPointToPrj(e);return this._setPrjCenter(i),i},i.offsetPlatform=function(t){return t?(this._getRenderer().offsetPlatform(t),this._mapViewCoord=this._getPrjCenter(),this._mapViewPoint=this._mapViewPoint.add(t),this):this._mapViewPoint},i.getViewPoint=function(){var t=this._getViewPointFrameOffset(),e=this.offsetPlatform();return t&&(e=e.add(t)),e},i._resetMapViewPoint=function(){this._mapViewPoint=new ae(0,0),this._mapViewCoord=this._getPrjCenter()},i._getResolution=function(t){return void 0!==t&&t!==this._zoomLevel||void 0===this._mapRes?t===this.getGLZoom()&&void 0!==this._mapGlRes?this._mapGlRes:(F(t)&&(t=this._zoomLevel),this._spatialReference.getResolution(t)):this._mapRes},i._getResolutions=function(){return this._spatialReference.getResolutions()},i._prjToPoint=function(t,e,i){return e=F(e)?this.getZoom():e,this._spatialReference.getTransformation().transform(t,this._getResolution(e),i)},i._prjsToPoints=function(t,e){e=F(e)?this.getZoom():e;for(var i=this._getResolution(e),n=this._spatialReference.getTransformation(),r=[],o=0,a=t.length;o<a;o++){var s=n.transform(t[o],i);r.push(s)}return r},i._pointToPrj=function(t,e,i){return e=F(e)?this.getZoom():e,this._spatialReference.getTransformation().untransform(t,this._getResolution(e),i)},i._pointToPoint=function(t,e,i){return i?(i.x=t.x,i.y=t.y):i=t.copy(),F(e)?i:i._multi(this._getResolution(e)/this._getResolution())},i._pointToPointAtZoom=function(t,e,i){return i?(i.x=t.x,i.y=t.y):i=t.copy(),F(e)?i:i._multi(this._getResolution()/this._getResolution(e))},i._containerPointToPrj=function(t,e){return this._pointToPrj(this._containerPointToPoint(t,void 0,e),void 0,e)},i._callOnLoadHooks=function(){var t=e.prototype;if(t._onLoadHooks)for(var i=0,n=t._onLoadHooks.length;i<n;i++)t._onLoadHooks[i].call(this)},e}(Wi(wi(Dn(Si))));ro.include({coordinateToPoint:(eo=new $i(0,0),function(t,e,i){var n=this.getProjection().project(t,eo);return this._prjToPoint(n,e,i)}),pointToCoordinate:function(){var t=new $i(0,0);return function(e,i,n){var r=this._pointToPrj(e,i,t);return this.getProjection().unproject(r,n)}}(),coordinateToViewPoint:function(){var t=new $i(0,0);return function(e,i,n){return this._prjToViewPoint(this.getProjection().project(e,t),i,n)}}(),viewPointToCoordinate:function(){var t=new $i(0,0);return function(e,i){return this.getProjection().unproject(this._viewPointToPrj(e,t),i)}}(),coordinateToContainerPoint:function(){var t=new $i(0,0);return function(e,i,n){var r=this.getProjection().project(e,t);return this._prjToContainerPoint(r,i,n)}}(),coordinatesToContainerPoints:function(t,e){e=F(e)?this.getZoom():e;for(var i=[],n=this._spatialReference.getTransformation(),r=this._getResolution(e),o=r/this._getResolution(),a=this.getProjection(),s=new $i(0,0),l=this.isTransforming(),c=this._prjToPoint(this._getPrjCenter(),void 0,io),h=0,u=t.length;h<u;h++){var d=a.project(t[h],s),p=n.transform(d,r);p=p._multi(o),this._toContainerPoint(p,l,o,0,c),i.push(p)}return i},containerPointToCoordinate:function(){var t=new $i(0,0);return function(e,i){var n=this._containerPointToPrj(e,t);return this.getProjection().unproject(n,i)}}(),containerToExtent:(Qr=new ae(0,0),to=new ae(0,0),function(t){var e=new pn(this._containerPointToPoint(t.getMin(Qr),void 0,Qr),this._containerPointToPoint(t.getMax(to),void 0,to));return this._pointToExtent(e)}),distanceToPixel:function(){var t=new ae(0,0),e=new ae(0,0);return function(i,n,r){var o=this.getProjection();if(!o)return null;var a=this.getScale()/this.getScale(r),s=this.getCenter(),l=o.locate(s,i,n),c=this.coordToContainerPoint(s,void 0,t),h=this.coordToContainerPoint(l,void 0,e);return h._sub(c)._multi(a)._abs(),new se(h.x,h.y)}}(),distanceToPoint:(Kr=new ae(0,0),function(t,e,i,n){var r=this.getProjection();if(!r)return null;var o=n||this.getCenter(),a=r.locate(o,t,e),s=this.coordToPoint(o,i,Kr),l=this.coordToPoint(a,i);return l._sub(s)._abs(),l}),pixelToDistance:($r=new $i(0,0),Jr=new $i(0,0),function(t,e){var i=this.getProjection();if(!i)return null;var n=this.getFullExtent(),r=n.top>n.bottom?-1:1,o=$r.set(this.width/2+t,this.height/2+r*e),a=this.containerPointToCoord(o,Jr);return i.measureLength(this.getCenter(),a)}),pointToDistance:function(){var t=new ae(0,0),e=new $i(0,0);return function(i,n,r){var o=this.getProjection();if(!o)return null;var a=this._prjToPoint(this._getPrjCenter(),r,t);a._add(i,n);var s=this.pointToCoord(a,r,e);return o.measureLength(this.getCenter(),s)}}(),locateByPoint:function(){var t=new ae(0,0);return function(e,i,n){var r=this.coordToContainerPoint(e,void 0,t);return this.containerPointToCoord(r._add(i,n))}}(),_get2DExtent:function(){var t=new ae(0,0);return function(e,i){var n,r=this;return void 0!==e&&e!==this._zoomLevel||!this._mapExtent2D?e===this.getGLZoom()&&this._mapGlExtent2D&&(n=this._mapGlExtent2D):n=this._mapExtent2D,n?i?(i.set(n.xmin,n.ymin,n.xmax,n.ymax),i):n.copy():this.getContainerExtent().convertTo((function(i){return r._containerPointToPoint(i,e,t)}),i)}}(),_pointToExtent:function(){var t=new $i(0,0),e=new $i(0,0);return function(i){var n=i.getMin(),r=i.getMax(),o=this.getFullExtent(),a=!o||o.left<=o.right?[n.x,r.x]:[r.x,n.x],s=a[0],l=a[1],c=!o||o.top>o.bottom?[r.y,n.y]:[n.y,r.y],h=c[0],u=c[1],d=n.set(s,u),p=r.set(l,h);return new un(this.pointToCoord(d,void 0,t),this.pointToCoord(p,void 0,e),this.getProjection())}}(),_getViewPointFrameOffset:function(){var t=new ae(0,0);return function(){if(this.isZooming())return null;var e=this._getPrjCenter();return this._mapViewCoord&&!this._mapViewCoord.equals(e)?this._prjToContainerPoint(this._mapViewCoord)._sub(this._prjToContainerPoint(e,void 0,t)):null}}(),_viewPointToPrj:function(){var t=new ae(0,0);return function(e,i){return this._containerPointToPrj(this.viewPointToContainerPoint(e,t),i)}}(),_prjToContainerPoint:function(){var t=new ae(0,0);return function(e,i,n,r){return this._pointToContainerPoint(this._prjToPoint(e,i,t),i,r||0,n)}}(),_prjToViewPoint:function(){var t=new ae(0,0);return function(e,i,n){var r=this._prjToContainerPoint(e,void 0,t,n);return this.containerPointToViewPoint(r,i)}}(),_viewPointToPoint:function(){var t=new ae(0,0);return function(e,i,n){return this._containerPointToPoint(this.viewPointToContainerPoint(e,t),i,n)}}(),_pointToViewPoint:function(){var t=new $i(0,0);return function(e,i,n){return this._prjToViewPoint(this._pointToPrj(e,i,t),n)}}()}),ro.mergeOptions(no);var oo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target&&this.target.on("_dblclick",this._onDoubleClick,this)},i.removeHooks=function(){this.target&&this.target.off("_dblclick",this._onDoubleClick,this)},i._onDoubleClick=function(t){var e=this.target;if(e.options.doubleClickZoom){var i=e.getZoom(),n=t.domEvent.shiftKey?Math.ceil(i)-1:Math.floor(i)+1;e._zoomAnimation(n,t.containerPoint)}},e}(Ti);ro.mergeOptions({doubleClickZoom:!0}),ro.addOnLoadHook("addHandler","doubleClickZoom",oo);var ao=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){var t=this.target;if(t){var e=t._panels.mapWrapper||t._containerDOM;this._dragHandler=new Yi(e,{cancelOn:this._cancelOn.bind(this),rightclick:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable()}},i.removeHooks=function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this),this._dragHandler.remove(),delete this._dragHandler},i._cancelOn=function(t){return!(!this.target.isZooming()&&!this._ignore(t))},i._ignore=function(t){return!!t&&(t.domEvent&&(t=t.domEvent),this.target._ignoreEvent(t))},i._onMouseDown=function(t){delete this.startDragTime,delete this._mode,2===t.domEvent.button||t.domEvent.ctrlKey?(this.target.options.dragRotate||this.target.options.dragPitch)&&(this._mode="rotatePitch"):this.target.options.dragPan&&(this._mode="move"),this.target._stopAnim(this.target._mapAnimPlayer),ve(t.domEvent)},i._onDragStart=function(t){this.startDragTime=z(),"move"===this._mode?this._moveStart(t):"rotatePitch"===this._mode&&this._rotateStart(t)},i._onDragging=function(t){this.target._isEventOutMap(t.domEvent)||("move"===this._mode?this._moving(t):"rotatePitch"===this._mode&&this._rotating(t))},i._onDragEnd=function(t){"move"===this._mode?this._moveEnd(t):"rotatePitch"===this._mode&&this._rotateEnd(t),delete this.startDragTime,delete this.startBearing},i._start=function(t){this.preX=t.mousePos.x,this.preY=t.mousePos.y,this.startX=this.preX,this.startY=this.preY},i._moveStart=function(t){this._start(t);var e=this.target;e.onMoveStart(t);var i=Te(e._getActualEvent(t.domEvent),e.getContainer());this.startPrjCoord=e._containerPointToPrj(i)},i._moving=function(t){if(this.startDragTime){var e=this.target,i=Te(e._getActualEvent(t.domEvent),e.getContainer());e._setPrjCoordAtContainerPoint(this.startPrjCoord,i),e.onMoving(t)}},i._moveEnd=function(t){if(this.startDragTime){var e=this.target,i=z()-this.startDragTime,n=t.mousePos.x,r=t.mousePos.y,o=n-this.startX,a=r-this.startY;this._clear(),e.options.panAnimation&&!t.interupted&&e._verifyExtent(e._getPrjCenter())&&i<280&&Math.abs(a)+Math.abs(o)>5?(i=5*i*(Math.abs(o)+Math.abs(a))/500,e.panBy(new ae(o,a),{duration:i})):e.onMoveEnd(t)}},i._rotateStart=function(t){this._start(t),delete this._rotateMode,this.startBearing=this.target.getBearing(),this.target.onDragRotateStart(t),this._db=0},i._rotating=function(t){var e=this.target,i=t.mousePos.x,n=t.mousePos.y,r=e.getPitch(),o=e.getBearing(),a=Math.abs(i-this.preX),s=Math.abs(n-this.preY);if(this._rotateMode||(e.options.dragRotatePitch?this._rotateMode="rotate_pitch":this._rotateMode=a>s?"rotate":a<s?"pitch":"rotate"),!("pitch"===this._rotateMode&&0===r&&s<10)){if(this._rotateMode.indexOf("rotate")>=0&&e.options.dragRotate){var l=0;l=e.options.dragPitch||a>s?-.6*(this.preX-i):i>e.width/2?.6*(this.preY-n):-.6*(this.preY-n);var c=e.getBearing()+l;this._db=this._db||0,this._db+=l,e.setBearing(c)}this._rotateMode.indexOf("pitch")>=0&&e.options.dragPitch&&e.setPitch(e.getPitch()+.4*(this.preY-n)),this.preX=i,this.preY=n,e.getBearing()===o&&e.getPitch()===r||e.onDragRotating(t)}},i._rotateEnd=function(t){var e=this.target,i=e.getBearing();this._clear();var n=z()-this.startDragTime;if(e.onDragRotateEnd(t),Math.abs(i-this.startBearing)>20&&("rotate"===this._rotateMode||"rotate_pitch"===this._rotateMode)&&!t.interupted&&n<400){var r=e.getBearing();e._animateTo({bearing:r+this._db/2},{easing:"out",duration:800})}},i._clear=function(){delete this.startPrjCoord,delete this.preX,delete this.preY,delete this.startX,delete this.startY},e}(Ti);ro.mergeOptions({draggable:!0,dragPan:!0,dragRotatePitch:!0,dragRotate:!0,dragPitch:!0}),ro.addOnLoadHook("addHandler","draggable",ao);var so="mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend",lo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){var t=this.target,e=t._panels.allLayers||t._containerDOM;ke(e,so,this._identifyGeometryEvents,this)},i.removeHooks=function(){var t=this.target,e=t._panels.allLayers||t._containerDOM;Oe(e,so,this._identifyGeometryEvents,this)},i._identifyGeometryEvents=function(t,e){var i=this.target;if(!i.isInteracting()&&!i._ignoreEvent(t)){var n=null,r=e||t.type,o="mousedown"===r||"touchstart"===r&&t.touches&&1===t.touches.length;if(o)this._mouseDownTime=z();else if(("click"===r||"touchend"===r)&&this._mouseDownTime){var a=this._mouseDownTime;if(delete this._mouseDownTime,z()-a>300){if("click"===r)return}else"touchend"===r&&(n="click")}var s=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(s){var l=Te(s,i._containerDOM);"touchstart"===r&&ve(t);for(var c=null,h=this.target.getRenderer().getTopElements(),u=(o||"click"===r)&&2!==t.button,d=0;d<h.length;d++)if(h[d].hitTest(l)){var p=h[d].options.cursor;if(p&&(c=p),u||h[d].events&&h[d].events.indexOf(r)>=0){var f={target:i,type:r,domEvent:t,containerPoint:l};if(u)return i._setPriorityCursor(c),void h[d].mousedown(f);h[d].onEvent(f)}}var m=i._getLayers((function(t){return!(!t.identify||!t.options.geometryEvents)}));if(i._setPriorityCursor(c),m.length){var g={includeInternals:!0,filter:function(e){if(!(e instanceof Wr))return!1;var i=e._getEventTypeToFire(t);if("mousemove"===r){if(!c&&e.options.cursor&&(c=e.options.cursor),!e.listens("mousemove")&&!e.listens("mouseover")&&!e.listens("mouseenter"))return!1}else if(!e.listens(i)&&!e.listens(n))return!1;return!0},count:1,containerPoint:l,onlyVisible:i.options.onlyVisibleGeometryEvents,layers:m},y=function(e){var o=!0;if("mousemove"===r){var a={};if(e.length>0)for(var s=e.length-1;s>=0;s--){var l=e[s];if(l instanceof Wr){var h=l._getInternalId();a[h]=l,l._onEvent(t),this._prevOverGeos&&this._prevOverGeos.geomap[h]||l._onEvent(t,"mouseenter"),o=l._onEvent(t,"mouseover")}}i._setPriorityCursor(c);var u=this._prevOverGeos&&this._prevOverGeos.geos;if(this._prevOverGeos={geos:e,geomap:a},u&&u.length>0)for(var d=u.length-1;d>=0;d--){var p=u[d];if(p instanceof Wr){var f=u[d]._getInternalId();a[f]||(o=p._onEvent(t,"mouseout"))}}}else{if(!e||!e.length)return;for(var m=e.length-1;m>=0;m--)if(e[m]instanceof Wr){o=e[m]._onEvent(t),n&&e[m]._onEvent(t,n);break}}!1===o&&xe(t)}.bind(this);"mousemove"===r||"touchmove"===r?this._queryIdentifyTimeout=i.getRenderer().callInNextFrame((function(){i.isInteracting()||i.identifyAtPoint(g,y)})):i.identifyAtPoint(g,y)}}}},e}(Ti);ro.mergeOptions({geometryEvents:!0,onlyVisibleGeometryEvents:!0}),ro.addOnLoadHook("addHandler","geometryEvents",lo);var co=function(t){function e(e){var i;return(i=t.call(this,e)||this)._thisScrollZoom=i._scrollZoom.bind(re(re(i))),i._wheelZoomRate=1/450,i._defaultZoomRate=.01,i._delta=0,i}ne(e,t);var i=e.prototype;return i.addHooks=function(){ge(this.target._containerDOM,"wheel",this._onWheelScroll,this)},i.removeHooks=function(){ye(this.target._containerDOM,"wheel",this._onWheelScroll)},i._onWheelScroll=function(t){ve(t),xe(t);var e=this.target;if(e._ignoreEvent(t)||!e.options.zoomable)return!1;var i=e._containerDOM,n=e._checkZoomOrigin(Te(t,i));return e.options.seamlessZoom?(this._zooming||(this._trackPadSuspect=0,this._ensureTrackpad=!1),this._seamless(t,n)):this._interval(t,n)},i._seamless=function(t,e){var i=t.deltaMode===window.WheelEvent.DOM_DELTA_LINE?60*t.deltaY:t.deltaY;if(i%4.000244140625!=0&&(this._ensureTrackpad||(Math.abs(i)<60?this._trackPadSuspect++:this._trackPadSuspect=0,this._trackPadSuspect>=2&&(this._ensureTrackpad=!0)),this._ensureTrackpad&&(i*=14)),t.shiftKey&&i&&(i/=4),this._lastWheelEvent=t,this._delta-=i,!this._zooming&&this._delta){var n=this.target;this._zoomOrigin=e,n.onZoomStart(null,e)}this._start()},i._start=function(){if(this._delta){this._zooming=!0;var t=this.target;this._active||(t.getRenderer().callInNextFrame(this._thisScrollZoom),this._active=!0)}},i._scrollZoom=function(){var t=this;if(this._active=!1,this._delta){var e=Math.abs(this._delta)>4.000244140625?this._wheelZoomRate:this._defaultZoomRate,i=2/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&0!==i&&(i=1/i);var n=this.target,r=n.getZoom(),o=n.getZoomForScale(i,r,!0);this._delta=0,n.onZooming(o,this._zoomOrigin),this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout((function(){t._zooming=!1,delete t._timeout,n.onZoomEnd(n.getZoom(),t._zoomOrigin)}),210)}},i._interval=function(t,e){var i=this,n=this.target;if(this._zooming)return this._requesting++,!1;this._requesting=0;var r=(t.deltaY?-1*t.deltaY:t.wheelDelta?t.wheelDelta:t.detail)>0?1:-1;t.detail&&(r*=-1);var o=n.getZoom(),a=o+r;if((a=n._checkZoom(r>0?Math.ceil(a):Math.floor(a)))===o)return!1;this._zooming=!0,this._delta||(n.onZoomStart(null,e),this._origin=e,this._delta=r,this._startZoom=n.getZoom());return n._animateTo({zoom:a-1*this._delta/2,around:this._origin},{continueOnViewChanged:!0,easing:"linear",duration:90,wheelZoom:!0},(function(e){"finished"===e.state.playState?i._requesting<1||Math.abs(a-i._startZoom)>2||a===n.getMaxZoom()||a===n.getMinZoom()?(n._animateTo({zoom:a,around:i._origin},{continueOnViewChanged:!0,duration:100},(function(t){"running"!==t.state.playState&&(delete i._zooming,delete i._requesting)})),delete i._startZoom,delete i._origin,delete i._delta,i._requesting=0):F(i._requesting)||(delete i._zooming,i._onWheelScroll(t)):"running"!==e.state.playState&&(delete i._zooming,delete i._requesting)})),!1},e}(Ti);ro.mergeOptions({scrollWheelZoom:!0,seamlessZoom:!0}),ro.addOnLoadHook("addHandler","scrollWheelZoom",co);var ho=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){ge(this.target.getContainer(),"touchstart",this._onTouchStart,this)},i.removeHooks=function(){ye(this.target.getContainer(),"touchstart",this._onTouchStart)},i._onTouchStart=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var i=e.getContainer(),n=Te(t.touches[0],i),r=Te(t.touches[1],i);this.preY=n.y,this._startP1=n,this._startP2=r,this._startDist=n.distanceTo(r),this._startVector=n.sub(r),this._startZoom=e.getZoom(),this._startBearing=e.getBearing(),Oe(document,"touchmove",this._onTouchMove,this),Oe(document,"touchend",this._onTouchEnd,this),ge(document,"touchmove",this._onTouchMove,this),ge(document,"touchend",this._onTouchEnd,this),ve(t),e._fireEvent("touchactstart")}},i._onTouchMove=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var i=e.getContainer(),n=Te(t.touches[0],i),r=Te(t.touches[1],i),o=n.sub(this._startP1),a=r.sub(this._startP2),s=n.sub(r),l=n.distanceTo(r)/this._startDist,c=180*s.angleWith(this._startVector)/Math.PI,h=.4*((this.preY||n.y)-n.y);this.preY=n.y;var u={domEvent:t,mousePos:[n,r]};if(this.mode||(e.options.touchRotate&&Math.abs(c)>8?this.mode=e.options.touchZoomRotate?"rotate_zoom":"rotate":e.options.touchPitch&&o.y*a.y>0&&Math.abs(o.y)>10&&Math.abs(a.y)>10?this.mode="pitch":e.options.zoomable&&e.options.touchZoom&&Math.abs(1-l)>.15&&(this.mode=e.options.touchZoomRotate&&e.options.touchRotate?"rotate_zoom":"zoom"),this._startTouching(u)),"zoom"===this.mode||"rotate_zoom"===this.mode){this._scale=l;var d=e._getResolution(this._startZoom)/l,p=e.getZoomFromRes(d);e.onZooming(p,this._Origin)}"rotate"===this.mode||"rotate_zoom"===this.mode?(e.setBearing(this._startBearing+c),e.onDragRotating(u)):"pitch"===this.mode&&(e.setPitch(e.getPitch()+h),e.onDragRotating(u)),e._fireEvent("touchactinging")}},i._startTouching=function(t){var e=this.target;if("zoom"===this.mode||"rotate_zoom"===this.mode){var i=e.getSize();this._Origin=new ae(i.width/2,i.height/2),e.onZoomStart(null,this._Origin)}"rotate"!==this.mode&&"pitch"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateStart(t)},i._onTouchEnd=function(t){delete this.preY;var e=this.target;if(Oe(document,"touchmove",this._onTouchMove,this),Oe(document,"touchend",this._onTouchEnd,this),"zoom"===this.mode||"rotate_zoom"===this.mode){var i=this._scale,n=e._getResolution(this._startZoom)/i,r=e.getZoomFromRes(n);e.onZoomEnd(r,this._Origin)}"pitch"!==this.mode&&"rotate"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateEnd({domEvent:t}),delete this.mode,e._fireEvent("touchactend")},e}(Ti);ro.mergeOptions({touchGesture:!0,touchZoom:!0,touchPitch:!0,touchRotate:!0,touchZoomRotate:!1}),ro.addOnLoadHook("addHandler","touchGesture",ho);var uo="__anim_player",po={in:function(t){return Math.pow(t,2)},out:function(t){return 1-po.in(1-t)},inAndOut:function(t){return 3*t*t-2*t*t*t},linear:function(t){return t},upAndDown:function(t){return t<.5?po.inAndOut(2*t):1-po.inAndOut(2*(t-.5))}},fo=function(t,e){this.state=t,this.styles=e},mo=function(t,e,i,n){this._animation=t,this.options=e,this._onFrame=i,this.playState="idle",this.ready=!0,this.finished=!1,this.target=n},go={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(t){if(!t)return null;function e(t){if(!Array.isArray(t))return go._resolveStyles(t);for(var e=[],i=[],n=[],r=0;r<t.length;r++){var o=go._resolveStyles(t[r]);o&&(e.push(o[0]),i.push(o[1]),n.push(o[2]))}return e.length?[e,i,n]:null}function i(t){var e,i=t;Array.isArray(t)||(i=N(t)?[0,t]:t instanceof ae||t instanceof $i?[new(e=t.constructor)(0,0),t]:[t,t]);var n=i[0],r=i[1];return N(n)&&N(r)?n===r?null:[n,r-n,r]:Array.isArray(n)&&N(n[0])||n instanceof $i||n instanceof ae?(Array.isArray(n)?(n=new $i(n),r=new $i(r)):(n=new(e=n.constructor)(n),r=new e(r)),n.equals(r)?null:[n,r.sub(n),r]):[n,r,r]}var n,r={},o={},a={};for(var s in t)if(t.hasOwnProperty(s)){var l=t[s];if(!l)continue;if(Array.isArray(l)&&(F(l[0])||F(l[1])))continue;var c=void 0;n=l,(c=!Array.isArray(n)&&n.constructor===Object||Array.isArray(n)&&n[0].constructor===Object?e(l):i(l))&&(o[s]=c[0],r[s]=c[1],a[s]=c[2])}return[o,r,a]},framing:function(t,e){e||(e={});var i,n,r,o=e.easing?po[e.easing]:po.linear;o||(o=po.linear),(t=go._resolveStyles(t))&&(n=t[0],i=t[1],r=t[2]);return function(t,e){var a,s;if(t<0)a={playState:"idle",delta:0},s=n;else if(t<e){var l=o(t/e);a={playState:"running",delta:l},s=function t(e,i,n){if(!i||!n)return null;var o={};for(var a in n)if(n.hasOwnProperty(a)){if(i[a]===r[a]){o[a]=i[a];continue}var s=i[a],l=n[a];if(N(l))o[a]=s+e*l;else if(Array.isArray(l)){for(var c=[],h=0;h<l.length;h++)c.push(t(e,s[h],l[h]));o[a]=c}else{var u=l.constructor;o[a]=u===Object?t(e,s,l):s instanceof ae||s instanceof $i?s.add(l.multi(e)):l}}return o}(l,n,i)}else a={playState:"finished",delta:1},s=r;return a.startStyles=n,a.destStyles=r,a.progress=t,a.remainingMs=e-t,new fo(a,s)}},_requestAnimFrame:function(t){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(t),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=W(go._frameFn))},_run:function(){if(this._frameQueue.length){var t=this._frameQueue;this._frameQueue=[];for(var e=0,i=t.length;e<i;e++)t[e]();this._frameQueue.length?this._animationFrameId=W(go._frameFn):delete this._animationFrameId}},animate:function(t,e,i,n){e||(e={});var r=go.framing(t,e);return new mo(r,e,i,n)}};go._frameFn=go._run.bind(go),B(mo.prototype,{_prepare:function(){var t=this.options,e=t.speed||t.duration;U(e)&&((e=go.speed[e])||(e=+e)),e||(e=go.speed.normal),this.duration=e,this._framer=t.framer||go._requestAnimFrame.bind(go)},play:function(){if("idle"!==this.playState&&"paused"!==this.playState||this.target&&this.target[uo])return this;this.target&&(this.target[uo]=1),"idle"===this.playState&&(this.currentTime=0,this._prepare());var t=z();if(!this.startTime){var e=this.options;this.startTime=e.startTime?e.startTime:t}return this._playStartTime=Math.max(t,this.startTime),"paused"===this.playState&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},pause:function(){return"paused"===this.playState||(this.playState="paused",this._run()),this},cancel:function(){return"idle"===this.playState||(this.playState="idle",this.finished=!1,this._run()),this},finish:function(){return"finished"===this.playState||(this.playState="finished",this.finished=!0,this._run()),this},reverse:function(){},_run:function(){var t=this,e=this._onFrame,i=z(),n=i-this._playStartTime;if(this.options.repeat&&n>=this.duration&&(this._playStartTime=i,n=0),"running"===this.playState){var r=this._animation(n,this.duration);this.playState=r.state.playState,"running"!==this.playState&&this.target&&delete this.target[uo],"idle"===this.playState?this.startTime>i&&setTimeout(this._run.bind(this),this.startTime-i):"running"===this.playState?this._framer((function(){"running"===t.playState&&(t.currentTime=n,e&&e(r),t._run())})):"finished"===this.playState&&(this.finished=!0,e&&e(r))}else if(this.target&&delete this.target[uo],e){"finished"===this.playState?n=this.duration:"idle"===this.playState&&(n=0);var o=this._animation(n,this.duration);o.state.playState=this.playState,e(o)}}});var yo=Object.freeze({Animation:go,Easing:po,Player:mo,Frame:fo}),_o=vi((function(t){!function(){function e(t,e,i){var n=e.x,r=e.y,o=i.x-n,a=i.y-r;if(0!==o||0!==a){var s=((t.x-n)*o+(t.y-r)*a)/(o*o+a*a);s>1?(n=i.x,r=i.y):s>0&&(n+=o*s,r+=a*s)}return(o=t.x-n)*o+(a=t.y-r)*a}function i(t,i){var n=t.length-1,r=[t[0]];return function t(i,n,r,o,a){for(var s,l=o,c=n+1;c<r;c++){var h=e(i[c],i[n],i[r]);h>l&&(s=c,l=h)}l>o&&(s-n>1&&t(i,n,s,o,a),a.push(i[s]),r-s>1&&t(i,s,r,o,a))}(t,0,n,i,r),r.push(t[n]),r}function n(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return t=i(t=n?t:function(t,e){for(var i,n,r,o,a,s=t[0],l=[s],c=1,h=t.length;c<h;c++)i=t[c],r=s,o=void 0,a=void 0,o=(n=i).x-r.x,a=n.y-r.y,o*o+a*a>e&&(l.push(i),s=i);return s!==i&&l.push(i),l}(t,r),r)}t.exports=n,t.exports.default=n}()})),vo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getOutline=function(){if(!this._getPainter())return null;var t=this.getExtent();return new xo(t.toArray(),{symbol:{lineWidth:1,lineColor:"6b707b"}})},i.animateShow=function(t,e){var i=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.finish(),V(t)&&(e=t={});var n=this.getCoordinates();if(0===n.length)return this;this._animIdx=0,this._animLenSoFar=0,this.show();var r=!!this.getShell?this.getShell().concat(this.getShell()[0]):this.getCoordinates(),o=this._getProjection(),a=o.projectCoords(r);this._prjAniShowCenter=this._getPrjExtent().getCenter(),this._aniShowCenter=o.unproject(this._prjAniShowCenter);var s=t.duration||1e3,l=t.easing||"out";this.setCoordinates([]);for(var c=0,h=1;h<a.length;h++)c+=a[h].distanceTo(a[h-1]);var u=this._showPlayer=go.animate({t:s},{duration:s,easing:l},(function(t){if(i.getMap()){var o=i._drawAnimShowFrame(t.styles.t,s,c,r,a);"finished"===t.state.playState&&(delete i._showPlayer,delete i._aniShowCenter,delete i._prjAniShowCenter,delete i._animIdx,delete i._animLenSoFar,delete i._animTailRatio,i.setCoordinates(n)),e&&e(t,o)}else if("finished"!==u.playState&&(u.finish(),e)){var l=i.getCoordinates();e(t,l[l.length-1])}}),this);return u.play(),u},i._drawAnimShowFrame=function(t,e,i,n,r){if(0===t)return n[0];var o,a,s=this._getProjection(),l=t/e*i,c=0;for(o=this._animIdx,a=r.length;o<a-1&&(c=r[o].distanceTo(r[o+1]),!(this._animLenSoFar+c>l));o++)this._animLenSoFar+=c;if(this._animIdx=o,this._animIdx>=a-1)return this.setCoordinates(n),n[n.length-1];var h=this._animIdx,u=r[h],d=r[h+1],p=(l-this._animLenSoFar)/c;this._animTailRatio=p;var f=u.x+(d.x-u.x)*p,m=u.y+(d.y-u.y)*p,g=new $i(f,m),y=s.unproject(g),_=!!this.getShell;if(!_&&this.options.smoothness>0){var v=n.slice(0,this._animIdx+3);this.setCoordinates(v);var x=r.slice(0,this._animIdx+3);this._setPrjCoordinates(x)}else{var b=n.slice(0,this._animIdx+1);b.push(y);var w=r.slice(0,this._animIdx+1);w.push(g),_?(this.setCoordinates([this._aniShowCenter].concat(b)),this._setPrjCoordinates([this._prjAniShowCenter].concat(w))):(this.setCoordinates(b),this._setPrjCoordinates(w))}return y},i._getCenterInExtent=function(t,e,i){var n=this.getExtent();if(!t.intersects(n))return null;var r=i(e,t);if(0===r.length)return null;var o=0,a=0,s=0;r.forEach((function(t){Array.isArray(t)?t.forEach((function(t){t.point&&(t=t.point),o+=t.x,a+=t.y,s++})):(t.point&&(t=t.point),o+=t.x,a+=t.y,s++)}));var l=new $i(o,a)._multi(1/s);return l.count=s,l},i._getPath2DPoints=function(t,e,i){if(!dt(t))return[];var n=this.getMap(),r=!e&&this._shouldSimplify(),o=this.options.simplifyTolerance*n._getResolution(),a=Array.isArray(t[0]);if(delete this._simplified,r&&!a){var s=t.length;t=_o(t,o,!1),this._simplified=t.length<s}if(F(i)&&(i=n.getZoom()),Array.isArray(t)){if(!Array.isArray(t[0]))return n._prjsToPoints(t,i);for(var l=[],c=0,h=t.length;c<h;c++){var u=t[c],d=n._prjsToPoints(u,i);l.push(d)}return l}return n._prjToPoint(t,i)},i._shouldSimplify=function(){var t=this.getLayer(),e=this.getProperties(),i=e&&t.options.enableAltitude&&!F(e[t.options.altitudeProperty]);return t&&t.options.enableSimplify&&!i&&this.options.enableSimplify&&!this._showPlayer},i._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},i._getPrjCoordinates=function(){return this._verifyProjection(),!this._prjCoords&&this._getProjection()&&(this._prjCoords=this._projectCoords(this._coordinates)),this._prjCoords},i._updateCache=function(){this._clearCache(),this._getProjection()&&this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates()))},i._clearProjection=function(){this._prjCoords=null,t.prototype._clearProjection.call(this)},i._projectCoords=function(t){var e=this._getProjection();return e?e.projectCoords(t):[]},i._unprojectCoords=function(t){var e=this._getProjection();return e?e.unprojectCoords(t):[]},i._computeCenter=function(){var t=this._coordinates;if(!dt(t))return null;for(var e=0,i=0,n=0,r=t.length,o=0;o<r;o++)t[o]&&N(t[o].x)&&N(t[o].y)&&(e+=t[o].x,i+=t[o].y,n++);return new $i(e/n,i/n)},i._computeExtent=function(){var t=this._coordinates;if(!dt(t))return null;var e=[t];return this.hasHoles&&this.hasHoles()&&e.push.apply(e,this.getHoles()),this._coords2Extent(e,this._getProjection())},i._computePrjExtent=function(){var t=[this._getPrjCoordinates()];return this.hasHoles&&this.hasHoles()&&t.push.apply(t,this._getPrjHoles()),this._coords2Extent(t)},i._get2DLength=function(){for(var t=this._getPath2DPoints(this._getPrjCoordinates(),!0),e=0,i=1,n=t.length;i<n;i++)e+=t[i].distanceTo(t[i-1]);return e},i._hitTestTolerance=function(){var t,e=this._getInternalSymbol();if(Array.isArray(e)){t=0;for(var i=0;i<e.length;i++)N(e[i].lineWidth)&&e[i].lineWidth>t&&(t=e[i].lineWidth)}else t=e.lineWidth;return N(t)?t/2:1.5},i._coords2Extent=function(t,e){for(var i=new un(e),n=0,r=t.length;n<r;n++)for(var o=0,a=t[n].length;o<a;o++)i._combine(t[n][o]);return i},e}(Wr);vo.mergeOptions({smoothness:0,enableClip:!0,enableSimplify:!0,simplifyTolerance:2,symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}});var xo=function(t){function e(e,i){var n;return(n=t.call(this,i)||this).type="Polygon",e&&n.setCoordinates(e),n}ne(e,t);var i=e.prototype;return i.setCoordinates=function(t){if(!t)return this._coordinates=null,this._holes=null,this._projectRings(),this;var e=$i.toCoordinates(t),i=e.length;if(Array.isArray(e[0])){if(this._coordinates=this._trimRing(e[0]),i>1){for(var n=[],r=1;r<i;r++)e[r]&&n.push(this._trimRing(e[r]));this._holes=n}}else this._coordinates=this._trimRing(e);return this._projectRings(),this},i.getCoordinates=function(){if(!this._coordinates)return[];for(var t=this.getHoles(),e=[this._copyAndCloseRing(this._coordinates)],i=0,n=t.length;i<n;i++)e.push(this._copyAndCloseRing(t[i]));return e},i.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getShell(),ar)},i.getShell=function(){return this._coordinates||[]},i.getHoles=function(){return this._holes||[]},i.hasHoles=function(){return this.getHoles().length>0},i._projectRings=function(){this.getMap()?(this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()):this.onShapeChanged()},i._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},i._cleanRing=function(t){for(var e=t.length-1;e>=0;e--)t[e]||t.splice(e,1)},i._checkRing=function(t){if(this._cleanRing(t),!t||!dt(t))return!1;var e=t[t.length-1],i=!0;return t[0].x===e.x&&t[0].y===e.y||(i=!1),i},i._trimRing=function(t){var e=this._checkRing(t);return dt(t)&&e&&t.splice(t.length-1,1),t},i._copyAndCloseRing=function(t){t=t.slice(0);var e=this._checkRing(t);return dt(t)&&!e?(t.push(t[0].copy()),t):t},i._getPrjShell=function(){return"Polygon"===this.getJSONType()?this._getPrjCoordinates():(this._verifyProjection(),this._getProjection()&&!this._prjShell&&(this._prjShell=this._projectCoords(this.getShell())),this._prjShell)},i._getPrjHoles=function(){var t=this._getProjection();return this._verifyProjection(),t&&!this._prjHoles&&(this._prjHoles=this._projectCoords(this.getHoles())),this._prjHoles},i._computeGeodesicLength=function(t){var e=this.getCoordinates();if(!dt(e))return 0;for(var i=0,n=0,r=e.length;n<r;n++)i+=t.measureLength(e[n]);return i},i._computeGeodesicArea=function(t){var e=this.getCoordinates();if(!dt(e))return 0;for(var i=t.measureArea(e[0]),n=1,r=e.length;n<r;n++)i-=t.measureArea(e[n]);return i},i._updateCache=function(){t.prototype._updateCache.call(this),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles()))},i._clearCache=function(){return delete this._prjShell,t.prototype._clearCache.call(this)},i._clearProjection=function(){this._prjHoles&&(this._prjHoles=null),this._prjShell&&(this._prjShell=null),t.prototype._clearProjection.call(this)},e}(vo);function bo(t){return function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getCoordinates=function(){return this._coordinates},i.setCoordinates=function(t){var e=t instanceof $i?t:new $i(t);if(e.equals(this._coordinates))return this;if(this._coordinates=e,!this.getMap())return this._dirtyCoords=!0,this.onPositionChanged(),this;var i=this._getProjection();return this._setPrjCoordinates(i.project(this._coordinates)),this},i._getCenter2DPoint=function(t){var e=this.getMap();if(!e)return null;var i=F(t)?e.getZoom():e.getGLZoom(),n=this._getPrjCoordinates();return n?e._prjToPoint(n,i):null},i._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pcenter&&t&&this._coordinates&&(this._pcenter=t.project(this._coordinates)),this._pcenter},i._setPrjCoordinates=function(t){this._pcenter=t,this.onPositionChanged()},i._updateCache=function(){this._clearCache();var t=this._getProjection();this._pcenter&&t&&(this._coordinates=t.unproject(this._pcenter))},i._clearProjection=function(){this._pcenter=null,t.prototype._clearProjection.call(this)},i._computeCenter=function(){return this._coordinates?this._coordinates.copy():null},e}(t)}xo.registerJSONType("Polygon");var wo=new pn,Mo=function(t){function e(e,i){var n;return(n=t.call(this,i)||this).type="Point",e&&n.setCoordinates(e),n}ne(e,t);var i=e.prototype;return i.getOutline=function(){var t=this.getCoordinates(),i=this.getContainerExtent(),n=this.getMap().coordToContainerPoint(t);return new e(t,{symbol:{markerType:"square",markerWidth:i.getWidth(),markerHeight:i.getHeight(),markerLineWidth:1,markerLineColor:"6b707b",markerFill:"rgba(0, 0, 0, 0)",markerDx:i.xmin-(n.x-i.getWidth()/2),markerDy:i.ymin-(n.y-i.getHeight()/2)}})},i.setSymbol=function(){var e;delete this._fixedExtent;for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.prototype.setSymbol).call.apply(e,[this].concat(n))},i._getSizeSymbol=function(t){for(var e,i={},n=!1,r=!1,o=0;o<ir.length;o++){var a=t[ir[o]];F(a)||(!n&&Lt(a)&&(n=!0,r=!0),i[ir[o]]=a)}for(var s=0;s<nr.length;s++){var l=t[nr[s]];F(l)||(!n&&Lt(l)&&(n=!0),i[nr[s]]=l)}return n?(e=Jt(i,this),r&&(e._dynamic=!0)):e=i,e},i._setExternSymbol=function(e){return this._symbol||delete this._fixedExtent,t.prototype._setExternSymbol.call(this,e)},i._isDynamicSize=function(){return this._sizeSymbol&&this._sizeSymbol._dynamic},i._getFixedExtent=function(){if(this._fixedExtent&&!this._isDynamicSize())return this._fixedExtent;this._fixedExtent=this._fixedExtent||new pn,this._fixedExtent.set(null,null,null,null);var t=this._sizeSymbol;if(!t)return this._fixedExtent;var e=this.getLayer()&&this.getLayer().getRenderer(),i=e&&e.resources,n=this.getTextDesc();if(Array.isArray(t))for(var r=0;r<t.length;r++)t[r]&&this._fixedExtent._combine($n(wo,t[r],i,n&&n[r]));else this._fixedExtent=$n(this._fixedExtent,t,i,n);return this._fixedExtent},i._isVectorMarker=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&Qn(t)},i._canEdit=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&(Qn(t)||tr(t)||Kn(t))},i._containsPoint=function(e,i){var n=this.getContainerExtent();return i&&(n=n.expand(i)),!!n.contains(e)&&(!this.options.hitTestForEvent||t.prototype._containsPoint.call(this,e,i))},i._computeExtent=function(){return To.call(this,"getCenter")},i._computePrjExtent=function(){return To.call(this,"_getPrjCoordinates")},i._computeGeodesicLength=function(){return 0},i._computeGeodesicArea=function(){return 0},i._getSprite=function(t,e){return this._getPainter()?this._getPainter().getSprite(t,e):new Nr(this).getSprite(t,e)},e}(bo(Wr));function To(t){var e=this[t]();return e?new un(e,e,this._getProjection()):null}Mo.mergeOptions({symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M3,9 a5,5 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34},hitTestForEvent:!1}),Mo.registerJSONType("Marker");var So=function(t){function e(e,i){var n;return(n=t.call(this,i)||this).type="LineString",e&&n.setCoordinates(e),n}ne(e,t);var i=e.prototype;return i.setCoordinates=function(t){return t?(this._coordinates=$i.toCoordinates(t),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},i.getCoordinates=function(){return this._coordinates||[]},i.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getCoordinates(),rr)},i._computeGeodesicLength=function(t){return t.measureLength(this.getCoordinates())},i._computeGeodesicArea=function(){return 0},e}(vo);So.mergeOptions({arrowStyle:null,arrowPlacement:"vertex-last"}),So.registerJSONType("LineString");var Eo=new pn,Co=function(t){function e(e,i){var n;return(n=t.call(this,i)||this).type="GeometryCollection",n.setGeometries(e),n}ne(e,t);var i=e.prototype;return i.getContainerExtent=function(t){var e=t||new pn;return this.forEach((function(t){e._combine(t.getContainerExtent(Eo))})),e},i.setGeometries=function(t){for(var e=this._checkGeometries(t||[]),i=this._getSymbol(),n=this.config(),r=e.length-1;r>=0;r--)e[r]._initOptions(n),e[r]._setParent(this),e[r]._setEventParent(this),i&&e[r].setSymbol(i);return this._geometries=e,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},i.getGeometries=function(){return this._geometries||[]},i.forEach=function(t,e){for(var i=this.getGeometries(),n=0,r=i.length;n<r;n++)i[n]&&(e?t.call(e,i[n],n):t(i[n],n));return this},i.filter=function(t,i){if(!t)return new e;var n=[],r=V(t),o=r?t:Bt(t);return this.forEach((function(t){var e=r?t:Wt(t);(i?o.call(i,e):o(e))&&n.push(t)}),this),new e(n)},i.translate=function(t){if(!t)return this;if(this.isEmpty())return this;var e=arguments;return this.forEach((function(t){t&&t.translate&&t.translate.apply(t,e)})),this},i.isEmpty=function(){return!dt(this.getGeometries())},i.remove=function(){return this.forEach((function(t){t._unbind()})),Wr.prototype.remove.apply(this,arguments)},i.show=function(){return this.options.visible=!0,this.forEach((function(t){t.show()})),this},i.hide=function(){return this.options.visible=!1,this.forEach((function(t){t.hide()})),this},i.onConfig=function(t){this.forEach((function(e){e.config(t)}))},i.getSymbol=function(){var e=t.prototype.getSymbol.call(this);if(!e){var i=[],n=!1;this.forEach((function(t){t.getSymbol()&&!n&&(n=!0),i.push(t.getSymbol())})),n&&(e={children:i})}return e},i.setSymbol=function(t){if(t&&t.children)this._symbol=null,this.forEach((function(e,i){e.setSymbol(t.children[i])}));else{var e=this._prepareSymbol(t);this._symbol=e,this.forEach((function(t){t.setSymbol(e)}))}return this.onSymbolChanged(),this},i._setExternSymbol=function(t){return t=this._prepareSymbol(t),this._externSymbol=t,this.forEach((function(e){e._setExternSymbol(t)})),this.onSymbolChanged(),this},i._bindLayer=function(){t.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},i._bindGeometriesToLayer=function(){var t=this.getLayer();this.forEach((function(e){e._bindLayer(t)}))},i._checkGeometries=function(t){if(t&&!Array.isArray(t)){if(t instanceof Wr)return[t];throw new Error("The geometry added to collection is invalid.")}for(var e=0,i=t.length;e<i;e++)if(!this._checkGeo(t[e]))throw new Error("The geometry added to collection is invalid. Index: "+e);return t},i._checkGeo=function(t){return t instanceof Wr},i._updateCache=function(){this._clearCache(),this.isEmpty()||this.forEach((function(t){t&&t._updateCache&&t._updateCache()}))},i._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach((function(t){t._removePainter()}))},i._computeCenter=function(t){if(!t||this.isEmpty())return null;for(var e=0,i=0,n=0,r=this.getGeometries(),o=0,a=r.length;o<a;o++)if(r[o]){var s=r[o]._computeCenter(t);s&&(e+=s.x,i+=s.y,n++)}return 0===n?null:new $i(e/n,i/n)},i._containsPoint=function(t,e){if(this.isEmpty())return!1;for(var i=this.getGeometries(),n=0,r=i.length;n<r;n++)if(i[n]._containsPoint(t,e))return!0;return!1},i._computeExtent=function(t){return Ao.call(this,t,"_computeExtent")},i._computePrjExtent=function(t){return Ao.call(this,t,"_computePrjExtent")},i._computeGeodesicLength=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,n=0,r=e.length;n<r;n++)e[n]&&(i+=e[n]._computeGeodesicLength(t));return i},i._computeGeodesicArea=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,n=0,r=e.length;n<r;n++)e[n]&&(i+=e[n]._computeGeodesicArea(t));return i},i._exportGeoJSONGeometry=function(){var t=[];if(!this.isEmpty())for(var e=this.getGeometries(),i=0,n=e.length;i<n;i++)e[i]&&t.push(e[i]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:t}},i._clearProjection=function(){if(!this.isEmpty())for(var t=this.getGeometries(),e=0,i=t.length;e<i;e++)t[e]&&t[e]._clearProjection()},i._getConnectPoints=function(){var t=this.getExtent();return[new $i(t.xmin,t.ymax),new $i(t.xmax,t.ymin),new $i(t.xmin,t.ymin),new $i(t.xmax,t.ymax)]},i._getExternalResources=function(){if(this.isEmpty())return[];for(var t,e,i=this.getGeometries(),n=[],r={},o=0,a=i.length;o<a;o++)if(i[o])for(var s=0,l=(t=te(i[o]._getInternalSymbol())).length;s<l;s++)r[e=t[s].join()]||(n.push(t[s]),r[e]=1);return n},i.startEdit=function(t){var e=this;if(this.isEmpty())return this;t||(t={}),t.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(t.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1);for(var i=this.getGeometries(),n=0,r=i.length;n<r;n++)i[n].startEdit(t);return this._editing=!0,this.hide(),setTimeout((function(){e.fire("editstart")}),1),this},i.endEdit=function(){if(this.isEmpty())return this;for(var t=this.getGeometries(),e=0,i=t.length;e<i;e++)t[e].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},i.isEditing=function(){return!!this._editing},e}(Wr);function Ao(t,e){if(this.isEmpty())return null;for(var i=this.getGeometries(),n=null,r=0,o=i.length;r<o;r++){var a=i[r];if(a){var s=a[e](t);s&&(n=s.combine(n))}}return n}Co.registerJSONType("GeometryCollection");var Po=function(t){function e(e,i,n,r){var o;return(o=t.call(this,null,r)||this).GeometryType=e,o.type=i,o._initData(n),o}ne(e,t);var i=e.prototype;return i.getCoordinates=function(){for(var t=[],e=this.getGeometries(),i=0,n=e.length;i<n;i++){var r=e[i];t.push(r.getShell&&"Polygon"!==r.getJSONType()?[r.getShell()]:r.getCoordinates())}return t},i.setCoordinates=function(t){for(var e=[],i=0,n=(t=t||[]).length;i<n;i++){var r=new this.GeometryType(t[i],this.config());e.push(r)}return this.setGeometries(e),this},i._initData=function(t){(t=t||[]).length&&(t[0]instanceof this.GeometryType?this.setGeometries(t):this.setCoordinates(t))},i._checkGeo=function(t){return t instanceof this.GeometryType},i._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=$i.toNumberArrays(t);return{type:this.getType(),coordinates:e}},e}(Co),Lo=function(t){function e(e,i){return t.call(this,Mo,"MultiPoint",e,i)||this}return ne(e,t),e.prototype.findClosest=function(t){if(!t)return null;var e=this.getCoordinates(),i=null,n=1/0;return e.forEach((function(e){var r,o,a,s,l=(r=e,a=(o=t).x-r.x,s=o.y-r.y,Math.sqrt(a*a+s*s));l<n&&(i=e,n=l)})),i},e}(Po);Lo.registerJSONType("MultiPoint");var Io=function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.prototype.getCenterInExtent=function(t){var e=this.getGeometries(),i=0,n=0,r=0;return e.forEach((function(e){var o=e.getCenterInExtent(t);o&&(i+=o.x*o.count,n+=o.y*o.count,r+=o.count)})),0===r?null:new $i(i,n)._multi(1/r)},e}(Po),Ro=function(t){function e(e,i){return t.call(this,So,"MultiLineString",e,i)||this}return ne(e,t),e}(Io);Ro.registerJSONType("MultiLineString");var Do=function(t){function e(e,i){return t.call(this,xo,"MultiPolygon",e,i)||this}return ne(e,t),e}(Io);Do.registerJSONType("MultiPolygon");var ko={Marker:Mo,LineString:So,Polygon:xo,MultiPoint:Lo,MultiLineString:Ro,MultiPolygon:Do},Oo={toGeometry:function(t,e){if(U(t)&&(t=it(t)),Array.isArray(t)){for(var i=[],n=0,r=t.length;n<r;n++){var o=Oo._convert(t[n],e);Array.isArray(o)?nt(i,o):i.push(o)}return i}return Oo._convert(t,e)},_convert:function(t,e){if(!t||F(t.type))return null;var i=t.type;if("Feature"===i){var n=t.geometry,r=Oo._convert(n);return r?(r.setId(t.id),r.setProperties(t.properties),e&&e(r),r):null}if("FeatureCollection"===i){var o=t.features;return o?Oo.toGeometry(o,e):null}if(["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].indexOf(i)>=0){var a=new ko["Point"===i?"Marker":i](t.coordinates);return e&&e(a),a}if("GeometryCollection"===i){var s=t.geometries;if(!dt(s)){var l=new Co;return e&&e(l),l}for(var c=[],h=s.length,u=0;u<h;u++)c.push(Oo._convert(s[u]));var d=new Co(c);return e&&e(d),d}return null}},zo=function(t){function e(e,i,n){var r;return r=t.call(this,null,n)||this,e&&r.setCoordinates(e),r._radius=i,r}ne(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(t.coordinates,t.radius,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i.getRadius=function(){return this._radius},i.setRadius=function(t){return this._radius=t,this.onShapeChanged(),this},i.getShell=function(){for(var t,e,i,n=this._getMeasurer(),r=this.getCoordinates(),o=this.options.numberOfShellPoints,a=this.getRadius(),s=[],l=0,c=o-1;l<c;l++){t=360*l/c*Math.PI/180,e=a*Math.cos(t),i=a*Math.sin(t);var h=n.locate(r,e,i);s.push(h)}return s.push(s[0]),s},i.getHoles=function(){return[]},i.animateShow=function(){return this.show()},i._containsPoint=function(e,i){var n=this.getMap();if(n.getPitch())return t.prototype._containsPoint.call(this,e,i);var r=n._pointToContainerPoint(this._getCenter2DPoint()),o=this.getSize(),a=F(i)?this._hitTestTolerance():i,s=r.add(o.width/2,o.height/2);return cr(e,r,s,a)},i._computePrjExtent=function(t){var e=this._getMinMax(t);if(!e)return null;var i=this._getPrjCoordinates(),n=e.map((function(e){return t.project(e)})),r=n[0].x-i.x,o=n[1].x-i.x,a=n[2].y-i.y,s=n[3].y-i.y;return new un(i.add(r,a),i.add(o,s))},i._computeExtent=function(t){var e=this._getMinMax(t);return e?new un(e[0].x,e[2].y,e[1].x,e[3].y,this._getProjection()):null},i._getMinMax=function(t){if(!t||!this._coordinates||F(this._radius))return null;var e=this._radius;return[t.locate(this._coordinates,-e,0),t.locate(this._coordinates,e,0),t.locate(this._coordinates,0,e),t.locate(this._coordinates,0,-e)]},i._computeGeodesicLength=function(){return F(this._radius)?0:2*Math.PI*this._radius},i._computeGeodesicArea=function(){return F(this._radius)?0:Math.PI*Math.pow(this._radius,2)},i._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:$i.toNumberArrays([this.getShell()])}},i._toJSON=function(t){var e=this.getCenter(),i=B({},t);i.geometry=!1;var n=this.toGeoJSON(i);return n.geometry={type:"Polygon"},{feature:n,subType:"Circle",coordinates:[e.x,e.y],radius:this.getRadius()}},e}(bo(xo));zo.mergeOptions({numberOfShellPoints:60}),zo.registerJSONType("Circle");var Bo=function(t){function e(e,i,n,r){var o;return o=t.call(this,null,r)||this,e&&o.setCoordinates(e),o.width=i,o.height=n,o}ne(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(t.coordinates,t.width,t.height,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i.getWidth=function(){return this.width},i.setWidth=function(t){return this.width=t,this.onShapeChanged(),this},i.getHeight=function(){return this.height},i.setHeight=function(t){return this.height=t,this.onShapeChanged(),this},i.getShell=function(){for(var t,e,i,n,r=this._getMeasurer(),o=this.getCoordinates(),a=this.options.numberOfShellPoints,s=this.getWidth(),l=this.getHeight(),c=[],h=Math.pow(s/2,2)*Math.pow(l/2,2),u=Math.pow(s/2,2),d=Math.pow(l/2,2),p=0;p<a;p++){e=(t=360*p/a)*Math.PI/180,i=Math.sqrt(h/(u*Math.pow(Math.tan(e),2)+d)),n=Math.sqrt(h/(d*Math.pow(1/Math.tan(e),2)+u)),t>90&&t<270&&(i*=-1),t>180&&t<360&&(n*=-1);var f=r.locate(o,i,n);c.push(f)}return c},i.getHoles=function(){return[]},i.animateShow=function(){return this.show()},i._containsPoint=function(e,i){var n=this.getMap();if(n.isTransforming())return t.prototype._containsPoint.call(this,e,i);var r=n.getProjection(),o=F(i)?this._hitTestTolerance():i,a=r.projectCoords([this._coordinates,n.locate(this._coordinates,this.getWidth()/2,this.getHeight()/2)]);return cr(e,n._prjToContainerPoint(a[0]),n._prjToContainerPoint(a[1]),o)},i._computePrjExtent=function(){return zo.prototype._computePrjExtent.apply(this,arguments)},i._computeExtent=function(){return zo.prototype._computeExtent.apply(this,arguments)},i._getMinMax=function(t){if(!t||!this._coordinates||F(this.width)||F(this.height))return null;var e=this.getWidth(),i=this.getHeight();return[t.locate(this._coordinates,-e/2,0),t.locate(this._coordinates,e/2,0),t.locate(this._coordinates,0,-i/2),t.locate(this._coordinates,0,i/2)]},i._computeGeodesicLength=function(){if(F(this.width)||F(this.height))return 0;var t=this.width>this.height?this.width:this.height;return 2*Math.PI*t/2-4*Math.abs(this.width-this.height)},i._computeGeodesicArea=function(){return F(this.width)||F(this.height)?0:Math.PI*this.width*this.height/4},i._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:$i.toNumberArrays([this.getShell()])}},i._toJSON=function(t){var e=B({},t),i=this.getCenter();e.geometry=!1;var n=this.toGeoJSON(e);return n.geometry={type:"Polygon"},{feature:n,subType:"Ellipse",coordinates:[i.x,i.y],width:this.getWidth(),height:this.getHeight()}},e}(bo(xo));Bo.mergeOptions({numberOfShellPoints:80}),Bo.registerJSONType("Ellipse");var Fo=function(t){function e(e,i,n,r){var o;return o=t.call(this,null,r)||this,e&&o.setCoordinates(e),o._width=i,o._height=n,o}ne(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(t.coordinates,t.width,t.height,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i.getCoordinates=function(){return this._coordinates},i.setCoordinates=function(t){if(this._coordinates=t instanceof $i?t:new $i(t),!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var e=this._getProjection();return this._setPrjCoordinates(e.project(this._coordinates)),this},i.getWidth=function(){return this._width},i.setWidth=function(t){return this._width=t,this.onShapeChanged(),this},i.getHeight=function(){return this._height},i.setHeight=function(t){return this._height=t,this.onShapeChanged(),this},i.getShell=function(){var t=this._getMeasurer(),e=this._coordinates,i=this.getMap(),n=1,r=-1;if(i){var o=i.getFullExtent();o.left>o.right&&(n=-1),o.bottom>o.top&&(r=1)}var a=[];return a.push(e),a.push(t.locate(e,n*this._width,0)),a.push(t.locate(e,n*this._width,r*this._height)),a.push(t.locate(e,0,r*this._height)),a.push(e),a},i.getHoles=function(){return[]},i.animateShow=function(){return this.show()},i._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pnw&&t&&this._coordinates&&(this._pnw=t.project(this._coordinates)),this._pnw},i._setPrjCoordinates=function(t){this._pnw=t,this.onPositionChanged()},i._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this),i=this._getProjection();if(!i.isSphere())return e;for(var n=i.getSphereExtent(),r=n.sx,o=n.sy,a=this._getProjection().getCircum(),s=e[0],l=1,c=e.length;l<c;l++){var h=e[l],u=0,d=0;r*(s.x-h.x)>0&&(u=a.x*r),o*(s.y-h.y)<0&&(d=a.y*o),e[l]._add(u,d)}return e},i._updateCache=function(){this._clearCache();var t=this._getProjection();this._pnw&&t&&(this._coordinates=t.unproject(this._pnw))},i._clearProjection=function(){this._pnw=null,t.prototype._clearProjection.call(this)},i._computeCenter=function(t){return t.locate(this._coordinates,this._width/2,-this._height/2)},i._containsPoint=function(e,i){var n=this.getMap();if(n.isTransforming())return t.prototype._containsPoint.call(this,e,i);var r=F(i)?this._hitTestTolerance():i,o=n._getResolution()*r,a=this._getPrjExtent().expand(o),s=n._containerPointToPrj(e);return a.contains(s)},i._computePrjExtent=function(t){var e=this._getSouthEast(t);if(!e)return null;var i=t.projectCoords([new $i(this._coordinates.x,e.y),new $i(e.x,this._coordinates.y)]);return new un(i[0],i[1])},i._computeExtent=function(t){var e=this._getSouthEast(t);return e?new un(this._coordinates,e,this._getProjection()):null},i._getSouthEast=function(t){if(!t||!this._coordinates||F(this._width)||F(this._height))return null;var e=this.getWidth(),i=-this.getHeight();if(t.fullExtent){var n=t.fullExtent;e*=n.right>n.left?1:-1,i*=n.top>n.bottom?1:-1}return t.locate(this._coordinates,e,i)},i._computeGeodesicLength=function(){return F(this._width)||F(this._height)?0:2*(this._width+this._height)},i._computeGeodesicArea=function(){return F(this._width)||F(this._height)?0:this._width*this._height},i._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:$i.toNumberArrays([this.getShell()])}},i._toJSON=function(t){var e=B({},t),i=this.getCoordinates();e.geometry=!1;var n=this.toGeoJSON(e);return n.geometry={type:"Polygon"},{feature:n,subType:"Rectangle",coordinates:[i.x,i.y],width:this.getWidth(),height:this.getHeight()}},e}(xo);Fo.registerJSONType("Rectangle");var No=function(t){function e(e,i,n,r,o){var a;return(a=t.call(this,e,i,o)||this).startAngle=n,a.endAngle=r,a}ne(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(t.coordinates,t.radius,t.startAngle,t.endAngle,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i.getStartAngle=function(){return this.startAngle},i.setStartAngle=function(t){return this.startAngle=t,this.onShapeChanged(),this},i.getEndAngle=function(){return this.endAngle},i.setEndAngle=function(t){return this.endAngle=t,this.onShapeChanged(),this},i.getShell=function(){for(var t,e,i,n=this._getMeasurer(),r=this.getCoordinates(),o=this.options.numberOfShellPoints-2,a=this.getRadius(),s=[r.copy()],l=this.getStartAngle(),c=this.getEndAngle()-l,h=0;h<o;h++){t=(c*h/(o-1)+l)*Math.PI/180,e=a*Math.cos(t),i=a*Math.sin(t);var u=n.locate(r,e,i);s.push(u)}return s.push(r.copy()),s},i._containsPoint=function(e,i){var n=this.getMap();if(n.isTransforming())return t.prototype._containsPoint.call(this,e,i);var r=n._pointToContainerPoint(this._getCenter2DPoint()),o=F(i)?this._hitTestTolerance():i,a=this.getSize(),s=r,l=e,c=l.x-s.x,h=s.y-l.y,u=Math.atan2(h,c),d=u<0?360*(u+2*Math.PI)/(2*Math.PI):360*u/(2*Math.PI),p=this.startAngle%360,f=this.endAngle%360,m=!1;return m=p>f?!(d>f&&d<p):d>=p&&d<=f,l.distanceTo(s)<=a.width/2+o&&m},i._computeGeodesicLength=function(){return F(this._radius)?0:2*Math.PI*this._radius*Math.abs(this.startAngle-this.endAngle)/360+2*this._radius},i._computeGeodesicArea=function(){return F(this._radius)?0:Math.PI*Math.pow(this._radius,2)*Math.abs(this.startAngle-this.endAngle)/360},i._toJSON=function(t){var e=B({},t),i=this.getCenter();e.geometry=!1;var n=this.toGeoJSON(e);return n.geometry={type:"Polygon"},{feature:n,subType:"Sector",coordinates:[i.x,i.y],radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}},e}(zo);No.mergeOptions({numberOfShellPoints:60}),No.registerJSONType("Sector");var jo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i._arc=function(t,e,i){for(var n=this.options.arcDegree*Math.PI/180,r=1,o=e.length;r<o;r++){var a=fi._arcBetween(t,e[r-1],e[r],n),s=[e[r-1].x+e[r].x-a[0],e[r-1].y+e[r].y-a[1]];e[r-1].nextCtrlPoint=s,e[r].prevCtrlPoint=s,fi._stroke(t,i)}},i._quadraticCurve=function(t,e){if(e.length<=2)fi._path(t,e);else{var i,n;for(i=2,n=e.length;i<n;i+=2)t.quadraticCurveTo(e[i-1].x,e[i-1].y,e[i].x,e[i].y);if((i-=1)<n)for(;i<n;i++)t.lineTo(e[i].x,e[i].y)}},i._bezierCurve=function(t,e){if(e.length<=3)fi._path(t,e);else{var i,n;for(i=1,n=e.length;i+2<n;i+=3)t.bezierCurveTo(e[i].x,e[i].y,e[i+1].x,e[i+1].y,e[i+2].x,e[i+2].y);if(i<n)for(;i<n;i++)t.lineTo(e[i].x,e[i].y)}},i._getCurveArrowPoints=function(t,e,i,n,r,o){var a,s=e.length;for(a=o;a<s;a+=o){var l=this._getArrowShape(e[a-1],e[a],i,n,r);l&&t.push(l)}if((a-=o)<s-1)for(a+=1;a<s;a++){var c=this._getArrowShape(e[a-1],e[a],i,n,r);c&&t.push(c)}},e}(So);jo.mergeOptions({enableSimplify:!1,enableClip:!1});var Go=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"ArcCurve"}},i._paintOn=function(t,e,i){t.beginPath(),this._arc(t,e,i),fi._stroke(t,i),this._paintArrow(t,e,i)},e.fromJSON=function(t){var i=t.feature,n=new e(i.geometry.coordinates,t.options);return n.setProperties(i.properties),n},e}(jo);Go.registerJSONType("ArcCurve"),Go.mergeOptions({arcDegree:90});var Uo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(i.geometry.coordinates,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"CubicBezierCurve"}},i._paintOn=function(t,e,i){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._bezierCurve(t,e),fi._stroke(t,i),this._paintArrow(t,e,i)},i._getArrowPoints=function(t,e,i,n,r){return this._getCurveArrowPoints(t,e,i,n,r,3)},e}(jo);Uo.registerJSONType("CubicBezierCurve");var Vo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t),e.fromJSON=function(t){var i=t.feature,n=new e(i.geometry.coordinates,t.options);return n.setProperties(i.properties),n};var i=e.prototype;return i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"QuadBezierCurve"}},i._paintOn=function(t,e,i){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._quadraticCurve(t,e,i),fi._stroke(t,i),this._paintArrow(t,e,i)},i._getArrowPoints=function(t,e,i,n,r){return this._getCurveArrowPoints(t,e,i,n,r,2)},e}(jo);Vo.registerJSONType("QuadBezierCurve");var Ho={textFaceName:"monospace",textSize:12,textLineSpacing:8,textWrapCharacter:"\n",textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},Zo={markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},Wo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getContent=function(){return this._content},i.setContent=function(t){var e=this._content;return this._content=Ne(t),this._refresh(),this._fireEvent("contentchange",{old:e,new:t}),this},i.onAdd=function(){this._refresh()},i.toJSON=function(){var e=t.prototype.toJSON.call(this);return delete e.symbol,e},i.setSymbol=function(e){if(this._refreshing||!e)return t.prototype.setSymbol.call(this,e);var i=this._parseSymbol(e);if(this.setTextStyle){var n=this.getTextStyle()||{};n.symbol=i[0],this.setTextStyle(n)}else this.setTextSymbol&&this.setTextSymbol(i[0]);if(this.setBoxStyle){var r=this.getBoxStyle()||{};r.symbol=i[1],this.setBoxStyle(r)}else this.setBoxSymbol&&this.setBoxSymbol(i[1]);return this},i._parseSymbol=function(t){var e={},i={};for(var n in t)Z(t,n)&&(0===n.indexOf("text")?e[n]=t[n]:i[n]=t[n]);return[e,i]},i._getTextSize=function(t){return $e(this._content,t).size},i._getInternalSymbol=function(){return this._symbol},i._getDefaultTextSymbol=function(){return B({},Ho)},i._getDefaultBoxSymbol=function(){return B({},Zo)},i._getDefaultPadding=function(){return[12,8]},e}(Mo),qo=function(t){function e(e,i,n,r,o){var a;return void 0===o&&(o={}),(a=t.call(this,i,o)||this)._content=Ne(e),a._width=F(n)?100:n,a._height=F(r)?40:r,o.boxSymbol&&a.setBoxSymbol(o.boxSymbol),o.textStyle&&a.setTextStyle(o.textStyle),a._refresh(),a}ne(e,t);var i=e.prototype;return i.getWidth=function(){return this._width},i.setWidth=function(t){return this._width=t,this._refresh(),this},i.getHeight=function(){return this._height},i.setHeight=function(t){return this._height=t,this._refresh(),this},i.getBoxSymbol=function(){return B({},this.options.boxSymbol)},i.setBoxSymbol=function(t){return this.options.boxSymbol=t?B({},t):t,this.getSymbol()&&this._refresh(),this},i.getTextStyle=function(){return this.options.textStyle?B({},this.options.textStyle):null},i.setTextStyle=function(t){return this.options.textStyle=t?B({},t):t,this.getSymbol()&&this._refresh(),this},e.fromJSON=function(t){var i=t.feature,n=new e(t.content,i.geometry.coordinates,t.width,t.height,t.options);return n.setProperties(i.properties),n.setId(i.id),t.symbol&&n.setSymbol(t.symbol),n},i._toJSON=function(t){return{feature:this.toGeoJSON(t),width:this.getWidth(),height:this.getHeight(),subType:"TextBox",content:this._content}},i._refresh=function(){var t=this.getTextStyle()||{},e=t.padding||[12,8],i=this._width-2*e[0],n=this._height-2*e[1],r=B({},t.symbol||this._getDefaultTextSymbol(),this.options.boxSymbol||this._getDefaultBoxSymbol(),{textName:this._content,markerWidth:this._width,markerHeight:this._height,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textMaxWidth:i,textMaxHeight:n});t.wrap&&!r.textWrapWidth&&(r.textWrapWidth=i);var o=t.horizontalAlignment;r.textDx=r.markerDx||0;var a=r.markerWidth/2-e[0];"left"===o?(r.textHorizontalAlignment="right",r.textDx=r.textDx-a):"right"===o&&(r.textHorizontalAlignment="left",r.textDx=r.textDx+a);var s=t.verticalAlignment;r.textDy=r.markerDy||0;var l=r.markerHeight/2-e[1];"top"===s?(r.textVerticalAlignment="bottom",r.textDy-=l):"bottom"===s&&(r.textVerticalAlignment="top",r.textDy+=l),this._refreshing=!0,this.updateSymbol(r),delete this._refreshing},e}(Wo);qo.mergeOptions({textStyle:{wrap:!0,padding:[12,8],verticalAlignment:"middle",horizontalAlignment:"middle"},boxSymbol:null}),qo.registerJSONType("TextBox");var Xo=function(t){function e(e,i,n){var r;return void 0===n&&(n={}),r=t.call(this,i,n)||this,n.textSymbol&&r.setTextSymbol(n.textSymbol),n.boxStyle&&r.setBoxStyle(n.boxStyle),r._content=Ne(e),r._refresh(),r}ne(e,t);var i=e.prototype;return i.getBoxStyle=function(){return this.options.boxStyle?B({},this.options.boxStyle):null},i.setBoxStyle=function(t){return this.options.boxStyle=t?B({},t):t,this._refresh(),this},i.getTextSymbol=function(){return B({},this._getDefaultTextSymbol(),this.options.textSymbol)},i.setTextSymbol=function(t){return this.options.textSymbol=t?B({},t):t,this._refresh(),this},e.fromJSON=function(t){var i=t.feature,n=new e(t.content,i.geometry.coordinates,t.options);return n.setProperties(i.properties),n.setId(i.id),t.symbol&&n.setSymbol(t.symbol),n},i._canEdit=function(){return!1},i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"Label",content:this._content}},i._refresh=function(){var t=B({},this.getTextSymbol(),{textName:this._content}),e=this.getBoxStyle();if(e){B(t,e.symbol);var i=this._getBoxSize(t),n=i[1],r=e.padding||this._getDefaultPadding(),o=i[0];t.markerWidth=o.width,t.markerHeight=o.height;var a=t.textDx||0,s=t.textDy||0,l=Xe(n,t.textHorizontalAlignment,t.textVerticalAlignment)._add(a,s),c=e.horizontalAlignment||"middle";t.markerDx=l.x,"left"===c?t.markerDx+=t.markerWidth/2-r[0]:"right"===c?t.markerDx-=t.markerWidth/2-n.width-r[0]:t.markerDx+=n.width/2;var h=e.verticalAlignment||"middle";t.markerDy=l.y,"top"===h?t.markerDy+=t.markerHeight/2-r[1]:"bottom"===h?t.markerDy-=t.markerHeight/2-n.height-r[1]:t.markerDy+=n.height/2}this._refreshing=!0,this.updateSymbol(t),delete this._refreshing},i._getBoxSize=function(t){t.markerType||(t.markerType="square");var e,i,n=this.getBoxStyle(),r=this._getTextSize(t),o=n.padding||this._getDefaultPadding();return e=r.width+2*o[0],i=r.height+2*o[1],n.minWidth&&(!e||e<n.minWidth)&&(e=n.minWidth),n.minHeight&&(!i||i<n.minHeight)&&(i=n.minHeight),[new se(e,i),r]},e}(Wo);Xo.mergeOptions({boxStyle:null,textSymbol:null}),Xo.registerJSONType("Label");var Yo=function(t){return function(t){function e(){return t.apply(this,arguments)||this}ne(e,t),e._hasConnectors=function(t){return!F(t.__connectors)&&t.__connectors.length>0},e._getConnectors=function(t){return t.__connectors};var i=e.prototype;return i.getConnectSource=function(){return this._connSource},i.setConnectSource=function(t){var e=this._connTarget;return this.onRemove(),this._connSource=t,this._connTarget=e,this.onAdd(),this},i.getConnectTarget=function(){return this._connTarget},i.setConnectTarget=function(t){var e=this._connSource;return this.onRemove(),this._connSource=e,this._connTarget=t,this._updateCoordinates(),this._registerEvents(),this},i._updateCoordinates=function(){var t=this.getMap();if(!t&&this._connSource&&(t=this._connSource.getMap()),!t&&this._connTarget&&(t=this._connTarget.getMap()),t&&this._connSource&&this._connTarget){for(var e,i,n=this._connSource._getConnectPoints(),r=this._connTarget._getConnectPoints(),o=0,a=this.getCoordinates(),s=0,l=n.length;s<l;s++)for(var c=n[s],h=0,u=r.length;h<u;h++){var d=r[h],p=t.computeLength(c,d);0===s&&0===h?(e=c,i=d,o=p):p<o&&(e=c,i=d)}dt(a)&&a[0].equals(e)&&a[1].equals(i)||this.setCoordinates([e,i])}},i.onAdd=function(){this._registerEvents(),this._updateCoordinates()},i.onRemove=function(){if(this._connSource&&(this._connSource.__connectors&&rt(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(rt(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget),!(this._connSource instanceof Wr&&this._connTarget instanceof Wr)){var t=this.getMap();t&&t.off("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}},i._showConnect=function(){this._connSource&&this._connTarget&&this._connSource.isVisible()&&this._connTarget.isVisible()&&(this._updateCoordinates(),this.show())},i._registerEvents=function(){if(this._connSource&&this._connTarget){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var t=this.options.showOn;if(this.hide(),"moving"===t?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===t?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===t?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect(),!(this._connSource instanceof Wr&&this._connTarget instanceof Wr)){var e=this.getMap();e&&e.on("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}}},e}(t)},$o={showOn:"always"},Jo=function(t){function e(e,i,n){var r;return r=t.call(this,null,n)||this,1===arguments.length&&(n=e,e=null,i=null),r._connSource=e,r._connTarget=i,r}return ne(e,t),e}(Yo(So));Jo.mergeOptions($o),Jo.registerJSONType("ConnectorLine");var Ko=function(t){function e(e,i,n){var r;return r=t.call(this,null,n)||this,1===arguments.length&&(n=e,e=null,i=null),r._connSource=e,r._connTarget=i,r}return ne(e,t),e}(Yo(Go));Ko.mergeOptions($o),Ko.registerJSONType("ArcConnectorLine");var Qo=function(t){function e(e,i,n){var r;i&&!(i instanceof Wr)&&!Array.isArray(i)&&a.indexOf(i.type)<0&&(n=i,i=null),(r=t.call(this,e,n)||this)._maxZIndex=0,r._minZIndex=0,r._initCache(),i&&r.addGeometry(i);var o=r.options.style;return o&&r.setStyle(o),r}ne(e,t);var i=e.prototype;return i.getGeometryById=function(t){return F(t)||""===t?null:this._geoMap[t]?this._geoMap[t]:null},i.getGeometries=function(t,e){if(!t)return this._geoList.slice(0);for(var i,n=[],r=0,o=this._geoList.length;r<o;r++)i=this._geoList[r],(e?t.call(e,i):t(i))&&n.push(i);return n},i.getFirstGeometry=function(){return this._geoList.length?this._geoList[0]:null},i.getLastGeometry=function(){var t=this._geoList.length;return 0===t?null:this._geoList[t-1]},i.getCount=function(){return this._geoList.length},i.getExtent=function(){if(0===this.getCount())return null;var t=new un(this.getProjection());return this.forEach((function(e){t._combine(e.getExtent())})),t},i.forEach=function(t,e){for(var i=this._geoList.slice(0),n=0,r=i.length;n<r;n++)e?t.call(e,i[n],n):t(i[n],n);return this},i.filter=function(t,e){var i=[],n=V(t),r=n?t:Bt(t);return this.forEach((function(t){var o=n?t:Wt(t);(e?r.call(e,o):r(o))&&i.push(t)}),this),i},i.isEmpty=function(){return!this._geoList.length},i.addGeometry=function(t,e){if(!t)return this;if("FeatureCollection"===t.type)return this.addGeometry(Oo.toGeometry(t),e);if(!Array.isArray(t)){var i=arguments.length,n=arguments[i-1];return t=Array.prototype.slice.call(arguments,0,i-1),e=n,n&&G(n)&&("type"in n||n instanceof Wr)&&(t.push(n),e=!1),this.addGeometry(t,e)}if(0===t.length)return this;var r;this._initCache(),e&&(r=new un),this._toSort=this._maxZIndex>0;for(var o=[],a=0,s=t.length;a<s;a++){var l=t[a];if(!l)throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+a);if(!(l instanceof Wr)&&(l=Wr.fromJSON(l),Array.isArray(l)))for(var c=0,h=l.length;c<h;c++)this._add(l[c],r,a),o.push(l[c]);Array.isArray(l)||(this._add(l,r,a),o.push(l))}var u=this.getMap();if(u&&(this._getRenderer().onGeometryAdd(o),r&&!F(r.xmin))){var d=r.getCenter(),p=u.getFitZoom(r);if(G(e)){var f=V(e.step)?e.step:function(){};u.animateTo({center:d,zoom:p},B({duration:u.options.zoomAnimationDuration,easing:"out"},e),f)}else!0===e&&u.setCenterAndZoom(d,p)}return this.fire("addgeo",{geometries:t}),this},i.getGeoMinZIndex=function(){return this._minZIndex},i.getGeoMaxZIndex=function(){return this._maxZIndex},i._add=function(t,e,i){this._toSort||(this._toSort=0!==t.getZIndex()),this._updateZIndex(t.getZIndex());var n=t.getId();if(!F(n)){if(!F(this._geoMap[n]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+n+", at index:"+i);this._geoMap[n]=t}var r=tt();t._setInternalId(r),this._geoList.push(t),this.onAddGeometry(t),t._bindLayer(this),t.onAdd&&t.onAdd(),e&&e._combine(t.getExtent()),t._fireEvent("add",{layer:this}),this._cookedStyles&&this._styleGeometry(t)},i.removeGeometry=function(t){if(!Array.isArray(t))return this.removeGeometry([t]);for(var e=t.length-1;e>=0;e--)t[e]instanceof Wr||(t[e]=this.getGeometryById(t[e])),t[e]&&this===t[e].getLayer()&&t[e].remove();return this.fire("removegeo",{geometries:t}),this},i.clear=function(){this._clearing=!0,this.forEach((function(t){t.remove()})),this._geoMap={};var t=this._geoList;return this._geoList=[],this._getRenderer()&&this._getRenderer().onGeometryRemove(t),this._clearing=!1,this.fire("clear"),this},i.onRemoveGeometry=function(t){if(t&&!this._clearing&&(this===t.getLayer()&&!F(t._getInternalId()))){var e=t.getId();F(e)||delete this._geoMap[e];var i=this._findInList(t);i>=0&&this._geoList.splice(i,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([t])}},i.getStyle=function(){return this.options.style?this.options.style:null},i.setStyle=function(t){return this.options.style=t,t=ni(t),this._cookedStyles=qt(t),this.forEach((function(t){this._styleGeometry(t)}),this),this.fire("setstyle",{style:t}),this},i._styleGeometry=function(t){if(!this._cookedStyles)return!1;for(var e=Wt(t),i=0,n=this._cookedStyles.length;i<n;i++)if(!0===this._cookedStyles[i].filter(e))return t._setExternSymbol(this._cookedStyles[i].symbol),!0;return!1},i.removeStyle=function(){return this.options.style?(delete this.options.style,delete this._cookedStyles,this.forEach((function(t){t._setExternSymbol(null)}),this),this.fire("removestyle"),this):this},i.onAddGeometry=function(t){this.getStyle()&&this._styleGeometry(t)},i.hide=function(){for(var t=0,e=this._geoList.length;t<e;t++)this._geoList[t].onHide();return Xr.prototype.hide.call(this)},i._initCache=function(){this._geoList||(this._geoList=[],this._geoMap={})},i._updateZIndex=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this._maxZIndex=Math.max(this._maxZIndex,Math.max.apply(Math,e)),this._minZIndex=Math.min(this._minZIndex,Math.min.apply(Math,e))},i._sortGeometries=function(){var t=this;this._toSort&&(this._maxZIndex=0,this._minZIndex=0,this._geoList.sort((function(e,i){return t._updateZIndex(e.getZIndex(),i.getZIndex()),t._compare(e,i)})),this._toSort=!1)},i._compare=function(t,e){return t.getZIndex()===e.getZIndex()?t._getInternalId()-e._getInternalId():t.getZIndex()-e.getZIndex()},i._findInList=function(t){var e=this._geoList.length;if(0===e)return-1;this._sortGeometries();for(var i,n=0,r=e-1;n<=r;){if(i=Math.floor((n+r)/2),this._geoList[i]===t)return i;this._compare(this._geoList[i],t)>0?r=i-1:n=i+1}return-1},i._onGeometryEvent=function(t){if(t&&t.target){var e=t.type;"idchange"===e?this._onGeometryIdChange(t):"zindexchange"===e?this._onGeometryZIndexChange(t):"positionchange"===e?this._onGeometryPositionChange(t):"shapechange"===e?this._onGeometryShapeChange(t):"symbolchange"===e?this._onGeometrySymbolChange(t):"show"===e?this._onGeometryShow(t):"hide"===e?this._onGeometryHide(t):"propertieschange"===e&&this._onGeometryPropertiesChange(t)}},i._onGeometryIdChange=function(t){if(t.new!==t.old||!this._geoMap[t.old]||this._geoMap[t.old]!==t.target){if(!F(t.new)){if(this._geoMap[t.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+t.new);this._geoMap[t.new]=t.target}F(t.old)||t.new===t.old||delete this._geoMap[t.old]}},i._onGeometryZIndexChange=function(t){t.old!==t.new&&(this._updateZIndex(t.new),this._toSort=!0,this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(t))},i._onGeometryPositionChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(t)},i._onGeometryShapeChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(t)},i._onGeometrySymbolChange=function(t){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(t)},i._onGeometryShow=function(t){this._getRenderer()&&this._getRenderer().onGeometryShow(t)},i._onGeometryHide=function(t){this._getRenderer()&&this._getRenderer().onGeometryHide(t)},i._onGeometryPropertiesChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(t)},e}(Xr);Qo.mergeOptions({drawImmediate:!1});var ta=new pn,ea={debug:!1,enableSimplify:!0,geometryEvents:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:O.gecko,enableAltitude:!1,altitudeProperty:"altitude",drawAltitude:!1,sortByDistanceToCamera:!1,roundPoint:!1,altitude:0},ia=function(t){function e(e,i,n){return t.call(this,e,i,n)||this}ne(e,t);var i=e.prototype;return i.onConfig=function(e){if(t.prototype.onConfig.call(this,e),e.enableAltitude||e.drawAltitude||e.altitudeProperty){var i=this.getRenderer();i&&i.setToRedraw&&i.setToRedraw()}},i.identify=function(t,e){void 0===e&&(e={});var i=this.getRenderer();t instanceof $i||(t=new $i(t));var n=this.getMap().coordToContainerPoint(t);return e.onlyVisible&&i&&i.identifyAtPoint?i.identifyAtPoint(n,e):this._hitGeos(this._geoList,n,e)},i.identifyAtPoint=function(t,e){void 0===e&&(e={});var i=this.getRenderer();return t instanceof ae||(t=new ae(t)),e.onlyVisible&&i&&i.identifyAtPoint?i.identifyAtPoint(t,e):this._hitGeos(this._geoList,t,e)},i._hitGeos=function(t,e,i){void 0===i&&(i={});for(var n=i.filter,r=i.tolerance,o=[],a=t.length-1;a>=0;a--){var s=t[a];if(s&&s.isVisible()&&s._getPainter()&&s.options.interactive){if(!(s instanceof So&&(s._getArrowStyle()||s instanceof jo))){var l=s.getContainerExtent(ta);if(r&&(l=l._expand(r)),!l||!l.contains(e))continue}if(s._containsPoint(e,r)&&(!n||n(s))&&(o.push(s),i.count&&o.length>=i.count))break}}return o},i.getAltitude=function(){return this.options.altitude||0},i.toJSON=function(t){t||(t={});var e={type:this.getJSONType(),id:this.getId(),options:this.config()};if(F(t.geometries)||t.geometries){var i;if(t.clipExtent){var n=this.getMap(),r=n?n.getProjection():null;i=new un(t.clipExtent,r)}for(var o=[],a=this.getGeometries(),s=0,l=a.length;s<l;s++){var c=a[s],h=c.getExtent();if(h&&(!i||i.intersects(h))){var u=c.toJSON(t.geometries);o.push(u)}}e.geometries=o}return e},e.fromJSON=function(t){if(!t||"VectorLayer"!==t.type)return null;for(var i=new e(t.id,t.options),n=t.geometries,r=[],o=0;o<n.length;o++){var a=Wr.fromJSON(n[o]);a&&r.push(a)}return i.addGeometry(r),i},e.getPainterClass=function(){return Nr},e.getCollectionPainterClass=function(){return Gr},e}(Qo);ia.mergeOptions(ea),ia.registerJSONType("VectorLayer");var na="_map_tool",ra=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addTo=function(t){return t?(this._map=t,t[na]&&t[na].disable(),this.onAdd&&this.onAdd(),this.enable(),t[na]=this,this._fireEvent("add"),this):this},i.getMap=function(){return this._map},i.enable=function(){return!this._map||this._enabled||(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable")),this},i.disable=function(){return this._enabled&&this._map?(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this):this},i.isEnabled=function(){return!!this._enabled},i.remove=function(){return this._map?(this.disable(),this._map&&(delete this._map[na],delete this._map),this._fireEvent("remove"),this):this},i._registerEvents=function(){this._switchEvents("on")},i._switchEvents=function(t){var e=this.getEvents();e&&this._map[t](e,this)},i._fireEvent=function(t,e){e||(e={}),this.fire(t,e)},e}(wi(Si)),oa={},aa=function(t){function e(e){var i;return(i=t.call(this,e)||this)._checkMode(),i._events={click:i._clickHandler,"mousemove touchmove":i._mouseMoveHandler,dblclick:i._doubleClickHandler,"mousedown touchstart":i._mouseDownHandler,"mouseup touchend":i._mouseUpHandler,mousemove:i._mouseMoveHandler,mousedown:i._mouseDownHandler,mouseup:i._mouseUpHandler},i}ne(e,t),e.registerMode=function(t,e){oa[t.toLowerCase()]=e},e.getRegisterMode=function(t){return oa[t.toLowerCase()]};var i=e.prototype;return i.getMode=function(){return this.options.mode?this.options.mode.toLowerCase():null},i.setMode=function(t){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=t,this._checkMode(),this.isEnabled()&&(this._switchEvents("on"),this._restoreMapCfg(),this._saveMapCfg()),this},i.getSymbol=function(){var t=this.options.symbol;return ii(t||this.options.symbol)},i.setSymbol=function(t){return t?(this.options.symbol=t,this._geometry&&this._geometry.setSymbol(t),this):this},i.getCurrentGeometry=function(){return this._geometry},i.onAdd=function(){this._checkMode()},i.onEnable=function(){if(this._saveMapCfg(),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources(),this.options.autoPanAtEdge){var t=this.getMap();this._mapAutoPanAtEdge=t.options.autoPanAtEdge,this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!0})}return this},i.onDisable=function(){var t=this.getMap();return this._restoreMapCfg(),this.endDraw(),this._map&&(t.removeLayer(this._getDrawLayer()),this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!1}))),this},i.undo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||!this._historyPointer)return this;var i=this._clickCoords.slice(0,--this._historyPointer);return t.update(this.getMap().getProjection(),i,this._geometry),this},i.redo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||F(this._historyPointer)||this._historyPointer===this._clickCoords.length)return this;var i=this._clickCoords.slice(0,++this._historyPointer);return t.update(this.getMap().getProjection(),i,this._geometry),this},i._shouldRecordHistory=function(t){return Array.isArray(t)&&"click"===t[0]&&"mousemove"===t[1]&&"dblclick"===t[2]},i._checkMode=function(){this._getRegisterMode()},i._saveMapCfg=function(){var t=this.getMap();this._mapDoubleClickZoom=t.options.doubleClickZoom,t.config({doubleClickZoom:this.options.doubleClickZoom});for(var e=this._getRegisterMode().action,i=!1,n=0;n<e.length;n++)if(e[n].indexOf("mousedown")>=0||e[n].indexOf("touchstart")>=0){i=!0;break}if(i){var r=this.getMap();this._mapDraggable=r.options.draggable,r.config({draggable:!1})}},i._restoreMapCfg=function(){var t=this.getMap();t.config({doubleClickZoom:this._mapDoubleClickZoom}),F(this._mapDraggable)||t.config("draggable",this._mapDraggable),delete this._mapDraggable,delete this._mapDoubleClickZoom},i._loadResources=function(){var t=te(this.getSymbol());t.length>0&&this._drawToolLayer._getRenderer().loadResources(t)},i._getProjection=function(){return this._map.getProjection()},i._getRegisterMode=function(){var t=this.getMode(),i=e.getRegisterMode(t);if(!i)throw new Error(t+" is not a valid mode of DrawTool.");return i},i.getEvents=function(){var t=this._getRegisterMode().action,e={};if(Array.isArray(t)){for(var i=0;i<t.length;i++)e[t[i]]=this._events[t[i]];return e}return null},i._mouseDownHandler=function(t){this._createGeometry(t)},i._mouseUpHandler=function(t){this.endDraw(t)},i._clickHandler=function(t){var e=this._getRegisterMode();if(this._clickCoords&&this._clickCoords.length){var i=this._clickCoords.length,n=this.getMap()._pointToPrj(t.point2d);if(this._clickCoords[i-1].equals(n))return}if(this._geometry){var r=this.getMap()._pointToPrj(t.point2d);F(this._historyPointer)||(this._clickCoords=this._clickCoords.slice(0,this._historyPointer)),this._clickCoords.push(r),this._historyPointer=this._clickCoords.length,t.drawTool=this,e.update(this.getMap().getProjection(),this._clickCoords,this._geometry,t),this._clickCoords.length<=1?this._fireEvent("drawstart",t):this._fireEvent("drawvertex",t),e.clickLimit&&e.clickLimit===this._historyPointer&&this.endDraw(t)}else this._createGeometry(t)},i._createGeometry=function(t){var e=this.getMode(),i=this._getRegisterMode(),n=this.getMap()._pointToPrj(t.point2d),r=this.getSymbol();this._geometry||(this._clickCoords=[n],t.drawTool=this,this._geometry=i.create(this.getMap().getProjection(),this._clickCoords,t),r&&"point"!==e?this._geometry.setSymbol(r):this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",t)),"point"===e&&this.endDraw(t)},i._mouseMoveHandler=function(t){var e=this.getMap();if(this._geometry&&e&&!e.isInteracting()){var i=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(i)){var n=this.getMap()._pointToPrj(t.point2d),r=e.getProjection();t.drawTool=this;var o=this._getRegisterMode();if(this._shouldRecordHistory(o.action)){var a=this._clickCoords.slice(0,this._historyPointer);if(a&&a.length>0&&n.equals(a[a.length-1]))return;o.update(r,a.concat([n]),this._geometry,t)}else o.update(r,n,this._geometry,t);this._fireEvent("mousemove",t)}}},i._doubleClickHandler=function(t){if(this._geometry){var e=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(e)){var i=this._getRegisterMode(),n=this._clickCoords;if(!(n.length<2)){var r=this.getMode();if(!(r&&r.indexOf("polygon")>-1&&n.length<3)){for(var o=this.getMap().getProjection(),a=[n[0]],s=1,l=n.length;s<l;s++)n[s].x===n[s-1].x&&n[s].y===n[s-1].y||a.push(n[s]);a.length<2||this._geometry&&this._geometry instanceof xo&&a.length<3||(t.drawTool=this,i.update(o,a,this._geometry,t),this.endDraw(t))}}}}},i._addGeometryToStage=function(t){this._getDrawLayer().addGeometry(t)},i.endDraw=function(t){if(!this._geometry||this._ending)return this;this._ending=!0;var e=this._geometry;return this._clearStage(),t=t||{},this._geometry=e,this._fireEvent("drawend",t),delete this._geometry,this.options.once&&this.disable(),delete this._ending,delete this._historyPointer,this},i._clearStage=function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},i._getMouseContainerPoint=function(t){var e=this._getRegisterMode().action;return(e[0].indexOf("mousedown")>=0||e[0].indexOf("touchstart")>=0)&&xe(t.domEvent),t.containerPoint},i._isValidContainerPoint=function(t){var e=this._map.getSize(),i=e.width,n=e.height;return!(t.x<0||t.y<0)&&!(t.x>i||t.y>n)},i._getDrawLayer=function(){var t="_maptalks__internal_layer_drawtool",e=this._map.getLayer(t);return e||(e=new ia(t,{enableSimplify:!1}),this._map.addLayer(e)),e},i._fireEvent=function(t,e){e||(e={}),this._geometry&&(e.geometry=this._getRegisterMode().generate(this._geometry,{drawTool:this})),ra.prototype._fireEvent.call(this,t,e)},e}(ra);aa.mergeOptions({symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},doubleClickZoom:!1,mode:null,once:!1,autoPanAtEdge:!1,ignoreMouseleave:!0});var sa=function(t){function e(e){var i;return(i=t.call(this,e)||this).drawTool=new aa({mode:"boxZoom",ignoreMouseleave:!1}),i}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target.on("_mousedown",this._onMouseDown,this)},i.removeHooks=function(){this.target.off("_mousedown",this._onMouseDown,this),this.drawTool.isEnabled()&&this.drawTool.remove()},i._onMouseDown=function(t){this.target.options.boxZoom&&t.domEvent.shiftKey&&this.drawTool.setSymbol(this.target.options.boxZoomSymbol).on("drawend",this._boxZoom,this).addTo(this.target)},i._boxZoom=function(t){var e=this.target;this.drawTool.remove();var i=t.geometry,n=i.getCenter(),r=i.getSymbol(),o=r.markerWidth,a=r.markerHeight,s=new un(n,e.locateByPoint(n,o,a),e.getProjection()),l=e.getFitZoom(s);e._animateTo({center:s.getCenter(),zoom:l})},e}(Ti);ro.mergeOptions({boxZoom:!0,boxZoomSymbol:{markerType:"rectangle",markerLineWidth:3,markerLineColor:"#1bbc9b",markerLineDasharray:[10,5],markerFillOpacity:.1,markerFill:"#1bbc9b",markerWidth:1,markerHeight:1}}),ro.addOnLoadHook("addHandler","boxZoom",sa);var la=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target&&this.target.on("_mousemove",this._onMouseMove,this)},i.removeHooks=function(){this.target&&this.target.off("_mousemove",this._onMouseMove,this)},i._onMouseMove=function(t){var e=this.target;if(e.options.autoPanAtEdge){var i=t.containerPoint,n=e.getContainerExtent();if(n){var r,o=i.x,a=i.y,s=n.xmax,l=n.ymax;o<30&&(r=[Math.abs(o-30),0]),a<30&&(r=[0,Math.abs(a-30)]),o+30>s&&(r=[-Math.abs(o+30-s),0]),a+30>l&&(r=[0,-Math.abs(a+30-l)]),r&&e.panBy(r,{duration:1})}}},e}(Ti);function ca(t,e,i){return t*(1-i)+e*i}ro.mergeOptions({autoPanAtEdge:!1}),ro.addOnLoadHook("addHandler","autoPanAtEdge",la),ro.include({animateTo:function(t,e,i){var n=this;void 0===e&&(e={}),V(e)&&(i=e,e={});var r=this.getProjection(),o=this.getView(),a={},s=!0;for(var l in t)if(Z(t,l)&&!F(t[l])&&("prjCenter"===l||!F(o[l])))if(s=!1,"center"===l){var c=new $i(o[l]).toFixed(7),h=new $i(t[l]).toFixed(7);c.equals(h)||(a.center=[c,h])}else if("prjCenter"===l){var u=new $i(this._getPrjCenter()),d=new $i(t[l]);u.equals(d)||(a.prjCenter=[u,d])}else o[l]!==t[l]&&"around"!==l&&(a[l]=[o[l],t[l]]);if(s)return null;this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer)));var p=t.around||new ae(this.width/2,this.height/2),f=this._getRenderer(),m=this._animPlayer=go.animate(a,{easing:e.easing||"out",duration:e.duration||this.options.zoomAnimationDuration,framer:function(t){f.callInNextFrame(t)}},(function(t){if(n.isRemoved())m.finish();else{if("running"===m.playState){if(t.styles.center){var o=t.styles.center;n._setPrjCenter(r.project(o)),n.onMoving(n._parseEventFromCoord(n.getCenter()))}else if(t.styles.prjCenter){var s=t.styles.prjCenter;n._setPrjCenter(s),n.onMoving(n._parseEventFromCoord(n.getCenter()))}F(t.styles.zoom)||n.onZooming(t.styles.zoom,p),F(t.styles.pitch)||n.setPitch(t.styles.pitch),F(t.styles.bearing)||n.setBearing(t.styles.bearing),n._fireEvent("animating")}else"paused"===m.playState&&m!==n._mapAnimPlayer||(m._interupted||(a.center?n._setPrjCenter(r.project(a.center[1])):a.prjCenter&&n._setPrjCenter(a.prjCenter[1]),F(a.pitch)||n.setPitch(a.pitch[1]),F(a.bearing)||n.setBearing(a.bearing[1])),n._endAnim(m,a,p,e));i&&i(t)}}),this);return this._startAnim(a,p),m},_animateTo:function(t,e,i){return void 0===e&&(e={}),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._isInternalAnimation=!0,this._mapAnimPlayer=this.animateTo(t,e,i),delete this._isInternalAnimation,this._mapAnimPlayer},flyTo:function(t,e,i){var n=this;void 0===e&&(e={}),this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer))),V(e)&&(i=e,e={}),e=B({curve:1.42},e);var r=this;function o(t,e){return r.getResolution(e)/r.getResolution(t)}var a=t.around||new ae(this.width/2,this.height/2),s=this.getMinZoom(),l=this.getMaxZoom(),c=this.getProjection(),h=this.getView(),u=h.zoom,d=h.bearing,p=h.pitch,f="zoom"in t?ut(+t.zoom,s,l):u,m="bearing"in t?+t.bearing:d,g="pitch"in t?+t.pitch:p,y=c.project(t.center&&new $i(t.center)||this.getCenter()),_=o(f,u),v=c.project(this.getCenter()),x=y.sub(v),b=e.curve,w=Math.max(this.width,this.height),M=w/_,T=x.mag();if("minZoom"in e){var S=ut(Math.min(e.minZoom,u,f),s,l),E=w/o(S,u);b=Math.sqrt(E/T*2)}var C=b*b;function A(t){var e=(M*M-w*w+(t?-1:1)*C*C*T*T)/(2*(t?M:w)*C*T);return Math.log(Math.sqrt(e*e+1)-e)}function P(t){return(Math.exp(t)-Math.exp(-t))/2}function L(t){return(Math.exp(t)+Math.exp(-t))/2}var I=A(0),R=function(t){return L(I)/L(I+b*t)},D=function(t){return w*((L(I)*(P(e=I+b*t)/L(e))-P(I))/C)/T;var e},k=(A(1)-I)/b;if(Math.abs(T)<1e-6||!isFinite(k)){if(Math.abs(w-M)<1e-6)return this.animateTo(t,e,i);var O=M<w?-1:1;k=Math.abs(Math.log(M/w))/b,D=function(){return 0},R=function(t){return Math.exp(O*b*t)}}var z=this._getRenderer(),F=this._animPlayer=go.animate({k:[0,1]},{easing:e.easing||"out",duration:e.duration||8,framer:function(t){z.callInNextFrame(t)}},(function(r){if(n.isRemoved())F.finish();else{var o=r.styles.k,s=o*k,l=1/R(s),c={};if(t.center){var h=1===o?y:v.add(x.multi(D(s)));c.prjCenter=[y,h]}if(u!==f){var _=1===o?f:n.getZoomForScale(l,u,!0);c.zoom=[u,_]}if(p!==g){var b=ca(p,g,o);c.pitch=[g,b]}if(d!==m){var w=ca(d,m,o);c.bearing=[m,w]}if("running"===F.playState){if(c.prjCenter){var M=c.prjCenter;n._setPrjCenter(M[1]),n.onMoving(n._parseEventFromCoord(n.getCenter()))}c.zoom&&n.onZooming(c.zoom[1],a),c.pitch&&n.setPitch(c.pitch[1]),c.bearing&&n.setBearing(c.bearing[1]),n._fireEvent("animating")}else"paused"===F.playState&&F!==n._mapAnimPlayer||(F._interupted||(c.prjCenter&&n._setPrjCenter(c.prjCenter[1]),c.pitch&&n.setPitch(c.pitch[1]),c.bearing&&n.setBearing(c.bearing[1])),n._endAnim(F,c,a,e));i&&i(r)}}));return this._startAnim({center:t.center,zoom:t.zoom!==u,pitch:g!==p,bearing:m!==d},a),this},isAnimating:function(){return!!this._animPlayer},isRotating:function(){return this.isDragRotating()||!!this._animRotating},_endAnim:function(t,e,i,n){delete this._animRotating;var r,o=t._interupted?"animateinterrupted":"animateend";if(t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer,e.center)r=t._interupted?this.getCenter():e.center[1],this.onMoveEnd(this._parseEventFromCoord(r));else if(e.prjCenter){var a;a=t._interupted?this._getPrjCenter():e.prjCenter[1];var s=this._parseEventFromCoord(this.getProjection().unproject(a));s.point2d=this._prjToPoint(a),this.onMoveEnd(s)}F(e.zoom)||(t._interupted?this.onZoomEnd(this.getZoom(),i):n.wheelZoom?this.onZooming(e.zoom[1],i):this.onZoomEnd(e.zoom[1],i)),o&&this._fireEvent(o),F(e.pitch)||this.getPitch()||this.getRenderer().setToRedraw(),n.wheelZoom||this._resumePrev(t)},_startAnim:function(t,e){this._animPlayer&&(t.center&&this.onMoveStart(),t.zoom&&!this.isZooming()&&this.onZoomStart(t.zoom[1],e),(t.pitch||t.bearing)&&(this._animRotating=!0),this._fireEvent("animatestart"),this._animPlayer.play())},_stopAnim:function(t){t&&(delete this._animRotating,"finished"!==t.playState&&(t._interupted=!0,t.cancel()),t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer)},_resumePrev:function(t){if(this._prevAnimPlayer){var e=this._prevAnimPlayer;"paused"!==e.playState&&delete this._prevAnimPlayer,t!==e&&(this._animPlayer=e,e.play())}}});var ha="mousedown mouseup mouseover mouseout mouseenter mouseleave mousemove click dblclick contextmenu keypress touchstart touchmove touchend ";function ua(t,e,i,n,r){var o=1/Math.tan(e/2),a=1/(n-r);return t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(r+n)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*r*n*a,t[15]=0,t}function da(t,e,i){var n,r,o,a,s,l,c,h,u,d,p,f,m=i[0],g=i[1],y=i[2];return e===t?(t[12]=e[0]*m+e[4]*g+e[8]*y+e[12],t[13]=e[1]*m+e[5]*g+e[9]*y+e[13],t[14]=e[2]*m+e[6]*g+e[10]*y+e[14],t[15]=e[3]*m+e[7]*g+e[11]*y+e[15]):(n=e[0],r=e[1],o=e[2],a=e[3],s=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=e[9],p=e[10],f=e[11],t[0]=n,t[1]=r,t[2]=o,t[3]=a,t[4]=s,t[5]=l,t[6]=c,t[7]=h,t[8]=u,t[9]=d,t[10]=p,t[11]=f,t[12]=n*m+s*g+u*y+e[12],t[13]=r*m+l*g+d*y+e[13],t[14]=o*m+c*g+p*y+e[14],t[15]=a*m+h*g+f*y+e[15]),t}function pa(t,e,i){var n=i[0],r=i[1],o=i[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function fa(t,e,i){var n=e[0],r=e[1],o=e[2],a=e[3],s=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=e[9],p=e[10],f=e[11],m=e[12],g=e[13],y=e[14],_=e[15],v=i[0],x=i[1],b=i[2],w=i[3];return t[0]=v*n+x*s+b*u+w*m,t[1]=v*r+x*l+b*d+w*g,t[2]=v*o+x*c+b*p+w*y,t[3]=v*a+x*h+b*f+w*_,v=i[4],x=i[5],b=i[6],w=i[7],t[4]=v*n+x*s+b*u+w*m,t[5]=v*r+x*l+b*d+w*g,t[6]=v*o+x*c+b*p+w*y,t[7]=v*a+x*h+b*f+w*_,v=i[8],x=i[9],b=i[10],w=i[11],t[8]=v*n+x*s+b*u+w*m,t[9]=v*r+x*l+b*d+w*g,t[10]=v*o+x*c+b*p+w*y,t[11]=v*a+x*h+b*f+w*_,v=i[12],x=i[13],b=i[14],w=i[15],t[12]=v*n+x*s+b*u+w*m,t[13]=v*r+x*l+b*d+w*g,t[14]=v*o+x*c+b*p+w*y,t[15]=v*a+x*h+b*f+w*_,t}function ma(t,e){var i=e[0],n=e[1],r=e[2],o=e[3],a=e[4],s=e[5],l=e[6],c=e[7],h=e[8],u=e[9],d=e[10],p=e[11],f=e[12],m=e[13],g=e[14],y=e[15],_=i*s-n*a,v=i*l-r*a,x=i*c-o*a,b=n*l-r*s,w=n*c-o*s,M=r*c-o*l,T=h*m-u*f,S=h*g-d*f,E=h*y-p*f,C=u*g-d*m,A=u*y-p*m,P=d*y-p*g,L=_*P-v*A+x*C+b*E-w*S+M*T;return L?(L=1/L,t[0]=(s*P-l*A+c*C)*L,t[1]=(r*A-n*P-o*C)*L,t[2]=(m*M-g*w+y*b)*L,t[3]=(d*w-u*M-p*b)*L,t[4]=(l*E-a*P-c*S)*L,t[5]=(i*P-r*E+o*S)*L,t[6]=(g*x-f*M-y*v)*L,t[7]=(h*M-d*x+p*v)*L,t[8]=(a*A-s*E+c*T)*L,t[9]=(n*E-i*A-o*T)*L,t[10]=(f*w-m*x+y*_)*L,t[11]=(u*x-h*w-p*_)*L,t[12]=(s*S-a*C-l*T)*L,t[13]=(i*C-n*S+r*T)*L,t[14]=(m*v-f*b-g*_)*L,t[15]=(h*b-u*v+d*_)*L,t):null}function ga(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ya(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function _a(t,e,i,n){return t[0]=e,t[1]=i,t[2]=n,t}function va(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function xa(t){var e=t[0],i=t[1],n=t[2];return Math.sqrt(e*e+i*i+n*n)}function ba(t,e){var i=e[0],n=e[1],r=e[2],o=i*i+n*n+r*r;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function wa(t,e,i){var n=e[0],r=e[1],o=e[2],a=i[0],s=i[1],l=i[2];return t[0]=r*l-o*s,t[1]=o*a-n*l,t[2]=n*s-r*a,t}function Ma(t,e){var i=e[0]-t[0],n=e[1]-t[1],r=e[2]-t[2];return Math.hypot?Math.hypot(i,n,r):function(){var t=0,e=arguments.length;for(;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}(i,n,r)}function Ta(t,e,i){var n=e[0],r=e[1],o=e[2],a=1/(i[3]*n+i[7]*r+i[11]*o+i[15]);return t[0]=(i[0]*n+i[4]*r+i[8]*o+i[12])*a,t[1]=(i[1]*n+i[5]*r+i[9]*o+i[13])*a,t[2]=(i[2]*n+i[6]*r+i[10]*o+i[14])*a,t}ro.include({_registerDomEvents:function(){ge(this._panels.mapWrapper||this._containerDOM,ha,this._handleDOMEvent,this)},_removeDomEvents:function(){ye(this._panels.mapWrapper||this._containerDOM,ha,this._handleDOMEvent)},_handleDOMEvent:function(t){var e=t.type;if("contextmenu"===e&&ve(t),this._fireDOMEvent(this,t,"dom:"+t.type),!this._ignoreEvent(t)){var i,n=!1;if("mousedown"!==e&&("touchstart"!==e||t.touches&&1!==t.touches.length)){if("click"===e||"touchend"===e||"contextmenu"===e){if(!this._mouseDownTime)return;var r=this._mouseDownTime;if(delete this._mouseDownTime,z()-r>300){if("click"===e||"contextmenu"===e)return}else"touchend"===e&&(n=!0)}}else this._mouseDownTime=z();n&&(this._clickTime&&z()-this._clickTime<=300?(delete this._clickTime,i="dblclick",this._fireDOMEvent(this,t,"dom:dblclick")):(this._clickTime=z(),i="click",this._fireDOMEvent(this,t,"dom:click"))),this._ignoreEvent(t)||(this._fireDOMEvent(this,t,e),i&&this._fireDOMEvent(this,t,i))}},_ignoreEvent:function(t){if(!t||!this._panels.control)return!1;if(this._isEventOutMap(t))return!0;var e,i=t.srcElement||t.target;if(i)for(;i&&i!==this._containerDOM;){if(i.className&&i.className.indexOf&&(i.className.indexOf("maptalks-control")>=0||i.className.indexOf("maptalks-ui")>=0&&e&&!e.eventsPropagation))return!0;e=i,i=i.parentNode}return!1},_isEventOutMap:function(t){if(this.getPitch()>this.options.maxVisualPitch){var e=Te(this._getActualEvent(t),this._containerDOM);if(!this.getContainerExtent().contains(e))return!0}return!1},_parseEvent:function(t,e){if(!t)return null;var i={domEvent:t};if("keypress"!==e){var n=this._getActualEvent(t);if(n){var r=Te(n,this._containerDOM);i=B(i,{containerPoint:r,viewPoint:this.containerPointToViewPoint(r)});var o=this.options.maxVisualPitch;(this.getPitch()<=o||r.y>=this.height-this._getVisualHeight(o))&&(i=B(i,{coordinate:this.containerPointToCoord(r),point2d:this._containerPointToPoint(r)}))}}return i},_parseEventFromCoord:function(t){var e=this.coordToContainerPoint(t);return{coordinate:t,containerPoint:e,viewPoint:this.containerPointToViewPoint(e),point2d:this.coordToPoint(t)}},_getActualEvent:function(t){return t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t},_fireDOMEvent:function(t,e,i){if(!this.isRemoved()){var n=this._parseEvent(e,i);this._fireEvent(i,n)}}}),ro.addOnLoadHook("_registerDomEvents"),ro.include({isFullScreen:function(){return!!(document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||document.fullscreenElement)},requestFullScreen:function(t){return this._fireEvent("fullscreenstart"),this._requestFullScreen(t||this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(t){if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullScreen)t.webkitRequestFullScreen();else if(t.msRequestFullScreen)t.msRequestFullScreen();else{var e="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45);null!==window.open(location.href,"_blank",e)&&(window.opener=null,window.close())}},_cancelFullScreen:function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen();else{null!==window.open(location.href,"_blank","fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes")&&(window.opener=null,window.close())}}}),ro.include({panTo:function(t,e,i){if(void 0===e&&(e={}),!t)return this;if(V(e)&&(i=e,e={}),t=new $i(t),void 0===e.animation||e.animation){var n=this.getProjection().project(t);return this._panAnimation(n,e.duration,i)}return this.setCenter(t),this},_panTo:function(t,e){return void 0===e&&(e={}),void 0===e.animation||e.animation?this._panAnimation(t,e.duration):(this.onMoveStart(),this._setPrjCenter(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this)},panBy:function(t,e,i){if(void 0===e&&(e={}),!t)return this;if(V(e)&&(i=e,e={}),t=new ae(t),this.getContainerExtent().ymin>0&&t.y>30){var n=t.y;t.y=30,t.x=30*t.x/n,console.warn("offset is limited to panBy when pitch is above maxPitch")}if(this.onMoveStart(),void 0===e.animation||e.animation){t=t.multi(-1);var r=this._containerPointToPrj(new ae(this.width/2+t.x,this.height/2+t.y));this._panAnimation(r,e.duration,i)}else this._offsetCenterByPixel(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter()));return this},_panAnimation:function(t,e,i){return this._animateTo({prjCenter:t},{duration:e||this.options.panAnimationDuration},i)}}),Wr.fromJSON=function(t){if(Array.isArray(t)){for(var e=[],i=0,n=t.length;i<n;i++){var r=Wr.fromJSON(t[i]);Array.isArray(t)?e=e.concat(r):e.push(r)}return e}return t&&!t.feature?Oo.toGeometry(t):(t.subType?(o=Wr.getJSONClass(t.subType).fromJSON(t),F(t.feature.id)||o.setId(t.feature.id)):(o=Oo.toGeometry(t.feature),t.options&&o.config(t.options)),t.symbol&&o.setSymbol(t.symbol),t.infoWindow&&o.setInfoWindow(t.infoWindow),o);var o},Xr.fromJSON=function(t){if(!t)return null;var e=t.type,i=Xr.getJSONClass(e);if(!i||!i.fromJSON)throw new Error("unsupported layer type:"+e);return i.fromJSON(t)},ro.include({JSON_VERSION:"1.0",toJSON:function(t){t||(t={});var e={jsonVersion:this.JSON_VERSION,version:this.VERSION,extent:this.getExtent().toJSON()};e.options=this.config(),e.options.center=this.getCenter(),e.options.zoom=this.getZoom(),e.options.bearing=this.getBearing(),e.options.pitch=this.getPitch();var i=this.getBaseLayer();(F(t.baseLayer)||t.baseLayer)&&i&&(e.baseLayer=i.toJSON(t.baseLayer));var n={};t.clipExtent&&(!0===t.clipExtent?n.clipExtent=this.getExtent():n.clipExtent=t.clipExtent);var r=[];if(F(t.layers)||t.layers&&!Array.isArray(t.layers)){for(var o=this.getLayers(),a=0,s=o.length;a<s;a++)if(o[a].toJSON){var l=B({},G(t.layers)?t.layers:{},n);r.push(o[a].toJSON(l))}e.layers=r}else if(dt(t.layers)){for(var c=t.layers,h=0;h<c.length;h++){var u=c[h],d=this.getLayer(u.id);if(d.toJSON){var p=B({},u.options,n);r.push(d.toJSON(p))}}e.layers=r}else e.layers=[];return e}}),ro.fromJSON=function(t,e,i){if(!t||!e)return null;i||(i={});var n=new ro(t,e.options);if(F(i.baseLayer)||i.baseLayer){var r=Xr.fromJSON(e.baseLayer);r&&n.setBaseLayer(r)}if(F(i.layers)||i.layers){for(var o=[],a=e.layers,s=0;s<a.length;s++){var l=Xr.fromJSON(a[s]);o.push(l)}n.addLayer(o)}return n},ro.include({computeLength:function(t,e){if(!this.getProjection())return null;var i=new $i(t),n=new $i(e);return i.equals(n)?0:this.getProjection().measureLength(i,n)},computeGeometryLength:function(t){return t._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(t){return t._computeGeodesicArea(this.getProjection())},identify:function(t,e){var i=new $i((t=t||{}).coordinate);return this._identify(t,e,(function(e){return e.identify(i,t)}))},identifyAtPoint:function(t,e){var i=new ae((t=t||{}).containerPoint),n=this.containerPointToCoord(i);return this._identify(t,e,(function(e){return e.identifyAtPoint?e.identifyAtPoint(i,t):n?e.identify(n,t):[]}))},_identify:function(t,e,i){var n=t.layers;if(!dt(n))return this;for(var r=[],o=0,a=n.length;o<a;o++)U(n[o])?r.push(this.getLayer(n[o])):r.push(n[o]);for(var s=[],l=r.length-1;l>=0&&!(t.count&&s.length>=t.count);l--){var c=r[l];if(c&&c.getMap()&&(t.includeInvisible||c.isVisible())&&(t.includeInternals||!(c.getId().indexOf("_maptalks__internal_layer_")>=0))){var h=i(c);h&&(Array.isArray(h)?nt(s,h):s.push(h))}}return e.call(this,s),this}}),ro.include({_zoom:function(t,e){this.options.zoomable&&!this.isZooming()&&(e=this._checkZoomOrigin(e),t=this._checkZoom(t),this.onZoomStart(t,e),this._frameZoom=this.getZoom(),this.onZoomEnd(t,e))},_zoomAnimation:function(t,e,i){this.options.zoomable&&!this.isZooming()&&(t=this._checkZoom(t),this.getZoom()!==t&&(e=this._checkZoomOrigin(e),this._startZoomAnim(t,e,i)))},_checkZoomOrigin:function(t){return t&&!this.options.zoomInCenter||(t=new ae(this.width/2,this.height/2)),this.options.zoomOrigin&&(t=new ae(this.options.zoomOrigin)),t},_startZoomAnim:function(t,e,i){F(i)&&(i=1);var n=this._getResolution(this._startZoomVal)/this._getResolution(t),r=this.options.zoomAnimationDuration*Math.abs(n-i)/Math.abs(n-1);this._frameZoom=this._startZoomVal,this._animateTo({zoom:t,around:e},{continueOnViewChanged:!0,duration:r})},onZoomStart:function(t,e){this.options.zoomable&&!this.isZooming()&&(this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._zooming=!0,this._startZoomVal=this.getZoom(),this._startZoomCoord=this._containerPointToPrj(e),this._fireEvent("zoomstart",{from:this._startZoomVal,to:t}))},onZooming:function(t,e,i){if(this.options.zoomable&&this._frameZoom!==t){F(i)&&(i=1),this._zoomTo(t,e);var n=this.getResolution(t),r=this.getResolution(this._startZoomVal)/n/i,o=this._prjToContainerPoint(this._startZoomCoord,this._startZoomVal),a=this.getViewPoint();if(!this.isRotating()&&!o.equals(e)&&1!==r){var s=this.getPitch(),l=o._sub(e)._multi(1/(1-r));s&&(l.y/=Math.cos(s*Math.PI/180)),e=e.add(l)}var c={view:[r,0,0,r,(e.x-a.x)*(1-r),(e.y-a.y)*(1-r)]},h=this.getDevicePixelRatio();1!==h&&(e=e.multi(h)),c.container=[r,0,0,r,e.x*(1-r),e.y*(1-r)],this._fireEvent("zooming",{from:this._startZoomVal,to:t,origin:e,matrix:c}),this._frameZoom=t}},onZoomEnd:function(t,e){if(this.options.zoomable){var i=this._startZoomVal;this._zoomTo(t,e),this._zooming=!1,this._getRenderer().onZoomEnd(),this._fireEvent("zoomend",{from:i,to:t}),this._verifyExtent(this._getPrjCenter())||this._panTo(this._prjMaxExtent.getCenter())}},_zoomTo:function(t,e){this._zoomLevel=t,this._calcMatrices(),e&&this._setPrjCoordAtContainerPoint(this._startZoomCoord,e)},_checkZoom:function(t){var e=this.getMaxZoom(),i=this.getMinZoom();return t<i&&(t=i),t>e&&(t=e),t}});var Sa,Ea,Ca,Aa,Pa,La,Ia,Ra,Da,ka=Math.PI/180,Oa=new $i(0,0);function za(){return ga(new Array(16))}ro.include({getFov:function(){return this._fov||(this._fov=.6435011087932844),this._fov/ka},setFov:function(t){if(this.isZooming())return this;if(t=Math.max(.01,Math.min(60,t)),this._fov===t)return this;var e=this.getFov();return this._fov=t*ka,this._calcMatrices(),this._renderLayers(),this._fireEvent("fovchange",{from:e,to:this.getFov()}),this},getBearing:function(){return this._angle?-this._angle/ka:0},setBearing:function(t){if(O.ie9)throw new Error("map can't rotate in IE9.");var e=-ht(t,-180,180)*ka;if(this._angle===e)return this;var i=this.getBearing();return this._fireEvent("rotatestart",{from:i,to:e}),this._angle=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("rotate",{from:i,to:e}),this._fireEvent("rotateend",{from:i,to:e}),this},getPitch:function(){return this._pitch?this._pitch/Math.PI*180:0},setPitch:function(t){if(O.ie9)throw new Error("map can't tilt in IE9.");var e=ut(t,0,this.options.maxPitch)*ka;if(this._pitch===e)return this;var i=this.getPitch();return this._fireEvent("pitchstart",{from:i,to:e}),this._pitch=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("pitch",{from:i,to:e}),this._fireEvent("pitchend",{from:i,to:e}),this},isTransforming:function(){return!(!this._pitch&&!this._angle)},getFrustumAltitude:function(){return this._frustumAltitude},_calcFrustumAltitude:function(){var t=90-this.getPitch(),e=this.getFov()/2,i=this.cameraPosition?this.cameraPosition[2]:0;if(e<=t)return i;e=Math.PI*e/180;var n=new ae(this.cameraPosition).distanceTo(new ae(this.cameraLookAt)),r=i*Math.tan(2*e);return i+Math.tan(e)*(n+r)},_pointToContainerPoint:function(t,e,i,n){void 0===i&&(i=0),n||(n=new ae(0,0)),t=this._pointToPoint(t,e,n);var r,o=this.isTransforming(),a=this._getResolution(e)/this._getResolution();return o||i||(r=this._prjToPoint(this._getPrjCenter(),void 0,Oa)),this._toContainerPoint(n,o,a,i,r),n},_pointsToContainerPoints:function(t,e,i){void 0===i&&(i=[]);for(var n=Array.isArray(i),r=this.isTransforming(),o=this._getResolution(e)/this._getResolution(),a=this._prjToPoint(this._getPrjCenter(),void 0,Oa),s=[],l=0,c=t.length;l<c;l++){var h=t[l].copy()._multi(o),u=n?i[l]||0:i;this._toContainerPoint(h,r,o,u,a),s.push(h)}return s},_toContainerPoint:(Da=[0,0,0],function(t,e,i,n,r){var o=this.width/2,a=this.height/2;if(e||n){n*=i;var s=this._glScale;_a(Da,t.x*s,t.y*s,n*s);var l=this._projIfBehindCamera(Da,this.cameraPosition,this.cameraForward);Ta(l,l,this.projViewMatrix),t.x=l[0]*o+o,t.y=-l[1]*a+a}else t._sub(r.x,r.y),t.set(t.x,-t.y),t._add(o,a)}),_projIfBehindCamera:(La=new Array(3),Ia=new Array(3),Ra=new Array(3),function(t,e,i){va(La,t,e);var n=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(i,La);return n<=0&&(function(t,e,i){t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}(Ia,i,1.01*n),function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]}(t,e,va(Ra,La,Ia))),t}),_containerPointToPoint:(Ca=[0,0,0],Aa=[0,0,0,1],Pa=[0,0,0,1],function(t,e,i){if(this.isTransforming()){var n=this.width/2||1,r=this.height/2||1;_a(Ca,(t.x-n)/n,(r-t.y)/r,0),_a(Aa,Ca[0],Ca[1],0),_a(Pa,Ca[0],Ca[1],1),Aa[3]=Pa[3]=1,Ta(Aa,Aa,this.projViewMatrixInverse),Ta(Pa,Pa,this.projViewMatrixInverse);var o=Aa[0],a=Pa[0],s=Aa[1],l=Pa[1],c=Aa[2],h=Pa[2],u=c===h?0:(0-c)/(h-c),d=ct(o,a,u),p=ct(s,l,u);return i?(i.x=d,i.y=p):i=new ae(d,p),i._multi(1/this._glScale),void 0===e||this.getZoom()===e?i:this._pointToPointAtZoom(i,e,i)}var f=this._prjToPoint(this._getPrjCenter(),e,i),m=void 0!==e?this._getResolution()/this._getResolution(e):1,g=m*(t.x-this.width/2),y=m*(t.y-this.height/2);return f._add(g,-y)}),_calcMatrices:(Ea=za(),function(){delete this._mapRes,delete this._mapGlRes,delete this._mapExtent2D,delete this._mapGlExtent2D;var t=this.getSize(),e=t.width||1,i=t.height||1;this._glScale=this.getGLScale();var n=this._getCameraWorldMatrix(),r=this.getFov()*Math.PI/180,o=this._getCameraFar(r,this.getPitch());this.cameraFar=o,this.cameraNear=Math.max(this.cameraCenterDistance/10,.1);var a=this.projMatrix||za();ua(a,r,e/i,this.cameraNear,o),this.projMatrix=a,this.viewMatrix=ma(this.viewMatrix||za(),n),this.projViewMatrix=fa(this.projViewMatrix||za(),a,this.viewMatrix),this._calcCascadeMatrixes(),this.projViewMatrixInverse=fa(this.projViewMatrixInverse||za(),n,ma(Ea,a)),this.domCssMatrix=this._calcDomMatrix(),this._frustumAltitude=this._calcFrustumAltitude(),this._mapRes=this._getResolution(),this._mapGlRes=this._getResolution(this.getGLZoom()),this._mapExtent2D=this._get2DExtent(),this._mapGlExtent2D=this._get2DExtent(this.getGLZoom())}),_getCameraFar:function(t,e){var i=this.cameraCenterDistance=Ma(this.cameraPosition,this.cameraLookAt),n=i,r=4*i;if(e>0&&(e=e*Math.PI/180,2/Math.PI-e>t/2)){var o=Math.tan(t/2),a=Math.tan(e);r=Math.max(i*o/(1/a-o),r)}return(n+=r)+1},_calcCascadeMatrixes:function(){var t=za();function e(e,i,n){var r=this.width,o=this.height,a=this.getFov()*Math.PI/180,s=this._getCameraFar(a,i),l=this.cameraCenterDistance;s=l+(s-l)/Math.cos((90-i)*Math.PI/180)*Math.cos((90-e)*Math.PI/180),ua(t,a,r/o,.1,s);var c=this.viewMatrix;return fa(n,t,c)}return function(){var t=this.getPitch(),i=this.options.cascadePitches[0],n=this.options.cascadePitches[1],r=this.cascadeFrustumMatrix0=this.cascadeFrustumMatrix0||za(),o=this.cascadeFrustumMatrix1=this.cascadeFrustumMatrix1||za();t>i?e.call(this,t,i,r):ya(this.cascadeFrustumMatrix0,this.projViewMatrix),t>n?e.call(this,t,n,o):ya(this.cascadeFrustumMatrix1,this.cascadeFrustumMatrix0)}}(),_calcDomMatrix:function(){var t=za(),e=za(),i=[1,-1,1],n=[0,0,0];return function(){var r=this.width||1,o=this.height||1,a=.5/Math.tan(this._fov/2)*o;return pa(t,this.projMatrix,i),da(t,t,_a(n,0,0,-a)),this._pitch&&function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e[4],a=e[5],s=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*r+c*n,t[5]=a*r+h*n,t[6]=s*r+u*n,t[7]=l*r+d*n,t[8]=c*r-o*n,t[9]=h*r-a*n,t[10]=u*r-s*n,t[11]=d*r-l*n}(t,t,this._pitch),this._angle&&function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e[0],a=e[1],s=e[2],l=e[3],c=e[4],h=e[5],u=e[6],d=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*r+c*n,t[1]=a*r+h*n,t[2]=s*r+u*n,t[3]=l*r+d*n,t[4]=c*r-o*n,t[5]=h*r-a*n,t[6]=u*r-s*n,t[7]=d*r-l*n}(t,t,this._angle),ga(e),pa(e,e,_a(n,r/2,-o/2,1)),fa(this.domCssMatrix||za(),e,t)}}(),_getFovZ:function(t){var e=this.getGLScale(t),i=this._getFovRatio();return e*(this.height||1)/2/i},_getCameraWorldMatrix:(Sa={},function(){var t=this.getGLZoom(),e=this._prjToPoint(this._prjCenter,t);this.cameraLookAt=_a(this.cameraLookAt||[0,0,0],e.x,e.y,0);var i=this.getPitch()*ka,n=this.getBearing()*ka,r=this._getFovZ(),o=r*Math.cos(i),a=Math.sin(i)*r,s=e.x-a*Math.sin(n),l=e.y-a*Math.cos(n);this.cameraPosition=_a(this.cameraPosition||[0,0,0],s,l,o),this.cameraToCenterDistance=Ma(this.cameraPosition,this.cameraLookAt);var c=a||1,h=this.cameraUp=_a(this.cameraUp||[0,0,0],Math.sin(n)*c,Math.cos(n)*c,0),u=this.cameraWorldMatrix=this.cameraWorldMatrix||za();!function(t,e,i,n){var r=[0,0,0],o=[0,0,0],a=[0,0,0];va(a,e,i),0===xa(a)&&(a[2]=1),ba(a,a),wa(r,n,a),0===xa(a)&&(1===Math.abs(n[2])?a[0]+=1e-4:a[2]+=1e-4,ba(a,a),wa(r,n,a)),ba(r,r),wa(o,a,r),t[0]=r[0],t[4]=o[0],t[8]=a[0],t[1]=r[1],t[5]=o[1],t[9]=a[1],t[2]=r[2],t[6]=o[2],t[10]=a[2]}(u,this.cameraPosition,this.cameraLookAt,h);var d,p,f,m=this.cameraForward||[0,0,0];return va(m,this.cameraLookAt,this.cameraPosition),this.cameraForward=ba(m,m),function(t,e){var i,n=e[0],r=e[4],o=e[8],a=e[1],s=e[5],l=e[9],c=e[2],h=e[6],u=e[10],d=n+s+u;d>0?(i=.5/Math.sqrt(d+1),t.w=.25/i,t.x=(h-l)*i,t.y=(o-c)*i,t.z=(a-r)*i):n>s&&n>u?(i=2*Math.sqrt(1+n-s-u),t.w=(h-l)/i,t.x=.25*i,t.y=(r+a)/i,t.z=(o+c)/i):s>u?(i=2*Math.sqrt(1+s-n-u),t.w=(o-c)/i,t.x=(r+a)/i,t.y=.25*i,t.z=(l+h)/i):(i=2*Math.sqrt(1+u-n-s),t.w=(a-r)/i,t.x=(o+c)/i,t.y=(l+h)/i,t.z=.25*i)}(Sa,u),function(t,e){var i=t,n=e.x,r=e.y,o=e.z,a=e.w,s=n+n,l=r+r,c=o+o,h=n*s,u=n*l,d=n*c,p=r*l,f=r*c,m=o*c,g=a*s,y=a*l,_=a*c;i[0]=1-(p+m),i[4]=u-_,i[8]=d+y,i[1]=u+_,i[5]=1-(h+m),i[9]=f-g,i[2]=d-y,i[6]=f+g,i[10]=1-(h+p),i[3]=0,i[7]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1}(u,Sa),d=u,p=this.cameraPosition,(f=d)[12]=p[0],f[13]=p[1],f[14]=p[2],u}),_getFovRatio:function(){var t=this.getFov();return Math.tan(t/2*ka)},_renderLayers:function(){this.isInteracting()||this._getLayers().forEach((function(t){if(t){var e=t._getRenderer();e&&e.setToRedraw&&e.setToRedraw()}}))}}),ro.include({_onViewChange:function(t){this._viewHistory||(this._viewHistory=[],this._viewHistoryPointer=0);for(var e=this._getCurrentView(),i=this._viewHistory.length-1;i>=0;i--)if(wt(t,this._viewHistory[i]))return this._viewHistoryPointer=i,void this._fireViewChange(e,t);this._viewHistoryPointer<this._viewHistory.length-1&&this._viewHistory.splice(this._viewHistoryPointer+1),this._viewHistory.push(t);var n=this.options.viewHistoryCount;n>0&&this._viewHistory.length>n&&this._viewHistory.splice(0,this._viewHistory.length-n),this._viewHistoryPointer=this._viewHistory.length-1,this._fireViewChange(e,t)},zoomToPreviousView:function(t){if(void 0===t&&(t={}),!this.hasPreviousView())return null;var e=this._viewHistory[--this._viewHistoryPointer];return this._zoomToView(e,t),e},hasPreviousView:function(){return!(!this._viewHistory||0===this._viewHistoryPointer)},zoomToNextView:function(t){if(void 0===t&&(t={}),!this.hasNextView())return null;var e=this._viewHistory[++this._viewHistoryPointer];return this._zoomToView(e,t),e},hasNextView:function(){return!(!this._viewHistory||this._viewHistoryPointer===this._viewHistory.length-1)},_zoomToView:function(t,e){var i=this,n=this.getView();e.animation?this._animateTo(t,{duration:e.duration},(function(e){"finished"===e.state.playState&&i._fireViewChange(n,t)})):(this.setView(t),this._fireViewChange(n,t))},getViewHistory:function(){return this._viewHistory},_fireViewChange:function(t,e){this._fireEvent("viewchange",{old:t,new:e})},_getCurrentView:function(){return this._viewHistory?this._viewHistory[this._viewHistoryPointer]:null}}),ro.mergeOptions({viewHistory:!0,viewHistoryCount:10}),ro.include({getCollisionIndex:function(){return this._collisionIndex||this.createCollisionIndex(),this._collisionIndex||this.createCollisionIndex()},createCollisionIndex:function(){return this.clearCollisionIndex(),this._collisionIndex=new Zi,this._collisionIndex},clearCollisionIndex:function(){return this.collisionFrameTime=0,this._collisionIndex&&this._collisionIndex.clear(),this}});var Ba=function(t){function e(e){var i;return(i=t.call(this,e)||this).on("enable",i._afterEnable,re(re(i))).on("disable",i._afterDisable,re(re(i))),i._measureLayers=[],i}ne(e,t);var i=e.prototype;return i.clear=function(){if(dt(this._measureLayers))for(var t=0;t<this._measureLayers.length;t++)this._measureLayers[t].remove();return delete this._lastMeasure,delete this._lastVertex,this._measureLayers=[],this},i.getMeasureLayers=function(){return this._measureLayers},i.getLastMeasure=function(){return this._lastMeasure?this._lastMeasure:0},i.undo=function(){t.prototype.undo.call(this);var e=this._historyPointer;if(e!==this._vertexes.length)for(var i=e;i<this._vertexes.length;i++)this._vertexes[i].label&&this._vertexes[i].label.remove(),this._vertexes[i].marker.remove();return this},i.redo=function(){t.prototype.redo.call(this);var e=this._historyPointer-1;return this._vertexes[e]&&(this._vertexes[e].marker.getLayer()||(this._vertexes[e].label&&this._vertexes[e].label.addTo(this._measureMarkerLayer),this._vertexes[e].marker.addTo(this._measureMarkerLayer))),this},i._measure=function(t){var e,i,n=this.getMap();t instanceof Wr?e=n.computeGeometryLength(t):Array.isArray(t)&&(e=n.getProjection().measureLength(t)),this._lastMeasure=e,i="zh-CN"===this.options.language?[" 米"," 公里"," 英尺"," 英里"]:[" m"," km"," feet"," mile"];var r="";return this.options.metric&&(r+=e<1e3?e.toFixed(0)+i[0]:(e/1e3).toFixed(2)+i[1]),this.options.imperial&&(e*=3.2808399,r.length>0&&(r+="\n"),r+=e<5280?e.toFixed(0)+i[2]:(e/5280).toFixed(2)+i[3]),r},i._registerMeasureEvents=function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},i._afterEnable=function(){this._registerMeasureEvents()},i._afterDisable=function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},i._msOnDrawStart=function(t){var e=this.getMap(),i=e._pointToPrj(t.point2d),n=tt(),r="distancetool_"+n,o="distancetool_markers_"+n;e.getLayer(r)?(this._measureLineLayer=e.getLayer(r),this._measureMarkerLayer=e.getLayer(o)):(this._measureLineLayer=new ia(r).addTo(e),this._measureMarkerLayer=new ia(o).addTo(e)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer);var a=new Mo(t.coordinate,{symbol:this.options.vertexSymbol});a._setPrjCoordinates(i);var s="zh-CN"===this.options.language?"起点":"start",l=new Xo(s,t.coordinate,this.options.labelOptions);l._setPrjCoordinates(i),this._lastVertex=l,this._addVertexMarker(a,l)},i._msOnMouseMove=function(t){var e=this._measure(this._msGetCoordsToMeasure(t));if(!this._tailMarker){var i=ii(this.options.vertexSymbol);i.markerWidth/=2,i.markerHeight/=2,this._tailMarker=new Mo(t.coordinate,{symbol:i}).addTo(this._measureMarkerLayer),this._tailLabel=new Xo(e,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}var n=this._geometry._getPrjCoordinates(),r=n[n.length-1];this._tailMarker.setCoordinates(t.coordinate),this._tailMarker._setPrjCoordinates(r),this._tailLabel.setContent(e),this._tailLabel.setCoordinates(t.coordinate),this._tailLabel._setPrjCoordinates(r)},i._msGetCoordsToMeasure=function(t){return t.geometry.getCoordinates().concat([t.coordinate])},i._msOnDrawVertex=function(t){var e=this._geometry._getPrjCoordinates(),i=e[e.length-1],n=t.geometry,r=new Mo(t.coordinate,{symbol:this.options.vertexSymbol}),o=this._measure(n),a=new Xo(o,t.coordinate,this.options.labelOptions);this._addVertexMarker(r,a),a._setPrjCoordinates(i),r._setPrjCoordinates(i),this._lastVertex=a},i._addVertexMarker=function(t,e){this._vertexes||(this._vertexes=[]),void 0!==this._historyPointer&&this._vertexes.length>this._historyPointer-1&&(this._vertexes.length=this._historyPointer-1),this._vertexes.push({label:e,marker:t}),this._measureMarkerLayer.addGeometry(t),e&&this._measureMarkerLayer.addGeometry(e)},i._msOnDrawEnd=function(t){if(this._clearTailMarker(),t.geometry._getPrjCoordinates().length<2)return this._lastMeasure=0,void this._clearMeasureLayers();var e=this._lastVertex.getSize();e||(e=new se(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),this._lastVertex._getPrjCoordinates(),e.width);var i=t.geometry.copy();i._setPrjCoordinates(t.geometry._getPrjCoordinates()),i.addTo(this._measureLineLayer),this._lastMeasure=i.getLength()},i._addClearMarker=function(t,e,i){var n=this.options.clearButtonSymbol,r={markerDx:(n.markerDx||0)+i,textDx:(n.textDx||0)+i};Array.isArray(n)&&(r=n.map((function(t){return t?{markerDx:(t.markerDx||0)+i,textDx:(t.textDx||0)+i}:null}))),n=ii(n,r);var o=new Mo(t,{symbol:n}),a=this._measureLineLayer,s=this._measureMarkerLayer;o.on("click",(function(){return a.remove(),s.remove(),!1}),this),o.addTo(this._measureMarkerLayer),o._setPrjCoordinates(e)},i._clearTailMarker=function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)},i._clearMeasureLayers=function(){this._measureLineLayer.remove(),this._measureMarkerLayer.remove()},e}(aa);Ba.mergeOptions({mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:11,markerHeight:11},labelOptions:{textSymbol:{textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",textDx:15},boxStyle:{padding:[6,2],symbol:{markerType:"square",markerFill:"#fff",markerFillOpacity:.9,markerLineColor:"#b4b3b3"}}},clearButtonSymbol:[{markerType:"square",markerFill:"#fff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20}]});(function(t){function e(e){var i;return(i=t.call(this,e)||this).on("enable",i._afterEnable,re(re(i))).on("disable",i._afterDisable,re(re(i))),i._measureLayers=[],i}ne(e,t);var i=e.prototype;return i._measure=function(t){var e,i,n=this.getMap();t instanceof Wr?e=n.computeGeometryArea(t):Array.isArray(t)&&(e=n.getProjection().measureArea(t)),this._lastMeasure=e,i="zh-CN"===this.options.language?[" 平方米"," 平方公里"," 平方英尺"," 平方英里"]:[" sq.m"," sq.km"," sq.ft"," sq.mi"];var r="";if(this.options.metric&&(r+=e<1e6?e.toFixed(0)+i[0]:(e/1e6).toFixed(2)+i[1]),this.options.imperial){e*=3.2808399,r.length>0&&(r+="\n");r+=e<27878400?e.toFixed(0)+i[2]:(e/27878400).toFixed(2)+i[3]}return r},i._msGetCoordsToMeasure=function(t){return t.geometry.getShell().concat([t.coordinate])},i._msOnDrawVertex=function(t){var e=this.getMap()._pointToPrj(t.point2d),i=new Mo(t.coordinate,{symbol:this.options.vertexSymbol});i._setPrjCoordinates(e),this._measure(t.geometry),this._lastVertex=i,this._addVertexMarker(i)},i._msOnDrawEnd=function(t){var e;if(this._clearTailMarker(),t.point2d)e=this.getMap()._pointToPrj(t.point2d);else{var i=t.geometry._getPrjCoordinates();i=i.slice(0,i.length-1),t.geometry._setPrjCoordinates(i),e=i[i.length-1]}if(t.geometry._getPrjCoordinates().length<3)return this._lastMeasure=0,void this._clearMeasureLayers();var n=this._measure(t.geometry),r=this.getMap().getProjection().unproject(e),o=new Xo(n,r,this.options.labelOptions).addTo(this._measureMarkerLayer);o._setPrjCoordinates(e);var a=o.getSize();a||(a=new se(10,10)),this._addClearMarker(r,e,a.width);var s=t.geometry.copy();s._setPrjCoordinates(t.geometry._getPrjCoordinates()),s.addTo(this._measureLineLayer),this._lastMeasure=s.getArea()},e})(Ba).mergeOptions({mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5}});var Fa={create:function(t,e){var i=t.unproject(e[0]),n=new zo(i,0);return n._setPrjCoordinates(e[0]),n},update:function(t,e,i){var n=i.getMap(),r=Array.isArray(e)?e[e.length-1]:e,o=t.unproject(r),a=n.computeLength(i.getCenter(),o);i.setRadius(a)},generate:function(t){return t}};aa.registerMode("circle",B({clickLimit:2,action:["click","mousemove","click"]},Fa)),aa.registerMode("freeHandCircle",B({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Fa));var Na={create:function(t,e){var i=t.unproject(e[0]),n=new Bo(i,0,0);return n._setPrjCoordinates(e[0]),n},update:function(t,e,i){var n=i.getMap(),r=i.getCenter(),o=Array.isArray(e)?e[e.length-1]:e,a=t.unproject(o),s=n.computeLength(r,new $i({x:a.x,y:r.y})),l=n.computeLength(r,new $i({x:r.x,y:a.y}));i.setWidth(2*s),i.setHeight(2*l)},generate:function(t){return t}};aa.registerMode("ellipse",B({clickLimit:2,action:["click","mousemove","click"]},Na)),aa.registerMode("freeHandEllipse",B({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Na));var ja={create:function(t,e){var i=new xo([]);return i._firstClick=e[0],i},update:function(t,e,i,n){var r=i.getMap(),o=n.containerPoint,a=r._prjToContainerPoint(i._firstClick),s=[[a.x,a.y],[o.x,a.y],[o.x,o.y],[a.x,o.y]];i.setCoordinates(s.map((function(t){return r.containerPointToCoord(new ae(t))}))),i._setPrjCoordinates(s.map((function(t){return r._containerPointToPrj(new ae(t))})))},generate:function(t){return t}};aa.registerMode("rectangle",B({clickLimit:2,action:["click","mousemove","click"]},ja)),aa.registerMode("freeHandRectangle",B({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},ja)),aa.registerMode("point",{clickLimit:1,action:["click"],create:function(t,e){var i=t.unproject(e[0]),n=new Mo(i);return n._setPrjCoordinates(e[0]),n},generate:function(t){return t}});var Ga={create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new So(i);return n._setPrjCoordinates(e),n},update:function(t,e,i){var n,r=i.getSymbol();Array.isArray(e)?n=e:(n=i._getPrjCoordinates()).push(e);var o=n.map((function(e){return t.unproject(e)}));i.setCoordinates(o),i._setPrjCoordinates(n);var a=i.getLayer();if(a){var s=a.getGeometryById("polygon");if(!s&&n.length>=3){if(s=new xo([o],{id:"polygon"}),r){var l=ii(r,{lineOpacity:0});s.setSymbol(l)}s.addTo(a)}s&&s._setPrjCoordinates(n)}},generate:function(t){var e=new xo(t.getCoordinates(),{symbol:t.getSymbol()});return e._setPrjCoordinates(t._getPrjCoordinates()),e._projCode=t._projCode,e}};aa.registerMode("polygon",B({action:["click","mousemove","dblclick"]},Ga)),aa.registerMode("freeHandPolygon",B({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Ga));var Ua={create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new So(i);return n._setPrjCoordinates(e),n},update:function(t,e,i){var n;Array.isArray(e)?n=e:(n=i._getPrjCoordinates()).push(e);var r=n.map((function(e){return t.unproject(e)}));i.setCoordinates(r),i._setPrjCoordinates(n)},generate:function(t){return t}};function Va(t){for(var e=t.tileInfo,i=[e.cols,e.rows],n=[],r=e.lods,o=0,a=r.length;o<a;o++)n.push(r[o].resolution);var s=t.fullExtent,l=e.origin,c=[1,-1,l.x,l.y];return delete s.spatialReference,{spatialReference:{resolutions:n,fullExtent:s},tileSystem:c,tileSize:i}}function Ha(t,e){return void 0===e&&(e=[]),e.forEach((function(e){var i=e[0],n=e[1];t=t.replace(i,n)})),t}function Za(t){var e=t.projection,i=t.isArcgis,n=t.isGeoServer,r=t.isSuperMap,o=.0002645833333333333;return(i||n||r)&&(o=28e-5),e&&e.indexOf("4326")>-1&&(o=2.3767925226029154e-9,(i||r)&&(o=2.518101729011901e-9),n&&(o=2.51528279553466e-9)),o}function Wa(t,e){for(var i=0;i<t.length;i++){var n=t[i];if((n=n.getElementsByTagName("ows:Identifier")[0])&&n.textContent===e)return t[i]}return null}function qa(t,e){void 0===e&&(e={});var i,n,r,o=t.getElementsByTagName("TileMatrix"),a=[],s=[],l=[],c=!1;if(!i){var h=t.getElementsByTagName("ows:SupportedCRS")[0];h&&(i=function(t){var e=t.indexOf("EPSG")>-1?t:"EPSG:"+t;return e=Ha(e,[["4490","4326"],["102100","3857"],["900913","3857"]])}(i=function(t){for(var e="",i=t.split(""),n=i.length-1;n>=0&&!isNaN(i[n]);n--)e=i[n]+e;return e}(i=(i=h.textContent).split("EPSG")[1])))}n||(n=t.getElementsByTagName("ows:Identifier")[0])&&(n=n.textContent),e.projection=i;for(var u=1/0,d=0;d<o.length;d++){var p=o[d],f=p.getElementsByTagName("ows:Identifier")[0].textContent;isNaN(parseInt(f))?(r=f.substr(0,f.lastIndexOf(":")),f=(f=f.split(":"))[f.length-1],f=parseInt(f),c=!0,e.isGeoServer=!0):f=parseInt(f),u=Math.min(u,f);var m=p.getElementsByTagName("ScaleDenominator")[0].textContent,g=p.getElementsByTagName("TopLeftCorner")[0].textContent,y=p.getElementsByTagName("TileWidth")[0].textContent,_=p.getElementsByTagName("TileHeight")[0].textContent;if(0===l.length&&l.push(parseInt(y),parseInt(_)),0===s.length){var v=g.split(" ").filter((function(t){return""!==t})).map((function(t){return parseFloat(t)})),x=v[0],b=v[1];x>0?s.push(1,-1,b,x):s.push(1,-1,x,b)}var w=Za(e),M=parseFloat(m)*w;a.push(M)}if(u>0)for(var T=a[0],S=u-1;S>=0;S--)T*=2,a.splice(0,0,T);return{resolutions:a,tileSize:l,tileSystem:s,projection:i,TileMatrixSet:n,isGeoServer:c,levelStr:r}}aa.registerMode("linestring",B({action:["click","mousemove","dblclick"]},Ua)),aa.registerMode("freeHandLinestring",B({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Ua)),aa.registerMode("arccurve",{action:["click","mousemove","dblclick"],create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new Go(i);return n._setPrjCoordinates(e),n},update:Ua.update,generate:function(t){return t}}),aa.registerMode("quadbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new Vo(i);return n._setPrjCoordinates(e),n},update:Ua.update,generate:function(t){return t}}),aa.registerMode("cubicbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var i=e.map((function(e){return t.unproject(e)})),n=new Uo(i);return n._setPrjCoordinates(e),n},update:Ua.update,generate:function(t){return t}}),aa.registerMode("boxZoom",{action:["mousedown","mousemove","mouseup"],create:function(t,e){e=e[0];var i=t.unproject(e),n=new Mo(i);return n._firstClick=e,n},update:function(t,e,i,n){var r=i.getMap(),o=r._prjToContainerPoint(i._firstClick),a=n.containerPoint;e=r._containerPointToPrj(new $i(Math.min(o.x,a.x),Math.min(o.y,a.y)));var s=t.unproject(e);i.setCoordinates(s)._setPrjCoordinates(e),i.updateSymbol({markerWidth:Math.abs(o.x-a.x),markerHeight:Math.abs(o.y-a.y)})},generate:function(t){return t}}),Vr.loadArcgis=function(t,e,i){if(void 0===i&&(i={jsonp:!0}),U(t)&&"{"!==t.substring(0,1))hi.getJSON(t,(function(t,i){if(t)e(t);else{var n=Va(i);e(null,n)}}),i);else{U(t)&&(t=it(t));var n=Va(t);e(null,n)}return this},Vr.loadWMTS=function(t,e,i){return void 0===i&&(i={jsonp:!0}),U(t)&&hi.get(t,(function(n,r){if(n)e(n);else{var o=function(t,e,i){null==i.isArcgis&&(i.isArcgis=t.indexOf("arcgis")>-1),null==i.isSuperMap&&(i.isSuperMap=t.indexOf("supermap")>-1);var n=(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("Contents")[0];if(!n)return[];var r=n.getElementsByTagName("Layer");if(!r.length)return[];for(var o=[],a=0,s=n.childNodes.length;a<s;a++)"TileMatrixSet"===n.childNodes[a].nodeName&&o.push(n.childNodes[a]);if(!o.length)return[];for(var l=[],c=0,h=r.length;c<h;c++){var u=r[c],d=u.querySelectorAll("Style")[0];d&&(d=d.getElementsByTagName("ows:Identifier")[0])&&(d=d.textContent);var p=u.getElementsByTagName("ows:Identifier")[0];p&&(p=p.textContent);var f=u.getElementsByTagName("TileMatrixSetLink");if(0!==f.length)for(var m=0,g=f.length;m<g;m++){var y=f[m];(y=y.getElementsByTagName("TileMatrixSet")[0])&&(y=y.textContent);var _=Wa(o,y);if(_){var v=u.querySelectorAll("ResourceURL")[0],x="";v&&(x=v.attributes.template.value);var b=qa(_,i),w=b.resolutions,M=b.tileSize,T=b.tileSystem,S=b.projection,E=b.TileMatrixSet,C=b.isGeoServer,A=b.levelStr;x.length||(x=e.substr(0,e.lastIndexOf("?")),x+="?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER={LAYER}&STYLE={Style}&TILEMATRIXSET={TileMatrixSet}&FORMAT={tiles}&TILEMATRIX={TileMatrix}&TILEROW={TileRow}&TILECOL={TileCol}");var P=Ha(x,[["{LAYER}",p],["{Layer}",p],["{layer}",p],["{STYLE}",d],["{Style}",d],["{style}",d],["{TileMatrixSet}",E],["{TileMatrix}",C?A+":{z}":"{z}"],["{TileRow}","{y}"],["{TileCol}","{x}"],["{tiles}",C?"image/png":"tiles"]]);l.push({tileSize:M,tileSystem:T,spatialReference:{resolutions:w,projection:S},urlTemplate:P,info:{layerName:p,TileMatrixSet:E,style:d,tileSize:M,tileSystem:T,resolutions:w,projection:S,urlTemplate:P}})}}}return l}(r,t,i);e(null,o)}}),i),this};var Xa=function(t){function e(e){return t.call(this,e)||this}ne(e,t);var i=e.prototype;return i.addTo=function(t){return this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this},i.getMap=function(){return this._owner?this._owner.getBaseLayer?this._owner:this._owner.getMap():null},i.show=function(t){var e=this.getMap();if(!e)return this;this.options.visible=!0,this._mapEventsOn||this._switchMapEvents("on"),t=t||this._coordinate||this._owner.getCenter();var i=this.isVisible();this.fire("showstart");var n=this._getUIContainer();this._coordinate=t,this._removePrevDOM();var r=this.__uiDOM=this.buildOn(e);if(r.eventsPropagation=this.options.eventsPropagation,!r)return this.fire("showend"),this;this._measureSize(r),this._singleton()&&(e[this._uiDomKey()]=r),this._setPosition(),r.style[ue]=null,n.appendChild(r);var o=this._getAnimation();if(i&&(o.ok=!1),o.ok&&(o.fade&&(r.style.opacity=0),o.scale)){if(this.getTransformOrigin){var a=this.getTransformOrigin();r.style[he]=a}r.style[ce]=this._toCSSTranslate(this._pos)+" scale(0)"}this.isSupportZoomFilter()||(r.style.display=""),this.options.eventsToStop&&ke(r,this.options.eventsToStop,xe),this.options.autoPan&&this._autoPan();var s=o.transition;return o.ok&&s&&(r.offsetHeight,s&&(r.style[ue]=s),o.fade&&(r.style.opacity=1),o.scale&&(r.style[ce]=this._toCSSTranslate(this._pos)+" scale(1)")),this.fire("showend"),this},i.hide=function(){var t=this;if(!this.getDOM()||!this.getMap())return this;this.options.visible=!1;var e=this._getAnimation(),i=this.getDOM();return this.options.animationOnHide||(e.ok=!1),e.ok?(i.offsetHeight,i.style[ue]=e.transition,setTimeout((function(){i.style.display="none",t.fire("hide")}),this.options.animationDuration)):(i.style.display="none",this.fire("hide")),e.fade&&(i.style.opacity=0),e.scale&&(i.style[ce]=this._toCSSTranslate(this._pos)+" scale(0)"),this},i.isVisible=function(){if(!this.options.visible)return!1;var t=this.getDOM();return this.getMap()&&t&&t.parentNode&&"none"!==t.style.display},i.remove=function(){return delete this._mapEventsOn,this._owner?(this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this):this},i.getSize=function(){return this._size?this._size.copy():null},i.getOwner=function(){return this._owner},i.getDOM=function(){return this.__uiDOM},i.getPosition=function(){if(!this.getMap())return null;var t=this._getViewPoint()._round();if(this.getOffset){var e=this.getOffset()._round();e&&t._add(e)}return t},i._getAnimation=function(){for(var t={fade:!1,scale:!1},e=this.options.animation?this.options.animation.split(","):[],i=0;i<e.length;i++){var n=Be(e[i]);"fade"===n?t.fade=!0:"scale"===n&&(t.scale=!0)}var r=null;return t.fade&&(r="opacity "+this.options.animationDuration+"ms"),t.scale&&(r=r?r+",":"",r+=ce+" "+this.options.animationDuration+"ms"),t.transition=r,t.ok=null!==r,t},i._getViewPoint=function(){var t=0;if(this._owner&&this._owner.getAltitude){var e=this._owner.getAltitude();e>0&&(t=this._meterToPoint(this._coordinate,e))}return this.getMap().coordToViewPoint(this._coordinate,void 0,t)._add(this.options.dx,this.options.dy)},i._meterToPoint=function(t,e){return this.getMap().distanceToPoint(e,0,void 0,t).x*st(e)},i._autoPan=function(){var t=this.getMap(),e=this.getDOM();if(!t.isMoving()){var i=this._getViewPoint()._round(),n=t.width,r=t.height,o=t.viewPointToContainerPoint(i),a=this.getOffset(),s=o.add(a),l=t._viewPointToPrj(i),c=parseInt(e.clientWidth),h=parseInt(e.clientHeight),u=0,d=0;if(s.x<0?u=50-s.x:s.x+c>n&&(u=-(s.x+c-n)-50),s.y<0?d=50-s.y:s.y+h>r&&(d=r-(s.y+h)-50),0!==d||0!==u){var p=o.add(u,d),f=t._containerPointToPoint(p)._sub(t._prjToPoint(t._getPrjCenter())),m=t._pointToPrj(t._prjToPoint(l).sub(f));t._panAnimation(m)}}},i._measureSize=function(t){var e=this._getUIContainer();t.style.position="absolute",t.style.left="-99999px";var i=t.style.bottom?"bottom":"top";return t.style[i]="-99999px",t.style.display="",e.appendChild(t),this._size=new se(t.clientWidth,t.clientHeight),t.style.display="none",t.style.left="0px",t.style[i]="0px",this._size},i._removePrevDOM=function(){this.onDomRemove&&this.onDomRemove();var t=this.options.eventsToStop;if(this._singleton()){var e=this.getMap(),i=this._uiDomKey();e[i]&&(t&&Oe(e[i],t,xe),me(e[i]),delete e[i]),delete this.__uiDOM}else this.__uiDOM&&(t&&Oe(this.__uiDOM,t,xe),me(this.__uiDOM),delete this.__uiDOM)},i._uiDomKey=function(){return"__ui_"+this._getClassName()},i._singleton=function(){return this.options.single},i._getUIContainer=function(){return this.getMap()._panels.ui},i._getClassName=function(){return"UIComponent"},i._switchMapEvents=function(t){var e=this.getMap();if(e){this._mapEventsOn="on"===t;var i=this._getDefaultEvents();if(this.getEvents&&B(i,this.getEvents()),i)for(var n in i)i.hasOwnProperty(n)&&e[t](n,i[n],this)}},i._switchEvents=function(t){this._switchMapEvents(t);var e=this._getOwnerEvents();if(this._owner)for(var i in e)e.hasOwnProperty(i)&&this._owner[t](i,e[i],this)},i._getDefaultEvents=function(){return{"zooming rotate pitch":this.onEvent,zoomend:this.onZoomEnd,moving:this.onMoving,resize:this.onResize}},i._getOwnerEvents=function(){var t={};return this._owner&&this._owner instanceof Wr&&(t.positionchange=this.onGeometryPositionChange),this.getOwnerEvents&&B(t,this.getOwnerEvents()),t},i.onGeometryPositionChange=function(t){this._owner&&this.isVisible()&&this.show(t.target.getCenter())},i.onMoving=function(){this.isVisible()&&this.getMap().isTransforming()&&this._updatePosition()},i.onEvent=function(){this.isVisible()&&this._updatePosition()},i.onZoomEnd=function(){this.isVisible()&&this._setPosition()},i.onResize=function(){this.isVisible()&&this._setPosition()},i._updatePosition=function(){this.getMap()._getRenderer().callInNextFrame(this._setPosition.bind(this))},i._setPosition=function(){var t=this.getDOM();if(t){t.style[ue]=null;var e=this.getPosition();this._pos=e,t.style[ce]=this._toCSSTranslate(e)+" scale(1)"}},i._toCSSTranslate=function(t){if(!t)return"";if(O.any3d){var e=this.getMap(),i=e?e.getBearing():0,n=e?e.getPitch():0,r="";return this.options.pitchWithMap&&n&&(r+=" rotateX("+Math.round(n)+"deg)"),this.options.rotateWithMap&&i&&(r+=" rotateZ("+Math.round(-i)+"deg)"),"translate3d("+t.x+"px,"+t.y+"px, 0px)"+r}return"translate("+t.x+"px,"+t.y+"px)"},i.isSupportZoomFilter=function(){return!1},e.isSupport=function(t){return!!(t&&V(t.on)&&V(t.off)&&V(t.getCenter))},e}(wi(Si));Xa.mergeOptions({eventsPropagation:!1,eventsToStop:null,dx:0,dy:0,autoPan:!1,autoPanDuration:600,single:!0,animation:"scale",animationOnHide:!0,animationDuration:500,pitchWithMap:!1,rotateWithMap:!1,visible:!0});var Ya="mousedown mouseup mouseenter mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",$a=function(t){function e(e,i){var n;return(n=t.call(this,i)||this)._markerCoord=new $i(e),n}ne(e,t);var i=e.prototype;return i._getClassName=function(){return"UIMarker"},i.setCoordinates=function(t){return this._markerCoord=t,this.fire("positionchange"),this.isVisible()&&(this._coordinate=this._markerCoord,this._setPosition()),this},i.getCoordinates=function(){return this._markerCoord},i.getCenter=function(){return this.getCoordinates()},i.getAltitude=function(){return this.options.altitude||0},i.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(),this},i.getContent=function(){return this.options.content},i.onAdd=function(){this.show()},i.show=function(){return t.prototype.show.call(this,this._markerCoord)},i.flash=function(t,e,i,n){return Tt.call(this,t,e,i,n)},i.buildOn=function(){var t;return U(this.options.content)?(t=pe("div")).innerHTML=this.options.content:t=this.options.content,this.options.containerClass&&(t.className=this.options.containerClass),this._registerDOMEvents(t),t},i.getOffset=function(){var t=this.getSize();return new ae(-t.width/2,-t.height/2)},i.getTransformOrigin=function(){return"center center"},i.onDomRemove=function(){var t=this.getDOM();this._removeDOMEvents(t)},i.isDragging=function(){return!!this.draggable&&this.draggable.isDragging()},i._registerDOMEvents=function(t){ke(t,Ya,this._onDomEvents,this)},i._onDomEvents=function(t){var e=this.getMap()._parseEvent(t,t.type);this.fire(t.type,e)},i._removeDOMEvents=function(t){Oe(t,Ya,this._onDomEvents,this)},i._getConnectPoints=function(){var t=this.getMap(),e=t.coordToContainerPoint(this.getCoordinates()),i=this.getSize(),n=i.width,r=i.height;return[t.containerPointToCoordinate(e.add(-n/2,0)),t.containerPointToCoordinate(e.add(n/2,0)),t.containerPointToCoordinate(e.add(0,r/2)),t.containerPointToCoordinate(e.add(0,-r/2))]},i._getViewPoint=function(){var t=0;if(this._owner){var e=this.getAltitude();e>0&&(t=this._meterToPoint(this._coordinate,e))}return this.getMap().coordToViewPoint(this._coordinate,void 0,t)._add(this.options.dx,this.options.dy)},i._getDefaultEvents=function(){return B({},t.prototype._getDefaultEvents.call(this),{"zooming zoomend":this.onZoomFilter})},i._setPosition=function(){this.onZoomFilter(),t.prototype._setPosition.call(this)},i.onZoomFilter=function(){var t=this.getDOM();t&&(this.isVisible()||"none"===t.style.display?this.isVisible()&&"none"===t.style.display&&(t.style.display=""):t.style.display="none")},i.isVisible=function(){var t=this.getMap();if(!t)return!1;if(!this.options.visible)return!1;var e=t.getZoom(),i=this.options,n=i.minZoom,r=i.maxZoom;return!(!F(n)&&e<n||!F(r)&&e>r)&&(this.getDOM()&&!0)},i.isSupportZoomFilter=function(){return!0},e}(Wi(Xa));$a.mergeOptions({containerClass:null,eventsPropagation:!0,draggable:!1,single:!1,content:null,altitude:0,minZoom:0,maxZoom:null});var Ja=O.touch?"touchstart mousedown":"mousedown",Ka=function(t){function e(e){return t.call(this,e)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target.on(Ja,this._startDrag,this)},i.removeHooks=function(){this.target.off(Ja,this._startDrag,this)},i._startDrag=function(t){var e=t.domEvent;e.touches&&e.touches.length>1||2===e.button||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastCoord=t.coordinate,this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this.target.fire("dragstart",t))},i._prepareDragHandler=function(){this._dragHandler=new Yi(this.target.getDOM(),{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},i._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},i._onMouseDown=function(t){xe(t.domEvent)},i._dragging=function(t){var e=this.target,i=e.getMap()._parseEvent(t.domEvent),n=i.domEvent;if(!(n.touches&&n.touches.length>1))if(this._isDragging){var r=i.coordinate,o=i.containerPoint;this._lastCoord||(this._lastCoord=r),this._lastPoint||(this._lastPoint=o);var a=r.sub(this._lastCoord),s=o.sub(this._lastPoint);this._lastCoord=r,this._lastPoint=o,this.target.setCoordinates(this.target.getCoordinates().add(a)),i.coordOffset=a,i.pointOffset=s,e.fire("dragging",i)}else this._isDragging=!0},i._endDrag=function(t){var e=this.target,i=e.getMap();if(this._dragHandler&&(e.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1,i){var n=i._parseEvent(t.domEvent);e.fire("dragend",n)}},i.isDragging=function(){return!!this._isDragging},e}(Ti);$a.addInitHook("addHandler","draggable",Ka);var Qa=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i._getClassName=function(){return"InfoWindow"},i.addTo=function(e){return e instanceof Wr&&(e.getInfoWindow()&&e.getInfoWindow()!==this&&e.removeInfoWindow(),e._infoWindow=this),t.prototype.addTo.call(this,e)},i.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},i.getContent=function(){return this.options.content},i.setTitle=function(t){var e=t;return this.options.title=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},i.getTitle=function(){return this.options.title},i.buildOn=function(){if(this.options.custom){if(U(this.options.content)){var t=pe("div");return t.innerHTML=this.options.content,t}return this.options.content}var e=pe("div");this.options.containerClass&&(e.className=this.options.containerClass),e.style.width=this._getWindowWidth()+"px",e.style.bottom="0px";var i='<em class="maptalks-ico"></em>';this.options.title&&(i+="<h2>"+this.options.title+"</h2>"),i+='<a href="javascript:void(0);" class="maptalks-close"></a><div class="maptalks-msgContent"></div>',e.innerHTML=i;var n=e.querySelector(".maptalks-msgContent");return U(this.options.content)?n.innerHTML=this.options.content:n.appendChild(this.options.content),this._onCloseBtnClick=this.hide.bind(this),ge(e.querySelector(".maptalks-close"),"click touchend",this._onCloseBtnClick),e},i.getTransformOrigin=function(){return this.getSize().width/2+"px bottom"},i.getOffset=function(){var t=this.getSize(),e=new ae(-t.width/2,0);this.options.custom?e._sub(0,t.height):e._sub(4,12);var i=this.getOwner();if(i instanceof Mo||i instanceof Lo){var n,r;if(i instanceof Mo)n=i._getPainter(),r=i.getSize();else{var o=i.getGeometries();if(!o||!o.length)return e;n=o[0]._getPainter(),r=o[0].getSize()}if(n){var a=n.getFixedExtent();e._add(a.xmax-r.width/2,a.ymin)}else e._add(0,-r.height)}return e},i.show=function(e){return this.getMap()&&this.getMap().options.enableInfoWindow?t.prototype.show.call(this,e):this},i.getEvents=function(){if(!this.options.autoCloseOn)return null;var t={};return t[this.options.autoCloseOn]=this.hide,t},i.getOwnerEvents=function(){var t=this.getOwner();if(!this.options.autoOpenOn||!t)return null;var e={};return e[this.options.autoOpenOn]=this._onAutoOpen,e},i.onRemove=function(){this.onDomRemove()},i.onDomRemove=function(){this._onCloseBtnClick&&(ye(this.getDOM().childNodes[2],"click touchend",this._onCloseBtnClick),delete this._onCloseBtnClick)},i._onAutoOpen=function(t){var e=this,i=this.getOwner();setTimeout((function(){i instanceof Mo||i instanceof Xa?e.show(i.getCoordinates()):i instanceof Lo?e.show(i.findClosest(t.coordinate)):i instanceof So||i instanceof Ro?(e.getMap().getScale()>=8&&(t.coordinate=e._rectifyMouseCoordinte(i,t.coordinate)),e.show(t.coordinate)):e.show(t.coordinate)}),1)},i._rectifyMouseCoordinte=function(t,e){var i=this;return t instanceof So?this._rectifyLineStringMouseCoordinate(t,e).coordinate:t instanceof Ro?t.getGeometries().map((function(t){return i._rectifyLineStringMouseCoordinate(t,e)})).sort((function(t,e){return t.dis-e.dis}))[0].coordinate:e},i._rectifyLineStringMouseCoordinate=function(t,e){for(var i=this,n=t.getCoordinates().map((function(t){return i.getMap().coordToContainerPoint(t)})),r=this.getMap().coordToContainerPoint(e),o=1/0,a=-1,s=0,l=n.length;s<l;s++){var c=n[s],h=r.distanceTo(c);h<o&&(o=h,a=s)}var u=[];0===a?u.push(n[0],n[1]):a===n.length-1?u.push(n[a-1],n[a]):u.push(n[a-1],n[a],n[a+1]);for(var d=[],p=this.getMap().getSize(),f=p.width,m=p.height,g=0,y=u.length-1;g<y;g++){var _=u[g],v=u[g+1];if(_.x===v.x)for(var x=Math.max(0,Math.min(_.y,v.y)),b=Math.min(m,Math.max(_.y,v.y)),w=x;w<=b;w++)d.push(new ae(_.x,w));else for(var M=(v.y-_.y)/(v.x-_.x),T=Math.max(0,Math.min(_.x,v.x)),S=Math.min(f,Math.max(_.x,v.x)),E=T;E<=S;E++){var C=M*(E-_.x)+_.y;d.push(new ae(E,C))}}for(var A=1/0,P=-1,L=0,I=d.length;L<I;L++){var R=d[L],D=r.distanceTo(R);D<A&&(A=D,P=L)}return{dis:A,coordinate:P<0?e:this.getMap().containerPointToCoord(d[P])}},i._getWindowWidth=function(){var t=this.options.width;return t||(t=300),t},e}(Xa);Qa.mergeOptions({containerClass:"maptalks-msgBox",autoPan:!0,autoCloseOn:null,autoOpenOn:"click",width:300,minHeight:120,custom:!1,title:null,content:null});var ts=function(t){ne(i,t);var e=i.prototype;function i(e,i){var n;return void 0===i&&(i={}),(n=t.call(this,i)||this)._content=e,n}return e._getClassName=function(){return"ToolTip"},e.addTo=function(e){if(i.isSupport(e))return e.on("mousemove",this.onMouseMove,this),e.on("mouseout",this.onMouseOut,this),t.prototype.addTo.call(this,e);throw new Error("Invalid geometry or UIMarker the tooltip is added to.")},e.setStyle=function(t){return this.options.containerClass=t,this},e.getStyle=function(){return this.options.containerClass},e.getContent=function(){return this._content},e.buildOn=function(){var t=pe("div"),e=this.options||{};e.height&&(t.style.height=e.height+"px"),e.width&&(t.style.width=e.width+"px");var i=e.containerClass||e.cssName;return!i&&e.height&&(t.style.lineHeight=e.height+"px"),t.innerHTML='<div class="'+i+'">'+this._content+"</div>",t},e.onMouseOut=function(){clearTimeout(this._timeout),this.isVisible()&&this._removePrevDOM()},e.onMouseMove=function(t){var e=this;clearTimeout(this._timeout);var i=this.getMap();if(i){var n=i.locateByPoint(t.coordinate,-5,25);0===this.options.showTimeout?this.show(n):this._timeout=setTimeout((function(){i&&e.show(n)}),this.options.showTimeout)}},e.onRemove=function(){clearTimeout(this._timeout),this._owner&&(this._owner.off("mouseover",this.onMouseOver,this),this._owner.off("mouseout",this.onMouseOut,this))},e._getViewPoint=function(){return this.getMap().coordToViewPoint(this._coordinate,void 0,0)._add(this.options.dx,this.options.dy)},i}(Xa);ts.mergeOptions({width:0,height:0,animation:"fade",containerClass:"maptalks-tooltip",showTimeout:400});var es=function(t){function e(e){return t.call(this,e)||this}ne(e,t);var i=e.prototype;return i._getClassName=function(){return"Menu"},i.addTo=function(t){return t._menu&&t._menu!==this&&t.removeMenu(),t._menu=this,Xa.prototype.addTo.apply(this,arguments)},i.setItems=function(t){return this.options.items=t,this},i.getItems=function(){return this.options.items||[]},i.buildOn=function(){if(this.options.custom){if(U(this.options.items)){var t=pe("div");return t.innerHTML=this.options.items,t}return this.options.items}var e=pe("div");this.options.containerClass&&Ce(e,this.options.containerClass),e.style.width=this._getMenuWidth()+"px";var i=this._createMenuItemDom();return e.appendChild(i),ke(e,"contextmenu",ve),e},i.getOffset=function(){if(!this.getMap())return null;var t=this.getMap().getSize(),e=this.getMap().viewPointToContainerPoint(this._getViewPoint()),i=this.getSize(),n=0,r=0;return e.x+i.width>t.width&&(n=-i.width),e.y+i.height>t.height&&(r=-i.height),new ae(n,r)},i.getTransformOrigin=function(){var t=this.getOffset()._multi(-1);return t.x+"px "+t.y+"px"},i.getEvents=function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this._removePrevDOM}},i._createMenuItemDom=function(){var t=this,e=this.getMap(),i=pe("ul");Ce(i,"maptalks-menu-items");var n,r,o=this.getItems();function a(i){return function(n){var r=e._parseEvent(n,"click");r.target=t,r.owner=t._owner,r.index=i,!1!==this._callback(r)&&t.hide()}}for(var s=0,l=o.length;s<l;s++){if("-"===(n=o[s])||"_"===n)Ce(r=pe("li"),"maptalks-menu-splitter");else{r=pe("li");var c=n.item;V(c)&&(c=c({owner:this._owner,index:s})),r.innerHTML=c,r._callback=n.click,ke(r,"click",a(s))}i.appendChild(r)}var h=this.options.maxHeight||0;return h>0&&Se(i,"max-height: "+h+"px; overflow-y: auto;"),i},i._getMenuWidth=function(){return this.options.width||160},e}(Xa);es.mergeOptions({containerClass:"maptalks-menu",animation:null,animationDelay:10,animationOnHide:!1,autoPan:!1,width:160,maxHeight:0,custom:!1,items:[]});var is={setMenu:function(t){return this._menuOptions=t,this._menu?this._menu.setOptions(t):this.on("contextmenu",this._defaultOpenMenu,this),this},openMenu:function(t){var e=this instanceof ro?this:this.getMap();return t||(t=this.getCenter()),this._menu?this._menu.show(t):this._menuOptions&&e&&(this._bindMenu(this._menuOptions),this._menu.show(t)),this},setMenuItems:function(t){return this._menuOptions||(this._menuOptions={}),Array.isArray(t)&&(this._menuOptions.custom=!1),this._menuOptions.items=t,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions&&this._menuOptions.items||[]},closeMenu:function(){return this._menu&&this._menu.hide(),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this},_bindMenu:function(t){return this._menu=new es(t),this._menu.addTo(this),this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(t){return this.listens("contextmenu")>1||(this.openMenu(t.coordinate),!1)}};ro.include(is),Wr.include(is);var ns=Object.freeze({UIComponent:Xa,UIMarker:$a,InfoWindow:Qa,ToolTip:ts,Menuable:is,Menu:es}),rs=function(t){function e(e){return e&&e.position&&!U(e.position)&&(e.position=B({},e.position)),t.call(this,e)||this}ne(e,t);var i=e.prototype;return i.addTo=function(t){if(this.remove(),!t.options.control)return this;this._map=t;var e=t._panels.control;return this.__ctrlContainer=pe("div"),Se(this.__ctrlContainer,"position:absolute;overflow:visible;"),this.update(),e.appendChild(this.__ctrlContainer),this.onAdd&&this.onAdd(),this.fire("add",{dom:e}),this},i.update=function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},i.getMap=function(){return this._map},i.getPosition=function(){return B({},this._parse(this.options.position))},i.setPosition=function(t){return U(t)?this.options.position=t:this.options.position=B({},t),this._updatePosition(),this},i.getContainerPoint=function(){var t,e,i=this.getPosition(),n=this.getMap().getSize();return F(i.left)?F(i.right)||(t=n.width-parseInt(i.right)):t=parseInt(i.left),F(i.top)?F(i.bottom)||(e=n.height-parseInt(i.bottom)):e=parseInt(i.top),new ae(t,e)},i.getContainer=function(){return this.__ctrlContainer},i.getDOM=function(){return this._controlDom},i.show=function(){return this.__ctrlContainer.style.display="",this},i.hide=function(){return this.__ctrlContainer.style.display="none",this},i.isVisible=function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},i.remove=function(){return this._map?(me(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},i._parse=function(t){var i=t;return U(t)&&(i=e.positions[i]),i},i._updatePosition=function(){var t=this.getPosition();for(var e in t||(t={top:20,left:20}),t)t.hasOwnProperty(e)&&(t[e]=parseInt(t[e]),this.__ctrlContainer.style[e]=t[e]+"px");this.fire("positionchange",{position:B({},t)})},e}(wi(Si));rs.positions={"top-left":{top:20,left:20},"top-right":{top:20,right:20},"bottom-left":{bottom:20,left:20},"bottom-right":{bottom:20,right:20}},ro.mergeOptions({control:!0}),ro.include({addControl:function(t){return this._containerDOM.getContext||t.addTo(this),this},removeControl:function(t){return t&&t.getMap()===this?(t.remove(),this):this}});var os="addlayer removelayer setbaselayer baselayerremove",as=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(){return this._attributionContainer=pe("div"),this._attributionContainer.className="maptalks-attribution",this._update(),this._attributionContainer},i.onAdd=function(){this.getMap().on(os,this._update,this)},i.onRemove=function(){this.getMap().off(os,this._update,this)},i._update=function(){var t=this.getMap();if(t){var e=t._getLayers((function(t){return t.options.attribution})).reverse().map((function(t){return t.options.attribution})),i=this.options.content+(e.length>0?" - "+e.join(", "):"");this._attributionContainer.innerHTML='<span style="padding:0px 4px">'+i+"</span>"}},e}(rs);as.mergeOptions({position:{bottom:0,left:0},content:'<a href="http://maptalks.org" target="_blank">maptalks</a>'}),ro.mergeOptions({attribution:!0}),ro.addOnLoadHook((function(){var t=this.options.attribution||this.options.attributionControl;t&&(this.attributionControl=new as(t),this.addControl(this.attributionControl))}));var ss=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(){var t=this.container=pe("div",this.options.containerClass),e=this.panel=pe("div","panel"),i=this.button=pe("button");return t.appendChild(i),t.appendChild(e),t},i.onAdd=function(){ke(this.button,"mouseover",this._show,this),ke(this.panel,"mouseleave",this._hide,this),ke(this.getMap(),"click",this._hide,this)},i.onRemove=function(){this.panel&&(Oe(this.button,"mouseover",this._show,this),Oe(this.panel,"mouseleave",this._hide,this),Oe(this.getMap(),"click",this._hide,this),me(this.panel),me(this.button),delete this.panel,delete this.button,delete this.container)},i._show=function(){Ee(this.container,"shown")||(Ce(this.container,"shown"),this._createPanel())},i._hide=function(t){this.panel.contains(t.toElement||t.relatedTarget)||Ae(this.container,this.options.containerClass)},i._createPanel=function(){this.panel.innerHTML="";var t=pe("ul");this.panel.appendChild(t),this._renderLayers(this.getMap(),t)},i._renderLayers=function(t,e){var i=t.getBaseLayer(),n=t.getLayers(),r=n.length;if(i){var o=i.layers||[i],a=pe("li","group"),s=pe("ul"),l=pe("label");l.innerHTML=this.options.baseTitle,a.appendChild(l);for(var c=0,h=o.length;c<h;c++){var u=o[c];this._isExcluded(u)&&(s.appendChild(this._renderLayer(o[c],!0)),a.appendChild(s),e.appendChild(a))}}if(r){var d=pe("li","group"),p=pe("ul"),f=pe("label");f.innerHTML=this.options.overlayTitle,d.appendChild(f);for(var m=0;m<r;m++){var g=n[m];this._isExcluded(g)&&p.appendChild(this._renderLayer(g))}d.appendChild(p),e.appendChild(d)}},i._isExcluded=function(t){var e=t.getId(),i=this.options.excludeLayers;return!(i.length&&i.indexOf(e)>=0)},i._renderLayer=function(t,e){var i=this,n=pe("li","layer"),r=pe("label"),o=pe("input"),a=this.getMap(),s=t.options.visible;t.options.visible=!0;var l=t.isVisible();return t.options.visible=s,n.className="layer",e?(o.type="radio",o.name="base"):o.type="checkbox",o.checked=s&&l,l||o.setAttribute("disabled","disabled"),o.onchange=function(e){if("radio"===e.target.type){var n=a.getBaseLayer(),r=n.layers;if(r)for(var o=0,s=r.length;o<s;o++){var l=r[o];l[l===t?"show":"hide"]()}else n.isVisible()||n.show();a._fireEvent("setbaselayer")}else t[e.target.checked?"show":"hide"]();i.fire("layerchange",{target:t})},n.appendChild(o),r.innerHTML=t.getId(),n.appendChild(r),n},e}(rs);ss.mergeOptions({position:"top-right",baseTitle:"Base Layers",overlayTitle:"Layers",excludeLayers:[],containerClass:"maptalks-layer-switcher"}),ro.mergeOptions({layerSwitcherControl:!1}),ro.addOnLoadHook((function(){this.options.layerSwitcherControl&&(this.layerSwitcherControl=new ss(this.options.layerSwitcherControl),this.addControl(this.layerSwitcherControl))}));var ls=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(){var t=this.options.size;this.options.maximize||(t=[0,0]);var e=pe("div"),i=this.mapContainer=pe("div");i.style.width=t[0]+"px",i.style.height=t[1]+"px",i.className=this.options.containerClass;var n=this.button=pe("div");return n.className=this.options.buttonClass,e.appendChild(i),e.appendChild(n),e},i.onAdd=function(){this.options.maximize&&this._createOverview(),this.getMap().on("resize moving zooming rotate dragrotating viewchange",this._update,this).on("setbaselayer",this._updateBaseLayer,this).on("spatialreferencechange",this._updateSpatialReference,this),ke(this.button,"click",this._onButtonClick,this),this._updateButtonText()},i.onRemove=function(){this.getMap().off("resize moving zooming rotate dragrotating viewchange",this._update,this).off("setbaselayer",this._updateBaseLayer,this).off("spatialreferencechange",this._updateSpatialReference,this),this._overview&&(this._overview.remove(),delete this._overview,delete this._perspective),Oe(this.button,"click",this._onButtonClick,this)},i.maxmize=function(){var t=this.options.size,e=this.mapContainer;return e.style.width=t[0]+"px",e.style.height=t[1]+"px",this._createOverview(),this},i.minimize=function(){this._overview&&this._overview.remove(),delete this._overview,delete this._perspective;var t=this.mapContainer;return t.style.width="0px",t.style.height="0px",this},i.getOverviewMap=function(){return this._overview},i._onButtonClick=function(){this._overview?this.minimize():this.maxmize(),this._updateButtonText()},i._updateButtonText=function(){this._overview?this.button.innerHTML="-":this.button.innerHTML="+"},i._createOverview=function(){var t=this.getMap(),e=this.mapContainer,i=t.config();B(i,{center:t.getCenter(),zoom:this._getOverviewZoom(),zoomAnimationDuration:150,pitch:0,bearing:0,scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1,draggable:!1,maxExtent:null}),this._overview=new ro(e,i),this._updateBaseLayer(),this._perspective=new xo(this._getPerspectiveCoords(),{draggable:!0,cursor:"move",symbol:this.options.symbol}).on("dragend",this._onDragEnd,this),new ia("perspective_layer",this._perspective).addTo(this._overview),this.fire("load")},i._getOverviewZoom=function(){var t=this.getMap(),e=t.getZoom(),i=t.getMinZoom(),n=this.options.level;if(n>0){for(var r=n;r>0;r--)if(e-r>=i)return e-r}else for(var o=n;o<0;o++)if(e-o>=i)return e-o;return e},i._onDragEnd=function(){var t=this._perspective.getCenter();this._overview.setCenter(t),this.getMap().panTo(t)},i._getPerspectiveCoords=function(){var t=this.getMap();return t.getContainerExtent().toArray().map((function(e){return t.containerPointToCoordinate(e)}))},i._update=function(){if(this._overview){Me(this._overview._containerDOM);var t=this._getPerspectiveCoords();this._perspective.setCoordinates(t),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())}},i._updateSpatialReference=function(){if(this._overview){var t=this.getMap().options.spatialReference;this._overview.setSpatialReference(t)}},i._updateBaseLayer=function(){if(this._overview){var t=this.getMap().getBaseLayer();if(t){var e=t.layers,i=0;if(e)for(var n=0,r=e.length;n<r;n++){if(e[n].isVisible()){i=n;break}}var o=t.toJSON(),a=null;e?(a=o.layers[i].options).visible=!0:a=o.options,this._overview.setMinZoom(a.minZoom||null).setMaxZoom(a.maxZoom||null),delete a.minZoom,delete a.maxZoom,delete o.options.canvas,o.options.visible=!0,o.options.renderer="canvas";var s=Xr.fromJSON(o);for(var l in t)V(t[l])&&t.hasOwnProperty(l)&&t[l]!==t.constructor.prototype[l]&&(s[l]=t[l]);this._overview.setBaseLayer(s)}else this._overview.setBaseLayer(null)}},e}(rs);ls.mergeOptions({level:4,position:{right:1,bottom:1},size:[300,200],maximize:!0,symbol:{lineWidth:3,lineColor:"#1bbc9b",polygonFill:"#1bbc9b",polygonOpacity:.4},containerClass:"maptalks-overview",buttonClass:"maptalks-overview-button"}),ro.mergeOptions({overviewControl:!1}),ro.addOnLoadHook((function(){this.options.overviewControl&&(this.overviewControl=new ls(this.options.overviewControl),this.addControl(this.overviewControl))}));var cs=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(){var t;if(this.options.custom)U(this.options.content)?(t=pe("div")).innerHTML=this.options.content:t=this.options.content;else{if(t=pe("div","maptalks-panel"),this.options.closeButton){var e=pe("a","maptalks-close");e.href="javascript:;",e.onclick=function(){t.style.display="none"},t.appendChild(e)}var i=pe("div","maptalks-panel-content");i.innerHTML=this.options.content,t.appendChild(i)}return this.draggable=new Yi(t,{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),t},i.update=function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),rs.prototype.update.call(this)},i.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.update(),this},i.getContent=function(){return this.options.content},i._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},i._onDragStart=function(t){this._startPos=t.mousePos,this._startPosition=B({},this.getPosition()),this.fire("dragstart",t)},i._onDragging=function(t){var e=t.mousePos.sub(this._startPos),i=this._startPosition,n=this.getPosition();F(n.top)||(n.top=parseInt(i.top)+e.y),F(n.bottom)||(n.bottom=parseInt(i.bottom)-e.y),F(n.left)||(n.left=parseInt(i.left)+e.x),F(n.right)||(n.right=parseInt(i.right)-e.x),this.setPosition(n),this.fire("dragging",t)},i._onDragEnd=function(t){delete this._startPos,delete this._startPosition,this.fire("dragend",t)},i._getConnectPoints=function(){var t=this.getMap(),e=this.getContainerPoint(),i=this.getDOM(),n=parseInt(i.clientWidth),r=parseInt(i.clientHeight);return[t.containerPointToCoordinate(e.add(n/2,0)),t.containerPointToCoordinate(e.add(n,r/2)),t.containerPointToCoordinate(e.add(n/2,r)),t.containerPointToCoordinate(e.add(0,r/2))]},e}(rs);cs.mergeOptions({position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0});var hs=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(t){return this._map=t,this._scaleContainer=pe("div",this.options.containerClass),this._addScales(),t.on("zoomend",this._update,this),this._map._loaded&&this._update(),this._scaleContainer},i.onRemove=function(){this.getMap().off("zoomend",this._update,this)},i._addScales=function(){var t="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 0px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=fe("div",this.options.containerClass?null:t,this._scaleContainer)),this.options.imperial&&(this._iScale=fe("div",this.options.containerClass?null:t,this._scaleContainer))},i._update=function(){var t=this._map.pixelToDistance(this.options.maxWidth,0);this._updateScales(t)},i._updateScales=function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},i._updateMetric=function(t){var e=this._getRoundNum(t),i=e<1e3?e+" m":e/1e3+" km";this._updateScale(this._mScale,i,e/t)},i._updateImperial=function(t){var e,i,n,r=3.2808399*t;r>5280?(e=r/5280,i=this._getRoundNum(e),this._updateScale(this._iScale,i+" mile",i/e)):(n=this._getRoundNum(r),this._updateScale(this._iScale,n+" feet",n/r))},i._updateScale=function(t,e,i){t.style.width=Math.round(this.options.maxWidth*i)+"px",t.innerHTML=e},i._getRoundNum=function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),i=t/e;return e*(i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:1)},e}(rs);hs.mergeOptions({position:"bottom-left",maxWidth:100,metric:!0,imperial:!1,containerClass:null}),ro.mergeOptions({scaleControl:!1}),ro.addOnLoadHook((function(){this.options.scaleControl&&(this.scaleControl=new hs(this.options.scaleControl),this.addControl(this.scaleControl))}));var us=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(t){this._map=t;var e=pe("div"),i=pe("ul","maptalks-toolbar-hx");e.appendChild(i),this.options.vertical?Ce(e,"maptalks-toolbar-vertical"):Ce(e,"maptalks-toolbar-horizonal");var n=this;function r(t,e,i,r){var o=n._getItems()[e];return function(n){return xe(n),t({target:o,index:e,childIndex:i,dom:r})}}var o=this.options.items;if(dt(o))for(var a=0,s=o.length;a<s;a++){var l=o[a],c=pe("li");if(28!==this.options.height&&(c.style.lineHeight=this.options.height+"px"),c.style.height=this.options.height+"px",c.style.cursor="pointer",Ie(l.item)){c.style.textAlign="center";var h=Re("div",l.item);c.innerHTML='<div style="margin-top:'+(this.options.height-h.height)/2+'px;">'+l.item+"</div>"}else c.innerHTML=l.item;if(l.click&&ke(c,"click",r(l.click,a,null,c)),dt(l.children)){var u=this._createDropMenu(a);c.appendChild(u),c._menu=u,ke(c,"mouseover",(function(){this._menu.style.display=""})),ke(c,"mouseout",(function(){this._menu.style.display="none"}))}i.appendChild(c)}return e},i._createDropMenu=function(t){var e=this;function i(t,i,n){var r=e._getItems()[i].children[n];return function(e){return xe(e),t({target:r,index:i,childIndex:n})}}var n=pe("div","maptalks-dropMenu"),r=this._getItems(),o=r.length,a=pe("ul"),s=r[t].children;t===o-1&&s&&(n.style.cssText="right: 0px;",a.style.cssText="right: 0px;position: absolute;",this.options.reverseMenu&&(a.style.bottom=0)),n.appendChild(pe("em","maptalks-ico"));for(var l=0,c=0,h=s.length;c<h;c++){var u=Ve(s[c].item,"12px");u.width>l&&(l=u.width)}for(var d=0,p=s.length;d<p;d++){var f=s[d],m=pe("li");m.innerHTML='<a href="javascript:;">'+f.item+"</a>",m.style.cursor="pointer",m.style.width=l+24+"px",ke(m.childNodes[0],"click",i(f.click,t,d)),a.appendChild(m)}if(this.options.vertical){var g=l<95?95:l;this.options.reverseMenu?n.style.right=-(g+20)+"px":n.style.left=-(g+20)+"px"}else this.options.reverseMenu?n.style.bottom="28px":n.style.top="28px";return n.appendChild(a),n.style.display="none",n},i._getItems=function(){return this.options.items||[]},e}(rs);us.mergeOptions({height:28,vertical:!1,position:"top-right",reverseMenu:!1,items:{}});var ds=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(t){var e=this.options,i=pe("div","maptalks-zoom");if(e.zoomLevel){var n=pe("span","maptalks-zoom-zoomlevel");i.appendChild(n),this._levelDOM=n}var r=pe("div","maptalks-zoom-slider"),o=pe("a","maptalks-zoom-zoomin");if(o.href="javascript:;",o.innerHTML="+",r.appendChild(o),this._zoomInButton=o,e.slider){var a=pe("div","maptalks-zoom-slider-box"),s=pe("div","maptalks-zoom-slider-ruler"),l=pe("span","maptalks-zoom-slider-reading"),c=pe("span","maptalks-zoom-slider-dot");s.appendChild(l),a.appendChild(s),a.appendChild(c),r.appendChild(a),this._sliderBox=a,this._sliderRuler=s,this._sliderReading=l,this._sliderDot=c}var h=pe("a","maptalks-zoom-zoomout");return h.href="javascript:;",h.innerHTML="-",r.appendChild(h),this._zoomOutButton=h,i.appendChild(r),t.on("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._update(),this._registerDomEvents(),i},i.onRemove=function(){this.getMap().off("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._zoomInButton&&Oe(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&Oe(this._zoomOutButton,"click",this._onZoomOutClick,this),this._sliderRuler&&(Oe(this._sliderRuler,"click",this._onClickRuler,this),this.dotDragger.disable(),delete this.dotDragger)},i._update=function(){var t=this.getMap();if(this._sliderBox){var e=10*(t.getMaxZoom()-t.getMinZoom());this._sliderBox.style.height=e+16+"px",this._sliderRuler.style.height=e+8+"px",this._sliderRuler.style.cursor="pointer";var i=10*(t.getMaxZoom()-t.getZoom());this._sliderReading.style.height=10*(t.getZoom()-t.getMinZoom()+1)+"px",this._sliderDot.style.top=i+"px"}this._updateText()},i._updateText=function(){if(this._levelDOM){var t=this.getMap().getZoom();j(t)||(t=Math.floor(10*t)/10),this._levelDOM.innerHTML=t}},i._registerDomEvents=function(){this._zoomInButton&&ke(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&ke(this._zoomOutButton,"click",this._onZoomOutClick,this),this._sliderRuler&&(ke(this._sliderRuler,"click",this._onClickRuler,this),this.dotDragger=new Yi(this._sliderDot,{ignoreMouseleave:!0}),this.dotDragger.on("dragstart",this._onDotDragstart,this).on("dragging dragend",this._onDotDrag,this).enable())},i._onZoomInClick=function(t){ve(t),this.getMap().zoomIn()},i._onZoomOutClick=function(t){ve(t),this.getMap().zoomOut()},i._onClickRuler=function(t){ve(t);var e=this.getMap(),i=Te(t,this._sliderRuler).y,n=e.getMaxZoom(),r=Math.floor(n-i/10);e.setZoom(r)},i._onDotDragstart=function(t){ve(t.domEvent);var e=this.getMap(),i=e.getSize().toPoint()._multi(.5);e.onZoomStart(e.getZoom(),i)},i._onDotDrag=function(t){ve(t.domEvent);var e=this.getMap(),i=e.getSize().toPoint()._multi(.5),n=Te(t.domEvent,this._sliderRuler),r=e.getMaxZoom(),o=e.getMinZoom(),a=n.y,s=r-a/10;r<s?(s=r,a=0):o>s&&(s=o,a=10*(r-o)),"dragging"===t.type?e.onZooming(s,i,1):"dragend"===t.type&&(this.options.seamless?e.onZoomEnd(s,i):e.onZoomEnd(Math.round(s),i)),this._sliderDot.style.top=a+"px",this._sliderReading.style.height=10*(e.getZoom()-o+1)+"px",this._updateText()},e}(rs);ds.mergeOptions({position:"top-left",slider:!0,zoomLevel:!0,seamless:!1}),ro.mergeOptions({zoomControl:!1}),ro.addOnLoadHook((function(){this.options.zoomControl&&(this.zoomControl=new ds(this.options.zoomControl),this.addControl(this.zoomControl))}));var ps=function(){function t(t,e,i,n){Array.isArray(t)?(this.scale={x:t[0],y:t[1]},this.origin={x:t[2],y:t[3]}):(this.scale={x:t,y:e},this.origin={x:i,y:n})}return t.getDefault=function(t){return"baidu"===t.code.toLowerCase()?"baidu":t.code.toLowerCase()==="EPSG:4326".toLowerCase()?"tms-global-geodetic":"identity"===t.code.toLowerCase()?[1,-1,0,0]:"web-mercator"},t}(),fs=6378137*Math.PI;B(ps,{"web-mercator":new ps([1,-1,-fs,fs]),"tms-global-mercator":new ps([1,1,-fs,-fs]),"tms-global-geodetic":new ps([1,1,-180,-90]),baidu:new ps([1,1,0,0])});for(var ms=function(){function t(t,e,i,n){this.map=t,this.tileSize=n,this.fullExtent=i,this.prepareTileInfo(e,i),this._xScale=i.right>=i.left?1:-1,this._yScale=i.top>=i.bottom?1:-1,this._pointOrigin=t._prjToPoint(new ae(this.tileSystem.origin),t.getGLZoom()),this._glRes=t.getResolution(t.getGLZoom())}var e=t.prototype;return e.prepareTileInfo=function(t,e){if(U(t)?t=ps[t.toLowerCase()]:Array.isArray(t)&&(t=new ps(t)),!t)throw new Error("Invalid TileSystem");this.tileSystem=t;var i=e.right>e.left?1:-1,n=e.top>e.bottom?-1:1,r=t.origin.x,o=t.origin.y;this.transformation=new fn([i,n,r,o])},e._getTileNum=function(t,e){var i=this.tileSystem,n=this.tileSize,r=Math.floor(1e-7*i.scale.x+t.x/(n.width*e)),o=Math.ceil(1e-7*i.scale.y+t.y/(n.height*e));return{x:i.scale.x*r,y:i.scale.y*o}},e.getTileIndex=function(t,e,i){var n=this.tileSystem,r=this.transformation.transform(t,1),o=this._getTileNum(r,e);return n.scale.x<0&&(o.x-=1),n.scale.y>0&&(o.y-=1),this.getNeighorTileIndex(o.x,o.y,0,0,e,i)},e.getNeighorTileIndex=function(t,e,i,n,r,o){var a=this.tileSystem,s=t+a.scale.x*i,l=e-a.scale.y*n,c=!1,h=s,u=l,d=this._getTileFullIndex(r);return o&&(!0!==o&&"x"!==o||(d.xmax===d.xmin?s=d.xmin:s<d.xmin?(s=d.xmax-(d.xmin-s)%(d.xmax-d.xmin))===d.xmax&&(s=d.xmin):s>=d.xmax&&(s=d.xmin+(s-d.xmin)%(d.xmax-d.xmin))),!0!==o&&"y"!==o||(d.ymax===d.ymin?l=d.ymin:l>=d.ymax?l=d.ymin+(l-d.ymin)%(d.ymax-d.ymin):l<d.ymin&&(l=d.ymax-(d.ymin-l)%(d.ymax-d.ymin))===d.ymax&&(l=d.ymin))),(s<d.xmin||s>d.xmax||l>d.ymax||l<d.ymin)&&(c=!0),{x:s,y:l,idx:h,idy:u,out:c}},e._getTileFullIndex=function(t){if(this._tileFullIndex||(this._tileFullIndex={}),this._tileFullIndex[t])return this._tileFullIndex[t];var e=this.fullExtent,i=this.transformation,n=this._getTileNum(i.transform(new $i(e.left,e.top),1),t),r=this._getTileNum(i.transform(new $i(e.right,e.bottom),1),t),o=this.tileSystem;return o.scale.x<0&&(n.x-=1,r.x-=1),o.scale.y>0&&(n.y-=1,r.y-=1),this._tileFullIndex[t]=new un(n,r),this._tileFullIndex[t]},e.getTilePrjNW=function(t,e,i){var n=this.tileSystem,r=this.tileSize,o=n.origin.y+this._yScale*n.scale.y*(e+(1===n.scale.y?1:0))*i*r.height,a=n.origin.x+this._xScale*n.scale.x*(t+(1===n.scale.x?0:1))*i*r.width;return new $i(a,o)},e.getTilePointNW=function(t,e,i){var n=this._glRes/i,r=this.tileSystem,o=this.tileSize,a=this._pointOrigin.y*n+this._yScale*r.scale.y*(e+(1===r.scale.y?1:0))*o.height,s=this._pointOrigin.x*n+this._xScale*r.scale.x*(t+(1===r.scale.x?0:1))*o.width;return new ae(s,a)},e.getTilePrjSE=function(t,e,i){var n=this.tileSystem,r=this.tileSize,o=n.origin.y+this._yScale*n.scale.y*(e+(1===n.scale.y?0:1))*i*r.height,a=n.origin.x+this._xScale*n.scale.x*(t+(1===n.scale.x?1:0))*i*r.width;return new $i(a,o)},e.getTilePointSE=function(t,e,i){var n=this._glRes/i,r=this.tileSystem,o=this.tileSize,a=this._pointOrigin.y*n+this._yScale*r.scale.y*(e+(1===r.scale.y?0:1))*o.height,s=this._pointOrigin.x*n+this._xScale*r.scale.x*(t+(1===r.scale.x?1:0))*o.width;return new ae(s,a)},e.getTilePrjExtent=function(t,e,i){var n=this.getTilePrjNW(t,e,i),r=this.getTilePrjSE(t,e,i);return new un(n,r)},t}(),gs=[],ys=0;ys<6;ys++)gs[ys]=[];var _s=[];function vs(t,e,i){var n,r,o,a,s,l,c,h,u,d,p,f,m,g,y,_,v;r=(n=t)[0],o=n[1],a=n[2],s=n[3],l=n[4],c=n[5],h=n[6],u=n[7],d=n[8],p=n[9],f=n[10],m=n[11],g=n[12],y=n[13],_=n[14],v=n[15],xs(gs[0],s-r,u-l,m-d,v-g),xs(gs[1],s+r,u+l,m+d,v+g),xs(gs[2],s+o,u+c,m+p,v+y),xs(gs[3],s-o,u-c,m-p,v-y),xs(gs[4],s-a,u-h,m-f,v-_),xs(gs[5],s+a,u+h,m+f,v+_);for(var x=0;x<6;x++)if(!i||"0"!==i.charAt(x)){var b=gs[x];if(_s[0]=b[0]>0?e[1][0]:e[0][0],_s[1]=b[1]>0?e[1][1]:e[0][1],_s[2]=b[2]>0?e[1][2]:e[0][2],bs(b,_s)<0)return!1}return!0}function xs(t,e,i,n,r){return t[0]=e*(1/6),t[1]=i*(1/6),t[2]=n*(1/6),t[3]=r*(1/6),t}function bs(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}var ws=new ae(0,0),Ms="undefined"!=typeof Set,Ts=function(){function t(){this._table=Ms?new Set:{}}var e=t.prototype;return e.add=function(t){Ms?this._table.add(t):this._table[t]=!0},e.has=function(t){return Ms?this._table.has(t):this._table[t]},e.reset=function(){Ms?this._table.clear():this._table={}},t}(),Ss={urlTemplate:null,subdomains:null,errorUrl:null,repeatWorld:!0,background:!0,backgroundZoomDiff:6,loadingLimitOnInteracting:3,tileRetryCount:0,placeholder:!1,crossOrigin:null,tileSize:[256,256],offset:[0,0],tileSystem:null,fadeAnimation:!u,debug:!1,spatialReference:null,maxCacheSize:256,renderer:O.webgl?"gl":"canvas",clipByPitch:!0,maxAvailableZoom:null,cascadeTiles:!0,zoomOffset:0,pyramidMode:1},Es=/\{ *([\w_]+) *\}/g,Cs=new ae(0,0),As=new ae(0,0),Ps=new ae(0,0),Ls=new ae(0,0),Is=new ae(0,0),Rs=new ae(0,0),Ds=[[0,0,0],[0,0,0]],ks=[0,0,0],Os=[0,0,0],zs=[],Bs=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t),e.fromJSON=function(t){return t&&"TileLayer"===t.type?new e(t.id,t.options):null};var i=e.prototype;return i.getTileSize=function(){if(this._tileSize)return this._tileSize;var t=this.options.tileSize;return N(t)&&(t=[t,t]),this._tileSize=new se(t),this._tileSize},i.getTiles=function(t,e){this._coordCache={};var i=this.getSpatialReference();return this.options.pyramidMode&&i&&i.isPyramid()?this._getPyramidTiles(t,e):this._getCascadeTiles(t,e)},i._getRootNode=function(){if(this._rootNode)return this._rootNode;var t=this.getMap(),e=Y(t.getFov()),i=this.map.width/this.map.height,n=t.cameraPosition[2],r=n*Math.tan(.5*e),o=r*i,a=Math.sqrt(n*n+r*r+o*o);return this._rootNode={x:0,y:0,z:0,idx:0,idy:0,extent2d:this._getTileConfig().getTilePrjExtent(0,0,t._getResolution(0)).convertTo((function(e){return t._prjToPoint(e,0,ws)})),id:this._getTileId(0,0,0),url:this.getTileUrl(0,0,this.options.zoomOffset),offset:[0,0],error:this._getRootError()*(a/n)},this._rootNode},i._getRootError=function(){return this.getMap()._getFovZ(0)},i._getPyramidTiles=function(t,e){var i=this.getMap();isNaN(+t)&&(t=this._getTileZoom(i.getZoom()));var n,r=Math.min(t,this.getMaxZoom()),o=i.projViewMatrix,a=this._getTileOffset(0),s=this._getRootNode();if(s.offset[0]=a[0],s.offset[1]=a[1],this.options.repeatWorld){var l=i.getContainerExtent(),c=this._convertToExtent2d(l),h=i.getResolution(0)/i.getResolution();if(c.within(s.extent2d.copy()._scale(h)))n=[s];else{var u=i.getPitch(),d=i.options.cascadePitches[1],p=Math.floor(i._getVisualHeight(d)),f=u<=d?l:new pn(0,i.height-p,i.width,i.height);this._visitedTiles=new Ts;var m=this._getTiles(0,f,2,e&&e.getRenderer());m.tiles.forEach((function(t){t.error=s.error})),n=m.tiles}}else n=[s];for(var g={0:a},y=new pn,_=[];n.length>0;){var v=n.pop();v.z!==r?(g[v.z+1]||(g[v.z+1]=this._getTileOffset(v.z+1)),this._splitNode(v,o,n,_,y,r,g[v.z+1],e&&e.getRenderer())):(y._combine(v.extent2d),_.push(v))}return{tileGrids:[{extent:y,count:_.length,tiles:_,offset:[0,0],zoom:t}],count:_.length}},i._splitNode=function(t,e,i,n,r,o,a,s){for(var l=t.z+1,c=t.x,h=t.y,u=t.extent2d,d=t.idx,p=t.idy,f=u.getWidth()/2*2,m=u.getHeight()/2*2,g=2*u.xmin,y=2*u.ymax,_=s||this.getRenderer(),v=!1,x=[],b=this.getMap().getGLScale(l),w=0;w<4;w++){var M=w%2,T=w>>1,S=(c<<1)+M,E=(h<<1)+T,C=(d<<1)+M,A=(p<<1)+T,P=g+M*f,L=y-T*m,I=this._getTileId(C,A,l),R=_.isTileCachedOrLoading(I),D=void 0;R||(D=new pn(P,L-m,P+f,L));var k=R&&R.info;k||(k={x:S,y:E,idx:C,idy:A,z:l,extent2d:D,error:t.error/2,id:I,url:this.getTileUrl(S,E,l+this.options.zoomOffset),offset:a},s&&(k.layer=this.getId())),k.offset[0]=a[0],k.offset[1]=a[1];var O=this._isTileVisible(k,e,b,o,a);if(1===O)v=!0;else{if(-1===O)continue;if(0===O&&l!==o)return n.push(t),void r._combine(t.extent2d)}x.push(k)}l===o?v?i.push.apply(i,x):(n.push(t),r._combine(t.extent2d)):i.push.apply(i,x)},i._isTileVisible=function(t,e,i,n,r){if(0===t.z)return 1;if(!this._isTileInFrustum(t,e,i,r))return-1;var o=this.options.maxError;return F(o)&&(o=1),this._getScreenSpaceError(t,i,n,r)>=o?1:0},i._isTileInFrustum=function(t,e,i,n){var r=t.extent2d,o=r.xmin,a=r.ymin,s=r.xmax,l=r.ymax;return Ds[0][0]=(o-n[0])*i,Ds[0][1]=(a-n[1])*i,Ds[1][0]=(s-n[0])*i,Ds[1][1]=(l-n[1])*i,vs(e,Ds)},i._getScreenSpaceError=function(t,e,i,n){var r=t.error,o=this.getMap(),a=t.extent2d,s=a.xmin,l=a.ymin,c=a.xmax,h=a.ymax;ks[0]=(s-n[0])*e,ks[1]=(l-n[1])*e,Os[0]=(c-n[0])*e,Os[1]=(h-n[1])*e;var u,d,p,f,m,g,y=(u=ks,d=Os,p=o.cameraPosition,f=Math.max(u[0]-p[0],0,p[0]-d[0]),m=Math.max(u[1]-p[1],0,p[1]-d[1]),g=Math.max(u[2]-p[2],0,p[2]-d[2]),Math.sqrt(f*f+m*m+g*g)),_=Math.max(Math.abs(y),1e-7),v=Math.abs(t.z-i);return r*(v<=1?1:v<=2?.7:.505)/_},i._getCascadeTiles=function(t,e){var i=this.getMap(),n=i.getPitch(),r=e&&e.getRenderer(),o=i.getContainerExtent(),a=[],s=0,l=this.getMinZoom(),c=i.options.cascadePitches[0],h=i.options.cascadePitches[1],u=Math.floor(i._getVisualHeight(h)),d=F(t)?this._getTileZoom(i.getZoom()):t;if(this._visitedTiles=new Ts,!F(t)||!this.options.cascadeTiles||n<=c||!F(l)&&d<=l){var p=n<=h?o:new pn(0,i.height-u,i.width,i.height),f=this._getTiles(d,p,2,r);return f&&(s+=f.tiles.length,a.push(f)),{tileGrids:a,count:s}}var m=Math.floor(i._getVisualHeight(c)),g=new pn(0,i.height-m,i.width,i.height),y=this._getTiles(d,g,0,r);s+=y?y.tiles.length:0,a.push(y);var _,v,x=g.ymin,b=i.getSpatialReference().getZoomDirection(),w=b;if(n>h){d-w<=l&&(w=0);var M=new pn(0,i.height-u,i.width,x);s+=(_=this._getTiles(d-w,M,1,r))?_.tiles.length:0,x=M.ymin,w+=4*b}if(d-w>=l){var T=new pn(0,o.ymin,i.width,x);s+=(v=this._getTiles(d-w,T,2,r))?v.tiles.length:0,a.push(v)}return _&&v&&(a[1]=v,a[2]=_),{tileGrids:a,count:s}},i.getTileUrl=function(t,e,i){var n=this.options.urlTemplate,r="";if(this.options.subdomains){var o=this.options.subdomains;if(dt(o)){var a=(t+e)%o.length;a<0&&(a=0),r=o[a]}}if(V(n))return n(t,e,i,r);var s={x:t,y:e,z:i,s:r};return n.replace(Es,(function(t,e){var i=s[e];if(void 0===i)throw new Error("No value provided for variable "+t);return"function"==typeof i&&(i=i(s)),i}))},i.clear=function(){return this._renderer&&this._renderer.clear(),this.fire("clear"),this},i.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}},i.getSpatialReference=function(){var t=this.getMap();return!t||this.options.spatialReference&&!Vr.equals(this.options.spatialReference,t.options.spatialReference)?(this._sr=this._sr||new Vr(this.options.spatialReference),void 0===this._srMinZoom&&(this._srMinZoom=this._sr.getMinZoom(),this._srMaxZoom=this._sr.getMaxZoom()),this._sr):t.getSpatialReference()},i.getMinZoom=function(){return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.max(t.prototype.getMinZoom.call(this),this._srMinZoom):t.prototype.getMinZoom.call(this)},i.getMaxZoom=function(){return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.min(t.prototype.getMaxZoom.call(this),this._srMaxZoom):t.prototype.getMaxZoom.call(this)},i._getTileZoom=function(t){j(t)||(t=Math.round(t));var e=this.options.maxAvailableZoom;return!F(e)&&t>e&&(t=e),t},i._getTiles=function(t,e,i,n){var r=this.getMap(),o=t,a=r.projViewMatrix;i<2&&(0===i&&(o-=1),a=0===i?r.cascadeFrustumMatrix0:1===i?r.cascadeFrustumMatrix1:r.projViewMatrix);var s=o+this.options.zoomOffset,l=this._getTileOffset(s),c=l[0]||l[1],h={zoom:o,extent:null,offset:l,tiles:[]};if(s<0)return h;var u=this.getMinZoom(),d=this.getMaxZoom();if(!(r&&this.isVisible()&&r.width&&r.height))return h;if(!F(u)&&o<u||!F(d)&&o>d)return h;var p=this._getTileConfig();if(!p)return h;var f={zoom:l},m=this.getSpatialReference(),g=r.getSpatialReference(),y=m.getResolution(s),_=r.getGLScale(o),v=m===g&&this.options.repeatWorld,x=this._convertToExtent2d(e),b=this._getMask2DExtent();if(b){var w=b.intersection(x);if(!w)return h;e=w.convertTo((function(t){return r._pointToContainerPoint(t,void 0,0,ws)}))}var M,T=r._containerPointToPrj(e.getCenter(),Cs),S=r._prjToPoint(T,s,As);M=c?this._project(r._pointToPrj(S._add(l),s,As),As):this._project(T,As);var E=r.getGLScale()/r.getGLScale(s);Ps.x=x.xmin*E,Ps.y=x.ymax*E,Ls.x=x.xmax*E,Ls.y=x.ymin*E;for(var C=this._project(r._pointToPrj(Ps._add(l),s,Ps),Ps),A=this._project(r._pointToPrj(Ls._add(l),s,Ls),Ls),P=p.getTileIndex(M,y,v),L=p.getTileIndex(C,y,v),I=p.getTileIndex(A,y,v),R=Math.ceil(Math.abs(P.idy-L.idy)),D=Math.ceil(Math.abs(P.idx-L.idx)),k=Math.ceil(Math.abs(P.idy-I.idy)),O=Math.ceil(Math.abs(P.idx-I.idx)),z=(R+k+1)*(D+O+1),B=this.getTileSize(),N=this.getRenderer()||n,j=this._getTileConfig().tileSystem.scale,G=[],U=new pn,V=new ae(0,0),H=-R;H<=k;H++)for(var Z=-D,W=-1/0,q=!1;Z>=W&&Z<=O;){var X=p.getNeighorTileIndex(P.idx,P.idy,Z,H,y,v);W===-1/0?Z++:Z--;var Y=this._getTileId(X.idx,X.idy,o);if(!(X.out||this._visitedTiles&&this._visitedTiles.has(Y))){var $=N&&N.isTileCachedOrLoading(Y);$&&($=$.info);var J=void 0;if($){var K=$.extent2d;V.set(K.xmin,K.ymax),J=V}else if(this._hasOwnSR){var Q=p.getTilePrjNW(X.x,X.y,y);J=r._prjToPoint(this._unproject(Q,Ls),o)}else J=p.getTilePointNW(X.x,X.y,y);var tt=void 0,et=void 0;if(m===g)tt=B.width,et=B.height;else{var it=void 0;if(this._hasOwnSR){var nt=p.getTilePrjSE(X.x,X.y,y);it=r._prjToPoint(this._unproject(nt,Ls),o,Ls)}else it=p.getTilePointSE(X.x,X.y,y);tt=Math.ceil(Math.abs(it.x-J.x)),et=Math.ceil(Math.abs(it.y-J.y))}var rt=j.x*(X.idx-X.x)*tt,ot=j.y*(X.idy-X.y)*et;$||!rt&&!ot||J._add(rt,ot);var at=$&&$.extent2d||new pn(J.x,J.y-et,J.x+tt,J.y);(z<=4||q||this._isTileInExtent(a,at,l,_))&&(this._visitedTiles&&0===i&&this._visitedTiles.add(Y),0===i?(this._splitTiles(a,G,N,X,o+1,at,rt,ot,f,n),U._combine(at)):($?($.offset[0]=l[0],$.offset[1]=l[1]):($={z:o,x:X.x,y:X.y,idx:X.idx,idy:X.idy,extent2d:at,offset:l,id:Y,url:this.getTileUrl(X.x,X.y,o)},n&&($.layer=this.getId())),G.push($),U._combine(at)),W===-1/0?(W=Z,Z=O):q||(q=!0))}}if(G.length){var st=r._containerPointToPoint(e.getCenter(),o,ws)._add(l),lt=new ae(0,0),ct=new ae(0,0);G.sort((function(t,e){return lt.set((t.extent2d.xmin+t.extent2d.xmax)/2,(t.extent2d.ymin+t.extent2d.ymax)/2),ct.set((e.extent2d.xmin+e.extent2d.xmax)/2,(e.extent2d.ymin+e.extent2d.ymax)/2),lt.distanceTo(st)-ct.distanceTo(st)}))}return{offset:l,zoom:t,extent:U,tiles:G}},i._convertToExtent2d=function(t){var e=this,i=this.getMap();return t.convertTo((function(t){if(t.y>0&&t.y<i.height){var n=(0===t.x?0:1)+t.y;e._coordCache[n]||(e._coordCache[n]=i._containerPointToPoint(t)),e._coordCache[n]}return i._containerPointToPoint(t,void 0,ws)}))},i._splitTiles=function(t,e,i,n,r,o,a,s,l,c){var h=this._getTileConfig().tileSystem.scale.y,u=this.getMap().getGLScale(r),d=Is.set(2*o.xmin,h<0?2*o.ymax:2*o.ymin),p=o.getWidth(),f=o.getHeight(),m=2*n.idx,g=2*n.idy,y=2*n.x,_=2*n.y,v=this._checkAndAddTile(t,i,m,g,y,_,r,0,0,p,f,d,u,l,c);v&&e.push(v),(v=this._checkAndAddTile(t,i,m,g,y,_,r,0,1,p,f,d,u,l,c))&&e.push(v),(v=this._checkAndAddTile(t,i,m,g,y,_,r,1,0,p,f,d,u,l,c))&&e.push(v),(v=this._checkAndAddTile(t,i,m,g,y,_,r,1,1,p,f,d,u,l,c))&&e.push(v)},i._checkAndAddTile=function(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f){var m=this._getTileId(i+s,n+l,a);if(this._visitedTiles&&this._visitedTiles.has(m))return null;var g=p[a];g||(g=p[a]=this._getTileOffset(a));var y=this._getTileConfig().tileSystem.scale.y,_=new pn(u.x+s*c,u.y+y*l*h,u.x+(s+1)*c,u.y+y*(l+1)*h);if(!this._isSplittedTileInExtent(t,_,g,d))return null;var v=e&&e.isTileCachedOrLoading(m);return v?v=v.info:(v={z:a,x:r+s,y:o+l,extent2d:_,id:m,offset:g,url:this.getTileUrl(r+s,o+l,a+this.options.zoomOffset)},f&&(v.layer=this.getId())),v},i._getTileOffset=function(t){var e=this.options.offset;return V(e)&&(e=e(t)),e},i._getTileId=function(t,e,i,n){return(n||this.getId())+"_"+e+"_"+t+"_"+i},i._project=function(t,e){if(this._hasOwnSR){var i=this.getMap().getProjection();return this.getSpatialReference().getProjection().project(i.unproject(t,e),e)}return t},i._unproject=function(t,e){if(this._hasOwnSR){var i=this.getMap(),n=this.getSpatialReference(),r=i.getProjection(),o=n.getProjection();return r.project(o.unproject(t,e),e)}return t},i._initTileConfig=function(){var t=this.getMap(),e=this.getTileSize(),i=this.getSpatialReference(),n=i.getProjection(),r=i.getFullExtent();this._defaultTileConfig=new ms(t,ps.getDefault(n),r,e),this.options.tileSystem&&(this._tileConfig=new ms(t,this.options.tileSystem,r,e)),this._hasOwnSR=i!==t.getSpatialReference(),delete this._rootNode},i._getTileConfig=function(){return this._defaultTileConfig||this._initTileConfig(),this._tileConfig||this._defaultTileConfig},i._bindMap=function(e){var i=e.getBaseLayer();return i===this&&(i.options.hasOwnProperty("forceRenderOnMoving")||this.config({forceRenderOnMoving:!0})),t.prototype._bindMap.apply(this,arguments)},i._isTileInExtent=function(t,e,i,n){var r,o=this.getMap();if(t!==o.projViewMatrix){var a=e.getCenter(Rs)._sub(i[0],i[1])._multi(n);_a(zs,a.x,a.y,0),r=function(t,e,i){var n=e[0],r=e[1],o=e[2],a=i[3]*n+i[7]*r+i[11]*o+i[15];return a=a||1,t[0]=(i[0]*n+i[4]*r+i[8]*o+i[12])/a,t[1]=(i[1]*n+i[5]*r+i[9]*o+i[13])/a,t[2]=(i[2]*n+i[6]*r+i[10]*o+i[14])/a,t}(zs,zs,o.projViewMatrix)[1]<0?o.projViewMatrix:t}else r=o.projViewMatrix;return Ds[0][0]=(e.xmin-i[0])*n,Ds[0][1]=(e.ymin-i[1])*n,Ds[1][0]=(e.xmax-i[0])*n,Ds[1][1]=(e.ymax-i[1])*n,vs(r,Ds)},i._isSplittedTileInExtent=function(t,e,i,n){var r=this.getMap();return Ds[0][0]=(e.xmin-i[0])*n,Ds[0][1]=(e.ymin-i[1])*n,Ds[1][0]=(e.xmax-i[0])*n,Ds[1][1]=(e.ymax-i[1])*n,vs(r.projViewMatrix,Ds)},i.getEvents=function(){return{spatialreferencechange:this._onSpatialReferenceChange}},i._onSpatialReferenceChange=function(){delete this._tileConfig,delete this._defaultTileConfig,delete this._sr;var t=this.getRenderer();t&&t.clear()},e}(Xr);Bs.registerJSONType("TileLayer"),Bs.mergeOptions(Ss);var Fs=function(t){function e(e,i,n){var r;return(r=t.call(this,e,n)||this).layers=i||[],r._checkChildren(),r.layerMap={},r._groupChildren=[],r}ne(e,t),e.fromJSON=function(t){if(!t||"GroupTileLayer"!==t.type)return null;var i=t.layers.map((function(t){return Xr.fromJSON(t)}));return new e(t.id,i,t.options)};var i=e.prototype;return i.getLayers=function(){return this.layers},i.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),layers:this.layers.map((function(t){return t.toJSON()})),options:this.config()}},i.getTiles=function(t){for(var e=this.layers,i=[],n=0,r=0,o=e.length;r<o;r++){var a=e[r];if(a.options.visible){var s=a.getTiles(t,this);s&&0!==s.count&&(n+=s.count,nt(i,s.tileGrids))}}return{count:n,tileGrids:i}},i.onAdd=function(){var e=this,i=this.getMap();this.layers.forEach((function(t){e.layerMap[t.getId()]=t,t.getChildLayer&&e._groupChildren.push(t),t._bindMap(i),t.on("show hide",e._onLayerShowHide,e)})),t.prototype.onAdd.call(this)},i.onRemove=function(){var e=this;this.layers.forEach((function(t){t._doRemove(),t.off("show hide",e._onLayerShowHide,e)})),this.layerMap={},this._groupChildren=[],t.prototype.onRemove.call(this)},i.getChildLayer=function(t){var e=this.layerMap[t];if(e)return e;for(var i=0;i<this._groupChildren.length;i++){var n=this._groupChildren[i].getChildLayer(t);if(n)return n}return null},i._onLayerShowHide=function(){var t=this.getRenderer();t&&t.setToRedraw()},i.isVisible=function(){if(!t.prototype.isVisible.call(this))return!1;for(var e=this.layers,i=0,n=e.length;i<n;i++)if(e[i].isVisible())return!0;return!1},i._checkChildren=function(){var t=this,e={};this.layers.forEach((function(i){var n=i.getId();if(e[n])throw new Error("Duplicate child layer id ("+n+") in the GroupTileLayer ("+t.getId()+")");e[n]=1}))},e}(Bs);Fs.registerJSONType("GroupTileLayer"),Fs.mergeOptions({maxCacheSize:1024});var Ns={crs:null,uppercase:!1,detectRetina:!1},js={service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},Gs=function(t){function e(e,i){var n;n=t.call(this,e)||this;var r=B({},js);for(var o in i)o in n.options||(r[o]=i[o]);n.setOptions(i),n.setZIndex(i.zIndex);var a=n.getTileSize();return r.width=a.width,r.height=a.height,n.wmsParams=r,n._wmsVersion=parseFloat(r.version),n}ne(e,t);var i=e.prototype;return i.onAdd=function(){var e=this.getMap().getDevicePixelRatio(),i=Ns.detectRetina?e:1;this.wmsParams.width*=i,this.wmsParams.height*=i;var n=this.options.crs||this.getMap().getProjection().code,r=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[r]=n,t.prototype.onAdd.call(this)},i.getTileUrl=function(e,i,n){var r=this.getSpatialReference().getResolution(n),o=this._getTileConfig().getTilePrjExtent(e,i,r),a=o.getMax(),s=o.getMin(),l=(this._wmsVersion>=1.3&&"EPSG:4326"===this.wmsParams.crs?[s.y,s.x,a.y,a.x]:[s.x,s.y,a.x,a.y]).join(","),c=t.prototype.getTileUrl.call(this,e,i,n);return c+function(t,e,i){var n=[];for(var r in t)n.push(encodeURIComponent(i?r.toUpperCase():r)+"="+encodeURIComponent(t[r]));return(e&&-1!==e.indexOf("?")?"&":"?")+n.join("&")}(this.wmsParams,c,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+l},i.toJSON=function(){return{type:"WMSTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"WMSTileLayer"===t.type?new e(t.id,t.options):null},e}(Bs);Gs.registerJSONType("WMSTileLayer"),Gs.mergeOptions(Ns);var Us=function(t){function e(e,i){var n;return(n=t.call(this,e,i)||this).options.hasOwnProperty("forceRenderOnMoving")||(n.options.forceRenderOnMoving=!1),n}ne(e,t);var i=e.prototype;return i.drawTile=function(){},i.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"CanvasTileLayer"===t.type?new e(t.id,t.options):null},e}(Bs);function Vs(t,e,i){var n=t.createShader(e);if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){var r=t.getShaderInfoLog(n);throw t.deleteShader(n),new Error("Failed to compile shader: "+r)}return n}function Hs(t,e,i){var n=Vs(t,t.VERTEX_SHADER,e),r=Vs(t,t.FRAGMENT_SHADER,i);if(!n||!r)return null;var o=t.createProgram();return o?(t.attachShader(o,n),t.attachShader(o,r),t.linkProgram(o),{program:o,vertexShader:n,fragmentShader:r}):null}function Zs(t,e,i){if(Array.isArray(i[0])){for(var n=Float32Array.BYTES_PER_ELEMENT,r=0,o=0;o<i.length;o++)r+=i[o][1]||0;for(var a=0,s=0;s<i.length;s++){var l=t.getAttribLocation(e,i[s][0]);if(l<0)throw new Error("Failed to get the storage location of "+i[s][0]);t.vertexAttribPointer(l,i[s][1],t[i[s][2]||"FLOAT"],!1,n*r,n*a),a+=i[s][1]||0,t.enableVertexAttribArray(l)}}else{var c=t.getAttribLocation(e,i[0]);t.vertexAttribPointer(c,i[1],t[i[2]||"FLOAT"],!1,0,0),t.enableVertexAttribArray(c)}}Us.registerJSONType("CanvasTileLayer");var Ws="\n        attribute vec2 a_position;\n\n        attribute vec2 a_texCoord;\n\n        uniform mat4 u_matrix;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            gl_Position = u_matrix * vec4(a_position, 0., 1.);\n\n            v_texCoord = a_texCoord;\n        }\n    ",qs="\n        precision mediump float;\n\n        uniform sampler2D u_image;\n\n        uniform float u_opacity;\n        uniform float u_debug_line;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            if (u_debug_line == 1.) {\n                gl_FragColor = vec4(0., 1., 0., 1.);\n            } else {\n                gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;\n            }\n        }\n    ",Xs=[0,0],Ys=[0,0,0],$s=new Array(16),Js=new ae(20,20),Ks=function(t){var e,i=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.drawGLImage=function(t,e,i,n,r,o,a,s){this.gl.program!==this.program&&this.useProgram(this.program);var l=this.gl;this.loadTexture(t),Ys[0]=e||0,Ys[1]=i||0;var c=ga($s);da(c,c,Ys),pa(c,c,[o,o,1]),fa(c,this.getMap().projViewMatrix,c),l.uniformMatrix4fv(this.program.u_matrix,!1,c),l.uniform1f(this.program.u_opacity,a),l.uniform1f(this.program.u_debug_line,0);var h=t.glBuffer;!h||h.width===n&&h.height===r||(this.saveImageBuffer(h),delete t.glBuffer),t.glBuffer?l.bindBuffer(l.ARRAY_BUFFER,h):t.glBuffer=this.bufferTileData(0,0,n,r),Xs[0]="a_position",Xs[1]=2,Xs[2]=t.glBuffer.type,this.enableVertexAttrib(Xs),l.drawArrays(l.TRIANGLE_STRIP,0,4),s&&this.drawDebug(c,Xs,0,0,n,r,s)},i.drawDebug=function(t,e,i,n,r,o,a){var s=this.gl;s.bindBuffer(s.ARRAY_BUFFER,this._debugBuffer),this.enableVertexAttrib(["a_position",2,"FLOAT"]),s.bufferData(s.ARRAY_BUFFER,new Float32Array([i,n,i+r,n,i+r,n-o,i,n-o,i,n]),s.DYNAMIC_DRAW),s.uniformMatrix4fv(this.program.u_matrix,!1,t),s.uniform1f(this.program.u_debug_line,1),s.drawArrays(s.LINE_STRIP,0,5);var l=this._debugInfoCanvas;if(!l){var c=this.getMap().getDevicePixelRatio()>1?2:1;(l=this._debugInfoCanvas=document.createElement("canvas")).width=256*c,l.height=32*c;var h=l.getContext("2d");h.font="20px monospace",h.scale(c,c)}var u=l.getContext("2d");u.clearRect(0,0,l.width,l.height);var d=this.layer.options.debugOutline;fi.fillText(u,a,Js,d),this.loadTexture(l),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,l);var p=i,f=i+(r=256),m=n,g=n-(o=32);s.bufferData(s.ARRAY_BUFFER,this.set8(p,m,p,g,f,m,f,g),s.DYNAMIC_DRAW),s.uniform1f(this.program.u_debug_line,0),s.drawArrays(s.TRIANGLE_STRIP,0,4)},i.bufferTileData=function(t,e,i,n,r){var o,a=t,s=t+i,l=e,c=e-n;o=j(a)&&j(s)&&j(l)&&j(c)?this.set8Int(a,l,a,c,s,l,s,c):this.set8(a,l,a,c,s,l,s,c);var h=this.loadImageBuffer(o,r);return h.width=i,h.height=n,h.type=o instanceof Int16Array?"SHORT":"FLOAT",h},i.drawTinImage=function(t,e,i,n,r){var o=this.gl;this.loadTexture(t),o.uniformMatrix4fv(this.program.u_matrix,!1,this.getMap().projViewMatrix),o.uniform1f(this.program.u_opacity,r),o.bindBuffer(o.ARRAY_BUFFER,this.posBuffer),this.enableVertexAttrib(["a_position",3]),o.bufferData(o.ARRAY_BUFFER,new Float32Array(e),o.DYNAMIC_DRAW),o.bindBuffer(o.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2]),o.bufferData(o.ARRAY_BUFFER,new Float32Array(i),o.DYNAMIC_DRAW),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),o.DYNAMIC_DRAW),o.drawElements(o.TRIANGLES,n.length,o.UNSIGNED_SHORT,0)},i.createCanvas2=function(){this.canvas2=fi.createCanvas(this.canvas.width,this.canvas.height)},i.createGLContext=function(){this.canvas.gl&&this.canvas.gl.wrap?this.gl=this.canvas.gl.wrap():this.gl=function(t,e){for(var i={alpha:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!1},n=["webgl","experimental-webgl"],r=null,o=0;o<n.length;++o){try{r=t.getContext(n[o],e||i)}catch(t){}if(r)break}return r}(this.canvas2||this.canvas,this.layer.options.glOptions);var t=this.gl;t.clearColor(0,0,0,0),t.disable(t.DEPTH_TEST),t.enable(t.STENCIL_TEST),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),this.program=this.createProgram(Ws,this.layer.options.fragmentShader||qs),this._debugBuffer=this.createBuffer(),this.useProgram(this.program),this.texBuffer=this.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),t.bufferData(t.ARRAY_BUFFER,new Uint8Array([0,0,0,1,1,0,1,1]),t.STATIC_DRAW),this.enableSampler("u_image"),t.activeTexture(t.TEXTURE0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)},i.resizeGLCanvas=function(){this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas2&&(this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.width=this.canvas.width,this.canvas2.height=this.canvas.height))},i.clearGLCanvas=function(){this.gl&&this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT)},i.disposeImage=function(t){t&&(t.texture&&this.saveTexture(t.texture),t.glBuffer&&this.saveImageBuffer(t.glBuffer),delete t.texture,delete t.glBuffer)},i._createTexture=function(t){var e=this.gl,i=this.getTexture()||e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),j(lt(t.width))&&j(lt(t.width))&&e.generateMipmap(e.TEXTURE_2D),i},i.getTexture=function(){this._textures||(this._textures=[]);var t=this._textures;return t&&t.length>0?t.pop():null},i.saveTexture=function(t){this._textures.push(t)},i.loadTexture=function(t){var e=this.gl,i=t.texture;return i||(i=this._createTexture(t),t.texture=i),e.bindTexture(e.TEXTURE_2D,i),i},i.getImageBuffer=function(){this._imageBuffers||(this._imageBuffers=[]);var t=this._imageBuffers;return t&&t.length>0?t.pop():null},i.saveImageBuffer=function(t){this._imageBuffers.push(t)},i.loadImageBuffer=function(t,e){var i=this.gl,n=e||this.createImageBuffer();return i.bindBuffer(i.ARRAY_BUFFER,n),i.bufferData(i.ARRAY_BUFFER,t,i.STATIC_DRAW),n},i.createImageBuffer=function(){return this.getImageBuffer()||this.createBuffer()},i.removeGLCanvas=function(){var t=this.gl;if(t){if(this._debugBuffer&&(t.deleteBuffer(this._debugBuffer),delete this._debugBuffer),this._buffers&&(this._buffers.forEach((function(e){t.deleteBuffer(e)})),delete this._buffers),this._textures&&(this._textures.forEach((function(e){return t.deleteTexture(e)})),delete this._textures),this._debugInfoCanvas){var e=this._debugInfoCanvas.texture;e&&t.deleteTexture(e),delete this._debugInfoCanvas.texture,delete this._debugInfoCanvas}var i=t.program;t.deleteShader(i.fragmentShader),t.deleteShader(i.vertexShader),t.deleteProgram(i),delete this.gl,delete this.canvas2}},i.createBuffer=function(){var t=this.gl.createBuffer();if(!t)throw new Error("Failed to create the buffer object");return this._buffers||(this._buffers=[]),this._buffers.push(t),t},i.enableVertexAttrib=function(t){Zs(this.gl,this.gl.program,t)},i.createProgram=function(t,e){for(var i=this.gl,n=Hs(i,t,e),r=n.program,o=n.vertexShader,a=n.fragmentShader,s=i.getProgramParameter(r,35718),l=[],c=0;c<s;++c){var h=i.getActiveUniform(r,c);l.push(h.name)}return r.vertexShader=o,r.fragmentShader=a,this._initUniforms(r,l),r},i.useProgram=function(t){var e=this.gl;return e.useProgram(t),e.program=t,this},i.enableSampler=function(t,e){var i=this.gl,n=this._getUniform(i.program,t);return e||(e=0),i.uniform1i(n,e),n},i._initUniforms=function(t,e){for(var i=0;i<e.length;i++){var n=e[i],r=e[i],o=n.indexOf("[");o>=0&&(n=n.substring(0,o),u||(r=r.substring(0,o))),t[n]=this._getUniform(t,r)}},i._getUniform=function(t,e){var i=this.gl.getUniformLocation(t,e);if(!i)throw new Error("Failed to get the storage location of "+e);return i},e}(t);return B(i.prototype,{set8:(e=O.ie9?null:new Float32Array(8),function(t,i,n,r,o,a,s,l){return e[0]=t,e[1]=i,e[2]=n,e[3]=r,e[4]=o,e[5]=a,e[6]=s,e[7]=l,e}),set8Int:function(){var t=O.ie9?null:new Int16Array(8);return function(e,i,n,r,o,a,s,l){return t[0]=e,t[1]=i,t[2]=n,t[3]=r,t[4]=o,t[5]=a,t[6]=s,t[7]=l,t}}()}),i},Qs={renderer:O.webgl?"gl":"canvas",crossOrigin:null},tl=new ae(0,0),el=function(t){function e(e,i,n){var r;return!i||Array.isArray(i)||i.url||(n=i,i=null),(r=t.call(this,e,n)||this)._images=i,r}ne(e,t);var i=e.prototype;return i.onAdd=function(){this._prepareImages(this._images)},i.setImages=function(t){return this._images=t,this._prepareImages(t),this},i.getImages=function(){return this._images},i._prepareImages=function(t){t=t||[],Array.isArray(t)||(t=[t]);var e=this.getMap();this._imageData=t.map((function(t){var i=new un(t.extent);return B({},t,{extent:i,extent2d:i.convertTo((function(t){return e.coordToPoint(t,e.getGLZoom())}))})})),this._images=t;var i=this.getRenderer();i&&i.refreshImages()},e}(Xr);el.mergeOptions(Qs);var il=[],nl=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("ImageLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),!1)},i.checkResources=function(){var t=this;if(this._imageLoaded)return il;var e=this.layer._imageData.map((function(t){return[t.url,null,null]}));if(this.resources){var i=[],n=new On;e.forEach((function(e){if(t.resources.isResourceLoaded(e)){var r=t.resources.getImage(e);n.addResource(e,r)}else i.push(e)})),this.resources.forEach((function(e,i){n.isResourceLoaded(e)||t.retireImage(i.image)})),this.resources=n,e=i}return this._imageLoaded=!0,e},i.retireImage=function(){},i.refreshImages=function(){this._imageLoaded=!1,this.setToRedraw()},i.needToRedraw=function(){var e=this.getMap();return!(e.isZooming()&&!e.getPitch())&&t.prototype.needToRedraw.call(this)},i.draw=function(){this.isDrawable()&&(this.prepareCanvas(),this._painted=!1,this._drawImages(),this.completeRender())},i._drawImages=function(){var t=this.layer._imageData,e=this.getMap(),i=e._get2DExtent(e.getGLZoom());if(t&&t.length)for(var n=0;n<t.length;n++){var r=t[n].extent2d,o=this.resources&&this.resources.getImage(t[n].url);o&&i.intersects(r)&&(this._painted=!0,this._drawImage(o,r,t[n].opacity||1))}},i._drawImage=function(t,e,i){var n=0,r=this.context;i<1&&(n=r.globalAlpha,r.globalAlpha=i);var o=this.getMap(),a=tl.set(e.xmin,e.ymax),s=o._pointToContainerPoint(a,o.getGLZoom()),l=s.x,c=s.y,h=o.getBearing();h&&(r.save(),r.translate(l,c),h&&r.rotate(-h*Math.PI/180),l=c=0);var u=o.getGLScale();r.drawImage(t,l,c,e.getWidth()/u,e.getHeight()/u),h&&r.restore(),n&&(r.globalAlpha=n)},i.drawOnInteracting=function(){this.draw()},e}(kn),rl=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.isDrawable=function(){return!0},i._drawImage=function(t,e,i){this.drawGLImage(t,e.xmin,e.ymax,e.getWidth(),e.getHeight(),1,i)},i.createContext=function(){this.createGLContext()},i.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},i.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},i.retireImage=function(t){this.disposeImage(t)},i.onRemove=function(){this.removeGLCanvas(),t.prototype.onRemove.call(this)},e}(Ks(nl));el.registerRenderer("canvas",nl),el.registerRenderer("gl",rl);var ol=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getPrepareParams=function(){return[]},i.getDrawParams=function(){return[]},i.onCanvasCreate=function(){this.canvas&&this.layer.options.doubleBuffer&&(this.buffer=fi.createCanvas(this.canvas.width,this.canvas.height,this.getMap().CanvasClass))},i.needToRedraw=function(){return!!this.layer.options.animation||!(this.getMap().isInteracting()&&!this.layer.drawOnInteracting)&&t.prototype.needToRedraw.call(this)},i.draw=function(){this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer()},i.drawOnInteracting=function(){this._drawLayerOnInteracting()},i.getCanvasImage=function(){var e=t.prototype.getCanvasImage.call(this);if(e&&e.image&&this.layer.options.doubleBuffer){var i=e.image;this.buffer.width===i.width&&this.buffer.height===i.height||(this.buffer.width=i.width,this.buffer.height=i.height);var n=this.buffer.getContext("2d"),r=this.layer.doubleBuffer(n,this.context);(void 0===r||r)&&(fi.image(n,i,0,0),e.image=this.buffer)}return e},i.remove=function(){return delete this._drawContext,t.prototype.remove.call(this)},i.onZoomStart=function(e){this.layer.onZoomStart(e),t.prototype.onZoomStart.call(this,e)},i.onZooming=function(e){this.layer.onZooming(e),t.prototype.onZooming.call(this,e)},i.onZoomEnd=function(e){this.layer.onZoomEnd(e),t.prototype.onZoomEnd.call(this,e)},i.onMoveStart=function(e){this.layer.onMoveStart(e),t.prototype.onMoveStart.call(this,e)},i.onMoving=function(e){this.layer.onMoving(e),t.prototype.onMoving.call(this,e)},i.onMoveEnd=function(e){this.layer.onMoveEnd(e),t.prototype.onMoveEnd.call(this,e)},i.onResize=function(e){this.layer.onResize(e),t.prototype.onResize.call(this,e)},i.prepareDrawContext=function(){if(!this._predrawed){var t=al(this.getPrepareParams());this._drawContext=this.layer.prepareToDraw.apply(this.layer,[this.context].concat(t)),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0}},i._prepareDrawParams=function(){if(!this.getMap())return null;var t=this.getViewExtent();if(t.maskExtent&&!t.extent.intersects(t.maskExtent))return this.completeRender(),null;var e=[this.context,t],i=al(this.getDrawParams());return e.push.apply(e,i),e.push.apply(e,this._drawContext),e},i._drawLayer=function(){var t=this._prepareDrawParams();t&&(this.layer.draw.apply(this.layer,t),this.completeRender())},i._drawLayerOnInteracting=function(){if(this.layer.drawOnInteracting){var t=this._prepareDrawParams();t&&(this.layer.drawOnInteracting.apply(this.layer,t),this.completeRender())}},e}(kn);function al(t){return t||(t=[]),Array.isArray(t)||(t=[t]),t}var sl=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.isCanvasRender=function(){return!0},i.prepareToDraw=function(){},i.draw=function(){},i.redraw=function(){return this._getRenderer()&&this._getRenderer().setToRedraw(),this},i.play=function(){return this.config("animation",!0),this},i.pause=function(){return this.config("animation",!1),this},i.isPlaying=function(){return this.options.animation},i.clearCanvas=function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},i.requestMapToRender=function(){return this._getRenderer()&&this._getRenderer().requestMapToRender(),this},i.completeRender=function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},i.onCanvasCreate=function(){return this},i.onZoomStart=function(){},i.onZooming=function(){},i.onZoomEnd=function(){},i.onMoveStart=function(){},i.onMoving=function(){},i.onMoveEnd=function(){},i.onResize=function(){},i.doubleBuffer=function(t){return t.clearRect(0,0,t.canvas.width,t.canvas.height),this},e}(Xr);sl.mergeOptions({doubleBuffer:!1,animation:!1}),sl.registerRenderer("canvas",ol);var ll=new ae(0,0),cl=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getParticles=function(){},i.draw=function(t,e){var i=this.getParticles(z());if(i&&0!==i.length){var n=this.getMap(),r=e.extent;e.maskExtent&&(r=e.extent.intersection(e.maskExtent)),r=r.convertTo((function(t){return n._pointToContainerPoint(t,void 0,0,ll)}));for(var o=2*Math.PI,a=0,s=i.length;a<s;a++){var l=i[a].point;if(r.contains(l)){var c=i[a].color||this.options.lineColor||"#fff",h=i[a].r;t.fillStyle!==c&&(t.fillStyle=c),h<=2?t.fillRect(l.x-h/2,l.y-h/2,h,h):(t.beginPath(),t.arc(l.x,l.y,h/2,0,o),t.fill())}}this._fillCanvas(t)}else{this._getRenderer()&&(this._getRenderer()._shouldClear=!0)}},i._fillCanvas=function(t){var e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out";var i=this.options.trail||30;t.fillStyle="rgba(0, 0, 0, "+1/i+")",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation=e},e}(sl);cl.mergeOptions({animation:!0}),cl.registerRenderer("canvas",function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.draw=function(){this.canvas&&this.layer.options.animation&&!this._shouldClear||(this.prepareCanvas(),this._shouldClear=!1),this.prepareDrawContext(),this._drawLayer()},i.drawOnInteracting=function(){this.draw(),this._shouldClear=!1},i.onSkipDrawOnInteracting=function(){this._shouldClear=!0},e}(ol));var hl,ul,dl=new On,pl=function(t){function e(e,i,n){var r;(r=t.call(this,n)||this).target=e,e.once("remove",r.delete,re(re(r)));var o=r.options.symbol,a=o.markerLineWidth||1;return r.w=o.markerWidth+a,r.h=o.markerHeight+a,r.dx=o.markerDx||0,r.dy=o.markerDy||0,r.opacity=o.opacity||1,r.map=i,r.events=n.events,r._fetchImage(),r.addTo(i),r}ne(e,t);var i=e.prototype;return i.getCursor=function(){return this.options.cursor||"default"},i._fetchImage=function(){var t=this.map,e=this.options.symbol,i=e.markerFile;this.url=i||ti(e);var n=dl.getImage(this.url);if(!n){var r=this.w,o=this.h;if(i)(n=new Image).onload=function(){var e=t.getRenderer();e&&e.setToRedraw()},n.src=this.url;else{var a=document.createElement("canvas");a.width=r,a.height=o,n=dr(a.getContext("2d"),{x:r/2,y:o/2},e,dl)}dl.addResource([this.url,r,o],n)}dl.login(this.url),this._img=n},i.setContainerPoint=function(t){this._point=t,this._point._sub(this.w/2,this.h/2)},i.getContainerPoint=function(){return this._point.add(this.w/2,this.h/2)},i.offset=function(t){this._point._add(t)},i.render=function(t){if(!this._img)return!1;var e=this.map,i=this._point,n=i.x,r=i.y,o=this.w,a=this.h;if(n+o>0&&n<e.width&&r+a>0&&r<e.height){var s=e.getDevicePixelRatio();return t.globalAlpha=this.opacity,t.drawImage(this._img,Math.round((n+this.dx)*s)+this.dx,Math.round((r+this.dy)*s),Math.round(o*s),Math.round(a*s)),!0}return!1},i.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}dl.logout(this.url),this._dragger&&(this._dragger.disable(),delete this._dragger),delete this.map},i.hitTest=function(t){var e=this.w,i=this.h,n=this._point.x+this.dx,r=this._point.y+this.dy;return t.x>=n&&t.x<=n+e&&t.y>=r&&t.y<=r+i},i.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},i.onEvent=function(t){this.fire(t.type,t)},i.mousedown=function(t){var e=t.target,i=this.options.cursor;i&&e.setCursor(i),this.onDragstart(t)},i.onDragstart=function(t){var e=t.containerPoint,i=t.target,n=i._panels.mapWrapper||i._containerDOM,r=this._dragger=new Yi(n);r.on("dragging",this.onDragging,this).on("mouseup",this.onDragend,this).enable(),r.type="handle",r.onMouseDown(t.domEvent),hl=e.x,ul=e.y,this.fire("dragstart",{containerPoint:e})},i.onDragging=function(t){if(this._dragger){var e=this.map,i=Te(t.domEvent,e._containerDOM),n={x:i.x-hl,y:i.y-ul},r=e.containerPointToCoord(new ae(hl,ul)),o=e.containerPointToCoord(i);hl=i.x,ul=i.y,this.offset(n),this.fire("dragging",{containerPoint:i,coordOffset:o._sub(r)})}},i.onDragend=function(t){if(this._dragger){var e=this.map;e.resetCursor();var i=Te(t.domEvent,e._containerDOM),n={x:i.x-hl,y:i.y-ul};this.offset(n),this._dragger.disable(),delete this._dragger,this.fire("dragend",{containerPoint:i})}},e}(wi(Si)),fl=function(){function t(t,e){this.target=t,t.once("remove",this.delete,this),this.map=e,this.addTo(e)}var e=t.prototype;return e.setPoints=function(t){this.points=t;var e=t.map((function(t){return t.x})),i=t.map((function(t){return t.y}));this.xmin=Math.min.apply(Math,e),this.xmax=Math.max.apply(Math,e),this.ymin=Math.min.apply(Math,i),this.ymax=Math.max.apply(Math,i)},e.hitTest=function(){return!1},e.render=function(t){var e=this.map;if(!(this.xmax<=0||this.xmin>=e.width||this.ymax<=0||this.ymin>=e.height)){var i=e.getDevicePixelRatio();t.lineWidth=1,t.strokeStyle="#000",t.globalAlpha=1,t.beginPath();var n=this.points;t.moveTo(o(n[0].x),o(n[0].y));for(var r=1;r<this.points.length;r++)t.lineTo(o(n[r].x),o(n[r].y));t.closePath(),t.stroke()}function o(t){return Math.round(t)*i+.5}},e.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},e.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}},t}();function ml(t,e){return{markerType:t,markerFill:"#fff",markerLineColor:"#000",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:e}}var gl={fixAspectRatio:!1,symbol:null,removeVertexOn:"contextmenu",centerHandleSymbol:ml("ellipse",1),vertexHandleSymbol:ml("square",1),newVertexHandleSymbol:ml("square",.4)},yl=function(t){function e(e,i){var n;return(n=t.call(this,i)||this)._geometry=e,n._geometry?n:re(n)}ne(e,t);var i=e.prototype;return i.getMap=function(){return this._geometry.getMap()},i.prepare=function(){var t=this.getMap();t&&(t.on("drawtopstart",this._refresh,this),this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},i._prepareEditStageLayer=function(){var t=this._geometry.getLayer();if("canvas"===t.options.renderer){var e=this.getMap(),i="_maptalks__internal_layer__edit_stage_"+tt()+"_shadow";if(this._shadowLayer=e.getLayer(i),!this._shadowLayer){var n=t.constructor;this._shadowLayer=new n(i),e.addLayer(this._shadowLayer)}}},i.start=function(){if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){this.editing=!0,this.prepare();var t,e=this._geometry,i="canvas"===this._geometry.getLayer().options.renderer;this._geometryDraggble=e.options.draggable,i?(e.config("draggable",!1),(t=e.copy()).setSymbol(e._getInternalSymbol()),t.copyEventListeners(e),e._getParent()&&t.copyEventListeners(e._getParent()),t._setEventTarget(e),t.setId(null).config({draggable:!1}),this._shadow=t,e.hide()):e instanceof Mo&&e.config("draggable",!0),this._switchGeometryEvents("on"),(e instanceof Mo||e instanceof zo||e instanceof Fo||e instanceof Bo)&&this._createOrRefreshOutline(),this._shadowLayer&&this._shadowLayer.bringToFront().addGeometry(t),e instanceof Mo?t&&(t.config("draggable",!0),t.on("dragend",this._onMarkerDragEnd,this)):this._createCenterHandle(),e instanceof Mo?this.createMarkerEditor():e instanceof zo?this.createCircleEditor():e instanceof Fo||e instanceof Bo?this.createEllipseOrRectEditor():e instanceof No||(e instanceof xo||e instanceof So)&&this.createPolygonEditor()}},i.stop=function(){delete this._history,delete this._historyPointer,delete this._editOutline,this._switchGeometryEvents("off"),this.getMap()?(this._geometry.config("draggable",this._geometryDraggble),this._shadow&&(delete this._shadow,delete this._geometryDraggble,this._geometry.show()),this._shadowLayer&&(this._shadowLayer.remove(),delete this._shadowLayer),this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1,this.fire("remove")):this.fire("remove")},i.isEditing=function(){return!F(this.editing)&&this.editing},i._getGeometryEvents=function(){return{symbolchange:this._onGeoSymbolChange,dragstart:this._onDragStart,dragend:this._onDragEnd,"positionchange shapechange":this._exeAndReset}},i._switchGeometryEvents=function(t){if(this._geometry){var e=this._getGeometryEvents();for(var i in e)this._geometry[t](i,e[i],this)}},i._onGeoSymbolChange=function(t){this._shadow&&this._shadow.setSymbol(t.target._getInternalSymbol())},i._onMarkerDragEnd=function(){this._update("setCoordinates",this._shadow.getCoordinates().toArray())},i._createOrRefreshOutline=function(){var t=this._geometry,e=this._editOutline;e||(this._editOutline=new fl(this,this.getMap()),this._addRefreshHook(this._createOrRefreshOutline));var i=this._editOutline.points;if(t instanceof Mo)this._editOutline.setPoints(t.getContainerExtent().toArray(i));else{var n=this.getMap();(i=t._getPrjExtent().toArray(i)).forEach((function(t){return n._prjToContainerPoint(t,null,t)})),this._editOutline.setPoints(i)}return e},i._createCenterHandle=function(){var t,e=this,i=this.getMap(),n=this.options.centerHandleSymbol;this._geometry instanceof So&&(n.markerDx=5);var r=i.coordToContainerPoint(this._geometry.getCenter()),o=this.createHandle(r,{symbol:n,cursor:"move",onDown:function(){if(e._shadow){var i=ei((t=e._shadow.copy())._getInternalSymbol(),.5);t.setSymbol(i).addTo(e._geometry.getLayer())}},onMove:function(i){var n=i.coordOffset;t?t.translate(n):e._geometry.translate(n)},onUp:function(){var i=t||e._geometry;e._update("setCoordinates",$i.toNumberArrays(i.getCoordinates())),t&&t.remove()}});this._addRefreshHook((function(){var t=e._geometry.getCenter();o.setContainerPoint(i.coordToContainerPoint(t))}))},i._createHandleInstance=function(t,e){var i=this.getMap(),n=Dt(e.symbol,(function(){return[i.getZoom(),{"{bearing}":i.getBearing(),"{pitch}":i.getPitch(),"{zoom}":i.getZoom()}]})),r=this.options.removeVertexOn,o=new pl(this,i,{symbol:n,cursor:e.cursor,events:r});return o.setContainerPoint(t),o},i.createHandle=function(t,e){e||(e={});var i=this._createHandleInstance(t,e),n=this;return i.on("dragstart",(function(t){return this._updating=!0,e.onDown&&(this._geometry.fire("handledragstart"),e.onDown.call(n,t.containerPoint,t)),!1}),this),i.on("dragging",(function(t){return n._hideContext(),e.onMove&&(this._geometry.fire("handledragging"),e.onMove.call(n,t)),!1}),this),i.on("dragend",(function(t){return e.onUp&&(this._geometry.fire("handledragend"),e.onUp.call(n,t)),this._updating=!1,!1}),this),e.onRefresh&&(i.refresh=e.onRefresh),i},i._createResizeHandles=function(t,e,i){var n=this,r=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],o=[null,"y",null,"x","x",null,"y",null],a=this._geometry,s=a instanceof Mo;t||(t=[]);var l=this,c=[],h={},u=this.getMap(),d=this.options.vertexHandleSymbol,p=function(){for(var p=function(){if(s){var t=a.getContainerExtent();return[new ae(t.xmin,t.ymin),new ae((t.xmax+t.xmin)/2,t.ymin),new ae(t.xmax,t.ymin),new ae(t.xmin,(t.ymin+t.ymax)/2),new ae(t.xmax,(t.ymin+t.ymax)/2),new ae(t.xmin,t.ymax),new ae((t.xmax+t.xmin)/2,t.ymax),new ae(t.xmax,t.ymax)]}var e=a._getPrjExtent();return[new ae(e.xmin,e.ymax),new ae((e.xmax+e.xmin)/2,e.ymax),new ae(e.xmax,e.ymax),new ae(e.xmin,(e.ymax+e.ymin)/2),new ae(e.xmax,(e.ymax+e.ymin)/2),new ae(e.xmin,e.ymin),new ae((e.xmax+e.xmin)/2,e.ymin),new ae(e.xmax,e.ymin)]}(),f=function(f){if(Array.isArray(t)&&t.some((function(t){return t===f})))return"continue";var m,g=p[f],y=s?g:u._prjToContainerPoint(g);if(c.length<p.length-t.length){var _=n.createHandle(y,{symbol:d,cursor:r[f],axis:o[f],onMove:(m=f,function(t){l._updating=!0,e(t.containerPoint,m),a.fire("resizing")}),onUp:function(){l._updating=!1,i()}});h[f]=c.length,c.push(_)}else c[h[f]].setContainerPoint(y)},m=0;m<p.length;m++)f(m)};return p(),this._addRefreshHook(p),c},i.createMarkerEditor=function(){var t=this,e=this._shadow||this._geometry,i=this.getMap();if(e._canEdit()){this._history||this._recordHistory(p());var n=e._getInternalSymbol(),r=new ae(0,0);N(n.markerDx)&&(r.x=n.markerDx),N(n.markerDy)&&(r.y=n.markerDy);var o=null,a="middle",s="middle";if(Pr.test(n)){var l=n.markerType;"pin"===l||"pie"===l||"bar"===l?(o=[5,6,7],a="bottom"):"rectangle"===l&&(o=[0,1,2,3,5],a="top",s="left")}else(Mr.test(n)||Lr.test(n))&&(a="bottom",o=[5,6,7]);var c,h=[2,1,2,0,0,2,1,2];if(this.options.fixAspectRatio){var u=e.getSize();c=u.width/u.height}var d=this._createResizeHandles(o,(function(n,l){if(o&&o.indexOf(l)>=0){var u=i.containerPointToCoordinate(n.sub(r)),p=e.getCoordinates();u.x=p.x,e.setCoordinates(u),t._updateCoordFromShadow(!0),n=d[d.length-1-l].getContainerPoint()}var f=i.coordToContainerPoint(e.getCoordinates()).add(r),m=e._getInternalSymbol(),g=n.sub(f);"bottom"===a&&n.y>f.y&&(g.y=0);var y="middle"===a?2:1,_="left"===s?1:2,v=Math.abs(g.x)*_,x=Math.abs(g.y)*y;c&&(x=(v=Math.max(v,x*c))/c);var b=h[l];e instanceof qo?((c||0===b||2===b)&&(e.setWidth(v),e!==t._geometry&&t._geometry.setWidth(v)),(c||1===b||2===b)&&(e.setHeight(x),e!==t._geometry&&t._geometry.setHeight(x))):((c||0===b||2===b)&&(m.markerWidth=Math.min(v,t._geometry.options.maxMarkerWidth||1/0)),(c||1===b||2===b)&&(m.markerHeight=Math.min(x,t._geometry.options.maxMarkerHeight||1/0)),e.setSymbol(m),e!==t._geometry&&t._geometry.setSymbol(m))}),(function(){t._update(p())}))}else console&&console.warn("A marker can't be resized with symbol:",e.getSymbol());function p(){var t=[["setCoordinates",e.getCoordinates().toArray()]];return e instanceof qo?(t.push(["setWidth",e.getWidth()]),t.push(["setHeight",e.getHeight()])):t.push(["setSymbol",e.getSymbol()]),t}},i.createCircleEditor=function(){var t=this,e=this._shadow||this._geometry,i=this.getMap();this._history||this._recordHistory([["setCoordinates",e.getCoordinates().toArray()],["setRadius",e.getRadius()]]),this._createResizeHandles(null,(function(n){var r=e.getCenter(),o=i.containerPointToCoord(n),a=new So([[r.x,r.y],[o.x,r.y]]),s=new So([[r.x,r.y],[r.x,o.y]]),l=Math.max(i.computeGeometryLength(a),i.computeGeometryLength(s));e.setRadius(l),e!==t._geometry&&t._geometry.setRadius(l)}),(function(){t._update("setRadius",e.getRadius())}))},i.createEllipseOrRectEditor=function(){var t=this,e=[2,1,2,0,0,2,1,2],i=this._shadow||this._geometry;this._history||this._recordHistory(s());var n,r=this.getMap(),o=this._geometry instanceof Fo;this.options.fixAspectRatio&&(n=i.getWidth()/i.getHeight());var a=this._createResizeHandles(null,(function(s,l){var c,h,u,d=o?1:2,p=a[l].getContainerPoint(),f=e[l];if(o){var m=a[7-l].getContainerPoint(),g=(c=p.sub(m)).abs();h=r.pixelToDistance(g.x,0),u=r.pixelToDistance(0,g.y);var y=i.getSize(),_=i.getCoordinates(),v=i.getWidth(),x=i.getHeight(),b=r.containerPointToCoord(s),w=r.containerPointToCoord(m),M=new So([[w.x,w.y],[b.x,w.y]]),T=new So([[w.x,w.y],[w.x,b.y]]);if(h=r.computeGeometryLength(M),u=r.computeGeometryLength(T),0===f)if(n&&(g.y=g.x/n,y.height=Math.abs(g.y),u=h/n),p.y=m.y-y.height/2,b.y=_.y,4===l)b.x=Math.min(b.x,_.x);else{var S=r.locate(_,v,0);b.x=r.locate(new $i(S.x,b.y),-h,0).x}else if(1===f)n&&(g.x=g.y*n,y.width=Math.abs(g.x),h=u*n),p.x=m.x-y.width/2,b.x=_.x,b.y=Math.max(b.y,w.y);else{if(n&&(h>u*n?(u=h/n,p.y=m.y+g.x*st(c.y)/n):(h=u*n,p.x=m.x+g.y*st(c.x)*n)),0===l||5===l){var E=0===l?r.locate(_,v,0):r.locate(_,v,-x);b.x=r.locate(new $i(E.x,b.y),-h,0).x}else b.x=Math.min(b.x,w.x);b.y=Math.max(b.y,w.y)}i.setCoordinates(b),t._updateCoordFromShadow(!0)}else{var C=i.getCenter(),A=r.containerPointToCoord(p),P=new So([[C.x,C.y],[A.x,C.y]]),L=new So([[C.x,C.y],[C.x,A.y]]);h=r.computeGeometryLength(P),u=r.computeGeometryLength(L),n&&(u=(h=Math.max(h,u*n))/n)}(n||0===f||2===f)&&(i.setWidth(h*d),i!==t._geometry&&t._geometry.setWidth(h*d)),(n||1===f||2===f)&&(i.setHeight(u*d),i!==t._geometry&&t._geometry.setHeight(u*d))}),(function(){t._update(s())}));function s(){return[["setCoordinates",i.getCoordinates().toArray()],["setWidth",i.getWidth()],["setHeight",i.getHeight()]]}},i.createPolygonEditor=function(){var t=this.getMap(),e=this._shadow||this._geometry,i=this;this._history||this._recordHistory("setCoordinates",$i.toNumberArrays(e.getCoordinates()));var n=e instanceof xo?3:2,r="maptalks--editor-vertex-index",o={0:[]},a={0:[]};function s(t){if(void 0===t&&(t=0),e instanceof xo){var i=e.getCoordinates()[t]||[];return i.slice(0,i.length-1)}return e.getCoordinates()}function l(t){return void 0===t&&(t=0),0===t?e._getPrjCoordinates():e._getPrjHoles()[t-1]}function c(){for(var t in o){for(var e=o[t].length-1;e>=0;e--)o[t][e][r]=e;for(var n=a[t].length-1;n>=0;n--)a[t][n][r]=n}i._updateCoordFromShadow()}function h(t){i._updating=!0;var s=t.target,h=s[r],u=N(s._ringIndex)?s._ringIndex:0,d=l(u);if(!(d.length<=n)){var p,m=e instanceof So&&(0===h||h===d.length-1);d.splice(h,1),u>0?e._prjHoles[u-1]=d:e._setPrjCoordinates(d),e._updateCache(),o[u].splice(h,1)[0].delete(),h<a[u].length&&a[u].splice(h,1)[0].delete(),p=0===h?a[u].length-1:h-1,a[u].splice(p,1)[0].delete(),m||a[u].splice(p,0,f.call(i,p,u)),c(),i._updating=!1}}function u(n,r,o){void 0===o&&(o=0);var s,c=l(o),h=t._containerPointToPrj(n),u=c[r];u.x=h.x,u.y=h.y,e._updateCache(),e.onShapeChanged(),i._updateCoordFromShadow(!0),s=0===r?a[o].length-1:r-1,a[o][r]&&a[o][r].refresh(),a[o][s]&&a[o][s].refresh()}function d(e,n){void 0===n&&(n=0);var o=s(n)[e],a=i.createHandle(t.coordToContainerPoint(o),{symbol:i.options.vertexHandleSymbol,cursor:"pointer",axis:null,onMove:function(){u(a.getContainerPoint(),a[r],n)},onRefresh:function(){o=s(n)[a[r]];var e=t.coordToContainerPoint(o);a.setContainerPoint(e)},onUp:function(){i._updateCoordFromShadow()},onDown:function(t,e){!e||!e.domEvent||e.domEvent.button}});return a[r]=e,a._ringIndex=n,a.on(i.options.removeVertexOn,h),a}var p=!1;function f(n,h){void 0===h&&(h=0);var m,g=s(h);m=n+1>=g.length?g[0]:g[n+1];var y=g[n].add(m).multi(.5),_=i.createHandle(y,{symbol:i.options.newVertexHandleSymbol,cursor:"pointer",axis:null,onDown:function(n,o){if(!o||!o.domEvent||2!==o.domEvent.button){var s=l(h),c=_[r],u=_.getContainerPoint(),d=t._containerPointToPrj(u);s.splice(c+1,0,d),h>0?e._prjHoles[h-1]=s:e._setPrjCoordinates(s),e._updateCache(),_.opacity=1,a[h].splice(c,0,f.call(i,c,h),f.call(i,c+1,h)),p=!0}},onMove:function(){u(_.getContainerPoint(),_[r]+1,h)},onUp:function(t){if(t&&t.domEvent&&2===t.domEvent.button)p=!1;else{var e=_[r];rt(_,a[h]),_.delete(),o[h].splice(e+1,0,d.call(i,e+1,h)),c(),i._updateCoordFromShadow(),p=!1}},onRefresh:function(e){g=s(e);var i,n=_[r];i=n===g.length-1?0:n+1;var o=g[n].add(g[i]).multi(.5),a=t.coordToContainerPoint(o);_.setContainerPoint(a)}});return _[r]=n,_}if(e instanceof xo)for(var m=e.getHoles().length+1,g=0;g<m;g++){o[g]=[],a[g]=[];for(var y=s(g),_=0,v=y.length;_<v;_++)o[g].push(d.call(this,_,g)),_<v-1&&a[g].push(f.call(this,_,g));a[g].push(f.call(this,y.length-1,g))}else for(var x=0,b=s(0).length;x<b;x++)o[0].push(d.call(this,x,0)),x<b-1&&a[0].push(f.call(this,x,0));this._addRefreshHook((function(){if(!p){for(var t in a)for(var e=a[t].length-1;e>=0;e--)a[t][e].refresh(t);for(var i in o)for(var n=o[i].length-1;n>=0;n--)o[i][n].refresh(i)}}))},i._refresh=function(){if(this._refreshHooks)for(var t=this._refreshHooks.length-1;t>=0;t--)this._refreshHooks[t].call(this)},i._hideContext=function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},i._addRefreshHook=function(t){t&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(t))},i._update=function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];this._exeHistory([t,i]),this._recordHistory.apply(this,[t].concat(i))},i._updateCoordFromShadow=function(t){var e=(this._shadow||this._geometry).getCoordinates(),i=this._geometry,n=this._updating;this._updating=!0,i.setCoordinates(e),t||this._recordHistory("setCoordinates",$i.toNumberArrays(i.getCoordinates())),this._updating=n},i._recordHistory=function(t){this._history||(this._history=[],this._historyPointer=0);for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];if(this._history.length){var r=this._history[this._history.length-1];if(r[0]===t&&JSON.stringify(r[1])===JSON.stringify(i))return}this._historyPointer<this._history.length-1&&this._history.splice(this._historyPointer+1),this._history.push([t,i]),this._historyPointer=this._history.length-1,this._geometry.fire("editrecord")},i.cancel=function(){if(!this._history||0===this._historyPointer)return this;this._historyPointer=0;var t=this._history[0];return this._exeAndReset(t),this},i.undo=function(){if(!this._history||0===this._historyPointer)return this;var t=this._history[--this._historyPointer];return this._exeAndReset(t),this},i.redo=function(){if(!this._history||this._historyPointer===this._history.length-1)return this;var t=this._history[++this._historyPointer];return this._exeAndReset(t),this},i._exeAndReset=function(t){if(!this._updating){this._exeHistory(t);var e=this._history,i=this._historyPointer;this.stop(),this._history=e,this._historyPointer=i,this.start()}},i._onDragStart=function(){this._updating=!0},i._onDragEnd=function(){this._updating=!1},i._exeHistory=function(t){if(Array.isArray(t)){var e=this._updating;this._updating=!0;var i=this._shadow||this._geometry,n=this._geometry;Array.isArray(t[0])?t[0].forEach((function(t){var e=t[0],r=t.slice(1);i[e].apply(i,r),i!==n&&n[e].apply(n,r)})):(i[t[0]].apply(i,t[1]),i!==n&&n[t[0]].apply(n,t[1])),this._updating=e}},e}(wi(Si));yl.mergeOptions(gl);var _l={startEditText:function(){return this.getMap()?(this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var t=this._textEditor.innerHTML;t=t.replace(/<p>/gi,"").replace(/<\/p>/gi,"<br/>"),this._textEditor.innerHTML=t;var e=this._textEditor.innerText.replace(/[\r\n]+$/gi,"");this.setContent(e),Oe(this._textEditor,"mousedown dblclick",xe),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this.show(),this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var t=this.getMap(),e=this._createEditor();this._textEditor=e,t.on("mousedown",this.endEditText,this);var i=this._getEditorOffset();this._editUIMarker=new $a(this.getCoordinates(),{animation:null,content:e,dx:i.dx,dy:i.dy}).addTo(t),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var t=this._getInternalSymbol()||{},e=0,i=0,n=t.textHorizontalAlignment;return"middle"===n||F(n)?(e=(t.textDx||0)-2,i=(t.textDy||0)-2):(e=(t.markerDx||0)-2,i=(t.markerDy||0)-2),{dx:e,dy:i}},_createEditor:function(){var t=this.getContent(),e=this.getSize(),i=this._getInternalSymbol()||{},n=e.width,r=i.textFill||"#000000",o=i.textSize||12,a=e.height,s=i.markerLineColor||"#000",l=i.markerFill||"#3398CC",c=i.textLineSpacing||0,h=pe("div");return h.contentEditable=!0,h.style.cssText="background:"+l+"; border:1px solid "+s+";\n            color:"+r+";font-size:"+o+"px;width:"+(n-2)+"px;height:"+(a-2)+"px;margin: auto;\n            line-height:"+(o+c)+"px;outline: 0; padding:0; margin:0;word-wrap: break-word;\n            overflow: hidden;-webkit-user-modify: read-write-plaintext-only;",h.innerText=t,ke(h,"mousedown dblclick",xe),h.onkeyup=function(t){var e=h.style.height||0;13===t.keyCode&&(h.style.height=parseInt(e)+o/2+"px")},h},_setCursorToLast:function(t){var e;window.getSelection?(t.focus(),(e=window.getSelection()).selectAllChildren(t),e.collapseToEnd()):document.selection&&((e=document.selection.createRange()).moveToElementText(t),e.collapse(!1),e.select())}};Wo.include(_l),Wr.include({animate:function(t,e,i){var n=this;this._animPlayer&&this._animPlayer.finish(),V(e)&&(i=e),e||(e={});var r,o=this.getMap(),a=this._getProjection(),s=this.getSymbol()||{},l=this._prepareAnimationStyles(t),c=e.focus;if(delete this._animationStarted,o){var h=o._getRenderer();e.framer=function(t){h.callInNextFrame(t)}}var u=go.animate(l,e,(function(t){if(o&&o.isRemoved())u.finish();else{o&&!n._animationStarted&&c&&o.onMoveStart();var e=t.styles;for(var l in e)if("symbol"!==l&&"translate"!==l&&e.hasOwnProperty(l)){var h="set"+l[0].toUpperCase()+l.slice(1);n[h](e[l])}var d=e.translate;if(d){var p=d;r&&(p=d.sub(r)),r=d,n.translate(p)}var f=e.symbol;if(f&&n.setSymbol(ii(s,f)),o&&c){var m=a.project(n.getCenter());o._setPrjCenter(m);var g=o._parseEventFromCoord(a.unproject(m));"running"!==u.playState?o.onMoveEnd(g):o.onMoving(g)}n._fireAnimateEvent(u.playState),i&&i(t)}}),this);return this._animPlayer=u,this._animPlayer.play()},_prepareAnimationStyles:function(t){var e=this._getInternalSymbol(),i={};for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];if("translate"!==n&&"symbol"!==n){var o=this["get"+n[0].toUpperCase()+n.substring(1)]();i[n]=[o,r]}else if("symbol"===n){var a=void 0;if(Array.isArray(t.symbol)){if(!Array.isArray(e))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");a=[];for(var s=t.symbol,l=0;l<s.length;l++)if(s[l]){var c={};for(var h in s[l])s[l].hasOwnProperty(h)&&(c[h]=[e[l][h],s[l][h]]);a.push(c)}else a.push(null)}else{if(Array.isArray(e))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");for(var u in a={},r)r.hasOwnProperty(u)&&(a[u]=[e[u],r[u]])}i.symbol=a}else"translate"===n&&(i.translate=new $i(r))}return i},_fireAnimateEvent:function(t){"finished"===t?(delete this._animationStarted,this._fireEvent("animateend")):"running"===t&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}});var vl=O.touch?"touchstart mousedown":"mousedown",xl=function(t){function e(e){return t.call(this,e)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target.on(vl,this._startDrag,this)},i.removeHooks=function(){this._endDrag(),this.target.off(vl,this._startDrag,this),delete this.container},i._prepareDragHandler=function(){this._dragHandler=new Yi(this.container),this._dragHandler.on("dragging",this._dragging,this).on("mouseup",this._endDrag,this).enable()},i._prepareShadow=function(){var t=this,e=this.target;if("canvas"===e.getLayer().options.renderer){this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var i=this._shadow=e.copy();if(i.getGeometries){var n=i.getGeometries(),r=e.getGeometries();n.forEach((function(e,i){t._updateShadowSymbol(e,r[i])}))}else this._updateShadowSymbol(i,e);i.setId(null),this._prepareShadowConnectors()}},i._updateShadowSymbol=function(t,e){if(t.setSymbol(e._getInternalSymbol()),e.options.dragShadow){var i=ei(t._getInternalSymbol(),.5);t.setSymbol(i)}},i._prepareShadowConnectors=function(){var t=this.target,e=this._shadow,i=this._dragStageLayer._getRenderer().resources,n=[];if(Jo._hasConnectors(t))for(var r=Jo._getConnectors(t),o=0,a=r.length;o<a;o++){var s=r[o],l=s.config(),c=s._getInternalSymbol();l.symbol=ei(c,.5);var h=void 0;h=s.getConnectSource()===t?new s.constructor(e,s.getConnectTarget(),l):new s.constructor(s.getConnectSource(),e,l),n.push(h),s.getLayer()&&s.getLayer()._getRenderer()&&i.merge(s.getLayer()._getRenderer().resources)}this._shadowConnectors=n,n.push(e),this._dragStageLayer.bringToFront().addGeometry(n)},i._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target._getSymbol())},i._prepareDragStageLayer=function(){var t=this.target.getMap(),e=this.target.getLayer();this._dragStageLayer=t.getLayer("_maptalks__internal_layer__drag_stage"),this._dragStageLayer||(this._dragStageLayer=new ia("_maptalks__internal_layer__drag_stage",{enableAltitude:e.options.enableAltitude,altitudeProperty:e.options.altitudeProperty}),t.addLayer(this._dragStageLayer));var i=new On;i.merge(e._getRenderer().resources),this._dragStageLayer._getRenderer().resources=i},i._startDrag=function(t){var e=this.target.getMap();if(e&&(!this.target._getParent()&&!this.isDragging())){var i=t.domEvent;i.touches&&i.touches.length>1||2===i.button||(this.container=e._panels.mapWrapper||e._containerDOM,this.target.on("click",this._endDrag,this),this._lastCoord=this._correctCoord(t.coordinate),this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),ke(this.container,"mouseleave",this._endDrag,this),this._startParam=t,this._moved=!1)}},i._dragging=function(t){var e=this.target,i=e.getMap()._parseEvent(t.domEvent),n=i.domEvent;if(!(n.touches&&n.touches.length>1)){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),this._shadow&&(e.options.dragShadow||e.hide(),this._shadow._fireEvent("dragstart",i)),this.target._fireEvent("dragstart",this._startParam||i),void delete this._startParam;var r=this._shadow||e,o=r.options.dragOnAxis,a=this._correctCoord(i.coordinate),s=i.containerPoint;this._lastPoint=this._lastPoint||s,this._lastCoord=this._lastCoord||a;var l=s.sub(this._lastPoint),c=a.sub(this._lastCoord);"x"===o?l.y=c.y=0:"y"===o&&(l.x=c.x=0),this._lastPoint=s,this._lastCoord=a,r.translate(c),r===e||e.options.dragShadow||e.translate(c),i.coordOffset=c,i.pointOffset=l,r._fireEvent("dragging",i),r!==e&&e._fireEvent("dragging",i)}},i._endDrag=function(t){if(this._dragHandler&&(this._dragHandler.disable(),delete this._dragHandler),this.container&&Oe(this.container,"mouseleave",this._endDrag,this),this.target){var e=this.target;e.off("click",this._endDrag,this),e.off("symbolchange",this._onTargetUpdated,this),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1;var i=e.getMap();if(this.enabled()&&i){var n=i._parseEvent(t?t.domEvent:null);this._updateTargetAndRemoveShadow(n),this._moved&&e._fireEvent("dragend",n)}}},i.isDragging=function(){return!!this._isDragging},i._updateTargetAndRemoveShadow=function(t){if(this._shadow){var e=this.target,i=e.getMap();e.options.dragShadow||e.show();var n=this._shadow;if(n){if(e.options.dragShadow)if(e.getGeometries){var r=n.getGeometries(),o=e.getGeometries();r.forEach((function(t,e){o[e].setCoordinates(r[e].getCoordinates())}))}else e.setCoordinates(n.getCoordinates());n._fireEvent("dragend",t),n.remove(),delete this._shadow}this._shadowConnectors&&(i.getLayer("_maptalks__internal_layer__drag_stage").removeGeometry(this._shadowConnectors),delete this._shadowConnectors),this._dragStageLayer&&this._dragStageLayer.remove()}},i._correctCoord=function(t){var e=this.target.getMap();if(!e.getPitch())return t;var i=this.target;if(!i.getMinAltitude())return t;var n=(i.getMinAltitude()+i.getMaxAltitude())/2;return e.locateByPoint(t,0,-n)},e}(Ti);Wr.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null}),Wr.addInitHook("addHandler","draggable",xl),Wr.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():!!this.draggable&&this.draggable.isDragging()}}),Wr.include({startEdit:function(t){return this.getMap()&&this.options.editable?(this.endEdit(),this._editor=new yl(this,t),this._editor.start(),this.fire("editstart"),this):this},endEdit:function(){return this._editor&&(this._editor.stop(),delete this._editor,this.fire("editend")),this},redoEdit:function(){return this.isEditing()?(this._editor.redo(),this.fire("redoedit"),this):this},undoEdit:function(){return this.isEditing()?(this._editor.undo(),this.fire("undoedit"),this):this},cancelEdit:function(){return this.isEditing()?(this._editor.cancel(),this.fire("canceledit"),this):this},isEditing:function(){return!!this._editor&&this._editor.isEditing()}}),Wr.include({_onEvent:function(t,e){if(this.getMap()){var i=e||this._getEventTypeToFire(t);"contextmenu"===i&&this.listens("contextmenu")&&(xe(t),ve(t));var n=this._getEventParams(t);this._fireEvent(i,n)}},_getEventTypeToFire:function(t){return t.type},_getEventParams:function(t){var e=this.getMap(),i={domEvent:t},n=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(n){var r=Te(n,e._containerDOM);i.coordinate=e.containerPointToCoordinate(r),i.containerPoint=r,i.viewPoint=e.containerPointToViewPoint(r),i.pont2d=e._containerPointToPoint(r)}return i}}),Wr.include({setInfoWindow:function(t){return this.removeInfoWindow(),t instanceof Qa?(this._infoWindow=t,this._infoWinOptions=B({},this._infoWindow.options),this._infoWindow.addTo(this),this):(this._infoWinOptions=B({},t),this._infoWindow?this._infoWindow.setOptions(t):this.getMap()&&this._bindInfoWindow(this._infoWinOptions),this)},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(t){return this.getMap()?(t||(t=this.getCenter()),this._infoWindow?this._infoWindow.show(t):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(this._infoWinOptions),this._infoWindow.show(t)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(t){return this._infoWindow=new Qa(t),this._infoWindow.addTo(this),this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}});var bl=new ae(0,0),wl=new ae(0,0),Ml=new ae(0,0),Tl=new ae(0,0),Sl=function(t){function e(e){var i;return(i=t.call(this,e)||this).tilesInView={},i.tilesLoading={},i._parentTiles=[],i._childTiles=[],i.tileCache=new ci(e.options.maxCacheSize,i.deleteTile.bind(re(re(i)))),i}ne(e,t);var i=e.prototype;return i.getCurrentTileZoom=function(){return this._tileZoom},i.draw=function(){var t=this.getMap();if(this.isDrawable()){var e=this.prepareCanvas();if(!e||e.intersects(this.canvasExtent2D)){var i=this.layer.getTiles().tileGrids;if(i&&i.length){var n=0,r=!1,o={},a=[],s=[],l={},c=[],h={},u=[],d={},p={},f=this._markTiles(),m=this._getLoadLimit(),g=i.length;this._tileZoom=i[0].zoom;for(var y=0;y<g;y++)for(var _=i[y],v=_.tiles,x=this._generatePlaceHolder(_.zoom),b=0,w=v.length;b<w;b++){var M=v[b],T=M.id,S=!1;if(this._isLoadingTile(T))S=r=!0,this.tilesLoading[T].current=!0;else{var E=this._getCachedTile(T);if(E)E.image&&this.getTileOpacity(E.image)<1&&(S=r=!0),a.push(E);else if(S=r=!0,!(m&&n+f[0]>m)&&(!t.isInteracting()||t.isMoving()||t.isRotating()))n++,p[T]=M}if(S&&!o[T]){o[T]=1,x&&!d[T]&&(M.cache=!1,u.push({image:x,info:M}),d[T]=1);var C=this._findParentTile(M);if(C){var A=C.info.id;void 0===l[A]&&(l[A]=s.length,s.push(C))}else if(!s.length){var P=this._findChildTiles(M);P.length&&P.forEach((function(t){h[t.info.id]||(c.push(t),h[t.info.id]=1)}))}}}s.length&&(c.length=0,this._childTiles.length=0),this._drawTiles(a,s,c,u),n?this.loadTileQueue(p):r||(t.isAnimating()||!this._parentTiles.length&&!this._childTiles.length||(this._parentTiles=[],this._childTiles=[],this.setToRedraw()),this.completeRender()),this._retireTiles()}else this.completeRender()}else this.completeRender()}},i.isTileCachedOrLoading=function(t){return this.tilesLoading[t]||this.tilesInView[t]||this.tileCache.get(t)},i._drawTiles=function(t,e,i,n){var r=this;e.length&&(e.sort((function(t,e){return Math.abs(e.info.z-r._tileZoom)-Math.abs(t.info.z-r._tileZoom)})),this._parentTiles=e),i.length&&(this._childTiles=i);var o={tiles:t,parentTiles:this._parentTiles,childTiles:this._childTiles};this.onDrawTileStart(o),this._parentTiles.forEach((function(t){return r._drawTileAndCache(t)})),this._childTiles.forEach((function(t){return r._drawTile(t.info,t.image)})),n.forEach((function(t){return r._drawTile(t.info,t.image)}));var a=this.layer,s=this.getMap();if(!a.options.cascadeTiles||s.getPitch()<=s.options.cascadePitches[0])t.forEach((function(t){return r._drawTileAndCache(t)}));else{this.writeZoomStencil();for(var l=!1,c=0,h=t.length;c<h;c++)t[c].info.z!==this._tileZoom?l?this.resumeZoomStencilTest():(this.startZoomStencilTest(),l=!0):l&&this.pauseZoomStencilTest(),this._drawTileAndCache(t[c]);this.endZoomStencilTest()}this.onDrawTileEnd(o)},i.writeZoomStencil=function(){},i.startZoomStencilTest=function(){},i.endZoomStencilTest=function(){},i.pauseZoomStencilTest=function(){},i.resumeZoomStencilTest=function(){},i.onDrawTileStart=function(){},i.onDrawTileEnd=function(){},i._drawTile=function(t,e){e&&this.drawTile(t,e)},i._drawTileAndCache=function(t){t.current=!0,this.tilesInView[t.info.id]=t,this._drawTile(t.info,t.image),this.tileCache.add(t.info.id,t)},i.drawOnInteracting=function(){this.draw()},i.needToRedraw=function(){var e=this.getMap();return e.getPitch()?t.prototype.needToRedraw.call(this):!(!e.isRotating()&&!e.isZooming())||(e.isMoving()?!!this.layer.options.forceRenderOnMoving:t.prototype.needToRedraw.call(this))},i.hitDetect=function(){return!1},i._getLoadLimit=function(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:0},i.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("TileLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),this.clear(),!1)},i.clear=function(){this._retireTiles(!0),this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._parentTiles=[],this._childTiles=[],t.prototype.clear.call(this)},i._isLoadingTile=function(t){return!!this.tilesLoading[t]},i.clipCanvas=function(e){return t.prototype.clipCanvas.call(this,e)},i._clipByPitch=function(t){var e=this.getMap();if(e.getPitch()<=e.options.maxVisualPitch)return!1;if(!this.layer.options.clipByPitch)return!1;var i=e.getContainerExtent(),n=e.getDevicePixelRatio();return t.save(),t.strokeStyle="rgba(0, 0, 0, 0)",t.beginPath(),t.rect(0,Math.ceil(i.ymin)*n,Math.ceil(i.getWidth())*n,Math.ceil(i.getHeight())*n),t.stroke(),t.clip(),!0},i.loadTileQueue=function(t){for(var e in t)if(t.hasOwnProperty(e)){var i=t[e],n=this.loadTile(i);void 0===n.loadTime&&(this.tilesLoading[i.id]={image:n,current:!0,info:i})}},i.loadTile=function(t){var e=this.layer.getTileSize(),i=new Image;return i.width=e.width,i.height=e.height,i.onload=this.onTileLoad.bind(this,i,t),i.onerror=this.onTileError.bind(this,i,t),this.loadTileImage(i,t.url),i},i.loadTileImage=function(t,e){var i=this.layer.options.crossOrigin;return F(i)||(t.crossOrigin=i),K(t,[e])},i.abortTileLoading=function(t){t&&(t.onload=El,t.onerror=El,t.src=bt)},i.onTileLoad=function(t,e){if(this.layer){var i=e.id;if(this.tilesInView){var n={tile:e,tileImage:t};this.layer.fire("tileload",n),(t=n.tileImage).loadTime=z(),delete this.tilesLoading[i],this._addTileToCache(e,t),this.setToRedraw()}}},i.onTileError=function(t,e){if(this.layer){if(t.onerrorTick=t.onerrorTick||0,this.layer.options.tileRetryCount>t.onerrorTick)return t.onerrorTick++,void(t.src=e.url);if(t instanceof Image){var i=this.layer.options.errorUrl;if(i&&t.src!==i)return void(t.src=i);this.abortTileLoading(t,e)}t.loadTime=0,delete this.tilesLoading[e.id],this._addTileToCache(e,t),this.setToRedraw(),this.layer.fire("tileerror",{tile:e})}},i.drawTile=function(t,e){if(e&&this.getMap()){var i=t.extent2d,n=t.offset,r=bl.set(i.xmin-n[0],i.ymax-n[1]),o=t.z,a=t.id,s=this.getMap(),l=this.layer.getTileSize(),c=s.getZoom(),h=this.context,u=s._pointToContainerPoint(r,o,0,wl),d=s.getBearing(),p=d||c!==o,f=this.getTileOpacity(e),m=h.globalAlpha;f<1&&(h.globalAlpha=f,this.setToRedraw()),p||u._round();var g=u.x,y=u.y,_=l.width,v=l.height;if(p){if(h.save(),h.translate(g,y),d&&(h.rotate(-d*Math.PI/180),_+=.1,v+=.1),c!==o){var x=s._getResolution(o)/s._getResolution();h.scale(x,x)}g=y=0}if(fi.image(h,e,g,y,_,v),this.layer.options.debug){var b=this.layer.options.debugOutline;h.save(),h.strokeStyle=b,h.fillStyle=b,h.strokeWidth=10,h.font="20px monospace";var w=new ae(g,y);fi.rectangle(h,w,{width:_,height:v},1,0),fi.fillText(h,this.getDebugInfo(a),w._add(10,20),b),fi.drawCross(h,g+_/2,y+v/2,2,b),h.restore()}p&&h.restore(),h.globalAlpha!==m&&(h.globalAlpha=m),this.setCanvasUpdated()}},i.getDebugInfo=function(t){var e=t.split("_"),i=e.length;return"x:"+e[i-2]+", y:"+e[i-3]+", z:"+e[i-1]},i._findChildTiles=function(t){var e=this._getLayerOfTile(t.layer);if(!e.options.background)return[];for(var i=this.getMap(),n=[],r=t.extent2d.getMin(),o=t.extent2d.getMax(),a=e._project(i._pointToPrj(r,t.z,Ml),Ml),s=e._project(i._pointToPrj(o,t.z,Tl),Tl),l=1;l<2;l++)this._findChildTilesAt(n,a,s,e,t.z+l);return n},i._findChildTilesAt=function(t,e,i,n,r){var o=n.options.zoomOffset,a=n.getId(),s=n.getSpatialReference().getResolution(r+o);if(s)for(var l,c,h=n._getTileConfig().getTileIndex(e,s),u=n._getTileConfig().getTileIndex(i,s),d=Math.min(h.idx,u.idx),p=Math.max(h.idx,u.idx),f=Math.min(h.idy,u.idy),m=Math.max(h.idy,u.idy),g=d;g<p;g++)for(var y=f;y<m;y++)l=n._getTileId(g,y,r+o,a),this.tileCache.has(l)&&(c=this.tileCache.getAndRemove(l),t.push(c),this.tileCache.add(l,c))},i._findParentTile=function(t){var e=this.getMap(),i=this._getLayerOfTile(t.layer);if(!i.options.background)return null;for(var n=i.getSpatialReference(),r=n.getZoomDirection(),o=i.options.zoomOffset,a=i.options.backgroundZoomDiff,s=t.extent2d.getCenter(),l=i._project(e._pointToPrj(s,t.z)),c=1;c<=a;c++){var h=t.z-r*c,u=n.getResolution(h+o);if(u){var d=i._getTileConfig().getTileIndex(l,u),p=i._getTileId(d.x,d.y,h+o,t.layer);if(this.tileCache.has(p)){var f=this.tileCache.getAndRemove(p);return this.tileCache.add(p,f),f}}}return null},i._getLayerOfTile=function(t){return this.layer.getChildLayer?this.layer.getChildLayer(t):this.layer},i._getCachedTile=function(t){var e=this.tilesInView,i=this.tileCache.getAndRemove(t);if(i){e[t]=i;var n=this.tilesLoading;if(n&&n[t]){n[t].current=!1;var r=n[t],o=r.image,a=r.info;this.abortTileLoading(o,a),delete n[t]}}else i=e[t];return i},i._addTileToCache=function(t,e){this.tilesInView[t.id]={image:e,current:!0,info:t}},i.getTileOpacity=function(t){return this.layer.options.fadeAnimation&&t.loadTime?Math.min(1,(z()-t.loadTime)/(1e3/60*10)):1},i.onRemove=function(){this.clear(),delete this.tileCache,delete this._tilePlaceHolder,t.prototype.onRemove.call(this)},i._markTiles=function(){var t=0,e=0;if(this.tilesLoading)for(var i in this.tilesLoading)this.tilesLoading[i].current=!1,t++;if(this.tilesInView)for(var n in this.tilesInView)this.tilesInView[n].current=!1,e++;return[t,e]},i._retireTiles=function(t){for(var e in this.tilesLoading){var i=this.tilesLoading[e];!t&&i.current||(i.image&&this.abortTileLoading(i.image,i.info),this.deleteTile(i),delete this.tilesLoading[e])}for(var n in this.tilesInView){var r=this.tilesInView[n];r.current||(delete this.tilesInView[n],this.tileCache.has(n)||this.deleteTile(r))}},i.deleteTile=function(t){t&&t.image&&(t.image.onload=null,t.image.onerror=null)},i._generatePlaceHolder=function(t){var e=this.getMap(),i=this.layer.options.placeholder;if(!i||e.getPitch())return null;var n=this.layer.getTileSize(),r=e._getResolution(t)/e._getResolution(),o=this._tilePlaceHolder=this._tilePlaceHolder||fi.createCanvas(1,1,e.CanvasClass);return o.width=n.width*r,o.height=n.height*r,V(i)?i(o):function(t){var e=t.getContext("2d"),i=t.width,n=t.height,r=i/16,o=n/16;e.beginPath();for(var a=0;a<16;a++)e.moveTo(0,a*o),e.lineTo(i,a*o),e.moveTo(a*r,0),e.lineTo(a*r,n);e.strokeStyle="rgba(180, 180, 180, 0.1)",e.lineWidth=1,e.stroke(),e.beginPath();for(var s=[[0,0],[i,0],[0,n],[i,n],[0,0],[0,n],[i,0],[i,n],[0,n/2],[i,n/2],[i/2,0],[i/2,n]],l=1;l<s.length;l+=2)e.moveTo(s[l-1][0],s[l-1][1]),e.lineTo(s[l][0],s[l][1]);e.lineWidth=4,e.stroke()}(o),o},e}(kn);function El(){return!1}Bs.registerRenderer("canvas",Sl);var Cl=new ae(0,0),Al=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.isDrawable=function(){return!0},i.needToRedraw=function(){var e=this.getMap();return!(!this._gl()||e.getPitch()||!e.isZooming()||e.isMoving()||e.isRotating())||t.prototype.needToRedraw.call(this)},i.drawTile=function(e,i){var n=this.getMap();if(e&&n&&i){var r=e._glScale=e._glScale||n.getGLScale(e.z),o=this.layer.getTileSize(),a=o.width,s=o.height;if(!1!==e.cache&&this._bindGLBuffer(i,a,s),this._gl()){var l=e.extent2d,c=e.offset,h=Cl.set(l.xmin-c[0],e.extent2d.ymax-c[1]),u=h.x*r,d=h.y*r,p=this.getTileOpacity(i),f=null;this.layer.options.debug&&(f=this.getDebugInfo(e.id)),this.drawGLImage(i,u,d,a,s,r,p,f),p<1?this.setToRedraw():this.setCanvasUpdated()}else t.prototype.drawTile.call(this,e,i)}},i.writeZoomStencil=function(){var t=this.gl;t.stencilFunc(t.ALWAYS,1,255),t.stencilOp(t.KEEP,t.KEEP,t.REPLACE)},i.startZoomStencilTest=function(){var t=this.gl;t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilFunc(t.EQUAL,0,255)},i.endZoomStencilTest=function(){this.pauseZoomStencilTest()},i.pauseZoomStencilTest=function(){var t=this.gl;t.stencilFunc(t.ALWAYS,1,255)},i.resumeZoomStencilTest=function(){var t=this.gl;t.stencilFunc(t.EQUAL,0,255)},i._bindGLBuffer=function(t,e,i){t.glBuffer||(t.glBuffer=this.bufferTileData(0,0,e,i))},i.loadTileImage=function(t,e){var i=this.layer.options.crossOrigin;t.crossOrigin=null!==i?i:"",t.src=e},i.onCanvasCreate=function(){this.canvas.gl&&this.canvas.gl.wrap||this.createCanvas2()},i.createContext=function(){t.prototype.createContext.call(this),this.createGLContext()},i.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},i.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},i.getCanvasImage=function(){if(!this._gl()||!this.canvas2)return t.prototype.getCanvasImage.call(this);var e=t.prototype.getCanvasImage.call(this);return e&&(e.image=this.canvas2),e},i._gl=function(){if(this.canvas.gl&&this.canvas.gl.wrap)return!0;var t=this.getMap();return t&&(t.getPitch()||t.getBearing())||this.layer&&!!this.layer.options.fragmentShader},i.deleteTile=function(e){t.prototype.deleteTile.call(this,e),e&&e.image&&this.disposeImage(e.image),delete e.image},i.onRemove=function(){t.prototype.onRemove.call(this),this.removeGLCanvas()},e}(Ks(Sl));function Pl(t){var e=this.layer.getTileSize(),i=this.canvas.constructor,n=this.getMap(),r=n.getDevicePixelRatio(),o=fi.createCanvas(e.width*r,e.height*r,i);o.layer=this.layer;var a=this,s=new ae(t.extent2d.xmin,t.extent2d.ymax),l=new un(n.pointToCoordinate(s),n.pointToCoordinate(s.add(e.width,e.height)),n.getProjection());return this.layer.drawTile(o,{url:t.url,point:s,center:n.pointToCoordinate(s.add(e.width/2,e.height/2)),extent:l,z:t.z,x:t.x,y:t.y},(function(e){e?a.onTileError(o,t):a.onTileLoad(o,t)})),o}Bs.registerRenderer("gl",Al);var Ll=function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.prototype.loadTile=function(){return Pl.apply(this,arguments)},e}(Sl),Il=function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.prototype.loadTile=function(){return Pl.apply(this,arguments)},e}(Al);Us.registerRenderer("canvas",Ll),Us.registerRenderer("gl",Il);var Rl="undefined"!=typeof Int8Array?new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]):[],Dl=function(){function t(t,e,i){this.gl=t,this.quadVertices=e||Rl,this.attributes=["a_position",3,kl(e)],this.debug=i}var e=t.prototype;return e.start=function(){var t=this.gl;t.enable(t.STENCIL_TEST),t.stencilMask(255),t.stencilOp(t.KEEP,t.REPLACE,t.REPLACE),t.depthMask(!1),this._save(),this.buffer||(this._createBuffer(),this._createProgram()),t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),Zs(t,this.program,this.attributes),this.transformLoc||(this.transformLoc=t.getUniformLocation(this.program,"transform")),this.colorLoc||(this.colorLoc=t.getUniformLocation(this.program,"color")),this.debug||t.colorMask(!1,!1,!1,!1)},e.end=function(){var t=this.gl;t.depthMask(!0),this._restore(),this.debug||t.colorMask(!0,!0,!0,!0)},e.draw=function(t){var e=this.gl;e.uniformMatrix4fv(this.transformLoc,!1,t),e.uniform3fv(this.colorLoc,[Math.random(),Math.random(),Math.random()]),e.drawArrays(e.TRIANGLE_STRIP,0,4)},e.remove=function(){var t=this.gl;return this.buffer&&t.deleteBuffer(this.buffer),this.program&&(t.deleteShader(this.program.fragmentShader),t.deleteShader(this.program.vertexShader),t.deleteProgram(this.program)),delete this.transformLoc,delete this.gl,this},e.stencilMask=function(t){return this.gl.stencilMask(t),this},e.stencilFunc=function(t,e,i){return this.ref=e,this.gl.stencilFunc(t,e,i),this},e.stencilOp=function(t,e,i){return this.gl.stencilOp(t,e,i),this},e.resetFunc=function(){return this.ref=1,this.gl.stencilFunc(this.gl.ALWAYS,1,255),this},e._save=function(){var t=this.gl;this._savedProgram=t.program},e._restore=function(){var t=this.gl;t.program=this._savedProgram,t.program&&t.useProgram(t.program)},e._createBuffer=function(){var t=this.gl;if(this.buffer=t.createBuffer(),!this.buffer)throw new Error("Failed to create the buffer object");t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.quadVertices,t.STATIC_DRAW)},e._createProgram=function(){var t=Hs(this.gl,"\n    attribute vec3 a_position;\n    uniform mat4 transform;\n\n    void main()\n    {\n        gl_Position = transform * vec4(a_position, 1.0);\n    }\n","\n    precision mediump float;\n    uniform vec3 color;\n    void main()\n    {\n        gl_FragColor = vec4(color, 1.0);\n    }\n"),e=t.program,i=t.vertexShader,n=t.fragmentShader;e.vertexShader=i,e.fragmentShader=n,this.program=e},t}();function kl(t){return t instanceof Float32Array?"FLOAT":t instanceof Int16Array?"SHORT":t instanceof Uint16Array?"UNSIGNED_SHORT":t instanceof Int8Array?"BYTE":t instanceof Uint8Array||t instanceof Uint8ClampedArray?"UNSIGNED_BYTE":"FLOAT"}var Ol=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.checkResources=function(){var t=this._geosToCheck;if(this._resourceChecked||t||(t=this.layer._geoList),!dt(t))return[];for(var e=[],i={},n=t.length-1;n>=0;n--){var r=t[n]._getExternalResources();if(r.length)if(this.resources)for(var o=0;o<r.length;o++){var a=r[o][0];this.resources.isResourceLoaded(r[o])||i[a]||(e.push(r[o]),i[a]=1)}else e.push.apply(e,r)}return this._resourceChecked=!0,delete this._geosToCheck,e},i.render=function(){return this.layer._sortGeometries(),t.prototype.render.apply(this,arguments)},i._addGeoToCheckRes=function(t){t&&(Array.isArray(t)||(t=[t]),this._geosToCheck||(this._geosToCheck=[]),nt(this._geosToCheck,t))},i.onGeometryAdd=function(t){this._addGeoToCheckRes(t),zl(this)},i.onGeometryRemove=function(){zl(this)},i.onGeometrySymbolChange=function(t){this._addGeoToCheckRes(t.target),zl(this)},i.onGeometryShapeChange=function(){zl(this)},i.onGeometryPositionChange=function(){zl(this)},i.onGeometryZIndexChange=function(){zl(this)},i.onGeometryShow=function(){zl(this)},i.onGeometryHide=function(){zl(this)},i.onGeometryPropertiesChange=function(){zl(this)},e}(kn);function zl(t){t.layer.options.drawImmediate&&t.render(),t.setToRedraw()}var Bl=new pn,Fl=[],Nl=new pn,jl=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.checkResources=function(){var e=this,i=t.prototype.checkResources.apply(this,arguments),n=this.layer.getStyle();return n&&(Array.isArray(n)||(n=[n]),n.forEach((function(t){for(var n=te(t.symbol,!0),r=0,o=n.length;r<o;r++)e.resources.isResourceLoaded(n[r])||i.push(n[r])}))),i},i.needToRedraw=function(){var e=this.getMap();return!(!e.isInteracting()||!this.layer.options.enableAltitude)||!(e.isZooming()&&!e.isRotating()&&!e.getPitch()&&!this._hasPoint&&this.layer.constructor===ia)&&t.prototype.needToRedraw.call(this)},i.draw=function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty())return this.clearCanvas(),void this.completeRender();this.prepareCanvas(),this.drawGeos(),this.completeRender()}},i.isBlank=function(){return!!this.context&&!this.context.canvas._drawn},i.drawOnInteracting=function(){if(this._geosToDraw){this._updateMapStateCache(),this._updateDisplayExtent();var t=this.getMap(),e=this.layer.getCount(),i=this.mapStateCache.resolution;(t.isZooming()&&t.options.seamlessZoom&&void 0!==this._drawnRes&&i>1.5*this._drawnRes&&this._geosToDraw.length<e||t.isMoving()||t.isInteracting())&&(this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glZoom),this.forEachGeo(this.checkGeo,this),this._drawnRes=i),this._sortByDistanceToCamera(t.cameraPosition);for(var n=0,r=this._geosToDraw.length;n<r;n++){var o=this._geosToDraw[n];o._isCheck||o.isVisible()?(o._paint(this._displayExtent),delete this._geosToDraw[n]._cPoint,delete this._geosToDraw[n]._inCurrentView):(delete o._cPoint,delete o._inCurrentView)}}},i.show=function(){this.layer.forEach((function(t){t._repaint()})),t.prototype.show.apply(this,arguments)},i.forEachGeo=function(t,e){this.layer.forEach(t,e)},i.drawGeos=function(){this._updateMapStateCache(),this._drawnRes=this.mapStateCache.resolution,this._updateDisplayExtent(),this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glZoom),this.forEachGeo(this.checkGeo,this),this._sortByDistanceToCamera(this.getMap().cameraPosition);for(var t=0,e=this._geosToDraw.length;t<e;t++)this._geosToDraw[t]._paint(),delete this._geosToDraw[t]._cPoint,delete this._geosToDraw[t]._inCurrentView},i.prepareToDraw=function(){this._hasPoint=!1,this._geosToDraw=[]},i.checkGeo=function(t){if(t._isCheck=!1,t&&t.isVisible()&&t.getMap()&&t.getLayer()&&t.getLayer().isCanvasRender()){var e=t._getPainter(),i=!0;if(t._inCurrentView)i=!0;else if(!1===t._inCurrentView)i=!1;else{var n=e.get2DExtent(this.resources,Bl);n&&n.intersects(this._displayExtent)||(i=!1)}i&&(e.hasPoint()&&(this._hasPoint=!0),t._isCheck=!0,this._geosToDraw.push(t))}},i.onZoomEnd=function(){delete this.canvasExtent2D,t.prototype.onZoomEnd.apply(this,arguments)},i.onRemove=function(){this.forEachGeo((function(t){t.onHide()})),delete this._geosToDraw},i.onGeometryPropertiesChange=function(e){e&&this.layer._styleGeometry(e.target),t.prototype.onGeometryPropertiesChange.call(this,e)},i._updateDisplayExtent=function(){var t=this.canvasExtent2D;if(this._maskExtent){if(!this._maskExtent.intersects(t))return void this.completeRender();t=t.intersection(this._maskExtent)}this._displayExtent=t},i.identifyAtPoint=function(t,e){void 0===e&&(e={});var i=this._geosToDraw;return i?this.layer._hitGeos(i,t,e):[]},i._updateMapStateCache=function(){var t=this.getMap(),e=t._pointToContainerPoint(this.southWest)._add(0,-t.height),i=t.getResolution(),n=t.getPitch(),r=t.getBearing(),o=t.getGLScale(),a=t.getGLZoom(),s=t.getContainerExtent(),l=t._get2DExtent(),c=t._get2DExtent(a);return this.mapStateCache={resolution:i,pitch:n,bearing:r,glScale:o,glZoom:a,_2DExtent:l,glExtent:c,containerExtent:s,offset:e},this},i._batchConversionMarkers=function(t){for(var e=[],i=[],n=[],r={},o=0,a=0,s=this.layer._geoList.length;a<s;a++){var l=this.layer._geoList[a];if("Point"===l.getType()){var c=l._painter;if(!c)continue;var h=c.getRenderPoints("center")[0][0],u=l.getAltitude();void 0===r[u]&&(r[u]=c.getAltitude()),e[o]=h,n[o]=r[u],i[o]=l,o++}}if(0===o)return[];for(var d=this.getMap(),p=d._pointsToContainerPoints(e,t,n),f=d.getContainerExtent(),m=f.xmax,g=f.ymax,y=f.xmin,_=f.ymin,v={},x=0,b=i.length;x<b;x++){var w=i[x];w._cPoint=p[x];var M=p[x],T=M.x,S=M.y;if(w._inCurrentView=T>=y&&S>=_&&T<=m&&S<=g,!w._inCurrentView){var E=w._symbolHash,C=void 0;C=E?v[E]=v[E]||w._painter.getFixedExtent():w._painter.getFixedExtent(),Nl.set(C.xmin,C.ymin,C.xmax,C.ymax),Nl._add(p[x]),w._inCurrentView=Nl.intersects(f)}}return p},i._sortByDistanceToCamera=function(t){if(this.layer.options.sortByDistanceToCamera&&this._geosToDraw.length){var e=this.getMap(),i=e.distanceToPoint(1e3,0,e.getGLScale()).x/1e3;this._geosToDraw.sort((function(e,n){var r=e.getType(),o=n.getType();if("Point"!==r||"Point"!==o)return 0;var a=e._painter,s=n._painter;if(!a||!s)return 0;var l=a.getRenderPoints("center")[0][0],c=s.getRenderPoints("center")[0][0],h=a.getAltitude()*i,u=s.getAltitude()*i;_a(Fl,l.x,l.y,h);var d=Ma(Fl,t);return _a(Fl,c.x,c.y,u),Ma(Fl,t)-d}))}},e}(Ol);ia.registerRenderer("canvas",jl);var Gl=function(t){function e(e){var i;return(i=t.call(this)||this).map=e,i._handlerQueue={},i}ne(e,t);var i=e.prototype;return i.callInNextFrame=function(t){this._handlerQueue.push(t)},i.executeFrameCallbacks=function(){var t=this._handlerQueue;this._handlerQueue=[];for(var e=0,i=t.length;e<i;e++)t[e]()},i.offsetPlatform=function(t,e){if(!this.map._panels.front)return this;if(!e&&0===t.x&&0===t.y)return this;var i=this.map._panels,n=this._frontCount=i.back.layerDOM.childElementCount,r=this._backCount=i.front.layerDOM.childElementCount,o=this._uiCount=i.front.uiDOM.childElementCount;if(n||r||o){var a=this.map.offsetPlatform();a=t?a.add(t)._round():a.round(),r&&we(i.back,a),(n||o)&&we(i.front,a)}return this},i.domChanged=function(){var t=this.map._panels;if(!t.front)return!1;var e=t.back.layerDOM.childElementCount;if(void 0===this._frontCount||this._frontCount!==e)return!0;var i=t.front.layerDOM.childElementCount;if(void 0===this._backCount||this._backCount!==i)return!0;var n=t.front.uiDOM.childElementCount;return void 0===this._uiCount||this._uiCount!==n},i.resetContainer=function(){if(this.map&&(this.map._resetMapViewPoint(),this.map._panels.front)){var t=new ae(0,0);we(this.map._panels.back,t),we(this.map._panels.front,t)}},i.onZoomEnd=function(){this.resetContainer()},i.onLoad=function(){this._frameLoop()},e}(Si),Ul=function(t){function e(e){var i;return(i=t.call(this,e)||this)._containerIsCanvas=!!e._containerDOM.getContext,i._thisVisibilitychange=i._onVisibilitychange.bind(re(re(i))),i._registerEvents(),i._loopTime=0,i}ne(e,t);var i=e.prototype;return i.load=function(){this.initContainer()},i.renderFrame=function(t){if(!this.map)return!1;delete this._isViewChanged;var e=this.map;e._fireEvent("framestart"),this.updateMapDOM(),e.clearCollisionIndex();var i=this._getAllLayerToRender();return this.drawLayers(i,t),this.drawLayerCanvas(i)&&(this.drawTops(),this._drawCenterCross()),e._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(),this.executeFrameCallbacks(),this._canvasUpdated=!1,!0},i.updateMapDOM=function(){var t=this.map;if(!t.isZooming()){var e=t._getViewPointFrameOffset();e?t.offsetPlatform(e):this.domChanged()&&this.offsetPlatform(null,!0)}},i.drawLayers=function(t,e){for(var i=this.map,n=i.isInteracting(),r=[],o=[],a=i.options.fpsOnInteracting||0,s=0===a?0:1e3/a,l=this.map.options.layerCanvasLimitOnInteracting,c=t.length,h=i.getBaseLayer(),u=0,d=0;d<c;d++){var p=t[d];if(p.isVisible()){var f=p.isCanvasRender();f&&r.push(p.getId());var m=p._getRenderer();if(m){var g=this._checkLayerRedraw(p);f&&m.isCanvasUpdated()&&(g||o.push(p.getId()),this.setLayerCanvasUpdated());var y=m.__zoomTransformMatrix;if(delete m.__zoomTransformMatrix,g){if(n&&f){if(l>0&&c-1-d>l&&p!==h){p._getRenderer().clearCanvas();continue}u+=this._drawCanvasLayerOnInteracting(p,u,s,e)}else n&&m.drawOnInteracting?(m.prepareRender&&m.prepareRender(),m.checkAndDraw?m.checkAndDraw(m.drawOnInteracting,this._eventParam,e):m.drawOnInteracting(this._eventParam,e)):(m.render(e),f&&y&&m.isLoadingResource()&&(m.__zoomTransformMatrix=y));f&&(o.push(p.getId()),this.setLayerCanvasUpdated())}else f&&n&&(i.isZooming()&&!i.getPitch()?(m.prepareRender(),m.__zoomTransformMatrix=this._zoomMatrix):(i.getPitch()||i.isRotating())&&m.clearCanvas())}}}var _=this._canvasIds||[],v=this._updatedIds||[];if(this._canvasIds=r,this._updatedIds=o,!this.isLayerCanvasUpdated()){_.join("---")===r.join("---")&&v.join("---")===o.join("---")||this.setLayerCanvasUpdated()}},i._checkLayerRedraw=function(t){if(this.isSpatialReferenceChanged())return!0;var e=this.map,i=t._getRenderer();return t.isCanvasRender()?i.testIfNeedRedraw():!(!i.needToRedraw||!i.needToRedraw())||(e.isInteracting()||this.isViewChanged())},i._drawCanvasLayerOnInteracting=function(t,e,i,n){var r=this.map,o=t._getRenderer(),a=o.getDrawTime(),s=0===i||i>0&&e+a<=i;if(o.mustRenderOnInteracting&&o.mustRenderOnInteracting())o.render(n);else{if(o.drawOnInteracting&&(t===r.getBaseLayer()||s||r.isZooming()&&t.options.forceRenderOnZooming||r.isMoving()&&t.options.forceRenderOnMoving||r.isRotating()&&t.options.forceRenderOnRotating))return o.prepareRender(),o.prepareCanvas(),o.checkAndDraw?o.checkAndDraw(o.drawOnInteracting,this._eventParam,n):o.drawOnInteracting(this._eventParam,n),a;!r.isZooming()||r.getPitch()||r.isRotating()?(r.getPitch()||r.isRotating())&&o.clearCanvas():(o.prepareRender(),o.__zoomTransformMatrix=this._zoomMatrix)}return o.drawOnInteracting&&!s&&o.onSkipDrawOnInteracting(this._eventParam,n),0},i._fireLayerLoadEvents=function(){if(this._updatedIds&&this._updatedIds.length>0){var t=this.map;this._updatedIds.reverse().forEach((function(e){var i=t.getLayer(e);if(i){var n=i._getRenderer();n&&n.isRenderComplete()&&i.fire("layerload")}}))}},i.isLayerCanvasUpdated=function(){return this._canvasUpdated},i.setLayerCanvasUpdated=function(){this._canvasUpdated=!0},i.drawLayerCanvas=function(t){var e=this.map;if(!e)return!1;if(!this.isLayerCanvasUpdated()&&!this.isViewChanged())return!1;this.canvas||this.createCanvas(),e._fireEvent("renderstart",{context:this.context}),this._updateCanvasSize()||this.clearCanvas();for(var i,n=e.isInteracting(),r=e.options.layerCanvasLimitOnInteracting,o=t.length,a=[],s=0;s<o;s++){if(t[s].isVisible()&&t[s].isCanvasRender())if(t[s]._getRenderer()){var l=this._getLayerImage(t[s]);l&&l.image&&(t[s]===e.getBaseLayer()?i=[t[s],l]:a.push([t[s],l]))}}i&&(this._drawLayerCanvasImage(i[0],i[1]),this._drawFog()),o=a.length;for(var c=n&&r>=0&&o>r?o-r:0;c<o;c++)this._drawLayerCanvasImage(a[c][0],a[c][1]);return e._fireEvent("renderend",{context:this.context}),!0},i.setToRedraw=function(){for(var t=this._getAllLayerToRender(),e=0,i=t.length;e<i;e++){var n=t[e].getRenderer();n&&n.canvas&&n.setToRedraw&&n.setToRedraw()}},i.updateMapSize=function(t){if(t&&!this._containerIsCanvas){var e=t.width+"px",i=t.height+"px",n=this.map._panels;n.mapWrapper.style.width=e,n.mapWrapper.style.height=i,this._updateCanvasSize()}},i.getMainPanel=function(){return this.map?this._containerIsCanvas?this.map._containerDOM:this.map._panels?this.map._panels.mapWrapper:null:null},i.toDataURL=function(t,e){return this.canvas?this.canvas.toDataURL(t,e):null},i.remove=function(){O.webgl&&"undefined"!=typeof document&&ye(document,"visibilitychange",this._thisVisibilitychange),this._resizeInterval&&clearInterval(this._resizeInterval),delete this.context,delete this.canvas,delete this.map,delete this._spatialRefChanged,this._cancelFrameLoop()},i.hitDetect=function(t){var e=this.map;if(e&&e.options.hitDetect&&!e.isInteracting()){for(var i=e._getLayers(),n="default",r=e.options.hitDetectLimit||0,o=0,a=i.length-1;a>=0;a--){var s=i[a];if(!(!s.options.hitDetect||s.isEmpty&&s.isEmpty())){var l=s._getRenderer();if(l&&l.hitDetect&&(!l.isBlank||!l.isBlank())){if("default"!==s.options.cursor&&l.hitDetect(t)){n=s.options.cursor||"pointer";break}if(o++,r>0&&o>r)break}}}e._trySetCursor(n)}},i._getLayerImage=function(t){var e=t._getRenderer();return e.getCanvasImage?e.getCanvasImage():null},i.initContainer=function(){var t=this.map._panels;function e(e,i,n,r){var o=pe("div",i);return n&&(o.style.cssText=n),t[e]=o,r||be(o),o}var i=this.map._containerDOM;if(!this._containerIsCanvas){i.innerHTML="";var n="position:absolute;top:0px;left:0px;",r=e("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),o=e("allLayers","maptalks-all-layers",n+"padding:0px;margin:0px;z-index:0;overflow:visible;",!0),a=e("backStatic","maptalks-back-static",n+"z-index:0;",!0),s=e("back","maptalks-back",n+"z-index:1;"),l=e("backLayer","maptalks-back-layer",n),c=e("canvasContainer","maptalks-canvas-layer",n+"border:none;z-index:2;"),h=e("frontStatic","maptalks-front-static",n+"z-index:3;",!0),u=e("front","maptalks-front",n+"z-index:4;",!0),d=e("frontLayer","maptalks-front-layer",n+"z-index:0;"),p=e("ui","maptalks-ui",n+"border:none;z-index:1;",!0),f=e("control","maptalks-control","z-index:1",!0);i.appendChild(r),o.appendChild(a),s.appendChild(l),s.layerDOM=l,o.appendChild(s),o.appendChild(c),u.appendChild(d),u.layerDOM=d,u.uiDOM=p,o.appendChild(h),o.appendChild(u),u.appendChild(p),r.appendChild(o),r.appendChild(f),this.createCanvas(),this.resetContainer();var m=this.map._getContainerDomSize();this.updateMapSize(m)}},i.isViewChanged=function(){if(void 0!==this._isViewChanged)return this._isViewChanged;var t=this._mapview,e=this._getMapView();return this._isViewChanged=!t||!wt(t,e),this._isViewChanged},i._recordView=function(){var t=this.map;!t._onViewChange||t.isInteracting()||t.isAnimating()||wt(t.getView(),t._getCurrentView())||t._onViewChange(t.getView())},i.isSpatialReferenceChanged=function(){return this._spatialRefChanged},i._getMapView=function(){var t=this.map,e=t._getPrjCenter();return{x:e.x,y:e.y,zoom:t.getZoom(),pitch:t.getPitch(),bearing:t.getBearing(),width:t.width,height:t.height}},i._frameLoop=function(t){var e=this;this.map?(this.map.options.renderable&&this.renderFrame(t),this._animationFrame=W((function(t){e._frameLoop(t)}))):this._cancelFrameLoop()},i._cancelFrameLoop=function(){this._animationFrame&&q(this._animationFrame)},i._drawLayerCanvasImage=function(t,e){var i=this.context,n=e.point.round(),r=this.map.getDevicePixelRatio();1!==r&&n._multi(r);var o=e.image,a=o.width,s=o.height;if(!(n.x+a<=0||n.y+s<=0)){var l=t.options.opacity;if(N(l)||(l=1),!(l<=0)){var c=e.opacity;if(N(c)||(c=1),!(c<=0)){var h=i.globalAlpha;l<1&&(i.globalAlpha*=l),c<1&&(i.globalAlpha*=c),t.options.cssFilter&&(i.filter=t.options.cssFilter);var u=t.getRenderer(),d=u.__zoomTransformMatrix,p=u.clipCanvas(this.context);d&&(i.save(),i.setTransform.apply(i,d)),i.drawImage(o,0,0,a,s,n.x,n.y,a,s),d&&i.restore(),p&&i.restore(),"none"!==i.filter&&(i.filter="none"),i.globalAlpha=h}}}},i._drawCenterCross=function(){var t=this.map.options.centerCross;if(t){var e=this.context,i=new ae(this.canvas.width/2,this.canvas.height/2);V(t)?t(e,i):fi.drawCross(this.context,i.x,i.y,2,"#f00")}},i._drawContainerExtent=function(){var t=this.map.options.cascadePitches,e=this.map.height-this.map._getVisualHeight(t[0]),i=this.map.height-this.map._getVisualHeight(t[1]),n=this.map.getContainerExtent(),r=this.context;r.beginPath(),r.moveTo(0,n.ymin),r.lineTo(n.xmax,n.ymin),r.stroke(),r.beginPath(),r.moveTo(0,e),r.lineTo(n.xmax,e),r.stroke(),r.beginPath(),r.moveTo(0,i),r.lineTo(n.xmax,i),r.stroke()},i._drawFog=function(){var t=this.map;if(!(t.getPitch()<=t.options.maxVisualPitch)&&t.options.fog){var e=t.getDevicePixelRatio(),i=this.context,n=t.getContainerExtent(),r=(t.height-t._getVisualHeight(75))*e;r<0&&(r=0);var o=n.ymin*e,a=Math.ceil(o-r),s=t.options.fogColor.join(),l=i.createLinearGradient(0,r,0,o+30),c=1-30/(a+30);l.addColorStop(0,"rgba("+s+", 0)"),l.addColorStop(.3,"rgba("+s+", 0.3)"),l.addColorStop(c,"rgba("+s+", 1)"),l.addColorStop(1,"rgba("+s+", 0)"),i.beginPath(),i.fillStyle=l,i.fillRect(0,r,Math.ceil(n.getWidth())*e,Math.ceil(a+30))}},i._getAllLayerToRender=function(){return this.map._getLayers()},i.clearCanvas=function(){this.canvas&&fi.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},i._updateCanvasSize=function(){if(!this.canvas||this._containerIsCanvas)return!1;var t=this.map,e=t.getSize(),i=this.canvas,n=t.getDevicePixelRatio();return(e.width*n!==i.width||e.height*n!==i.height)&&(i.height=n*e.height,i.width=n*e.width,this.topLayer.width=i.width,this.topLayer.height=i.height,i.style&&(i.style.width=e.width+"px",i.style.height=e.height+"px"),!0)},i.createCanvas=function(){this.topLayer=pe("canvas"),this.topCtx=this.topLayer.getContext("2d"),this._containerIsCanvas?this.canvas=this.map._containerDOM:(this.canvas=pe("canvas"),this._updateCanvasSize(),this.map._panels.canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d")},i._checkSize=function(){this.map&&(Me(this.map._containerDOM),this.map.checkSize())},i._setCheckSizeInterval=function(t){var e=this;"undefined"!=typeof window&&window.ResizeObserver?(this._resizeObserver&&this._resizeObserver.disconnect(),this.map&&(this._resizeObserver=new ResizeObserver((function(t){!e.map||e.map.isRemoved()?e._resizeObserver.disconnect():t.length&&e._checkSize(t[0].contentRect)})),this._resizeObserver.observe(this.map._containerDOM))):(clearInterval(this._resizeInterval),this._checkSizeInterval=t,this._resizeInterval=setInterval((function(){!e.map||e.map.isRemoved()?clearInterval(e._resizeInterval):e._checkSize()}),this._checkSizeInterval))},i._registerEvents=function(){var t=this,e=this.map;e.options.checkSize&&!u&&"undefined"!=typeof window&&this._setCheckSizeInterval(e.options.checkSizeInterval),O.mobile||e.on("_mousemove",this._onMapMouseMove,this),e.on("_dragrotatestart _dragrotating _dragrotateend _movestart _moving _moveend _zoomstart",(function(e){t._eventParam=e})),e.on("_zooming",(function(i){e.getPitch()||(t._zoomMatrix=i.matrix.container),t._eventParam=i})),e.on("_zoomend",(function(e){t._eventParam=e,delete t._zoomMatrix})),e.on("_spatialreferencechange",(function(){t._spatialRefChanged=!0})),O.webgl&&"undefined"!=typeof document&&ge(document,"visibilitychange",this._thisVisibilitychange,this)},i._onMapMouseMove=function(t){var e=this,i=this.map;!i.isInteracting()&&i.options.hitDetect&&(this._hitDetectFrame&&q(this._hitDetectFrame),this._hitDetectFrame=W((function(){e.hitDetect(t.containerPoint)})))},i._getCanvasLayers=function(){return this.map._getLayers((function(t){return t.isCanvasRender()}))},i._onVisibilitychange=function(){"visible"===document.visibilityState&&this.setToRedraw()},i.addTopElement=function(t){this._tops||(this._tops=[]),this._tops.push(t)},i.removeTopElement=function(t){if(this._tops){var e=this._tops.indexOf(t);e>=0&&this._tops.splice(e,1)}},i.getTopElements=function(){return this._tops||[]},i.drawTops=function(){this.topCtx.clearRect(0,0,this.topLayer.width,this.topLayer.height),this.map.fire("drawtopstart"),this.map.fire("drawtops");for(var t=this.getTopElements(),e=!1,i=0;i<t.length;i++)t[i].render(this.topCtx)&&(e=!0);e&&this.context.drawImage(this.topLayer,0,0),this.map.fire("drawtopsend")},e}(Gl);ro.registerRenderer("canvas",Ul),ro.mergeOptions({fog:!1,fogColor:[233,233,233]});var Vl=Object.freeze({ResourceCache:On,CanvasRenderer:kn,ImageGLRenderable:Ks,MapRenderer:Gl,MapCanvasRenderer:Ul,Renderable:Dn,ImageLayerCanvasRenderer:nl,ImageLayerGLRenderer:rl,TileLayerCanvasRenderer:Sl,TileLayerGLRenderer:Al,CanvasTileLayerCanvasRenderer:Ll,CanvasTileLayerGLRenderer:Il,QuadStencil:Dl,OverlayLayerCanvasRenderer:Ol,VectorLayerCanvasRenderer:jl,CanvasLayerRenderer:ol}),Hl={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getGLZoom())],null]}};Mo.include(Hl),Bo.include(Hl),zo.include(Hl),No.include(Hl),Fo.include({_getRenderPoints:function(t){var e=this.getMap();if("vertex"===t){for(var i=this._trimRing(this.getShell()),n=[],r=0,o=i.length;r<o;r++)n.push(e.coordToPoint(i[r],e.getGLZoom()));return[n,null]}return[[e.coordToPoint(this.getCenter(),e.getGLZoom())],null]}});var Zl={_getRenderPoints:function(t){var e,i=this.getMap(),n=i.getGLZoom(),r=null;if("point"===t)(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,n))&&e.length>0&&Array.isArray(e[0])&&(e=e[0].concat(e[1]));else if("vertex"===t)if(r=[],(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,n))&&e.length>0&&Array.isArray(e[0])){for(var o=0,a=e.length;o<a;o++)for(var s=0,l=e[o].length;s<l;s++)0===s?r.push([e[o][s],e[o][s+1]]):r.push([e[o][s-1],e[o][s]]);e=e[0].concat(e[1])}else for(var c=0,h=e.length;c<h;c++)0===c?r.push([e[c],e[c+1]]):r.push([e[c-1],e[c]]);else if("line"===t){e=[],r=[];var u=this._getPath2DPoints(this._getPrjCoordinates(),!1,n);if(u.length>0&&Array.isArray(u[0]))for(var d,p=1,f=u.length;p<f;p++){d=u[p],this instanceof xo&&d.length>0&&!d[0].equals(d[d.length-1])&&d.push(d[0]);for(var m=1,g=d.length;m<g;m++)e.push(d[m].add(d[m-1])._multi(.5)),r.push([d[m-1],d[m]])}else{this instanceof xo&&u.length>0&&!u[0].equals(u[u.length-1])&&u.push(u[0]);for(var y=1,_=u.length;y<_;y++)e.push(u[y].add(u[y-1])._multi(.5)),r.push([u[y-1],u[y]])}}else if("vertex-first"===t){var v=this._getPrjCoordinates();e=v.length?[i._prjToPoint(v[0],n)]:[],r=v.length?[[i._prjToPoint(v[0],n),i._prjToPoint(v[1],n)]]:[]}else if("vertex-last"===t){var x=this._getPrjCoordinates(),b=x.length;e=b?[i._prjToPoint(x[b-1],n)]:[];var w=b-1,M=b>1?b-2:b-1;r=b?[[i._prjToPoint(x[M],n),i._prjToPoint(x[w],n)]]:[]}else{var T=this._getProjection().project(this.getCenter());e=[i._prjToPoint(T,n)]}return[e,r]}};So.include(Zl),xo.include(Zl);var Wl={within:!1,center:[0,0]};function ql(t){if(t&&t._containerBbox){Wl.within=!1;var e=t._containerBbox,i=e.minx,n=e.miny,r=e.maxx,o=e.maxy,a=Math.abs(r-i),s=Math.abs(o-n);a<=1&&s<=1&&(Wl.within=!0,Wl.center[0]=(i+r)/2,Wl.center[1]=(n+o)/2),delete t._containerBbox}else Wl.within=!1;return Wl}Wr.include({_redrawWhenPitch:function(){return!1},_redrawWhenRotate:function(){return!1}});var Xl={_redrawWhenPitch:function(){return!0},_redrawWhenRotate:function(){return this instanceof Bo||this instanceof No},_paintAsPath:function(){var t=this.getMap();return this.getAltitude()>0||t.getPitch()||this instanceof Bo&&t.getBearing()},_getPaintParams:function(){var t=this.getMap();if(this._paintAsPath())return xo.prototype._getPaintParams.call(this,!0);var e=this._getPrjCoordinates(),i=t._prjToPoint(e,t.getGLZoom()),n=this._getRenderSize(i);return[i].concat(n)},_paintOn:function(){return this._paintAsPath()?fi.polygon.apply(fi,arguments):fi.ellipse.apply(fi,arguments)},_getRenderSize:function(t){var e=this.getMap(),i=e.getGLZoom(),n=this._getPrjExtent(),r=e._prjToPoint(n.getMin(),i),o=e._prjToPoint(n.getMax(),i);return[Math.abs(o.x-r.x)/2,Math.abs(o.y-t.y),Math.abs(t.y-r.y)]}};Bo.include(Xl),zo.include(Xl),Fo.include({_getPaintParams:function(){var t=this.getMap().getGLZoom(),e=this._getPrjShell();return[this._getPath2DPoints(e,!1,t)]},_paintOn:fi.polygon}),No.include(Xl,{_redrawWhenPitch:function(){return!0},_getPaintParams:function(){if(this._paintAsPath())return xo.prototype._getPaintParams.call(this,!0);var t=this.getMap(),e=t._prjToPoint(this._getPrjCoordinates(),t.getGLZoom());return[e,this._getRenderSize(e)[0],[this.getStartAngle(),this.getEndAngle()]]},_paintOn:function(){if(this._paintAsPath())return fi.polygon.apply(fi,arguments);var t=this.getMap().getBearing(),e=arguments;return t&&(e[3]=e[3].slice(0),e[3][0]+=t,e[3][1]+=t),fi.sector.apply(fi,e)}}),vo.include({_paintAsPath:function(){return!0}}),So.include({arrowStyles:{classic:[3,4]},_getArrowShape:function(t,e,i,n,r){if(!t||!e||t.equals(e))return null;r||(r=0);var o,a=i*n[0],s=i*n[1]+r,l=a/2+r;(o=e.nextCtrlPoint||e.prevCtrlPoint?e.prevCtrlPoint?e.sub(new ae(e.prevCtrlPoint)):e.sub(new ae(e.nextCtrlPoint)):e.sub(t))._unit();var c=e.sub(o.multi(s));o._perp();var h=c.add(o.multi(l));return o._multi(-1),[h,e,c.add(o.multi(l)),h]},_getPaintParams:function(){var t=this._getPrjCoordinates();return[this._getPath2DPoints(t,!1,this.getMap().getGLZoom())]},_paintOn:function(t,e,i,n,r){var o=ql(this._painter);o.within?fi.pixelRect(t,o.center,i,n):this.options.smoothness?fi.paintSmoothLine(t,e,i,this.options.smoothness,!1,this._animIdx,this._animTailRatio):fi.path(t,e,i,null,r),this._paintArrow(t,e,i)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var t=this.options.arrowStyle;return t?Array.isArray(t)?t:this.arrowStyles[t]:null},_getArrows:function(t,e,i){var n=this._getArrowStyle();if(!n||t.length<2)return[];for(var r=t.length>0&&Array.isArray(t[0])?t:[t],o=this._getArrowPlacement(),a=[],s=this.getMap(),l=s.coordToContainerPoint(this.getFirstCoordinate()),c=s.coordToContainerPoint(this.getLastCoordinate()),h=r.length-1;h>=0;h--){if("vertex-first"===o||"vertex-firstlast"===o&&r[h][0].closeTo(l,.01)){var u=this._getArrowShape(r[h][1],r[h][0],e,n,i);u&&a.push(u)}if("vertex-last"===o||"vertex-firstlast"===o&&r[h][r[h].length-1].closeTo(c,.01)){var d=this._getArrowShape(r[h][r[h].length-2],r[h][r[h].length-1],e,n,i);d&&a.push(d)}else"point"===o&&this._getArrowPoints(a,r[h],e,n,i)}return a},_getArrowPoints:function(t,e,i,n,r){for(var o=0,a=e.length-1;o<a;o++){var s=this._getArrowShape(e[o],e[o+1],i,n,r);s&&t.push(s)}},_paintArrow:function(t,e,i){var n=this._getInternalSymbol().lineWidth;(!N(n)||n<3)&&(n=3);var r=this._getArrows(e,n);if(r.length){t.setLineDash&&t.setLineDash([]);for(var o=r.length-1;o>=0;o--)t.fillStyle=t.strokeStyle,fi.polygon(t,r[o],i,i)}}}),xo.include({_getPaintParams:function(t){var e=this.getMap().getGLZoom(),i=this._getPrjShell(),n=this._getPath2DPoints(i,t,e),r=n.length>0&&Array.isArray(n[0]);r&&(n=[[n[0]],[n[1]]]);var o=this._getPrjHoles(),a=[];if(o&&o.length>0){for(var s=this._simplified,l=0;l<o.length;l++){var c=this._getPath2DPoints(o[l],t,e);Array.isArray(c)&&r?Array.isArray(c[0])?(n[0].push(c[0]),n[1].push(c[1])):n[0].push(c):a.push(c)}s&&(this._simplified=s)}return r||nt(n=[n],a),[n]},_paintOn:function(t,e,i,n,r){var o=ql(this._painter);o.within?fi.pixelRect(t,o.center,i,n):fi.polygon(t,e,i,n,r,this.options.smoothness)}});var Yl={};function $l(t,e){Yl[t]=e}var Jl;function Kl(){if("undefined"==typeof window)return null;if(!Jl){var t=function(){var t="\n    var adapters = {};\n    onmessage = function (msg) {\n        msg = msg.data;\n        var workerKey = msg.workerKey;\n        var adapter = adapters[workerKey];\n        if (!adapter) {\n            post(msg.callback, 'Unregistered worker adapters for ' + workerKey);\n            return;\n        }\n        try {\n            adapter.onmessage(msg, wrap(msg.callback));\n        } catch (err) {\n            post(msg.callback, workerKey + ':' + err.message);\n            console.error(err);\n            throw err;\n        }\n    };\n    function post(callback, err, data, buffers) {\n        var msg = {\n            callback : callback\n        };\n        if (err) {\n            msg.error = err;\n        } else {\n            msg.data = data;\n        }\n        if (buffers && buffers.length > 0) {\n            postMessage(msg, buffers);\n        } else {\n            postMessage(msg);\n        }\n    }\n    function wrap(callback) {\n        return function (err, data, buffers) {\n            post(callback, err, data, buffers);\n        };\n    }\n    var workerExports;\n";for(var e in Yl){t+="\n    workerExports = {};\n    ("+Yl[e]+")(workerExports, self);\n    adapters['"+e+"'] = workerExports",t+="\n    workerExports.initialize && workerExports.initialize(self);\n        "}return t+="\n    workerExports = null;\n"}();Jl=window.URL.createObjectURL(new Blob([t],{type:"text/javascript"})),Yl=null}return Jl}var Ql,tc="undefined"!=typeof window?window.navigator.hardwareConcurrency||4:0,ec=Math.max(Math.floor(tc/2),1),ic=function(){function t(){this.active={},this.workerCount="undefined"!=typeof window?window.MAPTALKS_WORKER_COUNT||ec:0}var e=t.prototype;return e.acquire=function(t){if(!this.workers){this.workers=[];for(var e=Kl(),i=0;i<this.workerCount;i++){var n=new Worker(e);n.id=i,this.workers.push(n)}}return this.active[t]=!0,this.workers.slice()},e.release=function(t){delete this.active[t],0===Object.keys(this.active).length&&(this.workers.forEach((function(t){t.terminate()})),this.workers=null)},t}();var nc=0,rc=[],oc=function(){function t(t){var e=this;this.workerKey=t,this.workerPool=(Ql||(Ql=new ic),Ql),this.currentActor=0,this.actorId=tt(),this.workers=this.workerPool.acquire(this.actorId),this.callbacks={},this.callbackID=0,this.receiveFn=this.receive.bind(this),this.workers.forEach((function(t){t.addEventListener("message",e.receiveFn,!1)}))}var e=t.prototype;return e.isActive=function(){return!!this.workers},e.broadcast=function(t,e,i){var n=this;return i=i||function(){},function(t,e,i){t.length||i(null,[]);var n=t.length,r=new Array(t.length),o=null;t.forEach((function(t,a){e(t,(function(t,e){t&&(o=t),r[a]=e,0==--n&&i(o,r)}))}))}(this.workers,(function(i,r){n.send(t,e,r,i.id)}),i),this},e.send=function(t,e,i,n){var r=i?this.actorId+":"+this.callbackID++:null;return i&&(this.callbacks[r]=i),this.post({data:t,callback:String(r)},e,n),this},e.receive=function(t){var e=this,i=t.data,n=i.callback,r=this.callbacks[n];delete this.callbacks[n],"<request>"===i.type?this.actorId===i.actorId&&this[i.command](i.params,(function(t,n,r){var o={type:"<response>",callback:i.callback};t?o.error=t.message:o.data=n,e.post(o,r||rc,i.workerId)})):r&&i.error?r(i.error):r&&r(null,i.data)},e.remove=function(){var t=this;this.workers.forEach((function(e){e.removeEventListener("message",t.receiveFn,!1)})),this.workerPool.release(this.actorId),delete this.receiveFn,delete this.workers,delete this.callbacks,delete this.workerPool},e.post=function(t,e,i){return("number"!=typeof i||isNaN(i))&&(i=this.currentActor=(this.currentActor+1)%this.workerPool.workerCount),t.workerId=i,t.workerKey=this.workerKey,t.actorId=this.actorId,this.workers[i].postMessage(t,e||rc),i},e.getDedicatedWorker=function(){return nc=(nc+1)%this.workerPool.workerCount},t}();ro.VERSION="1.0.0-alpha.17";var ac={Actor:oc}}).call(this,i(20),i(17),i(28).setImmediate)},function(e,i){e.exports=t},function(t,e,i){"use strict";(function(t){i.d(e,"f",(function(){return r})),i.d(e,"c",(function(){return o})),i.d(e,"d",(function(){return a})),i.d(e,"a",(function(){return l})),i.d(e,"b",(function(){return c})),i.d(e,"e",(function(){return h}));var n=i(4),r=function(e){var i=e.geometry;if(i){i.computeBoundingBox();var n=i.boundingBox.getCenter(new t.Vector3),r=new t.Matrix4;r.makeTranslation(-n.x,-n.y,-n.z),i.applyMatrix4(r),e.position.copy(n)}},o=function(t){var e=t.toLocaleLowerCase(),i=1;if(e.includes("rgba")){var n=e.split(",");i=+n[n.length-1].split(")")[0]}return[e,i]},a=function(t){var e=t.parent.loading,i=t.id,n=e.find((function(t){return t.id==i}));return n?n.loaded=!1:(n={id:i,loaded:!1},e.push(n)),n},s=function(t,e){var i=e.fontSize,n=e.fontFamily,r=e.color;t.font="normal ".concat(i,"px ").concat(n),t.fillStyle=r,t.textAlign="left",t.textBaseline="bottom"},l=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.width,i=t.height,n=t.item,r=void 0===n?{}:n,o=t.lines,a=void 0===o?[]:o,l=t.image,c=void 0===l?new Image:l,h=document.createElement("canvas");h.setAttribute("width",e),h.setAttribute("height",i),h.style.position="absolute";var u=h.getContext("2d");return u.drawImage(c,0,0,e,i),a.map((function(t){var e=t.mapping,i=e.field,n=e.showName,o=t.position,a=o.x,l=o.y,c=t.labelConfig,h=t.valueConfig,d=t.suffixConfig,p=n;s(u,c.simpleTextStyle),u.fillText(p,a,l),a+=u.measureText(p).width,a+=c.paddingRight;var f=r[i];if(s(u,h.simpleTextStyle),u.fillText(f,a,l),a+=u.measureText(f).width,d.show){a+=d.paddingLeft;var m=d.content||"";s(u,d.simpleTextStyle),u.fillText(m,a,l)}})),h},c=function(e){var i=document.createElement("video");i.muted=!0,i.preload="auto",i.loop=!0,i.autoplay=!0,i.controls=!0,i.crossOrigin="anonymous",i.src=window.appConfig.ASSETS_URL+e,i.addEventListener("canplay",(function(t){return t.target.play()}));var n=new t.VideoTexture(i);return n.minFilter=t.LinearFilter,n.magFilter=t.LinearFilter,n.format=t.RGBAFormat,n.encoding=t.sRGBEncoding,n.needsUpdate=!0,n},h=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[.5,1],e=Object(n.a)(t,2),i=e[0],r=void 0===i?0:i,o=e[1],a=void 0===o?0:o;return[r,1-a]}}).call(this,i(0))},function(t,e,i){"use strict";i.d(e,"a",(function(){return r}));var n=i(15);function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var i=[],n=!0,r=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(i.push(a.value),!e||i.length!==e);n=!0);}catch(t){r=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(r)throw o}}return i}}(t,e)||Object(n.a)(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}},function(t,e,i){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}i.d(e,"a",(function(){return n}))},function(t,e,i){"use strict";function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function r(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}i.d(e,"a",(function(){return r}))},function(t,e,i){"use strict";function n(t){t&&(t.map&&(t.map.dispose(),t.map=void 0),t.normalMap&&(t.normalMap.dispose(),t.normalMap=void 0),t.specularMap&&(t.specularMap.dispose(),t.specularMap=void 0),t.bumpMap&&(t.bumpMap.dispose(),t.bumpMap=void 0),t.dispose(),t=void 0)}function r(t){t.geometry&&(t.geometry.dispose(),t.geometry=void 0),t.material&&t.material instanceof Array?t.material.forEach((function(t){return n(t)})):t.material&&n(t.material)}Object.defineProperty(e,"__esModule",{value:!0}),e.disposeMaterial=n,e.dispose=r,e.deepDispose=function(t){t.traverse((function(t){return r(t)}))},e.deepDisposeGroup=function t(e){var i=e.children;if(i)for(var n=0,o=i.length;n<o;n++)"Mesh"===i[n].type&&r(i[n]),t(i[n])},e.deepDisposeGroupGeometry=function t(e){var i=e.children;if(i)for(var n=0,r=i.length;n<r;n++)"Mesh"===i[n].type&&i[n].geometry&&(i[n].geometry.dispose(),i[n].geometry=null),t(i[n])}},function(t,e,i){"use strict";function n(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function r(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function o(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?r(Object(i),!0).forEach((function(e){n(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}i.d(e,"a",(function(){return o}))},function(t,e,i){"use strict";function n(t){return(n=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}i.d(e,"a",(function(){return l}));var a=i(14);function s(t,e){return!e||"object"!==o(e)&&"function"!=typeof e?Object(a.a)(t):e}function l(t){return function(){var e,i=n(t);if(r()){var o=n(this).constructor;e=Reflect.construct(i,arguments,o)}else e=i.apply(this,arguments);return s(this,e)}}},function(t,e,i){"use strict";function n(t,e){return(n=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&n(t,e)}i.d(e,"a",(function(){return r}))},function(t,e,i){"use strict";i.d(e,"a",(function(){return o}));var n=i(5),r=i(6),o=function(){function t(){Object(n.a)(this,t)}return Object(r.a)(t,[{key:"init",value:function(){}},{key:"onZoom",value:function(t){}},{key:"getSupportObjects",value:function(){}},{key:"selectAction",value:function(t){}},{key:"animate",value:function(){}},{key:"updateComponent",value:function(t){}},{key:"destroy",value:function(){}}]),t}()},function(t,i){t.exports=e},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.reduceConfig2=function t(e){if(!Array.isArray(e))return e;return e.reduce((function(e,i){return e[i.name]=i.type&&!r.includes(i.type)?i.value:t(i.value),e}),{})},e.getValueFromConfig=function(t,e){function i(e){var i={_value:t};return e.split(".").every((function(t,e){return i=_.isNumber(t)?i._value[t]:i._value.find((function(e){return e._name===t}))})),i||{}}if(arguments.length<2)return i;return i(e)},e.reduceConfig=void 0;var n=["array","object","group","modal","colors"];e.reduceConfig=function t(e){if(!_.isArray(e))return e;for(var i={},r=0,o=e.length;r<o;r++){var a=e[r]._type;i[e[r]._name]=a&&!n.includes(a)?e[r]._value:t(e[r]._value)}return i};var r=["array","object","group","colors","menu","modal"]},function(t,e,i){"use strict";function n(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}i.d(e,"a",(function(){return n}))},function(t,e,i){"use strict";i.d(e,"a",(function(){return r}));var n=i(16);function r(t,e){if(t){if("string"==typeof t)return Object(n.a)(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Object(n.a)(t,e):void 0}}},function(t,e,i){"use strict";function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}i.d(e,"a",(function(){return n}))},function(t,e){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){"use strict";function n(t,e,i){i=i||2;var n,s,l,c,h,p,f,g=e&&e.length,y=g?e[0]*i:t.length,_=r(t,0,y,i,!0),v=[];if(!_||_.next===_.prev)return v;if(g&&(_=function(t,e,i,n){var a,s,l,c,h,p=[];for(a=0,s=e.length;a<s;a++)l=e[a]*n,c=a<s-1?e[a+1]*n:t.length,(h=r(t,l,c,n,!1))===h.next&&(h.steiner=!0),p.push(m(h));for(p.sort(u),a=0;a<p.length;a++)i=o(i=d(p[a],i),i.next);return i}(t,e,_,i)),t.length>80*i){n=l=t[0],s=c=t[1];for(var x=i;x<y;x+=i)(h=t[x])<n&&(n=h),(p=t[x+1])<s&&(s=p),h>l&&(l=h),p>c&&(c=p);f=0!==(f=Math.max(l-n,c-s))?1/f:0}return a(_,v,i,n,s,f),v}function r(t,e,i,n,r){var o,a;if(r===A(t,e,i,n)>0)for(o=e;o<i;o+=n)a=S(o,t[o],t[o+1],a);else for(o=i-n;o>=e;o-=n)a=S(o,t[o],t[o+1],a);return a&&v(a,a.next)&&(E(a),a=a.next),a}function o(t,e){if(!t)return t;e||(e=t);var i,n=t;do{if(i=!1,n.steiner||!v(n,n.next)&&0!==_(n.prev,n,n.next))n=n.next;else{if(E(n),(n=e=n.prev)===n.next)break;i=!0}}while(i||n!==e);return e}function a(t,e,i,n,r,u,d){if(t){!d&&u&&function(t,e,i,n){var r=t;do{null===r.z&&(r.z=f(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,i,n,r,o,a,s,l,c=1;do{for(i=t,t=null,o=null,a=0;i;){for(a++,n=i,s=0,e=0;e<c&&(s++,n=n.nextZ);e++);for(l=c;s>0||l>0&&n;)0!==s&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,s--):(r=n,n=n.nextZ,l--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;i=n}o.nextZ=null,c*=2}while(a>1)}(r)}(t,n,r,u);for(var p,m,g=t;t.prev!==t.next;)if(p=t.prev,m=t.next,u?l(t,n,r,u):s(t))e.push(p.i/i),e.push(t.i/i),e.push(m.i/i),E(t),t=m.next,g=m.next;else if((t=m)===g){d?1===d?a(t=c(o(t),e,i),e,i,n,r,u,2):2===d&&h(t,e,i,n,r,u):a(o(t),e,i,n,r,u,1);break}}}function s(t){var e=t.prev,i=t,n=t.next;if(_(e,i,n)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(g(e.x,e.y,i.x,i.y,n.x,n.y,r.x,r.y)&&_(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function l(t,e,i,n){var r=t.prev,o=t,a=t.next;if(_(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,l=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,c=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,h=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,u=f(s,l,e,i,n),d=f(c,h,e,i,n),p=t.prevZ,m=t.nextZ;p&&p.z>=u&&m&&m.z<=d;){if(p!==t.prev&&p!==t.next&&g(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&_(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,m!==t.prev&&m!==t.next&&g(r.x,r.y,o.x,o.y,a.x,a.y,m.x,m.y)&&_(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(;p&&p.z>=u;){if(p!==t.prev&&p!==t.next&&g(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&_(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;m&&m.z<=d;){if(m!==t.prev&&m!==t.next&&g(r.x,r.y,o.x,o.y,a.x,a.y,m.x,m.y)&&_(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function c(t,e,i){var n=t;do{var r=n.prev,a=n.next.next;!v(r,a)&&x(r,n,n.next,a)&&M(r,a)&&M(a,r)&&(e.push(r.i/i),e.push(n.i/i),e.push(a.i/i),E(n),E(n.next),n=t=a),n=n.next}while(n!==t);return o(n)}function h(t,e,i,n,r,s){var l=t;do{for(var c=l.next.next;c!==l.prev;){if(l.i!==c.i&&y(l,c)){var h=T(l,c);return l=o(l,l.next),h=o(h,h.next),a(l,e,i,n,r,s),void a(h,e,i,n,r,s)}c=c.next}l=l.next}while(l!==t)}function u(t,e){return t.x-e.x}function d(t,e){var i=function(t,e){var i,n=e,r=t.x,o=t.y,a=-1/0;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){var s=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=r&&s>a){if(a=s,s===r){if(o===n.y)return n;if(o===n.next.y)return n.next}i=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!i)return null;if(r===a)return i;var l,c=i,h=i.x,u=i.y,d=1/0;n=i;do{r>=n.x&&n.x>=h&&r!==n.x&&g(o<u?r:a,o,h,u,o<u?a:r,o,n.x,n.y)&&(l=Math.abs(o-n.y)/(r-n.x),M(n,t)&&(l<d||l===d&&(n.x>i.x||n.x===i.x&&p(i,n)))&&(i=n,d=l)),n=n.next}while(n!==c);return i}(t,e);if(!i)return e;var n=T(i,t),r=o(i,i.next);return o(n,n.next),e===i?r:e}function p(t,e){return _(t.prev,t,e.prev)<0&&_(e.next,t,t.next)<0}function f(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function m(t){var e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function g(t,e,i,n,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(n-s)-(i-a)*(e-s)>=0&&(i-a)*(o-s)-(r-a)*(n-s)>=0}function y(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&x(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(M(t,e)&&M(e,t)&&function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)&&(_(t.prev,t,e.prev)||_(t,e.prev,e))||v(t,e)&&_(t.prev,t,t.next)>0&&_(e.prev,e,e.next)>0)}function _(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function v(t,e){return t.x===e.x&&t.y===e.y}function x(t,e,i,n){var r=w(_(t,e,i)),o=w(_(t,e,n)),a=w(_(i,n,t)),s=w(_(i,n,e));return r!==o&&a!==s||(!(0!==r||!b(t,i,e))||(!(0!==o||!b(t,n,e))||(!(0!==a||!b(i,t,n))||!(0!==s||!b(i,e,n)))))}function b(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function w(t){return t>0?1:t<0?-1:0}function M(t,e){return _(t.prev,t,t.next)<0?_(t,e,t.next)>=0&&_(t,t.prev,e)>=0:_(t,e,t.prev)<0||_(t,t.next,e)<0}function T(t,e){var i=new C(t.i,t.x,t.y),n=new C(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function S(t,e,i,n){var r=new C(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function E(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function C(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function A(t,e,i,n){for(var r=0,o=e,a=i-n;o<i;o+=n)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}t.exports=n,t.exports.default=n,n.deviation=function(t,e,i,n){var r=e&&e.length,o=r?e[0]*i:t.length,a=Math.abs(A(t,0,o,i));if(r)for(var s=0,l=e.length;s<l;s++){var c=e[s]*i,h=s<l-1?e[s+1]*i:t.length;a-=Math.abs(A(t,c,h,i))}var u=0;for(s=0;s<n.length;s+=3){var d=n[s]*i,p=n[s+1]*i,f=n[s+2]*i;u+=Math.abs((t[d]-t[f])*(t[p+1]-t[d+1])-(t[d]-t[p])*(t[f+1]-t[d+1]))}return 0===a&&0===u?0:Math.abs((u-a)/a)},n.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},n=0,r=0;r<t.length;r++){for(var o=0;o<t[r].length;o++)for(var a=0;a<e;a++)i.vertices.push(t[r][o][a]);r>0&&(n+=t[r-1].length,i.holes.push(n))}return i}},function(t,e,i){(function(e){t.exports=function(){"use strict";var t,i,n;function r(e,r){if(t)if(i){var o="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+t+")(sharedChunk); ("+i+")(sharedChunk); self.onerror = null;",a={};t(a),n=r(a),"undefined"!=typeof window&&window&&window.URL&&window.URL.createObjectURL&&(n.workerUrl=window.URL.createObjectURL(new Blob([o],{type:"text/javascript"})))}else i=r;else t=r}return r(0,(function(t){var i="2.7.0",n=r;function r(t,e,i,n){this.cx=3*t,this.bx=3*(i-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(n-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=n,this.p2x=i,this.p2y=n}r.prototype.sampleCurveX=function(t){return((this.ax*t+this.bx)*t+this.cx)*t},r.prototype.sampleCurveY=function(t){return((this.ay*t+this.by)*t+this.cy)*t},r.prototype.sampleCurveDerivativeX=function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},r.prototype.solveCurveX=function(t,e){var i,n,r,o,a;for(void 0===e&&(e=1e-6),r=t,a=0;a<8;a++){if(o=this.sampleCurveX(r)-t,Math.abs(o)<e)return r;var s=this.sampleCurveDerivativeX(r);if(Math.abs(s)<1e-6)break;r-=o/s}if((r=t)<(i=0))return i;if(r>(n=1))return n;for(;i<n;){if(o=this.sampleCurveX(r),Math.abs(o-t)<e)return r;t>o?i=r:n=r,r=.5*(n-i)+i}return r},r.prototype.solve=function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))};var o=a;function a(t,e){this.x=t,this.y=e}a.prototype={clone:function(){return new a(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,i=t.y-this.y;return e*e+i*i},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),i=Math.sin(t),n=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=n,this},_rotateAround:function(t,e){var i=Math.cos(t),n=Math.sin(t),r=e.y+n*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-n*(this.y-e.y),this.y=r,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},a.convert=function(t){return t instanceof a?t:Array.isArray(t)?new a(t[0],t[1]):t};var s="undefined"!=typeof self?self:{},l=1e-6,c="undefined"!=typeof Float32Array?Float32Array:Array;function h(){var t=new c(9);return c!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function u(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function d(t,e,i){var n=e[0],r=e[1],o=e[2],a=e[3],s=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=e[9],p=e[10],f=e[11],m=e[12],g=e[13],y=e[14],_=e[15],v=i[0],x=i[1],b=i[2],w=i[3];return t[0]=v*n+x*s+b*u+w*m,t[1]=v*r+x*l+b*d+w*g,t[2]=v*o+x*c+b*p+w*y,t[3]=v*a+x*h+b*f+w*_,t[4]=(v=i[4])*n+(x=i[5])*s+(b=i[6])*u+(w=i[7])*m,t[5]=v*r+x*l+b*d+w*g,t[6]=v*o+x*c+b*p+w*y,t[7]=v*a+x*h+b*f+w*_,t[8]=(v=i[8])*n+(x=i[9])*s+(b=i[10])*u+(w=i[11])*m,t[9]=v*r+x*l+b*d+w*g,t[10]=v*o+x*c+b*p+w*y,t[11]=v*a+x*h+b*f+w*_,t[12]=(v=i[12])*n+(x=i[13])*s+(b=i[14])*u+(w=i[15])*m,t[13]=v*r+x*l+b*d+w*g,t[14]=v*o+x*c+b*p+w*y,t[15]=v*a+x*h+b*f+w*_,t}function p(t,e,i){var n,r,o,a,s,l,c,h,u,d,p,f,m=i[0],g=i[1],y=i[2];return e===t?(t[12]=e[0]*m+e[4]*g+e[8]*y+e[12],t[13]=e[1]*m+e[5]*g+e[9]*y+e[13],t[14]=e[2]*m+e[6]*g+e[10]*y+e[14],t[15]=e[3]*m+e[7]*g+e[11]*y+e[15]):(r=e[1],o=e[2],a=e[3],s=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=e[9],p=e[10],f=e[11],t[0]=n=e[0],t[1]=r,t[2]=o,t[3]=a,t[4]=s,t[5]=l,t[6]=c,t[7]=h,t[8]=u,t[9]=d,t[10]=p,t[11]=f,t[12]=n*m+s*g+u*y+e[12],t[13]=r*m+l*g+d*y+e[13],t[14]=o*m+c*g+p*y+e[14],t[15]=a*m+h*g+f*y+e[15]),t}function f(t,e,i){var n=i[0],r=i[1],o=i[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function m(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e[4],a=e[5],s=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*r+c*n,t[5]=a*r+h*n,t[6]=s*r+u*n,t[7]=l*r+d*n,t[8]=c*r-o*n,t[9]=h*r-a*n,t[10]=u*r-s*n,t[11]=d*r-l*n,t}function g(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e[0],a=e[1],s=e[2],l=e[3],c=e[8],h=e[9],u=e[10],d=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*r-c*n,t[1]=a*r-h*n,t[2]=s*r-u*n,t[3]=l*r-d*n,t[8]=o*n+c*r,t[9]=a*n+h*r,t[10]=s*n+u*r,t[11]=l*n+d*r,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var y=d;function _(){var t=new c(3);return c!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function v(t){var e=new c(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function x(t){return Math.hypot(t[0],t[1],t[2])}function b(t,e,i){var n=new c(3);return n[0]=t,n[1]=e,n[2]=i,n}function w(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function M(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function T(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t}function S(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t}function E(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function C(t,e,i,n){return t[0]=e[0]+i[0]*n,t[1]=e[1]+i[1]*n,t[2]=e[2]+i[2]*n,t}function A(t,e){var i=e[0],n=e[1],r=e[2],o=i*i+n*n+r*r;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t}function P(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function L(t,e,i){var n=e[0],r=e[1],o=e[2],a=i[0],s=i[1],l=i[2];return t[0]=r*l-o*s,t[1]=o*a-n*l,t[2]=n*s-r*a,t}function I(t,e,i){var n=e[0],r=e[1],o=e[2],a=i[3]*n+i[7]*r+i[11]*o+i[15];return t[0]=(i[0]*n+i[4]*r+i[8]*o+i[12])/(a=a||1),t[1]=(i[1]*n+i[5]*r+i[9]*o+i[13])/a,t[2]=(i[2]*n+i[6]*r+i[10]*o+i[14])/a,t}function R(t,e,i){var n=i[0],r=i[1],o=i[2],a=e[0],s=e[1],l=e[2],c=r*l-o*s,h=o*a-n*l,u=n*s-r*a,d=r*u-o*h,p=o*c-n*u,f=n*h-r*c,m=2*i[3];return h*=m,u*=m,p*=2,f*=2,t[0]=a+(c*=m)+(d*=2),t[1]=s+h+p,t[2]=l+u+f,t}var D,k=M,O=T,z=x;function B(t,e,i){var n=e[0],r=e[1],o=e[2],a=e[3];return t[0]=i[0]*n+i[4]*r+i[8]*o+i[12]*a,t[1]=i[1]*n+i[5]*r+i[9]*o+i[13]*a,t[2]=i[2]*n+i[6]*r+i[10]*o+i[14]*a,t[3]=i[3]*n+i[7]*r+i[11]*o+i[15]*a,t}function F(){var t=new c(4);return c!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function N(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function j(t,e,i){i*=.5;var n=e[0],r=e[1],o=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=n*l+a*s,t[1]=r*l+o*s,t[2]=o*l-r*s,t[3]=a*l-n*s,t}function G(t,e){return t[0]===e[0]&&t[1]===e[1]}_(),D=new c(4),c!=Float32Array&&(D[0]=0,D[1]=0,D[2]=0,D[3]=0),_(),b(1,0,0),b(0,1,0),F(),F(),h(),function(){var t;t=new c(2),c!=Float32Array&&(t[0]=0,t[1]=0)}();const U=Math.PI/180,V=180/Math.PI;function H(t){return t*U}function Z(t){return t*V}const W=[[0,0],[1,0],[1,1],[0,1]];function q(t){if(t<=0)return 0;if(t>=1)return 1;const e=t*t,i=e*t;return 4*(t<.5?i:3*(t-e)+i-.75)}function X(t,e,i,r){const o=new n(t,e,i,r);return function(t){return o.solve(t)}}const Y=X(.25,.1,.25,1);function $(t,e,i){return Math.min(i,Math.max(e,t))}function J(t,e,i){return(i=$((i-t)/(e-t),0,1))*i*(3-2*i)}function K(t,e,i){const n=i-e,r=((t-e)%n+n)%n+e;return r===e?i:r}function Q(t,e,i){if(!t.length)return i(null,[]);let n=t.length;const r=new Array(t.length);let o=null;t.forEach((t,a)=>{e(t,(t,e)=>{t&&(o=t),r[a]=e,0==--n&&i(o,r)})})}function tt(t){const e=[];for(const i in t)e.push(t[i]);return e}function et(t,...e){for(const i of e)for(const e in i)t[e]=i[e];return t}let it=1;function nt(){return it++}function rt(){return function t(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}function ot(t){return t<=1?1:Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}function at(t){return!!t&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}function st(t,e){t.forEach(t=>{e[t]&&(e[t]=e[t].bind(e))})}function lt(t,e){return-1!==t.indexOf(e,t.length-e.length)}function ct(t,e,i){const n={};for(const r in t)n[r]=e.call(i||this,t[r],r,t);return n}function ht(t,e,i){const n={};for(const r in t)e.call(i||this,t[r],r,t)&&(n[r]=t[r]);return n}function ut(t){return Array.isArray(t)?t.map(ut):"object"==typeof t&&t?ct(t,ut):t}const dt={};function pt(t){dt[t]||("undefined"!=typeof console&&console.warn(t),dt[t]=!0)}function ft(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)}function mt(t){let e=0;for(let i,n,r=0,o=t.length,a=o-1;r<o;a=r++)i=t[r],n=t[a],e+=(n.x-i.x)*(i.y+n.y);return e}function gt(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function yt(t){const e={};if(t.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(t,i,n,r)=>{const o=n||r;return e[i]=!o||o.toLowerCase(),""}),e["max-age"]){const t=parseInt(e["max-age"],10);isNaN(t)?delete e["max-age"]:e["max-age"]=t}return e}let _t,vt,xt,bt=null;function wt(t){if(null==bt){const e=t.navigator?t.navigator.userAgent:null;bt=!!t.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return bt}function Mt(t){try{const e=s[t];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch(t){return!1}}const Tt={now:()=>void 0!==xt?xt:s.performance.now(),setNow(t){xt=t},restoreNow(){xt=void 0},frame(t){const e=s.requestAnimationFrame(t);return{cancel:()=>s.cancelAnimationFrame(e)}},getImageData(t,e=0){const i=s.document.createElement("canvas"),n=i.getContext("2d");if(!n)throw new Error("failed to create canvas 2d context");return i.width=t.width,i.height=t.height,n.drawImage(t,0,0,t.width,t.height),n.getImageData(-e,-e,t.width+2*e,t.height+2*e)},resolveURL:t=>(_t||(_t=s.document.createElement("a")),_t.href=t,_t.href),get devicePixelRatio(){return s.devicePixelRatio},get prefersReducedMotion(){return!!s.matchMedia&&(null==vt&&(vt=s.matchMedia("(prefers-reduced-motion: reduce)")),vt.matches)}};let St;const Et={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==St){const t=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{St=null!=e.env.API_URL_REGEX?new RegExp(e.env.API_URL_REGEX):t}catch(e){St=t}}return St},get EVENTS_URL(){return this.API_URL?0===this.API_URL.indexOf("https://api.mapbox.cn")?"https://events.mapbox.cn/events/v2":0===this.API_URL.indexOf("https://api.mapbox.com")?"https://events.mapbox.com/events/v2":null:null},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},Ct={supported:!1,testSupport:function(t){!Lt&&Pt&&(It?Rt(t):At=t)}};let At,Pt,Lt=!1,It=!1;function Rt(t){const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e);try{if(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,Pt),t.isContextLost())return;Ct.supported=!0}catch(t){}t.deleteTexture(e),Lt=!0}s.document&&(Pt=s.document.createElement("img"),Pt.onload=function(){At&&Rt(At),At=null,It=!0},Pt.onerror=function(){Lt=!0,At=null},Pt.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Dt="01",kt="NO_ACCESS_TOKEN";function Ot(t){return 0===t.indexOf("mapbox:")}function zt(t){return Et.API_URL_REGEX.test(t)}const Bt=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Ft(t){const e=t.match(Bt);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function Nt(t){const e=t.params.length?"?"+t.params.join("&"):"";return`${t.protocol}://${t.authority}${t.path}${e}`}function jt(t){if(!t)return null;const e=t.split(".");if(!e||3!==e.length)return null;try{return JSON.parse(decodeURIComponent(s.atob(e[1]).split("").map(t=>"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch(t){return null}}class Gt{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const e=jt(Et.ACCESS_TOKEN);let i="";return i=e&&e.u?s.btoa(encodeURIComponent(e.u).replace(/%([0-9A-F]{2})/g,(t,e)=>String.fromCharCode(Number("0x"+e)))):Et.ACCESS_TOKEN||"",t?`mapbox.eventData.${t}:${i}`:"mapbox.eventData:"+i}fetchEventData(){const t=Mt("localStorage"),e=this.getStorageKey(),i=this.getStorageKey("uuid");if(t)try{const t=s.localStorage.getItem(e);t&&(this.eventData=JSON.parse(t));const n=s.localStorage.getItem(i);n&&(this.anonId=n)}catch(t){pt("Unable to read from LocalStorage")}}saveEventData(){const t=Mt("localStorage"),e=this.getStorageKey(),i=this.getStorageKey("uuid");if(t)try{s.localStorage.setItem(i,this.anonId),Object.keys(this.eventData).length>=1&&s.localStorage.setItem(e,JSON.stringify(this.eventData))}catch(t){pt("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,e,n,r){if(!Et.EVENTS_URL)return;const o=Ft(Et.EVENTS_URL);o.params.push("access_token="+(r||Et.ACCESS_TOKEN||""));const a={event:this.type,created:new Date(t).toISOString(),sdkIdentifier:"mapbox-gl-js",sdkVersion:i,skuId:Dt,userId:this.anonId},s=e?et(a,e):a,l={url:Nt(o),headers:{"Content-Type":"text/plain"},body:JSON.stringify([s])};this.pendingRequest=le(l,t=>{this.pendingRequest=null,n(t),this.saveEventData(),this.processRequests(r)})}queueRequest(t,e){this.queue.push(t),this.processRequests(e)}}const Ut=new class extends Gt{constructor(t){super("appUserTurnstile"),this._customAccessToken=t}postTurnstileEvent(t,e){Et.EVENTS_URL&&Et.ACCESS_TOKEN&&Array.isArray(t)&&t.some(t=>Ot(t)||zt(t))&&this.queueRequest(Date.now(),e)}processRequests(t){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=jt(Et.ACCESS_TOKEN),i=e?e.u:Et.ACCESS_TOKEN;let n=i!==this.eventData.tokenU;at(this.anonId)||(this.anonId=rt(),n=!0);const r=this.queue.shift();if(this.eventData.lastSuccess){const t=new Date(this.eventData.lastSuccess),e=new Date(r),i=(r-this.eventData.lastSuccess)/864e5;n=n||i>=1||i<-1||t.getDate()!==e.getDate()}else n=!0;if(!n)return this.processRequests();this.postEvent(r,{"enabled.telemetry":!1},t=>{t||(this.eventData.lastSuccess=r,this.eventData.tokenU=i)},t)}},Vt=Ut.postTurnstileEvent.bind(Ut),Ht=new class extends Gt{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(t,e,i,n){this.skuToken=e,this.errorCb=n,Et.EVENTS_URL&&(i||Et.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},i):this.errorCb(new Error(kt)))}processRequests(t){if(this.pendingRequest||0===this.queue.length)return;const{id:e,timestamp:i}=this.queue.shift();e&&this.success[e]||(this.anonId||this.fetchEventData(),at(this.anonId)||(this.anonId=rt()),this.postEvent(i,{skuToken:this.skuToken},t=>{t?this.errorCb(t):e&&(this.success[e]=!0)},t))}},Zt=Ht.postMapLoadEvent.bind(Ht),Wt=new class extends Gt{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(t,e,i,n){if(!Et.API_URL||!Et.SESSION_PATH)return;const r=Ft(Et.API_URL+Et.SESSION_PATH);r.params.push("sku="+(e||"")),r.params.push("access_token="+(n||Et.ACCESS_TOKEN||""));const o={url:Nt(r),headers:{"Content-Type":"text/plain"}};this.pendingRequest=ce(o,t=>{this.pendingRequest=null,i(t),this.saveEventData(),this.processRequests(n)})}getSessionAPI(t,e,i,n){this.skuToken=e,this.errorCb=n,Et.SESSION_PATH&&Et.API_URL&&(i||Et.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},i):this.errorCb(new Error(kt)))}processRequests(t){if(this.pendingRequest||0===this.queue.length)return;const{id:e,timestamp:i}=this.queue.shift();e&&this.success[e]||this.getSession(i,this.skuToken,t=>{t?this.errorCb(t):e&&(this.success[e]=!0)},t)}},qt=Wt.getSessionAPI.bind(Wt),Xt=new Set,Yt="mapbox-tiles";let $t,Jt,Kt=500,Qt=50;function te(){s.caches&&!$t&&($t=s.caches.open(Yt))}function ee(t){const e=t.indexOf("?");return e<0?t:t.slice(0,e)}let ie=1/0;const ne={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};"function"==typeof Object.freeze&&Object.freeze(ne);class re extends Error{constructor(t,e,i){401===e&&zt(i)&&(t+=": you may have provided an invalid Mapbox access token. See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes"),super(t),this.status=e,this.url=i}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const oe=gt()?()=>self.worker&&self.worker.referrer:()=>("blob:"===s.location.protocol?s.parent:s).location.href,ae=function(t,e){if(!(/^file:/.test(i=t.url)||/^file:/.test(oe())&&!/^\w+:/.test(i))){if(s.fetch&&s.Request&&s.AbortController&&s.Request.prototype.hasOwnProperty("signal"))return function(t,e){const i=new s.AbortController,n=new s.Request(t.url,{method:t.method||"GET",body:t.body,credentials:t.credentials,headers:t.headers,referrer:oe(),signal:i.signal});let r=!1,o=!1;const a=(l=n.url).indexOf("sku=")>0&&zt(l);var l;"json"===t.type&&n.headers.set("Accept","application/json");const c=(i,r,l)=>{if(o)return;if(i&&"SecurityError"!==i.message&&pt(i),r&&l)return h(r);const c=Date.now();s.fetch(n).then(i=>{if(i.ok){const t=a?i.clone():null;return h(i,t,c)}return e(new re(i.statusText,i.status,t.url))}).catch(t=>{20!==t.code&&e(new Error(t.message))})},h=(i,a,l)=>{("arrayBuffer"===t.type?i.arrayBuffer():"json"===t.type?i.json():i.text()).then(t=>{o||(a&&l&&function(t,e,i){if(te(),!$t)return;const n={status:e.status,statusText:e.statusText,headers:new s.Headers};e.headers.forEach((t,e)=>n.headers.set(e,t));const r=yt(e.headers.get("Cache-Control")||"");r["no-store"]||(r["max-age"]&&n.headers.set("Expires",new Date(i+1e3*r["max-age"]).toUTCString()),new Date(n.headers.get("Expires")).getTime()-i<42e4||function(t,e){if(void 0===Jt)try{new Response(new ReadableStream),Jt=!0}catch(t){Jt=!1}Jt?e(t.body):t.blob().then(e)}(e,e=>{const i=new s.Response(e,n);te(),$t&&$t.then(e=>e.put(ee(t.url),i)).catch(t=>pt(t.message))}))}(n,a,l),r=!0,e(null,t,i.headers.get("Cache-Control"),i.headers.get("Expires")))}).catch(t=>{o||e(new Error(t.message))})};return a?function(t,e){if(te(),!$t)return e(null);const i=ee(t.url);$t.then(t=>{t.match(i).then(n=>{const r=function(t){if(!t)return!1;const e=new Date(t.headers.get("Expires")||0),i=yt(t.headers.get("Cache-Control")||"");return e>Date.now()&&!i["no-cache"]}(n);t.delete(i),r&&t.put(i,n.clone()),e(null,n,r)}).catch(e)}).catch(e)}(n,c):c(null,null),{cancel:()=>{o=!0,r||i.abort()}}}(t,e);if(gt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",t,e,void 0,!0)}var i;return function(t,e){const i=new s.XMLHttpRequest;i.open(t.method||"GET",t.url,!0),"arrayBuffer"===t.type&&(i.responseType="arraybuffer");for(const e in t.headers)i.setRequestHeader(e,t.headers[e]);return"json"===t.type&&(i.responseType="text",i.setRequestHeader("Accept","application/json")),i.withCredentials="include"===t.credentials,i.onerror=()=>{e(new Error(i.statusText))},i.onload=()=>{if((i.status>=200&&i.status<300||0===i.status)&&null!==i.response){let n=i.response;if("json"===t.type)try{n=JSON.parse(i.response)}catch(t){return e(t)}e(null,n,i.getResponseHeader("Cache-Control"),i.getResponseHeader("Expires"))}else e(new re(i.statusText,i.status,t.url))},i.send(t.body),{cancel:()=>i.abort()}}(t,e)},se=function(t,e){return ae(et(t,{type:"arrayBuffer"}),e)},le=function(t,e){return ae(et(t,{method:"POST"}),e)},ce=function(t,e){return ae(et(t,{method:"GET"}),e)};function he(t){const e=s.document.createElement("a");return e.href=t,e.protocol===s.document.location.protocol&&e.host===s.document.location.host}const ue="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let de,pe;de=[],pe=0;const fe=function(t,e){if(Ct.supported&&(t.headers||(t.headers={}),t.headers.accept="image/webp,*/*"),pe>=Et.MAX_PARALLEL_IMAGE_REQUESTS){const i={requestParameters:t,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return de.push(i),i}pe++;let i=!1;const n=()=>{if(!i)for(i=!0,pe--;de.length&&pe<Et.MAX_PARALLEL_IMAGE_REQUESTS;){const t=de.shift(),{requestParameters:e,callback:i,cancelled:n}=t;n||(t.cancel=fe(e,i).cancel)}},r=se(t,(t,i,r,o)=>{n(),t?e(t):i&&(s.createImageBitmap?function(t,e){const i=new s.Blob([new Uint8Array(t)],{type:"image/png"});s.createImageBitmap(i).then(t=>{e(null,t)}).catch(t=>{e(new Error(`Could not load image because of ${t.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(i,(t,i)=>e(t,i,r,o)):function(t,e){const i=new s.Image,n=s.URL;i.onload=()=>{e(null,i),n.revokeObjectURL(i.src),i.onload=null,s.requestAnimationFrame(()=>{i.src=ue})},i.onerror=()=>e(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const r=new s.Blob([new Uint8Array(t)],{type:"image/png"});i.src=t.byteLength?n.createObjectURL(r):ue}(i,(t,i)=>e(t,i,r,o)))});return{cancel:()=>{r.cancel(),n()}}};function me(t,e,i){i[t]&&-1!==i[t].indexOf(e)||(i[t]=i[t]||[],i[t].push(e))}function ge(t,e,i){if(i&&i[t]){const n=i[t].indexOf(e);-1!==n&&i[t].splice(n,1)}}class ye{constructor(t,e={}){et(this,e),this.type=t}}class _e extends ye{constructor(t,e={}){super("error",et({error:t},e))}}class ve{on(t,e){return this._listeners=this._listeners||{},me(t,e,this._listeners),this}off(t,e){return ge(t,e,this._listeners),ge(t,e,this._oneTimeListeners),this}once(t,e){return e?(this._oneTimeListeners=this._oneTimeListeners||{},me(t,e,this._oneTimeListeners),this):new Promise(e=>this.once(t,e))}fire(t,e){"string"==typeof t&&(t=new ye(t,e||{}));const i=t.type;if(this.listens(i)){t.target=this;const e=this._listeners&&this._listeners[i]?this._listeners[i].slice():[];for(const i of e)i.call(this,t);const n=this._oneTimeListeners&&this._oneTimeListeners[i]?this._oneTimeListeners[i].slice():[];for(const e of n)ge(i,e,this._oneTimeListeners),e.call(this,t);const r=this._eventedParent;r&&(et(t,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),r.fire(t))}else t instanceof _e&&console.error(t.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,e){return this._eventedParent=t,this._eventedParentData=e,this}}var xe=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":0.1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":true,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"cross-faded"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"cross-faded":{"type":"property-type"},"cross-faded-data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class be{constructor(t,e,i,n){this.message=(t?t+": ":"")+i,n&&(this.identifier=n),null!=e&&e.__line__&&(this.line=e.__line__)}}function we(t){const e=t.value;return e?[new be(t.key,e,"constants have been deprecated as of v8")]:[]}function Me(t,...e){for(const i of e)for(const e in i)t[e]=i[e];return t}function Te(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}function Se(t){if(Array.isArray(t))return t.map(Se);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const e={};for(const i in t)e[i]=Se(t[i]);return e}return Te(t)}class Ee extends Error{constructor(t,e){super(e),this.message=e,this.key=t}}class Ce{constructor(t,e=[]){this.parent=t,this.bindings={};for(const[t,i]of e)this.bindings[t]=i}concat(t){return new Ce(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(t+" not found in scope.")}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}const Ae={kind:"null"},Pe={kind:"number"},Le={kind:"string"},Ie={kind:"boolean"},Re={kind:"color"},De={kind:"object"},ke={kind:"value"},Oe={kind:"collator"},ze={kind:"formatted"},Be={kind:"resolvedImage"};function Fe(t,e){return{kind:"array",itemType:t,N:e}}function Ne(t){if("array"===t.kind){const e=Ne(t.itemType);return"number"==typeof t.N?`array<${e}, ${t.N}>`:"value"===t.itemType.kind?"array":`array<${e}>`}return t.kind}const je=[Ae,Pe,Le,Ie,Re,ze,De,Fe(ke),Be];function Ge(t,e){if("error"===e.kind)return null;if("array"===t.kind){if("array"===e.kind&&(0===e.N&&"value"===e.itemType.kind||!Ge(t.itemType,e.itemType))&&("number"!=typeof t.N||t.N===e.N))return null}else{if(t.kind===e.kind)return null;if("value"===t.kind)for(const t of je)if(!Ge(t,e))return null}return`Expected ${Ne(t)} but found ${Ne(e)} instead.`}function Ue(t,e){return e.some(e=>e.kind===t.kind)}function Ve(t,e){return e.some(e=>"null"===e?null===t:"array"===e?Array.isArray(t):"object"===e?t&&!Array.isArray(t)&&"object"==typeof t:e===typeof t)}function He(t){var e={exports:{}};return t(e,e.exports),e.exports}var Ze=He((function(t,e){var i={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function n(t){return(t=Math.round(t))<0?0:t>255?255:t}function r(t){return n("%"===t[t.length-1]?parseFloat(t)/100*255:parseInt(t))}function o(t){return(e="%"===t[t.length-1]?parseFloat(t)/100:parseFloat(t))<0?0:e>1?1:e;var e}function a(t,e,i){return i<0?i+=1:i>1&&(i-=1),6*i<1?t+(e-t)*i*6:2*i<1?e:3*i<2?t+(e-t)*(2/3-i)*6:t}try{e.parseCSSColor=function(t){var e,s=t.replace(/ /g,"").toLowerCase();if(s in i)return i[s].slice();if("#"===s[0])return 4===s.length?(e=parseInt(s.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:7===s.length&&(e=parseInt(s.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var l=s.indexOf("("),c=s.indexOf(")");if(-1!==l&&c+1===s.length){var h=s.substr(0,l),u=s.substr(l+1,c-(l+1)).split(","),d=1;switch(h){case"rgba":if(4!==u.length)return null;d=o(u.pop());case"rgb":return 3!==u.length?null:[r(u[0]),r(u[1]),r(u[2]),d];case"hsla":if(4!==u.length)return null;d=o(u.pop());case"hsl":if(3!==u.length)return null;var p=(parseFloat(u[0])%360+360)%360/360,f=o(u[1]),m=o(u[2]),g=m<=.5?m*(f+1):m+f-m*f,y=2*m-g;return[n(255*a(y,g,p+1/3)),n(255*a(y,g,p)),n(255*a(y,g,p-1/3)),d];default:return null}}return null}}catch(t){}}));class We{constructor(t,e,i,n=1){this.r=t,this.g=e,this.b=i,this.a=n}static parse(t){if(!t)return;if(t instanceof We)return t;if("string"!=typeof t)return;const e=Ze.parseCSSColor(t);return e?new We(e[0]/255*e[3],e[1]/255*e[3],e[2]/255*e[3],e[3]):void 0}toString(){const[t,e,i,n]=this.toArray();return`rgba(${Math.round(t)},${Math.round(e)},${Math.round(i)},${n})`}toArray(){const{r:t,g:e,b:i,a:n}=this;return 0===n?[0,0,0,0]:[255*t/n,255*e/n,255*i/n,n]}}We.black=new We(0,0,0,1),We.white=new We(1,1,1,1),We.transparent=new We(0,0,0,0),We.red=new We(1,0,0,1),We.blue=new We(0,0,1,1);class qe{constructor(t,e,i){this.sensitivity=t?e?"variant":"case":e?"accent":"base",this.locale=i,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,e){return this.collator.compare(t,e)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Xe{constructor(t,e,i,n,r){this.text=t.normalize?t.normalize():t,this.image=e,this.scale=i,this.fontStack=n,this.textColor=r}}class Ye{constructor(t){this.sections=t}static fromString(t){return new Ye([new Xe(t,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(t=>0!==t.text.length||t.image&&0!==t.image.name.length)}static factory(t){return t instanceof Ye?t:Ye.fromString(t)}toString(){return 0===this.sections.length?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const e of this.sections){if(e.image){t.push(["image",e.image.name]);continue}t.push(e.text);const i={};e.fontStack&&(i["text-font"]=["literal",e.fontStack.split(",")]),e.scale&&(i["font-scale"]=e.scale),e.textColor&&(i["text-color"]=["rgba"].concat(e.textColor.toArray())),t.push(i)}return t}}class $e{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new $e({name:t,available:!1}):null}serialize(){return["image",this.name]}}function Je(t,e,i,n){return"number"==typeof t&&t>=0&&t<=255&&"number"==typeof e&&e>=0&&e<=255&&"number"==typeof i&&i>=0&&i<=255?void 0===n||"number"==typeof n&&n>=0&&n<=1?null:`Invalid rgba value [${[t,e,i,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof n?[t,e,i,n]:[t,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ke(t){if(null===t)return!0;if("string"==typeof t)return!0;if("boolean"==typeof t)return!0;if("number"==typeof t)return!0;if(t instanceof We)return!0;if(t instanceof qe)return!0;if(t instanceof Ye)return!0;if(t instanceof $e)return!0;if(Array.isArray(t)){for(const e of t)if(!Ke(e))return!1;return!0}if("object"==typeof t){for(const e in t)if(!Ke(t[e]))return!1;return!0}return!1}function Qe(t){if(null===t)return Ae;if("string"==typeof t)return Le;if("boolean"==typeof t)return Ie;if("number"==typeof t)return Pe;if(t instanceof We)return Re;if(t instanceof qe)return Oe;if(t instanceof Ye)return ze;if(t instanceof $e)return Be;if(Array.isArray(t)){const e=t.length;let i;for(const e of t){const t=Qe(e);if(i){if(i===t)continue;i=ke;break}i=t}return Fe(i||ke,e)}return De}function ti(t){const e=typeof t;return null===t?"":"string"===e||"number"===e||"boolean"===e?String(t):t instanceof We||t instanceof Ye||t instanceof $e?t.toString():JSON.stringify(t)}class ei{constructor(t,e){this.type=t,this.value=e}static parse(t,e){if(2!==t.length)return e.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Ke(t[1]))return e.error("invalid value");const i=t[1];let n=Qe(i);const r=e.expectedType;return"array"!==n.kind||0!==n.N||!r||"array"!==r.kind||"number"==typeof r.N&&0!==r.N||(n=r),new ei(n,i)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof We?["rgba"].concat(this.value.toArray()):this.value instanceof Ye?this.value.serialize():this.value}}class ii{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}}const ni={string:Le,number:Pe,boolean:Ie,object:De};class ri{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");let i,n=1;const r=t[0];if("array"===r){let r,o;if(t.length>2){const i=t[1];if("string"!=typeof i||!(i in ni)||"object"===i)return e.error('The item type argument of "array" must be one of string, number, boolean',1);r=ni[i],n++}else r=ke;if(t.length>3){if(null!==t[2]&&("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2])))return e.error('The length argument to "array" must be a positive integer literal',2);o=t[2],n++}i=Fe(r,o)}else i=ni[r];const o=[];for(;n<t.length;n++){const i=e.parse(t[n],n,ke);if(!i)return null;o.push(i)}return new ri(i,o)}evaluate(t){for(let e=0;e<this.args.length;e++){const i=this.args[e].evaluate(t);if(!Ge(this.type,Qe(i)))return i;if(e===this.args.length-1)throw new ii(`Expected value to be of type ${Ne(this.type)}, but found ${Ne(Qe(i))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,e=[t.kind];if("array"===t.kind){const i=t.itemType;if("string"===i.kind||"number"===i.kind||"boolean"===i.kind){e.push(i.kind);const n=t.N;("number"==typeof n||this.args.length>1)&&e.push(n)}}return e.concat(this.args.map(t=>t.serialize()))}}class oi{constructor(t){this.type=ze,this.sections=t}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const i=t[1];if(!Array.isArray(i)&&"object"==typeof i)return e.error("First argument must be an image or text section.");const n=[];let r=!1;for(let i=1;i<=t.length-1;++i){const o=t[i];if(r&&"object"==typeof o&&!Array.isArray(o)){r=!1;let t=null;if(o["font-scale"]&&(t=e.parse(o["font-scale"],1,Pe),!t))return null;let i=null;if(o["text-font"]&&(i=e.parse(o["text-font"],1,Fe(Le)),!i))return null;let a=null;if(o["text-color"]&&(a=e.parse(o["text-color"],1,Re),!a))return null;const s=n[n.length-1];s.scale=t,s.font=i,s.textColor=a}else{const o=e.parse(t[i],1,ke);if(!o)return null;const a=o.type.kind;if("string"!==a&&"value"!==a&&"null"!==a&&"resolvedImage"!==a)return e.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");r=!0,n.push({content:o,scale:null,font:null,textColor:null})}}return new oi(n)}evaluate(t){return new Ye(this.sections.map(e=>{const i=e.content.evaluate(t);return Qe(i)===Be?new Xe("",i,null,null,null):new Xe(ti(i),null,e.scale?e.scale.evaluate(t):null,e.font?e.font.evaluate(t).join(","):null,e.textColor?e.textColor.evaluate(t):null)}))}eachChild(t){for(const e of this.sections)t(e.content),e.scale&&t(e.scale),e.font&&t(e.font),e.textColor&&t(e.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const e of this.sections){t.push(e.content.serialize());const i={};e.scale&&(i["font-scale"]=e.scale.serialize()),e.font&&(i["text-font"]=e.font.serialize()),e.textColor&&(i["text-color"]=e.textColor.serialize()),t.push(i)}return t}}class ai{constructor(t){this.type=Be,this.input=t}static parse(t,e){if(2!==t.length)return e.error("Expected two arguments.");const i=e.parse(t[1],1,Le);return i?new ai(i):e.error("No image name provided.")}evaluate(t){const e=this.input.evaluate(t),i=$e.fromString(e);return i&&t.availableImages&&(i.available=t.availableImages.indexOf(e)>-1),i}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const si={"to-boolean":Ie,"to-color":Re,"to-number":Pe,"to-string":Le};class li{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const i=t[0];if(("to-boolean"===i||"to-string"===i)&&2!==t.length)return e.error("Expected one argument.");const n=si[i],r=[];for(let i=1;i<t.length;i++){const n=e.parse(t[i],i,ke);if(!n)return null;r.push(n)}return new li(n,r)}evaluate(t){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(t));if("color"===this.type.kind){let e,i;for(const n of this.args){if(e=n.evaluate(t),i=null,e instanceof We)return e;if("string"==typeof e){const i=t.parseColor(e);if(i)return i}else if(Array.isArray(e)&&(i=e.length<3||e.length>4?`Invalid rbga value ${JSON.stringify(e)}: expected an array containing either three or four numeric values.`:Je(e[0],e[1],e[2],e[3]),!i))return new We(e[0]/255,e[1]/255,e[2]/255,e[3])}throw new ii(i||`Could not parse color from value '${"string"==typeof e?e:String(JSON.stringify(e))}'`)}if("number"===this.type.kind){let e=null;for(const i of this.args){if(e=i.evaluate(t),null===e)return 0;const n=Number(e);if(!isNaN(n))return n}throw new ii(`Could not convert ${JSON.stringify(e)} to number.`)}return"formatted"===this.type.kind?Ye.fromString(ti(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?$e.fromString(ti(this.args[0].evaluate(t))):ti(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if("formatted"===this.type.kind)return new oi([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new ai(this.args[0]).serialize();const t=["to-"+this.type.kind];return this.eachChild(e=>{t.push(e.serialize())}),t}}const ci=["Unknown","Point","LineString","Polygon"];class hi{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?ci[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,e=this.featureDistanceData.scale,{x:i,y:n}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(i*e-t[0])+this.featureDistanceData.bearing[1]*(n*e-t[1])}return 0}parseColor(t){let e=this._parseColorCache[t];return e||(e=this._parseColorCache[t]=We.parse(t)),e}}class ui{constructor(t,e,i,n){this.name=t,this.type=e,this._evaluate=i,this.args=n}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,e){const i=t[0],n=ui.definitions[i];if(!n)return e.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0);const r=Array.isArray(n)?n[0]:n.type,o=Array.isArray(n)?[[n[1],n[2]]]:n.overloads,a=o.filter(([e])=>!Array.isArray(e)||e.length===t.length-1);let s=null;for(const[n,o]of a){s=new ki(e.registry,e.path,null,e.scope);const a=[];let l=!1;for(let e=1;e<t.length;e++){const i=t[e],r=Array.isArray(n)?n[e-1]:n.type,o=s.parse(i,1+a.length,r);if(!o){l=!0;break}a.push(o)}if(!l)if(Array.isArray(n)&&n.length!==a.length)s.error(`Expected ${n.length} arguments, but found ${a.length} instead.`);else{for(let t=0;t<a.length;t++){const e=Array.isArray(n)?n[t]:n.type,i=a[t];s.concat(t+1).checkSubtype(e,i.type)}if(0===s.errors.length)return new ui(i,r,o,a)}}if(1===a.length)e.errors.push(...s.errors);else{const i=(a.length?a:o).map(([t])=>{return e=t,Array.isArray(e)?`(${e.map(Ne).join(", ")})`:`(${Ne(e.type)}...)`;var e}).join(" | "),n=[];for(let i=1;i<t.length;i++){const r=e.parse(t[i],1+n.length);if(!r)return null;n.push(Ne(r.type))}e.error(`Expected arguments of type ${i}, but found (${n.join(", ")}) instead.`)}return null}static register(t,e){ui.definitions=e;for(const i in e)t[i]=ui}}class di{constructor(t,e,i){this.type=Oe,this.locale=i,this.caseSensitive=t,this.diacriticSensitive=e}static parse(t,e){if(2!==t.length)return e.error("Expected one argument.");const i=t[1];if("object"!=typeof i||Array.isArray(i))return e.error("Collator options argument must be an object.");const n=e.parse(void 0!==i["case-sensitive"]&&i["case-sensitive"],1,Ie);if(!n)return null;const r=e.parse(void 0!==i["diacritic-sensitive"]&&i["diacritic-sensitive"],1,Ie);if(!r)return null;let o=null;return i.locale&&(o=e.parse(i.locale,1,Le),!o)?null:new di(n,r,o)}evaluate(t){return new qe(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}const pi=8192;function fi(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1])}function mi(t,e){return!(t[0]<=e[0]||t[2]>=e[2]||t[1]<=e[1]||t[3]>=e[3])}function gi(t,e){const i=(180+t[0])/360,n=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,r=Math.pow(2,e.z);return[Math.round(i*r*pi),Math.round(n*r*pi)]}function yi(t,e,i){const n=t[0]-e[0],r=t[1]-e[1],o=t[0]-i[0],a=t[1]-i[1];return n*a-o*r==0&&n*o<=0&&r*a<=0}function _i(t,e){let i=!1;for(let a=0,s=e.length;a<s;a++){const s=e[a];for(let e=0,a=s.length;e<a-1;e++){if(yi(t,s[e],s[e+1]))return!1;(r=s[e])[1]>(n=t)[1]!=(o=s[e+1])[1]>n[1]&&n[0]<(o[0]-r[0])*(n[1]-r[1])/(o[1]-r[1])+r[0]&&(i=!i)}}var n,r,o;return i}function vi(t,e){for(let i=0;i<e.length;i++)if(_i(t,e[i]))return!0;return!1}function xi(t,e,i,n){const r=n[0]-i[0],o=n[1]-i[1],a=(t[0]-i[0])*o-r*(t[1]-i[1]),s=(e[0]-i[0])*o-r*(e[1]-i[1]);return a>0&&s<0||a<0&&s>0}function bi(t,e,i){for(const c of i)for(let i=0;i<c.length-1;++i)if(0!=(s=[(a=c[i+1])[0]-(o=c[i])[0],a[1]-o[1]])[0]*(l=[(r=e)[0]-(n=t)[0],r[1]-n[1]])[1]-s[1]*l[0]&&xi(n,r,o,a)&&xi(o,a,n,r))return!0;var n,r,o,a,s,l;return!1}function wi(t,e){for(let i=0;i<t.length;++i)if(!_i(t[i],e))return!1;for(let i=0;i<t.length-1;++i)if(bi(t[i],t[i+1],e))return!1;return!0}function Mi(t,e){for(let i=0;i<e.length;i++)if(wi(t,e[i]))return!0;return!1}function Ti(t,e,i){const n=[];for(let r=0;r<t.length;r++){const o=[];for(let n=0;n<t[r].length;n++){const a=gi(t[r][n],i);fi(e,a),o.push(a)}n.push(o)}return n}function Si(t,e,i){const n=[];for(let r=0;r<t.length;r++){const o=Ti(t[r],e,i);n.push(o)}return n}function Ei(t,e,i,n){if(t[0]<i[0]||t[0]>i[2]){const e=.5*n;let r=t[0]-i[0]>e?-n:i[0]-t[0]>e?n:0;0===r&&(r=t[0]-i[2]>e?-n:i[2]-t[0]>e?n:0),t[0]+=r}fi(e,t)}function Ci(t,e,i,n){const r=Math.pow(2,n.z)*pi,o=[n.x*pi,n.y*pi],a=[];for(const n of t)for(const t of n){const n=[t.x+o[0],t.y+o[1]];Ei(n,e,i,r),a.push(n)}return a}function Ai(t,e,i,n){const r=Math.pow(2,n.z)*pi,o=[n.x*pi,n.y*pi],a=[];for(const i of t){const t=[];for(const n of i){const i=[n.x+o[0],n.y+o[1]];fi(e,i),t.push(i)}a.push(t)}if(e[2]-e[0]<=r/2){(s=e)[0]=s[1]=1/0,s[2]=s[3]=-1/0;for(const t of a)for(const n of t)Ei(n,e,i,r)}var s;return a}class Pi{constructor(t,e){this.type=Ie,this.geojson=t,this.geometries=e}static parse(t,e){if(2!==t.length)return e.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Ke(t[1])){const e=t[1];if("FeatureCollection"===e.type)for(let t=0;t<e.features.length;++t){const i=e.features[t].geometry.type;if("Polygon"===i||"MultiPolygon"===i)return new Pi(e,e.features[t].geometry)}else if("Feature"===e.type){const t=e.geometry.type;if("Polygon"===t||"MultiPolygon"===t)return new Pi(e,e.geometry)}else if("Polygon"===e.type||"MultiPolygon"===e.type)return new Pi(e,e)}return e.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(t,e){const i=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],r=t.canonicalID();if("Polygon"===e.type){const o=Ti(e.coordinates,n,r),a=Ci(t.geometry(),i,n,r);if(!mi(i,n))return!1;for(const t of a)if(!_i(t,o))return!1}if("MultiPolygon"===e.type){const o=Si(e.coordinates,n,r),a=Ci(t.geometry(),i,n,r);if(!mi(i,n))return!1;for(const t of a)if(!vi(t,o))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(t,e){const i=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],r=t.canonicalID();if("Polygon"===e.type){const o=Ti(e.coordinates,n,r),a=Ai(t.geometry(),i,n,r);if(!mi(i,n))return!1;for(const t of a)if(!wi(t,o))return!1}if("MultiPolygon"===e.type){const o=Si(e.coordinates,n,r),a=Ai(t.geometry(),i,n,r);if(!mi(i,n))return!1;for(const t of a)if(!Mi(t,o))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}function Li(t){if(t instanceof ui){if("get"===t.name&&1===t.args.length)return!1;if("feature-state"===t.name)return!1;if("has"===t.name&&1===t.args.length)return!1;if("properties"===t.name||"geometry-type"===t.name||"id"===t.name)return!1;if(/^filter-/.test(t.name))return!1}if(t instanceof Pi)return!1;let e=!0;return t.eachChild(t=>{e&&!Li(t)&&(e=!1)}),e}function Ii(t){if(t instanceof ui&&"feature-state"===t.name)return!1;let e=!0;return t.eachChild(t=>{e&&!Ii(t)&&(e=!1)}),e}function Ri(t,e){if(t instanceof ui&&e.indexOf(t.name)>=0)return!1;let i=!0;return t.eachChild(t=>{i&&!Ri(t,e)&&(i=!1)}),i}class Di{constructor(t,e){this.type=e.type,this.name=t,this.boundExpression=e}static parse(t,e){if(2!==t.length||"string"!=typeof t[1])return e.error("'var' expression requires exactly one string literal argument.");const i=t[1];return e.scope.has(i)?new Di(i,e.scope.get(i)):e.error(`Unknown variable "${i}". Make sure "${i}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class ki{constructor(t,e=[],i,n=new Ce,r=[]){this.registry=t,this.path=e,this.key=e.map(t=>`[${t}]`).join(""),this.scope=n,this.errors=r,this.expectedType=i}parse(t,e,i,n,r={}){return e?this.concat(e,i,n)._parse(t,r):this._parse(t,r)}_parse(t,e){function i(t,e,i){return"assert"===i?new ri(e,[t]):"coerce"===i?new li(e,[t]):t}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const n=t[0];if("string"!=typeof n)return this.error(`Expression name must be a string, but found ${typeof n} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const r=this.registry[n];if(r){let n=r.parse(t,this);if(!n)return null;if(this.expectedType){const t=this.expectedType,r=n.type;if("string"!==t.kind&&"number"!==t.kind&&"boolean"!==t.kind&&"object"!==t.kind&&"array"!==t.kind||"value"!==r.kind)if("color"!==t.kind&&"formatted"!==t.kind&&"resolvedImage"!==t.kind||"value"!==r.kind&&"string"!==r.kind){if(this.checkSubtype(t,r))return null}else n=i(n,t,e.typeAnnotation||"coerce");else n=i(n,t,e.typeAnnotation||"assert")}if(!(n instanceof ei)&&"resolvedImage"!==n.type.kind&&function t(e){if(e instanceof Di)return t(e.boundExpression);if(e instanceof ui&&"error"===e.name)return!1;if(e instanceof di)return!1;if(e instanceof Pi)return!1;const i=e instanceof li||e instanceof ri;let n=!0;return e.eachChild(e=>{n=i?n&&t(e):n&&e instanceof ei}),!!n&&Li(e)&&Ri(e,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}(n)){const e=new hi;try{n=new ei(n.type,n.evaluate(e))}catch(t){return this.error(t.message),null}}return n}return this.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(void 0===t?"'undefined' value invalid. Use null instead.":"object"==typeof t?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,e,i){const n="number"==typeof t?this.path.concat(t):this.path,r=i?this.scope.concat(i):this.scope;return new ki(this.registry,n,e||null,r,this.errors)}error(t,...e){const i=`${this.key}${e.map(t=>`[${t}]`).join("")}`;this.errors.push(new Ee(i,t))}checkSubtype(t,e){const i=Ge(t,e);return i&&this.error(i),i}}function Oi(t,e){const i=t.length-1;let n,r,o=0,a=i,s=0;for(;o<=a;)if(s=Math.floor((o+a)/2),n=t[s],r=t[s+1],n<=e){if(s===i||e<r)return s;o=s+1}else{if(!(n>e))throw new ii("Input is not a number.");a=s-1}return 0}class zi{constructor(t,e,i){this.type=t,this.input=e,this.labels=[],this.outputs=[];for(const[t,e]of i)this.labels.push(t),this.outputs.push(e)}static parse(t,e){if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");const i=e.parse(t[1],1,Pe);if(!i)return null;const n=[];let r=null;e.expectedType&&"value"!==e.expectedType.kind&&(r=e.expectedType);for(let i=1;i<t.length;i+=2){const o=1===i?-1/0:t[i],a=t[i+1],s=i,l=i+1;if("number"!=typeof o)return e.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',s);if(n.length&&n[n.length-1][0]>=o)return e.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',s);const c=e.parse(a,l,r);if(!c)return null;r=r||c.type,n.push([o,c])}return new zi(r,i,n)}evaluate(t){const e=this.labels,i=this.outputs;if(1===e.length)return i[0].evaluate(t);const n=this.input.evaluate(t);if(n<=e[0])return i[0].evaluate(t);const r=e.length;return n>=e[r-1]?i[r-1].evaluate(t):i[Oi(e,n)].evaluate(t)}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let e=0;e<this.labels.length;e++)e>0&&t.push(this.labels[e]),t.push(this.outputs[e].serialize());return t}}function Bi(t,e,i){return t*(1-i)+e*i}var Fi=Object.freeze({__proto__:null,number:Bi,color:function(t,e,i){return new We(Bi(t.r,e.r,i),Bi(t.g,e.g,i),Bi(t.b,e.b,i),Bi(t.a,e.a,i))},array:function(t,e,i){return t.map((t,n)=>Bi(t,e[n],i))}});const Ni=6/29*3*(6/29),ji=Math.PI/180,Gi=180/Math.PI;function Ui(t){return t>.008856451679035631?Math.pow(t,1/3):t/Ni+4/29}function Vi(t){return t>6/29?t*t*t:Ni*(t-4/29)}function Hi(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function Zi(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function Wi(t){const e=Zi(t.r),i=Zi(t.g),n=Zi(t.b),r=Ui((.4124564*e+.3575761*i+.1804375*n)/.95047),o=Ui((.2126729*e+.7151522*i+.072175*n)/1);return{l:116*o-16,a:500*(r-o),b:200*(o-Ui((.0193339*e+.119192*i+.9503041*n)/1.08883)),alpha:t.a}}function qi(t){let e=(t.l+16)/116,i=isNaN(t.a)?e:e+t.a/500,n=isNaN(t.b)?e:e-t.b/200;return e=1*Vi(e),i=.95047*Vi(i),n=1.08883*Vi(n),new We(Hi(3.2404542*i-1.5371385*e-.4985314*n),Hi(-.969266*i+1.8760108*e+.041556*n),Hi(.0556434*i-.2040259*e+1.0572252*n),t.alpha)}function Xi(t,e,i){const n=e-t;return t+i*(n>180||n<-180?n-360*Math.round(n/360):n)}const Yi={forward:Wi,reverse:qi,interpolate:function(t,e,i){return{l:Bi(t.l,e.l,i),a:Bi(t.a,e.a,i),b:Bi(t.b,e.b,i),alpha:Bi(t.alpha,e.alpha,i)}}},$i={forward:function(t){const{l:e,a:i,b:n}=Wi(t),r=Math.atan2(n,i)*Gi;return{h:r<0?r+360:r,c:Math.sqrt(i*i+n*n),l:e,alpha:t.a}},reverse:function(t){const e=t.h*ji,i=t.c;return qi({l:t.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:t.alpha})},interpolate:function(t,e,i){return{h:Xi(t.h,e.h,i),c:Bi(t.c,e.c,i),l:Bi(t.l,e.l,i),alpha:Bi(t.alpha,e.alpha,i)}}};var Ji=Object.freeze({__proto__:null,lab:Yi,hcl:$i});class Ki{constructor(t,e,i,n,r){this.type=t,this.operator=e,this.interpolation=i,this.input=n,this.labels=[],this.outputs=[];for(const[t,e]of r)this.labels.push(t),this.outputs.push(e)}static interpolationFactor(t,e,i,r){let o=0;if("exponential"===t.name)o=Qi(e,t.base,i,r);else if("linear"===t.name)o=Qi(e,1,i,r);else if("cubic-bezier"===t.name){const a=t.controlPoints;o=new n(a[0],a[1],a[2],a[3]).solve(Qi(e,1,i,r))}return o}static parse(t,e){let[i,n,r,...o]=t;if(!Array.isArray(n)||0===n.length)return e.error("Expected an interpolation type expression.",1);if("linear"===n[0])n={name:"linear"};else if("exponential"===n[0]){const t=n[1];if("number"!=typeof t)return e.error("Exponential interpolation requires a numeric base.",1,1);n={name:"exponential",base:t}}else{if("cubic-bezier"!==n[0])return e.error("Unknown interpolation type "+String(n[0]),1,0);{const t=n.slice(1);if(4!==t.length||t.some(t=>"number"!=typeof t||t<0||t>1))return e.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);n={name:"cubic-bezier",controlPoints:t}}}if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");if(r=e.parse(r,2,Pe),!r)return null;const a=[];let s=null;"interpolate-hcl"===i||"interpolate-lab"===i?s=Re:e.expectedType&&"value"!==e.expectedType.kind&&(s=e.expectedType);for(let t=0;t<o.length;t+=2){const i=o[t],n=o[t+1],r=t+3,l=t+4;if("number"!=typeof i)return e.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',r);if(a.length&&a[a.length-1][0]>=i)return e.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',r);const c=e.parse(n,l,s);if(!c)return null;s=s||c.type,a.push([i,c])}return"number"===s.kind||"color"===s.kind||"array"===s.kind&&"number"===s.itemType.kind&&"number"==typeof s.N?new Ki(s,i,n,r,a):e.error(`Type ${Ne(s)} is not interpolatable.`)}evaluate(t){const e=this.labels,i=this.outputs;if(1===e.length)return i[0].evaluate(t);const n=this.input.evaluate(t);if(n<=e[0])return i[0].evaluate(t);const r=e.length;if(n>=e[r-1])return i[r-1].evaluate(t);const o=Oi(e,n),a=Ki.interpolationFactor(this.interpolation,n,e[o],e[o+1]),s=i[o].evaluate(t),l=i[o+1].evaluate(t);return"interpolate"===this.operator?Fi[this.type.kind.toLowerCase()](s,l,a):"interpolate-hcl"===this.operator?$i.reverse($i.interpolate($i.forward(s),$i.forward(l),a)):Yi.reverse(Yi.interpolate(Yi.forward(s),Yi.forward(l),a))}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const e=[this.operator,t,this.input.serialize()];for(let t=0;t<this.labels.length;t++)e.push(this.labels[t],this.outputs[t].serialize());return e}}function Qi(t,e,i,n){const r=n-i,o=t-i;return 0===r?0:1===e?o/r:(Math.pow(e,o)-1)/(Math.pow(e,r)-1)}class tn{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expectected at least one argument.");let i=null;const n=e.expectedType;n&&"value"!==n.kind&&(i=n);const r=[];for(const n of t.slice(1)){const t=e.parse(n,1+r.length,i,void 0,{typeAnnotation:"omit"});if(!t)return null;i=i||t.type,r.push(t)}const o=n&&r.some(t=>Ge(n,t.type));return new tn(o?ke:i,r)}evaluate(t){let e,i=null,n=0;for(const r of this.args){if(n++,i=r.evaluate(t),i&&i instanceof $e&&!i.available&&(e||(e=i),i=null,n===this.args.length))return e;if(null!==i)break}return i}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(e=>{t.push(e.serialize())}),t}}class en{constructor(t,e){this.type=e.type,this.bindings=[].concat(t),this.result=e}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const e of this.bindings)t(e[1]);t(this.result)}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const i=[];for(let n=1;n<t.length-1;n+=2){const r=t[n];if("string"!=typeof r)return e.error(`Expected string, but found ${typeof r} instead.`,n);if(/[^a-zA-Z0-9_]/.test(r))return e.error("Variable names must contain only alphanumeric characters or '_'.",n);const o=e.parse(t[n+1],n+1);if(!o)return null;i.push([r,o])}const n=e.parse(t[t.length-1],t.length-1,e.expectedType,i);return n?new en(i,n):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[e,i]of this.bindings)t.push(e,i.serialize());return t.push(this.result.serialize()),t}}class nn{constructor(t,e,i){this.type=t,this.index=e,this.input=i}static parse(t,e){if(3!==t.length)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const i=e.parse(t[1],1,Pe),n=e.parse(t[2],2,Fe(e.expectedType||ke));return i&&n?new nn(n.type.itemType,i,n):null}evaluate(t){const e=this.index.evaluate(t),i=this.input.evaluate(t);if(e<0)throw new ii(`Array index out of bounds: ${e} < 0.`);if(e>=i.length)throw new ii(`Array index out of bounds: ${e} > ${i.length-1}.`);if(e!==Math.floor(e))throw new ii(`Array index must be an integer, but found ${e} instead.`);return i[e]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class rn{constructor(t,e){this.type=Ie,this.needle=t,this.haystack=e}static parse(t,e){if(3!==t.length)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const i=e.parse(t[1],1,ke),n=e.parse(t[2],2,ke);return i&&n?Ue(i.type,[Ie,Le,Pe,Ae,ke])?new rn(i,n):e.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ne(i.type)} instead`):null}evaluate(t){const e=this.needle.evaluate(t),i=this.haystack.evaluate(t);if(!i)return!1;if(!Ve(e,["boolean","string","number","null"]))throw new ii(`Expected first argument to be of type boolean, string, number or null, but found ${Ne(Qe(e))} instead.`);if(!Ve(i,["string","array"]))throw new ii(`Expected second argument to be of type array or string, but found ${Ne(Qe(i))} instead.`);return i.indexOf(e)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class on{constructor(t,e,i){this.type=Pe,this.needle=t,this.haystack=e,this.fromIndex=i}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const i=e.parse(t[1],1,ke),n=e.parse(t[2],2,ke);if(!i||!n)return null;if(!Ue(i.type,[Ie,Le,Pe,Ae,ke]))return e.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ne(i.type)} instead`);if(4===t.length){const r=e.parse(t[3],3,Pe);return r?new on(i,n,r):null}return new on(i,n)}evaluate(t){const e=this.needle.evaluate(t),i=this.haystack.evaluate(t);if(!Ve(e,["boolean","string","number","null"]))throw new ii(`Expected first argument to be of type boolean, string, number or null, but found ${Ne(Qe(e))} instead.`);if(!Ve(i,["string","array"]))throw new ii(`Expected second argument to be of type array or string, but found ${Ne(Qe(i))} instead.`);if(this.fromIndex){const n=this.fromIndex.evaluate(t);return i.indexOf(e,n)}return i.indexOf(e)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class an{constructor(t,e,i,n,r,o){this.inputType=t,this.type=e,this.input=i,this.cases=n,this.outputs=r,this.otherwise=o}static parse(t,e){if(t.length<5)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return e.error("Expected an even number of arguments.");let i,n;e.expectedType&&"value"!==e.expectedType.kind&&(n=e.expectedType);const r={},o=[];for(let a=2;a<t.length-1;a+=2){let s=t[a];const l=t[a+1];Array.isArray(s)||(s=[s]);const c=e.concat(a);if(0===s.length)return c.error("Expected at least one branch label.");for(const t of s){if("number"!=typeof t&&"string"!=typeof t)return c.error("Branch labels must be numbers or strings.");if("number"==typeof t&&Math.abs(t)>Number.MAX_SAFE_INTEGER)return c.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof t&&Math.floor(t)!==t)return c.error("Numeric branch labels must be integer values.");if(i){if(c.checkSubtype(i,Qe(t)))return null}else i=Qe(t);if(void 0!==r[String(t)])return c.error("Branch labels must be unique.");r[String(t)]=o.length}const h=e.parse(l,a,n);if(!h)return null;n=n||h.type,o.push(h)}const a=e.parse(t[1],1,ke);if(!a)return null;const s=e.parse(t[t.length-1],t.length-1,n);return s?"value"!==a.type.kind&&e.concat(1).checkSubtype(i,a.type)?null:new an(i,n,a,r,o,s):null}evaluate(t){const e=this.input.evaluate(t);return(Qe(e)===this.inputType&&this.outputs[this.cases[e]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],e=Object.keys(this.cases).sort(),i=[],n={};for(const t of e){const e=n[this.cases[t]];void 0===e?(n[this.cases[t]]=i.length,i.push([this.cases[t],[t]])):i[e][1].push(t)}const r=t=>"number"===this.inputType.kind?Number(t):t;for(const[e,n]of i)t.push(1===n.length?r(n[0]):n.map(r)),t.push(this.outputs[e].serialize());return t.push(this.otherwise.serialize()),t}}class sn{constructor(t,e,i){this.type=t,this.branches=e,this.otherwise=i}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return e.error("Expected an odd number of arguments.");let i;e.expectedType&&"value"!==e.expectedType.kind&&(i=e.expectedType);const n=[];for(let r=1;r<t.length-1;r+=2){const o=e.parse(t[r],r,Ie);if(!o)return null;const a=e.parse(t[r+1],r+1,i);if(!a)return null;n.push([o,a]),i=i||a.type}const r=e.parse(t[t.length-1],t.length-1,i);return r?new sn(i,n,r):null}evaluate(t){for(const[e,i]of this.branches)if(e.evaluate(t))return i.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[e,i]of this.branches)t(e),t(i);t(this.otherwise)}outputDefined(){return this.branches.every(([t,e])=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(e=>{t.push(e.serialize())}),t}}class ln{constructor(t,e,i,n){this.type=t,this.input=e,this.beginIndex=i,this.endIndex=n}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const i=e.parse(t[1],1,ke),n=e.parse(t[2],2,Pe);if(!i||!n)return null;if(!Ue(i.type,[Fe(ke),Le,ke]))return e.error(`Expected first argument to be of type array or string, but found ${Ne(i.type)} instead`);if(4===t.length){const r=e.parse(t[3],3,Pe);return r?new ln(i.type,i,n,r):null}return new ln(i.type,i,n)}evaluate(t){const e=this.input.evaluate(t),i=this.beginIndex.evaluate(t);if(!Ve(e,["string","array"]))throw new ii(`Expected first argument to be of type array or string, but found ${Ne(Qe(e))} instead.`);if(this.endIndex){const n=this.endIndex.evaluate(t);return e.slice(i,n)}return e.slice(i)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function cn(t,e){return"=="===t||"!="===t?"boolean"===e.kind||"string"===e.kind||"number"===e.kind||"null"===e.kind||"value"===e.kind:"string"===e.kind||"number"===e.kind||"value"===e.kind}function hn(t,e,i,n){return 0===n.compare(e,i)}function un(t,e,i){const n="=="!==t&&"!="!==t;return class r{constructor(t,e,i){this.type=Ie,this.lhs=t,this.rhs=e,this.collator=i,this.hasUntypedArgument="value"===t.type.kind||"value"===e.type.kind}static parse(t,e){if(3!==t.length&&4!==t.length)return e.error("Expected two or three arguments.");const i=t[0];let o=e.parse(t[1],1,ke);if(!o)return null;if(!cn(i,o.type))return e.concat(1).error(`"${i}" comparisons are not supported for type '${Ne(o.type)}'.`);let a=e.parse(t[2],2,ke);if(!a)return null;if(!cn(i,a.type))return e.concat(2).error(`"${i}" comparisons are not supported for type '${Ne(a.type)}'.`);if(o.type.kind!==a.type.kind&&"value"!==o.type.kind&&"value"!==a.type.kind)return e.error(`Cannot compare types '${Ne(o.type)}' and '${Ne(a.type)}'.`);n&&("value"===o.type.kind&&"value"!==a.type.kind?o=new ri(a.type,[o]):"value"!==o.type.kind&&"value"===a.type.kind&&(a=new ri(o.type,[a])));let s=null;if(4===t.length){if("string"!==o.type.kind&&"string"!==a.type.kind&&"value"!==o.type.kind&&"value"!==a.type.kind)return e.error("Cannot use collator to compare non-string types.");if(s=e.parse(t[3],3,Oe),!s)return null}return new r(o,a,s)}evaluate(r){const o=this.lhs.evaluate(r),a=this.rhs.evaluate(r);if(n&&this.hasUntypedArgument){const e=Qe(o),i=Qe(a);if(e.kind!==i.kind||"string"!==e.kind&&"number"!==e.kind)throw new ii(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${e.kind}, ${i.kind}) instead.`)}if(this.collator&&!n&&this.hasUntypedArgument){const t=Qe(o),i=Qe(a);if("string"!==t.kind||"string"!==i.kind)return e(r,o,a)}return this.collator?i(r,o,a,this.collator.evaluate(r)):e(r,o,a)}eachChild(t){t(this.lhs),t(this.rhs),this.collator&&t(this.collator)}outputDefined(){return!0}serialize(){const e=[t];return this.eachChild(t=>{e.push(t.serialize())}),e}}}const dn=un("==",(function(t,e,i){return e===i}),hn),pn=un("!=",(function(t,e,i){return e!==i}),(function(t,e,i,n){return!hn(0,e,i,n)})),fn=un("<",(function(t,e,i){return e<i}),(function(t,e,i,n){return n.compare(e,i)<0})),mn=un(">",(function(t,e,i){return e>i}),(function(t,e,i,n){return n.compare(e,i)>0})),gn=un("<=",(function(t,e,i){return e<=i}),(function(t,e,i,n){return n.compare(e,i)<=0})),yn=un(">=",(function(t,e,i){return e>=i}),(function(t,e,i,n){return n.compare(e,i)>=0}));class _n{constructor(t,e,i,n,r){this.type=Le,this.number=t,this.locale=e,this.currency=i,this.minFractionDigits=n,this.maxFractionDigits=r}static parse(t,e){if(3!==t.length)return e.error("Expected two arguments.");const i=e.parse(t[1],1,Pe);if(!i)return null;const n=t[2];if("object"!=typeof n||Array.isArray(n))return e.error("NumberFormat options argument must be an object.");let r=null;if(n.locale&&(r=e.parse(n.locale,1,Le),!r))return null;let o=null;if(n.currency&&(o=e.parse(n.currency,1,Le),!o))return null;let a=null;if(n["min-fraction-digits"]&&(a=e.parse(n["min-fraction-digits"],1,Pe),!a))return null;let s=null;return n["max-fraction-digits"]&&(s=e.parse(n["max-fraction-digits"],1,Pe),!s)?null:new _n(i,r,o,a,s)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class vn{constructor(t){this.type=Pe,this.input=t}static parse(t,e){if(2!==t.length)return e.error(`Expected 1 argument, but found ${t.length-1} instead.`);const i=e.parse(t[1],1);return i?"array"!==i.type.kind&&"string"!==i.type.kind&&"value"!==i.type.kind?e.error(`Expected argument of type string or array, but found ${Ne(i.type)} instead.`):new vn(i):null}evaluate(t){const e=this.input.evaluate(t);if("string"==typeof e)return e.length;if(Array.isArray(e))return e.length;throw new ii(`Expected value to be of type string or array, but found ${Ne(Qe(e))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(e=>{t.push(e.serialize())}),t}}const xn={"==":dn,"!=":pn,">":mn,"<":fn,">=":yn,"<=":gn,array:ri,at:nn,boolean:ri,case:sn,coalesce:tn,collator:di,format:oi,image:ai,in:rn,"index-of":on,interpolate:Ki,"interpolate-hcl":Ki,"interpolate-lab":Ki,length:vn,let:en,literal:ei,match:an,number:ri,"number-format":_n,object:ri,slice:ln,step:zi,string:ri,"to-boolean":li,"to-color":li,"to-number":li,"to-string":li,var:Di,within:Pi};function bn(t,[e,i,n,r]){e=e.evaluate(t),i=i.evaluate(t),n=n.evaluate(t);const o=r?r.evaluate(t):1,a=Je(e,i,n,o);if(a)throw new ii(a);return new We(e/255*o,i/255*o,n/255*o,o)}function wn(t,e){return t in e}function Mn(t,e){const i=e[t];return void 0===i?null:i}function Tn(t){return{type:t}}function Sn(t){return{result:"success",value:t}}function En(t){return{result:"error",value:t}}function Cn(t){return"data-driven"===t["property-type"]||"cross-faded-data-driven"===t["property-type"]}function An(t){return!!t.expression&&t.expression.parameters.indexOf("zoom")>-1}function Pn(t){return!!t.expression&&t.expression.interpolated}function Ln(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":null===t?"null":typeof t}function In(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function Rn(t){return t}function Dn(t,e,i){return void 0!==t?t:void 0!==e?e:void 0!==i?i:void 0}function kn(t,e,i,n,r){return Dn(typeof i===r?n[i]:void 0,t.default,e.default)}function On(t,e,i){if("number"!==Ln(i))return Dn(t.default,e.default);const n=t.stops.length;if(1===n)return t.stops[0][1];if(i<=t.stops[0][0])return t.stops[0][1];if(i>=t.stops[n-1][0])return t.stops[n-1][1];const r=Oi(t.stops.map(t=>t[0]),i);return t.stops[r][1]}function zn(t,e,i){const n=void 0!==t.base?t.base:1;if("number"!==Ln(i))return Dn(t.default,e.default);const r=t.stops.length;if(1===r)return t.stops[0][1];if(i<=t.stops[0][0])return t.stops[0][1];if(i>=t.stops[r-1][0])return t.stops[r-1][1];const o=Oi(t.stops.map(t=>t[0]),i),a=function(t,e,i,n){const r=n-i,o=t-i;return 0===r?0:1===e?o/r:(Math.pow(e,o)-1)/(Math.pow(e,r)-1)}(i,n,t.stops[o][0],t.stops[o+1][0]),s=t.stops[o][1],l=t.stops[o+1][1];let c=Fi[e.type]||Rn;if(t.colorSpace&&"rgb"!==t.colorSpace){const e=Ji[t.colorSpace];c=(t,i)=>e.reverse(e.interpolate(e.forward(t),e.forward(i),a))}return"function"==typeof s.evaluate?{evaluate(...t){const e=s.evaluate.apply(void 0,t),i=l.evaluate.apply(void 0,t);if(void 0!==e&&void 0!==i)return c(e,i,a)}}:c(s,l,a)}function Bn(t,e,i){return"color"===e.type?i=We.parse(i):"formatted"===e.type?i=Ye.fromString(i.toString()):"resolvedImage"===e.type?i=$e.fromString(i.toString()):Ln(i)===e.type||"enum"===e.type&&e.values[i]||(i=void 0),Dn(i,t.default,e.default)}ui.register(xn,{error:[{kind:"error"},[Le],(t,[e])=>{throw new ii(e.evaluate(t))}],typeof:[Le,[ke],(t,[e])=>Ne(Qe(e.evaluate(t)))],"to-rgba":[Fe(Pe,4),[Re],(t,[e])=>e.evaluate(t).toArray()],rgb:[Re,[Pe,Pe,Pe],bn],rgba:[Re,[Pe,Pe,Pe,Pe],bn],has:{type:Ie,overloads:[[[Le],(t,[e])=>wn(e.evaluate(t),t.properties())],[[Le,De],(t,[e,i])=>wn(e.evaluate(t),i.evaluate(t))]]},get:{type:ke,overloads:[[[Le],(t,[e])=>Mn(e.evaluate(t),t.properties())],[[Le,De],(t,[e,i])=>Mn(e.evaluate(t),i.evaluate(t))]]},"feature-state":[ke,[Le],(t,[e])=>Mn(e.evaluate(t),t.featureState||{})],properties:[De,[],t=>t.properties()],"geometry-type":[Le,[],t=>t.geometryType()],id:[ke,[],t=>t.id()],zoom:[Pe,[],t=>t.globals.zoom],pitch:[Pe,[],t=>t.globals.pitch||0],"distance-from-center":[Pe,[],t=>t.distanceFromCenter()],"heatmap-density":[Pe,[],t=>t.globals.heatmapDensity||0],"line-progress":[Pe,[],t=>t.globals.lineProgress||0],"sky-radial-progress":[Pe,[],t=>t.globals.skyRadialProgress||0],accumulated:[ke,[],t=>void 0===t.globals.accumulated?null:t.globals.accumulated],"+":[Pe,Tn(Pe),(t,e)=>{let i=0;for(const n of e)i+=n.evaluate(t);return i}],"*":[Pe,Tn(Pe),(t,e)=>{let i=1;for(const n of e)i*=n.evaluate(t);return i}],"-":{type:Pe,overloads:[[[Pe,Pe],(t,[e,i])=>e.evaluate(t)-i.evaluate(t)],[[Pe],(t,[e])=>-e.evaluate(t)]]},"/":[Pe,[Pe,Pe],(t,[e,i])=>e.evaluate(t)/i.evaluate(t)],"%":[Pe,[Pe,Pe],(t,[e,i])=>e.evaluate(t)%i.evaluate(t)],ln2:[Pe,[],()=>Math.LN2],pi:[Pe,[],()=>Math.PI],e:[Pe,[],()=>Math.E],"^":[Pe,[Pe,Pe],(t,[e,i])=>Math.pow(e.evaluate(t),i.evaluate(t))],sqrt:[Pe,[Pe],(t,[e])=>Math.sqrt(e.evaluate(t))],log10:[Pe,[Pe],(t,[e])=>Math.log(e.evaluate(t))/Math.LN10],ln:[Pe,[Pe],(t,[e])=>Math.log(e.evaluate(t))],log2:[Pe,[Pe],(t,[e])=>Math.log(e.evaluate(t))/Math.LN2],sin:[Pe,[Pe],(t,[e])=>Math.sin(e.evaluate(t))],cos:[Pe,[Pe],(t,[e])=>Math.cos(e.evaluate(t))],tan:[Pe,[Pe],(t,[e])=>Math.tan(e.evaluate(t))],asin:[Pe,[Pe],(t,[e])=>Math.asin(e.evaluate(t))],acos:[Pe,[Pe],(t,[e])=>Math.acos(e.evaluate(t))],atan:[Pe,[Pe],(t,[e])=>Math.atan(e.evaluate(t))],min:[Pe,Tn(Pe),(t,e)=>Math.min(...e.map(e=>e.evaluate(t)))],max:[Pe,Tn(Pe),(t,e)=>Math.max(...e.map(e=>e.evaluate(t)))],abs:[Pe,[Pe],(t,[e])=>Math.abs(e.evaluate(t))],round:[Pe,[Pe],(t,[e])=>{const i=e.evaluate(t);return i<0?-Math.round(-i):Math.round(i)}],floor:[Pe,[Pe],(t,[e])=>Math.floor(e.evaluate(t))],ceil:[Pe,[Pe],(t,[e])=>Math.ceil(e.evaluate(t))],"filter-==":[Ie,[Le,ke],(t,[e,i])=>t.properties()[e.value]===i.value],"filter-id-==":[Ie,[ke],(t,[e])=>t.id()===e.value],"filter-type-==":[Ie,[Le],(t,[e])=>t.geometryType()===e.value],"filter-<":[Ie,[Le,ke],(t,[e,i])=>{const n=t.properties()[e.value],r=i.value;return typeof n==typeof r&&n<r}],"filter-id-<":[Ie,[ke],(t,[e])=>{const i=t.id(),n=e.value;return typeof i==typeof n&&i<n}],"filter->":[Ie,[Le,ke],(t,[e,i])=>{const n=t.properties()[e.value],r=i.value;return typeof n==typeof r&&n>r}],"filter-id->":[Ie,[ke],(t,[e])=>{const i=t.id(),n=e.value;return typeof i==typeof n&&i>n}],"filter-<=":[Ie,[Le,ke],(t,[e,i])=>{const n=t.properties()[e.value],r=i.value;return typeof n==typeof r&&n<=r}],"filter-id-<=":[Ie,[ke],(t,[e])=>{const i=t.id(),n=e.value;return typeof i==typeof n&&i<=n}],"filter->=":[Ie,[Le,ke],(t,[e,i])=>{const n=t.properties()[e.value],r=i.value;return typeof n==typeof r&&n>=r}],"filter-id->=":[Ie,[ke],(t,[e])=>{const i=t.id(),n=e.value;return typeof i==typeof n&&i>=n}],"filter-has":[Ie,[ke],(t,[e])=>e.value in t.properties()],"filter-has-id":[Ie,[],t=>null!==t.id()&&void 0!==t.id()],"filter-type-in":[Ie,[Fe(Le)],(t,[e])=>e.value.indexOf(t.geometryType())>=0],"filter-id-in":[Ie,[Fe(ke)],(t,[e])=>e.value.indexOf(t.id())>=0],"filter-in-small":[Ie,[Le,Fe(ke)],(t,[e,i])=>i.value.indexOf(t.properties()[e.value])>=0],"filter-in-large":[Ie,[Le,Fe(ke)],(t,[e,i])=>function(t,e,i,n){for(;i<=n;){const r=i+n>>1;if(e[r]===t)return!0;e[r]>t?n=r-1:i=r+1}return!1}(t.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Ie,overloads:[[[Ie,Ie],(t,[e,i])=>e.evaluate(t)&&i.evaluate(t)],[Tn(Ie),(t,e)=>{for(const i of e)if(!i.evaluate(t))return!1;return!0}]]},any:{type:Ie,overloads:[[[Ie,Ie],(t,[e,i])=>e.evaluate(t)||i.evaluate(t)],[Tn(Ie),(t,e)=>{for(const i of e)if(i.evaluate(t))return!0;return!1}]]},"!":[Ie,[Ie],(t,[e])=>!e.evaluate(t)],"is-supported-script":[Ie,[Le],(t,[e])=>{const i=t.globals&&t.globals.isSupportedScript;return!i||i(e.evaluate(t))}],upcase:[Le,[Le],(t,[e])=>e.evaluate(t).toUpperCase()],downcase:[Le,[Le],(t,[e])=>e.evaluate(t).toLowerCase()],concat:[Le,Tn(ke),(t,e)=>e.map(e=>ti(e.evaluate(t))).join("")],"resolved-locale":[Le,[Oe],(t,[e])=>e.evaluate(t).resolvedLocale()]});class Fn{constructor(t,e){this.expression=t,this._warningHistory={},this._evaluator=new hi,this._defaultValue=e?function(t){return"color"===t.type&&In(t.default)?new We(0,0,0,0):"color"===t.type?We.parse(t.default)||null:void 0===t.default?null:t.default}(e):null,this._enumValues=e&&"enum"===e.type?e.values:null}evaluateWithoutErrorHandling(t,e,i,n,r,o,a,s){return this._evaluator.globals=t,this._evaluator.feature=e,this._evaluator.featureState=i,this._evaluator.canonical=n,this._evaluator.availableImages=r||null,this._evaluator.formattedSection=o,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=s||null,this.expression.evaluate(this._evaluator)}evaluate(t,e,i,n,r,o,a,s){this._evaluator.globals=t,this._evaluator.feature=e||null,this._evaluator.featureState=i||null,this._evaluator.canonical=n,this._evaluator.availableImages=r||null,this._evaluator.formattedSection=o||null,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=s||null;try{const t=this.expression.evaluate(this._evaluator);if(null==t||"number"==typeof t&&t!=t)return this._defaultValue;if(this._enumValues&&!(t in this._enumValues))throw new ii(`Expected value to be one of ${Object.keys(this._enumValues).map(t=>JSON.stringify(t)).join(", ")}, but found ${JSON.stringify(t)} instead.`);return t}catch(t){return this._warningHistory[t.message]||(this._warningHistory[t.message]=!0,"undefined"!=typeof console&&console.warn(t.message)),this._defaultValue}}}function Nn(t){return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]&&t[0]in xn}function jn(t,e){const i=new ki(xn,[],e?function(t){const e={color:Re,string:Le,number:Pe,enum:Le,boolean:Ie,formatted:ze,resolvedImage:Be};return"array"===t.type?Fe(e[t.value]||ke,t.length):e[t.type]}(e):void 0),n=i.parse(t,void 0,void 0,void 0,e&&"string"===e.type?{typeAnnotation:"coerce"}:void 0);return n?Sn(new Fn(n,e)):En(i.errors)}class Gn{constructor(t,e){this.kind=t,this._styleExpression=e,this.isStateDependent="constant"!==t&&!Ii(e.expression)}evaluateWithoutErrorHandling(t,e,i,n,r,o){return this._styleExpression.evaluateWithoutErrorHandling(t,e,i,n,r,o)}evaluate(t,e,i,n,r,o){return this._styleExpression.evaluate(t,e,i,n,r,o)}}class Un{constructor(t,e,i,n){this.kind=t,this.zoomStops=i,this._styleExpression=e,this.isStateDependent="camera"!==t&&!Ii(e.expression),this.interpolationType=n}evaluateWithoutErrorHandling(t,e,i,n,r,o){return this._styleExpression.evaluateWithoutErrorHandling(t,e,i,n,r,o)}evaluate(t,e,i,n,r,o){return this._styleExpression.evaluate(t,e,i,n,r,o)}interpolationFactor(t,e,i){return this.interpolationType?Ki.interpolationFactor(this.interpolationType,t,e,i):0}}function Vn(t,e){if("error"===(t=jn(t,e)).result)return t;const i=t.value.expression,n=Li(i);if(!n&&!Cn(e))return En([new Ee("","data expressions not supported")]);const r=Ri(i,["zoom","pitch","distance-from-center"]);if(!r&&!An(e))return En([new Ee("","zoom expressions not supported")]);const o=function t(e){let i=null;if(e instanceof en)i=t(e.result);else if(e instanceof tn){for(const n of e.args)if(i=t(n),i)break}else(e instanceof zi||e instanceof Ki)&&e.input instanceof ui&&"zoom"===e.input.name&&(i=e);return i instanceof Ee||e.eachChild(e=>{const n=t(e);n instanceof Ee?i=n:!i&&n?i=new Ee("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):i&&n&&i!==n&&(i=new Ee("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),i}(i);return o||r?o instanceof Ee?En([o]):o instanceof Ki&&!Pn(e)?En([new Ee("",'"interpolate" expressions cannot be used with this property')]):Sn(o?new Un(n?"camera":"composite",t.value,o.labels,o instanceof Ki?o.interpolation:void 0):new Gn(n?"constant":"source",t.value)):En([new Ee("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Hn{constructor(t,e){this._parameters=t,this._specification=e,Me(this,function t(e,i){const n="color"===i.type,r=e.stops&&"object"==typeof e.stops[0][0],o=r||!(r||void 0!==e.property),a=e.type||(Pn(i)?"exponential":"interval");if(n&&((e=Me({},e)).stops&&(e.stops=e.stops.map(t=>[t[0],We.parse(t[1])])),e.default=We.parse(e.default?e.default:i.default)),e.colorSpace&&"rgb"!==e.colorSpace&&!Ji[e.colorSpace])throw new Error("Unknown color space: "+e.colorSpace);let s,l,c;if("exponential"===a)s=zn;else if("interval"===a)s=On;else if("categorical"===a){s=kn,l=Object.create(null);for(const t of e.stops)l[t[0]]=t[1];c=typeof e.stops[0][0]}else{if("identity"!==a)throw new Error(`Unknown function type "${a}"`);s=Bn}if(r){const n={},r=[];for(let t=0;t<e.stops.length;t++){const i=e.stops[t],o=i[0].zoom;void 0===n[o]&&(n[o]={zoom:o,type:e.type,property:e.property,default:e.default,stops:[]},r.push(o)),n[o].stops.push([i[0].value,i[1]])}const o=[];for(const e of r)o.push([n[e].zoom,t(n[e],i)]);const a={name:"linear"};return{kind:"composite",interpolationType:a,interpolationFactor:Ki.interpolationFactor.bind(void 0,a),zoomStops:o.map(t=>t[0]),evaluate:({zoom:t},n)=>zn({stops:o,base:e.base},i,t).evaluate(t,n)}}if(o){const t="exponential"===a?{name:"exponential",base:void 0!==e.base?e.base:1}:null;return{kind:"camera",interpolationType:t,interpolationFactor:Ki.interpolationFactor.bind(void 0,t),zoomStops:e.stops.map(t=>t[0]),evaluate:({zoom:t})=>s(e,i,t,l,c)}}return{kind:"source",evaluate(t,n){const r=n&&n.properties?n.properties[e.property]:void 0;return void 0===r?Dn(e.default,i.default):s(e,i,r,l,c)}}}(this._parameters,this._specification))}static deserialize(t){return new Hn(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function Zn(t){const e=t.key,i=t.value,n=t.valueSpec||{},r=t.objectElementValidators||{},o=t.style,a=t.styleSpec;let s=[];const l=Ln(i);if("object"!==l)return[new be(e,i,`object expected, ${l} found`)];for(const t in i){const l=t.split(".")[0],c=n[l]||n["*"];let h;if(r[l])h=r[l];else if(n[l])h=xr;else if(r["*"])h=r["*"];else{if(!n["*"]){s.push(new be(e,i[t],`unknown property "${t}"`));continue}h=xr}s=s.concat(h({key:(e?e+".":e)+t,value:i[t],valueSpec:c,style:o,styleSpec:a,object:i,objectKey:t},i))}for(const t in n)r[t]||n[t].required&&void 0===n[t].default&&void 0===i[t]&&s.push(new be(e,i,`missing required property "${t}"`));return s}function Wn(t){const e=t.value,i=t.valueSpec,n=t.style,r=t.styleSpec,o=t.key,a=t.arrayElementValidator||xr;if("array"!==Ln(e))return[new be(o,e,`array expected, ${Ln(e)} found`)];if(i.length&&e.length!==i.length)return[new be(o,e,`array length ${i.length} expected, length ${e.length} found`)];if(i["min-length"]&&e.length<i["min-length"])return[new be(o,e,`array length at least ${i["min-length"]} expected, length ${e.length} found`)];let s={type:i.value,values:i.values,minimum:i.minimum,maximum:i.maximum};r.$version<7&&(s.function=i.function),"object"===Ln(i.value)&&(s=i.value);let l=[];for(let t=0;t<e.length;t++)l=l.concat(a({array:e,arrayIndex:t,value:e[t],valueSpec:s,style:n,styleSpec:r,key:`${o}[${t}]`}));return l}function qn(t){const e=t.key,i=t.value,n=t.valueSpec;let r=Ln(i);if("number"===r&&i!=i&&(r="NaN"),"number"!==r)return[new be(e,i,`number expected, ${r} found`)];if("minimum"in n){let r=n.minimum;if("array"===Ln(n.minimum)&&(r=n.minimum[t.arrayIndex]),i<r)return[new be(e,i,`${i} is less than the minimum value ${r}`)]}if("maximum"in n){let r=n.maximum;if("array"===Ln(n.maximum)&&(r=n.maximum[t.arrayIndex]),i>r)return[new be(e,i,`${i} is greater than the maximum value ${r}`)]}return[]}function Xn(t){const e=t.valueSpec,i=Te(t.value.type);let n,r,o,a={};const s="categorical"!==i&&void 0===t.value.property,l=!s,c="array"===Ln(t.value.stops)&&"array"===Ln(t.value.stops[0])&&"object"===Ln(t.value.stops[0][0]),h=Zn({key:t.key,value:t.value,valueSpec:t.styleSpec.function,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{stops:function(t){if("identity"===i)return[new be(t.key,t.value,'identity function may not have a "stops" property')];let e=[];const n=t.value;return e=e.concat(Wn({key:t.key,value:n,valueSpec:t.valueSpec,style:t.style,styleSpec:t.styleSpec,arrayElementValidator:u})),"array"===Ln(n)&&0===n.length&&e.push(new be(t.key,n,"array must have at least one stop")),e},default:function(t){return xr({key:t.key,value:t.value,valueSpec:e,style:t.style,styleSpec:t.styleSpec})}}});return"identity"===i&&s&&h.push(new be(t.key,t.value,'missing required property "property"')),"identity"===i||t.value.stops||h.push(new be(t.key,t.value,'missing required property "stops"')),"exponential"===i&&t.valueSpec.expression&&!Pn(t.valueSpec)&&h.push(new be(t.key,t.value,"exponential functions not supported")),t.styleSpec.$version>=8&&(l&&!Cn(t.valueSpec)?h.push(new be(t.key,t.value,"property functions not supported")):s&&!An(t.valueSpec)&&h.push(new be(t.key,t.value,"zoom functions not supported"))),"categorical"!==i&&!c||void 0!==t.value.property||h.push(new be(t.key,t.value,'"property" property is required')),h;function u(t){let i=[];const n=t.value,s=t.key;if("array"!==Ln(n))return[new be(s,n,`array expected, ${Ln(n)} found`)];if(2!==n.length)return[new be(s,n,`array length 2 expected, length ${n.length} found`)];if(c){if("object"!==Ln(n[0]))return[new be(s,n,`object expected, ${Ln(n[0])} found`)];if(void 0===n[0].zoom)return[new be(s,n,"object stop key must have zoom")];if(void 0===n[0].value)return[new be(s,n,"object stop key must have value")];if(o&&o>Te(n[0].zoom))return[new be(s,n[0].zoom,"stop zoom values must appear in ascending order")];Te(n[0].zoom)!==o&&(o=Te(n[0].zoom),r=void 0,a={}),i=i.concat(Zn({key:s+"[0]",value:n[0],valueSpec:{zoom:{}},style:t.style,styleSpec:t.styleSpec,objectElementValidators:{zoom:qn,value:d}}))}else i=i.concat(d({key:s+"[0]",value:n[0],valueSpec:{},style:t.style,styleSpec:t.styleSpec},n));return Nn(Se(n[1]))?i.concat([new be(s+"[1]",n[1],"expressions are not allowed in function stops.")]):i.concat(xr({key:s+"[1]",value:n[1],valueSpec:e,style:t.style,styleSpec:t.styleSpec}))}function d(t,o){const s=Ln(t.value),l=Te(t.value),c=null!==t.value?t.value:o;if(n){if(s!==n)return[new be(t.key,c,`${s} stop domain type must match previous stop domain type ${n}`)]}else n=s;if("number"!==s&&"string"!==s&&"boolean"!==s)return[new be(t.key,c,"stop domain value must be a number, string, or boolean")];if("number"!==s&&"categorical"!==i){let n=`number expected, ${s} found`;return Cn(e)&&void 0===i&&(n+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new be(t.key,c,n)]}return"categorical"!==i||"number"!==s||isFinite(l)&&Math.floor(l)===l?"categorical"!==i&&"number"===s&&void 0!==r&&l<r?[new be(t.key,c,"stop domain values must appear in ascending order")]:(r=l,"categorical"===i&&l in a?[new be(t.key,c,"stop domain values must be unique")]:(a[l]=!0,[])):[new be(t.key,c,"integer expected, found "+l)]}}function Yn(t){const e=("property"===t.expressionContext?Vn:jn)(Se(t.value),t.valueSpec);if("error"===e.result)return e.value.map(e=>new be(`${t.key}${e.key}`,t.value,e.message));const i=e.value.expression||e.value._styleExpression.expression;if("property"===t.expressionContext&&"text-font"===t.propertyKey&&!i.outputDefined())return[new be(t.key,t.value,`Invalid data expression for "${t.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===t.expressionContext&&"layout"===t.propertyType&&!Ii(i))return[new be(t.key,t.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===t.expressionContext)return function t(e,i){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);for(const t of i.valueSpec.expression.parameters)n.delete(t);if(0===n.size)return[];const r=[];return e instanceof ui&&n.has(e.name)?[new be(i.key,i.value,`["${e.name}"] expression is not supported in a filter for a ${i.object.type} layer with id: ${i.object.id}`)]:(e.eachChild(e=>{r.push(...t(e,i))}),r)}(i,t);if(t.expressionContext&&0===t.expressionContext.indexOf("cluster")){if(!Ri(i,["zoom","feature-state"]))return[new be(t.key,t.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===t.expressionContext&&!Li(i))return[new be(t.key,t.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function $n(t){const e=t.key,i=t.value,n=t.valueSpec,r=[];return Array.isArray(n.values)?-1===n.values.indexOf(Te(i))&&r.push(new be(e,i,`expected one of [${n.values.join(", ")}], ${JSON.stringify(i)} found`)):-1===Object.keys(n.values).indexOf(Te(i))&&r.push(new be(e,i,`expected one of [${Object.keys(n.values).join(", ")}], ${JSON.stringify(i)} found`)),r}function Jn(t){if(!0===t||!1===t)return!0;if(!Array.isArray(t)||0===t.length)return!1;switch(t[0]){case"has":return t.length>=2&&"$id"!==t[1]&&"$type"!==t[1];case"in":return t.length>=3&&("string"!=typeof t[1]||Array.isArray(t[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==t.length||Array.isArray(t[1])||Array.isArray(t[2]);case"any":case"all":for(const e of t.slice(1))if(!Jn(e)&&"boolean"!=typeof e)return!1;return!0;default:return!0}}function Kn(t,e="fill"){if(null==t)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Jn(t)||(t=nr(t));const i=t;let n=!0;try{n=function(t){if(!Qn(t))return t;let e=Se(t);return function t(e){let i=!1;const n=[];if("case"===e[0]){for(let t=1;t<e.length-1;t+=2)i=i||Qn(e[t]),n.push(e[t+1]);n.push(e[e.length-1])}else if("match"===e[0]){i=i||Qn(e[1]);for(let t=2;t<e.length-1;t+=2)n.push(e[t+1]);n.push(e[e.length-1])}else if("step"===e[0]){i=i||Qn(e[1]);for(let t=1;t<e.length-1;t+=2)n.push(e[t+1])}i&&(e.length=0,e.push("any",...n));for(let i=1;i<e.length;i++)t(e[i])}(e),e=function t(e){if(!Array.isArray(e))return e;const i=function(t){if(tr.has(t[0]))for(let e=1;e<t.length;e++)if(Qn(t[e]))return!0;return t}(e);return!0===i?i:i.map(e=>t(e))}(e),e}(i)}catch(t){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(i,null,2)}\n        `)}const r=xe["filter_"+e],o=jn(n,r);let a=null;if("error"===o.result)throw new Error(o.value.map(t=>`${t.key}: ${t.message}`).join(", "));a=(t,e,i)=>o.value.evaluate(t,e,{},i);let s=null,l=null;if(n!==i){const t=jn(i,r);if("error"===t.result)throw new Error(t.value.map(t=>`${t.key}: ${t.message}`).join(", "));s=(e,i,n,r,o)=>t.value.evaluate(e,i,{},n,void 0,void 0,r,o),l=!Li(t.value.expression)}return a=a,{filter:a,dynamicFilter:s||void 0,needGeometry:ir(n),needFeature:!!l}}function Qn(t){if(!Array.isArray(t))return!1;if("pitch"===(e=t[0])||"distance-from-center"===e)return!0;var e;for(let e=1;e<t.length;e++)if(Qn(t[e]))return!0;return!1}const tr=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function er(t,e){return t<e?-1:t>e?1:0}function ir(t){if(!Array.isArray(t))return!1;if("within"===t[0])return!0;for(let e=1;e<t.length;e++)if(ir(t[e]))return!0;return!1}function nr(t){if(!t)return!0;const e=t[0];return t.length<=1?"any"!==e:"=="===e?rr(t[1],t[2],"=="):"!="===e?sr(rr(t[1],t[2],"==")):"<"===e||">"===e||"<="===e||">="===e?rr(t[1],t[2],e):"any"===e?(i=t.slice(1),["any"].concat(i.map(nr))):"all"===e?["all"].concat(t.slice(1).map(nr)):"none"===e?["all"].concat(t.slice(1).map(nr).map(sr)):"in"===e?or(t[1],t.slice(2)):"!in"===e?sr(or(t[1],t.slice(2))):"has"===e?ar(t[1]):"!has"===e?sr(ar(t[1])):"within"!==e||t;var i}function rr(t,e,i){switch(t){case"$type":return["filter-type-"+i,e];case"$id":return["filter-id-"+i,e];default:return["filter-"+i,t,e]}}function or(t,e){if(0===e.length)return!1;switch(t){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(t=>typeof t!=typeof e[0])?["filter-in-large",t,["literal",e.sort(er)]]:["filter-in-small",t,["literal",e]]}}function ar(t){switch(t){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",t]}}function sr(t){return["!",t]}function lr(t){if(Jn(Se(t.value))){const e=Se(t.layerType);return Yn(Me({},t,{expressionContext:"filter",valueSpec:t.styleSpec["filter_"+(e||"fill")]}))}return function t(e){const i=e.value,n=e.key;if("array"!==Ln(i))return[new be(n,i,`array expected, ${Ln(i)} found`)];const r=e.styleSpec;let o,a=[];if(i.length<1)return[new be(n,i,"filter array must have at least 1 element")];switch(a=a.concat($n({key:n+"[0]",value:i[0],valueSpec:r.filter_operator,style:e.style,styleSpec:e.styleSpec})),Te(i[0])){case"<":case"<=":case">":case">=":i.length>=2&&"$type"===Te(i[1])&&a.push(new be(n,i,`"$type" cannot be use with operator "${i[0]}"`));case"==":case"!=":3!==i.length&&a.push(new be(n,i,`filter array for operator "${i[0]}" must have 3 elements`));case"in":case"!in":i.length>=2&&(o=Ln(i[1]),"string"!==o&&a.push(new be(n+"[1]",i[1],`string expected, ${o} found`)));for(let t=2;t<i.length;t++)o=Ln(i[t]),"$type"===Te(i[1])?a=a.concat($n({key:`${n}[${t}]`,value:i[t],valueSpec:r.geometry_type,style:e.style,styleSpec:e.styleSpec})):"string"!==o&&"number"!==o&&"boolean"!==o&&a.push(new be(`${n}[${t}]`,i[t],`string, number, or boolean expected, ${o} found`));break;case"any":case"all":case"none":for(let r=1;r<i.length;r++)a=a.concat(t({key:`${n}[${r}]`,value:i[r],style:e.style,styleSpec:e.styleSpec}));break;case"has":case"!has":o=Ln(i[1]),2!==i.length?a.push(new be(n,i,`filter array for "${i[0]}" operator must have 2 elements`)):"string"!==o&&a.push(new be(n+"[1]",i[1],`string expected, ${o} found`));break;case"within":o=Ln(i[1]),2!==i.length?a.push(new be(n,i,`filter array for "${i[0]}" operator must have 2 elements`)):"object"!==o&&a.push(new be(n+"[1]",i[1],`object expected, ${o} found`))}return a}(t)}function cr(t,e){const i=t.key,n=t.style,r=t.styleSpec,o=t.value,a=t.objectKey,s=r[`${e}_${t.layerType}`];if(!s)return[];const l=a.match(/^(.*)-transition$/);if("paint"===e&&l&&s[l[1]]&&s[l[1]].transition)return xr({key:i,value:o,valueSpec:r.transition,style:n,styleSpec:r});const c=t.valueSpec||s[a];if(!c)return[new be(i,o,`unknown property "${a}"`)];let h;if("string"===Ln(o)&&Cn(c)&&!c.tokens&&(h=/^{([^}]+)}$/.exec(o)))return[new be(i,o,`"${a}" does not support interpolation syntax\nUse an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(h[1])} }\`.`)];const u=[];return"symbol"===t.layerType&&("text-field"===a&&n&&!n.glyphs&&u.push(new be(i,o,'use of "text-field" requires a style "glyphs" property')),"text-font"===a&&In(Se(o))&&"identity"===Te(o.type)&&u.push(new be(i,o,'"text-font" does not support identity functions'))),u.concat(xr({key:t.key,value:o,valueSpec:c,style:n,styleSpec:r,expressionContext:"property",propertyType:e,propertyKey:a}))}function hr(t){return cr(t,"paint")}function ur(t){return cr(t,"layout")}function dr(t){let e=[];const i=t.value,n=t.key,r=t.style,o=t.styleSpec;i.type||i.ref||e.push(new be(n,i,'either "type" or "ref" is required'));let a=Te(i.type);const s=Te(i.ref);if(i.id){const o=Te(i.id);for(let a=0;a<t.arrayIndex;a++){const t=r.layers[a];Te(t.id)===o&&e.push(new be(n,i.id,`duplicate layer id "${i.id}", previously used at line ${t.id.__line__}`))}}if("ref"in i){let t;["type","source","source-layer","filter","layout"].forEach(t=>{t in i&&e.push(new be(n,i[t],`"${t}" is prohibited for ref layers`))}),r.layers.forEach(e=>{Te(e.id)===s&&(t=e)}),t?t.ref?e.push(new be(n,i.ref,"ref cannot reference another ref layer")):a=Te(t.type):e.push(new be(n,i.ref,`ref layer "${s}" not found`))}else if("background"!==a&&"sky"!==a)if(i.source){const t=r.sources&&r.sources[i.source],o=t&&Te(t.type);t?"vector"===o&&"raster"===a?e.push(new be(n,i.source,`layer "${i.id}" requires a raster source`)):"raster"===o&&"raster"!==a?e.push(new be(n,i.source,`layer "${i.id}" requires a vector source`)):"vector"!==o||i["source-layer"]?"raster-dem"===o&&"hillshade"!==a?e.push(new be(n,i.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==a||!i.paint||!i.paint["line-gradient"]||"geojson"===o&&t.lineMetrics||e.push(new be(n,i,`layer "${i.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new be(n,i,`layer "${i.id}" must specify a "source-layer"`)):e.push(new be(n,i.source,`source "${i.source}" not found`))}else e.push(new be(n,i,'missing required property "source"'));return e=e.concat(Zn({key:n,value:i,valueSpec:o.layer,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":()=>[],type:()=>xr({key:n+".type",value:i.type,valueSpec:o.layer.type,style:t.style,styleSpec:t.styleSpec,object:i,objectKey:"type"}),filter:t=>lr(Me({layerType:a},t)),layout:t=>Zn({layer:i,key:t.key,value:t.value,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":t=>ur(Me({layerType:a},t))}}),paint:t=>Zn({layer:i,key:t.key,value:t.value,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":t=>hr(Me({layerType:a},t))}})}})),e}function pr(t){const e=t.value,i=t.key,n=Ln(e);return"string"!==n?[new be(i,e,`string expected, ${n} found`)]:[]}const fr={promoteId:function({key:t,value:e}){if("string"===Ln(e))return pr({key:t,value:e});{const i=[];for(const n in e)i.push(...pr({key:`${t}.${n}`,value:e[n]}));return i}}};function mr(t){const e=t.value,i=t.key,n=t.styleSpec,r=t.style;if(!e.type)return[new be(i,e,'"type" is required')];const o=Te(e.type);let a;switch(o){case"vector":case"raster":case"raster-dem":return a=Zn({key:i,value:e,valueSpec:n["source_"+o.replace("-","_")],style:t.style,styleSpec:n,objectElementValidators:fr}),a;case"geojson":if(a=Zn({key:i,value:e,valueSpec:n.source_geojson,style:r,styleSpec:n,objectElementValidators:fr}),e.cluster)for(const t in e.clusterProperties){const[n,r]=e.clusterProperties[t],o="string"==typeof n?[n,["accumulated"],["get",t]]:n;a.push(...Yn({key:`${i}.${t}.map`,value:r,expressionContext:"cluster-map"})),a.push(...Yn({key:`${i}.${t}.reduce`,value:o,expressionContext:"cluster-reduce"}))}return a;case"video":return Zn({key:i,value:e,valueSpec:n.source_video,style:r,styleSpec:n});case"image":return Zn({key:i,value:e,valueSpec:n.source_image,style:r,styleSpec:n});case"canvas":return[new be(i,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return $n({key:i+".type",value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:r,styleSpec:n})}}function gr(t){const e=t.value,i=t.styleSpec,n=i.light,r=t.style;let o=[];const a=Ln(e);if(void 0===e)return o;if("object"!==a)return o=o.concat([new be("light",e,`object expected, ${a} found`)]),o;for(const t in e){const a=t.match(/^(.*)-transition$/);o=o.concat(a&&n[a[1]]&&n[a[1]].transition?xr({key:t,value:e[t],valueSpec:i.transition,style:r,styleSpec:i}):n[t]?xr({key:t,value:e[t],valueSpec:n[t],style:r,styleSpec:i}):[new be(t,e[t],`unknown property "${t}"`)])}return o}function yr(t){const e=t.value,i=t.key,n=t.style,r=t.styleSpec,o=r.terrain;let a=[];const s=Ln(e);if(void 0===e)return a;if("object"!==s)return a=a.concat([new be("terrain",e,`object expected, ${s} found`)]),a;for(const t in e){const i=t.match(/^(.*)-transition$/);a=a.concat(i&&o[i[1]]&&o[i[1]].transition?xr({key:t,value:e[t],valueSpec:r.transition,style:n,styleSpec:r}):o[t]?xr({key:t,value:e[t],valueSpec:o[t],style:n,styleSpec:r}):[new be(t,e[t],`unknown property "${t}"`)])}if(e.source){const t=n.sources&&n.sources[e.source],r=t&&Te(t.type);t?"raster-dem"!==r&&a.push(new be(i,e.source,`terrain cannot be used with a source of type ${r}, it only be used with a "raster-dem" source type`)):a.push(new be(i,e.source,`source "${e.source}" not found`))}else a.push(new be(i,e,'terrain is missing required property "source"'));return a}function _r(t){const e=t.value,i=t.style,n=t.styleSpec,r=n.fog;let o=[];const a=Ln(e);if(void 0===e)return o;if("object"!==a)return o=o.concat([new be("fog",e,`object expected, ${a} found`)]),o;for(const t in e){const a=t.match(/^(.*)-transition$/);o=o.concat(a&&r[a[1]]&&r[a[1]].transition?xr({key:t,value:e[t],valueSpec:n.transition,style:i,styleSpec:n}):r[t]?xr({key:t,value:e[t],valueSpec:r[t],style:i,styleSpec:n}):[new be(t,e[t],`unknown property "${t}"`)])}return o}const vr={"*":()=>[],array:Wn,boolean:function(t){const e=t.value,i=t.key,n=Ln(e);return"boolean"!==n?[new be(i,e,`boolean expected, ${n} found`)]:[]},number:qn,color:function(t){const e=t.key,i=t.value,n=Ln(i);return"string"!==n?[new be(e,i,`color expected, ${n} found`)]:null===Ze.parseCSSColor(i)?[new be(e,i,`color expected, "${i}" found`)]:[]},constants:we,enum:$n,filter:lr,function:Xn,layer:dr,object:Zn,source:mr,light:gr,terrain:yr,fog:_r,string:pr,formatted:function(t){return 0===pr(t).length?[]:Yn(t)},resolvedImage:function(t){return 0===pr(t).length?[]:Yn(t)},projection:function(t){const e=t.value,i=t.styleSpec,n=i.projection,r=t.style;let o=[];const a=Ln(e);if("object"===a)for(const t in e)o=o.concat(xr({key:t,value:e[t],valueSpec:n[t],style:r,styleSpec:i}));else"string"!==a&&(o=o.concat([new be("projection",e,`object or string expected, ${a} found`)]));return o}};function xr(t){const e=t.value,i=t.valueSpec,n=t.styleSpec;return i.expression&&In(Te(e))?Xn(t):i.expression&&Nn(Se(e))?Yn(t):i.type&&vr[i.type]?vr[i.type](t):Zn(Me({},t,{valueSpec:i.type?n[i.type]:i}))}function br(t){const e=t.value,i=t.key,n=pr(t);return n.length||(-1===e.indexOf("{fontstack}")&&n.push(new be(i,e,'"glyphs" url must include a "{fontstack}" token')),-1===e.indexOf("{range}")&&n.push(new be(i,e,'"glyphs" url must include a "{range}" token'))),n}function wr(t,e=xe){let i=[];return i=i.concat(xr({key:"",value:t,valueSpec:e.$root,styleSpec:e,style:t,objectElementValidators:{glyphs:br,"*":()=>[]}})),t.constants&&(i=i.concat(we({key:"constants",value:t.constants,style:t,styleSpec:e}))),Mr(i)}function Mr(t){return[].concat(t).sort((t,e)=>t.line-e.line)}function Tr(t){return function(...e){return Mr(t.apply(this,e))}}wr.source=Tr(mr),wr.light=Tr(gr),wr.terrain=Tr(yr),wr.fog=Tr(_r),wr.layer=Tr(dr),wr.filter=Tr(lr),wr.paintProperty=Tr(hr),wr.layoutProperty=Tr(ur);const Sr=wr,Er=Sr.light,Cr=Sr.fog,Ar=Sr.paintProperty,Pr=Sr.layoutProperty;function Lr(t,e){let i=!1;if(e&&e.length)for(const n of e)t.fire(new _e(new Error(n.message))),i=!0;return i}var Ir=Rr;function Rr(t,e,i){var n=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;var r=new Int32Array(this.arrayBuffer);t=r[0],this.d=(e=r[1])+2*(i=r[2]);for(var o=0;o<this.d*this.d;o++){var a=r[3+o],s=r[3+o+1];n.push(a===s?null:r.subarray(a,s))}var l=r[3+n.length+1];this.keys=r.subarray(r[3+n.length],l),this.bboxes=r.subarray(l),this.insert=this._insertReadonly}else{this.d=e+2*i;for(var c=0;c<this.d*this.d;c++)n.push([]);this.keys=[],this.bboxes=[]}this.n=e,this.extent=t,this.padding=i,this.scale=e/t,this.uid=0;var h=i/e*t;this.min=-h,this.max=t+h}Rr.prototype.insert=function(t,e,i,n,r){this._forEachCell(e,i,n,r,this._insertCell,this.uid++),this.keys.push(t),this.bboxes.push(e),this.bboxes.push(i),this.bboxes.push(n),this.bboxes.push(r)},Rr.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Rr.prototype._insertCell=function(t,e,i,n,r,o){this.cells[r].push(o)},Rr.prototype.query=function(t,e,i,n,r){var o=this.min,a=this.max;if(t<=o&&e<=o&&a<=i&&a<=n&&!r)return Array.prototype.slice.call(this.keys);var s=[];return this._forEachCell(t,e,i,n,this._queryCell,s,{},r),s},Rr.prototype._queryCell=function(t,e,i,n,r,o,a,s){var l=this.cells[r];if(null!==l)for(var c=this.keys,h=this.bboxes,u=0;u<l.length;u++){var d=l[u];if(void 0===a[d]){var p=4*d;(s?s(h[p+0],h[p+1],h[p+2],h[p+3]):t<=h[p+2]&&e<=h[p+3]&&i>=h[p+0]&&n>=h[p+1])?(a[d]=!0,o.push(c[d])):a[d]=!1}}},Rr.prototype._forEachCell=function(t,e,i,n,r,o,a,s){for(var l=this._convertToCellCoord(t),c=this._convertToCellCoord(e),h=this._convertToCellCoord(i),u=this._convertToCellCoord(n),d=l;d<=h;d++)for(var p=c;p<=u;p++){var f=this.d*p+d;if((!s||s(this._convertFromCellCoord(d),this._convertFromCellCoord(p),this._convertFromCellCoord(d+1),this._convertFromCellCoord(p+1)))&&r.call(this,t,e,i,n,f,o,a,s))return}},Rr.prototype._convertFromCellCoord=function(t){return(t-this.padding)/this.scale},Rr.prototype._convertToCellCoord=function(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))},Rr.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var t=this.cells,e=3+this.cells.length+1+1,i=0,n=0;n<this.cells.length;n++)i+=this.cells[n].length;var r=new Int32Array(e+i+this.keys.length+this.bboxes.length);r[0]=this.extent,r[1]=this.n,r[2]=this.padding;for(var o=e,a=0;a<t.length;a++){var s=t[a];r[3+a]=o,r.set(s,o),o+=s.length}return r[3+t.length]=o,r.set(this.keys,o),r[3+t.length+1]=o+=this.keys.length,r.set(this.bboxes,o),o+=this.bboxes.length,r.buffer};const{ImageData:Dr,ImageBitmap:kr}=s,Or={};function zr(t,e,i={}){Object.defineProperty(e,"_classRegistryKey",{value:t,writeable:!1}),Or[t]={klass:e,omit:i.omit||[],shallow:i.shallow||[]}}zr("Object",Object),Ir.serialize=function(t,e){const i=t.toArrayBuffer();return e&&e.push(i),{buffer:i}},Ir.deserialize=function(t){return new Ir(t.buffer)},zr("Grid",Ir),zr("Color",We),zr("Error",Error),zr("ResolvedImage",$e),zr("StylePropertyFunction",Hn),zr("StyleExpression",Fn,{omit:["_evaluator"]}),zr("ZoomDependentExpression",Un),zr("ZoomConstantExpression",Gn),zr("CompoundExpression",ui,{omit:["_evaluate"]});for(const t in xn)xn[t]._classRegistryKey||zr("Expression_"+t,xn[t]);function Br(t){return t&&"undefined"!=typeof ArrayBuffer&&(t instanceof ArrayBuffer||t.constructor&&"ArrayBuffer"===t.constructor.name)}function Fr(t){return kr&&t instanceof kr}function Nr(t,e){if(null==t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp)return t;if(Br(t)||Fr(t))return e&&e.push(t),t;if(ArrayBuffer.isView(t)){const i=t;return e&&e.push(i.buffer),i}if(t instanceof Dr)return e&&e.push(t.data.buffer),t;if(Array.isArray(t)){const i=[];for(const n of t)i.push(Nr(n,e));return i}if("object"==typeof t){const i=t.constructor,n=i._classRegistryKey;if(!n)throw new Error("can't serialize object of unregistered class");const r=i.serialize?i.serialize(t,e):{};if(!i.serialize){for(const i in t){if(!t.hasOwnProperty(i))continue;if(Or[n].omit.indexOf(i)>=0)continue;const o=t[i];r[i]=Or[n].shallow.indexOf(i)>=0?o:Nr(o,e)}t instanceof Error&&(r.message=t.message)}if(r.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==n&&(r.$name=n),r}throw new Error("can't serialize object of type "+typeof t)}function jr(t){if(null==t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp||Br(t)||Fr(t)||ArrayBuffer.isView(t)||t instanceof Dr)return t;if(Array.isArray(t))return t.map(jr);if("object"==typeof t){const e=t.$name||"Object",{klass:i}=Or[e];if(!i)throw new Error("can't deserialize unregistered class "+e);if(i.deserialize)return i.deserialize(t);const n=Object.create(i.prototype);for(const i of Object.keys(t)){if("$name"===i)continue;const r=t[i];n[i]=Or[e].shallow.indexOf(i)>=0?r:jr(r)}return n}throw new Error("can't deserialize object of type "+typeof t)}class Gr{constructor(){this.first=!0}update(t,e){const i=Math.floor(t);return this.first?(this.first=!1,this.lastIntegerZoom=i,this.lastIntegerZoomTime=0,this.lastZoom=t,this.lastFloorZoom=i,!0):(this.lastFloorZoom>i?(this.lastIntegerZoom=i+1,this.lastIntegerZoomTime=e):this.lastFloorZoom<i&&(this.lastIntegerZoom=i,this.lastIntegerZoomTime=e),t!==this.lastZoom&&(this.lastZoom=t,this.lastFloorZoom=i,!0))}}const Ur=t=>t>=1536&&t<=1791,Vr=t=>t>=1872&&t<=1919,Hr=t=>t>=2208&&t<=2303,Zr=t=>t>=11904&&t<=12031,Wr=t=>t>=12032&&t<=12255,qr=t=>t>=12272&&t<=12287,Xr=t=>t>=12288&&t<=12351,Yr=t=>t>=12352&&t<=12447,$r=t=>t>=12448&&t<=12543,Jr=t=>t>=12544&&t<=12591,Kr=t=>t>=12704&&t<=12735,Qr=t=>t>=12736&&t<=12783,to=t=>t>=12784&&t<=12799,eo=t=>t>=12800&&t<=13055,io=t=>t>=13056&&t<=13311,no=t=>t>=13312&&t<=19903,ro=t=>t>=19968&&t<=40959,oo=t=>t>=40960&&t<=42127,ao=t=>t>=42128&&t<=42191,so=t=>t>=44032&&t<=55215,lo=t=>t>=63744&&t<=64255,co=t=>t>=64336&&t<=65023,ho=t=>t>=65040&&t<=65055,uo=t=>t>=65072&&t<=65103,po=t=>t>=65104&&t<=65135,fo=t=>t>=65136&&t<=65279,mo=t=>t>=65280&&t<=65519;function go(t){for(const e of t)if(vo(e.charCodeAt(0)))return!0;return!1}function yo(t){for(const e of t)if(!_o(e.charCodeAt(0)))return!1;return!0}function _o(t){return!(Ur(t)||Vr(t)||Hr(t)||co(t)||fo(t))}function vo(t){return!(746!==t&&747!==t&&(t<4352||!(Kr(t)||Jr(t)||uo(t)&&!(t>=65097&&t<=65103)||lo(t)||io(t)||Zr(t)||Qr(t)||!(!Xr(t)||t>=12296&&t<=12305||t>=12308&&t<=12319||12336===t)||no(t)||ro(t)||eo(t)||(t=>t>=12592&&t<=12687)(t)||(t=>t>=43360&&t<=43391)(t)||(t=>t>=55216&&t<=55295)(t)||(t=>t>=4352&&t<=4607)(t)||so(t)||Yr(t)||qr(t)||(t=>t>=12688&&t<=12703)(t)||Wr(t)||to(t)||$r(t)&&12540!==t||!(!mo(t)||65288===t||65289===t||65293===t||t>=65306&&t<=65310||65339===t||65341===t||65343===t||t>=65371&&t<=65503||65507===t||t>=65512&&t<=65519)||!(!po(t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||(t=>t>=5120&&t<=5759)(t)||(t=>t>=6320&&t<=6399)(t)||ho(t)||(t=>t>=19904&&t<=19967)(t)||oo(t)||ao(t))))}function xo(t){return!(vo(t)||function(t){return!!((t=>t>=128&&t<=255)(t)&&(167===t||169===t||174===t||177===t||188===t||189===t||190===t||215===t||247===t)||(t=>t>=8192&&t<=8303)(t)&&(8214===t||8224===t||8225===t||8240===t||8241===t||8251===t||8252===t||8258===t||8263===t||8264===t||8265===t||8273===t)||(t=>t>=8448&&t<=8527)(t)||(t=>t>=8528&&t<=8591)(t)||(t=>t>=8960&&t<=9215)(t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9114||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215)||(t=>t>=9216&&t<=9279)(t)&&9251!==t||(t=>t>=9280&&t<=9311)(t)||(t=>t>=9312&&t<=9471)(t)||(t=>t>=9632&&t<=9727)(t)||(t=>t>=9728&&t<=9983)(t)&&!(t>=9754&&t<=9759)||(t=>t>=11008&&t<=11263)(t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||Xr(t)||$r(t)||(t=>t>=57344&&t<=63743)(t)||uo(t)||po(t)||mo(t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t)}(t))}function bo(t){return t>=1424&&t<=2303||co(t)||fo(t)}function wo(t,e){return!(!e&&bo(t)||t>=2304&&t<=3583||t>=3840&&t<=4255||(t=>t>=6016&&t<=6143)(t))}function Mo(t){for(const e of t)if(bo(e.charCodeAt(0)))return!0;return!1}const To="deferred",So="loading",Eo="loaded";let Co=null,Ao="unavailable",Po=null;const Lo=function(t){t&&"string"==typeof t&&t.indexOf("NetworkError")>-1&&(Ao="error"),Co&&Co(t)};function Io(){Ro.fire(new ye("pluginStateChange",{pluginStatus:Ao,pluginURL:Po}))}const Ro=new ve,Do=function(){return Ao},ko=function(){if(Ao!==To||!Po)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Ao=So,Io(),Po&&se({url:Po},t=>{t?Lo(t):(Ao=Eo,Io())})},Oo={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Ao===Eo||null!=Oo.applyArabicShaping,isLoading:()=>Ao===So,setState(t){Ao=t.pluginStatus,Po=t.pluginURL},isParsed:()=>null!=Oo.applyArabicShaping&&null!=Oo.processBidirectionalText&&null!=Oo.processStyledBidirectionalText,getPluginURL:()=>Po};class zo{constructor(t,e){this.zoom=t,e?(this.now=e.now,this.fadeDuration=e.fadeDuration,this.zoomHistory=e.zoomHistory,this.transition=e.transition,this.pitch=e.pitch):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Gr,this.transition={},this.pitch=0)}isSupportedScript(t){return function(t,e){for(const i of t)if(!wo(i.charCodeAt(0),e))return!1;return!0}(t,Oo.isLoaded())}crossFadingFactor(){return 0===this.fadeDuration?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const t=this.zoom,e=t-Math.floor(t),i=this.crossFadingFactor();return t>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:e+(1-e)*i}:{fromScale:.5,toScale:1,t:1-(1-i)*e}}}class Bo{constructor(t,e){this.property=t,this.value=e,this.expression=function(t,e){if(In(t))return new Hn(t,e);if(Nn(t)){const i=Vn(t,e);if("error"===i.result)throw new Error(i.value.map(t=>`${t.key}: ${t.message}`).join(", "));return i.value}{let i=t;return"string"==typeof t&&"color"===e.type&&(i=We.parse(t)),{kind:"constant",evaluate:()=>i}}}(void 0===e?t.specification.default:e,t.specification)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(t,e,i){return this.property.possiblyEvaluate(this,t,e,i)}}class Fo{constructor(t){this.property=t,this.value=new Bo(t,void 0)}transitioned(t,e){return new jo(this.property,this.value,e,et({},t.transition,this.transition),t.now)}untransitioned(){return new jo(this.property,this.value,null,{},0)}}class No{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues)}getValue(t){return ut(this._values[t].value.value)}setValue(t,e){this._values.hasOwnProperty(t)||(this._values[t]=new Fo(this._values[t].property)),this._values[t].value=new Bo(this._values[t].property,null===e?void 0:ut(e))}getTransition(t){return ut(this._values[t].transition)}setTransition(t,e){this._values.hasOwnProperty(t)||(this._values[t]=new Fo(this._values[t].property)),this._values[t].transition=ut(e)||void 0}serialize(){const t={};for(const e of Object.keys(this._values)){const i=this.getValue(e);void 0!==i&&(t[e]=i);const n=this.getTransition(e);void 0!==n&&(t[e+"-transition"]=n)}return t}transitioned(t,e){const i=new Go(this._properties);for(const n of Object.keys(this._values))i._values[n]=this._values[n].transitioned(t,e._values[n]);return i}untransitioned(){const t=new Go(this._properties);for(const e of Object.keys(this._values))t._values[e]=this._values[e].untransitioned();return t}}class jo{constructor(t,e,i,n,r){const o=n.delay||0,a=n.duration||0;r=r||0,this.property=t,this.value=e,this.begin=r+o,this.end=this.begin+a,t.specification.transition&&(n.delay||n.duration)&&(this.prior=i)}possiblyEvaluate(t,e,i){const n=t.now||0,r=this.value.possiblyEvaluate(t,e,i),o=this.prior;if(o){if(n>this.end)return this.prior=null,r;if(this.value.isDataDriven())return this.prior=null,r;if(n<this.begin)return o.possiblyEvaluate(t,e,i);{const a=(n-this.begin)/(this.end-this.begin);return this.property.interpolate(o.possiblyEvaluate(t,e,i),r,q(a))}}return r}}class Go{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,e,i){const n=new Ho(this._properties);for(const r of Object.keys(this._values))n._values[r]=this._values[r].possiblyEvaluate(t,e,i);return n}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class Uo{constructor(t){this._properties=t,this._values=Object.create(t.defaultPropertyValues)}getValue(t){return ut(this._values[t].value)}setValue(t,e){this._values[t]=new Bo(this._values[t].property,null===e?void 0:ut(e))}serialize(){const t={};for(const e of Object.keys(this._values)){const i=this.getValue(e);void 0!==i&&(t[e]=i)}return t}possiblyEvaluate(t,e,i){const n=new Ho(this._properties);for(const r of Object.keys(this._values))n._values[r]=this._values[r].possiblyEvaluate(t,e,i);return n}}class Vo{constructor(t,e,i){this.property=t,this.value=e,this.parameters=i}isConstant(){return"constant"===this.value.kind}constantOr(t){return"constant"===this.value.kind?this.value.value:t}evaluate(t,e,i,n){return this.property.evaluate(this.value,this.parameters,t,e,i,n)}}class Ho{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class Zo{constructor(t){this.specification=t}possiblyEvaluate(t,e){return t.expression.evaluate(e)}interpolate(t,e,i){const n=Fi[this.specification.type];return n?n(t,e,i):t}}class Wo{constructor(t,e){this.specification=t,this.overrides=e}possiblyEvaluate(t,e,i,n){return new Vo(this,"constant"===t.expression.kind||"camera"===t.expression.kind?{kind:"constant",value:t.expression.evaluate(e,null,{},i,n)}:t.expression,e)}interpolate(t,e,i){if("constant"!==t.value.kind||"constant"!==e.value.kind)return t;if(void 0===t.value.value||void 0===e.value.value)return new Vo(this,{kind:"constant",value:void 0},t.parameters);const n=Fi[this.specification.type];return n?new Vo(this,{kind:"constant",value:n(t.value.value,e.value.value,i)},t.parameters):t}evaluate(t,e,i,n,r,o){return"constant"===t.kind?t.value:t.evaluate(e,i,n,r,o)}}class qo extends Wo{possiblyEvaluate(t,e,i,n){if(void 0===t.value)return new Vo(this,{kind:"constant",value:void 0},e);if("constant"===t.expression.kind){const r=t.expression.evaluate(e,null,{},i,n),o="resolvedImage"===t.property.specification.type&&"string"!=typeof r?r.name:r,a=this._calculate(o,o,o,e);return new Vo(this,{kind:"constant",value:a},e)}if("camera"===t.expression.kind){const i=this._calculate(t.expression.evaluate({zoom:e.zoom-1}),t.expression.evaluate({zoom:e.zoom}),t.expression.evaluate({zoom:e.zoom+1}),e);return new Vo(this,{kind:"constant",value:i},e)}return new Vo(this,t.expression,e)}evaluate(t,e,i,n,r,o){if("source"===t.kind){const a=t.evaluate(e,i,n,r,o);return this._calculate(a,a,a,e)}return"composite"===t.kind?this._calculate(t.evaluate({zoom:Math.floor(e.zoom)-1},i,n),t.evaluate({zoom:Math.floor(e.zoom)},i,n),t.evaluate({zoom:Math.floor(e.zoom)+1},i,n),e):t.value}_calculate(t,e,i,n){return n.zoom>n.zoomHistory.lastIntegerZoom?{from:t,to:e,other:i}:{from:i,to:e,other:t}}interpolate(t){return t}}class Xo{constructor(t){this.specification=t}possiblyEvaluate(t,e,i,n){if(void 0!==t.value){if("constant"===t.expression.kind){const r=t.expression.evaluate(e,null,{},i,n);return this._calculate(r,r,r,e)}return this._calculate(t.expression.evaluate(new zo(Math.floor(e.zoom-1),e)),t.expression.evaluate(new zo(Math.floor(e.zoom),e)),t.expression.evaluate(new zo(Math.floor(e.zoom+1),e)),e)}}_calculate(t,e,i,n){return n.zoom>n.zoomHistory.lastIntegerZoom?{from:t,to:e}:{from:i,to:e}}interpolate(t){return t}}class Yo{constructor(t){this.specification=t}possiblyEvaluate(t,e,i,n){return!!t.expression.evaluate(e,null,{},i,n)}interpolate(){return!1}}class $o{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const e in t){const i=t[e];i.specification.overridable&&this.overridableProperties.push(e);const n=this.defaultPropertyValues[e]=new Bo(i,void 0),r=this.defaultTransitionablePropertyValues[e]=new Fo(i);this.defaultTransitioningPropertyValues[e]=r.untransitioned(),this.defaultPossiblyEvaluatedValues[e]=n.possiblyEvaluate({})}}}function Jo(t,e){return 256*(t=$(Math.floor(t),0,255))+$(Math.floor(e),0,255)}zr("DataDrivenProperty",Wo),zr("DataConstantProperty",Zo),zr("CrossFadedDataDrivenProperty",qo),zr("CrossFadedProperty",Xo),zr("ColorRampProperty",Yo);const Ko={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Qo{constructor(t,e){this._structArray=t,this._pos1=e*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class ta{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,e){return t._trim(),e&&(t.isTransferred=!0,e.push(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const e=Object.create(this.prototype);return e.arrayBuffer=t.arrayBuffer,e.length=t.length,e.capacity=t.arrayBuffer.byteLength/e.bytesPerElement,e._refreshViews(),e}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const e=this.uint8;this._refreshViews(),e&&this.uint8.set(e)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function ea(t,e=1){let i=0,n=0;return{members:t.map(t=>{const r=Ko[t.type].BYTES_PER_ELEMENT,o=i=ia(i,Math.max(e,r)),a=t.components||1;return n=Math.max(n,r),i+=r*a,{name:t.name,type:t.type,components:a,offset:o}}),size:ia(i,Math.max(n,e)),alignment:e}}function ia(t,e){return Math.ceil(t/e)*e}class na extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e){const i=this.length;return this.resize(i+1),this.emplace(i,t,e)}emplace(t,e,i){const n=2*t;return this.int16[n+0]=e,this.int16[n+1]=i,t}}na.prototype.bytesPerElement=4,zr("StructArrayLayout2i4",na);class ra extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,e,i,n)}emplace(t,e,i,n,r){const o=4*t;return this.int16[o+0]=e,this.int16[o+1]=i,this.int16[o+2]=n,this.int16[o+3]=r,t}}ra.prototype.bytesPerElement=8,zr("StructArrayLayout4i8",ra);class oa extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,o,a){const s=this.length;return this.resize(s+1),this.emplace(s,t,e,i,n,r,o,a)}emplace(t,e,i,n,r,o,a,s){const l=6*t,c=12*t,h=3*t;return this.int16[l+0]=e,this.int16[l+1]=i,this.uint8[c+4]=n,this.uint8[c+5]=r,this.uint8[c+6]=o,this.uint8[c+7]=a,this.float32[h+2]=s,t}}oa.prototype.bytesPerElement=12,zr("StructArrayLayout2i4ub1f12",oa);class aa extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i){const n=this.length;return this.resize(n+1),this.emplace(n,t,e,i)}emplace(t,e,i,n){const r=3*t;return this.float32[r+0]=e,this.float32[r+1]=i,this.float32[r+2]=n,t}}aa.prototype.bytesPerElement=12,zr("StructArrayLayout3f12",aa);class sa extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,o,a,s,l,c){const h=this.length;return this.resize(h+1),this.emplace(h,t,e,i,n,r,o,a,s,l,c)}emplace(t,e,i,n,r,o,a,s,l,c,h){const u=10*t;return this.uint16[u+0]=e,this.uint16[u+1]=i,this.uint16[u+2]=n,this.uint16[u+3]=r,this.uint16[u+4]=o,this.uint16[u+5]=a,this.uint16[u+6]=s,this.uint16[u+7]=l,this.uint16[u+8]=c,this.uint16[u+9]=h,t}}sa.prototype.bytesPerElement=20,zr("StructArrayLayout10ui20",sa);class la extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,o,a,s){const l=this.length;return this.resize(l+1),this.emplace(l,t,e,i,n,r,o,a,s)}emplace(t,e,i,n,r,o,a,s,l){const c=8*t;return this.uint16[c+0]=e,this.uint16[c+1]=i,this.uint16[c+2]=n,this.uint16[c+3]=r,this.uint16[c+4]=o,this.uint16[c+5]=a,this.uint16[c+6]=s,this.uint16[c+7]=l,t}}la.prototype.bytesPerElement=16,zr("StructArrayLayout8ui16",la);class ca extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m){const g=this.length;return this.resize(g+1),this.emplace(g,t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m)}emplace(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g){const y=16*t;return this.int16[y+0]=e,this.int16[y+1]=i,this.int16[y+2]=n,this.int16[y+3]=r,this.uint16[y+4]=o,this.uint16[y+5]=a,this.uint16[y+6]=s,this.uint16[y+7]=l,this.int16[y+8]=c,this.int16[y+9]=h,this.int16[y+10]=u,this.int16[y+11]=d,this.int16[y+12]=p,this.int16[y+13]=f,this.int16[y+14]=m,this.int16[y+15]=g,t}}ca.prototype.bytesPerElement=32,zr("StructArrayLayout4i4ui4i4i32",ca);class ha extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const e=this.length;return this.resize(e+1),this.emplace(e,t)}emplace(t,e){return this.uint32[1*t+0]=e,t}}ha.prototype.bytesPerElement=4,zr("StructArrayLayout1ul4",ha);class ua extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,o,a,s,l,c,h,u,d){const p=this.length;return this.resize(p+1),this.emplace(p,t,e,i,n,r,o,a,s,l,c,h,u,d)}emplace(t,e,i,n,r,o,a,s,l,c,h,u,d,p){const f=20*t,m=10*t;return this.int16[f+0]=e,this.int16[f+1]=i,this.int16[f+2]=n,this.int16[f+3]=r,this.int16[f+4]=o,this.float32[m+3]=a,this.float32[m+4]=s,this.float32[m+5]=l,this.float32[m+6]=c,this.int16[f+14]=h,this.uint32[m+8]=u,this.uint16[f+18]=d,this.uint16[f+19]=p,t}}ua.prototype.bytesPerElement=40,zr("StructArrayLayout5i4f1i1ul2ui40",ua);class da extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,o,a){const s=this.length;return this.resize(s+1),this.emplace(s,t,e,i,n,r,o,a)}emplace(t,e,i,n,r,o,a,s){const l=8*t;return this.int16[l+0]=e,this.int16[l+1]=i,this.int16[l+2]=n,this.int16[l+4]=r,this.int16[l+5]=o,this.int16[l+6]=a,this.int16[l+7]=s,t}}da.prototype.bytesPerElement=16,zr("StructArrayLayout3i2i2i16",da);class pa extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,e,i,n,r)}emplace(t,e,i,n,r,o){const a=4*t,s=8*t;return this.float32[a+0]=e,this.float32[a+1]=i,this.float32[a+2]=n,this.int16[s+6]=r,this.int16[s+7]=o,t}}pa.prototype.bytesPerElement=16,zr("StructArrayLayout2f1f2i16",pa);class fa extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,e,i,n)}emplace(t,e,i,n,r){const o=12*t,a=3*t;return this.uint8[o+0]=e,this.uint8[o+1]=i,this.float32[a+1]=n,this.float32[a+2]=r,t}}fa.prototype.bytesPerElement=12,zr("StructArrayLayout2ub2f12",fa);class ma extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i){const n=this.length;return this.resize(n+1),this.emplace(n,t,e,i)}emplace(t,e,i,n){const r=3*t;return this.uint16[r+0]=e,this.uint16[r+1]=i,this.uint16[r+2]=n,t}}ma.prototype.bytesPerElement=6,zr("StructArrayLayout3ui6",ma);class ga extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y,_,v,x){const b=this.length;return this.resize(b+1),this.emplace(b,t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y,_,v,x)}emplace(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y,_,v,x,b){const w=30*t,M=15*t,T=60*t;return this.int16[w+0]=e,this.int16[w+1]=i,this.int16[w+2]=n,this.float32[M+2]=r,this.float32[M+3]=o,this.uint16[w+8]=a,this.uint16[w+9]=s,this.uint32[M+5]=l,this.uint32[M+6]=c,this.uint32[M+7]=h,this.uint16[w+16]=u,this.uint16[w+17]=d,this.uint16[w+18]=p,this.float32[M+10]=f,this.float32[M+11]=m,this.uint8[T+48]=g,this.uint8[T+49]=y,this.uint8[T+50]=_,this.uint32[M+13]=v,this.int16[w+28]=x,this.uint8[T+58]=b,t}}ga.prototype.bytesPerElement=60,zr("StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60",ga);class ya extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y,_,v,x,b,w,M,T,S,E,C,A,P){const L=this.length;return this.resize(L+1),this.emplace(L,t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y,_,v,x,b,w,M,T,S,E,C,A,P)}emplace(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y,_,v,x,b,w,M,T,S,E,C,A,P,L){const I=38*t,R=19*t;return this.int16[I+0]=e,this.int16[I+1]=i,this.int16[I+2]=n,this.float32[R+2]=r,this.float32[R+3]=o,this.int16[I+8]=a,this.int16[I+9]=s,this.int16[I+10]=l,this.int16[I+11]=c,this.int16[I+12]=h,this.int16[I+13]=u,this.uint16[I+14]=d,this.uint16[I+15]=p,this.uint16[I+16]=f,this.uint16[I+17]=m,this.uint16[I+18]=g,this.uint16[I+19]=y,this.uint16[I+20]=_,this.uint16[I+21]=v,this.uint16[I+22]=x,this.uint16[I+23]=b,this.uint16[I+24]=w,this.uint16[I+25]=M,this.uint16[I+26]=T,this.uint16[I+27]=S,this.uint16[I+28]=E,this.uint32[R+15]=C,this.float32[R+16]=A,this.float32[R+17]=P,this.float32[R+18]=L,t}}ya.prototype.bytesPerElement=76,zr("StructArrayLayout3i2f6i15ui1ul3f76",ya);class _a extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const e=this.length;return this.resize(e+1),this.emplace(e,t)}emplace(t,e){return this.float32[1*t+0]=e,t}}_a.prototype.bytesPerElement=4,zr("StructArrayLayout1f4",_a);class va extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e,i){const n=this.length;return this.resize(n+1),this.emplace(n,t,e,i)}emplace(t,e,i,n){const r=3*t;return this.int16[r+0]=e,this.int16[r+1]=i,this.int16[r+2]=n,t}}va.prototype.bytesPerElement=6,zr("StructArrayLayout3i6",va);class xa extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,o,a){const s=this.length;return this.resize(s+1),this.emplace(s,t,e,i,n,r,o,a)}emplace(t,e,i,n,r,o,a,s){const l=7*t;return this.float32[l+0]=e,this.float32[l+1]=i,this.float32[l+2]=n,this.float32[l+3]=r,this.float32[l+4]=o,this.float32[l+5]=a,this.float32[l+6]=s,t}}xa.prototype.bytesPerElement=28,zr("StructArrayLayout7f28",xa);class ba extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,e,i,n)}emplace(t,e,i,n,r){const o=6*t;return this.uint32[3*t+0]=e,this.uint16[o+2]=i,this.uint16[o+3]=n,this.uint16[o+4]=r,t}}ba.prototype.bytesPerElement=12,zr("StructArrayLayout1ul3ui12",ba);class wa extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e){const i=this.length;return this.resize(i+1),this.emplace(i,t,e)}emplace(t,e,i){const n=2*t;return this.uint16[n+0]=e,this.uint16[n+1]=i,t}}wa.prototype.bytesPerElement=4,zr("StructArrayLayout2ui4",wa);class Ma extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const e=this.length;return this.resize(e+1),this.emplace(e,t)}emplace(t,e){return this.uint16[1*t+0]=e,t}}Ma.prototype.bytesPerElement=2,zr("StructArrayLayout1ui2",Ma);class Ta extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e){const i=this.length;return this.resize(i+1),this.emplace(i,t,e)}emplace(t,e,i){const n=2*t;return this.float32[n+0]=e,this.float32[n+1]=i,t}}Ta.prototype.bytesPerElement=8,zr("StructArrayLayout2f8",Ta);class Sa extends ta{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,e,i,n)}emplace(t,e,i,n,r){const o=4*t;return this.float32[o+0]=e,this.float32[o+1]=i,this.float32[o+2]=n,this.float32[o+3]=r,t}}Sa.prototype.bytesPerElement=16,zr("StructArrayLayout4f16",Sa);class Ea extends Qo{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Ea.prototype.size=40;class Ca extends ua{get(t){return new Ea(this,t)}}zr("CollisionBoxArray",Ca);class Aa extends Qo{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}Aa.prototype.size=60;class Pa extends ga{get(t){return new Aa(this,t)}}zr("PlacedSymbolArray",Pa);class La extends Qo{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(t){this._structArray.uint32[this._pos4+15]=t}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}La.prototype.size=76;class Ia extends ya{get(t){return new La(this,t)}}zr("SymbolInstanceArray",Ia);class Ra extends _a{getoffsetX(t){return this.float32[1*t+0]}}zr("GlyphOffsetArray",Ra);class Da extends va{getx(t){return this.int16[3*t+0]}gety(t){return this.int16[3*t+1]}gettileUnitDistanceFromAnchor(t){return this.int16[3*t+2]}}zr("SymbolLineVertexArray",Da);class ka extends Qo{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}ka.prototype.size=12;class Oa extends ba{get(t){return new ka(this,t)}}zr("FeatureIndexArray",Oa);class za extends Qo{get a_centroid_pos0(){return this._structArray.uint16[this._pos2+0]}get a_centroid_pos1(){return this._structArray.uint16[this._pos2+1]}}za.prototype.size=4;class Ba extends wa{get(t){return new za(this,t)}}zr("FillExtrusionCentroidArray",Ba);const Fa=ea([{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"}]),Na=ea([{name:"a_dash_to",components:4,type:"Uint16"},{name:"a_dash_from",components:4,type:"Uint16"}]);var ja=He((function(t){t.exports=function(t,e){var i,n,r,o,a,s,l,c;for(n=t.length-(i=3&t.length),r=e,a=3432918353,s=461845907,c=0;c<n;)l=255&t.charCodeAt(c)|(255&t.charCodeAt(++c))<<8|(255&t.charCodeAt(++c))<<16|(255&t.charCodeAt(++c))<<24,++c,r=27492+(65535&(o=5*(65535&(r=(r^=l=(65535&(l=(l=(65535&l)*a+(((l>>>16)*a&65535)<<16)&4294967295)<<15|l>>>17))*s+(((l>>>16)*s&65535)<<16)&4294967295)<<13|r>>>19))+((5*(r>>>16)&65535)<<16)&4294967295))+((58964+(o>>>16)&65535)<<16);switch(l=0,i){case 3:l^=(255&t.charCodeAt(c+2))<<16;case 2:l^=(255&t.charCodeAt(c+1))<<8;case 1:r^=l=(65535&(l=(l=(65535&(l^=255&t.charCodeAt(c)))*a+(((l>>>16)*a&65535)<<16)&4294967295)<<15|l>>>17))*s+(((l>>>16)*s&65535)<<16)&4294967295}return r^=t.length,r=2246822507*(65535&(r^=r>>>16))+((2246822507*(r>>>16)&65535)<<16)&4294967295,r=3266489909*(65535&(r^=r>>>13))+((3266489909*(r>>>16)&65535)<<16)&4294967295,(r^=r>>>16)>>>0}})),Ga=He((function(t){t.exports=function(t,e){for(var i,n=t.length,r=e^n,o=0;n>=4;)i=1540483477*(65535&(i=255&t.charCodeAt(o)|(255&t.charCodeAt(++o))<<8|(255&t.charCodeAt(++o))<<16|(255&t.charCodeAt(++o))<<24))+((1540483477*(i>>>16)&65535)<<16),r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16)^(i=1540483477*(65535&(i^=i>>>24))+((1540483477*(i>>>16)&65535)<<16)),n-=4,++o;switch(n){case 3:r^=(255&t.charCodeAt(o+2))<<16;case 2:r^=(255&t.charCodeAt(o+1))<<8;case 1:r=1540483477*(65535&(r^=255&t.charCodeAt(o)))+((1540483477*(r>>>16)&65535)<<16)}return r=1540483477*(65535&(r^=r>>>13))+((1540483477*(r>>>16)&65535)<<16),(r^=r>>>15)>>>0}})),Ua=ja,Va=Ga;Ua.murmur3=ja,Ua.murmur2=Va;class Ha{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(t,e,i,n){this.ids.push(Za(t)),this.positions.push(e,i,n)}getPositions(t){const e=Za(t);let i=0,n=this.ids.length-1;for(;i<n;){const t=i+n>>1;this.ids[t]>=e?n=t:i=t+1}const r=[];for(;this.ids[i]===e;)r.push({index:this.positions[3*i],start:this.positions[3*i+1],end:this.positions[3*i+2]}),i++;return r}static serialize(t,e){const i=new Float64Array(t.ids),n=new Uint32Array(t.positions);return function t(e,i,n,r){for(;n<r;){const o=e[n+r>>1];let a=n-1,s=r+1;for(;;){do{a++}while(e[a]<o);do{s--}while(e[s]>o);if(a>=s)break;Wa(e,a,s),Wa(i,3*a,3*s),Wa(i,3*a+1,3*s+1),Wa(i,3*a+2,3*s+2)}s-n<r-s?(t(e,i,n,s),n=s+1):(t(e,i,s+1,r),r=s)}}(i,n,0,i.length-1),e&&e.push(i.buffer,n.buffer),{ids:i,positions:n}}static deserialize(t){const e=new Ha;return e.ids=t.ids,e.positions=t.positions,e.indexed=!0,e}}function Za(t){const e=+t;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Ua(String(t))}function Wa(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}zr("FeaturePositionMap",Ha);class qa{constructor(t,e){this.gl=t.gl,this.location=e}}class Xa extends qa{constructor(t,e){super(t,e),this.current=0}set(t){this.current!==t&&(this.current=t,this.gl.uniform1f(this.location,t))}}class Ya extends qa{constructor(t,e){super(t,e),this.current=[0,0,0,0]}set(t){t[0]===this.current[0]&&t[1]===this.current[1]&&t[2]===this.current[2]&&t[3]===this.current[3]||(this.current=t,this.gl.uniform4f(this.location,t[0],t[1],t[2],t[3]))}}class $a extends qa{constructor(t,e){super(t,e),this.current=We.transparent}set(t){t.r===this.current.r&&t.g===this.current.g&&t.b===this.current.b&&t.a===this.current.a||(this.current=t,this.gl.uniform4f(this.location,t.r,t.g,t.b,t.a))}}const Ja=new Float32Array(16),Ka=new Float32Array(9),Qa=new Float32Array(4);function ts(t){return[Jo(255*t.r,255*t.g),Jo(255*t.b,255*t.a)]}class es{constructor(t,e,i){this.value=t,this.uniformNames=e.map(t=>"u_"+t),this.type=i}setUniform(t,e,i){t.set(i.constantOr(this.value))}getBinding(t,e,i){return"color"===this.type?new $a(t,e):new Xa(t,e)}}class is{constructor(t,e){this.uniformNames=e.map(t=>"u_"+t),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(t,e){this.pixelRatioFrom=e.pixelRatio,this.pixelRatioTo=t.pixelRatio,this.patternFrom=e.tl.concat(e.br),this.patternTo=t.tl.concat(t.br)}setUniform(t,e,i,n){const r="u_pattern_to"===n||"u_dash_to"===n?this.patternTo:"u_pattern_from"===n||"u_dash_from"===n?this.patternFrom:"u_pixel_ratio_to"===n?this.pixelRatioTo:"u_pixel_ratio_from"===n?this.pixelRatioFrom:null;r&&t.set(r)}getBinding(t,e,i){return"u_pattern_from"===i||"u_pattern_to"===i||"u_dash_from"===i||"u_dash_to"===i?new Ya(t,e):new Xa(t,e)}}class ns{constructor(t,e,i,n){this.expression=t,this.type=i,this.maxValue=0,this.paintVertexAttributes=e.map(t=>({name:"a_"+t,type:"Float32",components:"color"===i?2:1,offset:0})),this.paintVertexArray=new n}populatePaintArray(t,e,i,n,r,o){const a=this.paintVertexArray.length,s=this.expression.evaluate(new zo(0),e,{},r,n,o);this.paintVertexArray.resize(t),this._setPaintValue(a,t,s)}updatePaintArray(t,e,i,n,r){const o=this.expression.evaluate({zoom:0},i,n,void 0,r);this._setPaintValue(t,e,o)}_setPaintValue(t,e,i){if("color"===this.type){const n=ts(i);for(let i=t;i<e;i++)this.paintVertexArray.emplace(i,n[0],n[1])}else{for(let n=t;n<e;n++)this.paintVertexArray.emplace(n,i);this.maxValue=Math.max(this.maxValue,Math.abs(i))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class rs{constructor(t,e,i,n,r,o){this.expression=t,this.uniformNames=e.map(t=>`u_${t}_t`),this.type=i,this.useIntegerZoom=n,this.zoom=r,this.maxValue=0,this.paintVertexAttributes=e.map(t=>({name:"a_"+t,type:"Float32",components:"color"===i?4:2,offset:0})),this.paintVertexArray=new o}populatePaintArray(t,e,i,n,r,o){const a=this.expression.evaluate(new zo(this.zoom),e,{},r,n,o),s=this.expression.evaluate(new zo(this.zoom+1),e,{},r,n,o),l=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(l,t,a,s)}updatePaintArray(t,e,i,n,r){const o=this.expression.evaluate({zoom:this.zoom},i,n,void 0,r),a=this.expression.evaluate({zoom:this.zoom+1},i,n,void 0,r);this._setPaintValue(t,e,o,a)}_setPaintValue(t,e,i,n){if("color"===this.type){const r=ts(i),o=ts(n);for(let i=t;i<e;i++)this.paintVertexArray.emplace(i,r[0],r[1],o[0],o[1])}else{for(let r=t;r<e;r++)this.paintVertexArray.emplace(r,i,n);this.maxValue=Math.max(this.maxValue,Math.abs(i),Math.abs(n))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,e){const i=this.useIntegerZoom?Math.floor(e.zoom):e.zoom,n=$(this.expression.interpolationFactor(i,this.zoom,this.zoom+1),0,1);t.set(n)}getBinding(t,e,i){return new Xa(t,e)}}class os{constructor(t,e,i,n,r,o,a){this.expression=t,this.type=i,this.useIntegerZoom=n,this.zoom=r,this.layerId=a,this.paintVertexAttributes=("array"===i?Na:Fa).members;for(let t=0;t<e.length;++t);this.zoomInPaintVertexArray=new o,this.zoomOutPaintVertexArray=new o}populatePaintArray(t,e,i){const n=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(t),this.zoomOutPaintVertexArray.resize(t),this._setPaintValues(n,t,e.patterns&&e.patterns[this.layerId],i)}updatePaintArray(t,e,i,n,r,o){this._setPaintValues(t,e,i.patterns&&i.patterns[this.layerId],o)}_setPaintValues(t,e,i,n){if(!n||!i)return;const{min:r,mid:o,max:a}=i,s=n[r],l=n[o],c=n[a];if(s&&l&&c)for(let i=t;i<e;i++)this._setPaintValue(this.zoomInPaintVertexArray,i,l,s),this._setPaintValue(this.zoomOutPaintVertexArray,i,l,c)}_setPaintValue(t,e,i,n){t.emplace(e,i.tl[0],i.tl[1],i.br[0],i.br[1],n.tl[0],n.tl[1],n.br[0],n.br[1],i.pixelRatio,n.pixelRatio)}upload(t){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=t.createVertexBuffer(this.zoomInPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=t.createVertexBuffer(this.zoomOutPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class as{constructor(t,e,i=(()=>!0)){this.binders={},this._buffers=[];const n=[];for(const r in t.paint._values){if(!i(r))continue;const o=t.paint.get(r);if(!(o instanceof Vo&&Cn(o.property.specification)))continue;const a=cs(r,t.type),s=o.value,l=o.property.specification.type,c=o.property.useIntegerZoom,h=o.property.specification["property-type"],u="cross-faded"===h||"cross-faded-data-driven"===h,d="line-dasharray"===String(r)&&"constant"!==t.layout.get("line-cap").value.kind;if("constant"!==s.kind||d)if("source"===s.kind||d||u){const i=ds(r,l,"source");this.binders[r]=u?new os(s,a,l,c,e,i,t.id):new ns(s,a,l,i),n.push("/a_"+r)}else{const t=ds(r,l,"composite");this.binders[r]=new rs(s,a,l,c,e,t),n.push("/z_"+r)}else this.binders[r]=u?new is(s.value,a):new es(s.value,a,l),n.push("/u_"+r)}this.cacheKey=n.sort().join("")}getMaxValue(t){const e=this.binders[t];return e instanceof ns||e instanceof rs?e.maxValue:0}populatePaintArrays(t,e,i,n,r,o){for(const a in this.binders){const s=this.binders[a];(s instanceof ns||s instanceof rs||s instanceof os)&&s.populatePaintArray(t,e,i,n,r,o)}}setConstantPatternPositions(t,e){for(const i in this.binders){const n=this.binders[i];n instanceof is&&n.setConstantPatternPositions(t,e)}}updatePaintArrays(t,e,i,n,r,o){let a=!1;for(const s in t){const l=e.getPositions(s);for(const e of l){const l=i.feature(e.index);for(const i in this.binders){const c=this.binders[i];if((c instanceof ns||c instanceof rs||c instanceof os)&&!0===c.expression.isStateDependent){const h=n.paint.get(i);c.expression=h.value,c.updatePaintArray(e.start,e.end,l,t[s],r,o),a=!0}}}}return a}defines(){const t=[];for(const e in this.binders){const i=this.binders[e];(i instanceof es||i instanceof is)&&t.push(...i.uniformNames.map(t=>"#define HAS_UNIFORM_"+t))}return t}getBinderAttributes(){const t=[];for(const e in this.binders){const i=this.binders[e];if(i instanceof ns||i instanceof rs||i instanceof os)for(let e=0;e<i.paintVertexAttributes.length;e++)t.push(i.paintVertexAttributes[e].name)}return t}getBinderUniforms(){const t=[];for(const e in this.binders){const i=this.binders[e];if(i instanceof es||i instanceof is||i instanceof rs)for(const e of i.uniformNames)t.push(e)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t,e){const i=[];for(const n in this.binders){const r=this.binders[n];if(r instanceof es||r instanceof is||r instanceof rs)for(const o of r.uniformNames)if(e[o]){const a=r.getBinding(t,e[o],o);i.push({name:o,property:n,binding:a})}}return i}setUniforms(t,e,i,n){for(const{name:t,property:r,binding:o}of e)this.binders[r].setUniform(o,n,i.get(r),t)}updatePaintBuffers(t){this._buffers=[];for(const e in this.binders){const i=this.binders[e];if(t&&i instanceof os){const e=2===t.fromScale?i.zoomInPaintVertexBuffer:i.zoomOutPaintVertexBuffer;e&&this._buffers.push(e)}else(i instanceof ns||i instanceof rs)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer)}}upload(t){for(const e in this.binders){const i=this.binders[e];(i instanceof ns||i instanceof rs||i instanceof os)&&i.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const e=this.binders[t];(e instanceof ns||e instanceof rs||e instanceof os)&&e.destroy()}}}class ss{constructor(t,e,i=(()=>!0)){this.programConfigurations={};for(const n of t)this.programConfigurations[n.id]=new as(n,e,i);this.needsUpload=!1,this._featureMap=new Ha,this._bufferOffset=0}populatePaintArrays(t,e,i,n,r,o,a){for(const i in this.programConfigurations)this.programConfigurations[i].populatePaintArrays(t,e,n,r,o,a);void 0!==e.id&&this._featureMap.add(e.id,i,this._bufferOffset,t),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,e,i,n,r){for(const o of i)this.needsUpload=this.programConfigurations[o.id].updatePaintArrays(t,this._featureMap,e,o,n,r)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const e in this.programConfigurations)this.programConfigurations[e].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const ls={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"line-dasharray":["dash_to","dash_from"]};function cs(t,e){return ls[t]||[t.replace(e+"-","").replace(/-/g,"_")]}const hs={"line-pattern":{source:sa,composite:sa},"fill-pattern":{source:sa,composite:sa},"fill-extrusion-pattern":{source:sa,composite:sa},"line-dasharray":{source:la,composite:la}},us={color:{source:Ta,composite:Sa},number:{source:_a,composite:Ta}};function ds(t,e,i){const n=hs[t];return n&&n[i]||us[e][i]}zr("ConstantBinder",es),zr("CrossFadedConstantBinder",is),zr("SourceExpressionBinder",ns),zr("CrossFadedCompositeBinder",os),zr("CompositeExpressionBinder",rs),zr("ProgramConfiguration",as,{omit:["_buffers"]}),zr("ProgramConfigurationSet",ss);const ps="-transition";class fs extends ve{constructor(t,e){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,"custom"!==t.type&&(this.metadata=(t=t).metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,"background"!==t.type&&"sky"!==t.type&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),e.layout&&(this._unevaluatedLayout=new Uo(e.layout)),e.paint)){this._transitionablePaint=new No(e.paint);for(const e in t.paint)this.setPaintProperty(e,t.paint[e],{validate:!1});for(const e in t.layout)this.setLayoutProperty(e,t.layout[e],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ho(e.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(t){return"visibility"===t?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,e,i={}){null!=e&&this._validate(Pr,`layers.${this.id}.layout.${t}`,t,e,i)||("visibility"!==t?this._unevaluatedLayout.setValue(t,e):this.visibility=e)}getPaintProperty(t){return lt(t,ps)?this._transitionablePaint.getTransition(t.slice(0,-ps.length)):this._transitionablePaint.getValue(t)}setPaintProperty(t,e,i={}){if(null!=e&&this._validate(Ar,`layers.${this.id}.paint.${t}`,t,e,i))return!1;if(lt(t,ps))return this._transitionablePaint.setTransition(t.slice(0,-ps.length),e||void 0),!1;{const i=this._transitionablePaint._values[t],n="cross-faded-data-driven"===i.property.specification["property-type"],r=i.value.isDataDriven(),o=i.value;this._transitionablePaint.setValue(t,e),this._handleSpecialPaintPropertyUpdate(t);const a=this._transitionablePaint._values[t].value;return a.isDataDriven()||r||n||this._handleOverridablePaintPropertyUpdate(t,o,a)}}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getProgramConfiguration(t){return null}_handleOverridablePaintPropertyUpdate(t,e,i){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||"none"===this.visibility}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,e){t.getCrossfadeParameters&&(this._crossfadeParameters=t.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,e)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,e)}serialize(){const t={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(t.layout=t.layout||{},t.layout.visibility=this.visibility),ht(t,(t,e)=>!(void 0===t||"layout"===e&&!Object.keys(t).length||"paint"===e&&!Object.keys(t).length))}_validate(t,e,i,n,r={}){return(!r||!1!==r.validate)&&Lr(this,t.call(Sr,{key:e,layerType:this.type,objectKey:i,value:n,styleSpec:xe,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const t in this.paint._values){const e=this.paint.get(t);if(e instanceof Vo&&Cn(e.property.specification)&&("source"===e.value.kind||"composite"===e.value.kind)&&e.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=Kn(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const ms=ea([{name:"a_pos",components:2,type:"Int16"}],4),{members:gs}=ms;class ys{constructor(t=[]){this.segments=t}prepareSegment(t,e,i,n){let r=this.segments[this.segments.length-1];return t>ys.MAX_VERTEX_ARRAY_LENGTH&&pt(`Max vertices per segment is ${ys.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!r||r.vertexLength+t>ys.MAX_VERTEX_ARRAY_LENGTH||r.sortKey!==n)&&(r={vertexOffset:e.length,primitiveOffset:i.length,vertexLength:0,primitiveLength:0},void 0!==n&&(r.sortKey=n),this.segments.push(r)),r}get(){return this.segments}destroy(){for(const t of this.segments)for(const e in t.vaos)t.vaos[e].destroy()}static simpleSegment(t,e,i,n){return new ys([{vertexOffset:t,primitiveOffset:e,vertexLength:i,primitiveLength:n,vaos:{},sortKey:0}])}}ys.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,zr("SegmentVector",ys);var _s=8192;class vs{constructor(t,e){t&&(e?this.setSouthWest(t).setNorthEast(e):4===t.length?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof bs?new bs(t.lng,t.lat):bs.convert(t),this}setSouthWest(t){return this._sw=t instanceof bs?new bs(t.lng,t.lat):bs.convert(t),this}extend(t){const e=this._sw,i=this._ne;let n,r;if(t instanceof bs)n=t,r=t;else{if(!(t instanceof vs))return Array.isArray(t)?4===t.length||t.every(Array.isArray)?this.extend(vs.convert(t)):this.extend(bs.convert(t)):this;if(n=t._sw,r=t._ne,!n||!r)return this}return e||i?(e.lng=Math.min(n.lng,e.lng),e.lat=Math.min(n.lat,e.lat),i.lng=Math.max(r.lng,i.lng),i.lat=Math.max(r.lat,i.lat)):(this._sw=new bs(n.lng,n.lat),this._ne=new bs(r.lng,r.lat)),this}getCenter(){return new bs((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new bs(this.getWest(),this.getNorth())}getSouthEast(){return new bs(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:e,lat:i}=bs.convert(t);let n=this._sw.lng<=e&&e<=this._ne.lng;return this._sw.lng>this._ne.lng&&(n=this._sw.lng>=e&&e>=this._ne.lng),this._sw.lat<=i&&i<=this._ne.lat&&n}static convert(t){return!t||t instanceof vs?t:new vs(t)}}const xs=6371008.8;class bs{constructor(t,e){if(isNaN(t)||isNaN(e))throw new Error(`Invalid LngLat object: (${t}, ${e})`);if(this.lng=+t,this.lat=+e,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new bs(K(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const e=Math.PI/180,i=this.lat*e,n=t.lat*e,r=Math.sin(i)*Math.sin(n)+Math.cos(i)*Math.cos(n)*Math.cos((t.lng-this.lng)*e);return xs*Math.acos(Math.min(r,1))}toBounds(t=0){const e=360*t/40075017,i=e/Math.cos(Math.PI/180*this.lat);return new vs(new bs(this.lng-i,this.lat-e),new bs(this.lng+i,this.lat+e))}static convert(t){if(t instanceof bs)return t;if(Array.isArray(t)&&(2===t.length||3===t.length))return new bs(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&"object"==typeof t&&null!==t)return new bs(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const ws=2*Math.PI*xs;function Ms(t){return ws*Math.cos(t*Math.PI/180)}function Ts(t){return(180+t)/360}function Ss(t){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))/360}function Es(t,e){return t/Ms(e)}function Cs(t){return 360*t-180}function As(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}function Ps(t,e){return t*Ms(As(e))}const Ls=85.051129;class Is{constructor(t,e,i=0){this.x=+t,this.y=+e,this.z=+i}static fromLngLat(t,e=0){const i=bs.convert(t);return new Is(Ts(i.lng),Ss(i.lat),Es(e,i.lat))}toLngLat(){return new bs(Cs(this.x),As(this.y))}toAltitude(){return Ps(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/ws*(t=As(this.y),1/Math.cos(t*Math.PI/180));var t}}function Rs(t,e,i,n,r,a,s,l,c){const h=(e+n)/2,u=(i+r)/2,d=new o(h,u);l(d),function(t,e,i,n,r,o){const a=i-r,s=n-o;return Math.abs((n-e)*a-(i-t)*s)/Math.hypot(a,s)}(d.x,d.y,a.x,a.y,s.x,s.y)>=c?(Rs(t,e,i,h,u,a,d,l,c),Rs(t,h,u,n,r,d,s,l,c)):t.push(s)}function Ds(t,e,i){const n=[];let r,o,a;for(const s of t){const{x:t,y:l}=s;e(s),a?Rs(n,r,o,t,l,a,s,e,i):n.push(s),r=t,o=l,a=s}return n}const ks=Math.pow(2,14)-1,Os=-ks-1;function zs(t,e){const i=Math.round(t.x*e),n=Math.round(t.y*e);return t.x=$(i,Os,ks),t.y=$(n,Os,ks),(i<t.x||i>t.x+1||n<t.y||n>t.y+1)&&pt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),t}function Bs(t,e,i){const n=t.loadGeometry(),r=t.extent,o=_s/r;if(e&&i&&i.projection.isReprojectedInTileSpace){const o=1<<e.z,{scale:a,x:s,y:l,projection:c}=i,h=t=>{const i=Cs((e.x+t.x/r)/o),n=As((e.y+t.y/r)/o),h=c.project(i,n);t.x=(h.x*a-s)*r,t.y=(h.y*a-l)*r};for(let e=0;e<n.length;e++)if(1!==t.type)n[e]=Ds(n[e],h,1);else{const t=[];for(const i of n[e])i.x<0||i.x>=r||i.y<0||i.y>=r||(h(i),t.push(i));n[e]=t}}for(const t of n)for(const e of t)zs(e,o);return n}function Fs(t,e){return{type:t.type,id:t.id,properties:t.properties,geometry:e?Bs(t):[]}}function Ns(t,e,i,n,r){t.emplaceBack(2*e+(n+1)/2,2*i+(r+1)/2)}class js{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(t=>t.id),this.index=t.index,this.hasPattern=!1,this.layoutVertexArray=new na,this.indexArray=new ma,this.segments=new ys,this.programConfigurations=new ss(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(t=>t.isStateDependent()).map(t=>t.id)}populate(t,e,i,n){const r=this.layers[0],o=[];let a=null;"circle"===r.type&&(a=r.layout.get("circle-sort-key"));for(const{feature:e,id:r,index:s,sourceLayerIndex:l}of t){const t=this.layers[0]._featureFilter.needGeometry,c=Fs(e,t);if(!this.layers[0]._featureFilter.filter(new zo(this.zoom),c,i))continue;const h=a?a.evaluate(c,{},i):void 0,u={id:r,properties:e.properties,type:e.type,sourceLayerIndex:l,index:s,geometry:t?c.geometry:Bs(e,i,n),patterns:{},sortKey:h};o.push(u)}a&&o.sort((t,e)=>t.sortKey-e.sortKey);for(const n of o){const{geometry:r,index:o,sourceLayerIndex:a}=n,s=t[o].feature;this.addFeature(n,r,o,e.availableImages,i),e.featureIndex.insert(s,r,o,a,this.index)}}update(t,e,i,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers,i,n)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,gs),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,e,i,n,r){for(const i of e)for(const e of i){const i=e.x,n=e.y;if(i<0||i>=_s||n<0||n>=_s)continue;const r=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),o=r.vertexLength;Ns(this.layoutVertexArray,i,n,-1,-1),Ns(this.layoutVertexArray,i,n,1,-1),Ns(this.layoutVertexArray,i,n,1,1),Ns(this.layoutVertexArray,i,n,-1,1),this.indexArray.emplaceBack(o,o+1,o+2),this.indexArray.emplaceBack(o,o+3,o+2),r.vertexLength+=4,r.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,i,{},n,r)}}function Gs(t,e){for(let i=0;i<t.length;i++)if($s(e,t[i]))return!0;for(let i=0;i<e.length;i++)if($s(t,e[i]))return!0;return!!Zs(t,e)}function Us(t,e,i){return!!$s(t,e)||!!qs(e,t,i)}function Vs(t,e){if(1===t.length)return Ys(e,t[0]);for(let i=0;i<e.length;i++){const n=e[i];for(let e=0;e<n.length;e++)if($s(t,n[e]))return!0}for(let i=0;i<t.length;i++)if(Ys(e,t[i]))return!0;for(let i=0;i<e.length;i++)if(Zs(t,e[i]))return!0;return!1}function Hs(t,e,i){if(t.length>1){if(Zs(t,e))return!0;for(let n=0;n<e.length;n++)if(qs(e[n],t,i))return!0}for(let n=0;n<t.length;n++)if(qs(t[n],e,i))return!0;return!1}function Zs(t,e){if(0===t.length||0===e.length)return!1;for(let i=0;i<t.length-1;i++){const n=t[i],r=t[i+1];for(let t=0;t<e.length-1;t++)if(Ws(n,r,e[t],e[t+1]))return!0}return!1}function Ws(t,e,i,n){return ft(t,i,n)!==ft(e,i,n)&&ft(t,e,i)!==ft(t,e,n)}function qs(t,e,i){const n=i*i;if(1===e.length)return t.distSqr(e[0])<n;for(let i=1;i<e.length;i++)if(Xs(t,e[i-1],e[i])<n)return!0;return!1}function Xs(t,e,i){const n=e.distSqr(i);if(0===n)return t.distSqr(e);const r=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/n;return t.distSqr(r<0?e:r>1?i:i.sub(e)._mult(r)._add(e))}function Ys(t,e){let i,n,r,o=!1;for(let a=0;a<t.length;a++){i=t[a];for(let t=0,a=i.length-1;t<i.length;a=t++)n=i[t],r=i[a],n.y>e.y!=r.y>e.y&&e.x<(r.x-n.x)*(e.y-n.y)/(r.y-n.y)+n.x&&(o=!o)}return o}function $s(t,e){let i=!1;for(let n=0,r=t.length-1;n<t.length;r=n++){const o=t[n],a=t[r];o.y>e.y!=a.y>e.y&&e.x<(a.x-o.x)*(e.y-o.y)/(a.y-o.y)+o.x&&(i=!i)}return i}function Js(t,e,i,n,r){for(const o of t)if(e<=o.x&&i<=o.y&&n>=o.x&&r>=o.y)return!0;const a=[new o(e,i),new o(e,r),new o(n,r),new o(n,i)];if(t.length>2)for(const e of a)if($s(t,e))return!0;for(let e=0;e<t.length-1;e++)if(Ks(t[e],t[e+1],a))return!0;return!1}function Ks(t,e,i){const n=i[0],r=i[2];if(t.x<n.x&&e.x<n.x||t.x>r.x&&e.x>r.x||t.y<n.y&&e.y<n.y||t.y>r.y&&e.y>r.y)return!1;const o=ft(t,e,i[0]);return o!==ft(t,e,i[1])||o!==ft(t,e,i[2])||o!==ft(t,e,i[3])}function Qs(t,e,i){const n=e.paint.get(t).value;return"constant"===n.kind?n.value:i.programConfigurations.get(e.id).getMaxValue(t)}function tl(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function el(t,e,i,n,r){if(!e[0]&&!e[1])return t;const a=o.convert(e)._mult(r);"viewport"===i&&a._rotate(-n);const s=[];for(let e=0;e<t.length;e++)s.push(t[e].sub(a));return s}function il(t,e,i,n){const r=o.convert(t)._mult(n);return"viewport"===e&&r._rotate(-i),r}zr("CircleBucket",js,{omit:["layers"]});const nl=new $o({"circle-sort-key":new Wo(xe.layout_circle["circle-sort-key"])});var rl={paint:new $o({"circle-radius":new Wo(xe.paint_circle["circle-radius"]),"circle-color":new Wo(xe.paint_circle["circle-color"]),"circle-blur":new Wo(xe.paint_circle["circle-blur"]),"circle-opacity":new Wo(xe.paint_circle["circle-opacity"]),"circle-translate":new Zo(xe.paint_circle["circle-translate"]),"circle-translate-anchor":new Zo(xe.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Zo(xe.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Zo(xe.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Wo(xe.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Wo(xe.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Wo(xe.paint_circle["circle-stroke-opacity"])}),layout:nl};class ol{constructor(t,e){this.points=t,this.planes=e}static fromInvProjectionMatrix(t,e,i,n){const r=Math.pow(2,i),o=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(i=>{const o=B([],i,t),a=1/o[3]/e*r;return function(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],t}(o,o,[a,a,n?1/o[3]:a,a])}),a=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(t=>{const e=A([],L([],k([],o[t[0]],o[t[1]]),k([],o[t[2]],o[t[1]]))),i=-P(e,o[t[1]]);return e.concat(i)});return new ol(o,a)}}class al{constructor(t,e){this.min=t,this.max=e,this.center=E([],w([],this.min,this.max),.5)}quadrant(t){const e=[t%2==0,t<2],i=v(this.min),n=v(this.max);for(let t=0;t<e.length;t++)i[t]=e[t]?this.min[t]:this.center[t],n[t]=e[t]?this.center[t]:this.max[t];return n[2]=this.max[2],new al(i,n)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,e=this.max;return[[t[0],t[1],t[2]],[e[0],t[1],t[2]],[e[0],e[1],t[2]],[t[0],e[1],t[2]],[t[0],t[1],e[2]],[e[0],t[1],e[2]],[e[0],e[1],e[2]],[t[0],e[1],e[2]]]}intersects(t){const e=this.getCorners();let i=!0;for(let n=0;n<t.planes.length;n++){const r=t.planes[n];let o=0;for(let t=0;t<e.length;t++)o+=P(r,e[t])+r[3]>=0;if(0===o)return 0;o!==e.length&&(i=!1)}if(i)return 2;for(let e=0;e<3;e++){let i=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let r=0;r<t.points.length;r++){const o=t.points[r][e]-this.min[e];i=Math.min(i,o),n=Math.max(n,o)}if(n<0||i>this.max[e]-this.min[e])return 0}return 1}}function sl(t,e,i,n,r,o,a,s,l){if(o&&t.queryGeometry.isAboveHorizon)return!1;o&&(l*=t.pixelToTileUnitsFactor);for(const c of e)for(const e of c){const c=e.add(s),h=r&&i.elevation?i.elevation.exaggeration()*r.getElevationAt(c.x,c.y,!0):0,u=o?c:ll(c,h,n),d=o?t.tilespaceRays.map(t=>ul(t,h)):t.queryGeometry.screenGeometry,p=B([],[e.x,e.y,h,1],n);if(!a&&o?l*=p[3]/i.cameraToCenterDistance:a&&!o&&(l*=i.cameraToCenterDistance/p[3]),Us(d,u,l))return!0}return!1}function ll(t,e,i){const n=B([],[t.x,t.y,e,1],i);return new o(n[0]/n[3],n[1]/n[3])}const cl=b(0,0,0),hl=b(0,0,1);function ul(t,e){const i=_();return cl[2]=e,t.intersectsPlane(cl,hl,i),new o(i[0],i[1])}class dl extends js{}function pl(t,{width:e,height:i},n,r){if(r){if(r instanceof Uint8ClampedArray)r=new Uint8Array(r.buffer);else if(r.length!==e*i*n)throw new RangeError("mismatched image size")}else r=new Uint8Array(e*i*n);return t.width=e,t.height=i,t.data=r,t}function fl(t,{width:e,height:i},n){if(e===t.width&&i===t.height)return;const r=pl({},{width:e,height:i},n);ml(t,r,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,e),height:Math.min(t.height,i)},n),t.width=e,t.height=i,t.data=r.data}function ml(t,e,i,n,r,o){if(0===r.width||0===r.height)return e;if(r.width>t.width||r.height>t.height||i.x>t.width-r.width||i.y>t.height-r.height)throw new RangeError("out of range source coordinates for image copy");if(r.width>e.width||r.height>e.height||n.x>e.width-r.width||n.y>e.height-r.height)throw new RangeError("out of range destination coordinates for image copy");const a=t.data,s=e.data;for(let l=0;l<r.height;l++){const c=((i.y+l)*t.width+i.x)*o,h=((n.y+l)*e.width+n.x)*o;for(let t=0;t<r.width*o;t++)s[h+t]=a[c+t]}return e}zr("HeatmapBucket",dl,{omit:["layers"]});class gl{constructor(t,e){pl(this,t,1,e)}resize(t){fl(this,t,1)}clone(){return new gl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,i,n,r){ml(t,e,i,n,r,1)}}class yl{constructor(t,e){pl(this,t,4,e)}resize(t){fl(this,t,4)}replace(t,e){e?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new yl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,i,n,r){ml(t,e,i,n,r,4)}}zr("AlphaImage",gl),zr("RGBAImage",yl);var _l={paint:new $o({"heatmap-radius":new Wo(xe.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Wo(xe.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Zo(xe.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Yo(xe.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Zo(xe.paint_heatmap["heatmap-opacity"])})};function vl(t){const e={},i=t.resolution||256,n=t.clips?t.clips.length:1,r=t.image||new yl({width:i,height:n}),o=(i,n,o)=>{e[t.evaluationKey]=o;const a=t.expression.evaluate(e);r.data[i+n+0]=Math.floor(255*a.r/a.a),r.data[i+n+1]=Math.floor(255*a.g/a.a),r.data[i+n+2]=Math.floor(255*a.b/a.a),r.data[i+n+3]=Math.floor(255*a.a)};if(t.clips)for(let e=0,r=0;e<n;++e,r+=4*i)for(let n=0,a=0;n<i;n++,a+=4){const s=n/(i-1),{start:l,end:c}=t.clips[e];o(r,a,l*(1-s)+c*s)}else for(let t=0,e=0;t<i;t++,e+=4)o(0,e,t/(i-1));return r}var xl={paint:new $o({"hillshade-illumination-direction":new Zo(xe.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Zo(xe.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Zo(xe.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Zo(xe.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Zo(xe.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Zo(xe.paint_hillshade["hillshade-accent-color"])})};const bl=ea([{name:"a_pos",components:2,type:"Int16"}],4),{members:wl}=bl;var Ml=Sl,Tl=Sl;function Sl(t,e,i){i=i||2;var n,r,o,a,s,l,c,h=e&&e.length,u=h?e[0]*i:t.length,d=El(t,0,u,i,!0),p=[];if(!d||d.next===d.prev)return p;if(h&&(d=function(t,e,i,n){var r,o,a,s=[];for(r=0,o=e.length;r<o;r++)(a=El(t,e[r]*n,r<o-1?e[r+1]*n:t.length,n,!1))===a.next&&(a.steiner=!0),s.push(Bl(a));for(s.sort(Dl),r=0;r<s.length;r++)i=Cl(i=kl(s[r],i),i.next);return i}(t,e,d,i)),t.length>80*i){n=o=t[0],r=a=t[1];for(var f=i;f<u;f+=i)(s=t[f])<n&&(n=s),(l=t[f+1])<r&&(r=l),s>o&&(o=s),l>a&&(a=l);c=0!==(c=Math.max(o-n,a-r))?1/c:0}return Al(d,p,i,n,r,c),p}function El(t,e,i,n,r){var o,a;if(r===$l(t,e,i,n)>0)for(o=e;o<i;o+=n)a=ql(o,t[o],t[o+1],a);else for(o=i-n;o>=e;o-=n)a=ql(o,t[o],t[o+1],a);return a&&Gl(a,a.next)&&(Xl(a),a=a.next),a}function Cl(t,e){if(!t)return t;e||(e=t);var i,n=t;do{if(i=!1,n.steiner||!Gl(n,n.next)&&0!==jl(n.prev,n,n.next))n=n.next;else{if(Xl(n),(n=e=n.prev)===n.next)break;i=!0}}while(i||n!==e);return e}function Al(t,e,i,n,r,o,a){if(t){!a&&o&&function(t,e,i,n){var r=t;do{null===r.z&&(r.z=zl(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,i,n,r,o,a,s,l,c=1;do{for(i=t,t=null,o=null,a=0;i;){for(a++,n=i,s=0,e=0;e<c&&(s++,n=n.nextZ);e++);for(l=c;s>0||l>0&&n;)0!==s&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,s--):(r=n,n=n.nextZ,l--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;i=n}o.nextZ=null,c*=2}while(a>1)}(r)}(t,n,r,o);for(var s,l,c=t;t.prev!==t.next;)if(s=t.prev,l=t.next,o?Ll(t,n,r,o):Pl(t))e.push(s.i/i),e.push(t.i/i),e.push(l.i/i),Xl(t),t=l.next,c=l.next;else if((t=l)===c){a?1===a?Al(t=Il(Cl(t),e,i),e,i,n,r,o,2):2===a&&Rl(t,e,i,n,r,o):Al(Cl(t),e,i,n,r,o,1);break}}}function Pl(t){var e=t.prev,i=t,n=t.next;if(jl(e,i,n)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(Fl(e.x,e.y,i.x,i.y,n.x,n.y,r.x,r.y)&&jl(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Ll(t,e,i,n){var r=t.prev,o=t,a=t.next;if(jl(r,o,a)>=0)return!1;for(var s=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,l=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,c=zl(r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,e,i,n),h=zl(s,l,e,i,n),u=t.prevZ,d=t.nextZ;u&&u.z>=c&&d&&d.z<=h;){if(u!==t.prev&&u!==t.next&&Fl(r.x,r.y,o.x,o.y,a.x,a.y,u.x,u.y)&&jl(u.prev,u,u.next)>=0)return!1;if(u=u.prevZ,d!==t.prev&&d!==t.next&&Fl(r.x,r.y,o.x,o.y,a.x,a.y,d.x,d.y)&&jl(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;u&&u.z>=c;){if(u!==t.prev&&u!==t.next&&Fl(r.x,r.y,o.x,o.y,a.x,a.y,u.x,u.y)&&jl(u.prev,u,u.next)>=0)return!1;u=u.prevZ}for(;d&&d.z<=h;){if(d!==t.prev&&d!==t.next&&Fl(r.x,r.y,o.x,o.y,a.x,a.y,d.x,d.y)&&jl(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function Il(t,e,i){var n=t;do{var r=n.prev,o=n.next.next;!Gl(r,o)&&Ul(r,n,n.next,o)&&Zl(r,o)&&Zl(o,r)&&(e.push(r.i/i),e.push(n.i/i),e.push(o.i/i),Xl(n),Xl(n.next),n=t=o),n=n.next}while(n!==t);return Cl(n)}function Rl(t,e,i,n,r,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&Nl(a,s)){var l=Wl(a,s);return a=Cl(a,a.next),l=Cl(l,l.next),Al(a,e,i,n,r,o),void Al(l,e,i,n,r,o)}s=s.next}a=a.next}while(a!==t)}function Dl(t,e){return t.x-e.x}function kl(t,e){var i=function(t,e){var i,n=e,r=t.x,o=t.y,a=-1/0;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){var s=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=r&&s>a){if(a=s,s===r){if(o===n.y)return n;if(o===n.next.y)return n.next}i=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!i)return null;if(r===a)return i;var l,c=i,h=i.x,u=i.y,d=1/0;n=i;do{r>=n.x&&n.x>=h&&r!==n.x&&Fl(o<u?r:a,o,h,u,o<u?a:r,o,n.x,n.y)&&(l=Math.abs(o-n.y)/(r-n.x),Zl(n,t)&&(l<d||l===d&&(n.x>i.x||n.x===i.x&&Ol(i,n)))&&(i=n,d=l)),n=n.next}while(n!==c);return i}(t,e);if(!i)return e;var n=Wl(i,t),r=Cl(i,i.next);return Cl(n,n.next),e===i?r:e}function Ol(t,e){return jl(t.prev,t,e.prev)<0&&jl(e.next,t,t.next)<0}function zl(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Bl(t){var e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function Fl(t,e,i,n,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(n-s)-(i-a)*(e-s)>=0&&(i-a)*(o-s)-(r-a)*(n-s)>=0}function Nl(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Ul(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(Zl(t,e)&&Zl(e,t)&&function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)&&(jl(t.prev,t,e.prev)||jl(t,e.prev,e))||Gl(t,e)&&jl(t.prev,t,t.next)>0&&jl(e.prev,e,e.next)>0)}function jl(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function Gl(t,e){return t.x===e.x&&t.y===e.y}function Ul(t,e,i,n){var r=Hl(jl(t,e,i)),o=Hl(jl(t,e,n)),a=Hl(jl(i,n,t)),s=Hl(jl(i,n,e));return r!==o&&a!==s||!(0!==r||!Vl(t,i,e))||!(0!==o||!Vl(t,n,e))||!(0!==a||!Vl(i,t,n))||!(0!==s||!Vl(i,e,n))}function Vl(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Hl(t){return t>0?1:t<0?-1:0}function Zl(t,e){return jl(t.prev,t,t.next)<0?jl(t,e,t.next)>=0&&jl(t,t.prev,e)>=0:jl(t,e,t.prev)<0||jl(t,t.next,e)<0}function Wl(t,e){var i=new Yl(t.i,t.x,t.y),n=new Yl(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function ql(t,e,i,n){var r=new Yl(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function Xl(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Yl(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function $l(t,e,i,n){for(var r=0,o=e,a=i-n;o<i;o+=n)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}function Jl(t,e,i,n,r){!function t(e,i,n,r,o){for(;r>n;){if(r-n>600){var a=r-n+1,s=i-n+1,l=Math.log(a),c=.5*Math.exp(2*l/3),h=.5*Math.sqrt(l*c*(a-c)/a)*(s-a/2<0?-1:1);t(e,i,Math.max(n,Math.floor(i-s*c/a+h)),Math.min(r,Math.floor(i+(a-s)*c/a+h)),o)}var u=e[i],d=n,p=r;for(Kl(e,n,i),o(e[r],u)>0&&Kl(e,n,r);d<p;){for(Kl(e,d,p),d++,p--;o(e[d],u)<0;)d++;for(;o(e[p],u)>0;)p--}0===o(e[n],u)?Kl(e,n,p):Kl(e,++p,r),p<=i&&(n=p+1),i<=p&&(r=p-1)}}(t,e,i||0,n||t.length-1,r||Ql)}function Kl(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function Ql(t,e){return t<e?-1:t>e?1:0}function tc(t,e){const i=t.length;if(i<=1)return[t];const n=[];let r,o;for(let e=0;e<i;e++){const i=mt(t[e]);0!==i&&(t[e].area=Math.abs(i),void 0===o&&(o=i<0),o===i<0?(r&&n.push(r),r=[t[e]]):r.push(t[e]))}if(r&&n.push(r),e>1)for(let t=0;t<n.length;t++)n[t].length<=e||(Jl(n[t],e,1,n[t].length-1,ec),n[t]=n[t].slice(0,e));return n}function ec(t,e){return e.area-t.area}function ic(t,e,i){const n=i.patternDependencies;let r=!1;for(const i of e){const e=i.paint.get(t+"-pattern");e.isConstant()||(r=!0);const o=e.constantOr(null);o&&(r=!0,n[o.to]=!0,n[o.from]=!0)}return r}function nc(t,e,i,n,r){const o=r.patternDependencies;for(const a of e){const e=a.paint.get(t+"-pattern").value;if("constant"!==e.kind){let t=e.evaluate({zoom:n-1},i,{},r.availableImages),s=e.evaluate({zoom:n},i,{},r.availableImages),l=e.evaluate({zoom:n+1},i,{},r.availableImages);t=t&&t.name?t.name:t,s=s&&s.name?s.name:s,l=l&&l.name?l.name:l,o[t]=!0,o[s]=!0,o[l]=!0,i.patterns[a.id]={min:t,mid:s,max:l}}}return i}Sl.deviation=function(t,e,i,n){var r=e&&e.length,o=Math.abs($l(t,0,r?e[0]*i:t.length,i));if(r)for(var a=0,s=e.length;a<s;a++)o-=Math.abs($l(t,e[a]*i,a<s-1?e[a+1]*i:t.length,i));var l=0;for(a=0;a<n.length;a+=3){var c=n[a]*i,h=n[a+1]*i,u=n[a+2]*i;l+=Math.abs((t[c]-t[u])*(t[h+1]-t[c+1])-(t[c]-t[h])*(t[u+1]-t[c+1]))}return 0===o&&0===l?0:Math.abs((l-o)/o)},Sl.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},n=0,r=0;r<t.length;r++){for(var o=0;o<t[r].length;o++)for(var a=0;a<e;a++)i.vertices.push(t[r][o][a]);r>0&&i.holes.push(n+=t[r-1].length)}return i},Ml.default=Tl;class rc{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(t=>t.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new na,this.indexArray=new ma,this.indexArray2=new wa,this.programConfigurations=new ss(t.layers,t.zoom),this.segments=new ys,this.segments2=new ys,this.stateDependentLayerIds=this.layers.filter(t=>t.isStateDependent()).map(t=>t.id)}populate(t,e,i,n){this.hasPattern=ic("fill",this.layers,e);const r=this.layers[0].layout.get("fill-sort-key"),o=[];for(const{feature:a,id:s,index:l,sourceLayerIndex:c}of t){const t=this.layers[0]._featureFilter.needGeometry,h=Fs(a,t);if(!this.layers[0]._featureFilter.filter(new zo(this.zoom),h,i))continue;const u=r?r.evaluate(h,{},i,e.availableImages):void 0,d={id:s,properties:a.properties,type:a.type,sourceLayerIndex:c,index:l,geometry:t?h.geometry:Bs(a,i,n),patterns:{},sortKey:u};o.push(d)}r&&o.sort((t,e)=>t.sortKey-e.sortKey);for(const n of o){const{geometry:r,index:o,sourceLayerIndex:a}=n;if(this.hasPattern){const t=nc("fill",this.layers,n,this.zoom,e);this.patternFeatures.push(t)}else this.addFeature(n,r,o,i,{},e.availableImages);e.featureIndex.insert(t[o].feature,r,o,a,this.index)}}update(t,e,i,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers,i,n)}addFeatures(t,e,i,n){for(const t of this.patternFeatures)this.addFeature(t,t.geometry,t.index,e,i,n)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,wl),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,e,i,n,r,o=[]){for(const t of tc(e,500)){let e=0;for(const i of t)e+=i.length;const i=this.segments.prepareSegment(e,this.layoutVertexArray,this.indexArray),n=i.vertexLength,r=[],o=[];for(const e of t){if(0===e.length)continue;e!==t[0]&&o.push(r.length/2);const i=this.segments2.prepareSegment(e.length,this.layoutVertexArray,this.indexArray2),n=i.vertexLength;this.layoutVertexArray.emplaceBack(e[0].x,e[0].y),this.indexArray2.emplaceBack(n+e.length-1,n),r.push(e[0].x),r.push(e[0].y);for(let t=1;t<e.length;t++)this.layoutVertexArray.emplaceBack(e[t].x,e[t].y),this.indexArray2.emplaceBack(n+t-1,n+t),r.push(e[t].x),r.push(e[t].y);i.vertexLength+=e.length,i.primitiveLength+=e.length}const a=Ml(r,o);for(let t=0;t<a.length;t+=3)this.indexArray.emplaceBack(n+a[t],n+a[t+1],n+a[t+2]);i.vertexLength+=e,i.primitiveLength+=a.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,i,r,o,n)}}zr("FillBucket",rc,{omit:["layers","patternFeatures"]});const oc=new $o({"fill-sort-key":new Wo(xe.layout_fill["fill-sort-key"])});var ac={paint:new $o({"fill-antialias":new Zo(xe.paint_fill["fill-antialias"]),"fill-opacity":new Wo(xe.paint_fill["fill-opacity"]),"fill-color":new Wo(xe.paint_fill["fill-color"]),"fill-outline-color":new Wo(xe.paint_fill["fill-outline-color"]),"fill-translate":new Zo(xe.paint_fill["fill-translate"]),"fill-translate-anchor":new Zo(xe.paint_fill["fill-translate-anchor"]),"fill-pattern":new qo(xe.paint_fill["fill-pattern"])}),layout:oc};const sc=ea([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),lc=ea([{name:"a_centroid_pos",components:2,type:"Uint16"}]),{members:cc}=sc;var hc=uc;function uc(t,e,i,n,r){this.properties={},this.extent=i,this.type=0,this._pbf=t,this._geometry=-1,this._keys=n,this._values=r,t.readFields(dc,this,e)}function dc(t,e,i){1==t?e.id=i.readVarint():2==t?function(t,e){for(var i=t.readVarint()+t.pos;t.pos<i;){var n=e._keys[t.readVarint()],r=e._values[t.readVarint()];e.properties[n]=r}}(i,e):3==t?e.type=i.readVarint():4==t&&(e._geometry=i.pos)}function pc(t){for(var e,i,n=0,r=0,o=t.length,a=o-1;r<o;a=r++)n+=((i=t[a]).x-(e=t[r]).x)*(e.y+i.y);return n}uc.types=["Unknown","Point","LineString","Polygon"],uc.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,i=t.readVarint()+t.pos,n=1,r=0,a=0,s=0,l=[];t.pos<i;){if(r<=0){var c=t.readVarint();n=7&c,r=c>>3}if(r--,1===n||2===n)a+=t.readSVarint(),s+=t.readSVarint(),1===n&&(e&&l.push(e),e=[]),e.push(new o(a,s));else{if(7!==n)throw new Error("unknown command "+n);e&&e.push(e[0].clone())}}return e&&l.push(e),l},uc.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,i=1,n=0,r=0,o=0,a=1/0,s=-1/0,l=1/0,c=-1/0;t.pos<e;){if(n<=0){var h=t.readVarint();i=7&h,n=h>>3}if(n--,1===i||2===i)(r+=t.readSVarint())<a&&(a=r),r>s&&(s=r),(o+=t.readSVarint())<l&&(l=o),o>c&&(c=o);else if(7!==i)throw new Error("unknown command "+i)}return[a,l,s,c]},uc.prototype.toGeoJSON=function(t,e,i){var n,r,o=this.extent*Math.pow(2,i),a=this.extent*t,s=this.extent*e,l=this.loadGeometry(),c=uc.types[this.type];function h(t){for(var e=0;e<t.length;e++){var i=t[e];t[e]=[360*(i.x+a)/o-180,360/Math.PI*Math.atan(Math.exp((180-360*(i.y+s)/o)*Math.PI/180))-90]}}switch(this.type){case 1:var u=[];for(n=0;n<l.length;n++)u[n]=l[n][0];h(l=u);break;case 2:for(n=0;n<l.length;n++)h(l[n]);break;case 3:for(l=function(t){var e=t.length;if(e<=1)return[t];for(var i,n,r=[],o=0;o<e;o++){var a=pc(t[o]);0!==a&&(void 0===n&&(n=a<0),n===a<0?(i&&r.push(i),i=[t[o]]):i.push(t[o]))}return i&&r.push(i),r}(l),n=0;n<l.length;n++)for(r=0;r<l[n].length;r++)h(l[n][r])}1===l.length?l=l[0]:c="Multi"+c;var d={type:"Feature",geometry:{type:c,coordinates:l},properties:this.properties};return"id"in this&&(d.id=this.id),d};var fc=mc;function mc(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(gc,this,e),this.length=this._features.length}function gc(t,e,i){15===t?e.version=i.readVarint():1===t?e.name=i.readString():5===t?e.extent=i.readVarint():2===t?e._features.push(i.pos):3===t?e._keys.push(i.readString()):4===t&&e._values.push(function(t){for(var e=null,i=t.readVarint()+t.pos;t.pos<i;){var n=t.readVarint()>>3;e=1===n?t.readString():2===n?t.readFloat():3===n?t.readDouble():4===n?t.readVarint64():5===n?t.readVarint():6===n?t.readSVarint():7===n?t.readBoolean():null}return e}(i))}function yc(t,e,i){if(3===t){var n=new fc(i,i.readVarint()+i.pos);n.length&&(e[n.name]=n)}}mc.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new hc(this._pbf,e,this.extent,this._keys,this._values)};var _c={VectorTile:function(t,e){this.layers=t.readFields(yc,{},e)},VectorTileFeature:hc,VectorTileLayer:fc};const vc=_c.VectorTileFeature.types,xc=Math.pow(2,13);function bc(t,e,i,n,r,o,a,s){t.emplaceBack((e<<1)+a,(i<<1)+o,(Math.floor(n*xc)<<1)+r,Math.round(s))}class wc{constructor(){this.acc=new o(0,0),this.polyCount=[]}startRing(t){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new o(t.x,t.y),this.max=new o(t.x,t.y))}append(t,e){this.currentPolyCount.edges++,this.acc._add(t);let i=!!this.borders;const n=this.min,r=this.max;t.x<n.x?(n.x=t.x,i=!0):t.x>r.x&&(r.x=t.x,i=!0),t.y<n.y?(n.y=t.y,i=!0):t.y>r.y&&(r.y=t.y,i=!0),((0===t.x||t.x===_s)&&t.x===e.x)!=((0===t.y||t.y===_s)&&t.y===e.y)&&this.processBorderOverlap(t,e),i&&this.checkBorderIntersection(t,e)}checkBorderIntersection(t,e){e.x<0!=t.x<0&&this.addBorderIntersection(0,Bi(e.y,t.y,(0-e.x)/(t.x-e.x))),e.x>_s!=t.x>_s&&this.addBorderIntersection(1,Bi(e.y,t.y,(_s-e.x)/(t.x-e.x))),e.y<0!=t.y<0&&this.addBorderIntersection(2,Bi(e.x,t.x,(0-e.y)/(t.y-e.y))),e.y>_s!=t.y>_s&&this.addBorderIntersection(3,Bi(e.x,t.x,(_s-e.y)/(t.y-e.y)))}addBorderIntersection(t,e){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const i=this.borders[t];e<i[0]&&(i[0]=e),e>i[1]&&(i[1]=e)}processBorderOverlap(t,e){if(t.x===e.x){if(t.y===e.y)return;const i=0===t.x?0:1;this.addBorderIntersection(i,e.y),this.addBorderIntersection(i,t.y)}else{const i=0===t.y?2:3;this.addBorderIntersection(i,e.x),this.addBorderIntersection(i,t.x)}}centroid(){const t=this.polyCount.reduce((t,e)=>t+e.edges,0);return 0!==t?this.acc.div(t)._round():new o(0,0)}span(){return new o(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce((t,e)=>t+ +(e[0]!==Number.MAX_VALUE),0)}}class Mc{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(t=>t.id),this.index=t.index,this.hasPattern=!1,this.layoutVertexArray=new ra,this.centroidVertexArray=new Ba,this.indexArray=new ma,this.programConfigurations=new ss(t.layers,t.zoom),this.segments=new ys,this.stateDependentLayerIds=this.layers.filter(t=>t.isStateDependent()).map(t=>t.id),this.enableTerrain=t.enableTerrain}populate(t,e,i,n){this.features=[],this.hasPattern=ic("fill-extrusion",this.layers,e),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDone=[!1,!1,!1,!1],this.tileToMeter=function(t){const e=Math.exp(Math.PI*(1-t.y/(1<<t.z)*2));return 80150034*e/(e*e+1)/_s/(1<<t.z)}(i);for(const{feature:r,id:o,index:a,sourceLayerIndex:s}of t){const t=this.layers[0]._featureFilter.needGeometry,l=Fs(r,t);if(!this.layers[0]._featureFilter.filter(new zo(this.zoom),l,i))continue;const c={id:o,sourceLayerIndex:s,index:a,geometry:t?l.geometry:Bs(r,i,n),properties:r.properties,type:r.type,patterns:{}},h=this.layoutVertexArray.length;this.hasPattern?this.features.push(nc("fill-extrusion",this.layers,c,this.zoom,e)):this.addFeature(c,c.geometry,a,i,{},e.availableImages),e.featureIndex.insert(r,c.geometry,a,s,this.index,h)}this.sortBorders()}addFeatures(t,e,i,n){for(const t of this.features){const{geometry:r}=t;this.addFeature(t,r,t.index,e,i,n)}this.sortBorders()}update(t,e,i,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers,i,n)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,cc),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){0!==this.centroidVertexArray.length&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,lc.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,e,i,n,r,o){const a=this.enableTerrain?new wc:null;for(const i of tc(e,500)){let e=0,n=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);if(0===i.length||(s=i[0]).every(t=>t.x<=0)||s.every(t=>t.x>=_s)||s.every(t=>t.y<=0)||s.every(t=>t.y>=_s))continue;for(let t=0;t<i.length;t++){const r=i[t];if(0===r.length)continue;e+=r.length;let o=0;a&&a.startRing(r[0]);for(let t=0;t<r.length;t++){const e=r[t];if(t>=1){const i=r[t-1];if(!Tc(e,i)){a&&a.append(e,i),n.vertexLength+4>ys.MAX_VERTEX_ARRAY_LENGTH&&(n=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const t=e.sub(i)._perp(),r=t.x/(Math.abs(t.x)+Math.abs(t.y)),s=t.y>0?1:0,l=i.dist(e);o+l>32768&&(o=0),bc(this.layoutVertexArray,e.x,e.y,r,s,0,0,o),bc(this.layoutVertexArray,e.x,e.y,r,s,0,1,o),o+=l,bc(this.layoutVertexArray,i.x,i.y,r,s,0,0,o),bc(this.layoutVertexArray,i.x,i.y,r,s,0,1,o);const c=n.vertexLength;this.indexArray.emplaceBack(c,c+2,c+1),this.indexArray.emplaceBack(c+1,c+2,c+3),n.vertexLength+=4,n.primitiveLength+=2}}}}if(n.vertexLength+e>ys.MAX_VERTEX_ARRAY_LENGTH&&(n=this.segments.prepareSegment(e,this.layoutVertexArray,this.indexArray)),"Polygon"!==vc[t.type])continue;const r=[],o=[],l=n.vertexLength;for(let t=0;t<i.length;t++){const e=i[t];if(0!==e.length){e!==i[0]&&o.push(r.length/2);for(let t=0;t<e.length;t++){const i=e[t];bc(this.layoutVertexArray,i.x,i.y,0,0,1,1,0),r.push(i.x),r.push(i.y),a&&a.currentPolyCount.top++}}}const c=Ml(r,o);for(let t=0;t<c.length;t+=3)this.indexArray.emplaceBack(l+c[t],l+c[t+2],l+c[t+1]);n.primitiveLength+=c.length/3,n.vertexLength+=e}var s;if(a&&a.polyCount.length>0){if(a.borders){a.vertexArrayOffset=this.centroidVertexArray.length;const t=a.borders,e=this.featuresOnBorder.push(a)-1;for(let i=0;i<4;i++)t[i][0]!==Number.MAX_VALUE&&this.borders[i].push(e)}this.encodeCentroid(a.borders?void 0:a.centroid(),a)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,i,r,o,n)}sortBorders(){for(let t=0;t<4;t++)this.borders[t].sort((e,i)=>this.featuresOnBorder[e].borders[t][0]-this.featuresOnBorder[i].borders[t][0])}encodeCentroid(t,e,i=!0){let n,r;if(t)if(0!==t.y){const i=e.span()._mult(this.tileToMeter);n=(Math.max(t.x,1)<<3)+Math.min(7,Math.round(i.x/10)),r=(Math.max(t.y,1)<<3)+Math.min(7,Math.round(i.y/10))}else n=Math.ceil(7*(t.x+450)),r=0;else n=0,r=+i;let o=i?this.centroidVertexArray.length:e.vertexArrayOffset;for(const t of e.polyCount){i&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*t.edges+t.top);for(let e=0;e<2*t.edges;e++)this.centroidVertexArray.emplace(o++,0,r),this.centroidVertexArray.emplace(o++,n,r);for(let e=0;e<t.top;e++)this.centroidVertexArray.emplace(o++,n,r)}}}function Tc(t,e){return t.x===e.x&&(t.x<0||t.x>_s)||t.y===e.y&&(t.y<0||t.y>_s)}zr("FillExtrusionBucket",Mc,{omit:["layers","features"]}),zr("PartMetadata",wc);var Sc={paint:new $o({"fill-extrusion-opacity":new Zo(xe["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Wo(xe["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Zo(xe["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Zo(xe["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new qo(xe["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Wo(xe["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Wo(xe["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Zo(xe["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})};function Ec(t,e){return t.x*e.x+t.y*e.y}function Cc(t,e){if(1===t.length){let i=0;const n=e[i++];let r;for(;!r||n.equals(r);)if(r=e[i++],!r)return 1/0;for(;i<e.length;i++){const o=e[i],a=t[0],s=r.sub(n),l=o.sub(n),c=a.sub(n),h=Ec(s,s),u=Ec(s,l),d=Ec(l,l),p=Ec(c,s),f=Ec(c,l),m=h*d-u*u,g=(d*p-u*f)/m,y=(h*f-u*p)/m,_=n.z*(1-g-y)+r.z*g+o.z*y;if(isFinite(_))return _}return 1/0}{let t=1/0;for(const i of e)t=Math.min(t,i.z);return t}}function Ac(t){const e=new o(t[0],t[1]);return e.z=t[2],e}function Pc(t,e,i,n,r,o,a,s){const l=a*r.getElevationAt(t,e,!0,!0),c=0!==o[0],h=c?0===o[1]?a*(o[0]/7-450):a*function(t,e,i){const n=Math.floor(e[0]/8),r=Math.floor(e[1]/8),o=10*(e[0]-8*n),a=10*(e[1]-8*r),s=t.getElevationAt(n,r,!0,!0),l=t.getMeterToDEM(i),c=Math.floor(.5*(o*l-1)),h=Math.floor(.5*(a*l-1)),u=t.tileCoordToPixel(n,r),d=2*c+1,p=2*h+1,f=function(t,e,i,n,r){return[t.getElevationAtPixel(e,i,!0),t.getElevationAtPixel(e+r,i,!0),t.getElevationAtPixel(e,i+r,!0),t.getElevationAtPixel(e+n,i+r,!0)]}(t,u.x-c,u.y-h,d,p),m=Math.abs(f[0]-f[1]),g=Math.abs(f[2]-f[3]),y=Math.abs(f[0]-f[2])+Math.abs(f[1]-f[3]),_=Math.min(.25,.5*l*(m+g)/d),v=Math.min(.25,.5*l*y/p);return s+Math.max(_*o,v*a)}(r,o,s):l;return{base:l+(0===i)?-1:i,top:c?Math.max(h+n,l+i+2):l+n}}const Lc=ea([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:Ic}=Lc,Rc=ea([{name:"a_packed",components:3,type:"Float32"}]),{members:Dc}=Rc,kc=_c.VectorTileFeature.types,Oc=Math.cos(Math.PI/180*37.5);class zc{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(t=>t.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(t=>{this.gradients[t.id]={}}),this.layoutVertexArray=new oa,this.layoutVertexArray2=new aa,this.indexArray=new ma,this.programConfigurations=new ss(t.layers,t.zoom),this.segments=new ys,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(t=>t.isStateDependent()).map(t=>t.id)}populate(t,e,i,n){this.hasPattern=ic("line",this.layers,e);const r=this.layers[0].layout.get("line-sort-key"),o=[];for(const{feature:e,id:a,index:s,sourceLayerIndex:l}of t){const t=this.layers[0]._featureFilter.needGeometry,c=Fs(e,t);if(!this.layers[0]._featureFilter.filter(new zo(this.zoom),c,i))continue;const h=r?r.evaluate(c,{},i):void 0,u={id:a,properties:e.properties,type:e.type,sourceLayerIndex:l,index:s,geometry:t?c.geometry:Bs(e,i,n),patterns:{},sortKey:h};o.push(u)}r&&o.sort((t,e)=>t.sortKey-e.sortKey);const{lineAtlas:a,featureIndex:s}=e,l=this.addConstantDashes(a);for(const n of o){const{geometry:r,index:o,sourceLayerIndex:c}=n;if(l&&this.addFeatureDashes(n,a),this.hasPattern){const t=nc("line",this.layers,n,this.zoom,e);this.patternFeatures.push(t)}else this.addFeature(n,r,o,i,a.positions,e.availableImages);s.insert(t[o].feature,r,o,c,this.index)}}addConstantDashes(t){let e=!1;for(const i of this.layers){const n=i.paint.get("line-dasharray").value,r=i.layout.get("line-cap").value;if("constant"!==n.kind||"constant"!==r.kind)e=!0;else{const e=r.value,i=n.value;if(!i)continue;t.addDash(i.from,e),t.addDash(i.to,e),i.other&&t.addDash(i.other,e)}}return e}addFeatureDashes(t,e){const i=this.zoom;for(const n of this.layers){const r=n.paint.get("line-dasharray").value,o=n.layout.get("line-cap").value;if("constant"===r.kind&&"constant"===o.kind)continue;let a,s,l,c,h,u;if("constant"===r.kind){const t=r.value;if(!t)continue;a=t.other||t.to,s=t.to,l=t.from}else a=r.evaluate({zoom:i-1},t),s=r.evaluate({zoom:i},t),l=r.evaluate({zoom:i+1},t);"constant"===o.kind?c=h=u=o.value:(c=o.evaluate({zoom:i-1},t),h=o.evaluate({zoom:i},t),u=o.evaluate({zoom:i+1},t)),e.addDash(a,c),e.addDash(s,h),e.addDash(l,u);const d=e.getKey(a,c),p=e.getKey(s,h),f=e.getKey(l,u);t.patterns[n.id]={min:d,mid:p,max:f}}}update(t,e,i,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers,i,n)}addFeatures(t,e,i,n){for(const t of this.patternFeatures)this.addFeature(t,t.geometry,t.index,e,i,n)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,Dc)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Ic),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&t.properties.hasOwnProperty("mapbox_clip_start")&&t.properties.hasOwnProperty("mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,e,i,n,r,o){const a=this.layers[0].layout,s=a.get("line-join").evaluate(t,{}),l=a.get("line-cap").evaluate(t,{}),c=a.get("line-miter-limit"),h=a.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const i of e)this.addLine(i,t,s,l,c,h);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,i,r,o,n)}addLine(t,e,i,n,r,o){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let e=0;e<t.length-1;e++)this.totalDistance+=t[e].dist(t[e+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const a="Polygon"===kc[e.type];let s=t.length;for(;s>=2&&t[s-1].equals(t[s-2]);)s--;let l=0;for(;l<s-1&&t[l].equals(t[l+1]);)l++;if(s<(a?3:2))return;"bevel"===i&&(r=1.05);const c=this.overscaling<=16?122880/(512*this.overscaling):0,h=this.segments.prepareSegment(10*s,this.layoutVertexArray,this.indexArray);let u,d,p,f,m;this.e1=this.e2=-1,a&&(u=t[s-2],m=t[l].sub(u)._unit()._perp());for(let e=l;e<s;e++){if(p=e===s-1?a?t[l+1]:void 0:t[e+1],p&&t[e].equals(p))continue;m&&(f=m),u&&(d=u),u=t[e],m=p?p.sub(u)._unit()._perp():f,f=f||m;let g=f.add(m);0===g.x&&0===g.y||g._unit();const y=f.x*m.x+f.y*m.y,_=g.x*m.x+g.y*m.y,v=0!==_?1/_:1/0,x=2*Math.sqrt(2-2*_),b=_<Oc&&d&&p,w=f.x*m.y-f.y*m.x>0;if(b&&e>l){const t=u.dist(d);if(t>2*c){const e=u.sub(u.sub(d)._mult(c/t)._round());this.updateDistance(d,e),this.addCurrentVertex(e,f,0,0,h),d=e}}const M=d&&p;let T=M?i:a?"butt":n;if(M&&"round"===T&&(v<o?T="miter":v<=2&&(T="fakeround")),"miter"===T&&v>r&&(T="bevel"),"bevel"===T&&(v>2&&(T="flipbevel"),v<r&&(T="miter")),d&&this.updateDistance(d,u),"miter"===T)g._mult(v),this.addCurrentVertex(u,g,0,0,h);else if("flipbevel"===T){if(v>100)g=m.mult(-1);else{const t=v*f.add(m).mag()/f.sub(m).mag();g._perp()._mult(t*(w?-1:1))}this.addCurrentVertex(u,g,0,0,h),this.addCurrentVertex(u,g.mult(-1),0,0,h)}else if("bevel"===T||"fakeround"===T){const t=-Math.sqrt(v*v-1),e=w?t:0,i=w?0:t;if(d&&this.addCurrentVertex(u,f,e,i,h),"fakeround"===T){const t=Math.round(180*x/Math.PI/20);for(let e=1;e<t;e++){let i=e/t;if(.5!==i){const t=i-.5;i+=i*t*(i-1)*((1.0904+y*(y*(3.55645-1.43519*y)-3.2452))*t*t+(.848013+y*(.215638*y-1.06021)))}const n=m.sub(f)._mult(i)._add(f)._unit()._mult(w?-1:1);this.addHalfVertex(u,n.x,n.y,!1,w,0,h)}}p&&this.addCurrentVertex(u,m,-e,-i,h)}else if("butt"===T)this.addCurrentVertex(u,g,0,0,h);else if("square"===T){const t=d?1:-1;d||this.addCurrentVertex(u,g,t,t,h),this.addCurrentVertex(u,g,0,0,h),d&&this.addCurrentVertex(u,g,t,t,h)}else"round"===T&&(d&&(this.addCurrentVertex(u,f,0,0,h),this.addCurrentVertex(u,f,1,1,h,!0)),p&&(this.addCurrentVertex(u,m,-1,-1,h,!0),this.addCurrentVertex(u,m,0,0,h)));if(b&&e<s-1){const t=u.dist(p);if(t>2*c){const e=u.add(p.sub(u)._mult(c/t)._round());this.updateDistance(u,e),this.addCurrentVertex(e,m,0,0,h),u=e}}}}addCurrentVertex(t,e,i,n,r,o=!1){const a=e.y*n-e.x,s=-e.y-e.x*n;this.addHalfVertex(t,e.x+e.y*i,e.y-e.x*i,o,!1,i,r),this.addHalfVertex(t,a,s,o,!0,-n,r)}addHalfVertex({x:t,y:e},i,n,r,o,a,s){this.layoutVertexArray.emplaceBack((t<<1)+(r?1:0),(e<<1)+(o?1:0),Math.round(63*i)+128,Math.round(63*n)+128,1+(0===a?0:a<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineSoFar);const l=s.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,l),s.primitiveLength++),o?this.e2=l:this.e1=l}updateScaledDistance(){if(this.lineClips){const t=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=t*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(t,e){this.distance+=t.dist(e),this.updateScaledDistance()}}zr("LineBucket",zc,{omit:["layers","patternFeatures"]});const Bc=new $o({"line-cap":new Wo(xe.layout_line["line-cap"]),"line-join":new Wo(xe.layout_line["line-join"]),"line-miter-limit":new Zo(xe.layout_line["line-miter-limit"]),"line-round-limit":new Zo(xe.layout_line["line-round-limit"]),"line-sort-key":new Wo(xe.layout_line["line-sort-key"])});var Fc={paint:new $o({"line-opacity":new Wo(xe.paint_line["line-opacity"]),"line-color":new Wo(xe.paint_line["line-color"]),"line-translate":new Zo(xe.paint_line["line-translate"]),"line-translate-anchor":new Zo(xe.paint_line["line-translate-anchor"]),"line-width":new Wo(xe.paint_line["line-width"]),"line-gap-width":new Wo(xe.paint_line["line-gap-width"]),"line-offset":new Wo(xe.paint_line["line-offset"]),"line-blur":new Wo(xe.paint_line["line-blur"]),"line-dasharray":new qo(xe.paint_line["line-dasharray"]),"line-pattern":new qo(xe.paint_line["line-pattern"]),"line-gradient":new Yo(xe.paint_line["line-gradient"])}),layout:Bc};const Nc=new class extends Wo{possiblyEvaluate(t,e){return e=new zo(Math.floor(e.zoom),{now:e.now,fadeDuration:e.fadeDuration,zoomHistory:e.zoomHistory,transition:e.transition}),super.possiblyEvaluate(t,e)}evaluate(t,e,i,n){return e=et({},e,{zoom:Math.floor(e.zoom)}),super.evaluate(t,e,i,n)}}(Fc.paint.properties["line-width"].specification);function jc(t,e){return e>0?e+2*t:t}Nc.useIntegerZoom=!0;const Gc=ea([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"},{name:"a_z_tile_anchor",components:4,type:"Int16"}],4),Uc=ea([{name:"a_projected_pos",components:3,type:"Float32"}],4);ea([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Vc=ea([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),Hc=ea([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);ea([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Zc=ea([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Wc=ea([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ea([{name:"triangle",components:3,type:"Uint16"}]),ea([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ea([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),ea([{type:"Float32",name:"offsetX"}]),ea([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);const qc=128;function Xc(t,e){const{expression:i}=e;if("constant"===i.kind)return{kind:"constant",layoutSize:i.evaluate(new zo(t+1))};if("source"===i.kind)return{kind:"source"};{const{zoomStops:e,interpolationType:n}=i;let r=0;for(;r<e.length&&e[r]<=t;)r++;r=Math.max(0,r-1);let o=r;for(;o<e.length&&e[o]<t+1;)o++;o=Math.min(e.length-1,o);const a=e[r],s=e[o];return"composite"===i.kind?{kind:"composite",minZoom:a,maxZoom:s,interpolationType:n}:{kind:"camera",minZoom:a,maxZoom:s,minSize:i.evaluate(new zo(a)),maxSize:i.evaluate(new zo(s)),interpolationType:n}}}function Yc(t,{uSize:e,uSizeT:i},{lowerSize:n,upperSize:r}){return"source"===t.kind?n/qc:"composite"===t.kind?Bi(n/qc,r/qc,i):e}function $c(t,e){let i=0,n=0;if("constant"===t.kind)n=t.layoutSize;else if("source"!==t.kind){const{interpolationType:r,minZoom:o,maxZoom:a}=t,s=r?$(Ki.interpolationFactor(r,e,o,a),0,1):0;"camera"===t.kind?n=Bi(t.minSize,t.maxSize,s):i=s}return{uSizeT:i,uSize:n}}var Jc=Object.freeze({__proto__:null,getSizeData:Xc,evaluateSizeForFeature:Yc,evaluateSizeForZoom:$c,SIZE_PACK_FACTOR:qc});function Kc(t,e,i){return t.sections.forEach(t=>{t.text=function(t,e,i){const n=e.layout.get("text-transform").evaluate(i,{});return"uppercase"===n?t=t.toLocaleUpperCase():"lowercase"===n&&(t=t.toLocaleLowerCase()),Oo.applyArabicShaping&&(t=Oo.applyArabicShaping(t)),t}(t.text,e,i)}),t}const Qc={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};function th(t){return"︶"===t||"﹈"===t||"︸"===t||"﹄"===t||"﹂"===t||"︾"===t||"︼"===t||"︺"===t||"︘"===t||"﹀"===t||"︐"===t||"︓"===t||"︔"===t||"｀"===t||"￣"===t||"︑"===t||"︒"===t}function eh(t){return"︵"===t||"﹇"===t||"︷"===t||"﹃"===t||"﹁"===t||"︽"===t||"︻"===t||"︹"===t||"︗"===t||"︿"===t}var ih=function(t,e,i,n,r){var o,a,s=8*r-n-1,l=(1<<s)-1,c=l>>1,h=-7,u=i?r-1:0,d=i?-1:1,p=t[e+u];for(u+=d,o=p&(1<<-h)-1,p>>=-h,h+=s;h>0;o=256*o+t[e+u],u+=d,h-=8);for(a=o&(1<<-h)-1,o>>=-h,h+=n;h>0;a=256*a+t[e+u],u+=d,h-=8);if(0===o)o=1-c;else{if(o===l)return a?NaN:1/0*(p?-1:1);a+=Math.pow(2,n),o-=c}return(p?-1:1)*a*Math.pow(2,o-n)},nh=function(t,e,i,n,r,o){var a,s,l,c=8*o-r-1,h=(1<<c)-1,u=h>>1,d=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:o-1,f=n?1:-1,m=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,a=h):(a=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-a))<1&&(a--,l*=2),(e+=a+u>=1?d/l:d*Math.pow(2,1-u))*l>=2&&(a++,l/=2),a+u>=h?(s=0,a=h):a+u>=1?(s=(e*l-1)*Math.pow(2,r),a+=u):(s=e*Math.pow(2,u-1)*Math.pow(2,r),a=0));r>=8;t[i+p]=255&s,p+=f,s/=256,r-=8);for(a=a<<r|s,c+=r;c>0;t[i+p]=255&a,p+=f,a/=256,c-=8);t[i+p-f]|=128*m},rh=oh;function oh(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}oh.Varint=0,oh.Fixed64=1,oh.Bytes=2,oh.Fixed32=5;var ah=4294967296,sh=1/ah,lh="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function ch(t){return t.type===oh.Bytes?t.readVarint()+t.pos:t.pos+1}function hh(t,e,i){return i?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function uh(t,e,i){var n=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(n);for(var r=i.pos-1;r>=t;r--)i.buf[r+n]=i.buf[r]}function dh(t,e){for(var i=0;i<t.length;i++)e.writeVarint(t[i])}function ph(t,e){for(var i=0;i<t.length;i++)e.writeSVarint(t[i])}function fh(t,e){for(var i=0;i<t.length;i++)e.writeFloat(t[i])}function mh(t,e){for(var i=0;i<t.length;i++)e.writeDouble(t[i])}function gh(t,e){for(var i=0;i<t.length;i++)e.writeBoolean(t[i])}function yh(t,e){for(var i=0;i<t.length;i++)e.writeFixed32(t[i])}function _h(t,e){for(var i=0;i<t.length;i++)e.writeSFixed32(t[i])}function vh(t,e){for(var i=0;i<t.length;i++)e.writeFixed64(t[i])}function xh(t,e){for(var i=0;i<t.length;i++)e.writeSFixed64(t[i])}function bh(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function wh(t,e,i){t[i]=e,t[i+1]=e>>>8,t[i+2]=e>>>16,t[i+3]=e>>>24}function Mh(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}function Th(t,e,i){e.glyphs=[],1===t&&i.readMessage(Sh,e)}function Sh(t,e,i){if(3===t){const{id:t,bitmap:n,width:r,height:o,left:a,top:s,advance:l}=i.readMessage(Eh,{});e.glyphs.push({id:t,bitmap:new gl({width:r+6,height:o+6},n),metrics:{width:r,height:o,left:a,top:s,advance:l}})}else 4===t?e.ascender=i.readSVarint():5===t&&(e.descender=i.readSVarint())}function Eh(t,e,i){1===t?e.id=i.readVarint():2===t?e.bitmap=i.readBytes():3===t?e.width=i.readVarint():4===t?e.height=i.readVarint():5===t?e.left=i.readSVarint():6===t?e.top=i.readSVarint():7===t&&(e.advance=i.readVarint())}function Ch(t){let e=0,i=0;for(const n of t)e+=n.w*n.h,i=Math.max(i,n.w);t.sort((t,e)=>e.h-t.h);const n=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let r=0,o=0;for(const e of t)for(let t=n.length-1;t>=0;t--){const i=n[t];if(!(e.w>i.w||e.h>i.h)){if(e.x=i.x,e.y=i.y,o=Math.max(o,e.y+e.h),r=Math.max(r,e.x+e.w),e.w===i.w&&e.h===i.h){const e=n.pop();t<n.length&&(n[t]=e)}else e.h===i.h?(i.x+=e.w,i.w-=e.w):e.w===i.w?(i.y+=e.h,i.h-=e.h):(n.push({x:i.x+e.w,y:i.y,w:i.w-e.w,h:e.h}),i.y+=e.h,i.h-=e.h);break}}return{w:r,h:o,fill:e/(r*o)||0}}oh.prototype={destroy:function(){this.buf=null},readFields:function(t,e,i){for(i=i||this.length;this.pos<i;){var n=this.readVarint(),r=n>>3,o=this.pos;this.type=7&n,t(r,e,this),this.pos===o&&this.skip(n)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=bh(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=Mh(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=bh(this.buf,this.pos)+bh(this.buf,this.pos+4)*ah;return this.pos+=8,t},readSFixed64:function(){var t=bh(this.buf,this.pos)+Mh(this.buf,this.pos+4)*ah;return this.pos+=8,t},readFloat:function(){var t=ih(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=ih(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,i,n=this.buf;return e=127&(i=n[this.pos++]),i<128?e:(e|=(127&(i=n[this.pos++]))<<7,i<128?e:(e|=(127&(i=n[this.pos++]))<<14,i<128?e:(e|=(127&(i=n[this.pos++]))<<21,i<128?e:function(t,e,i){var n,r,o=i.buf;if(n=(112&(r=o[i.pos++]))>>4,r<128)return hh(t,n,e);if(n|=(127&(r=o[i.pos++]))<<3,r<128)return hh(t,n,e);if(n|=(127&(r=o[i.pos++]))<<10,r<128)return hh(t,n,e);if(n|=(127&(r=o[i.pos++]))<<17,r<128)return hh(t,n,e);if(n|=(127&(r=o[i.pos++]))<<24,r<128)return hh(t,n,e);if(n|=(1&(r=o[i.pos++]))<<31,r<128)return hh(t,n,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(i=n[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&lh?function(t,e,i){return lh.decode(t.subarray(e,i))}(this.buf,e,t):function(t,e,i){for(var n="",r=e;r<i;){var o,a,s,l=t[r],c=null,h=l>239?4:l>223?3:l>191?2:1;if(r+h>i)break;1===h?l<128&&(c=l):2===h?128==(192&(o=t[r+1]))&&(c=(31&l)<<6|63&o)<=127&&(c=null):3===h?(a=t[r+2],128==(192&(o=t[r+1]))&&128==(192&a)&&((c=(15&l)<<12|(63&o)<<6|63&a)<=2047||c>=55296&&c<=57343)&&(c=null)):4===h&&(a=t[r+2],s=t[r+3],128==(192&(o=t[r+1]))&&128==(192&a)&&128==(192&s)&&((c=(15&l)<<18|(63&o)<<12|(63&a)<<6|63&s)<=65535||c>=1114112)&&(c=null)),null===c?(c=65533,h=1):c>65535&&(c-=65536,n+=String.fromCharCode(c>>>10&1023|55296),c=56320|1023&c),n+=String.fromCharCode(c),r+=h}return n}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==oh.Bytes)return t.push(this.readVarint(e));var i=ch(this);for(t=t||[];this.pos<i;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==oh.Bytes)return t.push(this.readSVarint());var e=ch(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==oh.Bytes)return t.push(this.readBoolean());var e=ch(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==oh.Bytes)return t.push(this.readFloat());var e=ch(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==oh.Bytes)return t.push(this.readDouble());var e=ch(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==oh.Bytes)return t.push(this.readFixed32());var e=ch(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==oh.Bytes)return t.push(this.readSFixed32());var e=ch(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==oh.Bytes)return t.push(this.readFixed64());var e=ch(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==oh.Bytes)return t.push(this.readSFixed64());var e=ch(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===oh.Varint)for(;this.buf[this.pos++]>127;);else if(e===oh.Bytes)this.pos=this.readVarint()+this.pos;else if(e===oh.Fixed32)this.pos+=4;else{if(e!==oh.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),wh(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),wh(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),wh(this.buf,-1&t,this.pos),wh(this.buf,Math.floor(t*sh),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),wh(this.buf,-1&t,this.pos),wh(this.buf,Math.floor(t*sh),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var i,n;if(t>=0?(i=t%4294967296|0,n=t/4294967296|0):(n=~(-t/4294967296),4294967295^(i=~(-t%4294967296))?i=i+1|0:(i=0,n=n+1|0)),t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,i){i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,i.buf[i.pos]=127&(t>>>=7)}(i,0,e),function(t,e){var i=(7&t)<<4;e.buf[e.pos++]|=i|((t>>>=3)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t)))))}(n,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,i){for(var n,r,o=0;o<e.length;o++){if((n=e.charCodeAt(o))>55295&&n<57344){if(!r){n>56319||o+1===e.length?(t[i++]=239,t[i++]=191,t[i++]=189):r=n;continue}if(n<56320){t[i++]=239,t[i++]=191,t[i++]=189,r=n;continue}n=r-55296<<10|n-56320|65536,r=null}else r&&(t[i++]=239,t[i++]=191,t[i++]=189,r=null);n<128?t[i++]=n:(n<2048?t[i++]=n>>6|192:(n<65536?t[i++]=n>>12|224:(t[i++]=n>>18|240,t[i++]=n>>12&63|128),t[i++]=n>>6&63|128),t[i++]=63&n|128)}return i}(this.buf,t,this.pos);var i=this.pos-e;i>=128&&uh(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i},writeFloat:function(t){this.realloc(4),nh(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),nh(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var i=0;i<e;i++)this.buf[this.pos++]=t[i]},writeRawMessage:function(t,e){this.pos++;var i=this.pos;t(e,this);var n=this.pos-i;n>=128&&uh(i,n,this),this.pos=i-1,this.writeVarint(n),this.pos+=n},writeMessage:function(t,e,i){this.writeTag(t,oh.Bytes),this.writeRawMessage(e,i)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,dh,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,ph,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,gh,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,fh,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,mh,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,yh,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,_h,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,vh,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,xh,e)},writeBytesField:function(t,e){this.writeTag(t,oh.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,oh.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,oh.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,oh.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,oh.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,oh.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,oh.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,oh.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,oh.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,oh.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}};class Ah{constructor(t,{pixelRatio:e,version:i,stretchX:n,stretchY:r,content:o}){this.paddedRect=t,this.pixelRatio=e,this.stretchX=n,this.stretchY=r,this.content=o,this.version=i}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Ph{constructor(t,e){const i={},n={};this.haveRenderCallbacks=[];const r=[];this.addImages(t,i,r),this.addImages(e,n,r);const{w:o,h:a}=Ch(r),s=new yl({width:o||1,height:a||1});for(const e in t){const n=t[e],r=i[e].paddedRect;yl.copy(n.data,s,{x:0,y:0},{x:r.x+1,y:r.y+1},n.data)}for(const t in e){const i=e[t],r=n[t].paddedRect,o=r.x+1,a=r.y+1,l=i.data.width,c=i.data.height;yl.copy(i.data,s,{x:0,y:0},{x:o,y:a},i.data),yl.copy(i.data,s,{x:0,y:c-1},{x:o,y:a-1},{width:l,height:1}),yl.copy(i.data,s,{x:0,y:0},{x:o,y:a+c},{width:l,height:1}),yl.copy(i.data,s,{x:l-1,y:0},{x:o-1,y:a},{width:1,height:c}),yl.copy(i.data,s,{x:0,y:0},{x:o+l,y:a},{width:1,height:c})}this.image=s,this.iconPositions=i,this.patternPositions=n}addImages(t,e,i){for(const n in t){const r=t[n],o={x:0,y:0,w:r.data.width+2,h:r.data.height+2};i.push(o),e[n]=new Ah(o,r),r.hasRenderCallback&&this.haveRenderCallbacks.push(n)}}patchUpdatedImages(t,e){t.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const i in t.updatedImages)this.patchUpdatedImage(this.iconPositions[i],t.getImage(i),e),this.patchUpdatedImage(this.patternPositions[i],t.getImage(i),e)}patchUpdatedImage(t,e,i){if(!t||!e)return;if(t.version===e.version)return;t.version=e.version;const[n,r]=t.tl;i.update(e.data,void 0,{x:n,y:r})}}zr("ImagePosition",Ah),zr("ImageAtlas",Ph);const Lh={horizontal:1,vertical:2,horizontalOnly:3};class Ih{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,e){const i=new Ih;return i.scale=t||1,i.fontStack=e,i}static forImage(t){const e=new Ih;return e.imageName=t,e}}class Rh{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,e){const i=new Rh;for(let n=0;n<t.sections.length;n++){const r=t.sections[n];r.image?i.addImageSection(r):i.addTextSection(r,e)}return i}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCharCode(t){return this.text.charCodeAt(t)}verticalizePunctuation(t){this.text=function(t,e){let i="";for(let n=0;n<t.length;n++){const r=t.charCodeAt(n+1)||null,o=t.charCodeAt(n-1)||null;i+=!e&&(r&&xo(r)&&!Qc[t[n+1]]||o&&xo(o)&&!Qc[t[n-1]])||!Qc[t[n]]?t[n]:Qc[t[n]]}return i}(this.text,t)}trim(){let t=0;for(let e=0;e<this.text.length&&kh[this.text.charCodeAt(e)];e++)t++;let e=this.text.length;for(let i=this.text.length-1;i>=0&&i>=t&&kh[this.text.charCodeAt(i)];i--)e--;this.text=this.text.substring(t,e),this.sectionIndex=this.sectionIndex.slice(t,e)}substring(t,e){const i=new Rh;return i.text=this.text.substring(t,e),i.sectionIndex=this.sectionIndex.slice(t,e),i.sections=this.sections,i}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,e)=>Math.max(t,this.sections[e].scale),0)}addTextSection(t,e){this.text+=t.text,this.sections.push(Ih.forText(t.scale,t.fontStack||e));const i=this.sections.length-1;for(let e=0;e<t.text.length;++e)this.sectionIndex.push(i)}addImageSection(t){const e=t.image?t.image.name:"";if(0===e.length)return void pt("Can't add FormattedSection with an empty image.");const i=this.getNextImageSectionCharCode();i?(this.text+=String.fromCharCode(i),this.sections.push(Ih.forImage(e)),this.sectionIndex.push(this.sections.length-1)):pt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Dh(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m){const g=Rh.fromFeature(t,r);let y;u===Lh.vertical&&g.verticalizePunctuation(d);const{processBidirectionalText:_,processStyledBidirectionalText:v}=Oo;if(_&&1===g.sections.length){y=[];const t=_(g.toString(),jh(g,c,o,e,n,p,f));for(const e of t){const t=new Rh;t.text=e,t.sections=g.sections;for(let i=0;i<e.length;i++)t.sectionIndex.push(0);y.push(t)}}else if(v){y=[];const t=v(g.text,g.sectionIndex,jh(g,c,o,e,n,p,f));for(const e of t){const t=new Rh;t.text=e[0],t.sectionIndex=e[1],t.sections=g.sections,y.push(t)}}else y=function(t,e){const i=[],n=t.text;let r=0;for(const n of e)i.push(t.substring(r,n)),r=n;return r<n.length&&i.push(t.substring(r,n.length)),i}(g,jh(g,c,o,e,n,p,f));const x=[],b={positionedLines:x,text:g.toString(),top:h[1],bottom:h[1],left:h[0],right:h[0],writingMode:u,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(t,e,i,n,r,o,a,s,l,c,h,u){let d=0,p=0,f=0;const m="right"===s?1:"left"===s?0:.5;let g=!1;for(const t of r){const i=t.getSections();for(const t of i){if(t.imageName)continue;const i=e[t.fontStack];if(i&&(g=void 0!==i.ascender&&void 0!==i.descender,!g))break}if(!g)break}let y=0;for(const a of r){a.trim();const r=a.getMaxScale(),s=24*(r-1),v={positionedGlyphs:[],lineOffset:0};t.positionedLines[y]=v;const x=v.positionedGlyphs;let b=0;if(!a.length()){p+=o,++y;continue}let w=0,M=0;for(let o=0;o<a.length();o++){const s=a.getSection(o),f=a.getSectionIndex(o),m=a.getCharCode(o);let y=s.scale,v=null,T=null,S=null,E=24,C=0;const A=!(l===Lh.horizontal||!h&&!vo(m)||h&&(kh[m]||(_=m,Ur(_)||Vr(_)||Hr(_)||co(_)||fo(_))));if(s.imageName){const e=n[s.imageName];if(!e)continue;S=s.imageName,t.iconsInText=t.iconsInText||!0,T=e.paddedRect;const i=e.displaySize;y=24*y/u,v={width:i[0],height:i[1],left:1,top:-3,advance:A?i[1]:i[0],localGlyph:!1},C=g?-v.height*y:24*r-17-i[1]*y,E=v.advance;const o=(A?i[0]:i[1])*y-24*r;o>0&&o>b&&(b=o)}else{const t=i[s.fontStack];if(!t)continue;t[m]&&(T=t[m]);const n=e[s.fontStack];if(!n)continue;const o=n.glyphs[m];if(!o)continue;if(v=o.metrics,E=8203!==m?24:0,g){const t=void 0!==n.ascender?Math.abs(n.ascender):0,e=void 0!==n.descender?Math.abs(n.descender):0,i=(t+e)*y;w<i&&(w=i,M=(t-e)/2*y),C=-t*y}else C=24*(r-y)-17}A?(t.verticalizable=!0,x.push({glyph:m,imageName:S,x:d,y:p+C,vertical:A,scale:y,localGlyph:v.localGlyph,fontStack:s.fontStack,sectionIndex:f,metrics:v,rect:T}),d+=E*y+c):(x.push({glyph:m,imageName:S,x:d,y:p+C,vertical:A,scale:y,localGlyph:v.localGlyph,fontStack:s.fontStack,sectionIndex:f,metrics:v,rect:T}),d+=v.advance*y+c)}0!==x.length&&(f=Math.max(d-c,f),g?Uh(x,m,b,M,o*r/2):Uh(x,m,b,0,o/2)),d=0;const T=o*r+b;v.lineOffset=Math.max(b,s),p+=T,++y}var _;const v=p,{horizontalAlign:x,verticalAlign:b}=Gh(a);(function(t,e,i,n,r,o){const a=(e-i)*r,s=-o*n;for(const e of t)for(const t of e.positionedGlyphs)t.x+=a,t.y+=s})(t.positionedLines,m,x,b,f,v),t.top+=-b*v,t.bottom=t.top+v,t.left+=-x*f,t.right=t.left+f,t.hasBaseline=g}(b,e,i,n,y,a,s,l,u,c,d,m),!function(t){for(const e of t)if(0!==e.positionedGlyphs.length)return!1;return!0}(x)&&b}const kh={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Oh={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function zh(t,e,i,n,r,o){if(e.imageName){const t=n[e.imageName];return t?t.displaySize[0]*e.scale*24/o+r:0}{const n=i[e.fontStack],o=n&&n.glyphs[t];return o?o.metrics.advance*e.scale+r:0}}function Bh(t,e,i,n){const r=Math.pow(t-e,2);return n?t<e?r/2:2*r:r+Math.abs(i)*i}function Fh(t,e,i){let n=0;return 10===t&&(n-=1e4),i&&(n+=150),40!==t&&65288!==t||(n+=50),41!==e&&65289!==e||(n+=50),n}function Nh(t,e,i,n,r,o){let a=null,s=Bh(e,i,r,o);for(const t of n){const n=Bh(e-t.x,i,r,o)+t.badness;n<=s&&(a=t,s=n)}return{index:t,x:e,priorBreak:a,badness:s}}function jh(t,e,i,n,r,o,a){if("point"!==o)return[];if(!t)return[];const s=[],l=function(t,e,i,n,r,o){let a=0;for(let i=0;i<t.length();i++){const s=t.getSection(i);a+=zh(t.getCharCode(i),s,n,r,e,o)}return a/Math.max(1,Math.ceil(a/i))}(t,e,i,n,r,a),c=t.text.indexOf("​")>=0;let h=0;for(let i=0;i<t.length();i++){const o=t.getSection(i),d=t.getCharCode(i);if(kh[d]||(h+=zh(d,o,n,r,e,a)),i<t.length()-1){const e=!((u=d)<11904||!(Kr(u)||Jr(u)||uo(u)||lo(u)||io(u)||Zr(u)||Qr(u)||Xr(u)||no(u)||ro(u)||eo(u)||mo(u)||Yr(u)||qr(u)||Wr(u)||to(u)||$r(u)||ho(u)||ao(u)||oo(u)));(Oh[d]||e||o.imageName)&&s.push(Nh(i+1,h,l,s,Fh(d,t.getCharCode(i+1),e&&c),!1))}}var u;return function t(e){return e?t(e.priorBreak).concat(e.index):[]}(Nh(t.length(),h,l,s,0,!0))}function Gh(t){let e=.5,i=.5;switch(t){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(t){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function Uh(t,e,i,n,r){if(!(e||i||n||r))return;const o=t.length-1,a=t[o],s=(a.x+a.metrics.advance*a.scale)*e;for(let e=0;e<=o;e++)t[e].x-=s,t[e].y+=i+n+r}function Vh(t,e,i){const{horizontalAlign:n,verticalAlign:r}=Gh(i),o=e[0]-t.displaySize[0]*n,a=e[1]-t.displaySize[1]*r;return{image:t,top:a,bottom:a+t.displaySize[1],left:o,right:o+t.displaySize[0]}}function Hh(t,e,i,n,r,o){const a=t.image;let s;if(a.content){const t=a.content,e=a.pixelRatio||1;s=[t[0]/e,t[1]/e,a.displaySize[0]-t[2]/e,a.displaySize[1]-t[3]/e]}const l=e.left*o,c=e.right*o;let h,u,d,p;"width"===i||"both"===i?(p=r[0]+l-n[3],u=r[0]+c+n[1]):(p=r[0]+(l+c-a.displaySize[0])/2,u=p+a.displaySize[0]);const f=e.top*o,m=e.bottom*o;return"height"===i||"both"===i?(h=r[1]+f-n[0],d=r[1]+m+n[2]):(h=r[1]+(f+m-a.displaySize[1])/2,d=h+a.displaySize[1]),{image:a,top:h,right:u,bottom:d,left:p,collisionPadding:s}}class Zh extends o{constructor(t,e,i,n,r){super(t,e),this.angle=n,this.z=i,void 0!==r&&(this.segment=r)}clone(){return new Zh(this.x,this.y,this.z,this.angle,this.segment)}}function Wh(t,e,i,n,r){if(void 0===e.segment)return!0;let o=e,a=e.segment+1,s=0;for(;s>-i/2;){if(a--,a<0)return!1;s-=t[a].dist(o),o=t[a]}s+=t[a].dist(t[a+1]),a++;const l=[];let c=0;for(;s<i/2;){const e=t[a],i=t[a+1];if(!i)return!1;let o=t[a-1].angleTo(e)-e.angleTo(i);for(o=Math.abs((o+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:s,angleDelta:o}),c+=o;s-l[0].distance>n;)c-=l.shift().angleDelta;if(c>r)return!1;a++,s+=e.dist(i)}return!0}function qh(t){let e=0;for(let i=0;i<t.length-1;i++)e+=t[i].dist(t[i+1]);return e}function Xh(t,e,i){return t?.6*e*i:0}function Yh(t,e){return Math.max(t?t.right-t.left:0,e?e.right-e.left:0)}function $h(t,e,i,n,r,o){const a=Xh(i,r,o),s=Yh(i,n)*o;let l=0;const c=qh(t)/2;for(let i=0;i<t.length-1;i++){const n=t[i],r=t[i+1],o=n.dist(r);if(l+o>c){const h=(c-l)/o,u=Bi(n.x,r.x,h),d=Bi(n.y,r.y,h),p=new Zh(u,d,0,r.angleTo(n),i);return!a||Wh(t,p,s,a,e)?p:void 0}l+=o}}function Jh(t,e,i,n,r,o,a,s,l){const c=Xh(n,o,a),h=Yh(n,r),u=h*a,d=0===t[0].x||t[0].x===l||0===t[0].y||t[0].y===l;return e-u<e/4&&(e=u+e/4),function t(e,i,n,r,o,a,s,l,c){const h=a/2,u=qh(e);let d=0,p=i-n,f=[];for(let t=0;t<e.length-1;t++){const i=e[t],s=e[t+1],l=i.dist(s),m=s.angleTo(i);for(;p+n<d+l;){p+=n;const g=(p-d)/l,y=Bi(i.x,s.x,g),_=Bi(i.y,s.y,g);if(y>=0&&y<c&&_>=0&&_<c&&p-h>=0&&p+h<=u){const i=new Zh(y,_,0,m,t);i._round(),r&&!Wh(e,i,a,r,o)||f.push(i)}}d+=l}return l||f.length||s||(f=t(e,d/2,n,r,o,a,s,!0,c)),f}(t,d?e/2*s%e:(h/2+2*o)*a*s%e,e,c,i,u,d,!1,l)}function Kh(t,e,i,n,r){const a=[];for(let s=0;s<t.length;s++){const l=t[s];let c;for(let t=0;t<l.length-1;t++){let s=l[t],h=l[t+1];s.x<e&&h.x<e||(s.x<e?s=new o(e,s.y+(e-s.x)/(h.x-s.x)*(h.y-s.y))._round():h.x<e&&(h=new o(e,s.y+(e-s.x)/(h.x-s.x)*(h.y-s.y))._round()),s.y<i&&h.y<i||(s.y<i?s=new o(s.x+(i-s.y)/(h.y-s.y)*(h.x-s.x),i)._round():h.y<i&&(h=new o(s.x+(i-s.y)/(h.y-s.y)*(h.x-s.x),i)._round()),s.x>=n&&h.x>=n||(s.x>=n?s=new o(n,s.y+(n-s.x)/(h.x-s.x)*(h.y-s.y))._round():h.x>=n&&(h=new o(n,s.y+(n-s.x)/(h.x-s.x)*(h.y-s.y))._round()),s.y>=r&&h.y>=r||(s.y>=r?s=new o(s.x+(r-s.y)/(h.y-s.y)*(h.x-s.x),r)._round():h.y>=r&&(h=new o(s.x+(r-s.y)/(h.y-s.y)*(h.x-s.x),r)._round()),c&&s.equals(c[c.length-1])||(c=[s],a.push(c)),c.push(h)))))}}return a}zr("Anchor",Zh);const Qh=1e20;function tu(t,e,i,n,r,o,a,s,l){for(let c=e;c<e+n;c++)eu(t,i*o+c,o,r,a,s,l);for(let c=i;c<i+r;c++)eu(t,c*o+e,1,n,a,s,l)}function eu(t,e,i,n,r,o,a){o[0]=0,a[0]=-Qh,a[1]=Qh,r[0]=t[e];for(let s=1,l=0,c=0;s<n;s++){r[s]=t[e+s*i];const n=s*s;do{const t=o[l];c=(r[s]-r[t]+n-t*t)/(s-t)/2}while(c<=a[l]&&--l>-1);l++,o[l]=s,a[l]=c,a[l+1]=Qh}for(let s=0,l=0;s<n;s++){for(;a[l+1]<s;)l++;const n=o[l],c=s-n;t[e+s*i]=r[n]+c*c}}const iu={none:0,ideographs:1,all:2};class nu{constructor(t,e,i){this.requestManager=t,this.localGlyphMode=e,this.localFontFamily=i,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t){this.url=t}getGlyphs(t,e){const i=[];for(const e in t)for(const n of t[e])i.push({stack:e,id:n});Q(i,({stack:t,id:e},i)=>{let n=this.entries[t];n||(n=this.entries[t]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let r=n.glyphs[e];if(void 0!==r)return void i(null,{stack:t,id:e,glyph:r});if(r=this._tinySDF(n,t,e),r)return n.glyphs[e]=r,void i(null,{stack:t,id:e,glyph:r});const o=Math.floor(e/256);if(256*o>65535)return void i(new Error("glyphs > 65535 not supported"));if(n.ranges[o])return void i(null,{stack:t,id:e,glyph:r});let a=n.requests[o];a||(a=n.requests[o]=[],nu.loadGlyphRange(t,o,this.url,this.requestManager,(t,e)=>{if(e){n.ascender=e.ascender,n.descender=e.descender;for(const t in e.glyphs)this._doesCharSupportLocalGlyph(+t)||(n.glyphs[+t]=e.glyphs[+t]);n.ranges[o]=!0}for(const i of a)i(t,e);delete n.requests[o]})),a.push((n,r)=>{n?i(n):r&&i(null,{stack:t,id:e,glyph:r.glyphs[e]||null})})},(t,i)=>{if(t)e(t);else if(i){const t={};for(const{stack:e,id:n,glyph:r}of i)void 0===t[e]&&(t[e]={}),void 0===t[e].glyphs&&(t[e].glyphs={}),t[e].glyphs[n]=r&&{id:r.id,bitmap:r.bitmap.clone(),metrics:r.metrics},t[e].ascender=this.entries[e].ascender,t[e].descender=this.entries[e].descender;e(null,t)}})}_doesCharSupportLocalGlyph(t){return this.localGlyphMode!==iu.none&&(this.localGlyphMode===iu.all?!!this.localFontFamily:!!this.localFontFamily&&(ro(t)||so(t)||Yr(t)||$r(t))||Xr(t))}_tinySDF(t,e,i){const n=this.localFontFamily;if(!n||!this._doesCharSupportLocalGlyph(i))return;let r=t.tinySDF;if(!r){let i="400";/bold/i.test(e)?i="900":/medium/i.test(e)?i="500":/light/i.test(e)&&(i="200"),r=t.tinySDF=new nu.TinySDF({fontFamily:n,fontWeight:i,fontSize:48,buffer:6,radius:16}),r.fontWeight=i}if(this.localGlyphs[r.fontWeight][i])return this.localGlyphs[r.fontWeight][i];const o=String.fromCharCode(i),{data:a,width:s,height:l,glyphWidth:c,glyphHeight:h,glyphLeft:u,glyphTop:d,glyphAdvance:p}=r.draw(o);return this.localGlyphs[r.fontWeight][i]={id:i,bitmap:new gl({width:s,height:l},a),metrics:{width:c/2,height:h/2,left:u/2,top:d/2-27,advance:p/2,localGlyph:!0}}}}function ru(t,e,i,n){const r=[],a=t.image,s=a.pixelRatio,l=a.paddedRect.w-2,c=a.paddedRect.h-2,h=t.right-t.left,u=t.bottom-t.top,d=a.stretchX||[[0,l]],p=a.stretchY||[[0,c]],f=(t,e)=>t+e[1]-e[0],m=d.reduce(f,0),g=p.reduce(f,0),y=l-m,_=c-g;let v=0,x=m,b=0,w=g,M=0,T=y,S=0,E=_;if(a.content&&n){const t=a.content;v=ou(d,0,t[0]),b=ou(p,0,t[1]),x=ou(d,t[0],t[2]),w=ou(p,t[1],t[3]),M=t[0]-v,S=t[1]-b,T=t[2]-t[0]-x,E=t[3]-t[1]-w}const C=(n,r,l,c)=>{const d=su(n.stretch-v,x,h,t.left),p=lu(n.fixed-M,T,n.stretch,m),f=su(r.stretch-b,w,u,t.top),y=lu(r.fixed-S,E,r.stretch,g),_=su(l.stretch-v,x,h,t.left),C=lu(l.fixed-M,T,l.stretch,m),A=su(c.stretch-b,w,u,t.top),P=lu(c.fixed-S,E,c.stretch,g),L=new o(d,f),I=new o(_,f),R=new o(_,A),D=new o(d,A),k=new o(p/s,y/s),O=new o(C/s,P/s),z=e*Math.PI/180;if(z){const t=Math.sin(z),e=Math.cos(z),i=[e,-t,t,e];L._matMult(i),I._matMult(i),D._matMult(i),R._matMult(i)}const B=n.stretch+n.fixed,F=r.stretch+r.fixed;return{tl:L,tr:I,bl:D,br:R,tex:{x:a.paddedRect.x+1+B,y:a.paddedRect.y+1+F,w:l.stretch+l.fixed-B,h:c.stretch+c.fixed-F},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:k,pixelOffsetBR:O,minFontScaleX:T/s/h,minFontScaleY:E/s/u,isSDF:i}};if(n&&(a.stretchX||a.stretchY)){const t=au(d,y,m),e=au(p,_,g);for(let i=0;i<t.length-1;i++){const n=t[i],o=t[i+1];for(let t=0;t<e.length-1;t++)r.push(C(n,e[t],o,e[t+1]))}}else r.push(C({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:l+1},{fixed:0,stretch:c+1}));return r}function ou(t,e,i){let n=0;for(const r of t)n+=Math.max(e,Math.min(i,r[1]))-Math.max(e,Math.min(i,r[0]));return n}function au(t,e,i){const n=[{fixed:-1,stretch:0}];for(const[e,i]of t){const t=n[n.length-1];n.push({fixed:e-t.stretch,stretch:t.stretch}),n.push({fixed:e-t.stretch,stretch:t.stretch+(i-e)})}return n.push({fixed:e+1,stretch:i}),n}function su(t,e,i,n){return t/e*i+n}function lu(t,e,i,n){return t-e*i/n}function cu(t,e,i,n){const r=e+t.positionedLines[n].lineOffset;return 0===n?i+r/2:i+(r+(e+t.positionedLines[n-1].lineOffset))/2}nu.loadGlyphRange=function(t,e,i,n,r){const o=256*e,a=o+255,s=n.transformRequest(n.normalizeGlyphsURL(i).replace("{fontstack}",t).replace("{range}",`${o}-${a}`),ne.Glyphs);se(s,(t,e)=>{if(t)r(t);else if(e){const t={},i=function(t){return new rh(t).readFields(Th,{})}(e);for(const e of i.glyphs)t[e.id]=e;r(null,{glyphs:t,ascender:i.ascender,descender:i.descender})}})},nu.TinySDF=class{constructor({fontSize:t=24,buffer:e=3,radius:i=8,cutoff:n=.25,fontFamily:r="sans-serif",fontWeight:o="normal",fontStyle:a="normal"}){this.buffer=e,this.cutoff=n,this.radius=i;const s=this.size=t+4*e,l=this._createCanvas(s),c=this.ctx=l.getContext("2d",{willReadFrequently:!0});c.font=`${a} ${o} ${t}px ${r}`,c.textBaseline="alphabetic",c.textAlign="left",c.fillStyle="black",this.gridOuter=new Float64Array(s*s),this.gridInner=new Float64Array(s*s),this.f=new Float64Array(s),this.z=new Float64Array(s+1),this.v=new Uint16Array(s)}_createCanvas(t){const e=document.createElement("canvas");return e.width=e.height=t,e}draw(t){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:n,actualBoundingBoxLeft:r,actualBoundingBoxRight:o}=this.ctx.measureText(t),a=Math.floor(i),s=Math.min(this.size-this.buffer,Math.ceil(o-r)),l=Math.min(this.size-this.buffer,Math.ceil(i)+Math.ceil(n)),c=s+2*this.buffer,h=l+2*this.buffer,u=c*h,d=new Uint8ClampedArray(u),p={data:d,width:c,height:h,glyphWidth:s,glyphHeight:l,glyphTop:a,glyphLeft:0,glyphAdvance:e};if(0===s||0===l)return p;const{ctx:f,buffer:m,gridInner:g,gridOuter:y}=this;f.clearRect(m,m,s,l),f.fillText(t,m,m+a+1);const _=f.getImageData(m,m,s,l);y.fill(Qh,0,u),g.fill(0,0,u);for(let t=0;t<l;t++)for(let e=0;e<s;e++){const i=_.data[4*(t*s+e)+3]/255;if(0===i)continue;const n=(t+m)*c+e+m;if(1===i)y[n]=0,g[n]=Qh;else{const t=.5-i;y[n]=t>0?t*t:0,g[n]=t<0?t*t:0}}tu(y,0,0,c,h,c,this.f,this.v,this.z),tu(g,m,m,s,l,c,this.f,this.v,this.z);for(let t=0;t<u;t++){const e=Math.sqrt(y[t])-Math.sqrt(g[t]);d[t]=Math.round(255-255*(e/this.radius+this.cutoff))}return p}};class hu{constructor(t=[],e=uu){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this._down(t)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:i}=this,n=e[t];for(;t>0;){const r=t-1>>1,o=e[r];if(i(n,o)>=0)break;e[t]=o,t=r}e[t]=n}_down(t){const{data:e,compare:i}=this,n=this.length>>1,r=e[t];for(;t<n;){let n=1+(t<<1),o=e[n];const a=n+1;if(a<this.length&&i(e[a],o)<0&&(n=a,o=e[a]),i(o,r)>=0)break;e[t]=o,t=n}e[t]=r}}function uu(t,e){return t<e?-1:t>e?1:0}function du(t,e=1,i=!1){let n=1/0,r=1/0,a=-1/0,s=-1/0;const l=t[0];for(let t=0;t<l.length;t++){const e=l[t];(!t||e.x<n)&&(n=e.x),(!t||e.y<r)&&(r=e.y),(!t||e.x>a)&&(a=e.x),(!t||e.y>s)&&(s=e.y)}const c=Math.min(a-n,s-r);let h=c/2;const u=new hu([],pu);if(0===c)return new o(n,r);for(let e=n;e<a;e+=c)for(let i=r;i<s;i+=c)u.push(new fu(e+h,i+h,h,t));let d=function(t){let e=0,i=0,n=0;const r=t[0];for(let t=0,o=r.length,a=o-1;t<o;a=t++){const o=r[t],s=r[a],l=o.x*s.y-s.x*o.y;i+=(o.x+s.x)*l,n+=(o.y+s.y)*l,e+=3*l}return new fu(i/e,n/e,0,t)}(t),p=u.length;for(;u.length;){const n=u.pop();(n.d>d.d||!d.d)&&(d=n,i&&console.log("found best %d after %d probes",Math.round(1e4*n.d)/1e4,p)),n.max-d.d<=e||(h=n.h/2,u.push(new fu(n.p.x-h,n.p.y-h,h,t)),u.push(new fu(n.p.x+h,n.p.y-h,h,t)),u.push(new fu(n.p.x-h,n.p.y+h,h,t)),u.push(new fu(n.p.x+h,n.p.y+h,h,t)),p+=4)}return i&&(console.log("num probes: "+p),console.log("best distance: "+d.d)),d.p}function pu(t,e){return e.max-t.max}function fu(t,e,i,n){this.p=new o(t,e),this.h=i,this.d=function(t,e){let i=!1,n=1/0;for(let r=0;r<e.length;r++){const o=e[r];for(let e=0,r=o.length,a=r-1;e<r;a=e++){const r=o[e],s=o[a];r.y>t.y!=s.y>t.y&&t.x<(s.x-r.x)*(t.y-r.y)/(s.y-r.y)+r.x&&(i=!i),n=Math.min(n,Xs(t,r,s))}}return(i?1:-1)*Math.sqrt(n)}(this.p,n),this.max=this.d+this.h*Math.SQRT2}const mu=Number.POSITIVE_INFINITY,gu=Math.sqrt(2);function yu(t,e){return e[1]!==mu?function(t,e,i){let n=0,r=0;switch(e=Math.abs(e),i=Math.abs(i),t){case"top-right":case"top-left":case"top":r=i-7;break;case"bottom-right":case"bottom-left":case"bottom":r=7-i}switch(t){case"top-right":case"bottom-right":case"right":n=-e;break;case"top-left":case"bottom-left":case"left":n=e}return[n,r]}(t,e[0],e[1]):function(t,e){let i=0,n=0;e<0&&(e=0);const r=e/gu;switch(t){case"top-right":case"top-left":n=r-7;break;case"bottom-right":case"bottom-left":n=7-r;break;case"bottom":n=7-e;break;case"top":n=e-7}switch(t){case"top-right":case"bottom-right":i=-r;break;case"top-left":case"bottom-left":i=r;break;case"left":i=e;break;case"right":i=-e}return[i,n]}(t,e[0])}function _u(t,e,i,n,r,o,a,s,l,c){t.createArrays(),t.tilePixelRatio=_s/(512*t.overscaling),t.compareText={},t.iconsNeedLinear=!1;const h=t.layers[0].layout,u=t.layers[0]._unevaluatedLayout._values,d={};if("composite"===t.textSizeData.kind){const{minZoom:e,maxZoom:i}=t.textSizeData;d.compositeTextSizes=[u["text-size"].possiblyEvaluate(new zo(e),s),u["text-size"].possiblyEvaluate(new zo(i),s)]}if("composite"===t.iconSizeData.kind){const{minZoom:e,maxZoom:i}=t.iconSizeData;d.compositeIconSizes=[u["icon-size"].possiblyEvaluate(new zo(e),s),u["icon-size"].possiblyEvaluate(new zo(i),s)]}d.layoutTextSize=u["text-size"].possiblyEvaluate(new zo(l+1),s),d.layoutIconSize=u["icon-size"].possiblyEvaluate(new zo(l+1),s),d.textMaxSize=u["text-size"].possiblyEvaluate(new zo(18),s);const p="map"===h.get("text-rotation-alignment")&&"point"!==h.get("symbol-placement"),f=h.get("text-size");for(const o of t.features){const l=h.get("text-font").evaluate(o,{},s).join(","),u=f.evaluate(o,{},s),m=d.layoutTextSize.evaluate(o,{},s),g=(d.layoutIconSize.evaluate(o,{},s),{horizontal:{},vertical:void 0}),y=o.text;let _,v=[0,0];if(y){const n=y.toString(),a=24*h.get("text-letter-spacing").evaluate(o,{},s),c=24*h.get("text-line-height").evaluate(o,{},s),d=yo(n)?a:0,f=h.get("text-anchor").evaluate(o,{},s),_=h.get("text-variable-anchor");if(!_){const t=h.get("text-radial-offset").evaluate(o,{},s);v=t?yu(f,[24*t,mu]):h.get("text-offset").evaluate(o,{},s).map(t=>24*t)}let x=p?"center":h.get("text-justify").evaluate(o,{},s);const b=h.get("symbol-placement"),w="point"===b,M="point"===b?24*h.get("text-max-width").evaluate(o,{},s):0,T=o=>{t.allowVerticalPlacement&&go(n)&&(g.vertical=Dh(y,e,i,r,l,M,c,f,o,d,v,Lh.vertical,!0,b,m,u))};if(!p&&_){const t="auto"===x?_.map(t=>vu(t)):[x];let n=!1;for(let o=0;o<t.length;o++){const a=t[o];if(!g.horizontal[a])if(n)g.horizontal[a]=g.horizontal[0];else{const t=Dh(y,e,i,r,l,M,c,"center",a,d,v,Lh.horizontal,!1,b,m,u);t&&(g.horizontal[a]=t,n=1===t.positionedLines.length)}}T("left")}else{if("auto"===x&&(x=vu(f)),w||h.get("text-writing-mode").indexOf("horizontal")>=0||!go(n)){const t=Dh(y,e,i,r,l,M,c,f,x,d,v,Lh.horizontal,!1,b,m,u);t&&(g.horizontal[x]=t)}T("point"===b?"left":x)}}let x=!1;if(o.icon&&o.icon.name){const e=n[o.icon.name];e&&(_=Vh(r[o.icon.name],h.get("icon-offset").evaluate(o,{},s),h.get("icon-anchor").evaluate(o,{},s)),x=e.sdf,void 0===t.sdfIcons?t.sdfIcons=e.sdf:t.sdfIcons!==e.sdf&&pt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(e.pixelRatio!==t.pixelRatio||0!==h.get("icon-rotate").constantOr(1))&&(t.iconsNeedLinear=!0))}const b=Mu(g.horizontal)||g.vertical;t.iconsInText||(t.iconsInText=!!b&&b.iconsInText),(b||_)&&xu(t,o,g,_,n,d,m,0,v,x,a,s,c)}o&&t.generateCollisionDebugBuffers(l,t.collisionBoxArray)}function vu(t){switch(t){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function xu(t,e,i,n,r,o,a,s,l,c,h,u,d){let p=o.textMaxSize.evaluate(e,{},u);void 0===p&&(p=a);const f=t.layers[0].layout,m=f.get("icon-offset").evaluate(e,{},u),g=Mu(i.horizontal)||i.vertical,y=a/24,_=t.tilePixelRatio*p/24,v=t.tilePixelRatio*f.get("symbol-spacing"),x=f.get("text-padding")*t.tilePixelRatio,b=f.get("icon-padding")*t.tilePixelRatio,w=H(f.get("text-max-angle")),M="map"===f.get("text-rotation-alignment")&&"point"!==f.get("symbol-placement"),T="map"===f.get("icon-rotation-alignment")&&"point"!==f.get("symbol-placement"),S=f.get("symbol-placement"),E=v/2,C=f.get("icon-text-fit");let A;n&&"none"!==C&&(t.allowVerticalPlacement&&i.vertical&&(A=Hh(n,i.vertical,C,f.get("icon-text-fit-padding"),m,y)),g&&(n=Hh(n,g,C,f.get("icon-text-fit-padding"),m,y)));const P=(a,s,p)=>{if(s.x<0||s.x>=_s||s.y<0||s.y>=_s)return;const{x:f,y:g,z:y}=d.projectTilePoint(s.x,s.y,p),_=new Zh(f,g,y,0,void 0);!function(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y,_,v,x,b,w,M,T){const S=t.addToLineVertexArray(e,n);let E,C,A,P,L,I,R,D=0,k=0,O=0,z=0,B=-1,F=-1;const N={};let j=Ua(""),G=0,U=0;if(void 0===l._unevaluatedLayout.getValue("text-radial-offset")?[G,U]=l.layout.get("text-offset").evaluate(x,{},T).map(t=>24*t):(G=24*l.layout.get("text-radial-offset").evaluate(x,{},T),U=mu),t.allowVerticalPlacement&&r.vertical){const t=r.vertical;if(f)I=Su(t),s&&(R=Su(s));else{const n=l.layout.get("text-rotate").evaluate(x,{},T)+90;A=Tu(c,i,e,h,u,d,t,p,n,m),s&&(P=Tu(c,i,e,h,u,d,s,y,n))}}if(o){const n=l.layout.get("icon-rotate").evaluate(x,{},T),r="none"!==l.layout.get("icon-text-fit"),a=ru(o,n,w,r),p=s?ru(s,n,w,r):void 0;C=Tu(c,i,e,h,u,d,o,y,n),D=4*a.length;const f=t.iconSizeData;let m=null;"source"===f.kind?(m=[qc*l.layout.get("icon-size").evaluate(x,{},T)],m[0]>bu&&pt(t.layerIds[0]+': Value for "icon-size" is >= 255. Reduce your "icon-size".')):"composite"===f.kind&&(m=[qc*b.compositeIconSizes[0].evaluate(x,{},T),qc*b.compositeIconSizes[1].evaluate(x,{},T)],(m[0]>bu||m[1]>bu)&&pt(t.layerIds[0]+': Value for "icon-size" is >= 255. Reduce your "icon-size".')),t.addSymbols(t.icon,a,m,v,_,x,!1,i,e,S.lineStartIndex,S.lineLength,-1,M,T),B=t.icon.placedSymbolArray.length-1,p&&(k=4*p.length,t.addSymbols(t.icon,p,m,v,_,x,Lh.vertical,i,e,S.lineStartIndex,S.lineLength,-1,M,T),F=t.icon.placedSymbolArray.length-1)}for(const n in r.horizontal){const o=r.horizontal[n];E||(j=Ua(o.text),f?L=Su(o):E=Tu(c,i,e,h,u,d,o,p,l.layout.get("text-rotate").evaluate(x,{},T),m));const s=1===o.positionedLines.length;if(O+=wu(t,i,e,o,a,l,f,x,m,S,r.vertical?Lh.horizontal:Lh.horizontalOnly,s?Object.keys(r.horizontal):[n],N,B,b,M,T),s)break}r.vertical&&(z+=wu(t,i,e,r.vertical,a,l,f,x,m,S,Lh.vertical,["vertical"],N,F,b,M,T));let V=-1;const H=(t,e)=>t?Math.max(t,e):e;V=H(L,V),V=H(I,V),V=H(R,V);const Z=V>-1?1:0;t.glyphOffsetArray.length>=ku.MAX_GLYPHS&&pt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==x.sortKey&&t.addToSortKeyRanges(t.symbolInstances.length,x.sortKey),t.symbolInstances.emplaceBack(i.x,i.y,i.z,e.x,e.y,N.right>=0?N.right:-1,N.center>=0?N.center:-1,N.left>=0?N.left:-1,N.vertical>=0?N.vertical:-1,B,F,j,void 0!==E?E:t.collisionBoxArray.length,void 0!==E?E+1:t.collisionBoxArray.length,void 0!==A?A:t.collisionBoxArray.length,void 0!==A?A+1:t.collisionBoxArray.length,void 0!==C?C:t.collisionBoxArray.length,void 0!==C?C+1:t.collisionBoxArray.length,P||t.collisionBoxArray.length,P?P+1:t.collisionBoxArray.length,h,O,z,D,k,Z,0,G,U,V)}(t,s,_,a,i,n,r,A,t.layers[0],t.collisionBoxArray,e.index,e.sourceLayerIndex,t.index,x,M,l,0,b,T,m,e,o,c,h,u)};if("line"===S)for(const r of Kh(e.geometry,0,0,_s,_s)){const e=Jh(r,v,w,i.vertical||g,n,24,_,t.overscaling,_s);for(const i of e){const e=g;e&&Eu(t,e.text,E,i)||P(r,i,u)}}else if("line-center"===S){for(const t of e.geometry)if(t.length>1){const e=$h(t,w,i.vertical||g,n,24,_);e&&P(t,e,u)}}else if("Polygon"===e.type)for(const t of tc(e.geometry,0)){const e=du(t,16);P(t[0],new Zh(e.x,e.y,0,0,void 0),u)}else if("LineString"===e.type)for(const t of e.geometry)P(t,new Zh(t[0].x,t[0].y,0,0,void 0),u);else if("Point"===e.type)for(const t of e.geometry)for(const e of t)P([e],new Zh(e.x,e.y,0,0,void 0),u)}const bu=32640;function wu(t,e,i,n,r,a,s,l,c,h,u,d,p,f,m,g,y){const _=function(t,e,i,n,r,a,s,l){const c=[];if(0===e.positionedLines.length)return c;const h=n.layout.get("text-rotate").evaluate(a,{})*Math.PI/180,u=function(t){const e=t[0],i=t[1],n=e*i;return n>0?[e,-i]:n<0?[-e,i]:0===e?[i,e]:[i,-e]}(i);let d=Math.abs(e.top-e.bottom);for(const t of e.positionedLines)d-=t.lineOffset;const p=e.positionedLines.length,f=d/p;let m=e.top-i[1];for(let t=0;t<p;++t){const n=e.positionedLines[t];m=cu(e,f,m,t);for(const t of n.positionedGlyphs){if(!t.rect)continue;const n=t.rect||{};let a=4,d=!0,p=1,f=0;if(t.imageName){const e=s[t.imageName];if(!e)continue;if(e.sdf){pt("SDF images are not supported in formatted text and will be ignored.");continue}d=!1,p=e.pixelRatio,a=1/p}const g=(r||l)&&t.vertical,y=t.metrics.advance*t.scale/2,_=t.metrics,v=t.rect;if(null===v)continue;l&&e.verticalizable&&(f=t.imageName?y-t.metrics.width*t.scale/2:0);const x=r?[t.x+y,t.y]:[0,0];let b=[0,0],w=[0,0],M=!1;r||(g?(w=[t.x+y+u[0],t.y+u[1]-f],M=!0):b=[t.x+y+i[0],t.y+i[1]-f]);const T=v.w*t.scale/(p*(t.localGlyph?2:1)),S=v.h*t.scale/(p*(t.localGlyph?2:1));let E,C,A,P;if(g){const e=t.y-m,i=new o(-y,y-e),n=-Math.PI/2,r=new o(...w);E=new o(-y+b[0],b[1]),E._rotateAround(n,i)._add(r),E.x+=-e+y,E.y-=(_.left-a)*t.scale;const s=t.imageName?_.advance*t.scale:24*t.scale,l=String.fromCharCode(t.glyph);th(l)?E.x+=(1-a)*t.scale:eh(l)?E.x+=s-_.height*t.scale+(-a-1)*t.scale:E.x+=t.imageName||_.width+2*a===v.w&&_.height+2*a===v.h?(s-S)/2:(s-(_.height+2*a)*t.scale)/2,C=new o(E.x,E.y-T),A=new o(E.x+S,E.y),P=new o(E.x+S,E.y-T)}else{const e=(_.left-a)*t.scale-y+b[0],i=(-_.top-a)*t.scale+b[1],n=e+T,r=i+S;E=new o(e,i),C=new o(n,i),A=new o(e,r),P=new o(n,r)}if(h){let t;t=r?new o(0,0):M?new o(u[0],u[1]):new o(i[0],i[1]),E._rotateAround(h,t),C._rotateAround(h,t),A._rotateAround(h,t),P._rotateAround(h,t)}const L=new o(0,0),I=new o(0,0);c.push({tl:E,tr:C,bl:A,br:P,tex:n,writingMode:e.writingMode,glyphOffset:x,sectionIndex:t.sectionIndex,isSDF:d,pixelOffsetTL:L,pixelOffsetBR:I,minFontScaleX:0,minFontScaleY:0})}}return c}(0,n,c,a,s,l,r,t.allowVerticalPlacement),v=t.textSizeData;let x=null;"source"===v.kind?(x=[qc*a.layout.get("text-size").evaluate(l,{},y)],x[0]>bu&&pt(t.layerIds[0]+': Value for "text-size" is >= 255. Reduce your "text-size".')):"composite"===v.kind&&(x=[qc*m.compositeTextSizes[0].evaluate(l,{},y),qc*m.compositeTextSizes[1].evaluate(l,{},y)],(x[0]>bu||x[1]>bu)&&pt(t.layerIds[0]+': Value for "text-size" is >= 255. Reduce your "text-size".')),t.addSymbols(t.text,_,x,c,s,l,u,e,i,h.lineStartIndex,h.lineLength,f,g,y);for(const e of d)p[e]=t.text.placedSymbolArray.length-1;return 4*_.length}function Mu(t){for(const e in t)return t[e];return null}function Tu(t,e,i,n,r,a,s,l,c,h){let u=s.top,d=s.bottom,p=s.left,f=s.right;const m=s.collisionPadding;if(m&&(p-=m[0],u-=m[1],f+=m[2],d+=m[3]),c){const t=new o(p,u),e=new o(f,u),i=new o(p,d),n=new o(f,d),r=H(c);let a=new o(0,0);h&&(a=new o(h[0],h[1])),t._rotateAround(r,a),e._rotateAround(r,a),i._rotateAround(r,a),n._rotateAround(r,a),p=Math.min(t.x,e.x,i.x,n.x),f=Math.max(t.x,e.x,i.x,n.x),u=Math.min(t.y,e.y,i.y,n.y),d=Math.max(t.y,e.y,i.y,n.y)}return t.emplaceBack(e.x,e.y,e.z,i.x,i.y,p,u,f,d,l,n,r,a),t.length-1}function Su(t){t.collisionPadding&&(t.top-=t.collisionPadding[1],t.bottom+=t.collisionPadding[3]);const e=t.bottom-t.top;return e>0?Math.max(10,e):null}function Eu(t,e,i,n){const r=t.compareText;if(e in r){const t=r[e];for(let e=t.length-1;e>=0;e--)if(n.dist(t[e])<i)return!0}else r[e]=[];return r[e].push(n),!1}const Cu=_c.VectorTileFeature.types,Au=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Pu(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m){const g=h?Math.min(bu,Math.round(h[0])):0,y=h?Math.min(bu,Math.round(h[1])):0;t.emplaceBack(e,i,Math.round(32*a),Math.round(32*s),l,c,(g<<1)+(u?1:0),y,16*d,16*p,256*f,256*m,n,r,o,0)}function Lu(t,e,i){t.emplaceBack(e.x,e.y,i),t.emplaceBack(e.x,e.y,i),t.emplaceBack(e.x,e.y,i),t.emplaceBack(e.x,e.y,i)}function Iu(t){for(const e of t.sections)if(Mo(e.text))return!0;return!1}class Ru{constructor(t){this.layoutVertexArray=new ca,this.indexArray=new ma,this.programConfigurations=t,this.segments=new ys,this.dynamicLayoutVertexArray=new aa,this.opacityVertexArray=new ha,this.placedSymbolArray=new Pa}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length}upload(t,e,i,n){this.isEmpty()||(i&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Gc.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,e),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,Uc.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,Au,!0),this.opacityVertexBuffer.itemSize=1),(i||n)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}zr("SymbolBuffers",Ru);class Du{constructor(t,e,i){this.layoutVertexArray=new t,this.layoutAttributes=e,this.indexArray=new i,this.segments=new ys,this.collisionVertexArray=new fa,this.collisionVertexArrayExt=new aa}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,Vc.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,Hc.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}zr("CollisionBuffers",Du);class ku{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(t=>t.id),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=u([]),this.placementViewportMatrix=u([]);const e=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Xc(this.zoom,e["text-size"]),this.iconSizeData=Xc(this.zoom,e["icon-size"]);const i=this.layers[0].layout,n=i.get("symbol-sort-key"),r=i.get("symbol-z-order");this.canOverlap=i.get("text-allow-overlap")||i.get("icon-allow-overlap")||i.get("text-ignore-placement")||i.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==r&&void 0!==n.constantOr(1),this.sortFeaturesByY=("viewport-y"===r||"auto"===r&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=i.get("text-writing-mode").map(t=>Lh[t]),this.stateDependentLayerIds=this.layers.filter(t=>t.isStateDependent()).map(t=>t.id),this.sourceID=t.sourceID}createArrays(){this.text=new Ru(new ss(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new Ru(new ss(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new Ra,this.lineVertexArray=new Da,this.symbolInstances=new Ia}calculateGlyphDependencies(t,e,i,n,r){for(let i=0;i<t.length;i++)if(e[t.charCodeAt(i)]=!0,n&&r){const n=Qc[t.charAt(i)];n&&(e[n.charCodeAt(0)]=!0)}}populate(t,e,i,n){const r=this.layers[0],o=r.layout,a=o.get("text-font"),s=o.get("text-field"),l=o.get("icon-image"),c=("constant"!==s.value.kind||s.value.value instanceof Ye&&!s.value.value.isEmpty()||s.value.value.toString().length>0)&&("constant"!==a.value.kind||a.value.value.length>0),h="constant"!==l.value.kind||!!l.value.value||Object.keys(l.parameters).length>0,u=o.get("symbol-sort-key");if(this.features=[],!c&&!h)return;const d=e.iconDependencies,p=e.glyphDependencies,f=e.availableImages,m=new zo(this.zoom);for(const{feature:e,id:s,index:l,sourceLayerIndex:g}of t){const t=r._featureFilter.needGeometry,y=Fs(e,t);if(!r._featureFilter.filter(m,y,i))continue;let _,v;if(t||(y.geometry=Bs(e,i,n)),c){const t=r.getValueAndResolveTokens("text-field",y,i,f),e=Ye.factory(t);Iu(e)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Do()||this.hasRTLText&&Oo.isParsed())&&(_=Kc(e,r,y))}if(h){const t=r.getValueAndResolveTokens("icon-image",y,i,f);v=t instanceof $e?t:$e.fromString(t)}if(!_&&!v)continue;const x=this.sortFeaturesByKey?u.evaluate(y,{},i):void 0;if(this.features.push({id:s,text:_,icon:v,index:l,sourceLayerIndex:g,geometry:y.geometry,properties:e.properties,type:Cu[e.type],sortKey:x}),v&&(d[v.name]=!0),_){const t=a.evaluate(y,{},i).join(","),e="map"===o.get("text-rotation-alignment")&&"point"!==o.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Lh.vertical)>=0;for(const i of _.sections)if(i.image)d[i.image.name]=!0;else{const n=go(_.toString()),r=i.fontStack||t,o=p[r]=p[r]||{};this.calculateGlyphDependencies(i.text,o,e,this.allowVerticalPlacement,n)}}}"line"===o.get("symbol-placement")&&(this.features=function(t){const e={},i={},n=[];let r=0;function o(e){n.push(t[e]),r++}function a(t,e,r){const o=i[t];return delete i[t],i[e]=o,n[o].geometry[0].pop(),n[o].geometry[0]=n[o].geometry[0].concat(r[0]),o}function s(t,i,r){const o=e[i];return delete e[i],e[t]=o,n[o].geometry[0].shift(),n[o].geometry[0]=r[0].concat(n[o].geometry[0]),o}function l(t,e,i){const n=i?e[0][e[0].length-1]:e[0][0];return`${t}:${n.x}:${n.y}`}for(let c=0;c<t.length;c++){const h=t[c],u=h.geometry,d=h.text?h.text.toString():null;if(!d){o(c);continue}const p=l(d,u),f=l(d,u,!0);if(p in i&&f in e&&i[p]!==e[f]){const t=s(p,f,u),r=a(p,f,n[t].geometry);delete e[p],delete i[f],i[l(d,n[r].geometry,!0)]=r,n[t].geometry=null}else p in i?a(p,f,u):f in e?s(p,f,u):(o(c),e[p]=r-1,i[f]=r-1)}return n.filter(t=>t.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((t,e)=>t.sortKey-e.sortKey)}update(t,e,i,n){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(t,e,this.layers,i,n),this.icon.programConfigurations.updatePaintArrays(t,e,this.layers,i,n))}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,e){const i=this.lineVertexArray.length;if(void 0!==t.segment){let i=t.dist(e[t.segment+1]),n=t.dist(e[t.segment]);const r={};for(let n=t.segment+1;n<e.length;n++)r[n]={x:e[n].x,y:e[n].y,tileUnitDistanceFromAnchor:i},n<e.length-1&&(i+=e[n+1].dist(e[n]));for(let i=t.segment||0;i>=0;i--)r[i]={x:e[i].x,y:e[i].y,tileUnitDistanceFromAnchor:n},i>0&&(n+=e[i-1].dist(e[i]));for(let t=0;t<e.length;t++){const e=r[t];this.lineVertexArray.emplaceBack(e.x,e.y,e.tileUnitDistanceFromAnchor)}}return{lineStartIndex:i,lineLength:this.lineVertexArray.length-i}}addSymbols(t,e,i,n,r,o,a,s,l,c,h,u,d,p){const f=t.indexArray,m=t.layoutVertexArray,g=t.segments.prepareSegment(4*e.length,m,f,this.canOverlap?o.sortKey:void 0),y=this.glyphOffsetArray.length,_=g.vertexLength,v=this.allowVerticalPlacement&&a===Lh.vertical?Math.PI/2:0,x=o.text&&o.text.sections;for(let n=0;n<e.length;n++){const{tl:r,tr:a,bl:c,br:h,tex:u,pixelOffsetTL:y,pixelOffsetBR:_,minFontScaleX:b,minFontScaleY:w,glyphOffset:M,isSDF:T,sectionIndex:S}=e[n],E=g.vertexLength,C=M[1];Pu(m,s.x,s.y,s.z,l.x,l.y,r.x,C+r.y,u.x,u.y,i,T,y.x,y.y,b,w),Pu(m,s.x,s.y,s.z,l.x,l.y,a.x,C+a.y,u.x+u.w,u.y,i,T,_.x,y.y,b,w),Pu(m,s.x,s.y,s.z,l.x,l.y,c.x,C+c.y,u.x,u.y+u.h,i,T,y.x,_.y,b,w),Pu(m,s.x,s.y,s.z,l.x,l.y,h.x,C+h.y,u.x+u.w,u.y+u.h,i,T,_.x,_.y,b,w),Lu(t.dynamicLayoutVertexArray,s,v),f.emplaceBack(E,E+1,E+2),f.emplaceBack(E+1,E+2,E+3),g.vertexLength+=4,g.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(M[0]),n!==e.length-1&&S===e[n+1].sectionIndex||t.programConfigurations.populatePaintArrays(m.length,o,o.index,{},d,p,x&&x[S])}t.placedSymbolArray.emplaceBack(s.x,s.y,s.z,l.x,l.y,y,this.glyphOffsetArray.length-y,_,c,h,l.segment,i?i[0]:0,i?i[1]:0,n[0],n[1],a,0,!1,0,u,0)}_commitLayoutVertex(t,e,i,n,r,o,a){t.emplaceBack(e,i,n,r,o,Math.round(a.x),Math.round(a.y))}_addCollisionDebugVertices(t,e,i,n,r,a,s){const l=i.segments.prepareSegment(4,i.layoutVertexArray,i.indexArray),c=l.vertexLength,h=s.tileAnchorX,u=s.tileAnchorY;for(let t=0;t<4;t++)i.collisionVertexArray.emplaceBack(0,0,0,0);i.collisionVertexArrayExt.emplaceBack(e,-t.padding,-t.padding),i.collisionVertexArrayExt.emplaceBack(e,t.padding,-t.padding),i.collisionVertexArrayExt.emplaceBack(e,t.padding,t.padding),i.collisionVertexArrayExt.emplaceBack(e,-t.padding,t.padding),this._commitLayoutVertex(i.layoutVertexArray,n,r,a,h,u,new o(t.x1,t.y1)),this._commitLayoutVertex(i.layoutVertexArray,n,r,a,h,u,new o(t.x2,t.y1)),this._commitLayoutVertex(i.layoutVertexArray,n,r,a,h,u,new o(t.x2,t.y2)),this._commitLayoutVertex(i.layoutVertexArray,n,r,a,h,u,new o(t.x1,t.y2)),l.vertexLength+=4;const d=i.indexArray;d.emplaceBack(c,c+1),d.emplaceBack(c+1,c+2),d.emplaceBack(c+2,c+3),d.emplaceBack(c+3,c),l.primitiveLength+=4}_addTextDebugCollisionBoxes(t,e,i,n,r,o){for(let a=n;a<r;a++){const n=i.get(a),r=this.getSymbolInstanceTextSize(t,o,e,a);this._addCollisionDebugVertices(n,r,this.textCollisionBox,n.projectedAnchorX,n.projectedAnchorY,n.projectedAnchorZ,o)}}_addIconDebugCollisionBoxes(t,e,i,n,r,o){for(let a=n;a<r;a++){const n=i.get(a),r=this.getSymbolInstanceIconSize(t,e,a);this._addCollisionDebugVertices(n,r,this.iconCollisionBox,n.projectedAnchorX,n.projectedAnchorY,n.projectedAnchorZ,o)}}generateCollisionDebugBuffers(t,e){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Du(da,Zc.members,wa),this.iconCollisionBox=new Du(da,Zc.members,wa);const i=$c(this.iconSizeData,t),n=$c(this.textSizeData,t);for(let r=0;r<this.symbolInstances.length;r++){const o=this.symbolInstances.get(r);this._addTextDebugCollisionBoxes(n,t,e,o.textBoxStartIndex,o.textBoxEndIndex,o),this._addTextDebugCollisionBoxes(n,t,e,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o),this._addIconDebugCollisionBoxes(i,t,e,o.iconBoxStartIndex,o.iconBoxEndIndex,o),this._addIconDebugCollisionBoxes(i,t,e,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex,o)}}getSymbolInstanceTextSize(t,e,i,n){const r=this.text.placedSymbolArray.get(e.rightJustifiedTextSymbolIndex>=0?e.rightJustifiedTextSymbolIndex:e.centerJustifiedTextSymbolIndex>=0?e.centerJustifiedTextSymbolIndex:e.leftJustifiedTextSymbolIndex>=0?e.leftJustifiedTextSymbolIndex:e.verticalPlacedTextSymbolIndex>=0?e.verticalPlacedTextSymbolIndex:n),o=Yc(this.textSizeData,t,r)/24;return this.tilePixelRatio*o}getSymbolInstanceIconSize(t,e,i){const n=this.icon.placedSymbolArray.get(i),r=Yc(this.iconSizeData,t,n);return this.tilePixelRatio*r}_commitDebugCollisionVertexUpdate(t,e,i){t.emplaceBack(e,-i,-i),t.emplaceBack(e,i,-i),t.emplaceBack(e,i,i),t.emplaceBack(e,-i,i)}_updateTextDebugCollisionBoxes(t,e,i,n,r,o){for(let a=n;a<r;a++){const n=i.get(a),r=this.getSymbolInstanceTextSize(t,o,e,a);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,r,n.padding)}}_updateIconDebugCollisionBoxes(t,e,i,n,r){for(let o=n;o<r;o++){const n=i.get(o),r=this.getSymbolInstanceIconSize(t,e,o);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,r,n.padding)}}updateCollisionDebugBuffers(t,e){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const i=$c(this.iconSizeData,t),n=$c(this.textSizeData,t);for(let r=0;r<this.symbolInstances.length;r++){const o=this.symbolInstances.get(r);this._updateTextDebugCollisionBoxes(n,t,e,o.textBoxStartIndex,o.textBoxEndIndex,o),this._updateTextDebugCollisionBoxes(n,t,e,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o),this._updateIconDebugCollisionBoxes(i,t,e,o.iconBoxStartIndex,o.iconBoxEndIndex),this._updateIconDebugCollisionBoxes(i,t,e,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,e,i,n,r,o,a,s,l){const c={};for(let n=e;n<i;n++){const e=t.get(n);c.textBox={x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2,padding:e.padding,projectedAnchorX:e.projectedAnchorX,projectedAnchorY:e.projectedAnchorY,projectedAnchorZ:e.projectedAnchorZ,tileAnchorX:e.tileAnchorX,tileAnchorY:e.tileAnchorY},c.textFeatureIndex=e.featureIndex;break}for(let e=n;e<r;e++){const i=t.get(e);c.verticalTextBox={x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,padding:i.padding,projectedAnchorX:i.projectedAnchorX,projectedAnchorY:i.projectedAnchorY,projectedAnchorZ:i.projectedAnchorZ,tileAnchorX:i.tileAnchorX,tileAnchorY:i.tileAnchorY},c.verticalTextFeatureIndex=i.featureIndex;break}for(let e=o;e<a;e++){const i=t.get(e);c.iconBox={x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,padding:i.padding,projectedAnchorX:i.projectedAnchorX,projectedAnchorY:i.projectedAnchorY,projectedAnchorZ:i.projectedAnchorZ,tileAnchorX:i.tileAnchorX,tileAnchorY:i.tileAnchorY},c.iconFeatureIndex=i.featureIndex;break}for(let e=s;e<l;e++){const i=t.get(e);c.verticalIconBox={x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,padding:i.padding,projectedAnchorX:i.projectedAnchorX,projectedAnchorY:i.projectedAnchorY,projectedAnchorZ:i.projectedAnchorZ,tileAnchorX:i.tileAnchorX,tileAnchorY:i.tileAnchorY},c.verticalIconFeatureIndex=i.featureIndex;break}return c}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let e=0;e<this.symbolInstances.length;e++){const i=this.symbolInstances.get(e);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,i.textBoxStartIndex,i.textBoxEndIndex,i.verticalTextBoxStartIndex,i.verticalTextBoxEndIndex,i.iconBoxStartIndex,i.iconBoxEndIndex,i.verticalIconBoxStartIndex,i.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(t,e){const i=t.placedSymbolArray.get(e),n=i.vertexStartIndex+4*i.numGlyphs;for(let e=i.vertexStartIndex;e<n;e+=4)t.indexArray.emplaceBack(e,e+1,e+2),t.indexArray.emplaceBack(e+1,e+2,e+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const e=Math.sin(t),i=Math.cos(t),n=[],r=[],o=[];for(let t=0;t<this.symbolInstances.length;++t){o.push(t);const a=this.symbolInstances.get(t);n.push(0|Math.round(e*a.tileAnchorX+i*a.tileAnchorY)),r.push(a.featureIndex)}return o.sort((t,e)=>n[t]-n[e]||r[e]-r[t]),o}addToSortKeyRanges(t,e){const i=this.sortKeyRanges[this.sortKeyRanges.length-1];i&&i.sortKey===e?i.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:e,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const t of this.symbolInstanceIndexes){const e=this.symbolInstances.get(t);this.featureSortOrder.push(e.featureIndex),[e.rightJustifiedTextSymbolIndex,e.centerJustifiedTextSymbolIndex,e.leftJustifiedTextSymbolIndex].forEach((t,e,i)=>{t>=0&&i.indexOf(t)===e&&this.addIndicesForPlacedSymbol(this.text,t)}),e.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,e.verticalPlacedTextSymbolIndex),e.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,e.placedIconSymbolIndex),e.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,e.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}zr("SymbolBucket",ku,{omit:["layers","collisionBoxArray","features","compareText"]}),ku.MAX_GLYPHS=65535,ku.addDynamicAttributes=Lu;const Ou=new $o({"symbol-placement":new Zo(xe.layout_symbol["symbol-placement"]),"symbol-spacing":new Zo(xe.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Zo(xe.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Wo(xe.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Zo(xe.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Zo(xe.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Zo(xe.layout_symbol["icon-ignore-placement"]),"icon-optional":new Zo(xe.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Zo(xe.layout_symbol["icon-rotation-alignment"]),"icon-size":new Wo(xe.layout_symbol["icon-size"]),"icon-text-fit":new Zo(xe.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Zo(xe.layout_symbol["icon-text-fit-padding"]),"icon-image":new Wo(xe.layout_symbol["icon-image"]),"icon-rotate":new Wo(xe.layout_symbol["icon-rotate"]),"icon-padding":new Zo(xe.layout_symbol["icon-padding"]),"icon-keep-upright":new Zo(xe.layout_symbol["icon-keep-upright"]),"icon-offset":new Wo(xe.layout_symbol["icon-offset"]),"icon-anchor":new Wo(xe.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Zo(xe.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Zo(xe.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Zo(xe.layout_symbol["text-rotation-alignment"]),"text-field":new Wo(xe.layout_symbol["text-field"]),"text-font":new Wo(xe.layout_symbol["text-font"]),"text-size":new Wo(xe.layout_symbol["text-size"]),"text-max-width":new Wo(xe.layout_symbol["text-max-width"]),"text-line-height":new Wo(xe.layout_symbol["text-line-height"]),"text-letter-spacing":new Wo(xe.layout_symbol["text-letter-spacing"]),"text-justify":new Wo(xe.layout_symbol["text-justify"]),"text-radial-offset":new Wo(xe.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Zo(xe.layout_symbol["text-variable-anchor"]),"text-anchor":new Wo(xe.layout_symbol["text-anchor"]),"text-max-angle":new Zo(xe.layout_symbol["text-max-angle"]),"text-writing-mode":new Zo(xe.layout_symbol["text-writing-mode"]),"text-rotate":new Wo(xe.layout_symbol["text-rotate"]),"text-padding":new Zo(xe.layout_symbol["text-padding"]),"text-keep-upright":new Zo(xe.layout_symbol["text-keep-upright"]),"text-transform":new Wo(xe.layout_symbol["text-transform"]),"text-offset":new Wo(xe.layout_symbol["text-offset"]),"text-allow-overlap":new Zo(xe.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Zo(xe.layout_symbol["text-ignore-placement"]),"text-optional":new Zo(xe.layout_symbol["text-optional"])});var zu={paint:new $o({"icon-opacity":new Wo(xe.paint_symbol["icon-opacity"]),"icon-color":new Wo(xe.paint_symbol["icon-color"]),"icon-halo-color":new Wo(xe.paint_symbol["icon-halo-color"]),"icon-halo-width":new Wo(xe.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Wo(xe.paint_symbol["icon-halo-blur"]),"icon-translate":new Zo(xe.paint_symbol["icon-translate"]),"icon-translate-anchor":new Zo(xe.paint_symbol["icon-translate-anchor"]),"text-opacity":new Wo(xe.paint_symbol["text-opacity"]),"text-color":new Wo(xe.paint_symbol["text-color"],{runtimeType:Re,getOverride:t=>t.textColor,hasOverride:t=>!!t.textColor}),"text-halo-color":new Wo(xe.paint_symbol["text-halo-color"]),"text-halo-width":new Wo(xe.paint_symbol["text-halo-width"]),"text-halo-blur":new Wo(xe.paint_symbol["text-halo-blur"]),"text-translate":new Zo(xe.paint_symbol["text-translate"]),"text-translate-anchor":new Zo(xe.paint_symbol["text-translate-anchor"])}),layout:Ou};class Bu{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:Ae,this.defaultValue=t}evaluate(t){if(t.formattedSection){const e=this.defaultValue.property.overrides;if(e&&e.hasOverride(t.formattedSection))return e.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}zr("FormatSectionOverride",Bu,{omit:["defaultValue"]});class Fu extends fs{constructor(t){super(t,zu)}recalculate(t,e){super.recalculate(t,e),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const i=this.layout.get("text-writing-mode");if(i){const t=[];for(const e of i)t.indexOf(e)<0&&t.push(e);this.layout._values["text-writing-mode"]=t}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(t,e,i,n){const r=this.layout.get(t).evaluate(e,{},i,n),o=this._unevaluatedLayout._values[t];return o.isDataDriven()||Nn(o.value)||!r?r:function(t,e){return e.replace(/{([^{}]+)}/g,(e,i)=>i in t?String(t[i]):"")}(e.properties,r)}createBucket(t){return new ku(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of zu.paint.overridableProperties){if(!Fu.hasPaintOverride(this.layout,t))continue;const e=this.paint.get(t),i=new Bu(e),n=new Fn(i,e.property.specification);let r=null;r="constant"===e.value.kind||"source"===e.value.kind?new Gn("source",n):new Un("composite",n,e.value.zoomStops,e.value._interpolationType),this.paint._values[t]=new Vo(e.property,r,e.parameters)}}_handleOverridablePaintPropertyUpdate(t,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven())&&Fu.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,e){const i=t.get("text-field"),n=zu.paint.properties[e];let r=!1;const o=t=>{for(const e of t)if(n.overrides&&n.overrides.hasOverride(e))return void(r=!0)};if("constant"===i.value.kind&&i.value.value instanceof Ye)o(i.value.value.sections);else if("source"===i.value.kind){const t=e=>{r||(e instanceof ei&&Qe(e.value)===ze?o(e.value.sections):e instanceof oi?o(e.sections):e.eachChild(t))},e=i.value;e._styleExpression&&t(e._styleExpression.expression)}return r}getProgramConfiguration(t){return new as(this,t)}}var Nu={paint:new $o({"background-color":new Zo(xe.paint_background["background-color"]),"background-pattern":new Xo(xe.paint_background["background-pattern"]),"background-opacity":new Zo(xe.paint_background["background-opacity"])})},ju={paint:new $o({"raster-opacity":new Zo(xe.paint_raster["raster-opacity"]),"raster-hue-rotate":new Zo(xe.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Zo(xe.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Zo(xe.paint_raster["raster-brightness-max"]),"raster-saturation":new Zo(xe.paint_raster["raster-saturation"]),"raster-contrast":new Zo(xe.paint_raster["raster-contrast"]),"raster-resampling":new Zo(xe.paint_raster["raster-resampling"]),"raster-fade-duration":new Zo(xe.paint_raster["raster-fade-duration"])})};class Gu extends fs{constructor(t){super(t,{}),this.implementation=t}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}recalculate(){}updateTransitions(){}hasTransition(){}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}var Uu={paint:new $o({"sky-type":new Zo(xe.paint_sky["sky-type"]),"sky-atmosphere-sun":new Zo(xe.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Zo(xe.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Zo(xe.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Zo(xe.paint_sky["sky-gradient-radius"]),"sky-gradient":new Yo(xe.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Zo(xe.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Zo(xe.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Zo(xe.paint_sky["sky-opacity"])})};function Vu(t,e,i){const n=b(0,0,1),r=N(F());return function(t,e,i){i*=.5;var n=e[0],r=e[1],o=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);t[0]=n*l-o*s,t[1]=r*l+a*s,t[2]=o*l+n*s,t[3]=a*l-r*s}(r,r,i?-H(t)+Math.PI:H(t)),j(r,r,-H(e)),R(n,n,r),A(n,n)}const Hu={circle:class extends fs{constructor(t){super(t,rl)}createBucket(t){return new js(t)}queryRadius(t){const e=t;return Qs("circle-radius",this,e)+Qs("circle-stroke-width",this,e)+tl(this.paint.get("circle-translate"))}queryIntersectsFeature(t,e,i,n,r,o,a,s){const l=il(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),o.angle,t.pixelToTileUnitsFactor),c=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return sl(t,n,o,a,s,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),l,c)}getProgramIds(){return["circle"]}getProgramConfiguration(t){return new as(this,t)}},heatmap:class extends fs{createBucket(t){return new dl(t)}constructor(t){super(t,_l),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){"heatmap-color"===t&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=vl({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(t){return Qs("heatmap-radius",this,t)}queryIntersectsFeature(t,e,i,n,r,a,s,l){const c=this.paint.get("heatmap-radius").evaluate(e,i);return sl(t,n,a,s,l,!0,!0,new o(0,0),c)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(t){return new as(this,t)}},hillshade:class extends fs{constructor(t){super(t,xl)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getProgramConfiguration(t){return new as(this,t)}},fill:class extends fs{constructor(t){super(t,ac)}getProgramIds(){const t=this.paint.get("fill-pattern"),e=t&&t.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getProgramConfiguration(t){return new as(this,t)}recalculate(t,e){super.recalculate(t,e);const i=this.paint._values["fill-outline-color"];"constant"===i.value.kind&&void 0===i.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(t){return new rc(t)}queryRadius(){return tl(this.paint.get("fill-translate"))}queryIntersectsFeature(t,e,i,n,r,o){return!t.queryGeometry.isAboveHorizon&&Vs(el(t.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),o.angle,t.pixelToTileUnitsFactor),n)}isTileClipped(){return!0}},"fill-extrusion":class extends fs{constructor(t){super(t,Sc)}createBucket(t){return new Mc(t)}queryRadius(){return tl(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(t){return new as(this,t)}queryIntersectsFeature(t,e,i,n,r,a,s,l,c){const h=il(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),a.angle,t.pixelToTileUnitsFactor),u=this.paint.get("fill-extrusion-height").evaluate(e,i),d=this.paint.get("fill-extrusion-base").evaluate(e,i),p=[0,0],f=l&&a.elevation,m=a.elevation?a.elevation.exaggeration():1;if(f){const e=t.tile.getBucket(this).centroidVertexArray,i=c+1;if(i<e.length){const t=e.get(i);p[0]=t.a_centroid_pos0,p[1]=t.a_centroid_pos1}}if(0===p[0]&&1===p[1])return!1;const g=function(t,e,i,n,r,a,s,l,c){return a?function(t,e,i,n,r,o,a,s,l){const c=[],h=[],u=[0,0,0,1];for(const d of t){const t=[],p=[];for(const c of d){const h=c.x+n.x,d=c.y+n.y,f=Pc(h,d,e,i,o,a,s,l);u[0]=h,u[1]=d,u[2]=f.base,u[3]=1,B(u,u,r),u[3]=Math.max(u[3],1e-5);const m=Ac([u[0]/u[3],u[1]/u[3],u[2]/u[3]]);u[0]=h,u[1]=d,u[2]=f.top,u[3]=1,B(u,u,r),u[3]=Math.max(u[3],1e-5);const g=Ac([u[0]/u[3],u[1]/u[3],u[2]/u[3]]);t.push(m),p.push(g)}c.push(t),h.push(p)}return[c,h]}(t,e,i,n,r,a,s,l,c):function(t,e,i,n,r){const a=[],s=[],l=r[8]*e,c=r[9]*e,h=r[10]*e,u=r[11]*e,d=r[8]*i,p=r[9]*i,f=r[10]*i,m=r[11]*i;for(const e of t){const t=[],i=[];for(const a of e){const e=a.x+n.x,s=a.y+n.y,g=r[0]*e+r[4]*s+r[12],y=r[1]*e+r[5]*s+r[13],_=r[2]*e+r[6]*s+r[14],v=r[3]*e+r[7]*s+r[15],x=g+l,b=y+c,w=_+h,M=Math.max(v+u,1e-5),T=g+d,S=y+p,E=_+f,C=Math.max(v+m,1e-5),A=new o(x/M,b/M);A.z=w/M,t.push(A);const P=new o(T/C,S/C);P.z=E/C,i.push(P)}a.push(t),s.push(i)}return[a,s]}(t,e,i,n,r)}(n,d,u,h,s,f?l:null,p,m,a.center.lat),y=t.queryGeometry;return function(t,e,i){let n=1/0;Vs(i,e)&&(n=Cc(i,e[0]));for(let r=0;r<e.length;r++){const o=e[r],a=t[r];for(let t=0;t<o.length-1;t++){const e=o[t],r=[e,o[t+1],a[t+1],a[t],e];Gs(i,r)&&(n=Math.min(n,Cc(i,r)))}}return n!==1/0&&n}(g[0],g[1],y.isPointQuery()?y.screenBounds:y.screenGeometry)}},line:class extends fs{constructor(t){super(t,Fc),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(t){if("line-gradient"===t){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof zi,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(t,e){super.recalculate(t,e),this.paint._values["line-floorwidth"]=Nc.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,t)}createBucket(t){return new zc(t)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(t){return new as(this,t)}queryRadius(t){const e=t,i=jc(Qs("line-width",this,e),Qs("line-gap-width",this,e)),n=Qs("line-offset",this,e);return i/2+Math.abs(n)+tl(this.paint.get("line-translate"))}queryIntersectsFeature(t,e,i,n,r,a){if(t.queryGeometry.isAboveHorizon)return!1;const s=el(t.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),a.angle,t.pixelToTileUnitsFactor),l=t.pixelToTileUnitsFactor/2*jc(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),c=this.paint.get("line-offset").evaluate(e,i);return c&&(n=function(t,e){const i=[],n=new o(0,0);for(let r=0;r<t.length;r++){const o=t[r],a=[];for(let t=0;t<o.length;t++){const i=o[t-1],r=o[t],s=o[t+1],l=0===t?n:r.sub(i)._unit()._perp(),c=t===o.length-1?n:s.sub(r)._unit()._perp(),h=l._add(c)._unit();h._mult(1/(h.x*c.x+h.y*c.y)),a.push(h._mult(e)._add(r))}i.push(a)}return i}(n,c*t.pixelToTileUnitsFactor)),function(t,e,i){for(let n=0;n<e.length;n++){const r=e[n];if(t.length>=3)for(let e=0;e<r.length;e++)if($s(t,r[e]))return!0;if(Hs(t,r,i))return!0}return!1}(s,n,l)}isTileClipped(){return!0}},symbol:Fu,background:class extends fs{constructor(t){super(t,Nu)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends fs{constructor(t){super(t,ju)}getProgramIds(){return["raster"]}},sky:class extends fs{constructor(t){super(t,Uu),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){"sky-gradient"===t?this._updateColorRamp():"sky-atmosphere-sun"!==t&&"sky-atmosphere-halo-color"!==t&&"sky-atmosphere-color"!==t&&"sky-atmosphere-sun-intensity"!==t||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=vl({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(t){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=t.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}}getCenter(t,e){const i=this.paint.get("sky-type");if("atmosphere"===i){const i=this.paint.get("sky-atmosphere-sun"),n=!i,r=t.style.light,o=r.properties.get("position");return n&&"viewport"===r.properties.get("anchor")&&pt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),n?Vu(o.azimuthal,90-o.polar,e):Vu(i[0],90-i[1],e)}if("gradient"===i){const t=this.paint.get("sky-gradient-center");return Vu(t[0],90-t[1],e)}}is3D(){return!1}isSky(){return!0}markSkyboxValid(t){this._skyboxInvalidated=!1,this._lightPosition=t.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const t=this.paint.get("sky-type");return"atmosphere"===t?["skyboxCapture","skybox"]:"gradient"===t?["skyboxGradient"]:null}}},{HTMLImageElement:Zu,HTMLCanvasElement:Wu,HTMLVideoElement:qu,ImageData:Xu,ImageBitmap:Yu}=s;class $u{constructor(t,e,i,n){this.context=t,this.format=i,this.texture=t.gl.createTexture(),this.update(e,n)}update(t,e,i){const{width:n,height:r}=t,{context:o}=this,{gl:a}=o;if(a.bindTexture(a.TEXTURE_2D,this.texture),o.pixelStoreUnpackFlipY.set(!1),o.pixelStoreUnpack.set(1),o.pixelStoreUnpackPremultiplyAlpha.set(this.format===a.RGBA&&(!e||!1!==e.premultiply)),i||this.size&&this.size[0]===n&&this.size[1]===r){const{x:e,y:o}=i||{x:0,y:0};t instanceof Zu||t instanceof Wu||t instanceof qu||t instanceof Xu||Yu&&t instanceof Yu?a.texSubImage2D(a.TEXTURE_2D,0,e,o,a.RGBA,a.UNSIGNED_BYTE,t):a.texSubImage2D(a.TEXTURE_2D,0,e,o,n,r,a.RGBA,a.UNSIGNED_BYTE,t.data)}else this.size=[n,r],t instanceof Zu||t instanceof Wu||t instanceof qu||t instanceof Xu||Yu&&t instanceof Yu?a.texImage2D(a.TEXTURE_2D,0,this.format,this.format,a.UNSIGNED_BYTE,t):a.texImage2D(a.TEXTURE_2D,0,this.format,n,r,0,this.format,a.UNSIGNED_BYTE,t.data);this.useMipmap=Boolean(e&&e.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&a.generateMipmap(a.TEXTURE_2D)}bind(t,e){const{context:i}=this,{gl:n}=i;n.bindTexture(n.TEXTURE_2D,this.texture),t!==this.filter&&(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,this.useMipmap?t===n.NEAREST?n.NEAREST_MIPMAP_NEAREST:n.LINEAR_MIPMAP_NEAREST:t),this.filter=t),e!==this.wrap&&(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,e),this.wrap=e)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class Ju{constructor(t,e){this.width=t,this.height=e,this.nextRow=0,this.image=new gl({width:t,height:e}),this.positions={},this.uploaded=!1}getDash(t,e){const i=this.getKey(t,e);return this.positions[i]}trim(){const t=this.width,e=this.height=ot(this.nextRow);this.image.resize({width:t,height:e})}getKey(t,e){return t.join(",")+e}getDashRanges(t,e,i){const n=[];let r=t.length%2==1?-t[t.length-1]*i:0,o=t[0]*i,a=!0;n.push({left:r,right:o,isDash:a,zeroLength:0===t[0]});let s=t[0];for(let e=1;e<t.length;e++){a=!a;const l=t[e];r=s*i,s+=l,o=s*i,n.push({left:r,right:o,isDash:a,zeroLength:0===l})}return n}addRoundDash(t,e,i){const n=e/2;for(let e=-i;e<=i;e++){const r=this.width*(this.nextRow+i+e);let o=0,a=t[o];for(let s=0;s<this.width;s++){s/a.right>1&&(a=t[++o]);const l=Math.abs(s-a.left),c=Math.abs(s-a.right),h=Math.min(l,c);let u;const d=e/i*(n+1);if(a.isDash){const t=n-Math.abs(d);u=Math.sqrt(h*h+t*t)}else u=n-Math.sqrt(h*h+d*d);this.image.data[r+s]=Math.max(0,Math.min(255,u+128))}}}addRegularDash(t,e){for(let e=t.length-1;e>=0;--e){const i=t[e],n=t[e+1];i.zeroLength?t.splice(e,1):n&&n.isDash===i.isDash&&(n.left=i.left,t.splice(e,1))}const i=t[0],n=t[t.length-1];i.isDash===n.isDash&&(i.left=n.left-this.width,n.right=i.right+this.width);const r=this.width*this.nextRow;let o=0,a=t[o];for(let i=0;i<this.width;i++){i/a.right>1&&(a=t[++o]);const n=Math.abs(i-a.left),s=Math.abs(i-a.right),l=Math.min(n,s);this.image.data[r+i]=Math.max(0,Math.min(255,(a.isDash?l:-l)+e+128))}}addDash(t,e){const i=this.getKey(t,e);if(this.positions[i])return this.positions[i];const n="round"===e,r=n?7:0,o=2*r+1;if(this.nextRow+o>this.height)return pt("LineAtlas out of space"),null;0===t.length&&t.push(1);let a=0;for(let e=0;e<t.length;e++)t[e]<0&&(pt("Negative value is found in line dasharray, replacing values with 0"),t[e]=0),a+=t[e];if(0!==a){const i=this.width/a,o=this.getDashRanges(t,this.width,i);n?this.addRoundDash(o,i,r):this.addRegularDash(o,"square"===e?.5*i:0)}const s=this.nextRow+r;this.nextRow+=o;const l={tl:[s,r],br:[a,0]};return this.positions[i]=l,l}}zr("LineAtlas",Ju);class Ku{constructor(t){this._callback=t,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){delete this._channel,this._callback=()=>{}}}const Qu=s.performance;function td(t){const e=t?t.url.toString():void 0;return Qu.getEntriesByName(e)}class ed{constructor(){this.tasks={},this.taskQueue=[],st(["process"],this),this.invoker=new Ku(this.process),this.nextId=0}add(t,e){const i=this.nextId++,n=function({type:t,isSymbolTile:e,zoom:i}){return i=i||0,"message"===t?0:"maybePrepare"!==t||e?"parseTile"!==t||e?"parseTile"===t&&e?300-i:"maybePrepare"===t&&e?400-i:500:200-i:100-i}(e);if(0===n){gt();try{t()}finally{}return{cancel:()=>{}}}return this.tasks[i]={fn:t,metadata:e,priority:n,id:i},this.taskQueue.push(i),this.invoker.trigger(),{cancel:()=>{delete this.tasks[i]}}}process(){gt();try{if(this.taskQueue=this.taskQueue.filter(t=>!!this.tasks[t]),!this.taskQueue.length)return;const t=this.pick();if(null===t)return;const e=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!e)return;e.fn()}finally{}}pick(){let t=null,e=1/0;for(let i=0;i<this.taskQueue.length;i++){const n=this.tasks[this.taskQueue[i]];n.priority<e&&(e=n.priority,t=i)}if(null===t)return null;const i=this.taskQueue[t];return this.taskQueue.splice(t,1),i}remove(){this.invoker.remove()}}function id(t,e,i){var n=2*Math.PI*6378137/256/Math.pow(2,i);return[t*n-2*Math.PI*6378137/2,e*n-2*Math.PI*6378137/2]}class nd{constructor(t,e,i){this.z=t,this.x=e,this.y=i,this.key=ad(0,t,t,e,i)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,e){const i=function(t,e,i){var n=id(256*t,256*(e=Math.pow(2,i)-e-1),i),r=id(256*(t+1),256*(e+1),i);return n[0]+","+n[1]+","+r[0]+","+r[1]}(this.x,this.y,this.z),n=function(t,e,i){let n,r="";for(let o=t;o>0;o--)n=1<<o-1,r+=(e&n?1:0)+(i&n?2:0);return r}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace("{z}",String(this.z)).replace("{x}",String(this.x)).replace("{y}",String("tms"===e?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",n).replace("{bbox-epsg-3857}",i)}toString(){return`${this.z}/${this.x}/${this.y}`}}class rd{constructor(t,e){this.wrap=t,this.canonical=e,this.key=ad(t,e.z,e.z,e.x,e.y)}}class od{constructor(t,e,i,n,r){this.overscaledZ=t,this.wrap=e,this.canonical=new nd(i,+n,+r),this.key=0===e&&t===i?this.canonical.key:ad(e,t,i,n,r)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const e=this.canonical.z-t;return t>this.canonical.z?new od(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new od(t,this.wrap,t,this.canonical.x>>e,this.canonical.y>>e)}calculateScaledKey(t,e=!0){if(this.overscaledZ===t&&e)return this.key;if(t>this.canonical.z)return ad(this.wrap*+e,t,this.canonical.z,this.canonical.x,this.canonical.y);{const i=this.canonical.z-t;return ad(this.wrap*+e,t,t,this.canonical.x>>i,this.canonical.y>>i)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const e=this.canonical.z-t.canonical.z;return 0===t.overscaledZ||t.overscaledZ<this.overscaledZ&&t.canonical.x===this.canonical.x>>e&&t.canonical.y===this.canonical.y>>e}children(t){if(this.overscaledZ>=t)return[new od(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const e=this.canonical.z+1,i=2*this.canonical.x,n=2*this.canonical.y;return[new od(e,this.wrap,e,i,n),new od(e,this.wrap,e,i+1,n),new od(e,this.wrap,e,i,n+1),new od(e,this.wrap,e,i+1,n+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new od(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new od(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new rd(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function ad(t,e,i,n,r){const o=1<<Math.min(i,22);let a=o*(r%o)+n%o;return t&&i<22&&(a+=o*o*((t<0?-2*t-1:2*t)%(1<<2*(22-i)))),16*(32*a+i)+(e-i)}zr("CanonicalTileID",nd),zr("OverscaledTileID",od,{omit:["projMatrix"]});class sd{constructor(t,e,i){this.func=t,this.mask=e,this.range=i}}sd.ReadOnly=!1,sd.ReadWrite=!0,sd.disabled=new sd(519,sd.ReadOnly,[0,1]);class ld{constructor(t,e,i,n,r,o){this.test=t,this.ref=e,this.mask=i,this.fail=n,this.depthFail=r,this.pass=o}}ld.disabled=new ld({func:519,mask:0},0,0,7680,7680,7680);class cd{constructor(t,e,i){this.blendFunction=t,this.blendColor=e,this.mask=i}}cd.Replace=[1,0],cd.disabled=new cd(cd.Replace,We.transparent,[!1,!1,!1,!1]),cd.unblended=new cd(cd.Replace,We.transparent,[!0,!0,!0,!0]),cd.alphaBlended=new cd([1,771],We.transparent,[!0,!0,!0,!0]);class hd{constructor(t,e,i){this.enable=t,this.mode=e,this.frontFace=i}}hd.disabled=new hd(!1,1029,2305),hd.backCCW=new hd(!0,1029,2305),hd.backCW=new hd(!0,1029,2304),hd.frontCW=new hd(!0,1028,2304),hd.frontCCW=new hd(!0,1028,2305);class ud{constructor(t){this._stringToNumber={},this._numberToString=[];for(let e=0;e<t.length;e++){const i=t[e];this._stringToNumber[i]=e,this._numberToString[e]=i}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}class dd{constructor(t,e,i,n,r){this.type="Feature",this._vectorTileFeature=t,t._z=e,t._x=i,t._y=n,this.properties=t.properties,this.id=r}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={geometry:this.geometry};for(const e in this)"_geometry"!==e&&"_vectorTileFeature"!==e&&(t[e]=this[e]);return t}}class pd{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,e,i){const n=String(e);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][n]=this.stateChanges[t][n]||{},et(this.stateChanges[t][n],i),null===this.deletedStates[t]){this.deletedStates[t]={};for(const e in this.state[t])e!==n&&(this.deletedStates[t][e]=null)}else if(this.deletedStates[t]&&null===this.deletedStates[t][n]){this.deletedStates[t][n]={};for(const e in this.state[t][n])i[e]||(this.deletedStates[t][n][e]=null)}else for(const e in i)this.deletedStates[t]&&this.deletedStates[t][n]&&null===this.deletedStates[t][n][e]&&delete this.deletedStates[t][n][e]}removeFeatureState(t,e,i){if(null===this.deletedStates[t])return;const n=String(e);if(this.deletedStates[t]=this.deletedStates[t]||{},i&&void 0!==e)null!==this.deletedStates[t][n]&&(this.deletedStates[t][n]=this.deletedStates[t][n]||{},this.deletedStates[t][n][i]=null);else if(void 0!==e)if(this.stateChanges[t]&&this.stateChanges[t][n])for(i in this.deletedStates[t][n]={},this.stateChanges[t][n])this.deletedStates[t][n][i]=null;else this.deletedStates[t][n]=null;else this.deletedStates[t]=null}getState(t,e){const i=String(e),n=et({},(this.state[t]||{})[i],(this.stateChanges[t]||{})[i]);if(null===this.deletedStates[t])return{};if(this.deletedStates[t]){const i=this.deletedStates[t][e];if(null===i)return{};for(const t in i)delete n[t]}return n}initializeTileState(t,e){t.setFeatureState(this.state,e)}coalesceChanges(t,e){const i={};for(const t in this.stateChanges){this.state[t]=this.state[t]||{};const e={};for(const i in this.stateChanges[t])this.state[t][i]||(this.state[t][i]={}),et(this.state[t][i],this.stateChanges[t][i]),e[i]=this.state[t][i];i[t]=e}for(const t in this.deletedStates){this.state[t]=this.state[t]||{};const e={};if(null===this.deletedStates[t])for(const i in this.state[t])e[i]={},this.state[t][i]={};else for(const i in this.deletedStates[t]){if(null===this.deletedStates[t][i])this.state[t][i]={};else for(const e of Object.keys(this.deletedStates[t][i]))delete this.state[t][i][e];e[i]=this.state[t][i]}i[t]=i[t]||{},et(i[t],e)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(i).length)for(const n in t)t[n].setFeatureState(i,e)}}class fd{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,e){const i=this.toIdx(t,e);return{min:this.minimums[i],max:this.maximums[i]}}isLeaf(t,e){return this.leaves[this.toIdx(t,e)]}toIdx(t,e){return e*this.size+t}}function md(t,e,i,n){let r=0,o=Number.MAX_VALUE;for(let a=0;a<3;a++)if(Math.abs(n[a])<1e-15){if(i[a]<t[a]||i[a]>e[a])return null}else{const s=1/n[a];let l=(t[a]-i[a])*s,c=(e[a]-i[a])*s;if(l>c){const t=l;l=c,c=t}if(l>r&&(r=l),c<o&&(o=c),r>o)return null}return r}function gd(t,e,i,n,r,o,a,s,l,c,h){const u=n-t,d=r-e,p=o-i,f=a-t,m=s-e,g=l-i,y=h[1]*g-h[2]*m,_=h[2]*f-h[0]*g,v=h[0]*m-h[1]*f,x=u*y+d*_+p*v;if(Math.abs(x)<1e-15)return null;const b=1/x,w=c[0]-t,M=c[1]-e,T=c[2]-i,S=(w*y+M*_+T*v)*b;if(S<0||S>1)return null;const E=M*p-T*d,C=T*u-w*p,A=w*d-M*u,P=(h[0]*E+h[1]*C+h[2]*A)*b;return P<0||S+P>1?null:(f*E+m*C+g*A)*b}function yd(t,e,i){return(t-e)/(i-e)}function _d(t,e,i,n,r,o,a,s,l){const c=1<<i,h=o-n,u=a-r,d=(t+1)/c*h+n,p=(e+0)/c*u+r,f=(e+1)/c*u+r;s[0]=(t+0)/c*h+n,s[1]=p,l[0]=d,l[1]=f}class vd{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const e=function(t){const e=Math.ceil(Math.log2(t.dim/8)),i=[];let n=Math.ceil(Math.pow(2,e));const r=1/n,o=(t,e,i,n,r)=>{const o=n?1:0,a=(t+1)*i-o,s=e*i,l=(e+1)*i-o;r[0]=t*i,r[1]=s,r[2]=a,r[3]=l};let a=new fd(n);const s=[];for(let e=0;e<n*n;e++){o(e%n,Math.floor(e/n),r,!1,s);const i=bd(s[0],s[1],t),l=bd(s[2],s[1],t),c=bd(s[2],s[3],t),h=bd(s[0],s[3],t);a.minimums.push(Math.min(i,l,c,h)),a.maximums.push(Math.max(i,l,c,h)),a.leaves.push(1)}for(i.push(a),n/=2;n>=1;n/=2){const t=i[i.length-1];a=new fd(n);for(let e=0;e<n*n;e++){o(e%n,Math.floor(e/n),2,!0,s);const i=t.getElevation(s[0],s[1]),r=t.getElevation(s[2],s[1]),l=t.getElevation(s[2],s[3]),c=t.getElevation(s[0],s[3]),h=t.isLeaf(s[0],s[1]),u=t.isLeaf(s[2],s[1]),d=t.isLeaf(s[2],s[3]),p=t.isLeaf(s[0],s[3]),f=Math.min(i.min,r.min,l.min,c.min),m=Math.max(i.max,r.max,l.max,c.max),g=h&&u&&d&&p;a.maximums.push(m),a.minimums.push(f),a.leaves.push(m-f<=5&&g?1:0)}i.push(a)}return i}(this.dem),i=e.length-1,n=e[i];this._addNode(n.minimums[0],n.maximums[0],n.leaves[0]),this._construct(e,0,0,i,0)}raycastRoot(t,e,i,n,r,o,a=1){return md([t,e,-100],[i,n,this.maximums[0]*a],r,o)}raycast(t,e,i,n,r,o,a=1){if(!this.nodeCount)return null;const s=this.raycastRoot(t,e,i,n,r,o,a);if(null==s)return null;const l=[],c=[],h=[],u=[],d=[{idx:0,t:s,nodex:0,nodey:0,depth:0}];for(;d.length>0;){const{idx:s,t:p,nodex:f,nodey:m,depth:g}=d.pop();if(this.leaves[s]){_d(f,m,g,t,e,i,n,h,u);const s=1<<g,l=(f+0)/s,c=(f+1)/s,d=(m+0)/s,y=(m+1)/s,_=bd(l,d,this.dem)*a,v=bd(c,d,this.dem)*a,x=bd(c,y,this.dem)*a,b=bd(l,y,this.dem)*a,w=gd(h[0],h[1],_,u[0],h[1],v,u[0],u[1],x,r,o),M=gd(u[0],u[1],x,h[0],u[1],b,h[0],h[1],_,r,o),T=Math.min(null!==w?w:Number.MAX_VALUE,null!==M?M:Number.MAX_VALUE);if(T!==Number.MAX_VALUE)return T;{const t=C([],r,o,p);if(xd(_,v,b,x,yd(t[0],h[0],u[0]),yd(t[1],h[1],u[1]))>=t[2])return p}continue}let y=0;for(let d=0;d<this._siblingOffset.length;d++){_d((f<<1)+this._siblingOffset[d][0],(m<<1)+this._siblingOffset[d][1],g+1,t,e,i,n,h,u),h[2]=-100,u[2]=this.maximums[this.childOffsets[s]+d]*a;const p=md(h,u,r,o);if(null!=p){const t=p;l[d]=t;let e=!1;for(let i=0;i<y&&!e;i++)t>=l[c[i]]&&(c.splice(i,0,d),e=!0);e||(c[y]=d),y++}}for(let t=0;t<y;t++){const e=c[t];d.push({idx:this.childOffsets[s]+e,t:l[e],nodex:(f<<1)+this._siblingOffset[e][0],nodey:(m<<1)+this._siblingOffset[e][1],depth:g+1})}}return null}_addNode(t,e,i){return this.minimums.push(t),this.maximums.push(e),this.leaves.push(i),this.childOffsets.push(0),this.nodeCount++}_construct(t,e,i,n,r){if(1===t[n].isLeaf(e,i))return;this.childOffsets[r]||(this.childOffsets[r]=this.nodeCount);const o=n-1,a=t[o];let s,l=0;for(let t=0;t<this._siblingOffset.length;t++){const n=2*e+this._siblingOffset[t][0],r=2*i+this._siblingOffset[t][1],o=a.getElevation(n,r),c=a.isLeaf(n,r),h=this._addNode(o.min,o.max,c);c&&(l|=1<<t),s||(s=h)}for(let n=0;n<this._siblingOffset.length;n++)l&1<<n||this._construct(t,2*e+this._siblingOffset[n][0],2*i+this._siblingOffset[n][1],o,s+n)}}function xd(t,e,i,n,r,o){return Bi(Bi(t,i,o),Bi(e,n,o),r)}function bd(t,e,i){const n=i.dim,r=$(t*n-.5,0,n-1),o=$(e*n-.5,0,n-1),a=Math.floor(r),s=Math.floor(o),l=Math.min(a+1,n-1),c=Math.min(s+1,n-1);return xd(i.get(a,s),i.get(l,s),i.get(a,c),i.get(l,c),r-a,o-s)}const wd={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};class Md{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,e,i,n=!1,r=!1){if(this.uid=t,e.height!==e.width)throw new RangeError("DEM tiles must be square");if(i&&"mapbox"!==i&&"terrarium"!==i)return pt(`"${i}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=e.height;const o=this.dim=e.height-2;if(this.data=new Uint32Array(e.data.buffer),this.encoding=i||"mapbox",this.borderReady=n,!n){for(let t=0;t<o;t++)this.data[this._idx(-1,t)]=this.data[this._idx(0,t)],this.data[this._idx(o,t)]=this.data[this._idx(o-1,t)],this.data[this._idx(t,-1)]=this.data[this._idx(t,0)],this.data[this._idx(t,o)]=this.data[this._idx(t,o-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(o,-1)]=this.data[this._idx(o-1,0)],this.data[this._idx(-1,o)]=this.data[this._idx(0,o-1)],this.data[this._idx(o,o)]=this.data[this._idx(o-1,o-1)],r&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new vd(this)}get(t,e,i=!1){const n=new Uint8Array(this.data.buffer);i&&(t=$(t,-1,this.dim),e=$(e,-1,this.dim));const r=4*this._idx(t,e);return("terrarium"===this.encoding?this._unpackTerrarium:this._unpackMapbox)(n[r],n[r+1],n[r+2])}static getUnpackVector(t){return wd[t]}get unpackVector(){return wd[this.encoding]}_idx(t,e){if(t<-1||t>=this.dim+1||e<-1||e>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(e+1)*this.stride+(t+1)}_unpackMapbox(t,e,i){return(256*t*256+256*e+i)/10-1e4}_unpackTerrarium(t,e,i){return 256*t+e+i/256-32768}static pack(t,e){const i=[0,0,0,0],n=Md.getUnpackVector(e);let r=Math.floor((t+n[3])/n[2]);return i[2]=r%256,r=Math.floor(r/256),i[1]=r%256,r=Math.floor(r/256),i[0]=r,i}getPixels(){return new yl({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(t,e,i){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let n=e*this.dim,r=e*this.dim+this.dim,o=i*this.dim,a=i*this.dim+this.dim;switch(e){case-1:n=r-1;break;case 1:r=n+1}switch(i){case-1:o=a-1;break;case 1:a=o+1}const s=-e*this.dim,l=-i*this.dim;for(let e=o;e<a;e++)for(let i=n;i<r;i++)this.data[this._idx(i,e)]=t.data[this._idx(i+s,e+l)]}onDeserialize(){this._tree&&(this._tree.dem=this)}}zr("DEMData",Md),zr("DemMinMaxQuadTree",vd,{omit:["dem"]});class Td{constructor(t,e){this.max=t,this.onRemove=e,this.reset()}reset(){for(const t in this.data)for(const e of this.data[t])e.timeout&&clearTimeout(e.timeout),this.onRemove(e.value);return this.data={},this.order=[],this}add(t,e,i){const n=t.wrapped().key;void 0===this.data[n]&&(this.data[n]=[]);const r={value:e,timeout:void 0};if(void 0!==i&&(r.timeout=setTimeout(()=>{this.remove(t,r)},i)),this.data[n].push(r),this.order.push(n),this.order.length>this.max){const t=this._getAndRemoveByKey(this.order[0]);t&&this.onRemove(t)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const e=this.data[t].shift();return e.timeout&&clearTimeout(e.timeout),0===this.data[t].length&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),e.value}getByKey(t){const e=this.data[t];return e?e[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,e){if(!this.has(t))return this;const i=t.wrapped().key,n=void 0===e?0:this.data[i].indexOf(e),r=this.data[i][n];return this.data[i].splice(n,1),r.timeout&&clearTimeout(r.timeout),0===this.data[i].length&&delete this.data[i],this.onRemove(r.value),this.order.splice(this.order.indexOf(i),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const t=this._getAndRemoveByKey(this.order[0]);t&&this.onRemove(t)}return this}filter(t){const e=[];for(const i in this.data)for(const n of this.data[i])t(n.value)||e.push(n);for(const t of e)this.remove(t.value.tileID,t)}}class Sd extends ve{constructor(t,e,i){super(),this.id=t,this._onlySymbols=i,e.on("data",t=>{"source"===t.dataType&&"metadata"===t.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===t.dataType&&"content"===t.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))}),e.on("error",()=>{this._sourceErrored=!0}),this._source=e,this._tiles={},this._cache=new Td(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=null,this._maxTileCacheSize=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new pd}onAdd(t){this.map=t,this._minTileCacheSize=t?t._minTileCacheSize:null,this._maxTileCacheSize=t?t._maxTileCacheSize:null}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const t in this._tiles){const e=this._tiles[t];if("loaded"!==e.state&&"errored"!==e.state)return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,e){return t.isSymbolTile=this._onlySymbols,this._source.loadTile(t,e)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t,()=>{})}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t,()=>{})}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const e in this._tiles){const i=this._tiles[e];i.upload(t),i.prepare(this.map.style.imageManager)}}getIds(){return tt(this._tiles).map(t=>t.tileID).sort(Ed).map(t=>t.key)}getRenderableIds(t){const e=[];for(const i in this._tiles)this._isIdRenderable(+i,t)&&e.push(this._tiles[i]);return t?e.sort((t,e)=>{const i=t.tileID,n=e.tileID,r=new o(i.canonical.x,i.canonical.y)._rotate(this.transform.angle),a=new o(n.canonical.x,n.canonical.y)._rotate(this.transform.angle);return i.overscaledZ-n.overscaledZ||a.y-r.y||a.x-r.x}).map(t=>t.tileID.key):e.map(t=>t.tileID).sort(Ed).map(t=>t.key)}hasRenderableParent(t){const e=this.findLoadedParent(t,0);return!!e&&this._isIdRenderable(e.tileID.key)}_isIdRenderable(t,e){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(e||!this._tiles[t].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)"errored"!==this._tiles[t].state&&this._reloadTile(+t,"reloading")}}_reloadTile(t,e){const i=this._tiles[t];i&&("loading"!==i.state&&(i.state=e),this._loadTile(i,this._tileLoaded.bind(this,i,t,e)))}_tileLoaded(t,e,i,n){if(n)if(t.state="errored",404!==n.status)this._source.fire(new _e(n,{tile:t}));else if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const t=this.map.painter.terrain;this.update(this.transform,t.getScaledDemTileSize(),!0),t.resetTileLookupCache(this.id)}else this.update(this.transform);else t.timeAdded=Tt.now(),"expired"===i&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(e,t),"raster-dem"===this._source.type&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new ye("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const e=this.getRenderableIds();for(let n=0;n<e.length;n++){const r=e[n];if(t.neighboringTiles&&t.neighboringTiles[r]){const e=this.getTileByID(r);i(t,e),i(e,t)}}function i(t,e){if(!t.dem||t.dem.borderReady)return;t.needsHillshadePrepare=!0,t.needsDEMTextureUpload=!0;let i=e.tileID.canonical.x-t.tileID.canonical.x;const n=e.tileID.canonical.y-t.tileID.canonical.y,r=Math.pow(2,t.tileID.canonical.z),o=e.tileID.key;0===i&&0===n||Math.abs(n)>1||(Math.abs(i)>1&&(1===Math.abs(i+r)?i+=r:1===Math.abs(i-r)&&(i-=r)),e.dem&&t.dem&&(t.dem.backfillBorder(e.dem,i,n),t.neighboringTiles&&t.neighboringTiles[o]&&(t.neighboringTiles[o].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,e,i,n){for(const r in this._tiles){let o=this._tiles[r];if(n[r]||!o.hasData()||o.tileID.overscaledZ<=e||o.tileID.overscaledZ>i)continue;let a=o.tileID;for(;o&&o.tileID.overscaledZ>e+1;){const t=o.tileID.scaledTo(o.tileID.overscaledZ-1);o=this._tiles[t.key],o&&o.hasData()&&(a=t)}let s=a;for(;s.overscaledZ>e;)if(s=s.scaledTo(s.overscaledZ-1),t[s.key]){n[a.key]=a;break}}}findLoadedParent(t,e){if(t.key in this._loadedParentTiles){const i=this._loadedParentTiles[t.key];return i&&i.tileID.overscaledZ>=e?i:null}for(let i=t.overscaledZ-1;i>=e;i--){const e=t.scaledTo(i),n=this._getLoadedTile(e);if(n)return n}}_getLoadedTile(t){const e=this._tiles[t.key];return e&&e.hasData()?e:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,e){e=e||this._source.tileSize;const i=Math.ceil(t.width/e)+1,n=Math.ceil(t.height/e)+1,r=Math.floor(i*n*5),o="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,r):r,a="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,o):o;this._cache.setMaxSize(a)}handleWrapJump(t){const e=Math.round((t-(void 0===this._prevLng?t:this._prevLng))/360);if(this._prevLng=t,e){const t={};for(const i in this._tiles){const n=this._tiles[i];n.tileID=n.tileID.unwrapTo(n.tileID.wrap+e),t[n.tileID.key]=n}this._tiles=t;for(const t in this._timers)clearTimeout(this._timers[t]),delete this._timers[t];for(const t in this._tiles)this._setTileReloadTimer(+t,this._tiles[t])}}update(t,e,i){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!i)return;let n;this.updateCacheSize(t,e),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?n=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(t=>new od(t.canonical.z,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y)):(n=t.coveringTiles({tileSize:e||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!i,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(n=n.filter(t=>this._source.hasTile(t)))):n=[];const r=this._updateRetainedTiles(n);if(Cd(this._source.type)&&0!==n.length){const t={},e={},i=Object.keys(r);for(const n of i){const i=r[n],o=this._tiles[n];if(!o||o.fadeEndTime&&o.fadeEndTime<=Tt.now())continue;const a=this.findLoadedParent(i,Math.max(i.overscaledZ-Sd.maxOverzooming,this._source.minzoom));a&&(this._addTile(a.tileID),t[a.tileID.key]=a.tileID),e[n]=i}const o=n[n.length-1].overscaledZ;for(const t in this._tiles){const i=this._tiles[t];if(r[t]||!i.hasData())continue;let n=i.tileID;for(;n.overscaledZ>o;){n=n.scaledTo(n.overscaledZ-1);const o=this._tiles[n.key];if(o&&o.hasData()&&e[n.key]){r[t]=i.tileID;break}}}for(const e in t)r[e]||(this._coveredTiles[e]=!0,r[e]=t[e])}for(const t in r)this._tiles[t].clearFadeHold();const o=function(t,e){const i=[];for(const n in t)n in e||i.push(n);return i}(this._tiles,r);for(const t of o){const e=this._tiles[t];e.hasSymbolBuckets&&!e.holdingForFade()?e.setHoldDuration(this.map._fadeDuration):e.hasSymbolBuckets&&!e.symbolFadeFinished()||this._removeTile(+t)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const e={};if(0===t.length)return e;const i={},n=t.reduce((t,e)=>Math.min(t,e.overscaledZ),1/0),r=t[0].overscaledZ,o=Math.max(r-Sd.maxOverzooming,this._source.minzoom),a=Math.max(r+Sd.maxUnderzooming,this._source.minzoom),s={};for(const i of t){const t=this._addTile(i);e[i.key]=i,t.hasData()||n<this._source.maxzoom&&(s[i.key]=i)}this._retainLoadedChildren(s,n,a,e);for(const n of t){let t=this._tiles[n.key];if(t.hasData())continue;if(n.canonical.z>=this._source.maxzoom){const t=n.children(this._source.maxzoom)[0],i=this.getTile(t);if(i&&i.hasData()){e[t.key]=t;continue}}else{const t=n.children(this._source.maxzoom);if(e[t[0].key]&&e[t[1].key]&&e[t[2].key]&&e[t[3].key])continue}let r=t.wasRequested();for(let a=n.overscaledZ-1;a>=o;--a){const o=n.scaledTo(a);if(i[o.key])break;if(i[o.key]=!0,t=this.getTile(o),!t&&r&&(t=this._addTile(o)),t&&(e[o.key]=o,r=t.wasRequested(),t.hasData()))break}}return e}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const e=[];let i,n=this._tiles[t].tileID;for(;n.overscaledZ>0;){if(n.key in this._loadedParentTiles){i=this._loadedParentTiles[n.key];break}e.push(n.key);const t=n.scaledTo(n.overscaledZ-1);if(i=this._getLoadedTile(t),i)break;n=t}for(const t of e)this._loadedParentTiles[t]=i}}_addTile(t){let e=this._tiles[t.key];if(e)return e;e=this._cache.getAndRemove(t),e&&(this._setTileReloadTimer(t.key,e),e.tileID=t,this._state.initializeTileState(e,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,e)));const i=Boolean(e);if(!i){const i=this.map?this.map.painter:null,n="raster"===this._source.type||"raster-dem"===this._source.type;e=new jd(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,i,n),this._loadTile(e,this._tileLoaded.bind(this,e,t.key,e.state))}return e?(e.uses++,this._tiles[t.key]=e,i||this._source.fire(new ye("dataloading",{tile:e,coord:e.tileID,dataType:"source"})),e):null}_setTileReloadTimer(t,e){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const i=e.getExpiryTimeout();i&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},i))}_removeTile(t){const e=this._tiles[t];e&&(e.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),e.uses>0||(e.hasData()&&"reloading"!==e.state?this._cache.add(e.tileID,e,e.getExpiryTimeout()):(e.aborted=!0,this._abortTile(e),this._unloadTile(e))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset()}tilesIn(t,e,i){const n=[],r=this.transform;if(!r)return n;for(const o in this._tiles){const a=this._tiles[o];if(i&&a.clearQueryDebugViz(),a.holdingForFade())continue;const s=t.containsTile(a,r,e);s&&n.push(s)}return n}getVisibleCoordinates(t){const e=this.getRenderableIds(t).map(t=>this._tiles[t].tileID);for(const t of e)t.projMatrix=this.transform.calculateProjMatrix(t.toUnwrapped());return e}hasTransition(){if(this._source.hasTransition())return!0;if(Cd(this._source.type))for(const t in this._tiles){const e=this._tiles[t];if(void 0!==e.fadeEndTime&&e.fadeEndTime>=Tt.now())return!0}return!1}setFeatureState(t,e,i){this._state.updateState(t=t||"_geojsonTileLayer",e,i)}removeFeatureState(t,e,i){this._state.removeFeatureState(t=t||"_geojsonTileLayer",e,i)}getFeatureState(t,e){return this._state.getState(t=t||"_geojsonTileLayer",e)}setDependencies(t,e,i){const n=this._tiles[t];n&&n.setDependencies(e,i)}reloadTilesForDependencies(t,e){for(const i in this._tiles)this._tiles[i].hasDependency(t,e)&&this._reloadTile(+i,"reloading");this._cache.filter(i=>!i.hasDependency(t,e))}_preloadTiles(t,e){const i=new Map,n=Array.isArray(t)?t:[t],r=this.map.painter.terrain,o=this.usedForTerrain&&r?r.getScaledDemTileSize():this._source.tileSize;for(const t of n){const e=t.coveringTiles({tileSize:o,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const t of e)i.set(t.key,t);this.usedForTerrain&&t.updateElevation(!1)}const a=Array.from(i.values()),s="raster"===this._source.type||"raster-dem"===this._source.type;Q(a,(t,e)=>{const i=new jd(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,this.map.painter,s);this._loadTile(i,t=>{"raster-dem"===this._source.type&&i.dem&&this._backfillDEM(i),e(t,i)})},e)}}function Ed(t,e){const i=Math.abs(2*t.wrap)-+(t.wrap<0),n=Math.abs(2*e.wrap)-+(e.wrap<0);return t.overscaledZ-e.overscaledZ||n-i||e.canonical.y-t.canonical.y||e.canonical.x-t.canonical.x}function Cd(t){return"raster"===t||"image"===t||"video"===t}Sd.maxOverzooming=10,Sd.maxUnderzooming=3;class Ad{constructor(t,e,i){this._demTile=t,this._dem=this._demTile.dem,this._scale=e,this._offset=i}static create(t,e,i){const n=i||t.findDEMTileFor(e);if(!n||!n.dem)return;const r=n.dem,o=n.tileID,a=1<<e.canonical.z-o.canonical.z;return new Ad(n,n.tileSize/_s/a,[(e.canonical.x/a-o.canonical.x)*r.dim,(e.canonical.y/a-o.canonical.y)*r.dim])}tileCoordToPixel(t,e){const i=e*this._scale+this._offset[1],n=Math.floor(t*this._scale+this._offset[0]),r=Math.floor(i);return new o(n,r)}getElevationAt(t,e,i,n){const r=t*this._scale+this._offset[0],o=e*this._scale+this._offset[1],a=Math.floor(r),s=Math.floor(o),l=this._dem;return n=!!n,i?Bi(Bi(l.get(a,s,n),l.get(a,s+1,n),o-s),Bi(l.get(a+1,s,n),l.get(a+1,s+1,n),o-s),r-a):l.get(a,s,n)}getElevationAtPixel(t,e,i){return this._dem.get(t,e,!!i)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*Es(1,t)*this._dem.stride}}class Pd{constructor(t,e){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new Ir(_s,16,0),this.featureIndexArray=new Oa,this.promoteId=e}insert(t,e,i,n,r,o=0){const a=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(i,n,r,o);const s=this.grid;for(let t=0;t<e.length;t++){const i=e[t],n=[1/0,1/0,-1/0,-1/0];for(let t=0;t<i.length;t++){const e=i[t];n[0]=Math.min(n[0],e.x),n[1]=Math.min(n[1],e.y),n[2]=Math.max(n[2],e.x),n[3]=Math.max(n[3],e.y)}n[0]<_s&&n[1]<_s&&n[2]>=0&&n[3]>=0&&s.insert(a,n[0],n[1],n[2],n[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new _c.VectorTile(new rh(this.rawTileData)).layers,this.sourceLayerCoder=new ud(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,e,i,n){this.loadVTLayers();const r=t.params||{},o=Kn(r.filter),a=t.tileResult,s=t.transform,l=a.bufferedTilespaceBounds,c=this.grid.query(l.min.x,l.min.y,l.max.x,l.max.y,(t,e,i,n)=>Js(a.bufferedTilespaceGeometry,t,e,i,n));c.sort(Id);let h=null;s.elevation&&c.length>0&&(h=Ad.create(s.elevation,this.tileID));const u={};let d;for(let s=0;s<c.length;s++){const l=c[s];if(l===d)continue;d=l;const p=this.featureIndexArray.get(l);let f=null;this.loadMatchingFeature(u,p,o,r.layers,r.availableImages,e,i,n,(e,i,n,r=0)=>(f||(f=Bs(e,this.tileID.canonical,t.tileTransform)),i.queryIntersectsFeature(a,e,n,f,this.z,t.transform,t.pixelPosMatrix,h,r)))}return u}loadMatchingFeature(t,e,i,n,r,o,a,s,l){const{featureIndex:c,bucketIndex:h,sourceLayerIndex:u,layoutVertexArrayOffset:d}=e,p=this.bucketLayerIDs[h];if(n&&!function(t,e){for(let i=0;i<t.length;i++)if(e.indexOf(t[i])>=0)return!0;return!1}(n,p))return;const f=this.sourceLayerCoder.decode(u),m=this.vtLayers[f].feature(c);if(i.needGeometry){const t=Fs(m,!0);if(!i.filter(new zo(this.tileID.overscaledZ),t,this.tileID.canonical))return}else if(!i.filter(new zo(this.tileID.overscaledZ),m))return;const g=this.getId(m,f);for(let e=0;e<p.length;e++){const i=p[e];if(n&&n.indexOf(i)<0)continue;const h=o[i];if(!h)continue;let u={};void 0!==g&&s&&(u=s.getState(h.sourceLayer||"_geojsonTileLayer",g));const f=et({},a[i]);f.paint=Ld(f.paint,h.paint,m,u,r),f.layout=Ld(f.layout,h.layout,m,u,r);const y=!l||l(m,h,u,d);if(!y)continue;const _=new dd(m,this.z,this.x,this.y,g);_.layer=f;let v=t[i];void 0===v&&(v=t[i]=[]),v.push({featureIndex:c,feature:_,intersectionZ:y})}}lookupSymbolFeatures(t,e,i,n,r,o,a,s){const l={};this.loadVTLayers();const c=Kn(r);for(const r of t)this.loadMatchingFeature(l,{bucketIndex:i,sourceLayerIndex:n,featureIndex:r,layoutVertexArrayOffset:0},c,o,a,s,e);return l}loadFeature(t){const{featureIndex:e,sourceLayerIndex:i}=t;this.loadVTLayers();const n=this.sourceLayerCoder.decode(i),r=this.vtFeatures[n];if(r[e])return r[e];const o=this.vtLayers[n].feature(e);return r[e]=o,o}hasLayer(t){for(const e of this.bucketLayerIDs)for(const i of e)if(t===i)return!0;return!1}getId(t,e){let i=t.id;return this.promoteId&&(i=t.properties["string"==typeof this.promoteId?this.promoteId:this.promoteId[e]],"boolean"==typeof i&&(i=Number(i))),i}}function Ld(t,e,i,n,r){return ct(t,(t,o)=>{const a=e instanceof Ho?e.get(o):null;return a&&a.evaluate?a.evaluate(i,n,r):a})}function Id(t,e){return e-t}zr("FeatureIndex",Pd,{omit:["rawTileData","sourceLayerCoder"]});var Rd=ea([{name:"a_pos",type:"Int16",components:2}]);const Dd=new Uint16Array(8184);for(let t=0;t<2046;t++){let e=t+2,i=0,n=0,r=0,o=0,a=0,s=0;for(1&e?r=o=a=32:i=n=s=32;(e>>=1)>1;){const t=i+r>>1,l=n+o>>1;1&e?(r=i,o=n,i=a,n=s):(i=r,n=o,r=a,o=s),a=t,s=l}const l=4*t;Dd[l+0]=i,Dd[l+1]=n,Dd[l+2]=r,Dd[l+3]=o}const kd=new Uint16Array(2178),Od=new Uint8Array(1089),zd=new Uint16Array(1089);function Bd(t){return 0===t?-.03125:32===t?.03125:0}var Fd=ea([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const Nd={type:2,extent:_s,loadGeometry:()=>[[new o(0,0),new o(8193,0),new o(8193,8193),new o(0,8193),new o(0,0)]]};class jd{constructor(t,e,i,n,r){this.tileID=t,this.uid=nt(),this.uses=0,this.tileSize=e,this.tileZoom=i,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=r,this.expiredRequestCount=0,this.state="loading",n&&n.transform&&(this.projection=n.transform.projection)}registerFadeDuration(t){const e=t+this.timeAdded;e<Tt.now()||this.fadeEndTime&&e<this.fadeEndTime||(this.fadeEndTime=e)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=np(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,e,i){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(t,e){const i={};if(!e)return i;for(const n of t){const t=n.layerIds.map(t=>e.getLayer(t)).filter(Boolean);if(0!==t.length){n.layers=t,n.stateDependentLayerIds&&(n.stateDependentLayers=n.stateDependentLayerIds.map(e=>t.filter(t=>t.id===e)[0]));for(const e of t)i[e.id]=n}}return i}(t.buckets,e.style),this.hasSymbolBuckets=!1;for(const t in this.buckets){const e=this.buckets[t];if(e instanceof ku){if(this.hasSymbolBuckets=!0,!i)break;e.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const t in this.buckets){const e=this.buckets[t];if(e instanceof ku&&e.hasRTLText){this.hasRTLText=!0,Oo.isLoading()||Oo.isLoaded()||"deferred"!==Do()||ko();break}}this.queryPadding=0;for(const t in this.buckets){const i=this.buckets[t];this.queryPadding=Math.max(this.queryPadding,e.style.getLayer(t).queryRadius(i))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas)}else this.collisionBoxArray=new Ca}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugIndexBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this.globeGridBuffer&&(this.globeGridBuffer.destroy(),this.globeGridBuffer=null),this.globePoleBuffer&&(this.globePoleBuffer.destroy(),this.globePoleBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(t){return this.buckets[t.id]}upload(t){for(const e in this.buckets){const i=this.buckets[e];i.uploadPending()&&i.upload(t)}const e=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new $u(t,this.imageAtlas.image,e.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new $u(t,this.glyphAtlasImage,e.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new $u(t,this.lineAtlas.image,e.ALPHA),this.lineAtlas.uploaded=!0)}prepare(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture)}queryRenderedFeatures(t,e,i,n,r,o,a,s){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:n,pixelPosMatrix:a,transform:o,params:r,tileTransform:this.tileTransform},t,e,i):{}}querySourceFeatures(t,e){const i=this.latestFeatureIndex;if(!i||!i.rawTileData)return;const n=i.loadVTLayers(),r=e?e.sourceLayer:"",o=n._geojsonTileLayer||n[r];if(!o)return;const a=Kn(e&&e.filter),{z:s,x:l,y:c}=this.tileID.canonical,h={z:s,x:l,y:c};for(let e=0;e<o.length;e++){const n=o.feature(e);if(a.needGeometry){const t=Fs(n,!0);if(!a.filter(new zo(this.tileID.overscaledZ),t,this.tileID.canonical))continue}else if(!a.filter(new zo(this.tileID.overscaledZ),n))continue;const u=i.getId(n,r),d=new dd(n,s,l,c,u);d.tile=h,t.push(d)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const e=this.expirationTime;if(t.cacheControl){const e=yt(t.cacheControl);e["max-age"]&&(this.expirationTime=Date.now()+1e3*e["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const t=Date.now();let i=!1;if(this.expirationTime>t)i=!1;else if(e)if(this.expirationTime<e)i=!0;else{const n=this.expirationTime-e;n?this.expirationTime=t+Math.max(n,3e4):i=!0}else i=!0;i?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(t,e){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||0===Object.keys(t).length||!e)return;const i=this.latestFeatureIndex.loadVTLayers(),n=e.style.listImages();for(const r in this.buckets){if(!e.style.hasLayer(r))continue;const o=this.buckets[r],a=o.layers[0].sourceLayer||"_geojsonTileLayer",s=i[a],l=t[a];if(!s||!l||0===Object.keys(l).length)continue;if(o.update(l,s,n,this.imageAtlas&&this.imageAtlas.patternPositions||{}),o instanceof zc||o instanceof rc){const t=e.style._getSourceCache(o.layers[0].source);e._terrain&&e._terrain.enabled&&t&&o.programConfigurations.needsUpload&&e._terrain._clearRenderCacheForTile(t.id,this.tileID)}const c=e&&e.style&&e.style.getLayer(r);c&&(this.queryPadding=Math.max(this.queryPadding,c.queryRadius(o)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<Tt.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=Tt.now()+t}setDependencies(t,e){const i={};for(const t of e)i[t]=!0;this.dependencies[t]=i}hasDependency(t,e){for(const i of t){const t=this.dependencies[i];if(t)for(const i of e)if(t[i])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,e){if(!e||"mercator"===e.name||this._tileDebugBuffer)return;const i=Bs(Nd,this.tileID.canonical,this.tileTransform)[0],n=new na,r=new Ma;for(let t=0;t<i.length;t++){const{x:e,y:o}=i[t];n.emplaceBack(e,o),r.emplaceBack(t)}r.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(r),this._tileDebugBuffer=t.createVertexBuffer(n,Fd.members),this._tileDebugSegments=ys.simpleSegment(0,0,n.length,r.length)}_makeTileBoundsBuffers(t,e){if(this._tileBoundsBuffer||!e||"mercator"===e.name)return;const i=Bs(Nd,this.tileID.canonical,this.tileTransform)[0];let n,r;if(this.isRaster){const t=function(t,e){const i=np(t,e),n=Math.pow(2,t.z);for(let r=0;r<33;r++)for(let o=0;o<33;o++){const a=Cs((t.x+(o+Bd(o))/32)/n),s=As((t.y+(r+Bd(r))/32)/n),l=e.project(a,s),c=33*r+o;kd[2*c+0]=Math.round((l.x*i.scale-i.x)*_s),kd[2*c+1]=Math.round((l.y*i.scale-i.y)*_s)}Od.fill(0),zd.fill(0);for(let t=2045;t>=0;t--){const e=4*t,i=Dd[e+0],n=Dd[e+1],r=Dd[e+2],o=Dd[e+3],a=i+r>>1,s=n+o>>1,l=a+s-n,c=s+i-a,h=33*n+i,u=33*o+r,d=33*s+a,p=Math.hypot((kd[2*h+0]+kd[2*u+0])/2-kd[2*d+0],(kd[2*h+1]+kd[2*u+1])/2-kd[2*d+1])>=16;if(Od[d]=Od[d]||(p?1:0),t<1022){const t=33*(n+c>>1)+(i+l>>1),e=33*(o+c>>1)+(r+l>>1);Od[d]=Od[d]||Od[t]||Od[e]}}const r=new ra,o=new ma;let a=0;function s(t,e){const i=33*e+t;return 0===zd[i]&&(r.emplaceBack(kd[2*i+0],kd[2*i+1],t*_s/32,e*_s/32),zd[i]=++a),zd[i]-1}function l(t,e,i,n,r,a){const c=t+i>>1,h=e+n>>1;if(Math.abs(t-r)+Math.abs(e-a)>1&&Od[33*h+c])l(r,a,t,e,c,h),l(i,n,r,a,c,h);else{const l=s(t,e),c=s(i,n),h=s(r,a);o.emplaceBack(l,c,h)}}return l(0,0,32,32,32,0),l(32,32,0,0,0,32),{vertices:r,indices:o}}(this.tileID.canonical,e);n=t.vertices,r=t.indices}else{n=new ra,r=new ma;for(const{x:t,y:e}of i)n.emplaceBack(t,e,0,0);const t=Ml(n.int16,void 0,4);for(let e=0;e<t.length;e+=3)r.emplaceBack(t[e],t[e+1],t[e+2])}this._tileBoundsBuffer=t.createVertexBuffer(n,Fd.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(r),this._tileBoundsSegments=ys.simpleSegment(0,0,n.length,r.length)}}const Gd=ea([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_merc_pos",components:2},{type:"Float32",name:"a_uv",components:2}]),Ud=ea([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Vd}=Gd;function Hd(t,e){const i=t.fovAboveCenter,n=t.elevation?t.elevation.getMinElevationBelowMSL()*e:0,r=(t._camera.position[2]*t.worldSize-n)/Math.cos(t._pitch),o=Math.sin(i)*r/Math.sin(Math.max(Math.PI/2-t._pitch-i,.01)),a=Math.sin(t._pitch)*o+r;return Math.min(1.01*a,r*(1/t._horizonShift))}const Zd=_s/Math.PI/2,Wd=-Zd,qd=Zd,Xd=[new al([Wd,Wd,Wd],[qd,qd,qd]),new al([Wd,Wd,Wd],[0,0,qd]),new al([0,Wd,Wd],[qd,0,qd]),new al([Wd,0,Wd],[0,qd,qd]),new al([0,0,Wd],[qd,qd,qd])];function Yd(t){if(t.z<=1)return Xd[t.z+2*t.y+t.x];const[e,i]=$d(t),n=[Kd(e[0],e[1]),Kd(e[0],i[1]),Kd(i[0],e[1]),Kd(i[0],i[1])],r=[qd,qd,qd],o=[Wd,Wd,Wd];for(const t of n)r[0]=Math.min(r[0],t[0]),r[1]=Math.min(r[1],t[1]),r[2]=Math.min(r[2],t[2]),o[0]=Math.max(o[0],t[0]),o[1]=Math.max(o[1],t[1]),o[2]=Math.max(o[2],t[2]);return new al(r,o)}function $d(t){const e=Math.pow(2,t.z),i=t.x/e,n=(t.x+1)/e,r=(t.y+1)/e;return[[As(t.y/e),Cs(i)],[As(r),Cs(n)]]}function Jd(t,e,i,n){return i=H(i),n||(n=Zd),[t*Math.sin(i)*n,-e*n,t*Math.cos(i)*n]}function Kd(t,e,i){return Jd(Math.cos(H(t)),Math.sin(H(t)),e,i)}function Qd(t){return 16383/Math.max(...k([],t.max,t.min))}function tp(t){const e=u(new Float64Array(16)),i=1/Qd(t);return p(e,e,t.min),f(e,e,[i,i,i]),e}function ep(t,e,i){const n=e/(2*Math.PI),r=function(t){const e=_s/(2*Math.PI);return t/(2*Math.PI)/e}(e);if(!i){const n=$(t.center.lat,-85.051129,Ls);i=[Ts(t.center.lng)*e,Ss(n)*e]}const o=u(new Float64Array(16));return p(o,o,[i[0],i[1],-n]),f(o,o,[r,r,r]),m(o,o,H(-t._center.lat)),g(o,o,H(-t._center.lng)),o}class ip{constructor(t){const e=this._createGridIndices();this.gridIndexBuffer=t.createIndexBuffer(e,!0),this.gridSegments=ys.simpleSegment(0,0,4225,8192);const i=this._createPoleTriangleIndices();this.poleIndexBuffer=t.createIndexBuffer(i,!0),this.poleSegments=ys.simpleSegment(0,0,66,64);const n=new xa;n.emplaceBack(-1,1,1,0,0,0,0),n.emplaceBack(1,1,1,0,0,1,0),n.emplaceBack(1,-1,1,0,0,1,1),n.emplaceBack(-1,-1,1,0,0,0,1);const r=new ma;r.emplaceBack(0,1,2),r.emplaceBack(2,3,0),this.atmosphereVertexBuffer=t.createVertexBuffer(n,Ud.members),this.atmosphereIndexBuffer=t.createIndexBuffer(r),this.atmosphereSegments=ys.simpleSegment(0,0,4,2)}destroy(){this.poleIndexBuffer.destroy(),this.gridIndexBuffer.destroy(),this.poleSegments.destroy(),this.gridSegments.destroy(),this.atmosphereVertexBuffer.destroy(),this.atmosphereIndexBuffer.destroy(),this.atmosphereSegments.destroy(),this.wireframeIndexBuffer&&(this.wireframeIndexBuffer.destroy(),this.wireframeSegments.destroy())}static createPoleTriangleVertices(t,e,i){const n=new xa,r=e/Math.PI/2;n.emplaceBack(0,-r,0,0,0,.5,i?0:1);const o=360/t,a=Math.cos(H(85)),s=Math.sin(H(85));for(let t=0;t<=64;t++){const e=t/64,c=Jd(a,s,0*(1-(l=e))+o*l,r);n.emplaceBack(c[0],c[1],c[2],0,0,e,i?0:1)}var l;return n}_createPoleTriangleIndices(){const t=new ma;for(let e=0;e<=64;e++)t.emplaceBack(0,e+1,e+2);return t}static createGridVertices(t){const e=Math.pow(2,t.z),i=(t,e,i)=>t*(1-i)+e*i,[n,r]=$d(t),o=new xa,a=function(t){const e=u(new Float64Array(16)),i=Qd(t);var n,r;return f(e,e,[i,i,i]),p(e,e,((n=[])[0]=-(r=t.min)[0],n[1]=-r[1],n[2]=-r[2],n)),e}(Yd(t));o.reserve(4096);for(let s=0;s<65;s++){const l=i(n[0],r[0],s/64),c=Ss(l),h=c*e-t.y,u=Math.sin(H(l)),d=Math.cos(H(l));for(let t=0;t<65;t++){const e=t/64,s=i(n[1],r[1],e),l=Jd(d,u,s);I(l,l,a);const p=Ts(s);o.emplaceBack(l[0],l[1],l[2],p,c,e,h)}}return o}_createGridIndices(){const t=new ma,e=(e,i)=>{const n=65*i+e;t.emplaceBack(n+1,n,n+65),t.emplaceBack(n+65,n+65+1,n+1)};for(let t=0;t<64;t++)for(let i=0;i<64;i++)e(i,t);return t}getWirefameBuffer(t){if(!this.wireframeSegments){const e=this._createWireframeGrid();this.wireframeIndexBuffer=t.createIndexBuffer(e),this.wireframeSegments=ys.simpleSegment(0,0,4096,e.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}_createWireframeGrid(){const t=new wa,e=(e,i)=>{const n=65*i+e;t.emplaceBack(n,n+1),t.emplaceBack(n,n+65),t.emplaceBack(n,n+65+1)};for(let t=0;t<64;t++)for(let i=0;i<64;i++)e(i,t);return t}}function np(t,e){if(!e.isReprojectedInTileSpace)return{scale:1<<t.z,x:t.x,y:t.y,x2:t.x+1,y2:t.y+1,projection:e};const i=Math.pow(2,-t.z),n=t.x*i,r=(t.x+1)*i,o=t.y*i,a=(t.y+1)*i,s=Cs(n),l=Cs(r),c=As(o),h=As(a),u=e.project(s,c),d=e.project(l,c),p=e.project(l,h),f=e.project(s,h);let m=Math.min(u.x,d.x,p.x,f.x),g=Math.min(u.y,d.y,p.y,f.y),y=Math.max(u.x,d.x,p.x,f.x),_=Math.max(u.y,d.y,p.y,f.y);const v=i/16;function x(t,i,n,r,o,a){const s=(n+o)/2,l=(r+a)/2,c=e.project(Cs(s),As(l)),h=Math.max(0,m-c.x,g-c.y,c.x-y,c.y-_);m=Math.min(m,c.x),y=Math.max(y,c.x),g=Math.min(g,c.y),_=Math.max(_,c.y),h>v&&(x(t,c,n,r,s,l),x(c,i,s,l,o,a))}x(u,d,n,o,r,o),x(d,p,r,o,r,a),x(p,f,r,a,n,a),x(f,u,n,a,n,o),m-=v,g-=v,y+=v,_+=v;const b=1/Math.max(y-m,_-g);return{scale:b,x:m*b,y:g*b,x2:y*b,y2:_*b,projection:e}}class rp{constructor(t){const e={},i=[];for(const n in t){const r=t[n],o=e[n]={};for(const t in r.glyphs){const e=r.glyphs[+t];if(!e||0===e.bitmap.width||0===e.bitmap.height)continue;const n=e.metrics.localGlyph?2:1,a={x:0,y:0,w:e.bitmap.width+2*n,h:e.bitmap.height+2*n};i.push(a),o[t]=a}}const{w:n,h:r}=Ch(i),o=new gl({width:n||1,height:r||1});for(const i in t){const n=t[i];for(const t in n.glyphs){const r=n.glyphs[+t];if(!r||0===r.bitmap.width||0===r.bitmap.height)continue;const a=e[i][t],s=r.metrics.localGlyph?2:1;gl.copy(r.bitmap,o,{x:0,y:0},{x:a.x+s,y:a.y+s},r.bitmap)}}this.image=o,this.positions=e}}zr("GlyphAtlas",rp);class op{constructor(t){this.tileID=new od(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.collectResourceTiming,this.returnDependencies=!!t.returnDependencies,this.promoteId=t.promoteId,this.enableTerrain=!!t.enableTerrain,this.isSymbolTile=t.isSymbolTile,this.tileTransform=np(t.tileID.canonical,t.projection),this.projection=t.projection}parse(t,e,i,n,r){this.status="parsing",this.data=t,this.collisionBoxArray=new Ca;const o=new ud(Object.keys(t.layers).sort()),a=new Pd(this.tileID,this.promoteId);a.bucketLayerIDs=[];const s={},l=new Ju(256,256),c={featureIndex:a,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:l,availableImages:i},h=e.familiesBySource[this.source];for(const e in h){const n=t.layers[e];if(!n)continue;let r=!1,l=!1;for(const t of h[e])"symbol"===t[0].type?r=!0:l=!0;if(!0===this.isSymbolTile&&!r)continue;if(!1===this.isSymbolTile&&!l)continue;1===n.version&&pt(`Vector tile source "${this.source}" layer "${e}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const u=o.encode(e),d=[];for(let t=0;t<n.length;t++){const i=n.feature(t),r=a.getId(i,e);d.push({feature:i,id:r,index:t,sourceLayerIndex:u})}for(const t of h[e]){const e=t[0];void 0!==this.isSymbolTile&&"symbol"===e.type!==this.isSymbolTile||e.minzoom&&this.zoom<Math.floor(e.minzoom)||e.maxzoom&&this.zoom>=e.maxzoom||"none"!==e.visibility&&(ap(t,this.zoom,i),(s[e.id]=e.createBucket({index:a.bucketLayerIDs.length,layers:t,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:u,sourceID:this.source,enableTerrain:this.enableTerrain,availableImages:i})).populate(d,c,this.tileID.canonical,this.tileTransform),a.bucketLayerIDs.push(t.map(t=>t.id)))}}let u,d,p,f;l.trim();const m={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},g=ct(c.glyphDependencies,t=>Object.keys(t).map(Number));Object.keys(g).length?n.send("getGlyphs",{uid:this.uid,stacks:g},(t,e)=>{u||(u=t,d=e,v.call(this))},void 0,!1,m):d={};const y=Object.keys(c.iconDependencies);y.length?n.send("getImages",{icons:y,source:this.source,tileID:this.tileID,type:"icons"},(t,e)=>{u||(u=t,p=e,v.call(this))},void 0,!1,m):p={};const _=Object.keys(c.patternDependencies);function v(){if(u)return r(u);if(d&&p&&f){const t=new rp(d),e=new Ph(p,f);for(const n in s){const r=s[n];r instanceof ku?(ap(r.layers,this.zoom,i),_u(r,d,t.positions,p,e.iconPositions,this.showCollisionBoxes,i,this.tileID.canonical,this.tileZoom,this.projection),r.projection=this.projection.name):r.hasPattern&&(r instanceof zc||r instanceof rc||r instanceof Mc)&&(ap(r.layers,this.zoom,i),r.addFeatures(c,this.tileID.canonical,e.patternPositions,i))}this.status="done",r(null,{buckets:tt(s).filter(t=>!t.isEmpty()),featureIndex:a,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:t.image,lineAtlas:l,imageAtlas:e,glyphMap:this.returnDependencies?d:null,iconMap:this.returnDependencies?p:null,glyphPositions:this.returnDependencies?t.positions:null})}}_.length?n.send("getImages",{icons:_,source:this.source,tileID:this.tileID,type:"patterns"},(t,e)=>{u||(u=t,f=e,v.call(this))},void 0,!1,m):f={},v.call(this)}}function ap(t,e,i){const n=new zo(e);for(const e of t)e.recalculate(n,i)}class sp{constructor(t){this.entries={},this.scheduler=t}request(t,e,i,n){const r=this.entries[t]=this.entries[t]||{callbacks:[]};if(r.result){const[t,i]=r.result;return this.scheduler?this.scheduler.add(()=>{n(t,i)},e):n(t,i),()=>{}}return r.callbacks.push(n),r.cancel||(r.cancel=i((i,n)=>{r.result=[i,n];for(const t of r.callbacks)this.scheduler?this.scheduler.add(()=>{t(i,n)},e):t(i,n);setTimeout(()=>delete this.entries[t],3e3)})),()=>{r.result||(r.callbacks=r.callbacks.filter(t=>t!==n),r.callbacks.length||(r.cancel(),delete this.entries[t]))}}}function lp(t,e,i){const n=JSON.stringify(t.request);return t.data&&(this.deduped.entries[n]={result:[null,t.data]}),this.deduped.request(n,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom},e=>{const n=se(t.request,(t,n,r,o)=>{t?e(t):n&&e(null,{vectorTile:i?void 0:new _c.VectorTile(new rh(n)),rawData:n,cacheControl:r,expires:o})});return()=>{n.cancel(),e()}},e)}const cp=u(new Float64Array(16));class hp{constructor(t,e){this._tr=t,this._worldSize=e}createInversionMatrix(){return cp}createTileMatrix(t){let e,i,n;const r=t.canonical,o=u(new Float64Array(16)),a=this._tr.projection;if(a.isReprojectedInTileSpace){const s=np(r,a);e=1,i=s.x+t.wrap*s.scale,n=s.y,f(o,o,[e/s.scale,e/s.scale,this._tr.pixelsPerMeter/this._worldSize])}else e=this._worldSize/this._tr.zoomScale(r.z),i=(r.x+Math.pow(2,r.z)*t.wrap)*e,n=r.y*e;return p(o,o,[i,n,0]),f(o,o,[e/_s,e/_s,1]),o}pointCoordinate(t,e,i){const n=this._tr.horizonLineFromTop(!1),r=new o(t,Math.max(n,e));return this._tr.rayIntersectionCoordinate(this._tr.pointRayIntersection(r,i))}upVector(){return[0,0,1]}upVectorScale(){return 1}}var up={name:"albers",range:[4,7],center:[-96,37.5],parallels:[29.5,45.5],zAxisUnit:"meters",conic:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],initializeConstants(){if(this.constants&&G(this.parallels,this.constants.parallels))return;const t=Math.sin(H(this.parallels[0])),e=(t+Math.sin(H(this.parallels[1])))/2,i=1+t*(2*e-t),n=Math.sqrt(i)/e;this.constants={n:e,c:i,r0:n,parallels:this.parallels}},project(t,e){this.initializeConstants();const i=H(t-this.center[0]),n=H(e),{n:r,c:o,r0:a}=this.constants,s=Math.sqrt(o-2*r*Math.sin(n))/r;return{x:s*Math.sin(i*r),y:s*Math.cos(i*r)-a,z:0}},unproject(t,e){this.initializeConstants();const{n:i,c:n,r0:r}=this.constants,o=r+e;let a=Math.atan2(t,Math.abs(o))*Math.sign(o);o*i<0&&(a-=Math.PI*Math.sign(t)*Math.sign(o));const s=H(this.center[0])*i;a=K(a,-Math.PI-s,Math.PI-s);const l=Z(a/i)+this.center[0],c=Math.asin($((n-(t*t+o*o)*i*i)/(2*i),-1,1)),h=$(Z(c),-85.051129,Ls);return new bs(l,h)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>Es(1,t)*e,farthestPixelDistance(t){return Hd(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new hp(t,e)};const dp=1.340264,pp=-.081106,fp=893e-6,mp=.003796,gp=Math.sqrt(3)/2;var yp={name:"equalEarth",center:[0,0],range:[3.5,7],zAxisUnit:"meters",isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project(t,e){e=e/180*Math.PI,t=t/180*Math.PI;const i=Math.asin(gp*Math.sin(e)),n=i*i,r=n*n*n;return{x:.5*(t*Math.cos(i)/(gp*(dp+3*pp*n+r*(7*fp+9*mp*n)))/Math.PI+.5),y:1-.5*(i*(dp+pp*n+r*(fp+mp*n))/Math.PI+1),z:0}},unproject(t,e){t=(2*t-.5)*Math.PI;let i=e=(2*(1-e)-1)*Math.PI,n=i*i,r=n*n*n;for(let t,o,a,s=0;s<12&&(o=i*(dp+pp*n+r*(fp+mp*n))-e,a=dp+3*pp*n+r*(7*fp+9*mp*n),t=o/a,i=$(i-t,-Math.PI/3,Math.PI/3),n=i*i,r=n*n*n,!(Math.abs(t)<1e-12));++s);const o=gp*t*(dp+3*pp*n+r*(7*fp+9*mp*n))/Math.cos(i),a=Math.asin(Math.sin(i)/gp),s=$(180*o/Math.PI,-180,180),l=$(180*a/Math.PI,-85.051129,Ls);return new bs(s,l)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>Es(1,t)*e,farthestPixelDistance(t){return Hd(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new hp(t,e)},_p={name:"equirectangular",supportsWorldCopies:!0,center:[0,0],range:[3.5,7],zAxisUnit:"meters",wrap:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project:(t,e)=>({x:.5+t/360,y:.5-e/360,z:0}),unproject(t,e){const i=360*(t-.5),n=$(360*(.5-e),-85.051129,Ls);return new bs(i,n)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>Es(1,t)*e,farthestPixelDistance(t){return Hd(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new hp(t,e)};const vp=Math.PI/2;function xp(t){return Math.tan((vp+t)/2)}var bp={name:"lambertConformalConic",range:[3.5,7],zAxisUnit:"meters",center:[0,30],parallels:[30,30],conic:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],initializeConstants(){if(this.constants&&G(this.parallels,this.constants.parallels))return;const t=H(this.parallels[0]),e=H(this.parallels[1]),i=Math.cos(t),n=t===e?Math.sin(t):Math.log(i/Math.cos(e))/Math.log(xp(e)/xp(t)),r=i*Math.pow(xp(t),n)/n;this.constants={n:n,f:r,parallels:this.parallels}},project(t,e){this.initializeConstants(),e=H(e),t=H(t-this.center[0]);const i=1e-6,{n:n,f:r}=this.constants;r>0?e<-vp+i&&(e=-vp+i):e>vp-i&&(e=vp-i);const o=r/Math.pow(xp(e),n),a=o*Math.sin(n*t),s=r-o*Math.cos(n*t);return{x:.5*(a/Math.PI+.5),y:1-.5*(s/Math.PI+.5),z:0}},unproject(t,e){this.initializeConstants(),t=(2*t-.5)*Math.PI,e=(2*(1-e)-.5)*Math.PI;const{n:i,f:n}=this.constants,r=n-e,o=Math.sign(r),a=Math.sign(i)*Math.sqrt(t*t+r*r);let s=Math.atan2(t,Math.abs(r))*o;r*i<0&&(s-=Math.PI*Math.sign(t)*o);const l=$(Z(s/i)+this.center[0],-180,180),c=$(Z(2*Math.atan(Math.pow(n/a,1/i))-vp),-85.051129,Ls);return new bs(l,c)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>Es(1,t)*e,farthestPixelDistance(t){return Hd(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new hp(t,e)},wp={name:"mercator",wrap:!0,requiresDraping:!1,supportsWorldCopies:!0,supportsTerrain:!0,supportsFog:!0,supportsFreeCamera:!0,zAxisUnit:"meters",center:[0,0],project:(t,e)=>({x:Ts(t),y:Ss(e),z:0}),unproject(t,e){const i=Cs(t),n=As(e);return new bs(i,n)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>Es(1,t)*e,farthestPixelDistance(t){return Hd(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new hp(t,e)};const Mp=H(Ls);var Tp={name:"naturalEarth",center:[0,0],range:[3.5,7],isReprojectedInTileSpace:!0,zAxisUnit:"meters",unsupportedLayers:["custom"],project(t,e){const i=(e=H(e))*e,n=i*i;return{x:.5*((t=H(t))*(.8707-.131979*i+n*(n*(.003971*i-.001529*n)-.013791))/Math.PI+.5),y:1-.5*(e*(1.007226+i*(.015085+n*(.028874*i-.044475-.005916*n)))/Math.PI+1),z:0}},unproject(t,e){t=(2*t-.5)*Math.PI;let i=e=(2*(1-e)-1)*Math.PI,n=25,r=0,o=i*i;do{o=i*i;const t=o*o;r=(i*(1.007226+o*(.015085+t*(.028874*o-.044475-.005916*t)))-e)/(1.007226+o*(.045255+t*(.259866*o-.311325-.005916*11*t))),i=$(i-r,-Mp,Mp)}while(Math.abs(r)>1e-6&&--n>0);o=i*i;const a=$(Z(t/(.8707+o*(o*(o*o*o*(.003971-.001529*o)-.013791)-.131979))),-180,180),s=Z(i);return new bs(a,s)},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>Es(1,t)*e,farthestPixelDistance(t){return Hd(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new hp(t,e)};const Sp=H(Ls),Ep={albers:up,equalEarth:yp,equirectangular:_p,lambertConformalConic:bp,mercator:wp,naturalEarth:Tp,winkelTripel:{name:"winkelTripel",center:[0,0],range:[3.5,7],zAxisUnit:"meters",isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project(t,e){e=H(e),t=H(t);const i=Math.cos(e),n=2/Math.PI,r=Math.acos(i*Math.cos(t/2)),o=Math.sin(r)/r,a=.5*(t*n+2*i*Math.sin(t/2)/o)||0,s=.5*(e+Math.sin(e)/o)||0;return{x:.5*(a/Math.PI+.5),y:1-.5*(s/Math.PI+1),z:0}},unproject(t,e){let i=t=(2*t-.5)*Math.PI,n=e=(2*(1-e)-1)*Math.PI,r=25;const o=1e-6;let a=0,s=0;do{const r=Math.cos(n),o=Math.sin(n),l=2*o*r,c=o*o,h=r*r,u=Math.cos(i/2),d=Math.sin(i/2),p=2*u*d,f=d*d,m=1-h*u*u,g=m?1/m:0,y=m?Math.acos(r*u)*Math.sqrt(1/m):0,_=.5*(2*y*r*d+2*i/Math.PI)-t,v=.5*(y*o+n)-e,x=.5*g*(h*f+y*r*u*c)+1/Math.PI,b=g*(p*l/4-y*o*d),w=.125*g*(l*d-y*o*h*p),M=.5*g*(c*u+y*f*r)+.5,T=b*w-M*x;a=(v*b-_*M)/T,s=(_*w-v*x)/T,i=$(i-a,-Math.PI,Math.PI),n=$(n-s,-Sp,Sp)}while((Math.abs(a)>o||Math.abs(s)>o)&&--r>0);return new bs(Z(i),Z(n))},projectTilePoint:(t,e)=>({x:t,y:e,z:0}),locationPoint:(t,e)=>t._coordinatePoint(t.locationCoordinate(e),!1),pixelsPerMeter:(t,e)=>Es(1,t)*e,farthestPixelDistance(t){return Hd(t,this.pixelsPerMeter(t.center.lat,t.worldSize))},createTileTransform:(t,e)=>new hp(t,e)}};t.ARRAY_TYPE=c,t.AUTH_ERR_MSG=kt,t.Aabb=al,t.Actor=class{constructor(t,e,i){this.target=t,this.parent=e,this.mapId=i,this.callbacks={},this.cancelCallbacks={},st(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=gt()?t:s,this.scheduler=new ed}send(t,e,i,n,r=!1,o){const a=Math.round(1e18*Math.random()).toString(36).substring(0,10);i&&(i.metadata=o,this.callbacks[a]=i);const s=wt(this.globalScope)?void 0:[];return this.target.postMessage({id:a,type:t,hasCallback:!!i,targetMapId:n,mustQueue:r,sourceMapId:this.mapId,data:Nr(e,s)},s),{cancel:()=>{i&&delete this.callbacks[a],this.target.postMessage({id:a,type:"<cancel>",targetMapId:n,sourceMapId:this.mapId})}}}receive(t){const e=t.data,i=e.id;if(i&&(!e.targetMapId||this.mapId===e.targetMapId))if("<cancel>"===e.type){const t=this.cancelCallbacks[i];delete this.cancelCallbacks[i],t&&t.cancel()}else if(e.mustQueue||gt()){const t=this.callbacks[i];this.cancelCallbacks[i]=this.scheduler.add(()=>this.processTask(i,e),t&&t.metadata||{type:"message"})}else this.processTask(i,e)}processTask(t,e){if("<response>"===e.type){const i=this.callbacks[t];delete this.callbacks[t],i&&(e.error?i(jr(e.error)):i(null,jr(e.data)))}else{const i=wt(this.globalScope)?void 0:[],n=e.hasCallback?(e,n)=>{delete this.cancelCallbacks[t],this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:e?Nr(e):null,data:Nr(n,i)},i)}:t=>{},r=jr(e.data);if(this.parent[e.type])this.parent[e.type](e.sourceMapId,r,n);else if(this.parent.getWorkerSource){const t=e.type.split(".");this.parent.getWorkerSource(e.sourceMapId,t[0],r.source)[t[1]](r,n)}else n(new Error("Could not find function "+e.type))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},t.CanonicalTileID=nd,t.Color=We,t.ColorMode=cd,t.CullFaceMode=hd,t.DEMData=Md,t.DataConstantProperty=Zo,t.DedupedRequest=sp,t.DepthMode=sd,t.EXTENT=_s,t.Elevation=class{getAtPointOrZero(t,e=0){return this.getAtPoint(t,e)||0}getAtPoint(t,e,i=!0){null==e&&(e=null);const n=this._source();if(!n)return e;if(t.y<0||t.y>1)return e;const r=n.getSource().maxzoom,o=1<<r,a=Math.floor(t.x),s=t.x-a,l=new od(r,a,r,Math.floor(s*o),Math.floor(t.y*o)),c=this.findDEMTileFor(l);if(!c||!c.dem)return e;const h=c.dem,u=1<<c.tileID.canonical.z,d=(s*u-c.tileID.canonical.x)*h.dim,p=(t.y*u-c.tileID.canonical.y)*h.dim,f=Math.floor(d),m=Math.floor(p);return(i?this.exaggeration():1)*Bi(Bi(h.get(f,m),h.get(f,m+1),p-m),Bi(h.get(f+1,m),h.get(f+1,m+1),p-m),d-f)}getAtTileOffset(t,e,i){const n=1<<t.canonical.z;return this.getAtPointOrZero(new Is(t.wrap+(t.canonical.x+e/_s)/n,(t.canonical.y+i/_s)/n))}getAtTileOffsetFunc(t,e){return i=>{const n=this.getAtTileOffset(t,i.x,i.y),r=e.upVector(t.canonical,i.x,i.y);return E(r,r,n*e.upVectorScale(t.canonical)),r}}getForTilePoints(t,e,i,n){const r=Ad.create(this,t,n);return!!r&&(e.forEach(t=>{t[2]=this.exaggeration()*r.getElevationAt(t[0],t[1],i)}),!0)}getMinMaxForTile(t){const e=this.findDEMTileFor(t);if(!e||!e.dem)return null;const i=e.dem.tree,n=e.tileID,r=1<<t.canonical.z-n.canonical.z;let o=t.canonical.x/r-n.canonical.x,a=t.canonical.y/r-n.canonical.y,s=0;for(let e=0;e<t.canonical.z-n.canonical.z&&!i.leaves[s];e++){o*=2,a*=2;const t=2*Math.floor(a)+Math.floor(o);s=i.childOffsets[s]+t,o%=1,a%=1}return{min:this.exaggeration()*i.minimums[s],max:this.exaggeration()*i.maximums[s]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},t.ErrorEvent=_e,t.EvaluationParameters=zo,t.Event=ye,t.Evented=ve,t.Frustum=ol,t.GLOBE_ZOOM_THRESHOLD_MAX=6,t.GlobeSharedBuffers=ip,t.GlyphManager=nu,t.ImagePosition=Ah,t.LineAtlas=Ju,t.LngLat=bs,t.LngLatBounds=vs,t.LocalGlyphMode=iu,t.MAX_MERCATOR_LATITUDE=Ls,t.MercatorCoordinate=Is,t.ONE_EM=24,t.OverscaledTileID=od,t.Properties=$o,t.RGBAImage=yl,t.Ray=class{constructor(t,e){this.pos=t,this.dir=e}intersectsPlane(t,e,i){const n=P(e,this.dir);if(Math.abs(n)<1e-6)return!1;const r=((t[0]-this.pos[0])*e[0]+(t[1]-this.pos[1])*e[1]+(t[2]-this.pos[2])*e[2])/n;return i[0]=this.pos[0]+this.dir[0]*r,i[1]=this.pos[1]+this.dir[1]*r,i[2]=this.pos[2]+this.dir[2]*r,!0}closestPointOnSphere(t,e,i){if(function(t,e){var i=t[0],n=t[1],r=t[2],o=e[0],a=e[1],s=e[2];return Math.abs(i-o)<=l*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(n-a)<=l*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-s)<=l*Math.max(1,Math.abs(r),Math.abs(s))}(this.pos,t)||0===e)return i[0]=i[1]=i[2]=0,!1;const[n,r,o]=this.dir,a=this.pos[0]-t[0],s=this.pos[1]-t[1],c=this.pos[2]-t[2],h=n*n+r*r+o*o,u=2*(a*n+s*r+c*o),d=u*u-4*h*(a*a+s*s+c*c-e*e);if(d<0){const t=Math.max(-u/2,0),l=a+n*t,h=s+r*t,d=c+o*t,p=Math.hypot(l,h,d);return i[0]=l*e/p,i[1]=h*e/p,i[2]=d*e/p,!1}{const t=(-u-Math.sqrt(d))/(2*h);if(t<0){const t=Math.hypot(a,s,c);return i[0]=a*e/t,i[1]=s*e/t,i[2]=c*e/t,!1}return i[0]=a+n*t,i[1]=s+r*t,i[2]=c+o*t,!0}}},t.RequestManager=class{constructor(t,e,i){this._transformRequestFn=t,this._customAccessToken=e,this._silenceAuthErrors=!!i,this._createSkuToken()}_createSkuToken(){const t=function(){let t="";for(let e=0;e<10;e++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Dt,t].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,e){return this._transformRequestFn&&this._transformRequestFn(t,e)||{url:t}}normalizeStyleURL(t,e){if(!Ot(t))return t;const i=Ft(t);return i.path="/styles/v1"+i.path,this._makeAPIURL(i,this._customAccessToken||e)}normalizeGlyphsURL(t,e){if(!Ot(t))return t;const i=Ft(t);return i.path="/fonts/v1"+i.path,this._makeAPIURL(i,this._customAccessToken||e)}normalizeSourceURL(t,e){if(!Ot(t))return t;const i=Ft(t);return i.path=`/v4/${i.authority}.json`,i.params.push("secure"),this._makeAPIURL(i,this._customAccessToken||e)}normalizeSpriteURL(t,e,i,n){const r=Ft(t);return Ot(t)?(r.path=`/styles/v1${r.path}/sprite${e}${i}`,this._makeAPIURL(r,this._customAccessToken||n)):(r.path+=`${e}${i}`,Nt(r))}normalizeTileURL(t,e,i){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!Ot(t))return t;const n=Ft(t);n.path=n.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${e||i&&"raster"!==n.authority&&512===i?"@2x":""}${Ct.supported?".webp":"$1"}`),"raster"===n.authority?n.path=`/${Et.RASTER_URL_PREFIX}${n.path}`:(n.path=n.path.replace(/^.+\/v4\//,"/"),n.path=`/${Et.TILE_URL_VERSION}${n.path}`);const r=this._customAccessToken||function(t){for(const e of t){const t=e.match(/^access_token=(.*)$/);if(t)return t[1]}return null}(n.params)||Et.ACCESS_TOKEN;return Et.REQUIRE_ACCESS_TOKEN&&r&&this._skuToken&&n.params.push("sku="+this._skuToken),this._makeAPIURL(n,r)}canonicalizeTileURL(t,e){const i=Ft(t);if(!i.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!i.path.match(/\.[\w]+$/))return t;let n="mapbox://";i.path.match(/^\/raster\/v1\//)?n+="raster/"+i.path.replace(`/${Et.RASTER_URL_PREFIX}/`,""):n+="tiles/"+i.path.replace(`/${Et.TILE_URL_VERSION}/`,"");let r=i.params;return e&&(r=r.filter(t=>!t.match(/^access_token=/))),r.length&&(n+="?"+r.join("&")),n}canonicalizeTileset(t,e){const i=!!e&&Ot(e),n=[];for(const e of t.tiles||[])zt(e)?n.push(this.canonicalizeTileURL(e,i)):n.push(e);return n}_makeAPIURL(t,e){const i="See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes",n=Ft(Et.API_URL);if(t.protocol=n.protocol,t.authority=n.authority,"http"===t.protocol){const e=t.params.indexOf("secure");e>=0&&t.params.splice(e,1)}if("/"!==n.path&&(t.path=`${n.path}${t.path}`),!Et.REQUIRE_ACCESS_TOKEN)return Nt(t);if(e=e||Et.ACCESS_TOKEN,!this._silenceAuthErrors){if(!e)throw new Error("An API access token is required to use Mapbox GL. "+i);if("s"===e[0])throw new Error("Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). "+i)}return t.params=t.params.filter(t=>-1===t.indexOf("access_token")),t.params.push("access_token="+(e||"")),Nt(t)}},t.ResourceType=ne,t.SegmentVector=ys,t.SourceCache=Sd,t.StencilMode=ld,t.StructArrayLayout1ui2=Ma,t.StructArrayLayout2f1f2i16=pa,t.StructArrayLayout2i4=na,t.StructArrayLayout2ui4=wa,t.StructArrayLayout3f12=aa,t.StructArrayLayout3ui6=ma,t.StructArrayLayout4i8=ra,t.Texture=$u,t.Tile=jd,t.Transitionable=No,t.Uniform1f=Xa,t.Uniform1i=class extends qa{constructor(t,e){super(t,e),this.current=0}set(t){this.current!==t&&(this.current=t,this.gl.uniform1i(this.location,t))}},t.Uniform2f=class extends qa{constructor(t,e){super(t,e),this.current=[0,0]}set(t){t[0]===this.current[0]&&t[1]===this.current[1]||(this.current=t,this.gl.uniform2f(this.location,t[0],t[1]))}},t.Uniform3f=class extends qa{constructor(t,e){super(t,e),this.current=[0,0,0]}set(t){t[0]===this.current[0]&&t[1]===this.current[1]&&t[2]===this.current[2]||(this.current=t,this.gl.uniform3f(this.location,t[0],t[1],t[2]))}},t.Uniform4f=Ya,t.UniformColor=$a,t.UniformMatrix2f=class extends qa{constructor(t,e){super(t,e),this.current=Qa}set(t){for(let e=0;e<4;e++)if(t[e]!==this.current[e]){this.current=t,this.gl.uniformMatrix2fv(this.location,!1,t);break}}},t.UniformMatrix3f=class extends qa{constructor(t,e){super(t,e),this.current=Ka}set(t){for(let e=0;e<9;e++)if(t[e]!==this.current[e]){this.current=t,this.gl.uniformMatrix3fv(this.location,!1,t);break}}},t.UniformMatrix4f=class extends qa{constructor(t,e){super(t,e),this.current=Ja}set(t){if(t[12]!==this.current[12]||t[0]!==this.current[0])return this.current=t,void this.gl.uniformMatrix4fv(this.location,!1,t);for(let e=1;e<16;e++)if(t[e]!==this.current[e]){this.current=t,this.gl.uniformMatrix4fv(this.location,!1,t);break}}},t.UnwrappedTileID=rd,t.ValidationError=be,t.VectorTileWorkerSource=class extends ve{constructor(t,e,i,n,r){super(),this.actor=t,this.layerIndex=e,this.availableImages=i,this.loadVectorData=r||lp,this.loading={},this.loaded={},this.deduped=new sp(t.scheduler),this.isSpriteLoaded=n,this.scheduler=t.scheduler}loadTile(t,e){const i=t.uid,n=t&&t.request,r=n&&n.collectResourceTiming,o=this.loading[i]=new op(t);o.abort=this.loadVectorData(t,(a,s)=>{const l=!this.loading[i];if(delete this.loading[i],l||a||!s)return o.status="done",l||(this.loaded[i]=o),e(a);const c=s.rawData,h={};s.expires&&(h.expires=s.expires),s.cacheControl&&(h.cacheControl=s.cacheControl),o.vectorTile=s.vectorTile||new _c.VectorTile(new rh(c));const u=()=>{o.parse(o.vectorTile,this.layerIndex,this.availableImages,this.actor,(t,i)=>{if(t||!i)return e(t);const o={};if(r){const t=td(n);t.length>0&&(o.resourceTiming=JSON.parse(JSON.stringify(t)))}e(null,et({rawTileData:c.slice(0)},i,h,o))})};this.isSpriteLoaded?u():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(u,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom}):u()}),this.loaded=this.loaded||{},this.loaded[i]=o})}reloadTile(t,e){const i=this.loaded,n=t.uid,r=this;if(i&&i[n]){const o=i[n];o.showCollisionBoxes=t.showCollisionBoxes,o.enableTerrain=!!t.enableTerrain,o.projection=t.projection;const a=(t,i)=>{const n=o.reloadCallback;n&&(delete o.reloadCallback,o.parse(o.vectorTile,r.layerIndex,this.availableImages,r.actor,n)),e(t,i)};"parsing"===o.status?o.reloadCallback=a:"done"===o.status&&(o.vectorTile?o.parse(o.vectorTile,this.layerIndex,this.availableImages,this.actor,a):a())}}abortTile(t,e){const i=t.uid,n=this.loading[i];n&&(n.abort&&n.abort(),delete this.loading[i]),e()}removeTile(t,e){const i=this.loaded,n=t.uid;i&&i[n]&&delete i[n],e()}},t.WritingMode=Lh,t.ZoomHistory=Gr,t.add=w,t.addDynamicAttributes=Lu,t.adjoint=function(t,e){var i=e[0],n=e[1],r=e[2],o=e[3],a=e[4],s=e[5],l=e[6],c=e[7],h=e[8];return t[0]=a*h-s*c,t[1]=r*c-n*h,t[2]=n*s-r*a,t[3]=s*l-o*h,t[4]=i*h-r*l,t[5]=r*o-i*s,t[6]=o*c-a*l,t[7]=n*l-i*c,t[8]=i*a-n*o,t},t.asyncAll=Q,t.bezier=X,t.bindAll=st,t.boundsAttributes=Fd,t.bufferConvexPolygon=function(t,e){const i=[];for(let n=0;n<t.length;n++){const r=K(n-1,-1,t.length-1),o=K(n+1,-1,t.length-1),a=t[n],s=t[o],l=t[r].sub(a).unit(),c=s.sub(a).unit(),h=c.angleWithSep(l.x,l.y),u=l.add(c).unit().mult(-1*e/Math.sin(h/2));i.push(a.add(u))}return i},t.cacheEntryPossiblyAdded=function(t){ie++,ie>Qt&&(t.getActor().send("enforceCacheSizeLimit",Kt),ie=0)},t.calculateGlobeMatrix=ep,t.calculateGlobeMercatorMatrix=function(t){const e=t.worldSize,i=$(t.center.lat,-85.051129,Ls),n=new o(Ts(t.center.lng)*e,Ss(i)*e),r=Es(1,t.center.lat)*e,a=t.pixelsPerMeter,s=e/(r/t.pixelsPerMeter),l=u(new Float64Array(16));return p(l,l,[n.x,n.y,0]),f(l,l,[s,s,a]),l},t.clamp=$,t.clearTileCache=function(t){const e=s.caches.delete(Yt);t&&e.catch(t).then(()=>t())},t.clipLine=Kh,t.clone=function(t){var e=new c(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},t.clone$1=ut,t.collisionCircleLayout=Wc,t.config=Et,t.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},t.create=function(){var t=new c(16);return c!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},t.create$1=h,t.createExpression=jn,t.createLayout=ea,t.createStyleLayer=function(t){return"custom"===t.type?new Gu(t):new Hu[t.type](t)},t.cross=L,t.degToRad=H,t.div=function(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t},t.dot=P,t.ease=Y,t.easeCubicInOut=q,t.emitValidationErrors=Lr,t.endsWith=lt,t.enforceCacheSizeLimit=function(t){te(),$t&&$t.then(e=>{e.keys().then(i=>{for(let n=0;n<i.length-t;n++)e.delete(i[n])})})},t.evaluateSizeForFeature=Yc,t.evaluateSizeForZoom=$c,t.evaluateVariableOffset=yu,t.evented=Ro,t.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},t.exactEquals$1=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},t.exported=Tt,t.exported$1=Ct,t.extend=et,t.extend$1=Me,t.filterObject=ht,t.fromMat4=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},t.fromQuat=function(t,e){var i=e[0],n=e[1],r=e[2],o=e[3],a=i+i,s=n+n,l=r+r,c=i*a,h=n*a,u=n*s,d=r*a,p=r*s,f=r*l,m=o*a,g=o*s,y=o*l;return t[0]=1-u-f,t[1]=h+y,t[2]=d-g,t[3]=0,t[4]=h-y,t[5]=1-c-f,t[6]=p+m,t[7]=0,t[8]=d+g,t[9]=p-m,t[10]=1-c-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},t.fromRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=i,t[2]=0,t[3]=-i,t[4]=n,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},t.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},t.furthestTileCorner=function(t){const e=Math.round((t+45+360)%360/90)%4;return W[e]},t.getAABBPointSquareDist=function(t,e,i){let n=0;for(let r=0;r<2;++r){const o=i?i[r]:0;t[r]>o&&(n+=(t[r]-o)*(t[r]-o)),e[r]<o&&(n+=(o-e[r])*(o-e[r]))}return n},t.getAnchorAlignment=Gh,t.getAnchorJustification=vu,t.getBounds=function(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;for(const o of t)e=Math.min(e,o.x),i=Math.min(i,o.y),n=Math.max(n,o.x),r=Math.max(r,o.y);return{min:new o(e,i),max:new o(n,r)}},t.getColumn=function(t,e){return[t[4*e],t[4*e+1],t[4*e+2],t[4*e+3]]},t.getImage=fe,t.getJSON=function(t,e){return ae(et(t,{type:"json"}),e)},t.getMapSessionAPI=qt,t.getPerformanceMeasurement=td,t.getProjection=function(t){const e=Ep[t.name];if(!e)throw new Error("Invalid projection name: "+t.name);return e.conic?function(t,e){if(e.parallels&&Math.abs(e.parallels[0]+e.parallels[1])<.01){let i=function(t){const e=Math.max(.01,Math.cos(H(t))),i=1/(2*Math.max(Math.PI*e,1/e));return{wrap:!0,supportsWorldCopies:!0,unsupportedLayers:["custom"],project(t,n){const r=H(t)*e,o=Math.sin(H(n))/e;return{x:r*i+.5,y:-o*i+.5,z:0}},unproject(t,n){const r=-(n-.5)/i,o=$(Z((t-.5)/i)/e,-180,180),a=Math.asin($(r*e,-1,1)),s=$(Z(a),-85.051129,Ls);return new bs(o,s)}}}(e.parallels[0]);if("lambertConformalConic"===e.name){const{project:t,unproject:e}=Ep.mercator;i={wrap:!0,supportsWorldCopies:!0,project:t,unproject:e}}return et({},t,e,i)}return et({},t,e)}(e,t):e},t.getRTLTextPluginStatus=Do,t.getReferrer=oe,t.getTilePoint=function(t,{x:e,y:i},n=0){return new o(((e-n)*t.scale-t.x)*_s,(i*t.scale-t.y)*_s)},t.getTileVec3=function(t,e,i=0){return b(((e.x-i)*t.scale-t.x)*_s,(e.y*t.scale-t.y)*_s,Ps(e.z,e.y))},t.getVideo=function(t,e){const i=s.document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let e=0;e<t.length;e++){const n=s.document.createElement("source");he(t[e])||(i.crossOrigin="Anonymous"),n.src=t[e],i.appendChild(n)}return{cancel:()=>{}}},t.globeBuffersForTileMesh=function(t,e,i,n){const r=t.context,o=t.transform;let a=e.globeGridBuffer,s=e.globePoleBuffer;if(!a){const t=ip.createGridVertices(i.canonical);a=e.globeGridBuffer=r.createVertexBuffer(t,Vd,!1)}if(!s){const t=ip.createPoleTriangleVertices(n,o.tileSize*n,0===i.canonical.y);s=e.globePoleBuffer=r.createVertexBuffer(t,Vd,!1)}return[a,s]},t.globeDenormalizeECEF=tp,t.globeMatrixForTile=function(t,e){const i=tp(Yd(t)),n=((r=new Float64Array(16))[0]=(o=e)[0],r[1]=o[1],r[2]=o[2],r[3]=o[3],r[4]=o[4],r[5]=o[5],r[6]=o[6],r[7]=o[7],r[8]=o[8],r[9]=o[9],r[10]=o[10],r[11]=o[11],r[12]=o[12],r[13]=o[13],r[14]=o[14],r[15]=o[15],r);var r,o;return y(n,n,i),n},t.globePoleMatrixForTile=function(t,e,i){const n=u(new Float64Array(16)),r=Math.pow(2,t.z),o=(t.x-r/2)/r*Math.PI*2,a=i.point,s=i.worldSize/(i.tileSize*r);return p(n,n,[a.x,a.y,-i.worldSize/Math.PI/2]),f(n,n,[s,s,s]),m(n,n,H(-i._center.lat)),g(n,n,H(-i._center.lng)),g(n,n,o),e&&f(n,n,[1,-1,1]),n},t.globeTileBounds=Yd,t.globeToMercatorTransition=function(t){return J(5,6,t)},t.identity=u,t.identity$1=N,t.invert=function(t,e){var i=e[0],n=e[1],r=e[2],o=e[3],a=e[4],s=e[5],l=e[6],c=e[7],h=e[8],u=e[9],d=e[10],p=e[11],f=e[12],m=e[13],g=e[14],y=e[15],_=i*s-n*a,v=i*l-r*a,x=i*c-o*a,b=n*l-r*s,w=n*c-o*s,M=r*c-o*l,T=h*m-u*f,S=h*g-d*f,E=h*y-p*f,C=u*g-d*m,A=u*y-p*m,P=d*y-p*g,L=_*P-v*A+x*C+b*E-w*S+M*T;return L?(t[0]=(s*P-l*A+c*C)*(L=1/L),t[1]=(r*A-n*P-o*C)*L,t[2]=(m*M-g*w+y*b)*L,t[3]=(d*w-u*M-p*b)*L,t[4]=(l*E-a*P-c*S)*L,t[5]=(i*P-r*E+o*S)*L,t[6]=(g*x-f*M-y*v)*L,t[7]=(h*M-d*x+p*v)*L,t[8]=(a*A-s*E+c*T)*L,t[9]=(n*E-i*A-o*T)*L,t[10]=(f*w-m*x+y*_)*L,t[11]=(u*x-h*w-p*_)*L,t[12]=(s*S-a*C-l*T)*L,t[13]=(i*C-n*S+r*T)*L,t[14]=(m*v-f*b-g*_)*L,t[15]=(h*b-u*v+d*_)*L,t):null},t.isMapAuthenticated=function(t){return Xt.has(t)},t.isMapboxURL=Ot,t.latFromMercatorY=As,t.len=z,t.length=x,t.length$1=function(t){return Math.hypot(t[0],t[1],t[2],t[3])},t.loadVectorTile=lp,t.makeRequest=ae,t.mercatorXfromLng=Ts,t.mercatorYfromLat=Ss,t.mercatorZfromAltitude=Es,t.mul=y,t.mul$1=O,t.multiply=function(t,e,i){var n=e[0],r=e[1],o=e[2],a=e[3],s=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=i[0],p=i[1],f=i[2],m=i[3],g=i[4],y=i[5],_=i[6],v=i[7],x=i[8];return t[0]=d*n+p*a+f*c,t[1]=d*r+p*s+f*h,t[2]=d*o+p*l+f*u,t[3]=m*n+g*a+y*c,t[4]=m*r+g*s+y*h,t[5]=m*o+g*l+y*u,t[6]=_*n+v*a+x*c,t[7]=_*r+v*s+x*h,t[8]=_*o+v*l+x*u,t},t.multiply$1=d,t.multiply$2=T,t.nextPowerOfTwo=ot,t.normalize=A,t.normalize$1=function(t,e){var i=e[0],n=e[1],r=e[2],o=e[3],a=i*i+n*n+r*r+o*o;return a>0&&(a=1/Math.sqrt(a)),t[0]=i*a,t[1]=n*a,t[2]=r*a,t[3]=o*a,t},t.number=Bi,t.ortho=function(t,e,i,n,r,o,a){var s=1/(e-i),l=1/(n-r),c=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+i)*s,t[13]=(r+n)*l,t[14]=(a+o)*c,t[15]=1,t},t.pbf=rh,t.perspective=function(t,e,i,n,r){var o,a=1/Math.tan(e/2);return t[0]=a/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(t[10]=(r+n)*(o=1/(n-r)),t[14]=2*r*n*o):(t[10]=-1,t[14]=-2*n),t},t.pick=function(t,e){const i={};for(let n=0;n<e.length;n++){const r=e[n];r in t&&(i[r]=t[r])}return i},t.plugin=Oo,t.pointGeometry=o,t.polygonIntersectsBox=Js,t.polygonIntersectsPolygon=Gs,t.polygonizeBounds=function(t,e,i=0,n=!0){const r=new o(i,i),a=t.sub(r),s=e.add(r),l=[a,new o(s.x,a.y),s,new o(a.x,s.y)];return n&&l.push(a),l},t.posAttributes=Rd,t.postMapLoadEvent=Zt,t.postTurnstileEvent=Vt,t.potpack=Ch,t.prevPowerOfTwo=function(t){return t<=1?1:Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},t.radToDeg=Z,t.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],t.registerForPluginStateChange=function(t){return t({pluginStatus:Ao,pluginURL:Po}),Ro.on("pluginStateChange",t),t},t.removeAuthState=function(t){Xt.delete(t)},t.renderColorRamp=vl,t.rotateX=m,t.rotateX$1=j,t.rotateY=g,t.rotateZ=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e[0],a=e[1],s=e[2],l=e[3],c=e[4],h=e[5],u=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*r+c*n,t[1]=a*r+h*n,t[2]=s*r+u*n,t[3]=l*r+d*n,t[4]=c*r-o*n,t[5]=h*r-a*n,t[6]=u*r-s*n,t[7]=d*r-l*n,t},t.rotateZ$1=function(t,e,i){i*=.5;var n=e[0],r=e[1],o=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=n*l+r*s,t[1]=r*l-n*s,t[2]=o*l+a*s,t[3]=a*l-o*s,t},t.scale=f,t.scale$1=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t},t.scale$2=E,t.scaleAndAdd=C,t.setCacheLimits=function(t,e){Kt=t,Qt=e},t.setColumn=function(t,e,i){t[4*e+0]=i[0],t[4*e+1]=i[1],t[4*e+2]=i[2],t[4*e+3]=i[3]},t.setRTLTextPlugin=function(t,e,i=!1){if(Ao===To||Ao===So||Ao===Eo)throw new Error("setRTLTextPlugin cannot be called multiple times.");Po=Tt.resolveURL(t),Ao=To,Co=e,Io(),i||ko()},t.smoothstep=J,t.spec=xe,t.storeAuthState=function(t,e){e?Xt.add(t):Xt.delete(t)},t.sub=k,t.subtract=M,t.symbolSize=Jc,t.tileAABB=function(t,e,i,n,r,o,a,s,l){if("globe"===l.name){const a=Yd(new rd(o,new nd(i,n,r)).canonical).getCorners(),s=Number.MAX_VALUE,l=[-s,-s,-s],d=[s,s,s],p=ep(t,e);for(let t=0;t<a.length;t++)I(a[t],a[t],p),h=d,u=a[t],(c=d)[0]=Math.min(h[0],u[0]),c[1]=Math.min(h[1],u[1]),c[2]=Math.min(h[2],u[2]),S(l,l,a[t]);return new al(d,l)}var c,h,u;const d=np({z:i,x:n,y:r},l);return new al([(o+d.x/d.scale)*e,e*(d.y/d.scale),a],[(o+d.x2/d.scale)*e,e*(d.y2/d.scale),s])},t.tileTransform=np,t.transformMat3=function(t,e,i){var n=e[0],r=e[1],o=e[2];return t[0]=n*i[0]+r*i[3]+o*i[6],t[1]=n*i[1]+r*i[4]+o*i[7],t[2]=n*i[2]+r*i[5]+o*i[8],t},t.transformMat4=I,t.transformMat4$1=B,t.transformQuat=R,t.translate=p,t.transpose=function(t,e){if(t===e){var i=e[1],n=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=n,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},t.triggerPluginCompletionEvent=Lo,t.uniqueId=nt,t.validateCustomStyleLayer=function(t){const e=[],i=t.id;return void 0===i&&e.push({message:`layers.${i}: missing required property "id"`}),void 0===t.render&&e.push({message:`layers.${i}: missing required method "render"`}),t.renderingMode&&"2d"!==t.renderingMode&&"3d"!==t.renderingMode&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},t.validateFog=Cr,t.validateLight=Er,t.validateStyle=Sr,t.values=tt,t.vectorTile=_c,t.version=i,t.warnOnce=pt,t.window=s,t.wrap=K})),r(0,(function(t){function e(t){const i=typeof t;if("number"===i||"boolean"===i||"string"===i||null==t)return JSON.stringify(t);if(Array.isArray(t)){let i="[";for(const n of t)i+=e(n)+",";return i+"]"}const n=Object.keys(t).sort();let r="{";for(let i=0;i<n.length;i++)r+=`${JSON.stringify(n[i])}:${e(t[n[i]])},`;return r+"}"}function i(i){let n="";for(const r of t.refProperties)n+="/"+e(i[r]);return n}class n{constructor(t){this.keyCache={},t&&this.replace(t)}replace(t){this._layerConfigs={},this._layers={},this.update(t,[])}update(e,n){for(const i of e)this._layerConfigs[i.id]=i,(this._layers[i.id]=t.createStyleLayer(i)).compileFilter(),this.keyCache[i.id]&&delete this.keyCache[i.id];for(const t of n)delete this.keyCache[t],delete this._layerConfigs[t],delete this._layers[t];this.familiesBySource={};const r=function(t,e){const n={};for(let r=0;r<t.length;r++){const o=e&&e[t[r].id]||i(t[r]);e&&(e[t[r].id]=o);let a=n[o];a||(a=n[o]=[]),a.push(t[r])}const r=[];for(const t in n)r.push(n[t]);return r}(t.values(this._layerConfigs),this.keyCache);for(const t of r){const e=t.map(t=>this._layers[t.id]),i=e[0];if("none"===i.visibility)continue;const n=i.source||"";let r=this.familiesBySource[n];r||(r=this.familiesBySource[n]={});const o=i.sourceLayer||"_geojsonTileLayer";let a=r[o];a||(a=r[o]=[]),a.push(e)}}}const{ImageBitmap:r}=t.window;class o{loadTile(e,i){const{uid:n,encoding:o,rawImageData:a,padding:s,buildQuadTree:l}=e,c=r&&a instanceof r?this.getImageData(a,s):a;i(null,new t.DEMData(n,c,o,s<1,l))}getImageData(e,i){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(e.width,e.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=e.width,this.offscreenCanvas.height=e.height,this.offscreenCanvasContext.drawImage(e,0,0,e.width,e.height);const n=this.offscreenCanvasContext.getImageData(-i,-i,e.width+2*i,e.height+2*i);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),new t.RGBAImage({width:n.width,height:n.height},n.data)}}var a=function t(e,i){var n,r=e&&e.type;if("FeatureCollection"===r)for(n=0;n<e.features.length;n++)t(e.features[n],i);else if("GeometryCollection"===r)for(n=0;n<e.geometries.length;n++)t(e.geometries[n],i);else if("Feature"===r)t(e.geometry,i);else if("Polygon"===r)s(e.coordinates,i);else if("MultiPolygon"===r)for(n=0;n<e.coordinates.length;n++)s(e.coordinates[n],i);return e};function s(t,e){if(0!==t.length){l(t[0],e);for(var i=1;i<t.length;i++)l(t[i],!e)}}function l(t,e){for(var i=0,n=0,r=0,o=t.length,a=o-1;r<o;a=r++){var s=(t[r][0]-t[a][0])*(t[a][1]+t[r][1]),l=i+s;n+=Math.abs(i)>=Math.abs(s)?i-l+s:s-l+i,i=l}i+n>=0!=!!e&&t.reverse()}const c=t.vectorTile.VectorTileFeature.prototype.toGeoJSON;class h{constructor(e){this._feature=e,this.extent=t.EXTENT,this.type=e.type,this.properties=e.tags,"id"in e&&!isNaN(e.id)&&(this.id=parseInt(e.id,10))}loadGeometry(){if(1===this._feature.type){const e=[];for(const i of this._feature.geometry)e.push([new t.pointGeometry(i[0],i[1])]);return e}{const e=[];for(const i of this._feature.geometry){const n=[];for(const e of i)n.push(new t.pointGeometry(e[0],e[1]));e.push(n)}return e}}toGeoJSON(t,e,i){return c.call(this,t,e,i)}}class u{constructor(e){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=t.EXTENT,this.length=e.length,this._features=e}feature(t){return new h(this._features[t])}}var d=t.vectorTile.VectorTileFeature,p=f;function f(t,e){this.options=e||{},this.features=t,this.length=t.length}function m(t,e){this.id="number"==typeof t.id?t.id:void 0,this.type=t.type,this.rawGeometry=1===t.type?[t.geometry]:t.geometry,this.properties=t.tags,this.extent=e||4096}f.prototype.feature=function(t){return new m(this.features[t],this.options.extent)},m.prototype.loadGeometry=function(){var e=this.rawGeometry;this.geometry=[];for(var i=0;i<e.length;i++){for(var n=e[i],r=[],o=0;o<n.length;o++)r.push(new t.pointGeometry(n[o][0],n[o][1]));this.geometry.push(r)}return this.geometry},m.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var t=this.geometry,e=1/0,i=-1/0,n=1/0,r=-1/0,o=0;o<t.length;o++)for(var a=t[o],s=0;s<a.length;s++){var l=a[s];e=Math.min(e,l.x),i=Math.max(i,l.x),n=Math.min(n,l.y),r=Math.max(r,l.y)}return[e,n,i,r]},m.prototype.toGeoJSON=d.prototype.toGeoJSON;var g=_,y=p;function _(e){var i=new t.pbf;return function(t,e){for(var i in t.layers)e.writeMessage(3,v,t.layers[i])}(e,i),i.finish()}function v(t,e){var i;e.writeVarintField(15,t.version||1),e.writeStringField(1,t.name||""),e.writeVarintField(5,t.extent||4096);var n={keys:[],values:[],keycache:{},valuecache:{}};for(i=0;i<t.length;i++)n.feature=t.feature(i),e.writeMessage(2,x,n);var r=n.keys;for(i=0;i<r.length;i++)e.writeStringField(3,r[i]);var o=n.values;for(i=0;i<o.length;i++)e.writeMessage(4,S,o[i])}function x(t,e){var i=t.feature;void 0!==i.id&&e.writeVarintField(1,i.id),e.writeMessage(2,b,t),e.writeVarintField(3,i.type),e.writeMessage(4,T,i)}function b(t,e){var i=t.feature,n=t.keys,r=t.values,o=t.keycache,a=t.valuecache;for(var s in i.properties){var l=i.properties[s],c=o[s];if(null!==l){void 0===c&&(n.push(s),o[s]=c=n.length-1),e.writeVarint(c);var h=typeof l;"string"!==h&&"boolean"!==h&&"number"!==h&&(l=JSON.stringify(l));var u=h+":"+l,d=a[u];void 0===d&&(r.push(l),a[u]=d=r.length-1),e.writeVarint(d)}}}function w(t,e){return(e<<3)+(7&t)}function M(t){return t<<1^t>>31}function T(t,e){for(var i=t.loadGeometry(),n=t.type,r=0,o=0,a=i.length,s=0;s<a;s++){var l=i[s],c=1;1===n&&(c=l.length),e.writeVarint(w(1,c));for(var h=3===n?l.length-1:l.length,u=0;u<h;u++){1===u&&1!==n&&e.writeVarint(w(2,h-1));var d=l[u].x-r,p=l[u].y-o;e.writeVarint(M(d)),e.writeVarint(M(p)),r+=d,o+=p}3===n&&e.writeVarint(w(7,1))}}function S(t,e){var i=typeof t;"string"===i?e.writeStringField(1,t):"boolean"===i?e.writeBooleanField(7,t):"number"===i&&(t%1!=0?e.writeDoubleField(3,t):t<0?e.writeSVarintField(6,t):e.writeVarintField(5,t))}function E(t,e,i,n,r,o){if(r-n<=i)return;const a=n+r>>1;(function t(e,i,n,r,o,a){for(;o>r;){if(o-r>600){const s=o-r+1,l=n-r+1,c=Math.log(s),h=.5*Math.exp(2*c/3),u=.5*Math.sqrt(c*h*(s-h)/s)*(l-s/2<0?-1:1);t(e,i,n,Math.max(r,Math.floor(n-l*h/s+u)),Math.min(o,Math.floor(n+(s-l)*h/s+u)),a)}const s=i[2*n+a];let l=r,c=o;for(C(e,i,r,n),i[2*o+a]>s&&C(e,i,r,o);l<c;){for(C(e,i,l,c),l++,c--;i[2*l+a]<s;)l++;for(;i[2*c+a]>s;)c--}i[2*r+a]===s?C(e,i,r,c):(c++,C(e,i,c,o)),c<=n&&(r=c+1),n<=c&&(o=c-1)}})(t,e,a,n,r,o%2),E(t,e,i,n,a-1,o+1),E(t,e,i,a+1,r,o+1)}function C(t,e,i,n){A(t,i,n),A(e,2*i,2*n),A(e,2*i+1,2*n+1)}function A(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}function P(t,e,i,n){const r=t-i,o=e-n;return r*r+o*o}g.fromVectorTileJs=_,g.fromGeojsonVt=function(t,e){e=e||{};var i={};for(var n in t)i[n]=new p(t[n].features,e),i[n].name=n,i[n].version=e.version,i[n].extent=e.extent;return _({layers:i})},g.GeoJSONWrapper=y;const L=t=>t[0],I=t=>t[1];class R{constructor(t,e=L,i=I,n=64,r=Float64Array){this.nodeSize=n,this.points=t;const o=t.length<65536?Uint16Array:Uint32Array,a=this.ids=new o(t.length),s=this.coords=new r(2*t.length);for(let n=0;n<t.length;n++)a[n]=n,s[2*n]=e(t[n]),s[2*n+1]=i(t[n]);E(a,s,n,0,a.length-1,0)}range(t,e,i,n){return function(t,e,i,n,r,o,a){const s=[0,t.length-1,0],l=[];let c,h;for(;s.length;){const u=s.pop(),d=s.pop(),p=s.pop();if(d-p<=a){for(let a=p;a<=d;a++)c=e[2*a],h=e[2*a+1],c>=i&&c<=r&&h>=n&&h<=o&&l.push(t[a]);continue}const f=Math.floor((p+d)/2);c=e[2*f],h=e[2*f+1],c>=i&&c<=r&&h>=n&&h<=o&&l.push(t[f]);const m=(u+1)%2;(0===u?i<=c:n<=h)&&(s.push(p),s.push(f-1),s.push(m)),(0===u?r>=c:o>=h)&&(s.push(f+1),s.push(d),s.push(m))}return l}(this.ids,this.coords,t,e,i,n,this.nodeSize)}within(t,e,i){return function(t,e,i,n,r,o){const a=[0,t.length-1,0],s=[],l=r*r;for(;a.length;){const c=a.pop(),h=a.pop(),u=a.pop();if(h-u<=o){for(let r=u;r<=h;r++)P(e[2*r],e[2*r+1],i,n)<=l&&s.push(t[r]);continue}const d=Math.floor((u+h)/2),p=e[2*d],f=e[2*d+1];P(p,f,i,n)<=l&&s.push(t[d]);const m=(c+1)%2;(0===c?i-r<=p:n-r<=f)&&(a.push(u),a.push(d-1),a.push(m)),(0===c?i+r>=p:n+r>=f)&&(a.push(d+1),a.push(h),a.push(m))}return s}(this.ids,this.coords,t,e,i,this.nodeSize)}}const D={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:t=>t},k=Math.fround||(O=new Float32Array(1),t=>(O[0]=+t,O[0]));var O;class z{constructor(t){this.options=H(Object.create(D),t),this.trees=new Array(this.options.maxZoom+1)}load(t){const{log:e,minZoom:i,maxZoom:n,nodeSize:r}=this.options;e&&console.time("total time");const o=`prepare ${t.length} points`;e&&console.time(o),this.points=t;let a=[];for(let e=0;e<t.length;e++)t[e].geometry&&a.push(F(t[e],e));this.trees[n+1]=new R(a,Z,W,r,Float32Array),e&&console.timeEnd(o);for(let t=n;t>=i;t--){const i=+Date.now();a=this._cluster(a,t),this.trees[t]=new R(a,Z,W,r,Float32Array),e&&console.log("z%d: %d clusters in %dms",t,a.length,+Date.now()-i)}return e&&console.timeEnd("total time"),this}getClusters(t,e){let i=((t[0]+180)%360+360)%360-180;const n=Math.max(-90,Math.min(90,t[1]));let r=180===t[2]?180:((t[2]+180)%360+360)%360-180;const o=Math.max(-90,Math.min(90,t[3]));if(t[2]-t[0]>=360)i=-180,r=180;else if(i>r){const t=this.getClusters([i,n,180,o],e),a=this.getClusters([-180,n,r,o],e);return t.concat(a)}const a=this.trees[this._limitZoom(e)],s=a.range(G(i),U(o),G(r),U(n)),l=[];for(const t of s){const e=a.points[t];l.push(e.numPoints?N(e):this.points[e.index])}return l}getChildren(t){const e=this._getOriginId(t),i=this._getOriginZoom(t),n="No cluster with the specified id.",r=this.trees[i];if(!r)throw new Error(n);const o=r.points[e];if(!o)throw new Error(n);const a=this.options.radius/(this.options.extent*Math.pow(2,i-1)),s=r.within(o.x,o.y,a),l=[];for(const e of s){const i=r.points[e];i.parentId===t&&l.push(i.numPoints?N(i):this.points[i.index])}if(0===l.length)throw new Error(n);return l}getLeaves(t,e,i){const n=[];return this._appendLeaves(n,t,e=e||10,i=i||0,0),n}getTile(t,e,i){const n=this.trees[this._limitZoom(t)],r=Math.pow(2,t),{extent:o,radius:a}=this.options,s=a/o,l=(i-s)/r,c=(i+1+s)/r,h={features:[]};return this._addTileFeatures(n.range((e-s)/r,l,(e+1+s)/r,c),n.points,e,i,r,h),0===e&&this._addTileFeatures(n.range(1-s/r,l,1,c),n.points,r,i,r,h),e===r-1&&this._addTileFeatures(n.range(0,l,s/r,c),n.points,-1,i,r,h),h.features.length?h:null}getClusterExpansionZoom(t){let e=this._getOriginZoom(t)-1;for(;e<=this.options.maxZoom;){const i=this.getChildren(t);if(e++,1!==i.length)break;t=i[0].properties.cluster_id}return e}_appendLeaves(t,e,i,n,r){const o=this.getChildren(e);for(const e of o){const o=e.properties;if(o&&o.cluster?r+o.point_count<=n?r+=o.point_count:r=this._appendLeaves(t,o.cluster_id,i,n,r):r<n?r++:t.push(e),t.length===i)break}return r}_addTileFeatures(t,e,i,n,r,o){for(const a of t){const t=e[a],s=t.numPoints;let l,c,h;if(s)l=j(t),c=t.x,h=t.y;else{const e=this.points[t.index];l=e.properties,c=G(e.geometry.coordinates[0]),h=U(e.geometry.coordinates[1])}const u={type:1,geometry:[[Math.round(this.options.extent*(c*r-i)),Math.round(this.options.extent*(h*r-n))]],tags:l};let d;s?d=t.id:this.options.generateId?d=t.index:this.points[t.index].id&&(d=this.points[t.index].id),void 0!==d&&(u.id=d),o.features.push(u)}}_limitZoom(t){return Math.max(this.options.minZoom,Math.min(+t,this.options.maxZoom+1))}_cluster(t,e){const i=[],{radius:n,extent:r,reduce:o,minPoints:a}=this.options,s=n/(r*Math.pow(2,e));for(let n=0;n<t.length;n++){const r=t[n];if(r.zoom<=e)continue;r.zoom=e;const l=this.trees[e+1],c=l.within(r.x,r.y,s),h=r.numPoints||1;let u=h;for(const t of c){const i=l.points[t];i.zoom>e&&(u+=i.numPoints||1)}if(u>h&&u>=a){let t=r.x*h,a=r.y*h,s=o&&h>1?this._map(r,!0):null;const d=(n<<5)+(e+1)+this.points.length;for(const i of c){const n=l.points[i];if(n.zoom<=e)continue;n.zoom=e;const c=n.numPoints||1;t+=n.x*c,a+=n.y*c,n.parentId=d,o&&(s||(s=this._map(r,!0)),o(s,this._map(n)))}r.parentId=d,i.push(B(t/u,a/u,d,u,s))}else if(i.push(r),u>1)for(const t of c){const n=l.points[t];n.zoom<=e||(n.zoom=e,i.push(n))}}return i}_getOriginId(t){return t-this.points.length>>5}_getOriginZoom(t){return(t-this.points.length)%32}_map(t,e){if(t.numPoints)return e?H({},t.properties):t.properties;const i=this.points[t.index].properties,n=this.options.map(i);return e&&n===i?H({},n):n}}function B(t,e,i,n,r){return{x:k(t),y:k(e),zoom:1/0,id:i,parentId:-1,numPoints:n,properties:r}}function F(t,e){const[i,n]=t.geometry.coordinates;return{x:k(G(i)),y:k(U(n)),zoom:1/0,index:e,parentId:-1}}function N(t){return{type:"Feature",id:t.id,properties:j(t),geometry:{type:"Point",coordinates:[(e=t.x,360*(e-.5)),V(t.y)]}};var e}function j(t){const e=t.numPoints,i=e>=1e4?Math.round(e/1e3)+"k":e>=1e3?Math.round(e/100)/10+"k":e;return H(H({},t.properties),{cluster:!0,cluster_id:t.id,point_count:e,point_count_abbreviated:i})}function G(t){return t/360+.5}function U(t){const e=Math.sin(t*Math.PI/180),i=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return i<0?0:i>1?1:i}function V(t){const e=(180-360*t)*Math.PI/180;return 360*Math.atan(Math.exp(e))/Math.PI-90}function H(t,e){for(const i in e)t[i]=e[i];return t}function Z(t){return t.x}function W(t){return t.y}function q(t,e,i,n,r,o){var a=r-i,s=o-n;if(0!==a||0!==s){var l=((t-i)*a+(e-n)*s)/(a*a+s*s);l>1?(i=r,n=o):l>0&&(i+=a*l,n+=s*l)}return(a=t-i)*a+(s=e-n)*s}function X(t,e,i,n){var r={id:void 0===t?null:t,type:e,geometry:i,tags:n,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(t){var e=t.geometry,i=t.type;if("Point"===i||"MultiPoint"===i||"LineString"===i)Y(t,e);else if("Polygon"===i||"MultiLineString"===i)for(var n=0;n<e.length;n++)Y(t,e[n]);else if("MultiPolygon"===i)for(n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)Y(t,e[n][r])}(r),r}function Y(t,e){for(var i=0;i<e.length;i+=3)t.minX=Math.min(t.minX,e[i]),t.minY=Math.min(t.minY,e[i+1]),t.maxX=Math.max(t.maxX,e[i]),t.maxY=Math.max(t.maxY,e[i+1])}function $(t,e,i,n){if(e.geometry){var r=e.geometry.coordinates,o=e.geometry.type,a=Math.pow(i.tolerance/((1<<i.maxZoom)*i.extent),2),s=[],l=e.id;if(i.promoteId?l=e.properties[i.promoteId]:i.generateId&&(l=n||0),"Point"===o)J(r,s);else if("MultiPoint"===o)for(var c=0;c<r.length;c++)J(r[c],s);else if("LineString"===o)K(r,s,a,!1);else if("MultiLineString"===o){if(i.lineMetrics){for(c=0;c<r.length;c++)K(r[c],s=[],a,!1),t.push(X(l,"LineString",s,e.properties));return}Q(r,s,a,!1)}else if("Polygon"===o)Q(r,s,a,!0);else{if("MultiPolygon"!==o){if("GeometryCollection"===o){for(c=0;c<e.geometry.geometries.length;c++)$(t,{id:l,geometry:e.geometry.geometries[c],properties:e.properties},i,n);return}throw new Error("Input data is not a valid GeoJSON object.")}for(c=0;c<r.length;c++){var h=[];Q(r[c],h,a,!0),s.push(h)}}t.push(X(l,o,s,e.properties))}}function J(t,e){e.push(tt(t[0])),e.push(et(t[1])),e.push(0)}function K(t,e,i,n){for(var r,o,a=0,s=0;s<t.length;s++){var l=tt(t[s][0]),c=et(t[s][1]);e.push(l),e.push(c),e.push(0),s>0&&(a+=n?(r*c-l*o)/2:Math.sqrt(Math.pow(l-r,2)+Math.pow(c-o,2))),r=l,o=c}var h=e.length-3;e[2]=1,function t(e,i,n,r){for(var o,a=r,s=n-i>>1,l=n-i,c=e[i],h=e[i+1],u=e[n],d=e[n+1],p=i+3;p<n;p+=3){var f=q(e[p],e[p+1],c,h,u,d);if(f>a)o=p,a=f;else if(f===a){var m=Math.abs(p-s);m<l&&(o=p,l=m)}}a>r&&(o-i>3&&t(e,i,o,r),e[o+2]=a,n-o>3&&t(e,o,n,r))}(e,0,h,i),e[h+2]=1,e.size=Math.abs(a),e.start=0,e.end=e.size}function Q(t,e,i,n){for(var r=0;r<t.length;r++){var o=[];K(t[r],o,i,n),e.push(o)}}function tt(t){return t/360+.5}function et(t){var e=Math.sin(t*Math.PI/180),i=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return i<0?0:i>1?1:i}function it(t,e,i,n,r,o,a,s){if(n/=e,o>=(i/=e)&&a<n)return t;if(a<i||o>=n)return null;for(var l=[],c=0;c<t.length;c++){var h=t[c],u=h.geometry,d=h.type,p=0===r?h.minX:h.minY,f=0===r?h.maxX:h.maxY;if(p>=i&&f<n)l.push(h);else if(!(f<i||p>=n)){var m=[];if("Point"===d||"MultiPoint"===d)nt(u,m,i,n,r);else if("LineString"===d)rt(u,m,i,n,r,!1,s.lineMetrics);else if("MultiLineString"===d)at(u,m,i,n,r,!1);else if("Polygon"===d)at(u,m,i,n,r,!0);else if("MultiPolygon"===d)for(var g=0;g<u.length;g++){var y=[];at(u[g],y,i,n,r,!0),y.length&&m.push(y)}if(m.length){if(s.lineMetrics&&"LineString"===d){for(g=0;g<m.length;g++)l.push(X(h.id,d,m[g],h.tags));continue}"LineString"!==d&&"MultiLineString"!==d||(1===m.length?(d="LineString",m=m[0]):d="MultiLineString"),"Point"!==d&&"MultiPoint"!==d||(d=3===m.length?"Point":"MultiPoint"),l.push(X(h.id,d,m,h.tags))}}}return l.length?l:null}function nt(t,e,i,n,r){for(var o=0;o<t.length;o+=3){var a=t[o+r];a>=i&&a<=n&&(e.push(t[o]),e.push(t[o+1]),e.push(t[o+2]))}}function rt(t,e,i,n,r,o,a){for(var s,l,c=ot(t),h=0===r?lt:ct,u=t.start,d=0;d<t.length-3;d+=3){var p=t[d],f=t[d+1],m=t[d+2],g=t[d+3],y=t[d+4],_=0===r?p:f,v=0===r?g:y,x=!1;a&&(s=Math.sqrt(Math.pow(p-g,2)+Math.pow(f-y,2))),_<i?v>i&&(l=h(c,p,f,g,y,i),a&&(c.start=u+s*l)):_>n?v<n&&(l=h(c,p,f,g,y,n),a&&(c.start=u+s*l)):st(c,p,f,m),v<i&&_>=i&&(l=h(c,p,f,g,y,i),x=!0),v>n&&_<=n&&(l=h(c,p,f,g,y,n),x=!0),!o&&x&&(a&&(c.end=u+s*l),e.push(c),c=ot(t)),a&&(u+=s)}var b=t.length-3;p=t[b],f=t[b+1],m=t[b+2],(_=0===r?p:f)>=i&&_<=n&&st(c,p,f,m),b=c.length-3,o&&b>=3&&(c[b]!==c[0]||c[b+1]!==c[1])&&st(c,c[0],c[1],c[2]),c.length&&e.push(c)}function ot(t){var e=[];return e.size=t.size,e.start=t.start,e.end=t.end,e}function at(t,e,i,n,r,o){for(var a=0;a<t.length;a++)rt(t[a],e,i,n,r,o,!1)}function st(t,e,i,n){t.push(e),t.push(i),t.push(n)}function lt(t,e,i,n,r,o){var a=(o-e)/(n-e);return t.push(o),t.push(i+(r-i)*a),t.push(1),a}function ct(t,e,i,n,r,o){var a=(o-i)/(r-i);return t.push(e+(n-e)*a),t.push(o),t.push(1),a}function ht(t,e){for(var i=[],n=0;n<t.length;n++){var r,o=t[n],a=o.type;if("Point"===a||"MultiPoint"===a||"LineString"===a)r=ut(o.geometry,e);else if("MultiLineString"===a||"Polygon"===a){r=[];for(var s=0;s<o.geometry.length;s++)r.push(ut(o.geometry[s],e))}else if("MultiPolygon"===a)for(r=[],s=0;s<o.geometry.length;s++){for(var l=[],c=0;c<o.geometry[s].length;c++)l.push(ut(o.geometry[s][c],e));r.push(l)}i.push(X(o.id,a,r,o.tags))}return i}function ut(t,e){var i=[];i.size=t.size,void 0!==t.start&&(i.start=t.start,i.end=t.end);for(var n=0;n<t.length;n+=3)i.push(t[n]+e,t[n+1],t[n+2]);return i}function dt(t,e){if(t.transformed)return t;var i,n,r,o=1<<t.z,a=t.x,s=t.y;for(i=0;i<t.features.length;i++){var l=t.features[i],c=l.geometry,h=l.type;if(l.geometry=[],1===h)for(n=0;n<c.length;n+=2)l.geometry.push(pt(c[n],c[n+1],e,o,a,s));else for(n=0;n<c.length;n++){var u=[];for(r=0;r<c[n].length;r+=2)u.push(pt(c[n][r],c[n][r+1],e,o,a,s));l.geometry.push(u)}}return t.transformed=!0,t}function pt(t,e,i,n,r,o){return[Math.round(i*(t*n-r)),Math.round(i*(e*n-o))]}function ft(t,e,i,n,r){for(var o=e===r.maxZoom?0:r.tolerance/((1<<e)*r.extent),a={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:i,y:n,z:e,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},s=0;s<t.length;s++){a.numFeatures++,mt(a,t[s],o,r);var l=t[s].minX,c=t[s].minY,h=t[s].maxX,u=t[s].maxY;l<a.minX&&(a.minX=l),c<a.minY&&(a.minY=c),h>a.maxX&&(a.maxX=h),u>a.maxY&&(a.maxY=u)}return a}function mt(t,e,i,n){var r=e.geometry,o=e.type,a=[];if("Point"===o||"MultiPoint"===o)for(var s=0;s<r.length;s+=3)a.push(r[s]),a.push(r[s+1]),t.numPoints++,t.numSimplified++;else if("LineString"===o)gt(a,r,t,i,!1,!1);else if("MultiLineString"===o||"Polygon"===o)for(s=0;s<r.length;s++)gt(a,r[s],t,i,"Polygon"===o,0===s);else if("MultiPolygon"===o)for(var l=0;l<r.length;l++){var c=r[l];for(s=0;s<c.length;s++)gt(a,c[s],t,i,!0,0===s)}if(a.length){var h=e.tags||null;if("LineString"===o&&n.lineMetrics){for(var u in h={},e.tags)h[u]=e.tags[u];h.mapbox_clip_start=r.start/r.size,h.mapbox_clip_end=r.end/r.size}var d={geometry:a,type:"Polygon"===o||"MultiPolygon"===o?3:"LineString"===o||"MultiLineString"===o?2:1,tags:h};null!==e.id&&(d.id=e.id),t.features.push(d)}}function gt(t,e,i,n,r,o){var a=n*n;if(n>0&&e.size<(r?a:n))i.numPoints+=e.length/3;else{for(var s=[],l=0;l<e.length;l+=3)(0===n||e[l+2]>a)&&(i.numSimplified++,s.push(e[l]),s.push(e[l+1])),i.numPoints++;r&&function(t,e){for(var i=0,n=0,r=t.length,o=r-2;n<r;o=n,n+=2)i+=(t[n]-t[o])*(t[n+1]+t[o+1]);if(i>0===e)for(n=0,r=t.length;n<r/2;n+=2){var a=t[n],s=t[n+1];t[n]=t[r-2-n],t[n+1]=t[r-1-n],t[r-2-n]=a,t[r-1-n]=s}}(s,o),t.push(s)}}function yt(t,e){var i=(e=this.options=function(t,e){for(var i in e)t[i]=e[i];return t}(Object.create(this.options),e)).debug;if(i&&console.time("preprocess data"),e.maxZoom<0||e.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(e.promoteId&&e.generateId)throw new Error("promoteId and generateId cannot be used together.");var n=function(t,e){var i=[];if("FeatureCollection"===t.type)for(var n=0;n<t.features.length;n++)$(i,t.features[n],e,n);else $(i,"Feature"===t.type?t:{geometry:t},e);return i}(t,e);this.tiles={},this.tileCoords=[],i&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",e.indexMaxZoom,e.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(n=function(t,e){var i=e.buffer/e.extent,n=t,r=it(t,1,-1-i,i,0,-1,2,e),o=it(t,1,1-i,2+i,0,-1,2,e);return(r||o)&&(n=it(t,1,-i,1+i,0,-1,2,e)||[],r&&(n=ht(r,1).concat(n)),o&&(n=n.concat(ht(o,-1)))),n}(n,e)).length&&this.splitTile(n,0,0,0),i&&(n.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function _t(t,e,i){return 32*((1<<t)*i+e)+t}function vt(t,e){const i=t.tileID.canonical;if(!this._geoJSONIndex)return e(null,null);const n=this._geoJSONIndex.getTile(i.z,i.x,i.y);if(!n)return e(null,null);const r=new u(n.features);let o=g(r);0===o.byteOffset&&o.byteLength===o.buffer.byteLength||(o=new Uint8Array(o)),e(null,{vectorTile:r,rawData:o.buffer})}yt.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},yt.prototype.splitTile=function(t,e,i,n,r,o,a){for(var s=[t,e,i,n],l=this.options,c=l.debug;s.length;){n=s.pop(),i=s.pop(),e=s.pop(),t=s.pop();var h=1<<e,u=_t(e,i,n),d=this.tiles[u];if(!d&&(c>1&&console.time("creation"),d=this.tiles[u]=ft(t,e,i,n,l),this.tileCoords.push({z:e,x:i,y:n}),c)){c>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",e,i,n,d.numFeatures,d.numPoints,d.numSimplified),console.timeEnd("creation"));var p="z"+e;this.stats[p]=(this.stats[p]||0)+1,this.total++}if(d.source=t,r){if(e===l.maxZoom||e===r)continue;var f=1<<r-e;if(i!==Math.floor(o/f)||n!==Math.floor(a/f))continue}else if(e===l.indexMaxZoom||d.numPoints<=l.indexMaxPoints)continue;if(d.source=null,0!==t.length){c>1&&console.time("clipping");var m,g,y,_,v,x,b=.5*l.buffer/l.extent,w=.5-b,M=.5+b,T=1+b;m=g=y=_=null,v=it(t,h,i-b,i+M,0,d.minX,d.maxX,l),x=it(t,h,i+w,i+T,0,d.minX,d.maxX,l),t=null,v&&(m=it(v,h,n-b,n+M,1,d.minY,d.maxY,l),g=it(v,h,n+w,n+T,1,d.minY,d.maxY,l),v=null),x&&(y=it(x,h,n-b,n+M,1,d.minY,d.maxY,l),_=it(x,h,n+w,n+T,1,d.minY,d.maxY,l),x=null),c>1&&console.timeEnd("clipping"),s.push(m||[],e+1,2*i,2*n),s.push(g||[],e+1,2*i,2*n+1),s.push(y||[],e+1,2*i+1,2*n),s.push(_||[],e+1,2*i+1,2*n+1)}}},yt.prototype.getTile=function(t,e,i){var n=this.options,r=n.extent,o=n.debug;if(t<0||t>24)return null;var a=1<<t,s=_t(t,e=(e%a+a)%a,i);if(this.tiles[s])return dt(this.tiles[s],r);o>1&&console.log("drilling down to z%d-%d-%d",t,e,i);for(var l,c=t,h=e,u=i;!l&&c>0;)c--,h=Math.floor(h/2),u=Math.floor(u/2),l=this.tiles[_t(c,h,u)];return l&&l.source?(o>1&&console.log("found parent tile z%d-%d-%d",c,h,u),o>1&&console.time("drilling down"),this.splitTile(l.source,c,h,u,t,e,i),o>1&&console.timeEnd("drilling down"),this.tiles[s]?dt(this.tiles[s],r):null):null};class xt extends t.VectorTileWorkerSource{constructor(t,e,i,n,r){super(t,e,i,n,vt),r&&(this.loadGeoJSON=r)}loadData(e,i){const n=e&&e.request,r=n&&n.collectResourceTiming;this.loadGeoJSON(e,(o,s)=>{if(o||!s)return i(o);if("object"!=typeof s)return i(new Error(`Input data given to '${e.source}' is not a valid GeoJSON object.`));{a(s,!0);try{if(e.filter){const i=t.createExpression(e.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===i.result)throw new Error(i.value.map(t=>`${t.key}: ${t.message}`).join(", "));const n=s.features.filter(t=>i.value.evaluate({zoom:0},t));s={type:"FeatureCollection",features:n}}this._geoJSONIndex=e.cluster?new z(function({superclusterOptions:e,clusterProperties:i}){if(!i||!e)return e;const n={},r={},o={accumulated:null,zoom:0},a={properties:null},s=Object.keys(i);for(const e of s){const[o,a]=i[e],s=t.createExpression(a),l=t.createExpression("string"==typeof o?[o,["accumulated"],["get",e]]:o);n[e]=s.value,r[e]=l.value}return e.map=t=>{a.properties=t;const e={};for(const t of s)e[t]=n[t].evaluate(o,a);return e},e.reduce=(t,e)=>{a.properties=e;for(const e of s)o.accumulated=t[e],t[e]=r[e].evaluate(o,a)},e}(e)).load(s.features):function(t,e){return new yt(t,e)}(s,e.geojsonVtOptions)}catch(o){return i(o)}this.loaded={};const l={};if(r){const i=t.getPerformanceMeasurement(n);i&&(l.resourceTiming={},l.resourceTiming[e.source]=JSON.parse(JSON.stringify(i)))}i(null,l)}})}reloadTile(t,e){const i=this.loaded;return i&&i[t.uid]?super.reloadTile(t,e):this.loadTile(t,e)}loadGeoJSON(e,i){if(e.request)t.getJSON(e.request,i);else{if("string"!=typeof e.data)return i(new Error(`Input data given to '${e.source}' is not a valid GeoJSON object.`));try{return i(null,JSON.parse(e.data))}catch(t){return i(new Error(`Input data given to '${e.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(t,e){try{e(null,this._geoJSONIndex.getClusterExpansionZoom(t.clusterId))}catch(t){e(t)}}getClusterChildren(t,e){try{e(null,this._geoJSONIndex.getChildren(t.clusterId))}catch(t){e(t)}}getClusterLeaves(t,e){try{e(null,this._geoJSONIndex.getLeaves(t.clusterId,t.limit,t.offset))}catch(t){e(t)}}}class bt{constructor(e){this.self=e,this.actor=new t.Actor(e,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=t.getProjection({name:"mercator"}),this.workerSourceTypes={vector:t.VectorTileWorkerSource,geojson:xt},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(t,e)=>{if(this.workerSourceTypes[t])throw new Error(`Worker source with name "${t}" already registered.`);this.workerSourceTypes[t]=e},this.self.registerRTLTextPlugin=e=>{if(t.plugin.isParsed())throw new Error("RTL text plugin already registered.");t.plugin.applyArabicShaping=e.applyArabicShaping,t.plugin.processBidirectionalText=e.processBidirectionalText,t.plugin.processStyledBidirectionalText=e.processStyledBidirectionalText}}clearCaches(t,e,i){delete this.layerIndexes[t],delete this.availableImages[t],delete this.workerSources[t],delete this.demWorkerSources[t],i()}checkIfReady(t,e,i){i()}setReferrer(t,e){this.referrer=e}spriteLoaded(e,i){this.isSpriteLoaded[e]=i;for(const n in this.workerSources[e]){const r=this.workerSources[e][n];for(const e in r)r[e]instanceof t.VectorTileWorkerSource&&(r[e].isSpriteLoaded=i,r[e].fire(new t.Event("isSpriteLoaded")))}}setImages(t,e,i){this.availableImages[t]=e;for(const i in this.workerSources[t]){const n=this.workerSources[t][i];for(const t in n)n[t].availableImages=e}i()}enableTerrain(t,e,i){this.terrain=e,i()}setProjection(e,i){this.projections[e]=t.getProjection(i)}setLayers(t,e,i){this.getLayerIndex(t).replace(e),i()}updateLayers(t,e,i){this.getLayerIndex(t).update(e.layers,e.removedIds),i()}loadTile(e,i,n){const r=this.enableTerrain?t.extend({enableTerrain:this.terrain},i):i;r.projection=this.projections[e]||this.defaultProjection,this.getWorkerSource(e,i.type,i.source).loadTile(r,n)}loadDEMTile(e,i,n){const r=this.enableTerrain?t.extend({buildQuadTree:this.terrain},i):i;this.getDEMWorkerSource(e,i.source).loadTile(r,n)}reloadTile(e,i,n){const r=this.enableTerrain?t.extend({enableTerrain:this.terrain},i):i;r.projection=this.projections[e]||this.defaultProjection,this.getWorkerSource(e,i.type,i.source).reloadTile(r,n)}abortTile(t,e,i){this.getWorkerSource(t,e.type,e.source).abortTile(e,i)}removeTile(t,e,i){this.getWorkerSource(t,e.type,e.source).removeTile(e,i)}removeSource(t,e,i){if(!this.workerSources[t]||!this.workerSources[t][e.type]||!this.workerSources[t][e.type][e.source])return;const n=this.workerSources[t][e.type][e.source];delete this.workerSources[t][e.type][e.source],void 0!==n.removeSource?n.removeSource(e,i):i()}loadWorkerSource(t,e,i){try{this.self.importScripts(e.url),i()}catch(t){i(t.toString())}}syncRTLPluginState(e,i,n){try{t.plugin.setState(i);const e=t.plugin.getPluginURL();if(t.plugin.isLoaded()&&!t.plugin.isParsed()&&null!=e){this.self.importScripts(e);const i=t.plugin.isParsed();n(i?void 0:new Error("RTL Text Plugin failed to import scripts from "+e),i)}}catch(t){n(t.toString())}}getAvailableImages(t){let e=this.availableImages[t];return e||(e=[]),e}getLayerIndex(t){let e=this.layerIndexes[t];return e||(e=this.layerIndexes[t]=new n),e}getWorkerSource(t,e,i){return this.workerSources[t]||(this.workerSources[t]={}),this.workerSources[t][e]||(this.workerSources[t][e]={}),this.workerSources[t][e][i]||(this.workerSources[t][e][i]=new this.workerSourceTypes[e]({send:(e,i,n,r,o,a)=>{this.actor.send(e,i,n,t,o,a)},scheduler:this.actor.scheduler},this.getLayerIndex(t),this.getAvailableImages(t),this.isSpriteLoaded[t])),this.workerSources[t][e][i]}getDEMWorkerSource(t,e){return this.demWorkerSources[t]||(this.demWorkerSources[t]={}),this.demWorkerSources[t][e]||(this.demWorkerSources[t][e]=new o),this.demWorkerSources[t][e]}enforceCacheSizeLimit(e,i){t.enforceCacheSizeLimit(i)}getWorkerPerformanceMetrics(t,e,i){i(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new bt(self)),bt})),r(0,(function(t){var e=i;function i(t){return!function(t){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var t,e,i=new Blob([""],{type:"text/javascript"}),n=URL.createObjectURL(i);try{e=new Worker(n),t=!0}catch(e){t=!1}return e&&e.terminate(),URL.revokeObjectURL(n),t}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var t=document.createElement("canvas");t.width=t.height=1;var e=t.getContext("2d");if(!e)return!1;var i=e.getImageData(0,0,1,1);return i&&i.width===t.width}()?(void 0===n[e=t&&t.failIfMajorPerformanceCaveat]&&(n[e]=function(t){var e,n=function(t){var e=document.createElement("canvas"),n=Object.create(i.webGLContextAttributes);return n.failIfMajorPerformanceCaveat=t,e.getContext("webgl",n)||e.getContext("experimental-webgl",n)}(t);if(!n)return!1;try{e=n.createShader(n.VERTEX_SHADER)}catch(t){return!1}return!(!e||n.isContextLost())&&(n.shaderSource(e,"void main() {}"),n.compileShader(e),!0===n.getShaderParameter(e,n.COMPILE_STATUS))}(e)),n[e]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var e}(t)}var n={};function r(t,e){var i=e[0],n=e[1],r=e[2],o=e[3],a=i*o-r*n;return a?(t[0]=o*(a=1/a),t[1]=-n*a,t[2]=-r*a,t[3]=i*a,t):null}function o(t,e){if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!o(t[i],e[i]))return!1;return!0}if("object"==typeof t&&null!==t&&null!==e){if("object"!=typeof e)return!1;if(Object.keys(t).length!==Object.keys(e).length)return!1;for(const i in t)if(!o(t[i],e[i]))return!1;return!0}return t===e}i.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const a={create:function(e,i,n){const r=t.window.document.createElement(e);return void 0!==i&&(r.className=i),n&&n.appendChild(r),r},createSVG:function(e,i,n){const r=t.window.document.createElementNS("http://www.w3.org/2000/svg",e);for(const t of Object.keys(i))r.setAttributeNS(null,t,i[t]);return n&&n.appendChild(r),r}},s=t.window.document&&t.window.document.documentElement.style,l=s&&void 0!==s.userSelect?"userSelect":"WebkitUserSelect";let c;a.disableDrag=function(){s&&l&&(c=s[l],s[l]="none")},a.enableDrag=function(){s&&l&&(s[l]=c)};const h=function(e){e.preventDefault(),e.stopPropagation(),t.window.removeEventListener("click",h,!0)};function u(e,i,n){const r=e.offsetWidth===i.width?1:e.offsetWidth/i.width;return new t.pointGeometry((n.clientX-i.left)*r,(n.clientY-i.top)*r)}function d(t){const{userImage:e}=t;return!!(e&&e.render&&e.render())&&(t.data.replace(new Uint8Array(e.data.buffer)),!0)}a.suppressClick=function(){t.window.addEventListener("click",h,!0),t.window.setTimeout(()=>{t.window.removeEventListener("click",h,!0)},0)},a.mousePos=function(t,e){const i=t.getBoundingClientRect();return u(t,i,e)},a.touchPos=function(t,e){const i=t.getBoundingClientRect(),n=[];for(let r=0;r<e.length;r++)n.push(u(t,i,e[r]));return n},a.mouseButton=function(e){return void 0!==t.window.InstallTrigger&&2===e.button&&e.ctrlKey&&t.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:e.button};class p extends t.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new t.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(t){if(this.loaded!==t&&(this.loaded=t,t)){for(const{ids:t,callback:e}of this.requestors)this._notify(t,e);this.requestors=[]}}getImage(t){return this.images[t]}addImage(t,e){this._validate(t,e)&&(this.images[t]=e)}_validate(e,i){let n=!0;return this._validateStretch(i.stretchX,i.data&&i.data.width)||(this.fire(new t.ErrorEvent(new Error(`Image "${e}" has invalid "stretchX" value`))),n=!1),this._validateStretch(i.stretchY,i.data&&i.data.height)||(this.fire(new t.ErrorEvent(new Error(`Image "${e}" has invalid "stretchY" value`))),n=!1),this._validateContent(i.content,i)||(this.fire(new t.ErrorEvent(new Error(`Image "${e}" has invalid "content" value`))),n=!1),n}_validateStretch(t,e){if(!t)return!0;let i=0;for(const n of t){if(n[0]<i||n[1]<n[0]||e<n[1])return!1;i=n[1]}return!0}_validateContent(t,e){return!(t&&(4!==t.length||t[0]<0||e.data.width<t[0]||t[1]<0||e.data.height<t[1]||t[2]<0||e.data.width<t[2]||t[3]<0||e.data.height<t[3]||t[2]<t[0]||t[3]<t[1]))}updateImage(t,e){e.version=this.images[t].version+1,this.images[t]=e,this.updatedImages[t]=!0}removeImage(t){const e=this.images[t];delete this.images[t],delete this.patterns[t],e.userImage&&e.userImage.onRemove&&e.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(t,e){let i=!0;if(!this.isLoaded())for(const e of t)this.images[e]||(i=!1);this.isLoaded()||i?this._notify(t,e):this.requestors.push({ids:t,callback:e})}_notify(e,i){const n={};for(const i of e){this.images[i]||this.fire(new t.Event("styleimagemissing",{id:i}));const e=this.images[i];e?n[i]={data:e.data.clone(),pixelRatio:e.pixelRatio,sdf:e.sdf,version:e.version,stretchX:e.stretchX,stretchY:e.stretchY,content:e.content,hasRenderCallback:Boolean(e.userImage&&e.userImage.render)}:t.warnOnce(`Image "${i}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}i(null,n)}getPixelSize(){const{width:t,height:e}=this.atlasImage;return{width:t,height:e}}getPattern(e){const i=this.patterns[e],n=this.getImage(e);if(!n)return null;if(i&&i.position.version===n.version)return i.position;if(i)i.position.version=n.version;else{const i={w:n.data.width+2,h:n.data.height+2,x:0,y:0},r=new t.ImagePosition(i,n);this.patterns[e]={bin:i,position:r}}return this._updatePatternAtlas(),this.patterns[e].position}bind(e){const i=e.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new t.Texture(e,this.atlasImage,i.RGBA),this.atlasTexture.bind(i.LINEAR,i.CLAMP_TO_EDGE)}_updatePatternAtlas(){const e=[];for(const t in this.patterns)e.push(this.patterns[t].bin);const{w:i,h:n}=t.potpack(e),r=this.atlasImage;r.resize({width:i||1,height:n||1});for(const e in this.patterns){const{bin:i}=this.patterns[e],n=i.x+1,o=i.y+1,a=this.images[e].data,s=a.width,l=a.height;t.RGBAImage.copy(a,r,{x:0,y:0},{x:n,y:o},{width:s,height:l}),t.RGBAImage.copy(a,r,{x:0,y:l-1},{x:n,y:o-1},{width:s,height:1}),t.RGBAImage.copy(a,r,{x:0,y:0},{x:n,y:o+l},{width:s,height:1}),t.RGBAImage.copy(a,r,{x:s-1,y:0},{x:n-1,y:o},{width:1,height:l}),t.RGBAImage.copy(a,r,{x:0,y:0},{x:n+s,y:o},{width:1,height:l})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(t){for(const e of t){if(this.callbackDispatchedThisFrame[e])continue;this.callbackDispatchedThisFrame[e]=!0;const t=this.images[e];d(t)&&this.updateImage(e,t)}}}const f=new t.Properties({anchor:new t.DataConstantProperty(t.spec.light.anchor),position:new class{constructor(){this.specification=t.spec.light.position}possiblyEvaluate(e,i){return function([e,i,n]){const r=t.degToRad(i+90),o=t.degToRad(n);return{x:e*Math.cos(r)*Math.sin(o),y:e*Math.sin(r)*Math.sin(o),z:e*Math.cos(o),azimuthal:i,polar:n}}(e.expression.evaluate(i))}interpolate(e,i,n){return{x:t.number(e.x,i.x,n),y:t.number(e.y,i.y,n),z:t.number(e.z,i.z,n),azimuthal:t.number(e.azimuthal,i.azimuthal,n),polar:t.number(e.polar,i.polar,n)}}},color:new t.DataConstantProperty(t.spec.light.color),intensity:new t.DataConstantProperty(t.spec.light.intensity)}),m="-transition";class g extends t.Evented{constructor(e){super(),this._transitionable=new t.Transitionable(f),this.setLight(e),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,i={}){if(!this._validate(t.validateLight,e,i))for(const i in e){const n=e[i];t.endsWith(i,m)?this._transitionable.setTransition(i.slice(0,-m.length),n):this._transitionable.setValue(i,n)}}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(e,i,n){return(!n||!1!==n.validate)&&t.emitValidationErrors(this,e.call(t.validateStyle,t.extend({value:i,style:{glyphs:!0,sprite:!0},styleSpec:t.spec})))}}const y=new t.Properties({source:new t.DataConstantProperty(t.spec.terrain.source),exaggeration:new t.DataConstantProperty(t.spec.terrain.exaggeration)}),_="-transition";class v extends t.Evented{constructor(e,i){super(),this._transitionable=new t.Transitionable(y),this.set(e),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=i}get(){return this._transitionable.serialize()}set(e){for(const i in e){const n=e[i];t.endsWith(i,_)?this._transitionable.setTransition(i.slice(0,-_.length),n):this._transitionable.setValue(i,n)}}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}}function x(e,i,n,r){const o=t.smoothstep(45,65,n),[a,s]=b(e,r),l=t.length(i);let c=1-Math.min(1,Math.exp((l-a)/(s-a)*-6));return c*=c*c,c=Math.min(1,1.00747*c),c*o*e.alpha}function b(t,e){const i=.5/Math.tan(.5*e);return[t.range[0]+i,t.range[1]+i]}const w=new t.Properties({range:new t.DataConstantProperty(t.spec.fog.range),color:new t.DataConstantProperty(t.spec.fog.color),"horizon-blend":new t.DataConstantProperty(t.spec.fog["horizon-blend"])}),M="-transition";class T extends t.Evented{constructor(e,i){super(),this._transitionable=new t.Transitionable(w),this.set(e),this._transitioning=this._transitionable.untransitioned(),this._transform=i}get state(){return{range:this.properties.get("range"),horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(e,i={}){if(!this._validate(t.validateFog,e,i))for(const i in e){const n=e[i];t.endsWith(i,M)?this._transitionable.setTransition(i.slice(0,-M.length),n):this._transitionable.setValue(i,n)}}getOpacity(e){if(!this._transform.projection.supportsFog)return 0;const i=this.properties&&this.properties.get("color")||1;return t.smoothstep(45,65,e)*i.a}getOpacityAtLatLng(e,i){return this._transform.projection.supportsFog?function(e,i,n){const r=t.MercatorCoordinate.fromLngLat(i),o=n.elevation?n.elevation.getAtPointOrZero(r):0,a=[r.x,r.y,o];return t.transformMat4(a,a,n.mercatorFogMatrix),x(e,a,n.pitch,n._fov)}(this.state,e,i):0}getFovAdjustedRange(t){return this._transform.projection.supportsFog?b(this.state,t):[0,1]}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(e,i,n){return(!n||!1!==n.validate)&&t.emitValidationErrors(this,e.call(t.validateStyle,t.extend({value:i,style:{glyphs:!0,sprite:!0},styleSpec:t.spec})))}}class S{constructor(e,i){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=t.uniqueId();const n=this.workerPool.acquire(this.id);for(let t=0;t<n.length;t++){const e=new S.Actor(n[t],i,this.id);e.name="Worker "+t,this.actors.push(e)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,n){t.asyncAll(this.actors,(t,n)=>{t.send(e,i,n)},n=n||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(t=>{t.remove()}),this.actors=[],this.workerPool.release(this.id)}}function E(e,i,n){return i*(t.EXTENT/(e.tileSize*Math.pow(2,n-e.tileID.overscaledZ)))}S.Actor=t.Actor;class C{constructor(t,e,i){this.context=t;const n=t.gl;this.buffer=n.createBuffer(),this.dynamicDraw=Boolean(i),this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.arrayBuffer,this.dynamicDraw?n.DYNAMIC_DRAW:n.STATIC_DRAW),this.dynamicDraw||delete e.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){const e=this.context.gl;this.context.unbindVAO(),this.bind(),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const A={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class P{constructor(t,e,i,n){this.length=e.length,this.attributes=i,this.itemSize=e.bytesPerElement,this.dynamicDraw=n,this.context=t;const r=t.gl;this.buffer=r.createBuffer(),t.bindVertexBuffer.set(this.buffer),r.bufferData(r.ARRAY_BUFFER,e.arrayBuffer,this.dynamicDraw?r.DYNAMIC_DRAW:r.STATIC_DRAW),this.dynamicDraw||delete e.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const e=this.context.gl;this.bind(),e.bufferSubData(e.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,e){for(let i=0;i<this.attributes.length;i++){const n=e.attributes[this.attributes[i].name];void 0!==n&&t.enableVertexAttribArray(n)}}setVertexAttribPointers(t,e,i){for(let n=0;n<this.attributes.length;n++){const r=this.attributes[n],o=e.attributes[r.name];void 0!==o&&t.vertexAttribPointer(o,r.components,t[A[r.type]],!1,this.itemSize,r.offset+this.itemSize*(i||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class L{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class I extends L{getDefault(){return t.Color.transparent}set(t){const e=this.current;(t.r!==e.r||t.g!==e.g||t.b!==e.b||t.a!==e.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class R extends L{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class D extends L{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class k extends L{getDefault(){return[!0,!0,!0,!0]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class O extends L{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class z extends L{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class B extends L{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const e=this.current;(t.func!==e.func||t.ref!==e.ref||t.mask!==e.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class F extends L{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class N extends L{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.current=t,this.dirty=!1}}class j extends L{getDefault(){return[0,1]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class G extends L{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.current=t,this.dirty=!1}}class U extends L{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class V extends L{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.current=t,this.dirty=!1}}class H extends L{getDefault(){const t=this.gl;return[t.ONE,t.ZERO]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||this.dirty)&&(this.gl.blendFunc(t[0],t[1]),this.current=t,this.dirty=!1)}}class Z extends L{getDefault(){return t.Color.transparent}set(t){const e=this.current;(t.r!==e.r||t.g!==e.g||t.b!==e.b||t.a!==e.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class W extends L{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquation(t),this.current=t,this.dirty=!1)}}class q extends L{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;t?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this.current=t,this.dirty=!1}}class X extends L{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Y extends L{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}class $ extends L{getDefault(){return null}set(t){(t!==this.current||this.dirty)&&(this.gl.useProgram(t),this.current=t,this.dirty=!1)}}class J extends L{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class K extends L{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Q extends L{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class tt extends L{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.bindRenderbuffer(e.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class et extends L{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.bindTexture(e.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class it extends L{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.bindBuffer(e.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class nt extends L{getDefault(){return null}set(t){const e=this.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class rt extends L{constructor(t){super(t),this.vao=t.extVertexArrayObject}getDefault(){return null}set(t){this.vao&&(t!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(t),this.current=t,this.dirty=!1)}}class ot extends L{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.pixelStorei(e.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class at extends L{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class st extends L{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class lt extends L{constructor(t,e){super(t),this.context=t,this.parent=e}getDefault(){return null}}class ct extends lt{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const e=this.gl;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class ht extends lt{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const e=this.gl;e.framebufferRenderbuffer(e.FRAMEBUFFER,this.attachment(),e.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class ut extends ht{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class dt{constructor(t,e,i,n){this.context=t,this.width=e,this.height=i;const r=this.framebuffer=t.gl.createFramebuffer();this.colorAttachment=new ct(t,r),n&&(this.depthAttachment=new ht(t,r))}destroy(){const t=this.context.gl,e=this.colorAttachment.get();if(e&&t.deleteTexture(e),this.depthAttachment){const e=this.depthAttachment.get();e&&t.deleteRenderbuffer(e)}t.deleteFramebuffer(this.framebuffer)}}class pt{constructor(t){this.gl=t,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new I(this),this.clearDepth=new R(this),this.clearStencil=new D(this),this.colorMask=new k(this),this.depthMask=new O(this),this.stencilMask=new z(this),this.stencilFunc=new B(this),this.stencilOp=new F(this),this.stencilTest=new N(this),this.depthRange=new j(this),this.depthTest=new G(this),this.depthFunc=new U(this),this.blend=new V(this),this.blendFunc=new H(this),this.blendColor=new Z(this),this.blendEquation=new W(this),this.cullFace=new q(this),this.cullFaceSide=new X(this),this.frontFace=new Y(this),this.program=new $(this),this.activeTexture=new J(this),this.viewport=new K(this),this.bindFramebuffer=new Q(this),this.bindRenderbuffer=new tt(this),this.bindTexture=new et(this),this.bindVertexBuffer=new it(this),this.bindElementBuffer=new nt(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new rt(this),this.pixelStoreUnpack=new ot(this),this.pixelStoreUnpackPremultiplyAlpha=new at(this),this.pixelStoreUnpackFlipY=new st(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extTextureHalfFloat=t.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(t.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float")),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,e){return new C(this,t,e)}createVertexBuffer(t,e,i){return new P(this,t,e,i)}createRenderbuffer(t,e,i){const n=this.gl,r=n.createRenderbuffer();return this.bindRenderbuffer.set(r),n.renderbufferStorage(n.RENDERBUFFER,t,e,i),this.bindRenderbuffer.set(null),r}createFramebuffer(t,e,i){return new dt(this,t,e,i)}clear({color:t,depth:e,stencil:i}){const n=this.gl;let r=0;t&&(r|=n.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set([!0,!0,!0,!0])),void 0!==e&&(r|=n.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(e),this.depthMask.set(!0)),void 0!==i&&(r|=n.STENCIL_BUFFER_BIT,this.clearStencil.set(i),this.stencilMask.set(255)),n.clear(r)}setCullFace(t){!1===t.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(e){o(e.blendFunction,t.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(e.blendFunction),this.blendColor.set(e.blendColor)),this.colorMask.set(e.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class ft{constructor(t,e,i,n){this.screenBounds=t,this.cameraPoint=e,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=i,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this.screenGeometry.map(t=>n.pointCoordinate3D(t)),this.cameraGeometry=this.bufferedCameraGeometry(0)}static createFromScreenPoints(e,i){let n,r;if(e instanceof t.pointGeometry||"number"==typeof e[0]){const o=t.pointGeometry.convert(e);n=[t.pointGeometry.convert(e)],r=i.isPointAboveHorizon(o)}else{const o=t.pointGeometry.convert(e[0]),a=t.pointGeometry.convert(e[1]);n=[o,a],r=t.polygonizeBounds(o,a).every(t=>i.isPointAboveHorizon(t))}return new ft(n,i.getCameraPoint(),r,i)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(e){return t.polygonizeBounds(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],e)}bufferedCameraGeometry(e){const i=this.screenBounds[0],n=1===this.screenBounds.length?this.screenBounds[0].add(new t.pointGeometry(1,1)):this.screenBounds[1],r=t.polygonizeBounds(i,n,0,!1);return this.cameraPoint.y>n.y&&(this.cameraPoint.x>i.x&&this.cameraPoint.x<n.x?r.splice(3,0,this.cameraPoint):this.cameraPoint.x>=n.x?r[2]=this.cameraPoint:this.cameraPoint.x<=i.x&&(r[3]=this.cameraPoint)),t.bufferConvexPolygon(r,e)}containsTile(e,i,n){const r=e.queryPadding+1,o=e.tileID.wrap,a=n?this._bufferedCameraMercator(r,i).map(i=>t.getTilePoint(e.tileTransform,i,o)):this._bufferedScreenMercator(r,i).map(i=>t.getTilePoint(e.tileTransform,i,o)),s=this.screenGeometryMercator.map(i=>t.getTileVec3(e.tileTransform,i,o)),l=s.map(e=>new t.pointGeometry(e[0],e[1])),c=i.getFreeCameraOptions().position||new t.MercatorCoordinate(0,0,0),h=t.getTileVec3(e.tileTransform,c,o),u=s.map(e=>{const i=t.sub(e,e,h);return t.normalize(i,i),new t.Ray(h,i)}),d=E(e,1,i.zoom);if(t.polygonIntersectsBox(a,0,0,t.EXTENT,t.EXTENT))return{queryGeometry:this,tilespaceGeometry:l,tilespaceRays:u,bufferedTilespaceGeometry:a,bufferedTilespaceBounds:(p=t.getBounds(a),p.min.x=t.clamp(p.min.x,0,t.EXTENT),p.min.y=t.clamp(p.min.y,0,t.EXTENT),p.max.x=t.clamp(p.max.x,0,t.EXTENT),p.max.y=t.clamp(p.max.y,0,t.EXTENT),p),tile:e,tileID:e.tileID,pixelToTileUnitsFactor:d};var p}_bufferedScreenMercator(t,e){const i=mt(t);if(this._screenRaycastCache[i])return this._screenRaycastCache[i];{const n=this.bufferedScreenGeometry(t).map(t=>e.pointCoordinate3D(t));return this._screenRaycastCache[i]=n,n}}_bufferedCameraMercator(t,e){const i=mt(t);if(this._cameraRaycastCache[i])return this._cameraRaycastCache[i];{const n=this.bufferedCameraGeometry(t).map(t=>e.pointCoordinate3D(t));return this._cameraRaycastCache[i]=n,n}}}function mt(t){return 100*t|0}function gt(e,i,n){const r=function(r,o){if(r)return n(r);if(o){const r=t.pick(t.extend(o,e),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);o.vector_layers&&(r.vectorLayers=o.vector_layers,r.vectorLayerIds=r.vectorLayers.map(t=>t.id)),r.tiles=i.canonicalizeTileset(r,e.url),n(null,r)}};return e.url?t.getJSON(i.transformRequest(i.normalizeSourceURL(e.url),t.ResourceType.Source),r):t.exported.frame(()=>r(null,e))}class yt{constructor(e,i,n){this.bounds=t.LngLatBounds.convert(this.validateBounds(e)),this.minzoom=i||0,this.maxzoom=n||24}validateBounds(t){return Array.isArray(t)&&4===t.length?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(e){const i=Math.pow(2,e.z),n=Math.floor(t.mercatorXfromLng(this.bounds.getWest())*i),r=Math.floor(t.mercatorYfromLat(this.bounds.getNorth())*i),o=Math.ceil(t.mercatorXfromLng(this.bounds.getEast())*i),a=Math.ceil(t.mercatorYfromLat(this.bounds.getSouth())*i);return e.x>=n&&e.x<o&&e.y>=r&&e.y<a}}class _t extends t.Evented{constructor(e,i,n,r){super(),this.id=e,this.dispatcher=n,this.setEventedParent(r),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=t.extend({type:"raster"},i),t.extend(this,t.pick(i,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new t.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=gt(this._options,this.map._requestManager,(e,i)=>{this._tileJSONRequest=null,this._loaded=!0,e?this.fire(new t.ErrorEvent(e)):i&&(t.extend(this,i),i.bounds&&(this.tileBounds=new yt(i.bounds,this.minzoom,this.maxzoom)),t.postTurnstileEvent(i.tiles),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return t.extend({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(e,i){const n=t.exported.devicePixelRatio>=2,r=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),n,this.tileSize);e.request=t.getImage(this.map._requestManager.transformRequest(r,t.ResourceType.Tile),(n,r,o,a)=>{if(delete e.request,e.aborted)e.state="unloaded",i(null);else if(n)e.state="errored",i(n);else if(r){this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:o,expires:a});const n=this.map.painter.context,s=n.gl;e.texture=this.map.painter.getTileTexture(r.width),e.texture?e.texture.update(r,{useMipmap:!0}):(e.texture=new t.Texture(n,r,s.RGBA,{useMipmap:!0}),e.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE),n.extTextureFilterAnisotropic&&s.texParameterf(s.TEXTURE_2D,n.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,n.extTextureFilterAnisotropicMax)),e.state="loaded",t.cacheEntryPossiblyAdded(this.dispatcher),i(null)}})}abortTile(t,e){t.request&&(t.request.cancel(),delete t.request),e()}unloadTile(t,e){t.texture&&this.map.painter.saveTileTexture(t.texture),e()}hasTransition(){return!1}}let vt;function xt(e,i,n,r,o,a,s,l){const c=[e,n,o,i,r,a,1,1,1],h=[s,l,1],u=t.adjoint([],c),[d,p,f]=t.transformMat3(h,h,t.transpose(u,u));return t.multiply(c,[d,0,0,0,p,0,0,0,f],c)}class bt extends t.Evented{constructor(t,e,i,n){super(),this.id=t,this.dispatcher=i,this.coordinates=e.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(n),this.options=e}load(e,i){this._loaded=!1,this.fire(new t.Event("dataloading",{dataType:"source"})),this.url=this.options.url,t.getImage(this.map._requestManager.transformRequest(this.url,t.ResourceType.Image),(n,r)=>{this._loaded=!0,n?this.fire(new t.ErrorEvent(n)):r&&(this.image=t.exported.getImageData(r),this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),i&&i(),this._finishLoading())})}loaded(){return this._loaded}updateImage(t){return this.image&&t.url?(this.options.url=t.url,this.load(t.coordinates,()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}setCoordinates(e){this.coordinates=e,delete this._boundsArray;const i=e.map(t.MercatorCoordinate.fromLngLat);return this.tileID=function(e){let i=1/0,n=1/0,r=-1/0,o=-1/0;for(const t of e)i=Math.min(i,t.x),n=Math.min(n,t.y),r=Math.max(r,t.x),o=Math.max(o,t.y);const a=Math.max(r-i,o-n),s=Math.max(0,Math.floor(-Math.log(a)/Math.LN2)),l=Math.pow(2,s);return new t.CanonicalTileID(s,Math.floor((i+r)/2*l),Math.floor((n+o)/2*l))}(i),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new t.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){delete this._boundsArray}_makeBoundsArray(){const e=t.tileTransform(this.tileID,this.map.transform.projection),[i,n,r,o]=this.coordinates.map(i=>{const n=e.projection.project(i[0],i[1]);return t.getTilePoint(e,n)._round()});return this.perspectiveTransform=function(e,i,n,r,o,a,s,l,c,h){const u=xt(0,0,e,0,0,i,e,i),d=xt(n,r,o,a,s,l,c,h);return t.multiply(d,t.adjoint(u,u),d),[d[6]/d[8]*e/t.EXTENT,d[7]/d[8]*i/t.EXTENT]}(this.width,this.height,i.x,i.y,n.x,n.y,o.x,o.y,r.x,r.y),this._boundsArray=new t.StructArrayLayout4i8,this._boundsArray.emplaceBack(i.x,i.y,0,0),this._boundsArray.emplaceBack(n.x,n.y,t.EXTENT,0),this._boundsArray.emplaceBack(o.x,o.y,0,t.EXTENT),this._boundsArray.emplaceBack(r.x,r.y,t.EXTENT,t.EXTENT),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this}prepare(){if(0===Object.keys(this.tiles).length||!this.image)return;const e=this.map.painter.context,i=e.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=e.createVertexBuffer(this._boundsArray,t.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=t.SegmentVector.simpleSegment(0,0,4,2)),this.texture||(this.texture=new t.Texture(e,this.image,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE));for(const t in this.tiles){const e=this.tiles[t];"loaded"!==e.state&&(e.state="loaded",e.texture=this.texture)}}loadTile(t,e){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},e(null)):(t.state="errored",e(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const wt={vector:class extends t.Evented{constructor(e,i,n,r){if(super(),this.id=e,this.dispatcher=n,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,t.extend(this,t.pick(i,["url","scheme","tileSize","promoteId"])),this._options=t.extend({type:"vector"},i),this._collectResourceTiming=i.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(r),this._tileWorkers={},this._deduped=new t.DedupedRequest}load(){this._loaded=!1,this.fire(new t.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=gt(this._options,this.map._requestManager,(e,i)=>{this._tileJSONRequest=null,this._loaded=!0,e?this.fire(new t.ErrorEvent(e)):i&&(t.extend(this,i),i.bounds&&(this.tileBounds=new yt(i.bounds,this.minzoom,this.maxzoom)),t.postTurnstileEvent(i.tiles,this.map._requestManager._customAccessToken),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}setSourceProperty(t){this._tileJSONRequest&&this._tileJSONRequest.cancel(),t();const e=this.map.style._getSourceCaches(this.id);for(const t of e)t.clearTiles();this.load()}setTiles(t){return this.setSourceProperty(()=>{this._options.tiles=t}),this}setUrl(t){return this.setSourceProperty(()=>{this.url=t,this._options.url=t}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return t.extend({},this._options)}loadTile(e,i){const n=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme)),r={request:this.map._requestManager.transformRequest(n,t.ResourceType.Tile),data:void 0,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:t.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:e.isSymbolTile};if(r.request.collectResourceTiming=this._collectResourceTiming,e.actor&&"expired"!==e.state)"loading"===e.state?e.reloadCallback=i:e.request=e.actor.send("reloadTile",r,o.bind(this));else if(e.actor=this._tileWorkers[n]=this._tileWorkers[n]||this.dispatcher.getActor(),this.dispatcher.ready)e.request=e.actor.send("loadTile",r,o.bind(this),void 0,!0);else{const i=t.loadVectorTile.call({deduped:this._deduped},r,(t,i)=>{t||!i?o.call(this,t):(r.data={cacheControl:i.cacheControl,expires:i.expires,rawData:i.rawData.slice(0)},e.actor&&e.actor.send("loadTile",r,o.bind(this),void 0,!0))},!0);e.request={cancel:i}}function o(n,r){return delete e.request,e.aborted?i(null):n&&404!==n.status?i(n):(r&&r.resourceTiming&&(e.resourceTiming=r.resourceTiming),this.map._refreshExpiredTiles&&r&&e.setExpiryData(r),e.loadVectorData(r,this.map.painter),t.cacheEntryPossiblyAdded(this.dispatcher),i(null),void(e.reloadCallback&&(this.loadTile(e,e.reloadCallback),e.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id})}unloadTile(t){t.unloadVectorData(),t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}},raster:_t,"raster-dem":class extends _t{constructor(e,i,n,r){super(e,i,n,r),this.type="raster-dem",this.maxzoom=22,this._options=t.extend({type:"raster-dem"},i),this.encoding=i.encoding||"mapbox"}loadTile(e,i){const n=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function r(t,n){t&&(e.state="errored",i(t)),n&&(e.dem=n,e.dem.onDeserialize(),e.needsHillshadePrepare=!0,e.needsDEMTextureUpload=!0,e.state="loaded",i(null))}e.request=t.getImage(this.map._requestManager.transformRequest(n,t.ResourceType.Tile),function(n,o,a,s){if(delete e.request,e.aborted)e.state="unloaded",i(null);else if(n)e.state="errored",i(n);else if(o){this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:a,expires:s});const i=t.window.ImageBitmap&&o instanceof t.window.ImageBitmap&&(null==vt&&(vt=t.window.OffscreenCanvas&&new t.window.OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof t.window.createImageBitmap),vt),n=1-(o.width-t.prevPowerOfTwo(o.width))/2;n<1||e.neighboringTiles||(e.neighboringTiles=this._getNeighboringTiles(e.tileID));const l=i?o:t.exported.getImageData(o,n),c={uid:e.uid,coord:e.tileID,source:this.id,rawImageData:l,encoding:this.encoding,padding:n};e.actor&&"expired"!==e.state||(e.actor=this.dispatcher.getActor(),e.actor.send("loadDEMTile",c,r.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(e){const i=e.canonical,n=Math.pow(2,i.z),r=(i.x-1+n)%n,o=0===i.x?e.wrap-1:e.wrap,a=(i.x+1+n)%n,s=i.x+1===n?e.wrap+1:e.wrap,l={};return l[new t.OverscaledTileID(e.overscaledZ,o,i.z,r,i.y).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,s,i.z,a,i.y).key]={backfilled:!1},i.y>0&&(l[new t.OverscaledTileID(e.overscaledZ,o,i.z,r,i.y-1).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,e.wrap,i.z,i.x,i.y-1).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,s,i.z,a,i.y-1).key]={backfilled:!1}),i.y+1<n&&(l[new t.OverscaledTileID(e.overscaledZ,o,i.z,r,i.y+1).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,e.wrap,i.z,i.x,i.y+1).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,s,i.z,a,i.y+1).key]={backfilled:!1}),l}unloadTile(t){t.demTexture&&this.map.painter.saveTileTexture(t.demTexture),t.fbo&&(t.fbo.destroy(),delete t.fbo),t.dem&&delete t.dem,delete t.neighboringTiles,t.state="unloaded"}},geojson:class extends t.Evented{constructor(e,i,n,r){super(),this.id=e,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(r),this._data=i.data,this._options=t.extend({},i),this._collectResourceTiming=i.collectResourceTiming,void 0!==i.maxzoom&&(this.maxzoom=i.maxzoom),i.type&&(this.type=i.type),i.attribution&&(this.attribution=i.attribution),this.promoteId=i.promoteId;const o=t.EXTENT/this.tileSize;this.workerOptions=t.extend({source:this.id,cluster:i.cluster||!1,geojsonVtOptions:{buffer:(void 0!==i.buffer?i.buffer:128)*o,tolerance:(void 0!==i.tolerance?i.tolerance:.375)*o,extent:t.EXTENT,maxZoom:this.maxzoom,lineMetrics:i.lineMetrics||!1,generateId:i.generateId||!1},superclusterOptions:{maxZoom:void 0!==i.clusterMaxZoom?i.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,i.clusterMinPoints||2),extent:t.EXTENT,radius:(void 0!==i.clusterRadius?i.clusterRadius:50)*o,log:!1,generateId:i.generateId||!1},clusterProperties:i.clusterProperties,filter:i.filter},i.workerOptions)}onAdd(t){this.map=t,this.setData(this._data)}setData(t){return this._data=t,this._updateWorkerData(),this}getClusterExpansionZoom(t,e){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:t,source:this.id},e),this}getClusterChildren(t,e){return this.actor.send("geojson.getClusterChildren",{clusterId:t,source:this.id},e),this}getClusterLeaves(t,e,i,n){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:t,limit:e,offset:i},n),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new t.Event("dataloading",{dataType:"source"})),this._loaded=!1;const e=t.extend({},this.workerOptions),i=this._data;"string"==typeof i?(e.request=this.map._requestManager.transformRequest(t.exported.resolveURL(i),t.ResourceType.Source),e.request.collectResourceTiming=this._collectResourceTiming):e.data=JSON.stringify(i),this._pendingLoad=this.actor.send(this.type+".loadData",e,(e,i)=>{if(this._loaded=!0,this._pendingLoad=null,e)this.fire(new t.ErrorEvent(e));else{const e={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&i&&i.resourceTiming&&i.resourceTiming[this.id]&&(e.resourceTiming=i.resourceTiming[this.id]),this.fire(new t.Event("data",e)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(e,i){const n=e.actor?"reloadTile":"loadTile";e.actor=this.actor,e.request=this.actor.send(n,{type:this.type,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:t.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(t,r)=>(delete e.request,e.unloadVectorData(),e.aborted?i(null):t?i(t):(e.loadVectorData(r,this.map.painter,"reloadTile"===n),i(null))),void 0,"loadTile"===n)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.aborted=!0}unloadTile(t){t.unloadVectorData(),this.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return t.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends bt{constructor(t,e,i,n){super(t,e,i,n),this.roundZoom=!0,this.type="video",this.options=e}load(){this._loaded=!1;const e=this.options;this.urls=[];for(const i of e.urls)this.urls.push(this.map._requestManager.transformRequest(i,t.ResourceType.Source).url);t.getVideo(this.urls,(e,i)=>{this._loaded=!0,e?this.fire(new t.ErrorEvent(e)):i&&(this.video=i,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(e){if(this.video){const i=this.video.seekable;e<i.start(0)||e>i.end(0)?this.fire(new t.ErrorEvent(new t.ValidationError("sources."+this.id,null,`Playback for this video can be set only between the ${i.start(0)} and ${i.end(0)}-second mark.`))):this.video.currentTime=e}}getVideo(){return this.video}onAdd(t){this.map||(this.map=t,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const e=this.map.painter.context,i=e.gl;this.texture?this.video.paused||(this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,this.video)):(this.texture=new t.Texture(e,this.video,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=e.createVertexBuffer(this._boundsArray,t.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=t.SegmentVector.simpleSegment(0,0,4,2));for(const t in this.tiles){const e=this.tiles[t];"loaded"!==e.state&&(e.state="loaded",e.texture=this.texture)}}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:bt,canvas:class extends bt{constructor(e,i,n,r){super(e,i,n,r),i.coordinates?Array.isArray(i.coordinates)&&4===i.coordinates.length&&!i.coordinates.some(t=>!Array.isArray(t)||2!==t.length||t.some(t=>"number"!=typeof t))||this.fire(new t.ErrorEvent(new t.ValidationError("sources."+e,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new t.ErrorEvent(new t.ValidationError("sources."+e,null,'missing required property "coordinates"'))),i.animate&&"boolean"!=typeof i.animate&&this.fire(new t.ErrorEvent(new t.ValidationError("sources."+e,null,'optional "animate" property must be a boolean value'))),i.canvas?"string"==typeof i.canvas||i.canvas instanceof t.window.HTMLCanvasElement||this.fire(new t.ErrorEvent(new t.ValidationError("sources."+e,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new t.ErrorEvent(new t.ValidationError("sources."+e,null,'missing required property "canvas"'))),this.options=i,this.animate=void 0===i.animate||i.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof t.window.HTMLCanvasElement?this.options.canvas:t.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new t.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(t){this.map=t,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let e=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,e=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,e=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const i=this.map.painter.context,n=i.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=i.createVertexBuffer(this._boundsArray,t.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=t.SegmentVector.simpleSegment(0,0,4,2)),this.texture?(e||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new t.Texture(i,this.canvas,n.RGBA,{premultiply:!0});for(const t in this.tiles){const e=this.tiles[t];"loaded"!==e.state&&(e.state="loaded",e.texture=this.texture)}}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const t of[this.canvas.width,this.canvas.height])if(isNaN(t)||t<=0)return!0;return!1}}},Mt=function(e,i,n,r){const o=new wt[i.type](e,i,n,r);if(o.id!==e)throw new Error(`Expected Source id to be ${e} instead of ${o.id}`);return t.bindAll(["load","abort","unload","serialize","prepare"],o),o};function Tt(e,i){const n=t.identity([]);return t.scale(n,n,[.5*e.width,.5*-e.height,1]),t.translate(n,n,[1,-1,0]),t.multiply$1(n,n,e.calculateProjMatrix(i.toUnwrapped()))}function St(t,e,i,n,r,o,a,s=!1){const l=t.tilesIn(n,a,s);l.sort(Ct);const c=[];for(const n of l)c.push({wrappedTileID:n.tile.tileID.wrapped().key,queryResults:n.tile.queryRenderedFeatures(e,i,t._state,n,r,o,Tt(t.transform,n.tile.tileID),s)});const h=function(t){const e={},i={};for(const n of t){const t=n.queryResults,r=n.wrappedTileID,o=i[r]=i[r]||{};for(const i in t){const n=t[i],r=o[i]=o[i]||{},a=e[i]=e[i]||[];for(const t of n)r[t.featureIndex]||(r[t.featureIndex]=!0,a.push(t))}}return e}(c);for(const e in h)h[e].forEach(e=>{const i=e.feature,n=t.getFeatureState(i.layer["source-layer"],i.id);i.source=i.layer.source,i.layer["source-layer"]&&(i.sourceLayer=i.layer["source-layer"]),i.state=n});return h}function Et(t,e){const i=t.getRenderableIds().map(e=>t.getTileByID(e)),n=[],r={};for(let t=0;t<i.length;t++){const o=i[t],a=o.tileID.canonical.key;r[a]||(r[a]=!0,o.querySourceFeatures(n,e))}return n}function Ct(t,e){const i=t.tileID,n=e.tileID;return i.overscaledZ-n.overscaledZ||i.canonical.y-n.canonical.y||i.wrap-n.wrap||i.canonical.x-n.canonical.x}function At(){return null!=$r.workerClass?new $r.workerClass:new t.window.Worker($r.workerUrl)}const Pt="mapboxgl_preloaded_worker_pool";class Lt{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<Lt.workerCount;)this.workers.push(new At);return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],0===this.numActive()&&(this.workers.forEach(t=>{t.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Pt]}numActive(){return Object.keys(this.active).length}}let It;function Rt(){return It||(It=new Lt),It}function Dt(e,i){const n={};for(const t in e)"ref"!==t&&(n[t]=e[t]);return t.refProperties.forEach(t=>{t in i&&(n[t]=i[t])}),n}function kt(t){t=t.slice();const e=Object.create(null);for(let i=0;i<t.length;i++)e[t[i].id]=t[i];for(let i=0;i<t.length;i++)"ref"in t[i]&&(t[i]=Dt(t[i],e[t[i].ref]));return t}Lt.workerCount=2;const Ot={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function zt(t,e,i){i.push({command:Ot.addSource,args:[t,e[t]]})}function Bt(t,e,i){e.push({command:Ot.removeSource,args:[t]}),i[t]=!0}function Ft(t,e,i,n){Bt(t,i,n),zt(t,e,i)}function Nt(t,e,i){let n;for(n in t[i])if(t[i].hasOwnProperty(n)&&"data"!==n&&!o(t[i][n],e[i][n]))return!1;for(n in e[i])if(e[i].hasOwnProperty(n)&&"data"!==n&&!o(t[i][n],e[i][n]))return!1;return!0}function jt(t,e,i,n,r,a){let s;for(s in e=e||{},t=t||{})t.hasOwnProperty(s)&&(o(t[s],e[s])||i.push({command:a,args:[n,s,e[s],r]}));for(s in e)e.hasOwnProperty(s)&&!t.hasOwnProperty(s)&&(o(t[s],e[s])||i.push({command:a,args:[n,s,e[s],r]}))}function Gt(t){return t.id}function Ut(t,e){return t[e.id]=e,t}class Vt{constructor(t,e){this.reset(t,e)}reset(t,e){this.points=t||[],this._distances=[0];for(let t=1;t<this.points.length;t++)this._distances[t]=this._distances[t-1]+this.points[t].dist(this.points[t-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(e||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(e){if(1===this.points.length)return this.points[0];e=t.clamp(e,0,1);let i=1,n=this._distances[i];const r=e*this.paddedLength+this.padding;for(;n<r&&i<this._distances.length;)n=this._distances[++i];const o=i-1,a=this._distances[o],s=n-a,l=s>0?(r-a)/s:0;return this.points[o].mult(1-l).add(this.points[i].mult(l))}}class Ht{constructor(t,e,i){const n=this.boxCells=[],r=this.circleCells=[];this.xCellCount=Math.ceil(t/i),this.yCellCount=Math.ceil(e/i);for(let t=0;t<this.xCellCount*this.yCellCount;t++)n.push([]),r.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=e,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/e,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,e,i,n,r){this._forEachCell(e,i,n,r,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(e),this.bboxes.push(i),this.bboxes.push(n),this.bboxes.push(r)}insertCircle(t,e,i,n){this._forEachCell(e-n,i-n,e+n,i+n,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(e),this.circles.push(i),this.circles.push(n)}_insertBoxCell(t,e,i,n,r,o){this.boxCells[r].push(o)}_insertCircleCell(t,e,i,n,r,o){this.circleCells[r].push(o)}_query(t,e,i,n,r,o){if(i<0||t>this.width||n<0||e>this.height)return!r&&[];const a=[];if(t<=0&&e<=0&&this.width<=i&&this.height<=n){if(r)return!0;for(let t=0;t<this.boxKeys.length;t++)a.push({key:this.boxKeys[t],x1:this.bboxes[4*t],y1:this.bboxes[4*t+1],x2:this.bboxes[4*t+2],y2:this.bboxes[4*t+3]});for(let t=0;t<this.circleKeys.length;t++){const e=this.circles[3*t],i=this.circles[3*t+1],n=this.circles[3*t+2];a.push({key:this.circleKeys[t],x1:e-n,y1:i-n,x2:e+n,y2:i+n})}return o?a.filter(o):a}return this._forEachCell(t,e,i,n,this._queryCell,a,{hitTest:r,seenUids:{box:{},circle:{}}},o),r?a.length>0:a}_queryCircle(t,e,i,n,r){const o=t-i,a=t+i,s=e-i,l=e+i;if(a<0||o>this.width||l<0||s>this.height)return!n&&[];const c=[];return this._forEachCell(o,s,a,l,this._queryCellCircle,c,{hitTest:n,circle:{x:t,y:e,radius:i},seenUids:{box:{},circle:{}}},r),n?c.length>0:c}query(t,e,i,n,r){return this._query(t,e,i,n,!1,r)}hitTest(t,e,i,n,r){return this._query(t,e,i,n,!0,r)}hitTestCircle(t,e,i,n){return this._queryCircle(t,e,i,!0,n)}_queryCell(t,e,i,n,r,o,a,s){const l=a.seenUids,c=this.boxCells[r];if(null!==c){const r=this.bboxes;for(const h of c)if(!l.box[h]){l.box[h]=!0;const c=4*h;if(t<=r[c+2]&&e<=r[c+3]&&i>=r[c+0]&&n>=r[c+1]&&(!s||s(this.boxKeys[h]))){if(a.hitTest)return o.push(!0),!0;o.push({key:this.boxKeys[h],x1:r[c],y1:r[c+1],x2:r[c+2],y2:r[c+3]})}}}const h=this.circleCells[r];if(null!==h){const r=this.circles;for(const c of h)if(!l.circle[c]){l.circle[c]=!0;const h=3*c;if(this._circleAndRectCollide(r[h],r[h+1],r[h+2],t,e,i,n)&&(!s||s(this.circleKeys[c]))){if(a.hitTest)return o.push(!0),!0;{const t=r[h],e=r[h+1],i=r[h+2];o.push({key:this.circleKeys[c],x1:t-i,y1:e-i,x2:t+i,y2:e+i})}}}}}_queryCellCircle(t,e,i,n,r,o,a,s){const l=a.circle,c=a.seenUids,h=this.boxCells[r];if(null!==h){const t=this.bboxes;for(const e of h)if(!c.box[e]){c.box[e]=!0;const i=4*e;if(this._circleAndRectCollide(l.x,l.y,l.radius,t[i+0],t[i+1],t[i+2],t[i+3])&&(!s||s(this.boxKeys[e])))return o.push(!0),!0}}const u=this.circleCells[r];if(null!==u){const t=this.circles;for(const e of u)if(!c.circle[e]){c.circle[e]=!0;const i=3*e;if(this._circlesCollide(t[i],t[i+1],t[i+2],l.x,l.y,l.radius)&&(!s||s(this.circleKeys[e])))return o.push(!0),!0}}}_forEachCell(t,e,i,n,r,o,a,s){const l=this._convertToXCellCoord(t),c=this._convertToYCellCoord(e),h=this._convertToXCellCoord(i),u=this._convertToYCellCoord(n);for(let d=l;d<=h;d++)for(let l=c;l<=u;l++)if(r.call(this,t,e,i,n,this.xCellCount*l+d,o,a,s))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,e,i,n,r,o){const a=n-t,s=r-e,l=i+o;return l*l>a*a+s*s}_circleAndRectCollide(t,e,i,n,r,o,a){const s=(o-n)/2,l=Math.abs(t-(n+s));if(l>s+i)return!1;const c=(a-r)/2,h=Math.abs(e-(r+c));if(h>c+i)return!1;if(l<=s||h<=c)return!0;const u=l-s,d=h-c;return u*u+d*d<=i*i}}const Zt=Math.tan(85*Math.PI/180);function Wt(e,i,n,o,a,s){let l=t.create();if(n){if("globe"===a.projection.name)l=t.calculateGlobeMatrix(a,a.worldSize/a._projectionScaler,[0,0]),t.multiply$1(l,l,t.globeDenormalizeECEF(t.globeTileBounds(i)));else{const t=r([],s);l[0]=t[0],l[1]=t[1],l[4]=t[2],l[5]=t[3]}o||t.rotateZ(l,l,a.angle)}else t.multiply$1(l,a.labelPlaneMatrix,e);return l}function qt(e,i,n,r,o,a){if(n){if("globe"===o.projection.name){const s=Wt(e,i,n,r,o,a);return t.invert(s,s),t.multiply$1(s,e,s),s}{const i=t.clone(e),n=t.identity([]);return n[0]=a[0],n[1]=a[1],n[4]=a[2],n[5]=a[3],t.multiply$1(i,i,n),r||t.rotateZ(i,i,-o.angle),i}}return o.glCoordMatrix}function Xt(e,i,n=0){const r=[e.x,e.y,n,1];n?t.transformMat4$1(r,r,i):ae(r,r,i);const o=r[3];return{point:new t.pointGeometry(r[0]/o,r[1]/o),signedDistanceFromCamera:o}}function Yt(t,e){return Math.min(.5+t/e*.5,1.5)}function $t(t,e){const i=t[0]/t[3],n=t[1]/t[3];return i>=-e[0]&&i<=e[0]&&n>=-e[1]&&n<=e[1]}function Jt(e,i,n,r,o,a,s,l,c,h){const u=n.transform,d=r?e.textSizeData:e.iconSizeData,p=t.evaluateSizeForZoom(d,n.transform.zoom),f=[256/n.width*2+1,256/n.height*2+1],m=r?e.text.dynamicLayoutVertexArray:e.icon.dynamicLayoutVertexArray;m.clear();const g=e.lineVertexArray,y=r?e.text.placedSymbolArray:e.icon.placedSymbolArray,_=n.transform.width/n.transform.height;let v=!1;for(let r=0;r<y.length;r++){const x=y.get(r);if(x.writingMode!==t.WritingMode.vertical||v||0!==r&&y.get(r-1).writingMode===t.WritingMode.horizontal||(v=!0),x.hidden||x.writingMode===t.WritingMode.vertical&&!v){oe(x.numGlyphs,m);continue}v=!1;const b=new t.pointGeometry(x.tileAnchorX,x.tileAnchorY),w=c?c(b):[0,0,0],M=u.projection.projectTilePoint(b.x,b.y,h.canonical),T=[M.x+w[0],M.y+w[1],M.z+w[2]],S=[...T,1];if(t.transformMat4$1(S,S,i),!$t(S,f)){oe(x.numGlyphs,m);continue}const E=Yt(n.transform.cameraToCenterDistance,S[3]),C=t.evaluateSizeForFeature(d,p,x),A=s?C/E:C*E,P=Xt(new t.pointGeometry(T[0],T[1]),o,T[2]);if(P.signedDistanceFromCamera<=0){oe(x.numGlyphs,m);continue}let L={};const I=s?null:c,R=te(x,A,!1,l,i,o,a,e.glyphOffsetArray,g,m,P.point,b,L,_,I,u.projection,h);v=R.useVertical,I&&R.needsFlipping&&(L={}),(R.notEnoughRoom||v||R.needsFlipping&&te(x,A,!0,l,i,o,a,e.glyphOffsetArray,g,m,P.point,b,L,_,I,u.projection,h).notEnoughRoom)&&oe(x.numGlyphs,m)}r?e.text.dynamicLayoutVertexBuffer.updateData(m):e.icon.dynamicLayoutVertexBuffer.updateData(m)}function Kt(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f){const m=s.glyphStartIndex+s.numGlyphs,g=s.lineStartIndex,y=s.lineStartIndex+s.lineLength,_=e.getoffsetX(s.glyphStartIndex),v=e.getoffsetX(m-1),x=ne(t*_,i,n,r,o,a,s.segment,g,y,l,c,h,u,d,!0,p,f);if(!x)return null;const b=ne(t*v,i,n,r,o,a,s.segment,g,y,l,c,h,u,d,!0,p,f);return b?{first:x,last:b}:null}function Qt(e,i,n,r){return e.writingMode===t.WritingMode.horizontal&&Math.abs(n.y-i.y)>Math.abs(n.x-i.x)*r?{useVertical:!0}:e.writingMode===t.WritingMode.vertical?i.y<n.y?{needsFlipping:!0}:null:0!==e.flipState&&function(t,e,i){const n=(e.x-t.x)*i;return 0===n||Math.abs((e.y-t.y)/n)>Zt}(i,n,r)?1===e.flipState?{needsFlipping:!0}:null:i.x>n.x?{needsFlipping:!0}:null}function te(e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y){const _=i/24,v=e.lineOffsetX*_,x=e.lineOffsetY*_;let b;if(e.numGlyphs>1){const t=e.glyphStartIndex+e.numGlyphs,i=e.lineStartIndex,o=e.lineStartIndex+e.lineLength,h=Kt(_,l,v,x,n,u,d,e,c,a,p,m,!1,g,y);if(!h)return{notEnoughRoom:!0};const w=Xt(h.first.point,s).point,M=Xt(h.last.point,s).point;if(r&&!n){const t=Qt(e,w,M,f);if(e.flipState=t&&t.needsFlipping?1:2,t)return t}b=[h.first];for(let r=e.glyphStartIndex+1;r<t-1;r++)b.push(ne(_*l.getoffsetX(r),v,x,n,u,d,e.segment,i,o,c,a,p,m,!1,!1,g,y));b.push(h.last)}else{if(r&&!n){const i=Xt(d,o).point,n=e.lineStartIndex+e.segment+1,r=new t.pointGeometry(c.getx(n),c.gety(n)),a=Xt(r,o),s=Qt(e,i,a.signedDistanceFromCamera>0?a.point:ie(d,r,i,1,o,void 0,g,y.canonical),f);if(e.flipState=s&&s.needsFlipping?1:2,s)return s}const i=ne(_*l.getoffsetX(e.glyphStartIndex),v,x,n,u,d,e.segment,e.lineStartIndex,e.lineStartIndex+e.lineLength,c,a,p,m,!1,!1,g,y);if(!i)return{notEnoughRoom:!0};b=[i]}for(const e of b)t.addDynamicAttributes(h,e.point,e.angle);return{}}function ee(e,i,n,r,o){const a=r.projectTilePoint(e.x,e.y,i);if(!o)return Xt(a,n,a.z);const s=o(e);return Xt(new t.pointGeometry(a.x+s[0],a.y+s[1]),n,a.z+s[2])}function ie(t,e,i,n,r,o,a,s){const l=ee(t.add(t.sub(e)._unit()),s,r,a,o).point,c=i.sub(l);return i.add(c._mult(n/c.mag()))}function ne(e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y){const _=r?e-i:e+i;let v=_>0?1:-1,x=0;r&&(v*=-1,x=Math.PI),v<0&&(x+=Math.PI);let b=v>0?l+s:l+s+1,w=o,M=o,T=0,S=0;const E=Math.abs(_),C=[],A=[];let P=a;const L=()=>{const e=b-v;return 0===T?a:new t.pointGeometry(h.getx(e),h.gety(e))},I=()=>ie(L(),P,M,E-T+1,u,p,g,y.canonical);for(;T+S<=E;){if(b+=v,b<l||b>=c)return null;if(M=w,C.push(w),f&&A.push(P||L()),w=d[b],void 0===w){P=new t.pointGeometry(h.getx(b),h.gety(b));const e=ee(P,y.canonical,u,g,p);w=e.signedDistanceFromCamera>0?d[b]=e.point:I()}else P=null;T+=S,S=M.dist(w)}m&&p&&(P=P||new t.pointGeometry(h.getx(b),h.gety(b)),d[b]=w=void 0===d[b]?w:I(),S=M.dist(w));const R=(E-T)/S,D=w.sub(M),k=D.mult(R)._add(M);n&&k._add(D._unit()._perp()._mult(n*v));const O=x+Math.atan2(w.y-M.y,w.x-M.x);return C.push(k),f&&(P=P||new t.pointGeometry(h.getx(b),h.gety(b)),A.push(function(e,i,n){const r=1-n;return new t.pointGeometry(e.x*r+i.x*n,e.y*r+i.y*n)}(A.length>0?A[A.length-1]:P,P,R))),{point:k,angle:O,path:C,tilePath:A}}const re=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function oe(t,e){for(let i=0;i<t;i++){const t=e.length;e.resize(t+4),e.float32.set(re,3*t)}}function ae(t,e,i){const n=e[0],r=e[1];return t[0]=i[0]*n+i[4]*r+i[12],t[1]=i[1]*n+i[5]*r+i[13],t[3]=i[3]*n+i[7]*r+i[15],t}const se=100;class le{constructor(t,e,i=new Ht(t.width+200,t.height+200,25),n=new Ht(t.width+200,t.height+200,25)){this.transform=t,this.grid=i,this.ignoredGrid=n,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+se,this.screenBottomBoundary=t.height+se,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=e}placeCollisionBox(t,e,i,n,r,o,a){let s=e.projectedAnchorX,l=e.projectedAnchorY,c=e.projectedAnchorZ;const h=e.elevation,u=e.tileID;if(h&&u){const t=this.transform.projection.createTileTransform(this.transform,this.transform.worldSize),i=t.upVector(u.canonical,e.tileAnchorX,e.tileAnchorY),n=t.upVectorScale(u.canonical);s+=i[0]*h*n,l+=i[1]*h*n,c+=i[2]*h*n}const d=this.projectAndGetPerspectiveRatio(o,s,l,c,e.tileID),p=r*d.perspectiveRatio,f=(e.x1*t+i.x-e.padding)*p+d.point.x,m=(e.y1*t+i.y-e.padding)*p+d.point.y,g=(e.x2*t+i.x+e.padding)*p+d.point.x,y=(e.y2*t+i.y+e.padding)*p+d.point.y,_=d.perspectiveRatio<=.55||d.aboveHorizon;return!this.isInsideGrid(f,m,g,y)||!n&&this.grid.hitTest(f,m,g,y,a)||_?{box:[],offscreen:!1}:{box:[f,m,g,y],offscreen:this.isOffscreen(f,m,g,y)}}placeCollisionCircles(e,i,n,r,o,a,s,l,c,h,u,d,p,f){const m=[],g=this.transform.elevation,y=this.transform.projection.createTileTransform(this.transform,this.transform.worldSize),_=g?g.getAtTileOffsetFunc(f,y):t=>[0,0,0],v=new t.pointGeometry(i.tileAnchorX,i.tileAnchorY),x=this.transform.projection.projectTilePoint(i.tileAnchorX,i.tileAnchorY,f.canonical),b=_(v),w=[x.x+b[0],x.y+b[1],x.z+b[2]],M=this.projectAndGetPerspectiveRatio(a,w[0],w[1],w[2],f),{perspectiveRatio:T}=M,S=(h?o/T:o*T)/t.ONE_EM,E=Xt(new t.pointGeometry(w[0],w[1]),s,w[2]).point,C=M.signedDistanceFromCamera>0?Kt(S,r,i.lineOffsetX*S,i.lineOffsetY*S,!1,E,v,i,n,s,{},g&&!h?_:null,h&&!!g,this.transform.projection,f):null;let A=!1,P=!1,L=!0;if(C&&!M.aboveHorizon){const i=.5*d*T+p,n=new t.pointGeometry(-100,-100),r=new t.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),o=new Vt,a=C.first,s=C.last;let h=[];for(let t=a.path.length-1;t>=1;t--)h.push(a.path[t]);for(let t=1;t<s.path.length;t++)h.push(s.path[t]);const f=2.5*i;if(l){const t=h.map(g?(t,e)=>{const i=_(e<a.path.length-1?a.tilePath[a.path.length-1-e]:s.tilePath[e-a.path.length+2]);return Xt(t,l,i[2])}:t=>Xt(t,l));h=t.some(t=>t.signedDistanceFromCamera<=0)?[]:t.map(t=>t.point)}let y=[];if(h.length>0){const e=h[0].clone(),i=h[0].clone();for(let t=1;t<h.length;t++)e.x=Math.min(e.x,h[t].x),e.y=Math.min(e.y,h[t].y),i.x=Math.max(i.x,h[t].x),i.y=Math.max(i.y,h[t].y);y=e.x>=n.x&&i.x<=r.x&&e.y>=n.y&&i.y<=r.y?[h]:i.x<n.x||e.x>r.x||i.y<n.y||e.y>r.y?[]:t.clipLine([h],n.x,n.y,r.x,r.y)}for(const t of y){o.reset(t,.25*i);let n=0;n=o.length<=.5*i?1:Math.ceil(o.paddedLength/f)+1;for(let t=0;t<n;t++){const r=t/Math.max(n-1,1),a=o.lerp(r),s=a.x+se,l=a.y+se;m.push(s,l,i,0);const h=s-i,d=l-i,p=s+i,f=l+i;if(L=L&&this.isOffscreen(h,d,p,f),P=P||this.isInsideGrid(h,d,p,f),!e&&this.grid.hitTestCircle(s,l,i,u)&&(A=!0,!c))return{circles:[],offscreen:!1,collisionDetected:A}}}}return{circles:!c&&A||!P?[]:m,offscreen:L,collisionDetected:A}}queryRenderedSymbols(e){if(0===e.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const i=[];let n=1/0,r=1/0,o=-1/0,a=-1/0;for(const s of e){const e=new t.pointGeometry(s.x+se,s.y+se);n=Math.min(n,e.x),r=Math.min(r,e.y),o=Math.max(o,e.x),a=Math.max(a,e.y),i.push(e)}const s=this.grid.query(n,r,o,a).concat(this.ignoredGrid.query(n,r,o,a)),l={},c={};for(const e of s){const n=e.key;if(void 0===l[n.bucketInstanceId]&&(l[n.bucketInstanceId]={}),l[n.bucketInstanceId][n.featureIndex])continue;const r=[new t.pointGeometry(e.x1,e.y1),new t.pointGeometry(e.x2,e.y1),new t.pointGeometry(e.x2,e.y2),new t.pointGeometry(e.x1,e.y2)];t.polygonIntersectsPolygon(i,r)&&(l[n.bucketInstanceId][n.featureIndex]=!0,void 0===c[n.bucketInstanceId]&&(c[n.bucketInstanceId]=[]),c[n.bucketInstanceId].push(n.featureIndex))}return c}insertCollisionBox(t,e,i,n,r){(e?this.ignoredGrid:this.grid).insert({bucketInstanceId:i,featureIndex:n,collisionGroupID:r},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,e,i,n,r){const o=e?this.ignoredGrid:this.grid,a={bucketInstanceId:i,featureIndex:n,collisionGroupID:r};for(let e=0;e<t.length;e+=4)o.insertCircle(a,t[e],t[e+1],t[e+2])}projectAndGetPerspectiveRatio(e,i,n,r,o){const a=[i,n,r||0,1];let s=!1;if(r||this.transform.pitch>0){t.transformMat4$1(a,a,e);let l=!1;this.fogState&&o&&(l=function(e,i,n,r,o,a){const s=a.calculateFogTileMatrix(o),l=[i,n,r];return t.transformMat4(l,l,s),x(e,l,a.pitch,a._fov)}(this.fogState,i,n,r||0,o.toUnwrapped(),this.transform)>.9),s=a[2]>a[3]||l}else ae(a,a,e);return{point:new t.pointGeometry((a[0]/a[3]+1)/2*this.transform.width+se,(-a[1]/a[3]+1)/2*this.transform.height+se),perspectiveRatio:Math.min(.5+this.transform.cameraToCenterDistance/a[3]*.5,1.5),signedDistanceFromCamera:a[3],aboveHorizon:s}}isOffscreen(t,e,i,n){return i<se||t>=this.screenRightBoundary||n<se||e>this.screenBottomBoundary}isInsideGrid(t,e,i,n){return i>=0&&t<this.gridRightBoundary&&n>=0&&e<this.gridBottomBoundary}getViewportMatrix(){const e=t.identity([]);return t.translate(e,e,[-100,-100,0]),e}}class ce{constructor(t,e,i,n){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?e:-e))):n&&i?1:0,this.placed=i}isHidden(){return 0===this.opacity&&!this.placed}}class he{constructor(t,e,i,n,r,o=!1){this.text=new ce(t?t.text:null,e,i,r),this.icon=new ce(t?t.icon:null,e,n,r),this.clipped=o}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class ue{constructor(t,e,i,n=!1){this.text=t,this.icon=e,this.skipFade=i,this.clipped=n}}class de{constructor(){this.invProjMatrix=t.create(),this.viewportMatrix=t.create(),this.circles=[]}}class pe{constructor(t,e,i,n,r){this.bucketInstanceId=t,this.featureIndex=e,this.sourceLayerIndex=i,this.bucketIndex=n,this.tileID=r}}class fe{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const e=++this.maxGroupID;this.collisionGroups[t]={ID:e,predicate:t=>t.collisionGroupID===e}}return this.collisionGroups[t]}}function me(e,i,n,r,o){const{horizontalAlign:a,verticalAlign:s}=t.getAnchorAlignment(e),l=-(a-.5)*i,c=-(s-.5)*n,h=t.evaluateVariableOffset(e,r);return new t.pointGeometry(l+h[0]*o,c+h[1]*o)}function ge(e,i,n,r,o){const a=new t.pointGeometry(e,i);return n&&a._rotate(r?o:-o),a}class ye{constructor(t,e,i,n,r){this.transform=t.clone(),this.collisionIndex=new le(this.transform,r),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=e,this.retainedQueryData={},this.collisionGroups=new fe(i),this.collisionCircleArrays={},this.prevPlacement=n,n&&(n.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(e,i,n,r){const o=n.getBucket(i),a=n.latestFeatureIndex;if(!o||!a||i.id!==o.layerIds[0])return;const s=o.layers[0].layout,l=n.collisionBoxArray,c=Math.pow(2,this.transform.zoom-n.tileID.overscaledZ),h=n.tileSize/t.EXTENT,u=n.tileID.toUnwrapped(),d=this.transform.calculateProjMatrix(u),p="map"===s.get("text-pitch-alignment"),f="map"===s.get("text-rotation-alignment");i.compileFilter();const m=i.dynamicFilter(),g=i.dynamicFilterNeedsFeature(),y=this.transform.calculatePixelsToTileUnitsMatrix(n),_=Wt(d,n.tileID.canonical,p,f,this.transform,y);let v=null;if(p){const e=qt(d,n.tileID.canonical,p,f,this.transform,y);v=t.multiply$1([],this.transform.labelPlaneMatrix,e)}let x=null;m&&n.latestFeatureIndex&&(x={unwrappedTileID:u,dynamicFilter:m,dynamicFilterNeedsFeature:g,featureIndex:n.latestFeatureIndex}),this.retainedQueryData[o.bucketInstanceId]=new pe(o.bucketInstanceId,a,o.sourceLayerIndex,o.index,n.tileID);const b={bucket:o,layout:s,posMatrix:d,textLabelPlaneMatrix:_,labelToScreenMatrix:v,clippingData:x,scale:c,textPixelRatio:h,holdingForFade:n.holdingForFade(),collisionBoxArray:l,partiallyEvaluatedTextSize:t.evaluateSizeForZoom(o.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:t.evaluateSizeForZoom(o.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(o.sourceID)};if(r)for(const t of o.sortKeyRanges){const{sortKey:i,symbolInstanceStart:n,symbolInstanceEnd:r}=t;e.push({sortKey:i,symbolInstanceStart:n,symbolInstanceEnd:r,parameters:b})}else e.push({symbolInstanceStart:0,symbolInstanceEnd:o.symbolInstances.length,parameters:b})}attemptAnchorPlacement(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m,g,y){const _=[u.textOffset0,u.textOffset1],v=me(t,i,n,_,r),x=this.collisionIndex.placeCollisionBox(r,e,ge(v.x,v.y,o,a,this.transform.angle),h,s,l,c.predicate);if((!m||0!==this.collisionIndex.placeCollisionBox(p.getSymbolInstanceIconSize(y,this.transform.zoom,d),m,ge(v.x,v.y,o,a,this.transform.angle),h,s,l,c.predicate).box.length)&&x.box.length>0){let e;return this.prevPlacement&&this.prevPlacement.variableOffsets[u.crossTileID]&&this.prevPlacement.placements[u.crossTileID]&&this.prevPlacement.placements[u.crossTileID].text&&(e=this.prevPlacement.variableOffsets[u.crossTileID].anchor),this.variableOffsets[u.crossTileID]={textOffset:_,width:i,height:n,anchor:t,textScale:r,prevAnchor:e},this.markUsedJustification(p,t,u,f),p.allowVerticalPlacement&&(this.markUsedOrientation(p,f,u),this.placedOrientations[u.crossTileID]=f),{shift:v,placedGlyphBoxes:x}}}placeLayerBucketPart(e,i,n,r){const{bucket:o,layout:a,posMatrix:s,textLabelPlaneMatrix:l,labelToScreenMatrix:c,clippingData:h,textPixelRatio:u,holdingForFade:d,collisionBoxArray:p,partiallyEvaluatedTextSize:f,partiallyEvaluatedIconSize:m,collisionGroup:g}=e.parameters,y=a.get("text-optional"),_=a.get("icon-optional"),v=a.get("text-allow-overlap"),x=a.get("icon-allow-overlap"),b="map"===a.get("text-rotation-alignment"),w="map"===a.get("text-pitch-alignment"),M="none"!==a.get("icon-text-fit"),T="viewport-y"===a.get("symbol-z-order"),S=v&&(x||!o.hasIconData()||_),E=x&&(v||!o.hasTextData()||y);!o.collisionArrays&&p&&o.deserializeCollisionBoxes(p),n&&r&&o.updateCollisionDebugBuffers(this.transform.zoom,p);const C=(e,r,p)=>{if(h){const n={zoom:this.transform.zoom,pitch:this.transform.pitch};let r=null;if(h.dynamicFilterNeedsFeature){const t=this.retainedQueryData[o.bucketInstanceId];r=h.featureIndex.loadFeature({featureIndex:e.featureIndex,bucketIndex:t.bucketIndex,sourceLayerIndex:t.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,h.dynamicFilter)(n,r,this.retainedQueryData[o.bucketInstanceId].tileID.canonical,new t.pointGeometry(e.tileAnchorX,e.tileAnchorY),this.transform.calculateDistanceTileData(h.unwrappedTileID)))return this.placements[e.crossTileID]=new ue(!1,!1,!1,!0),void(i[e.crossTileID]=!0)}if(i[e.crossTileID])return;if(d)return void(this.placements[e.crossTileID]=new ue(!1,!1,!1));let T=!1,C=!1,A=!0,P=null,L={box:null,offscreen:null},I={box:null,offscreen:null},R=null,D=null,k=null,O=0,z=0,B=0;p.textFeatureIndex?O=p.textFeatureIndex:e.useRuntimeCollisionCircles&&(O=e.featureIndex),p.verticalTextFeatureIndex&&(z=p.verticalTextFeatureIndex);const F=t=>{t.tileID=this.retainedQueryData[o.bucketInstanceId].tileID,(this.transform.elevation||t.elevation)&&(t.elevation=this.transform.elevation?this.transform.elevation.getAtTileOffset(this.retainedQueryData[o.bucketInstanceId].tileID,t.tileAnchorX,t.tileAnchorY):0)},N=p.textBox;if(N){F(N);const i=i=>{let n=t.WritingMode.horizontal;if(o.allowVerticalPlacement&&!i&&this.prevPlacement){const t=this.prevPlacement.placedOrientations[e.crossTileID];t&&(this.placedOrientations[e.crossTileID]=t,n=t,this.markUsedOrientation(o,n,e))}return n},n=(i,n)=>{if(o.allowVerticalPlacement&&e.numVerticalGlyphVertices>0&&p.verticalTextBox){for(const e of o.writingModes)if(e===t.WritingMode.vertical?(L=n(),I=L):L=i(),L&&L.box&&L.box.length)break}else L=i()};if(a.get("text-variable-anchor")){let l=a.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[e.crossTileID]){const t=this.prevPlacement.variableOffsets[e.crossTileID];l.indexOf(t.anchor)>0&&(l=l.filter(e=>e!==t.anchor),l.unshift(t.anchor))}const c=(t,i,n)=>{const a=o.getSymbolInstanceTextSize(f,e,this.transform.zoom,r),c=(t.x2-t.x1)*a+2*t.padding,h=(t.y2-t.y1)*a+2*t.padding,d=M&&!x?i:null;d&&F(d);let p={box:[],offscreen:!1};const y=v?2*l.length:l.length;for(let i=0;i<y;++i){const y=this.attemptAnchorPlacement(l[i%l.length],t,c,h,a,b,w,u,s,g,i>=l.length,e,r,o,n,d,f,m);if(y&&(p=y.placedGlyphBoxes,p&&p.box&&p.box.length)){T=!0,P=y.shift;break}}return p};n(()=>c(N,p.iconBox,t.WritingMode.horizontal),()=>{const i=p.verticalTextBox;return i&&F(i),o.allowVerticalPlacement&&!(L&&L.box&&L.box.length)&&e.numVerticalGlyphVertices>0&&i?c(i,p.verticalIconBox,t.WritingMode.vertical):{box:null,offscreen:null}}),L&&(T=L.box,A=L.offscreen);const h=i(L&&L.box);if(!T&&this.prevPlacement){const t=this.prevPlacement.variableOffsets[e.crossTileID];t&&(this.variableOffsets[e.crossTileID]=t,this.markUsedJustification(o,t.anchor,e,h))}}else{const a=(i,n)=>{const a=o.getSymbolInstanceTextSize(f,e,this.transform.zoom,r),l=this.collisionIndex.placeCollisionBox(a,i,new t.pointGeometry(0,0),v,u,s,g.predicate);return l&&l.box&&l.box.length&&(this.markUsedOrientation(o,n,e),this.placedOrientations[e.crossTileID]=n),l};n(()=>a(N,t.WritingMode.horizontal),()=>{const i=p.verticalTextBox;return o.allowVerticalPlacement&&e.numVerticalGlyphVertices>0&&i?(F(i),a(i,t.WritingMode.vertical)):{box:null,offscreen:null}}),i(L&&L.box&&L.box.length)}}if(R=L,T=R&&R.box&&R.box.length>0,A=R&&R.offscreen,e.useRuntimeCollisionCircles){const i=o.text.placedSymbolArray.get(e.centerJustifiedTextSymbolIndex>=0?e.centerJustifiedTextSymbolIndex:e.verticalPlacedTextSymbolIndex),r=t.evaluateSizeForFeature(o.textSizeData,f,i),h=a.get("text-padding");D=this.collisionIndex.placeCollisionCircles(v,i,o.lineVertexArray,o.glyphOffsetArray,r,s,l,c,n,w,g.predicate,e.collisionCircleDiameter*r/t.ONE_EM,h,this.retainedQueryData[o.bucketInstanceId].tileID),T=v||D.circles.length>0&&!D.collisionDetected,A=A&&D.offscreen}if(p.iconFeatureIndex&&(B=p.iconFeatureIndex),p.iconBox){const e=e=>{F(e);const i=M&&P?ge(P.x,P.y,b,w,this.transform.angle):new t.pointGeometry(0,0),n=o.getSymbolInstanceIconSize(m,this.transform.zoom,r);return this.collisionIndex.placeCollisionBox(n,e,i,x,u,s,g.predicate)};I&&I.box&&I.box.length&&p.verticalIconBox?(k=e(p.verticalIconBox),C=k.box.length>0):(k=e(p.iconBox),C=k.box.length>0),A=A&&k.offscreen}const j=y||0===e.numHorizontalGlyphVertices&&0===e.numVerticalGlyphVertices,G=_||0===e.numIconVertices;if(j||G?G?j||(C=C&&T):T=C&&T:C=T=C&&T,T&&R&&R.box&&this.collisionIndex.insertCollisionBox(R.box,a.get("text-ignore-placement"),o.bucketInstanceId,I&&I.box&&z?z:O,g.ID),C&&k&&this.collisionIndex.insertCollisionBox(k.box,a.get("icon-ignore-placement"),o.bucketInstanceId,B,g.ID),D&&(T&&this.collisionIndex.insertCollisionCircles(D.circles,a.get("text-ignore-placement"),o.bucketInstanceId,O,g.ID),n)){const t=o.bucketInstanceId;let e=this.collisionCircleArrays[t];void 0===e&&(e=this.collisionCircleArrays[t]=new de);for(let t=0;t<D.circles.length;t+=4)e.circles.push(D.circles[t+0]),e.circles.push(D.circles[t+1]),e.circles.push(D.circles[t+2]),e.circles.push(D.collisionDetected?1:0)}this.placements[e.crossTileID]=new ue(T||S,C||E,A||o.justReloaded),i[e.crossTileID]=!0};if(T){const t=o.getSortedSymbolIndexes(this.transform.angle);for(let e=t.length-1;e>=0;--e){const i=t[e];C(o.symbolInstances.get(i),i,o.collisionArrays[i])}}else for(let t=e.symbolInstanceStart;t<e.symbolInstanceEnd;t++)C(o.symbolInstances.get(t),t,o.collisionArrays[t]);if(n&&o.bucketInstanceId in this.collisionCircleArrays){const e=this.collisionCircleArrays[o.bucketInstanceId];t.invert(e.invProjMatrix,s),e.viewportMatrix=this.collisionIndex.getViewportMatrix()}o.justReloaded=!1}markUsedJustification(e,i,n,r){let o;o=r===t.WritingMode.vertical?n.verticalPlacedTextSymbolIndex:{left:n.leftJustifiedTextSymbolIndex,center:n.centerJustifiedTextSymbolIndex,right:n.rightJustifiedTextSymbolIndex}[t.getAnchorJustification(i)];const a=[n.leftJustifiedTextSymbolIndex,n.centerJustifiedTextSymbolIndex,n.rightJustifiedTextSymbolIndex,n.verticalPlacedTextSymbolIndex];for(const t of a)t>=0&&(e.text.placedSymbolArray.get(t).crossTileID=o>=0&&t!==o?0:n.crossTileID)}markUsedOrientation(e,i,n){const r=i===t.WritingMode.horizontal||i===t.WritingMode.horizontalOnly?i:0,o=i===t.WritingMode.vertical?i:0,a=[n.leftJustifiedTextSymbolIndex,n.centerJustifiedTextSymbolIndex,n.rightJustifiedTextSymbolIndex];for(const t of a)e.text.placedSymbolArray.get(t).placedOrientation=r;n.verticalPlacedTextSymbolIndex&&(e.text.placedSymbolArray.get(n.verticalPlacedTextSymbolIndex).placedOrientation=o)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const e=this.prevPlacement;let i=!1;this.prevZoomAdjustment=e?e.zoomAdjustment(this.transform.zoom):0;const n=e?e.symbolFadeChange(t):1,r=e?e.opacities:{},o=e?e.variableOffsets:{},a=e?e.placedOrientations:{};for(const t in this.placements){const e=this.placements[t],o=r[t];o?(this.opacities[t]=new he(o,n,e.text,e.icon,null,e.clipped),i=i||e.text!==o.text.placed||e.icon!==o.icon.placed):(this.opacities[t]=new he(null,n,e.text,e.icon,e.skipFade,e.clipped),i=i||e.text||e.icon)}for(const t in r){const e=r[t];if(!this.opacities[t]){const r=new he(e,n,!1,!1);r.isHidden()||(this.opacities[t]=r,i=i||e.text.placed||e.icon.placed)}}for(const t in o)this.variableOffsets[t]||!this.opacities[t]||this.opacities[t].isHidden()||(this.variableOffsets[t]=o[t]);for(const t in a)this.placedOrientations[t]||!this.opacities[t]||this.opacities[t].isHidden()||(this.placedOrientations[t]=a[t]);i?this.lastPlacementChangeTime=t:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=e?e.lastPlacementChangeTime:t)}updateLayerOpacities(t,e){const i={};for(const n of e){const e=n.getBucket(t);e&&n.latestFeatureIndex&&t.id===e.layerIds[0]&&this.updateBucketOpacities(e,i,n.collisionBoxArray)}}updateBucketOpacities(e,i,n){e.hasTextData()&&e.text.opacityVertexArray.clear(),e.hasIconData()&&e.icon.opacityVertexArray.clear(),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexArray.clear(),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexArray.clear();const r=e.layers[0].layout,o=!!e.layers[0].dynamicFilter(),a=new he(null,0,!1,!1,!0),s=r.get("text-allow-overlap"),l=r.get("icon-allow-overlap"),c=r.get("text-variable-anchor"),h="map"===r.get("text-rotation-alignment"),u="map"===r.get("text-pitch-alignment"),d="none"!==r.get("icon-text-fit"),p=new he(null,0,s&&(l||!e.hasIconData()||r.get("icon-optional")),l&&(s||!e.hasTextData()||r.get("text-optional")),!0);!e.collisionArrays&&n&&(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData())&&e.deserializeCollisionBoxes(n);const f=(t,e,i)=>{for(let n=0;n<e/4;n++)t.opacityVertexArray.emplaceBack(i)};let m=0;for(let n=0;n<e.symbolInstances.length;n++){const r=e.symbolInstances.get(n),{numHorizontalGlyphVertices:s,numVerticalGlyphVertices:l,crossTileID:g}=r;let y=this.opacities[g];i[g]?y=a:y||(y=p,this.opacities[g]=y),i[g]=!0;const _=s>0||l>0,v=r.numIconVertices>0,x=this.placedOrientations[r.crossTileID],b=x===t.WritingMode.vertical,w=x===t.WritingMode.horizontal||x===t.WritingMode.horizontalOnly;if(!_&&!v||y.isHidden()||m++,_){const t=Ee(y.text);f(e.text,s,b?Ce:t),f(e.text,l,w?Ce:t);const i=y.text.isHidden();[r.rightJustifiedTextSymbolIndex,r.centerJustifiedTextSymbolIndex,r.leftJustifiedTextSymbolIndex].forEach(t=>{t>=0&&(e.text.placedSymbolArray.get(t).hidden=i||b?1:0)}),r.verticalPlacedTextSymbolIndex>=0&&(e.text.placedSymbolArray.get(r.verticalPlacedTextSymbolIndex).hidden=i||w?1:0);const n=this.variableOffsets[r.crossTileID];n&&this.markUsedJustification(e,n.anchor,r,x);const o=this.placedOrientations[r.crossTileID];o&&(this.markUsedJustification(e,"left",r,o),this.markUsedOrientation(e,o,r))}if(v){const t=Ee(y.icon);r.placedIconSymbolIndex>=0&&(f(e.icon,r.numIconVertices,b?Ce:t),e.icon.placedSymbolArray.get(r.placedIconSymbolIndex).hidden=y.icon.isHidden()),r.verticalPlacedIconSymbolIndex>=0&&(f(e.icon,r.numVerticalIconVertices,w?Ce:t),e.icon.placedSymbolArray.get(r.verticalPlacedIconSymbolIndex).hidden=y.icon.isHidden())}if(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData()){const i=e.collisionArrays[n];if(i){let n=new t.pointGeometry(0,0),r=!0;if(i.textBox||i.verticalTextBox){if(c){const t=this.variableOffsets[g];t?(n=me(t.anchor,t.width,t.height,t.textOffset,t.textScale),h&&n._rotate(u?this.transform.angle:-this.transform.angle)):r=!1}o&&(r=!y.clipped),i.textBox&&_e(e.textCollisionBox.collisionVertexArray,y.text.placed,!r||b,n.x,n.y),i.verticalTextBox&&_e(e.textCollisionBox.collisionVertexArray,y.text.placed,!r||w,n.x,n.y)}const a=r&&Boolean(!w&&i.verticalIconBox);i.iconBox&&_e(e.iconCollisionBox.collisionVertexArray,y.icon.placed,a,d?n.x:0,d?n.y:0),i.verticalIconBox&&_e(e.iconCollisionBox.collisionVertexArray,y.icon.placed,!a,d?n.x:0,d?n.y:0)}}}if(e.fullyClipped=0===m,e.sortFeatures(this.transform.angle),this.retainedQueryData[e.bucketInstanceId]&&(this.retainedQueryData[e.bucketInstanceId].featureSortOrder=e.featureSortOrder),e.hasTextData()&&e.text.opacityVertexBuffer&&e.text.opacityVertexBuffer.updateData(e.text.opacityVertexArray),e.hasIconData()&&e.icon.opacityVertexBuffer&&e.icon.opacityVertexBuffer.updateData(e.icon.opacityVertexArray),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexBuffer&&e.iconCollisionBox.collisionVertexBuffer.updateData(e.iconCollisionBox.collisionVertexArray),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexBuffer&&e.textCollisionBox.collisionVertexBuffer.updateData(e.textCollisionBox.collisionVertexArray),e.bucketInstanceId in this.collisionCircleArrays){const t=this.collisionCircleArrays[e.bucketInstanceId];e.placementInvProjMatrix=t.invProjMatrix,e.placementViewportMatrix=t.viewportMatrix,e.collisionCircleArray=t.circles,delete this.collisionCircleArrays[e.bucketInstanceId]}}symbolFadeChange(t){return 0===this.fadeDuration?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,e){const i=this.zoomAtLastRecencyCheck===e?1-this.zoomAdjustment(e):1;return this.zoomAtLastRecencyCheck=e,this.commitTime+this.fadeDuration*i>t}setStale(){this.stale=!0}}function _e(t,e,i,n,r){t.emplaceBack(e?1:0,i?1:0,n||0,r||0),t.emplaceBack(e?1:0,i?1:0,n||0,r||0),t.emplaceBack(e?1:0,i?1:0,n||0,r||0),t.emplaceBack(e?1:0,i?1:0,n||0,r||0)}const ve=Math.pow(2,25),xe=Math.pow(2,24),be=Math.pow(2,17),we=Math.pow(2,16),Me=Math.pow(2,9),Te=Math.pow(2,8),Se=Math.pow(2,1);function Ee(t){if(0===t.opacity&&!t.placed)return 0;if(1===t.opacity&&t.placed)return 4294967295;const e=t.placed?1:0,i=Math.floor(127*t.opacity);return i*ve+e*xe+i*be+e*we+i*Me+e*Te+i*Se+e}const Ce=0;class Ae{constructor(t){this._sortAcrossTiles="viewport-y"!==t.layout.get("symbol-z-order")&&void 0!==t.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(t,e,i,n,r){const o=this._bucketParts;for(;this._currentTileIndex<t.length;)if(e.getBucketParts(o,n,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,r())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,o.sort((t,e)=>t.sortKey-e.sortKey));this._currentPartIndex<o.length;){const t=o[this._currentPartIndex];if(e.placeLayerBucketPart(t,this._seenCrossTileIDs,i,0===t.symbolInstanceStart),this._currentPartIndex++,r())return!0}return!1}}class Pe{constructor(t,e,i,n,r,o,a,s){this.placement=new ye(t,r,o,a,s),this._currentPlacementIndex=e.length-1,this._forceFullPlacement=i,this._showCollisionBoxes=n,this._done=!1}isDone(){return this._done}continuePlacement(e,i,n){const r=t.exported.now(),o=()=>{const e=t.exported.now()-r;return!this._forceFullPlacement&&e>2};for(;this._currentPlacementIndex>=0;){const t=i[e[this._currentPlacementIndex]],r=this.placement.collisionIndex.transform.zoom;if("symbol"===t.type&&(!t.minzoom||t.minzoom<=r)&&(!t.maxzoom||t.maxzoom>r)){if(this._inProgressLayer||(this._inProgressLayer=new Ae(t)),this._inProgressLayer.continuePlacement(n[t.source],this.placement,this._showCollisionBoxes,t,o))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Le=512/t.EXTENT/2;class Ie{constructor(t,e,i){this.tileID=t,this.indexedSymbolInstances={},this.bucketInstanceId=i;for(let i=0;i<e.length;i++){const n=e.get(i),r=n.key;this.indexedSymbolInstances[r]||(this.indexedSymbolInstances[r]=[]),this.indexedSymbolInstances[r].push({crossTileID:n.crossTileID,coord:this.getScaledCoordinates(n,t)})}}getScaledCoordinates(e,i){const n=Le/Math.pow(2,i.canonical.z-this.tileID.canonical.z);return{x:Math.floor((i.canonical.x*t.EXTENT+e.tileAnchorX)*n),y:Math.floor((i.canonical.y*t.EXTENT+e.tileAnchorY)*n)}}findMatches(t,e,i){const n=this.tileID.canonical.z<e.canonical.z?1:Math.pow(2,this.tileID.canonical.z-e.canonical.z);for(let r=0;r<t.length;r++){const o=t.get(r);if(o.crossTileID)continue;const a=this.indexedSymbolInstances[o.key];if(!a)continue;const s=this.getScaledCoordinates(o,e);for(const t of a)if(Math.abs(t.coord.x-s.x)<=n&&Math.abs(t.coord.y-s.y)<=n&&!i[t.crossTileID]){i[t.crossTileID]=!0,o.crossTileID=t.crossTileID;break}}}}class Re{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class De{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const e=Math.round((t-this.lng)/360);if(0!==e)for(const t in this.indexes){const i=this.indexes[t],n={};for(const t in i){const r=i[t];r.tileID=r.tileID.unwrapTo(r.tileID.wrap+e),n[r.tileID.key]=r}this.indexes[t]=n}this.lng=t}addBucket(t,e,i){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===e.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let t=0;t<e.symbolInstances.length;t++)e.symbolInstances.get(t).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]={});const n=this.usedCrossTileIDs[t.overscaledZ];for(const i in this.indexes){const r=this.indexes[i];if(Number(i)>t.overscaledZ)for(const i in r){const o=r[i];o.tileID.isChildOf(t)&&o.findMatches(e.symbolInstances,t,n)}else{const o=r[t.scaledTo(Number(i)).key];o&&o.findMatches(e.symbolInstances,t,n)}}for(let t=0;t<e.symbolInstances.length;t++){const r=e.symbolInstances.get(t);r.crossTileID||(r.crossTileID=i.generate(),n[r.crossTileID]=!0)}return void 0===this.indexes[t.overscaledZ]&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Ie(t,e.symbolInstances,e.bucketInstanceId),!0}removeBucketCrossTileIDs(t,e){for(const i in e.indexedSymbolInstances)for(const n of e.indexedSymbolInstances[i])delete this.usedCrossTileIDs[t][n.crossTileID]}removeStaleBuckets(t){let e=!1;for(const i in this.indexes){const n=this.indexes[i];for(const r in n)t[n[r].bucketInstanceId]||(this.removeBucketCrossTileIDs(i,n[r]),delete n[r],e=!0)}return e}}class ke{constructor(){this.layerIndexes={},this.crossTileIDs=new Re,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,e,i,n){let r=this.layerIndexes[t.id];void 0===r&&(r=this.layerIndexes[t.id]=new De);let o=!1;const a={};"globe"!==n.name&&r.handleWrapJump(i);for(const i of e){const e=i.getBucket(t);e&&t.id===e.layerIds[0]&&(e.bucketInstanceId||(e.bucketInstanceId=++this.maxBucketInstanceId),r.addBucket(i.tileID,e,this.crossTileIDs)&&(o=!0),a[e.bucketInstanceId]=!0)}return r.removeStaleBuckets(a)&&(o=!0),o}pruneUnusedLayers(t){const e={};t.forEach(t=>{e[t]=!0});for(const t in this.layerIndexes)e[t]||delete this.layerIndexes[t]}}const Oe=(e,i)=>t.emitValidationErrors(e,i&&i.filter(t=>"source.canvas"!==t.identifier)),ze=t.pick(Ot,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),Be=t.pick(Ot,["setCenter","setZoom","setBearing","setPitch"]),Fe=function(){const e={},i=t.spec.$version;for(const n in t.spec.$root){const r=t.spec.$root[n];if(r.required){let t=null;t="version"===n?i:"array"===r.type?[]:{},null!=t&&(e[n]=t)}}return e}(),Ne={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class je extends t.Evented{constructor(e,i={}){super(),this.map=e,this.dispatcher=new S(Rt(),this),this.imageManager=new p,this.imageManager.setEventedParent(this),this.glyphManager=new t.GlyphManager(e._requestManager,i.localFontFamily?t.LocalGlyphMode.all:i.localIdeographFontFamily?t.LocalGlyphMode.ideographs:t.LocalGlyphMode.none,i.localFontFamily||i.localIdeographFontFamily),this.lineAtlas=new t.LineAtlas(256,512),this.crossTileSymbolIndex=new ke,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this.zoomHistory=new t.ZoomHistory,this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",t.getReferrer());const n=this;this._rtlTextPluginCallback=je.registerForPluginStateChange(e=>{n.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:e.pluginStatus,pluginURL:e.pluginURL},(e,i)=>{if(t.triggerPluginCompletionEvent(e),i&&i.every(t=>t))for(const t in n._sourceCaches){const e=n._sourceCaches[t],i=e.getSource().type;"vector"!==i&&"geojson"!==i||e.reload()}})}),this.on("data",t=>{if("source"!==t.dataType||"metadata"!==t.sourceDataType)return;const e=this.getSource(t.sourceId);if(e&&e.vectorLayerIds)for(const t in this._layers){const i=this._layers[t];i.source===e.id&&this._validateLayer(i)}})}loadURL(e,i={}){this.fire(new t.Event("dataloading",{dataType:"style"}));const n="boolean"==typeof i.validate?i.validate:!t.isMapboxURL(e);e=this.map._requestManager.normalizeStyleURL(e,i.accessToken);const r=this.map._requestManager.transformRequest(e,t.ResourceType.Style);this._request=t.getJSON(r,(e,i)=>{this._request=null,e?this.fire(new t.ErrorEvent(e)):i&&this._load(i,n)})}loadJSON(e,i={}){this.fire(new t.Event("dataloading",{dataType:"style"})),this._request=t.exported.frame(()=>{this._request=null,this._load(e,!1!==i.validate)})}loadEmpty(){this.fire(new t.Event("dataloading",{dataType:"style"})),this._load(Fe,!1)}_updateLayerCount(t,e){const i=e?1:-1;t.is3D()&&(this._num3DLayers+=i),"circle"===t.type&&(this._numCircleLayers+=i),"symbol"===t.type&&(this._numSymbolLayers+=i)}_load(e,i){if(i&&Oe(this,t.validateStyle(e)))return;this._loaded=!0,this.stylesheet=e,this.updateProjection();for(const t in e.sources)this.addSource(t,e.sources[t],{validate:!1});this._changed=!1,e.sprite?this._loadSprite(e.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(e.glyphs);const n=kt(this.stylesheet.layers);this._order=n.map(t=>t.id),this._layers={},this._serializedLayers={};for(let e of n)e=t.createStyleLayer(e),e.setEventedParent(this,{layer:{id:e.id}}),this._layers[e.id]=e,this._serializedLayers[e.id]=e.serialize(),this._updateLayerCount(e,!0);this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new g(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new t.Event("data",{dataType:"style"})),this.fire(new t.Event("style.load"))}terrainSetForDrapingOnly(){return this.terrain&&0===this.terrain.drapeRenderMode}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.updateProjection()}updateProjection(){const t=this.map.transform.projection,e=this.map.transform.setProjection(this.map._runtimeProjection||(this.stylesheet?this.stylesheet.projection:void 0)),i=this.map.transform.projection;if(this._loaded&&(i.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null)),this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),e){if(i.isReprojectedInTileSpace||t.isReprojectedInTileSpace){this.map.painter.clearBackgroundTiles();for(const t in this._sourceCaches)this._sourceCaches[t].clearTiles()}else this._forceSymbolLayerUpdate();this.map._update(!0)}}_loadSprite(e){this._spriteRequest=function(e,i,n){let r,o,a;const s=t.exported.devicePixelRatio>1?"@2x":"";let l=t.getJSON(i.transformRequest(i.normalizeSpriteURL(e,s,".json"),t.ResourceType.SpriteJSON),(t,e)=>{l=null,a||(a=t,r=e,h())}),c=t.getImage(i.transformRequest(i.normalizeSpriteURL(e,s,".png"),t.ResourceType.SpriteImage),(t,e)=>{c=null,a||(a=t,o=e,h())});function h(){if(a)n(a);else if(r&&o){const e=t.exported.getImageData(o),i={};for(const n in r){const{width:o,height:a,x:s,y:l,sdf:c,pixelRatio:h,stretchX:u,stretchY:d,content:p}=r[n],f=new t.RGBAImage({width:o,height:a});t.RGBAImage.copy(e,f,{x:s,y:l},{x:0,y:0},{width:o,height:a}),i[n]={data:f,pixelRatio:h,sdf:c,stretchX:u,stretchY:d,content:p}}n(null,i)}}return{cancel(){l&&(l.cancel(),l=null),c&&(c.cancel(),c=null)}}}(e,this.map._requestManager,(e,i)=>{if(this._spriteRequest=null,e)this.fire(new t.ErrorEvent(e));else if(i)for(const t in i)this.imageManager.addImage(t,i[t]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new t.Event("data",{dataType:"style"}))})}_validateLayer(e){const i=this.getSource(e.source);if(!i)return;const n=e.sourceLayer;n&&("geojson"===i.type||i.vectorLayerIds&&-1===i.vectorLayerIds.indexOf(n))&&this.fire(new t.ErrorEvent(new Error(`Source layer "${n}" does not exist on source "${i.id}" as specified by style layer "${e.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._updatedSources).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(t){const e=[];for(const i of t){const t=this._layers[i];"custom"!==t.type&&e.push(t.serialize())}return e}hasTransitions(){if(this.light&&this.light.hasTransition())return!0;if(this.fog&&this.fog.hasTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(t){return!!this.terrain&&Ne[t.type]}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(e){if(!this._loaded)return;const i=this._changed;if(this._changed){const t=Object.keys(this._updatedLayers),i=Object.keys(this._removedLayers);(t.length||i.length)&&this._updateWorkerLayers(t,i);for(const t in this._updatedSources){const e=this._updatedSources[t];"reload"===e?this._reloadSource(t):"clear"===e&&this._clearSource(t)}this._updateTilesForChangedImages();for(const t in this._updatedPaintProps)this._layers[t].updateTransitions(e);this.light.updateTransitions(e),this.fog&&this.fog.updateTransitions(e),this._resetUpdates()}const n={};for(const t in this._sourceCaches){const e=this._sourceCaches[t];n[t]=e.used,e.used=!1}for(const t of this._order){const i=this._layers[t];if(i.recalculate(e,this._availableImages),!i.isHidden(e.zoom)){const t=this._getLayerSourceCache(i);t&&(t.used=!0)}const n=this.map.painter;if(n){const t=i.getProgramIds();if(!t)continue;const r=i.getProgramConfiguration(e.zoom);for(const e of t)n.useProgram(e,r)}}for(const e in n){const i=this._sourceCaches[e];n[e]!==i.used&&i.getSource().fire(new t.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:i.getSource().id}))}this.light.recalculate(e),this.terrain&&this.terrain.recalculate(e),this.fog&&this.fog.recalculate(e),this.z=e.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),i&&this.fire(new t.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=Object.keys(this._changedImages);if(t.length){for(const e in this._sourceCaches)this._sourceCaches[e].reloadTilesForDependencies(["icons","patterns"],t);this._changedImages={}}}_updateWorkerLayers(t,e){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(t),removedIds:e})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(e){if(this._checkLoaded(),Oe(this,t.validateStyle(e)))return!1;(e=t.clone$1(e)).layers=kt(e.layers);const i=function(t,e){if(!t)return[{command:Ot.setStyle,args:[e]}];let i=[];try{if(!o(t.version,e.version))return[{command:Ot.setStyle,args:[e]}];o(t.center,e.center)||i.push({command:Ot.setCenter,args:[e.center]}),o(t.zoom,e.zoom)||i.push({command:Ot.setZoom,args:[e.zoom]}),o(t.bearing,e.bearing)||i.push({command:Ot.setBearing,args:[e.bearing]}),o(t.pitch,e.pitch)||i.push({command:Ot.setPitch,args:[e.pitch]}),o(t.sprite,e.sprite)||i.push({command:Ot.setSprite,args:[e.sprite]}),o(t.glyphs,e.glyphs)||i.push({command:Ot.setGlyphs,args:[e.glyphs]}),o(t.transition,e.transition)||i.push({command:Ot.setTransition,args:[e.transition]}),o(t.light,e.light)||i.push({command:Ot.setLight,args:[e.light]}),o(t.fog,e.fog)||i.push({command:Ot.setFog,args:[e.fog]}),o(t.projection,e.projection)||i.push({command:Ot.setProjection,args:[e.projection]});const n={},r=[];!function(t,e,i,n){let r;for(r in e=e||{},t=t||{})t.hasOwnProperty(r)&&(e.hasOwnProperty(r)||Bt(r,i,n));for(r in e)e.hasOwnProperty(r)&&(t.hasOwnProperty(r)?o(t[r],e[r])||("geojson"===t[r].type&&"geojson"===e[r].type&&Nt(t,e,r)?i.push({command:Ot.setGeoJSONSourceData,args:[r,e[r].data]}):Ft(r,e,i,n)):zt(r,e,i))}(t.sources,e.sources,r,n);const a=[];t.layers&&t.layers.forEach(t=>{n[t.source]?i.push({command:Ot.removeLayer,args:[t.id]}):a.push(t)});let s=t.terrain;s&&n[s.source]&&(i.push({command:Ot.setTerrain,args:[void 0]}),s=void 0),i=i.concat(r),o(s,e.terrain)||i.push({command:Ot.setTerrain,args:[e.terrain]}),function(t,e,i){e=e||[];const n=(t=t||[]).map(Gt),r=e.map(Gt),a=t.reduce(Ut,{}),s=e.reduce(Ut,{}),l=n.slice(),c=Object.create(null);let h,u,d,p,f,m,g;for(h=0,u=0;h<n.length;h++)d=n[h],s.hasOwnProperty(d)?u++:(i.push({command:Ot.removeLayer,args:[d]}),l.splice(l.indexOf(d,u),1));for(h=0,u=0;h<r.length;h++)d=r[r.length-1-h],l[l.length-1-h]!==d&&(a.hasOwnProperty(d)?(i.push({command:Ot.removeLayer,args:[d]}),l.splice(l.lastIndexOf(d,l.length-u),1)):u++,m=l[l.length-h],i.push({command:Ot.addLayer,args:[s[d],m]}),l.splice(l.length-h,0,d),c[d]=!0);for(h=0;h<r.length;h++)if(d=r[h],p=a[d],f=s[d],!c[d]&&!o(p,f))if(o(p.source,f.source)&&o(p["source-layer"],f["source-layer"])&&o(p.type,f.type)){for(g in jt(p.layout,f.layout,i,d,null,Ot.setLayoutProperty),jt(p.paint,f.paint,i,d,null,Ot.setPaintProperty),o(p.filter,f.filter)||i.push({command:Ot.setFilter,args:[d,f.filter]}),o(p.minzoom,f.minzoom)&&o(p.maxzoom,f.maxzoom)||i.push({command:Ot.setLayerZoomRange,args:[d,f.minzoom,f.maxzoom]}),p)p.hasOwnProperty(g)&&"layout"!==g&&"paint"!==g&&"filter"!==g&&"metadata"!==g&&"minzoom"!==g&&"maxzoom"!==g&&(0===g.indexOf("paint.")?jt(p[g],f[g],i,d,g.slice(6),Ot.setPaintProperty):o(p[g],f[g])||i.push({command:Ot.setLayerProperty,args:[d,g,f[g]]}));for(g in f)f.hasOwnProperty(g)&&!p.hasOwnProperty(g)&&"layout"!==g&&"paint"!==g&&"filter"!==g&&"metadata"!==g&&"minzoom"!==g&&"maxzoom"!==g&&(0===g.indexOf("paint.")?jt(p[g],f[g],i,d,g.slice(6),Ot.setPaintProperty):o(p[g],f[g])||i.push({command:Ot.setLayerProperty,args:[d,g,f[g]]}))}else i.push({command:Ot.removeLayer,args:[d]}),m=l[l.lastIndexOf(d)+1],i.push({command:Ot.addLayer,args:[f,m]})}(a,e.layers,i)}catch(t){console.warn("Unable to compute style diff:",t),i=[{command:Ot.setStyle,args:[e]}]}return i}(this.serialize(),e).filter(t=>!(t.command in Be));if(0===i.length)return!1;const n=i.filter(t=>!(t.command in ze));if(n.length>0)throw new Error(`Unimplemented: ${n.map(t=>t.command).join(", ")}.`);return i.forEach(t=>{"setTransition"!==t.command&&this[t.command].apply(this,t.args)}),this.stylesheet=e,this.updateProjection(),!0}addImage(e,i){if(this.getImage(e))return this.fire(new t.ErrorEvent(new Error("An image with this name already exists.")));this.imageManager.addImage(e,i),this._afterImageUpdated(e)}updateImage(t,e){this.imageManager.updateImage(t,e)}getImage(t){return this.imageManager.getImage(t)}removeImage(e){if(!this.getImage(e))return this.fire(new t.ErrorEvent(new Error("No image with this name exists.")));this.imageManager.removeImage(e),this._afterImageUpdated(e)}_afterImageUpdated(e){this._availableImages=this.imageManager.listImages(),this._changedImages[e]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new t.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(e,i,n={}){if(this._checkLoaded(),void 0!==this.getSource(e))throw new Error("There is already a source with this ID");if(!i.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(i).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(i.type)>=0&&this._validate(t.validateStyle.source,"sources."+e,i,null,n))return;this.map&&this.map._collectResourceTiming&&(i.collectResourceTiming=!0);const r=Mt(e,i,this.dispatcher,this);r.setEventedParent(this,()=>({isSourceLoaded:this.loaded(),source:r.serialize(),sourceId:e}));const o=i=>{const n=(i?"symbol:":"other:")+e,o=this._sourceCaches[n]=new t.SourceCache(n,r,i);(i?this._symbolSourceCaches:this._otherSourceCaches)[e]=o,o.style=this,o.onAdd(this.map)};o(!1),"vector"!==i.type&&"geojson"!==i.type||o(!0),r.onAdd&&r.onAdd(this.map),this._changed=!0}removeSource(e){this._checkLoaded();const i=this.getSource(e);if(void 0===i)throw new Error("There is no source with this ID");for(const i in this._layers)if(this._layers[i].source===e)return this.fire(new t.ErrorEvent(new Error(`Source "${e}" cannot be removed while layer "${i}" is using it.`)));if(this.terrain&&this.terrain.get().source===e)return this.fire(new t.ErrorEvent(new Error(`Source "${e}" cannot be removed while terrain is using it.`)));const n=this._getSourceCaches(e);for(const e of n)delete this._sourceCaches[e.id],delete this._updatedSources[e.id],e.fire(new t.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:e.getSource().id})),e.setEventedParent(null),e.clearTiles();delete this._otherSourceCaches[e],delete this._symbolSourceCaches[e],i.setEventedParent(null),i.onRemove&&i.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(t,e){this._checkLoaded(),this.getSource(t).setData(e),this._changed=!0}getSource(t){const e=this._getSourceCache(t);return e&&e.getSource()}addLayer(e,i,n={}){this._checkLoaded();const r=e.id;if(this.getLayer(r))return void this.fire(new t.ErrorEvent(new Error(`Layer with id "${r}" already exists on this map`)));let o;if("custom"===e.type){if(Oe(this,t.validateCustomStyleLayer(e)))return;o=t.createStyleLayer(e)}else{if("object"==typeof e.source&&(this.addSource(r,e.source),e=t.clone$1(e),e=t.extend(e,{source:r})),this._validate(t.validateStyle.layer,"layers."+r,e,{arrayIndex:-1},n))return;o=t.createStyleLayer(e),this._validateLayer(o),o.setEventedParent(this,{layer:{id:r}}),this._serializedLayers[o.id]=o.serialize(),this._updateLayerCount(o,!0)}const a=i?this._order.indexOf(i):this._order.length;if(i&&-1===a)return void this.fire(new t.ErrorEvent(new Error(`Layer with id "${i}" does not exist on this map.`)));this._order.splice(a,0,r),this._layerOrderChanged=!0,this._layers[r]=o;const s=this._getLayerSourceCache(o);if(this._removedLayers[r]&&o.source&&s&&"custom"!==o.type){const t=this._removedLayers[r];delete this._removedLayers[r],t.type!==o.type?this._updatedSources[o.source]="clear":(this._updatedSources[o.source]="reload",s.pause())}this._updateLayer(o),o.onAdd&&o.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(e,i){if(this._checkLoaded(),this._changed=!0,!this._layers[e])return void this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot be moved.`)));if(e===i)return;const n=this._order.indexOf(e);this._order.splice(n,1);const r=i?this._order.indexOf(i):this._order.length;i&&-1===r?this.fire(new t.ErrorEvent(new Error(`Layer with id "${i}" does not exist on this map.`))):(this._order.splice(r,0,e),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(e){this._checkLoaded();const i=this._layers[e];if(!i)return void this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot be removed.`)));i.setEventedParent(null),this._updateLayerCount(i,!1);const n=this._order.indexOf(e);this._order.splice(n,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[e]=i,delete this._layers[e],delete this._serializedLayers[e],delete this._updatedLayers[e],delete this._updatedPaintProps[e],i.onRemove&&i.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(t){return this._layers[t]}hasLayer(t){return t in this._layers}hasLayerType(t){for(const e in this._layers)if(this._layers[e].type===t)return!0;return!1}setLayerZoomRange(e,i,n){this._checkLoaded();const r=this.getLayer(e);r?r.minzoom===i&&r.maxzoom===n||(null!=i&&(r.minzoom=i),null!=n&&(r.maxzoom=n),this._updateLayer(r)):this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(e,i,n={}){this._checkLoaded();const r=this.getLayer(e);if(r){if(!o(r.filter,i))return null==i?(r.filter=void 0,void this._updateLayer(r)):void(this._validate(t.validateStyle.filter,`layers.${r.id}.filter`,i,{layerType:r.type},n)||(r.filter=t.clone$1(i),this._updateLayer(r)))}else this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot be filtered.`)))}getFilter(e){return t.clone$1(this.getLayer(e).filter)}setLayoutProperty(e,i,n,r={}){this._checkLoaded();const a=this.getLayer(e);a?o(a.getLayoutProperty(i),n)||(a.setLayoutProperty(i,n,r),this._updateLayer(a)):this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(e,i){const n=this.getLayer(e);if(n)return n.getLayoutProperty(i);this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style.`)))}setPaintProperty(e,i,n,r={}){this._checkLoaded();const a=this.getLayer(e);a?o(a.getPaintProperty(i),n)||(a.setPaintProperty(i,n,r)&&this._updateLayer(a),this._changed=!0,this._updatedPaintProps[e]=!0):this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(t,e){return this.getLayer(t).getPaintProperty(e)}setFeatureState(e,i){this._checkLoaded();const n=e.source,r=e.sourceLayer,o=this.getSource(n);if(void 0===o)return void this.fire(new t.ErrorEvent(new Error(`The source '${n}' does not exist in the map's style.`)));const a=o.type;if("geojson"===a&&r)return void this.fire(new t.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===a&&!r)return void this.fire(new t.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===e.id&&this.fire(new t.ErrorEvent(new Error("The feature id parameter must be provided.")));const s=this._getSourceCaches(n);for(const t of s)t.setFeatureState(r,e.id,i)}removeFeatureState(e,i){this._checkLoaded();const n=e.source,r=this.getSource(n);if(void 0===r)return void this.fire(new t.ErrorEvent(new Error(`The source '${n}' does not exist in the map's style.`)));const o=r.type,a="vector"===o?e.sourceLayer:void 0;if("vector"===o&&!a)return void this.fire(new t.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(i&&"string"!=typeof e.id&&"number"!=typeof e.id)return void this.fire(new t.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const s=this._getSourceCaches(n);for(const t of s)t.removeFeatureState(a,e.id,i)}getFeatureState(e){this._checkLoaded();const i=e.source,n=e.sourceLayer,r=this.getSource(i);if(void 0!==r){if("vector"!==r.type||n)return void 0===e.id&&this.fire(new t.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(i)[0].getFeatureState(n,e.id);this.fire(new t.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new t.ErrorEvent(new Error(`The source '${i}' does not exist in the map's style.`)))}getTransition(){return t.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const e={};for(const t in this._sourceCaches){const i=this._sourceCaches[t].getSource();e[i.id]||(e[i.id]=i.serialize())}return t.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.stylesheet.terrain,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:e,layers:this._serializeLayers(this._order)},t=>void 0!==t)}_updateLayer(t){this._updatedLayers[t.id]=!0;const e=this._getLayerSourceCache(t);t.source&&!this._updatedSources[t.source]&&e&&"raster"!==e.getSource().type&&(this._updatedSources[t.source]="reload",e.pause()),this._changed=!0,t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const e=t=>"fill-extrusion"===this._layers[t].type,i={},n=[];for(let r=this._order.length-1;r>=0;r--){const o=this._order[r];if(e(o)){i[o]=r;for(const e of t){const t=e[o];if(t)for(const e of t)n.push(e)}}}n.sort((t,e)=>e.intersectionZ-t.intersectionZ);const r=[];for(let o=this._order.length-1;o>=0;o--){const a=this._order[o];if(e(a))for(let t=n.length-1;t>=0;t--){const e=n[t].feature;if(i[e.layer.id]<o)break;r.push(e),n.pop()}else for(const e of t){const t=e[a];if(t)for(const e of t)r.push(e.feature)}}return r}queryRenderedFeatures(e,i,n){i&&i.filter&&this._validate(t.validateStyle.filter,"queryRenderedFeatures.filter",i.filter,null,i);const r={};if(i&&i.layers){if(!Array.isArray(i.layers))return this.fire(new t.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const e of i.layers){const i=this._layers[e];if(!i)return this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot be queried for features.`))),[];r[i.source]=!0}}const o=[];i.availableImages=this._availableImages;const a=i&&i.layers?i.layers.some(t=>{const e=this.getLayer(t);return e&&e.is3D()}):this.has3DLayers(),s=ft.createFromScreenPoints(e,n);for(const t in this._sourceCaches){const e=this._sourceCaches[t].getSource().id;i.layers&&!r[e]||o.push(St(this._sourceCaches[t],this._layers,this._serializedLayers,s,i,n,a,!!this.map._showQueryGeometry))}return this.placement&&o.push(function(t,e,i,n,r,o,a){const s={},l=o.queryRenderedSymbols(n),c=[];for(const t of Object.keys(l).map(Number))c.push(a[t]);c.sort(Ct);for(const i of c){const n=i.featureIndex.lookupSymbolFeatures(l[i.bucketInstanceId],e,i.bucketIndex,i.sourceLayerIndex,r.filter,r.layers,r.availableImages,t);for(const t in n){const e=s[t]=s[t]||[],r=n[t];r.sort((t,e)=>{const n=i.featureSortOrder;if(n){const i=n.indexOf(t.featureIndex);return n.indexOf(e.featureIndex)-i}return e.featureIndex-t.featureIndex});for(const t of r)e.push(t)}}for(const e in s)s[e].forEach(n=>{const r=n.feature,o=i(t[e]).getFeatureState(r.layer["source-layer"],r.id);r.source=r.layer.source,r.layer["source-layer"]&&(r.sourceLayer=r.layer["source-layer"]),r.state=o});return s}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),s.screenGeometry,i,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(o)}querySourceFeatures(e,i){i&&i.filter&&this._validate(t.validateStyle.filter,"querySourceFeatures.filter",i.filter,null,i);const n=this._getSourceCaches(e);let r=[];for(const t of n)r=r.concat(Et(t,i));return r}addSourceType(t,e,i){return je.getSourceType(t)?i(new Error(`A source type called "${t}" already exists.`)):(je.setSourceType(t,e),e.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:e.workerSourceURL},i):i(null,null))}getLight(){return this.light.getLight()}setLight(e,i={}){this._checkLoaded();const n=this.light.getLight();let r=!1;for(const t in e)if(!o(e[t],n[t])){r=!0;break}if(!r)return;const a={now:t.exported.now(),transition:t.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(e,i),this.light.updateTransitions(a)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(e,i=1){if(this._checkLoaded(),!e)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);if(1===i){if("object"==typeof e.source){const i="terrain-dem-src";this.addSource(i,e.source),e=t.clone$1(e),e=t.extend(e,{source:i})}if(this._validate(t.validateStyle.terrain,"terrain",e))return}if(!this.terrain||this.terrain&&i!==this.terrain.drapeRenderMode)this._createTerrain(e,i);else{const i=this.terrain,n=i.get();for(const r in e)if(!o(e[r],n[r])){i.set(e),this.stylesheet.terrain=e;const n={now:t.exported.now(),transition:t.extend({duration:0},this.stylesheet.transition)};i.updateTransitions(n);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(e){const i=this.fog=new T(e,this.map.transform);this.stylesheet.fog=e;const n={now:t.exported.now(),transition:t.extend({duration:0},this.stylesheet.transition)};i.updateTransitions(n)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(e){if(this._checkLoaded(),!e)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const i=this.fog,n=i.get();for(const r in e)if(!o(e[r],n[r])){i.set(e),this.stylesheet.fog=e;const n={now:t.exported.now(),transition:t.extend({duration:0},this.stylesheet.transition)};i.updateTransitions(n);break}}else this._createFog(e);this._markersNeedUpdate=!0}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const t=this._order.filter(t=>this.isLayerDraped(this._layers[t])),e=this._order.filter(t=>!this.isLayerDraped(this._layers[t]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...e)}_createTerrain(e,i){const n=this.terrain=new v(e,i);this.stylesheet.terrain=e,this.dispatcher.broadcast("enableTerrain",!0),this._force3DLayerUpdate();const r={now:t.exported.now(),transition:t.extend({duration:0},this.stylesheet.transition)};n.updateTransitions(r)}_force3DLayerUpdate(){for(const t in this._layers){const e=this._layers[t];"fill-extrusion"===e.type&&this._updateLayer(e)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const e=this._layers[t];"symbol"===e.type&&this._updateLayer(e)}}_validate(e,i,n,r,o={}){return(!o||!1!==o.validate)&&Oe(this,e.call(t.validateStyle,t.extend({key:i,style:this.serialize(),value:n,styleSpec:t.spec},r)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),t.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._layers)this._layers[t].setEventedParent(null);for(const t in this._sourceCaches)this._sourceCaches[t].clearTiles(),this._sourceCaches[t].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(t){const e=this._getSourceCaches(t);for(const t of e)t.clearTiles()}_reloadSource(t){const e=this._getSourceCaches(t);for(const t of e)t.resume(),t.reload()}_updateSources(t){for(const e in this._sourceCaches)this._sourceCaches[e].update(t)}_generateCollisionBoxes(){for(const t in this._sourceCaches){const e=this._sourceCaches[t];e.resume(),e.reload()}}_updatePlacement(e,i,n,r,o=!1){let a=!1,s=!1;const l={};for(const t of this._order){const i=this._layers[t];if("symbol"!==i.type)continue;if(!l[i.source]){const t=this._getLayerSourceCache(i);if(!t)continue;l[i.source]=t.getRenderableIds(!0).map(e=>t.getTileByID(e)).sort((t,e)=>e.tileID.overscaledZ-t.tileID.overscaledZ||(t.tileID.isLessThan(e.tileID)?-1:1))}const n=this.crossTileSymbolIndex.addLayer(i,l[i.source],e.center.lng,e.projection);a=a||n}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),o=o||this._layerOrderChanged||0===n,this._layerOrderChanged&&this.fire(new t.Event("neworder")),(o||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(t.exported.now(),e.zoom))&&(this.pauseablePlacement=new Pe(e,this._order,o,i,n,r,this.placement,this.fog&&e.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,l),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(t.exported.now()),s=!0),a&&this.pauseablePlacement.placement.setStale()),s||a)for(const t of this._order){const e=this._layers[t];"symbol"===e.type&&this.placement.updateLayerOpacities(e,l[e.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(t.exported.now())}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}getImages(t,e,i){this.imageManager.getImages(e.icons,i),this._updateTilesForChangedImages();const n=t=>{t&&t.setDependencies(e.tileID.key,e.type,e.icons)};n(this._otherSourceCaches[e.source]),n(this._symbolSourceCaches[e.source])}getGlyphs(t,e,i){this.glyphManager.getGlyphs(e.stacks,i)}getResource(e,i,n){return t.makeRequest(i,n)}_getSourceCache(t){return this._otherSourceCaches[t]}_getLayerSourceCache(t){return"symbol"===t.type?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}_getSourceCaches(t){const e=[];return this._otherSourceCaches[t]&&e.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&e.push(this._symbolSourceCaches[t]),e}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}je.getSourceType=function(t){return wt[t]},je.setSourceType=function(t,e){wt[t]=e},je.registerForPluginStateChange=t.registerForPluginStateChange;var Ge="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#define EXTENT 8192.0\n#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}\n#endif",Ue="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}";let Ve={},He={};Ve=Xe("","\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;\n#else\nuniform sampler2D u_dem;uniform sampler2D u_dem_prev;\n#endif\nuniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));\n#ifdef TERRAIN_DEM_NEAREST_FILTER\nreturn u_exaggeration*tl;\n#endif\nfloat tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {return currentElevation(apos);}\n#endif\nfloat unpack_depth(vec4 rgba_depth)\n{const vec4 bit_shift=vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(\nunpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))\n);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nfloat tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;\n#else\nvec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);\n#endif\nreturn vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;vec4 bounds=vec4(d,vec2(1.0)-d);h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",!0),He=Xe("#ifdef FOG\nuniform float u_fog_temporal_offset;float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif","#ifdef FOG\nuniform mat4 u_fog_matrix;vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",!0);const Ze=Xe("\nhighp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}\n#ifdef TERRAIN\nhighp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(256.0*256.0*256.0,256.0*256.0,256.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/256.0,1.0/256.0,1.0/256.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#endif","\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {\n#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)\nreturn mix(globe,mercator,t);\n#else\nreturn globe;\n#endif\n}\n#ifdef PROJECTION_GLOBE_VIEW\nmat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered."),We=Ge;var qe={background:Xe("uniform vec4 u_color;uniform float u_opacity;void main() {vec4 out_color=u_color;\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),backgroundPattern:Xe("uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_mix);\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),circle:Xe("varying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\ngl_FragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);\n#ifdef PROJECTION_GLOBE_VIEW\nvec2 scaled_extrude=extrude*a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=scaled_extrude.x*surface_vectors[0]+scaled_extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);vec4 world_center=vec4(pos,1);\n#else \nmat3 surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);vec4 world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\n#if defined(SCALE_WITH_MAP) && defined(PROJECTION_GLOBE_VIEW)\nview_scale*=a_scale;\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);vec4 occlusion_world_center=vec4(circle_center,cantilevered_height,1);vec4 occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nvec4 occlusion_world_center=world_center;vec4 occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}"),clippingMask:Xe("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Xe("uniform highp float u_intensity;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\ngl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);\n#ifdef PROJECTION_GLOBE_VIEW\nextrude*=a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\nvec3 pos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),heatmapTexture:Xe("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(0.0);\n#endif\n}","attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Xe("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}","attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Xe("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Xe("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;\n#endif\nvarying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}"),fill:Xe("#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillOutline:Xe("varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillOutlinePattern:Xe("uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=mix(color1,color2,u_fade);\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillPattern:Xe("uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillExtrusion:Xe("varying vec4 v_color;void main() {vec4 color=v_color;\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nvarying vec4 v_color;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\nvec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 pos=vec3(pos_nx.xy,h);\n#else\nvec3 pos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(pos.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.rgb+=clamp(color.rgb*directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),fillExtrusionPattern:Xe("uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);out_color=out_color*v_lighting;\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nvarying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 p=vec3(pos_nx.xy,h);\n#else\nvec3 p=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}"),hillshadePrepare:Xe("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nreturn texture2D(u_image,coord).a/4.0;\n#else\nvec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;\n#endif\n}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos);float f=getElevation(v_pos+vec2(epsilon.x,0));float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float h=getElevation(v_pos+vec2(0,epsilon.y));float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Xe("uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef FOG\ngl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),line:Xe("uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;uniform float u_mix;uniform vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;varying highp vec2 v_uv;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash_from\n#pragma mapbox: define lowp vec4 dash_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash_from\n#pragma mapbox: initialize lowp vec4 dash_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist_a=texture2D(u_dash_image,v_tex_a).a;float sdfdist_b=texture2D(u_dash_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfwidth=min(dash_from.z*u_scale.y,dash_to.z*u_scale.z);float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/sdfwidth;alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\n#ifdef RENDER_LINE_GRADIENT\nvec4 out_color=texture2D(u_gradient_image,v_uv);\n#else\nvec4 out_color=color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef RENDER_LINE_ALPHA_DISCARD\nif (alpha < u_alpha_discard_threshold) {discard;}\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define EXTRUDE_SCALE 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;\n#ifdef RENDER_LINE_GRADIENT\nattribute vec3 a_packed;\n#else\nattribute float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform mediump vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;varying highp vec2 v_uv;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash_from\n#pragma mapbox: define lowp vec4 dash_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash_from\n#pragma mapbox: initialize lowp vec4 dash_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];float a_linesofar=a_packed[2];highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);\n#endif\n#ifdef RENDER_LINE_DASH\nfloat tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;float scaleA=dash_from.z==0.0 ? 0.0 : tileZoomRatio/(dash_from.z*fromScale);float scaleB=dash_to.z==0.0 ? 0.0 : tileZoomRatio/(dash_to.z*toScale);float heightA=dash_from.y;float heightB=dash_to.y;v_tex_a=vec2(a_linesofar*scaleA/floorwidth,(-normal.y*heightA+dash_from.x+0.5)/u_texsize.y);v_tex_b=vec2(a_linesofar*scaleB/floorwidth,(-normal.y*heightB+dash_to.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),linePattern:Xe("uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ngl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),raster:Xe("uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef FOG\nout_color=fog_dither(fog_apply(out_color,v_fog_pos));\n#endif\ngl_FragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),symbolIcon:Xe("uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nlowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);\n#ifdef PROJECTED_POS_ON_VIEWPORT\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);\n#else\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0);\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\nfloat occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nv_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}"),symbolSDF:Xe("#define SDF_PX 8.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);\n#ifdef PROJECTED_POS_ON_VIEWPORT\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);\n#else\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\nfloat occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}"),symbolTextAndIcon:Xe("#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);\n#ifdef PROJECTED_POS_ON_VIEWPORT\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);\n#else\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale);\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\nfloat occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nv_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}"),terrainRaster:Xe("uniform sampler2D u_image0;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\nvoid main() {vec4 color=texture2D(u_image0,v_pos0);\n#ifdef FOG\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\ngl_FragColor=color;\n#ifdef TERRAIN_WIREFRAME\ngl_FragColor=vec4(1.0,0.0,0.0,0.8);\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\nconst float skirtOffset=24575.0;const float wireframeOffset=0.00015;void main() {v_pos0=a_texture_pos/8192.0;float skirt=float(a_pos.x >=skirtOffset);float elevation=elevation(a_texture_pos)-skirt*u_skirt_height;\n#ifdef TERRAIN_WIREFRAME\nelevation+=u_skirt_height*u_skirt_height*wireframeOffset;\n#endif\nvec2 decodedPos=a_pos-vec2(skirt*skirtOffset,0.0);gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n}"),terrainDepth:Xe("#ifdef GL_ES\nprecision highp float;\n#endif\nvarying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}","uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying float v_depth;void main() {float elevation=elevation(a_texture_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:Xe("\nvarying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",Ue),skyboxGradient:Xe("varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",Ue),skyboxCapture:Xe("\nvarying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;\n#ifdef GL_ES\nprecision highp float;\n#endif\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}","attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Xe("uniform sampler2D u_image0;varying vec2 v_pos0;void main() {gl_FragColor=texture2D(u_image0,v_pos0);\n#ifdef TERRAIN_WIREFRAME\ngl_FragColor=vec4(1.0,0.0,0.0,0.8);\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_proj_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;attribute vec3 a_globe_pos;attribute vec2 a_merc_pos;attribute vec2 a_uv;varying vec2 v_pos0;const float wireframeOffset=1e3;void main() {v_pos0=a_uv;vec2 uv=a_uv*EXTENT;vec4 up_vector=vec4(elevationVector(uv),1.0);float height=elevation(uv);\n#ifdef TERRAIN_WIREFRAME\nheight+=wireframeOffset;\n#endif\nvec4 globe=u_globe_matrix*vec4(a_globe_pos+up_vector.xyz*height,1.0);vec4 mercator=vec4(0.0);if (u_zoom_transition > 0.0) {mercator=vec4(a_merc_pos,height,1.0);mercator.xy-=u_merc_center;mercator.x=wrap(mercator.x,-0.5,0.5);mercator=u_merc_matrix*mercator;}vec3 position=mix(globe.xyz,mercator.xyz,u_zoom_transition);gl_Position=u_proj_matrix*vec4(position,1.0);}"),globeAtmosphere:Xe("uniform vec2 u_center;uniform float u_radius;uniform vec2 u_screen_size;uniform float u_opacity;uniform highp float u_fadeout_range;uniform vec3 u_start_color;uniform vec3 u_end_color;uniform float u_pixel_ratio;void main() {highp vec2 fragCoord=gl_FragCoord.xy/u_pixel_ratio;fragCoord.y=u_screen_size.y-fragCoord.y;float distFromCenter=length(fragCoord-u_center);float normDistFromCenter=length(fragCoord-u_center)/u_radius;if (normDistFromCenter < 1.0)\ndiscard;float t=clamp(1.0-sqrt(normDistFromCenter-1.0)/u_fadeout_range,0.0,1.0);vec3 color=mix(u_start_color,u_end_color,1.0-t);gl_FragColor=vec4(color*t*u_opacity,u_opacity);}","attribute vec3 a_pos;void main() {gl_Position=vec4(a_pos,1.0);}")};function Xe(t,e,i){const n=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,r=/uniform (highp |mediump |lowp )?([\w]+) ([\w]+)([\s]*)([\w]*)/g,o=e.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),a=t.match(r),s=e.match(r),l=Ge.match(r);let c=s?s.concat(a):a;i||(Ve.staticUniforms&&(c=Ve.staticUniforms.concat(c)),He.staticUniforms&&(c=He.staticUniforms.concat(c))),c&&(c=c.concat(l));const h={};return{fragmentSource:t=t.replace(n,(t,e,i,n,r)=>(h[r]=!0,"define"===e?`\n#ifndef HAS_UNIFORM_u_${r}\nvarying ${i} ${n} ${r};\n#else\nuniform ${i} ${n} u_${r};\n#endif\n`:`\n#ifdef HAS_UNIFORM_u_${r}\n    ${i} ${n} ${r} = u_${r};\n#endif\n`)),vertexSource:e=e.replace(n,(t,e,i,n,r)=>{const o="float"===n?"vec2":"vec4",a=r.match(/color/)?"color":o;return h[r]?"define"===e?`\n#ifndef HAS_UNIFORM_u_${r}\nuniform lowp float u_${r}_t;\nattribute ${i} ${o} a_${r};\nvarying ${i} ${n} ${r};\n#else\nuniform ${i} ${n} u_${r};\n#endif\n`:"vec4"===a?`\n#ifndef HAS_UNIFORM_u_${r}\n    ${r} = a_${r};\n#else\n    ${i} ${n} ${r} = u_${r};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${r}\n    ${r} = unpack_mix_${a}(a_${r}, u_${r}_t);\n#else\n    ${i} ${n} ${r} = u_${r};\n#endif\n`:"define"===e?`\n#ifndef HAS_UNIFORM_u_${r}\nuniform lowp float u_${r}_t;\nattribute ${i} ${o} a_${r};\n#else\nuniform ${i} ${n} u_${r};\n#endif\n`:"vec4"===a?`\n#ifndef HAS_UNIFORM_u_${r}\n    ${i} ${n} ${r} = a_${r};\n#else\n    ${i} ${n} ${r} = u_${r};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${r}\n    ${i} ${n} ${r} = unpack_mix_${a}(a_${r}, u_${r}_t);\n#else\n    ${i} ${n} ${r} = u_${r};\n#endif\n`}),staticAttributes:o,staticUniforms:c}}class Ye{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(t,e,i,n,r,o,a,s){this.context=t;let l=this.boundPaintVertexBuffers.length!==n.length;for(let t=0;!l&&t<n.length;t++)this.boundPaintVertexBuffers[t]!==n[t]&&(l=!0);t.extVertexArrayObject&&this.vao&&this.boundProgram===e&&this.boundLayoutVertexBuffer===i&&!l&&this.boundIndexBuffer===r&&this.boundVertexOffset===o&&this.boundDynamicVertexBuffer===a&&this.boundDynamicVertexBuffer2===s?(t.bindVertexArrayOES.set(this.vao),a&&a.bind(),r&&r.dynamicDraw&&r.bind(),s&&s.bind()):this.freshBind(e,i,n,r,o,a,s)}freshBind(t,e,i,n,r,o,a){let s;const l=t.numAttributes,c=this.context,h=c.gl;if(c.extVertexArrayObject)this.vao&&this.destroy(),this.vao=c.extVertexArrayObject.createVertexArrayOES(),c.bindVertexArrayOES.set(this.vao),s=0,this.boundProgram=t,this.boundLayoutVertexBuffer=e,this.boundPaintVertexBuffers=i,this.boundIndexBuffer=n,this.boundVertexOffset=r,this.boundDynamicVertexBuffer=o,this.boundDynamicVertexBuffer2=a;else{s=c.currentNumAttributes||0;for(let t=l;t<s;t++)h.disableVertexAttribArray(t)}e.enableAttributes(h,t);for(const e of i)e.enableAttributes(h,t);o&&o.enableAttributes(h,t),a&&a.enableAttributes(h,t),e.bind(),e.setVertexAttribPointers(h,t,r);for(const e of i)e.bind(),e.setVertexAttribPointers(h,t,r);o&&(o.bind(),o.setVertexAttribPointers(h,t,r)),n&&n.bind(),a&&(a.bind(),a.setVertexAttribPointers(h,t,r)),c.currentNumAttributes=l}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function $e(e,i){const n=Math.pow(2,i.canonical.z),r=i.canonical.y;return[new t.MercatorCoordinate(0,r/n).toLngLat().lat,new t.MercatorCoordinate(0,(r+1)/n).toLngLat().lat]}function Je(e,i,n,r,o,a,s){const l=e.context,c=l.gl,h=n.fbo;if(!h)return;e.prepareDrawTile(i);const u=e.useProgram("hillshade");l.activeTexture.set(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,h.colorAttachment.get());const d=((t,e,i,n)=>{const r=i.paint.get("hillshade-shadow-color"),o=i.paint.get("hillshade-highlight-color"),a=i.paint.get("hillshade-accent-color");let s=i.paint.get("hillshade-illumination-direction")*(Math.PI/180);"viewport"===i.paint.get("hillshade-illumination-anchor")&&(s-=t.transform.angle);const l=!t.options.moving;return{u_matrix:n||t.transform.calculateProjMatrix(e.tileID.toUnwrapped(),l),u_image:0,u_latrange:$e(0,e.tileID),u_light:[i.paint.get("hillshade-exaggeration"),s],u_shadow:r,u_highlight:o,u_accent:a}})(e,n,r,e.terrain?i.projMatrix:null);e.prepareDrawProgram(l,u,i.toUnwrapped());const{tileBoundsBuffer:p,tileBoundsIndexBuffer:f,tileBoundsSegments:m}=e.getTileBoundsBuffers(n);u.draw(l,c.TRIANGLES,o,a,s,t.CullFaceMode.disabled,d,r.id,p,f,m)}function Ke(e,i,n){if(!i.needsDEMTextureUpload)return;const r=e.context,o=r.gl;r.pixelStoreUnpackPremultiplyAlpha.set(!1),i.demTexture=i.demTexture||e.getTileTexture(n.stride);const a=n.getPixels();i.demTexture?i.demTexture.update(a,{premultiply:!1}):i.demTexture=new t.Texture(r,a,o.RGBA,{premultiply:!1}),i.needsDEMTextureUpload=!1}function Qe(e,i,n,r,o,a){const s=e.context,l=s.gl;if(!i.dem)return;const c=i.dem;if(s.activeTexture.set(l.TEXTURE1),Ke(e,i,c),!i.demTexture)return;i.demTexture.bind(l.NEAREST,l.CLAMP_TO_EDGE);const h=c.dim;s.activeTexture.set(l.TEXTURE0);let u=i.fbo;if(!u){const e=new t.Texture(s,{width:h,height:h,data:null},l.RGBA);e.bind(l.LINEAR,l.CLAMP_TO_EDGE),u=i.fbo=s.createFramebuffer(h,h,!0),u.colorAttachment.set(e.texture)}s.bindFramebuffer.set(u.framebuffer),s.viewport.set([0,0,h,h]);const{tileBoundsBuffer:d,tileBoundsIndexBuffer:p,tileBoundsSegments:f}=e.getMercatorTileBoundsBuffers();e.useProgram("hillshadePrepare").draw(s,l.TRIANGLES,r,o,a,t.CullFaceMode.disabled,((e,i)=>{const n=i.stride,r=t.create();return t.ortho(r,0,t.EXTENT,-t.EXTENT,0,0,1),t.translate(r,r,[0,-t.EXTENT,0]),{u_matrix:r,u_image:1,u_dimension:[n,n],u_zoom:e.overscaledZ,u_unpack:i.unpackVector}})(i.tileID,c),n.id,d,p,f),i.needsHillshadePrepare=!1}const ti=(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_image0:new t.Uniform1i(e,i.u_image0),u_skirt_height:new t.Uniform1f(e,i.u_skirt_height)}),ei=(t,e)=>({u_matrix:t,u_image0:0,u_skirt_height:e}),ii=(t,e,i,n,r)=>({u_proj_matrix:Float32Array.from(t),u_globe_matrix:e,u_merc_matrix:i,u_zoom_transition:n,u_merc_center:r,u_image0:0});function ni(t,e){return null!=t&&null!=e&&!(!t.hasData()||!e.hasData())&&null!=t.demTexture&&null!=e.demTexture&&t.tileID.key!==e.tileID.key}const ri=new class{constructor(){this.operations={}}newMorphing(t,e,i,n,r){if(t in this.operations){const e=this.operations[t];e.to.tileID.key!==i.tileID.key&&(e.queued=i)}else this.operations[t]={startTime:n,phase:0,duration:r,from:e,to:i,queued:null}}getMorphValuesForProxy(t){if(!(t in this.operations))return null;const e=this.operations[t];return{from:e.from,to:e.to,phase:e.phase}}update(t){for(const e in this.operations){const i=this.operations[e];for(i.phase=(t-i.startTime)/i.duration;i.phase>=1||!this._validOp(i);)if(!this._nextOp(i,t)){delete this.operations[e];break}}}_nextOp(t,e){return!!t.queued&&(t.from=t.to,t.to=t.queued,t.queued=null,t.phase=0,t.startTime=e,!0)}_validOp(t){return t.from.hasData()&&t.to.hasData()}},oi={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function ai(t,e){const i=1<<t.z;return!e&&(0===t.x||t.x===i-1)||0===t.y||t.y===i-1}const si=t=>({u_matrix:t});function li(e,i,n,r,o){if(o>0){const a=t.exported.now(),s=(a-e.timeAdded)/o,l=i?(a-i.timeAdded)/o:-1,c=n.getSource(),h=r.coveringZoomLevel({tileSize:c.tileSize,roundZoom:c.roundZoom}),u=!i||Math.abs(i.tileID.overscaledZ-h)>Math.abs(e.tileID.overscaledZ-h),d=u&&e.refreshedUponExpiration?1:t.clamp(u?s:1-l,0,1);return e.refreshedUponExpiration&&s>=1&&(e.refreshedUponExpiration=!1),i?{opacity:1,mix:1-d}:{opacity:d,mix:0}}return{opacity:1,mix:0}}class ci extends t.SourceCache{constructor(t){const e={type:"raster-dem",maxzoom:t.transform.maxZoom},i=new S(Rt(),null),n=Mt("mock-dem",e,i,t.style);super("mock-dem",n,!1),n.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,e){t.state="loaded",e(null)}}class hi extends t.SourceCache{constructor(t){const e=Mt("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new S(Rt(),null),t.style);super("proxy",e,!1),e.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(e,i,n){if(e.freezeTileCoverage)return;this.transform=e;const r=e.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((i,n)=>{if(i[n.key]="",!this._tiles[n.key]){const i=new t.Tile(n,this._source.tileSize*n.overscaleFactor(),e.tileZoom);i.state="loaded",this._tiles[n.key]=i}return i},{});for(const t in this._tiles)t in r||(this.freeFBO(t),this._tiles[t].unloadVectorData(),delete this._tiles[t])}freeFBO(t){const e=this.proxyCachedFBO[t];if(void 0!==e){const i=Object.values(e);this.renderCachePool.push(...i),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class ui extends t.OverscaledTileID{constructor(t,e,i){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=e,this.projMatrix=i}}class di extends t.Elevation{constructor(e,i){super(),this.painter=e,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[n,r,o]=function(e){const i=new t.StructArrayLayout4i8,n=new t.StructArrayLayout3ui6,r=131;i.reserve(17161),n.reserve(33800);const o=t.EXTENT/128,a=t.EXTENT+o/2,s=a+o;for(let e=-o;e<s;e+=o)for(let n=-o;n<s;n+=o){const r=n<0||n>a||e<0||e>a?24575:0,o=t.clamp(Math.round(n),0,t.EXTENT),s=t.clamp(Math.round(e),0,t.EXTENT);i.emplaceBack(o+r,s,o,s)}const l=(t,e)=>{const i=e*r+t;n.emplaceBack(i+1,i,i+r),n.emplaceBack(i+r,i+r+1,i+1)};for(let t=1;t<129;t++)for(let e=1;e<129;e++)l(e,t);return[0,129].forEach(t=>{for(let e=0;e<130;e++)l(e,t),l(t,e)}),[i,n,32768]}(),a=e.context;this.gridBuffer=a.createVertexBuffer(n,t.boundsAttributes.members),this.gridIndexBuffer=a.createIndexBuffer(r),this.gridSegments=t.SegmentVector.simpleSegment(0,0,n.length,r.length),this.gridNoSkirtSegments=t.SegmentVector.simpleSegment(0,0,n.length,o),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new hi(i.map),this.orthoMatrix=t.create(),t.ortho(this.orthoMatrix,0,t.EXTENT,0,t.EXTENT,0,1);const s=a.gl;this._overlapStencilMode=new t.StencilMode({func:s.GEQUAL,mask:255},0,255,s.KEEP,s.KEEP,s.REPLACE),this._previousZoom=e.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=i,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new ci(i.map)}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),t.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=t,this._checkRenderCacheEfficiency()}update(e,i,n){if(e&&e.terrain){this._style!==e&&(this.style=e),this.enabled=!0;const r=e.terrain.properties;this.sourceCache=0===e.terrain.drapeRenderMode?this._mockSourceCache:e._getSourceCache(r.get("source")),this._exaggeration=r.get("exaggeration");const o=()=>{this.sourceCache.used&&t.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const e=this.getScaledDemTileSize();this.sourceCache.update(i,e,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,o(),this._initializing=!0),o(),i.updateElevation(!n),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(i),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const e=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||100!==e.efficiency&&t.warnOnce(`Terrain render cache efficiency is not optimal (${e.efficiency}%) and performance\n                may be affected negatively, consider placing all background, fill and line layers before layer\n                with id '${e.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(t){t.coord&&"source"===t.dataType?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):"style"===t.dataType&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._sourceCaches)this._style._sourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture)}_source(){return this.enabled?this.sourceCache:null}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(e){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const i=this.proxySourceCache,n=this.painter.transform;this._initializing&&(this._initializing=0===n._centerAltitude&&-1===this.getAtPointOrZero(t.MercatorCoordinate.fromLngLat(n.center),-1),this._emptyDEMTextureDirty=!this._initializing);const r=this.proxyCoords=i.getIds().map(t=>{const e=i.getTileByID(t).tileID;return e.projMatrix=n.calculateProjMatrix(e.toUnwrapped()),e});!function(e,i){const n=i.transform.pointCoordinate(i.transform.getCameraPoint()),r=new t.pointGeometry(n.x,n.y);e.sort((e,i)=>{if(i.overscaledZ-e.overscaledZ)return i.overscaledZ-e.overscaledZ;const n=new t.pointGeometry(e.canonical.x+(1<<e.canonical.z)*e.wrap,e.canonical.y),o=new t.pointGeometry(i.canonical.x+(1<<i.canonical.z)*i.wrap,i.canonical.y),a=r.mult(1<<e.canonical.z);return a.x-=.5,a.y-=.5,a.distSqr(n)-a.distSqr(o)})}(r,this.painter),this._previousZoom=n.zoom;const o=this.proxyToSource||{};this.proxyToSource={},r.forEach(t=>{this.proxyToSource[t.key]={}}),this.terrainTileForTile={};const a=this._style._sourceCaches;for(const t in a){const i=a[t];if(!i.used)continue;if(i!==this.sourceCache&&this.resetTileLookupCache(i.id),this._setupProxiedCoordsForOrtho(i,e[t],o),i.usedForTerrain)continue;const n=e[t];i.getSource().reparseOverscaled&&this._assignTerrainTiles(n)}this.proxiedCoords[i.id]=r.map(t=>new ui(t,t.key,this.orthoMatrix)),this._assignTerrainTiles(r),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(o),this.renderingToTexture=!1,this._updateTimestamp=t.exported.now();const s={};this._visibleDemTiles=[];for(const t of this.proxyCoords){const e=this.terrainTileForTile[t.key];if(!e)continue;const i=e.tileID.key;i in s||(this._visibleDemTiles.push(e),s[i]=i)}}_assignTerrainTiles(t){this._initializing||t.forEach(t=>{if(this.terrainTileForTile[t.key])return;const e=this._findTileCoveringTileID(t,this.sourceCache);e&&(this.terrainTileForTile[t.key]=e)})}_prepareDEMTextures(){const t=this.painter.context,e=t.gl;for(const i in this.terrainTileForTile){const n=this.terrainTileForTile[i],r=n.dem;!r||n.demTexture&&!n.needsDEMTextureUpload||(t.activeTexture.set(e.TEXTURE1),Ke(this.painter,n,r))}}_prepareDemTileUniforms(t,e,i,n){if(!e||null==e.demTexture)return!1;const r=t.tileID.canonical,o=Math.pow(2,e.tileID.canonical.z-r.z),a=n||"";return i["u_dem_tl"+a]=[r.x*o%1,r.y*o%1],i["u_dem_scale"+a]=o,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const e=this.painter.context,i=e.gl;if(!this._emptyDepthBufferTexture){const n={width:1,height:1,data:new Uint8Array([255,255,255,255])};this._emptyDepthBufferTexture=new t.Texture(e,n,i.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let t=0;const e=this._visibleDemTiles.reduce((e,i)=>{if(!i.dem)return e;const n=i.dem.tree.minimums[0];return n>0&&t++,e+n},0);return t?e/t:0}_updateEmptyDEMTexture(){const e=this.painter.context,i=e.gl;e.activeTexture.set(i.TEXTURE2);const n=this._getLoadedAreaMinimum(),r={width:1,height:1,data:new Uint8Array(t.DEMData.pack(n,this.sourceCache.getSource().encoding))};this._emptyDEMTextureDirty=!1;let o=this._emptyDEMTexture;return o?o.update(r,{premultiply:!1}):o=this._emptyDEMTexture=new t.Texture(e,r,i.RGBA,{premultiply:!1}),o}setupElevationDraw(e,i,n){const r=this.painter.context,o=r.gl,a=(s=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:t.DEMData.getUnpackVector(s),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0,u_tile_tl_up:[0,0,1],u_tile_tr_up:[0,0,1],u_tile_br_up:[0,0,1],u_tile_bl_up:[0,0,1],u_tile_up_scale:1});var s;a.u_dem_size=this.sourceCache.getSource().tileSize,a.u_exaggeration=this.exaggeration();const l=this.painter.transform,c=l.projection.createTileTransform(l,l.worldSize),h=e.tileID.canonical;a.u_tile_tl_up=c.upVector(h,0,0),a.u_tile_tr_up=c.upVector(h,t.EXTENT,0),a.u_tile_br_up=c.upVector(h,t.EXTENT,t.EXTENT),a.u_tile_bl_up=c.upVector(h,0,t.EXTENT),a.u_tile_up_scale=c.upVectorScale(h);let u=null,d=null,p=1;if(n&&n.morphing&&this._useVertexMorphing){const t=n.morphing.srcDemTile,i=n.morphing.dstDemTile;p=n.morphing.phase,t&&i&&(this._prepareDemTileUniforms(e,t,a,"_prev")&&(d=t),this._prepareDemTileUniforms(e,i,a)&&(u=i))}if(d&&u?(r.activeTexture.set(o.TEXTURE2),u.demTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE,o.NEAREST),r.activeTexture.set(o.TEXTURE4),d.demTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE,o.NEAREST),a.u_dem_lerp=p):(u=this.terrainTileForTile[e.tileID.key],r.activeTexture.set(o.TEXTURE2),(this._prepareDemTileUniforms(e,u,a)?u.demTexture:this.emptyDEMTexture).bind(o.NEAREST,o.CLAMP_TO_EDGE)),r.activeTexture.set(o.TEXTURE3),n&&n.useDepthForOcclusion?(this._depthTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE),a.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height]):(this.emptyDepthBufferTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE),a.u_depth_size_inv=[1,1]),n&&n.useMeterToDem&&u){const e=(1<<u.tileID.canonical.z)*t.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;a.u_meter_to_dem=e}n&&n.labelPlaneMatrixInv&&(a.u_label_plane_matrix_inv=n.labelPlaneMatrixInv),i.setTerrainUniformValues(r,a)}renderToBackBuffer(e){const i=this.painter,n=this.painter.context;0!==e.length&&(n.bindFramebuffer.set(null),n.viewport.set([0,0,i.width,i.height]),this.renderingToTexture=!1,function(e,i,n,r,o){if("globe"===e.transform.projection.name)!function(e,i,n,r,o){const a=e.context,s=a.gl;let l,c;const h=e.options.showTerrainWireframe?2:0,u=(t,i)=>{if(c===t)return;const n=[];i&&n.push(oi[h]),n.push(oi[t]),n.push("PROJECTION_GLOBE_VIEW"),l=e.useProgram("globeRaster",null,n),c=t},d=e.colorModeForRenderPass(),p=new t.DepthMode(s.LEQUAL,t.DepthMode.ReadWrite,e.depthRangeFor3D);ri.update(o);const f=e.transform,m=t.calculateGlobeMatrix(f,f.worldSize),g=t.calculateGlobeMercatorMatrix(f),y=[t.mercatorXfromLng(f.center.lng),t.mercatorYfromLat(f.center.lat)],_=e.globeSharedBuffers;(h?[!1,!0]:[!1]).forEach(h=>{c=-1;const v=h?s.LINES:s.TRIANGLES;for(const c of r){const r=n.getTile(c),x=Math.pow(2,c.canonical.z),[b,w]=t.globeBuffersForTileMesh(e,r,c,x),M=t.StencilMode.disabled,T=i.prevTerrainTileForTile[c.key],S=i.terrainTileForTile[c.key];ni(T,S)&&ri.newMorphing(c.key,T,S,o,250),a.activeTexture.set(s.TEXTURE0),r.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE);const E=ri.getMorphValuesForProxy(c.key),C=E?1:0,A={};E&&t.extend$1(A,{morphing:{srcDemTile:E.from,dstDemTile:E.to,phase:t.easeCubicInOut(E.phase)}});const P=t.globeMatrixForTile(c.canonical,m),L=ii(f.projMatrix,P,g,t.globeToMercatorTransition(f.zoom),y);if(u(C,h),i.setupElevationDraw(r,l,A),e.prepareDrawProgram(a,l,c.toUnwrapped()),_){const[i,n]=h?_.getWirefameBuffer(e.context):[_.gridIndexBuffer,_.gridSegments];l.draw(a,v,p,M,d,t.CullFaceMode.backCCW,L,"globe_raster",b,i,n)}if(!h){const e=[0===c.canonical.y?t.globePoleMatrixForTile(c.canonical,!1,f):null,c.canonical.y===x-1?t.globePoleMatrixForTile(c.canonical,!0,f):null];for(const i of e){if(!i)continue;const e=ii(f.projMatrix,i,i,0,y);_&&l.draw(a,v,p,M,d,t.CullFaceMode.disabled,e,"globe_pole_raster",w,_.poleIndexBuffer,_.poleSegments)}}}})}(e,i,n,r,o);else{const a=e.context,s=a.gl;let l,c;const h=e.options.showTerrainWireframe?2:0,u=(t,i)=>{if(c===t)return;const n=[oi[t]];i&&n.push(oi[h]),l=e.useProgram("terrainRaster",null,n),c=t},d=e.colorModeForRenderPass(),p=new t.DepthMode(s.LEQUAL,t.DepthMode.ReadWrite,e.depthRangeFor3D);ri.update(o);const f=e.transform,m=6*Math.pow(1.5,22-f.zoom)*i.exaggeration();(h?[!1,!0]:[!1]).forEach(h=>{c=-1;const g=h?s.LINES:s.TRIANGLES,[y,_]=h?i.getWirefameBuffer():[i.gridIndexBuffer,i.gridSegments];for(const c of r){const r=n.getTile(c),v=t.StencilMode.disabled,x=i.prevTerrainTileForTile[c.key],b=i.terrainTileForTile[c.key];ni(x,b)&&ri.newMorphing(c.key,x,b,o,250),a.activeTexture.set(s.TEXTURE0),r.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE,s.LINEAR_MIPMAP_NEAREST);const w=ri.getMorphValuesForProxy(c.key),M=w?1:0;let T;w&&(T={morphing:{srcDemTile:w.from,dstDemTile:w.to,phase:t.easeCubicInOut(w.phase)}});const S=ei(c.projMatrix,ai(c.canonical,f.renderWorldCopies)?m/10:m);u(M,h),i.setupElevationDraw(r,l,T),e.prepareDrawProgram(a,l,c.toUnwrapped()),l.draw(a,g,p,v,d,t.CullFaceMode.backCCW,S,"terrain_raster",i.gridBuffer,y,_)}})}}(i,this,this.proxySourceCache,e,this._updateTimestamp),this.renderingToTexture=!0,e.splice(0,e.length))}renderBatch(e){if(0===this._drapedRenderBatches.length)return e+1;this.renderingToTexture=!0;const i=this.painter,n=this.painter.context,r=this.proxySourceCache,o=this.proxiedCoords[r.id],a=this._drapedRenderBatches.shift(),s=[],l=i.style.order;let c=0;for(const h of o){const o=r.getTileByID(h.proxyTileKey),u=r.proxyCachedFBO[h.key]?r.proxyCachedFBO[h.key][e]:void 0,d=void 0!==u?r.renderCache[u]:this.pool[c++],p=void 0!==u;if(o.texture=d.tex,p&&!d.dirty){s.push(o.tileID);continue}let f;n.bindFramebuffer.set(d.fb.framebuffer),this.renderedToTile=!1,d.dirty&&(n.clear({color:t.Color.transparent,stencil:0}),d.dirty=!1);for(let t=a.start;t<=a.end;++t){const e=i.style._layers[l[t]];if(e.isHidden(i.transform.zoom))continue;const r=i.style._getLayerSourceCache(e),o=r?this.proxyToSource[h.key][r.id]:[h];if(!o)continue;const a=o;n.viewport.set([0,0,d.fb.width,d.fb.height]),f!==(r?r.id:null)&&(this._setupStencil(d,o,e,r),f=r?r.id:null),i.renderLayer(i,r,e,a)}this.renderedToTile?(d.dirty=!0,s.push(o.tileID)):p||--c,5===c&&(c=0,this.renderToBackBuffer(s))}return this.renderToBackBuffer(s),this.renderingToTexture=!1,n.bindFramebuffer.set(null),n.viewport.set([0,0,i.width,i.height]),a.end+1}postRender(){}renderCacheEfficiency(t){const e=t.order.length;if(0===e)return{efficiency:100};let i,n=0,r=0,o=!1;for(let a=0;a<e;++a){const e=t._layers[t.order[a]];this._style.isLayerDraped(e)?(o&&++n,++r):o||(o=!0,i=e.id)}return 0===r?{efficiency:100}:{efficiency:100*(1-n/r),firstUndrapedLayer:i}}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(t=>t.dem).forEach(e=>{t=Math.min(t,e.dem.tree.minimums[0])}),0===t?t:(t-30)*this._exaggeration}raycast(t,e,i){if(!this._visibleDemTiles)return null;const n=this._visibleDemTiles.filter(t=>t.dem).map(n=>{const r=n.tileID,o=Math.pow(2,r.overscaledZ),{x:a,y:s}=r.canonical,l=a/o,c=(a+1)/o,h=s/o,u=(s+1)/o;return{minx:l,miny:h,maxx:c,maxy:u,t:n.dem.tree.raycastRoot(l,h,c,u,t,e,i),tile:n}});n.sort((t,e)=>(null!==t.t?t.t:Number.MAX_VALUE)-(null!==e.t?e.t:Number.MAX_VALUE));for(const r of n){if(null==r.t)return null;const n=r.tile.dem.tree.raycast(r.minx,r.miny,r.maxx,r.maxy,t,e,i);if(null!=n)return n}return null}_createFBO(){const e=this.painter.context,i=e.gl,n=this.drapeBufferSize;e.activeTexture.set(i.TEXTURE0);const r=new t.Texture(e,{width:n[0],height:n[1],data:null},i.RGBA);r.bind(i.LINEAR,i.CLAMP_TO_EDGE);const o=e.createFramebuffer(n[0],n[1],!1);return o.colorAttachment.set(r.texture),o.depthAttachment=new ut(e,o.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=e.createRenderbuffer(e.gl.DEPTH_STENCIL,n[0],n[1]),this._stencilRef=0,o.depthAttachment.set(this._sharedDepthStencil),e.clear({stencil:0})):o.depthAttachment.set(this._sharedDepthStencil),e.extTextureFilterAnisotropic&&!e.extTextureFilterAnisotropicForceOff&&i.texParameterf(i.TEXTURE_2D,e.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e.extTextureFilterAnisotropicMax),{fb:o,tex:r,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const t in this._style._sourceCaches)if(this._style._sourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const e=this._style._layers[t],i=e.isHidden(this.painter.transform.zoom),n=e.getCrossfadeParameters(),r=!!n&&1!==n.t,o=e.hasTransition();return"custom"!==e.type&&!i&&(r||o)})}_clearRasterFadeFromRenderCache(){let t=!1;for(const e in this._style._sourceCaches)if(this._style._sourceCaches[e]._source instanceof _t){t=!0;break}if(t)for(let t=0;t<this._style.order.length;++t){const e=this._style._layers[this._style.order[t]],i=e.isHidden(this.painter.transform.zoom),n=this._style._getLayerSourceCache(e);if("raster"!==e.type||i||!n)continue;const r=e.paint.get("raster-fade-duration");for(const t of this.proxyCoords){const e=this.proxyToSource[t.key][n.id];if(e)for(const t of e){const e=li(n.getTile(t),n.findLoadedParent(t,0),n,this.painter.transform,r);(1!==e.opacity||0!==e.mix)&&this._clearRenderCacheForTile(n.id,t)}}}}_setupDrapedRenderBatches(){const t=this._style.order,e=t.length;if(0===e)return;const i=[];let n,r=0,o=this._style._layers[t[r]];for(;!this._style.isLayerDraped(o)&&o.isHidden(this.painter.transform.zoom)&&++r<e;)o=this._style._layers[t[r]];for(;r<e;++r){const e=this._style._layers[t[r]];e.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(e)?void 0===n&&(n=r):void 0!==n&&(i.push({start:n,end:r-1}),n=void 0))}void 0!==n&&i.push({start:n,end:r-1}),this._drapedRenderBatches=i}_setupRenderCache(t){const e=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,e.renderCache.length>e.renderCachePool.length){const t=Object.values(e.proxyCachedFBO);e.proxyCachedFBO={};for(let i=0;i<t.length;++i){const n=Object.values(t[i]);e.renderCachePool.push(...n)}}return}this._clearRasterFadeFromRenderCache();const i=this.proxyCoords,n=this._tilesDirty;for(let r=i.length-1;r>=0;r--){const o=i[r];if(e.getTileByID(o.key),void 0!==e.proxyCachedFBO[o.key]){const i=t[o.key],r=this.proxyToSource[o.key];let a=0;for(const t in r){const e=r[t],o=i[t];if(!o||o.length!==e.length||e.some((e,i)=>e!==o[i]||n[t]&&n[t].hasOwnProperty(e.key))){a=-1;break}++a}for(const t in e.proxyCachedFBO[o.key])e.renderCache[e.proxyCachedFBO[o.key][t]].dirty=a<0||a!==Object.values(i).length}}const r=[...this._drapedRenderBatches];r.sort((t,e)=>e.end-e.start-(t.end-t.start));for(const t of r)for(const n of i){if(e.proxyCachedFBO[n.key])continue;let i=e.renderCachePool.pop();void 0===i&&e.renderCache.length<50&&(i=e.renderCache.length,e.renderCache.push(this._createFBO())),void 0!==i&&(e.proxyCachedFBO[n.key]={},e.proxyCachedFBO[n.key][t.start]=i,e.renderCache[i].dirty=!0)}this._tilesDirty={}}_setupStencil(t,e,i,n){if(!n||!this._sourceTilesOverlap[n.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const r=this.painter.context,o=r.gl;if(e.length<=1)return void(this._overlapStencilType=!1);let a;if(i.isTileClipped())a=e.length,this._overlapStencilMode.test={func:o.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(e[0].overscaledZ>e[e.length-1].overscaledZ))return void(this._overlapStencilType=!1);a=1,this._overlapStencilMode.test={func:o.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+a>255&&(r.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=a,this._overlapStencilMode.ref=this._stencilRef,i.isTileClipped()&&this._renderTileClippingMasks(e,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(e){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[e.key]),this._overlapStencilMode):t.StencilMode.disabled}_renderTileClippingMasks(e,i){const n=this.painter,r=this.painter.context,o=r.gl;n._tileClippingMaskIDs={},r.setColorMode(t.ColorMode.disabled),r.setDepthMode(t.DepthMode.disabled);const a=n.useProgram("clippingMask");for(const s of e){const e=n._tileClippingMaskIDs[s.key]=--i;a.draw(r,o.TRIANGLES,t.DepthMode.disabled,new t.StencilMode({func:o.ALWAYS,mask:0},e,255,o.KEEP,o.KEEP,o.REPLACE),t.ColorMode.disabled,t.CullFaceMode.disabled,si(s.projMatrix),"$clipping",n.tileExtentBuffer,n.quadTriangleIndexBuffer,n.tileExtentSegments)}}pointCoordinate(e){const i=this.painter.transform;if(e.x<0||e.x>i.width||e.y<0||e.y>i.height)return null;const n=[e.x,e.y,1,1];t.transformMat4$1(n,n,i.pixelMatrixInverse),t.scale$1(n,n,1/n[3]),n[0]/=i.worldSize,n[1]/=i.worldSize;const r=i._camera.position,o=t.mercatorZfromAltitude(1,i.center.lat),a=[r[0],r[1],r[2]/o,0],s=t.subtract([],n.slice(0,3),a);t.normalize(s,s);const l=this.raycast(a,s,this._exaggeration);return null!==l&&l?(t.scaleAndAdd(a,a,s,l),a[3]=a[2],a[2]*=o,a):null}drawDepth(){const e=this.painter,i=e.context,n=this.proxySourceCache,r=Math.ceil(e.width),o=Math.ceil(e.height);if(!this._depthFBO||this._depthFBO.width===r&&this._depthFBO.height===o||(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture),!this._depthFBO){const e=i.gl,n=i.createFramebuffer(r,o,!0);i.activeTexture.set(e.TEXTURE0);const a=new t.Texture(i,{width:r,height:o,data:null},e.RGBA);a.bind(e.NEAREST,e.CLAMP_TO_EDGE),n.colorAttachment.set(a.texture);const s=i.createRenderbuffer(i.gl.DEPTH_COMPONENT16,r,o);n.depthAttachment.set(s),this._depthFBO=n,this._depthTexture=a}i.bindFramebuffer.set(this._depthFBO.framebuffer),i.viewport.set([0,0,r,o]),function(e,i,n,r){if("globe"===e.transform.projection.name)return;const o=e.context,a=o.gl;o.clear({depth:1});const s=e.useProgram("terrainDepth"),l=new t.DepthMode(a.LESS,t.DepthMode.ReadWrite,e.depthRangeFor3D);for(const e of r){const r=n.getTile(e),c=ei(e.projMatrix,0);i.setupElevationDraw(r,s),s.draw(o,a.TRIANGLES,l,t.StencilMode.disabled,t.ColorMode.unblended,t.CullFaceMode.backCCW,c,"terrain_depth",i.gridBuffer,i.gridIndexBuffer,i.gridNoSkirtSegments)}}(e,this,n,this.proxyCoords)}_setupProxiedCoordsForOrtho(t,e,i){if(t.getSource()instanceof bt)return this._setupProxiedCoordsForImageSource(t,e,i);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const n=this.proxiedCoords[t.id]=[],r=this.proxyCoords;for(let e=0;e<r.length;e++){const o=r[e],a=this._findTileCoveringTileID(o,t);if(a){const e=this._createProxiedId(o,a,i[o.key]&&i[o.key][t.id]);n.push(e),this.proxyToSource[o.key][t.id]=[e]}}let o=!1;for(let r=0;r<e.length;r++){const a=t.getTile(e[r]);if(!a||!a.hasData())continue;const s=this._findTileCoveringTileID(a.tileID,this.proxySourceCache);if(s&&s.tileID.canonical.z!==a.tileID.canonical.z){const e=this.proxyToSource[s.tileID.key][t.id],r=this._createProxiedId(s.tileID,a,i[s.tileID.key]&&i[s.tileID.key][t.id]);e?e.splice(e.length-1,0,r):this.proxyToSource[s.tileID.key][t.id]=[r],n.push(r),o=!0}}this._sourceTilesOverlap[t.id]=o}_setupProxiedCoordsForImageSource(e,i,n){if(!e.getSource().loaded())return;const r=this.proxiedCoords[e.id]=[],o=this.proxyCoords,a=e.getSource(),s=new t.pointGeometry(a.tileID.x,a.tileID.y)._div(1<<a.tileID.z),l=a.coordinates.map(t.MercatorCoordinate.fromLngLat).reduce((t,e)=>(t.min.x=Math.min(t.min.x,e.x-s.x),t.min.y=Math.min(t.min.y,e.y-s.y),t.max.x=Math.max(t.max.x,e.x-s.x),t.max.y=Math.max(t.max.y,e.y-s.y),t),{min:new t.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new t.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),c=(e,i)=>{const n=e.wrap+e.canonical.x/(1<<e.canonical.z),r=e.canonical.y/(1<<e.canonical.z),o=t.EXTENT/(1<<e.canonical.z),a=i.wrap+i.canonical.x/(1<<i.canonical.z),s=i.canonical.y/(1<<i.canonical.z);return n+o<a+l.min.x||n>a+l.max.x||r+o<s+l.min.y||r>s+l.max.y};for(let t=0;t<o.length;t++){const a=o[t];for(let t=0;t<i.length;t++){const o=e.getTile(i[t]);if(!o||!o.hasData())continue;if(c(a,o.tileID))continue;const s=this._createProxiedId(a,o,n[a.key]&&n[a.key][e.id]),l=this.proxyToSource[a.key][e.id];l?l.push(s):this.proxyToSource[a.key][e.id]=[s],r.push(s)}}}_createProxiedId(e,i,n){let r=this.orthoMatrix;if(n){const t=n.find(t=>t.key===i.tileID.key);if(t)return t}if(i.tileID.key!==e.key){const n=e.canonical.z-i.tileID.canonical.z;let o,a,s;r=t.create();const l=i.tileID.wrap-e.wrap<<e.overscaledZ;n>0?(o=t.EXTENT>>n,a=o*((i.tileID.canonical.x<<n)-e.canonical.x+l),s=o*((i.tileID.canonical.y<<n)-e.canonical.y)):(o=t.EXTENT<<-n,a=t.EXTENT*(i.tileID.canonical.x-(e.canonical.x+l<<-n)),s=t.EXTENT*(i.tileID.canonical.y-(e.canonical.y<<-n))),t.ortho(r,0,o,0,o,0,1),t.translate(r,r,[a,s,0])}return new ui(i.tileID,e.key,r)}_findTileCoveringTileID(e,i){let n=i.getTile(e);if(n&&n.hasData())return n;const r=this._findCoveringTileCache[i.id],o=r[e.key];if(n=o?i.getTileByID(o):null,n&&n.hasData()||null===o)return n;let a=n?n.tileID:e,s=a.overscaledZ;const l=i.getSource().minzoom,c=[];if(!o){const r=i.getSource().maxzoom;if(e.canonical.z>=r){const n=e.canonical.z-r;i.getSource().reparseOverscaled?(s=Math.max(e.canonical.z+2,i.transform.tileZoom),a=new t.OverscaledTileID(s,e.wrap,r,e.canonical.x>>n,e.canonical.y>>n)):0!==n&&(s=r,a=new t.OverscaledTileID(s,e.wrap,r,e.canonical.x>>n,e.canonical.y>>n))}a.key!==e.key&&(c.push(a.key),n=i.getTile(a))}const h=t=>{c.forEach(e=>{r[e]=t}),c.length=0};for(s-=1;s>=l&&(!n||!n.hasData());s--){n&&h(n.tileID.key);const t=a.calculateScaledKey(s);if(n=i.getTileByID(t),n&&n.hasData())break;const e=r[t];if(null===e)break;void 0===e?c.push(t):n=i.getTileByID(e)}return h(n?n.tileID.key:null),n&&n.hasData()?n:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(t){this.renderedToTile=!0}_clearRenderCacheForTile(t,e){let i=this._tilesDirty[t];i||(i=this._tilesDirty[t]={}),i[e.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const e=function(e){let i,n,r;const o=new t.StructArrayLayout2ui4,a=131;for(n=1;n<129;n++){for(i=1;i<129;i++)r=n*a+i,o.emplaceBack(r,r+1),o.emplaceBack(r,r+a),o.emplaceBack(r+1,r+a),128===n&&o.emplaceBack(r+a,r+a+1);o.emplaceBack(r+1,r+1+a)}return o}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(e),this.wireframeSegments=t.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,e.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}function pi(t){const e=[];for(let i=0;i<t.length;i++){if(null===t[i])continue;const n=t[i].split(" ");e.push(n.pop())}return e}class fi{static cacheKey(t,e,i){let n=`${t}${i?i.cacheKey:""}`;for(const t of e)n+="/"+t;return n}constructor(e,i,n,r,o,a){const s=e.gl;this.program=s.createProgram();const l=pi(n.staticAttributes),c=r?r.getBinderAttributes():[],h=l.concat(c),u=n.staticUniforms?pi(n.staticUniforms):[],d=r?r.getBinderUniforms():[],p=u.concat(d),f=[];for(const t of p)f.indexOf(t)<0&&f.push(t);let m=r?r.defines():[];m=m.concat(a.map(t=>"#define "+t));const g=m.concat("\n#ifdef GL_ES\nprecision mediump float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif",We,Ze.fragmentSource,He.fragmentSource,n.fragmentSource).join("\n"),y=m.concat("\n#ifdef GL_ES\nprecision highp float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif",We,Ze.vertexSource,He.vertexSource,Ve.vertexSource,n.vertexSource).join("\n"),_=s.createShader(s.FRAGMENT_SHADER);if(s.isContextLost())return void(this.failedToCreate=!0);s.shaderSource(_,g),s.compileShader(_),s.attachShader(this.program,_);const v=s.createShader(s.VERTEX_SHADER);if(s.isContextLost())return void(this.failedToCreate=!0);s.shaderSource(v,y),s.compileShader(v),s.attachShader(this.program,v),this.attributes={};const x={};this.numAttributes=h.length;for(let t=0;t<this.numAttributes;t++)h[t]&&(s.bindAttribLocation(this.program,t,h[t]),this.attributes[h[t]]=t);s.linkProgram(this.program),s.deleteShader(v),s.deleteShader(_);for(let t=0;t<f.length;t++){const e=f[t];if(e&&!x[e]){const t=s.getUniformLocation(this.program,e);t&&(x[e]=t)}}this.fixedUniforms=o(e,x),this.binderUniforms=r?r.getUniforms(e,x):[],-1!==a.indexOf("TERRAIN")&&(this.terrainUniforms=((e,i)=>({u_dem:new t.Uniform1i(e,i.u_dem),u_dem_prev:new t.Uniform1i(e,i.u_dem_prev),u_dem_unpack:new t.Uniform4f(e,i.u_dem_unpack),u_dem_tl:new t.Uniform2f(e,i.u_dem_tl),u_dem_scale:new t.Uniform1f(e,i.u_dem_scale),u_dem_tl_prev:new t.Uniform2f(e,i.u_dem_tl_prev),u_dem_scale_prev:new t.Uniform1f(e,i.u_dem_scale_prev),u_dem_size:new t.Uniform1f(e,i.u_dem_size),u_dem_lerp:new t.Uniform1f(e,i.u_dem_lerp),u_exaggeration:new t.Uniform1f(e,i.u_exaggeration),u_depth:new t.Uniform1i(e,i.u_depth),u_depth_size_inv:new t.Uniform2f(e,i.u_depth_size_inv),u_meter_to_dem:new t.Uniform1f(e,i.u_meter_to_dem),u_label_plane_matrix_inv:new t.UniformMatrix4f(e,i.u_label_plane_matrix_inv),u_tile_tl_up:new t.Uniform3f(e,i.u_tile_tl_up),u_tile_tr_up:new t.Uniform3f(e,i.u_tile_tr_up),u_tile_br_up:new t.Uniform3f(e,i.u_tile_br_up),u_tile_bl_up:new t.Uniform3f(e,i.u_tile_bl_up),u_tile_up_scale:new t.Uniform1f(e,i.u_tile_up_scale)}))(e,x)),-1!==a.indexOf("FOG")&&(this.fogUniforms=((e,i)=>({u_fog_matrix:new t.UniformMatrix4f(e,i.u_fog_matrix),u_fog_range:new t.Uniform2f(e,i.u_fog_range),u_fog_color:new t.Uniform4f(e,i.u_fog_color),u_fog_horizon_blend:new t.Uniform1f(e,i.u_fog_horizon_blend),u_fog_temporal_offset:new t.Uniform1f(e,i.u_fog_temporal_offset)}))(e,x))}setTerrainUniformValues(t,e){if(!this.terrainUniforms)return;const i=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const t in e)i[t].set(e[t])}}setFogUniformValues(t,e){if(!this.fogUniforms)return;const i=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const t in e)i[t].location&&i[t].set(e[t])}}draw(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m){const g=t.gl;if(this.failedToCreate)return;t.program.set(this.program),t.setDepthMode(i),t.setStencilMode(n),t.setColorMode(r),t.setCullFace(o);for(const t of Object.keys(this.fixedUniforms))this.fixedUniforms[t].set(a[t]);p&&p.setUniforms(t,this.binderUniforms,u,{zoom:d});const y={[g.LINES]:2,[g.TRIANGLES]:3,[g.LINE_STRIP]:1}[e];for(const i of h.get()){const n=i.vaos||(i.vaos={});(n[s]||(n[s]=new Ye)).bind(t,this,l,p?p.getPaintVertexBuffers():[],c,i.vertexOffset,f,m),g.drawElements(e,i.primitiveLength*y,g.UNSIGNED_SHORT,i.primitiveOffset*y*2)}}}function mi(t,e,i){const n=1/E(i,1,e.transform.tileZoom),r=Math.pow(2,i.tileID.overscaledZ),o=i.tileSize*Math.pow(2,e.transform.tileZoom)/r,a=o*(i.tileID.canonical.x+i.tileID.wrap*r),s=o*i.tileID.canonical.y;return{u_image:0,u_texsize:i.imageAtlasTexture.size,u_scale:[n,t.fromScale,t.toScale],u_fade:t.t,u_pixel_coord_upper:[a>>16,s>>16],u_pixel_coord_lower:[65535&a,65535&s]}}const gi=(e,i,n,r)=>{const o=i.style.light,a=o.properties.get("position"),s=[a.x,a.y,a.z],l=t.create$1();"viewport"===o.properties.get("anchor")&&(t.fromRotation(l,-i.transform.angle),t.transformMat3(s,s,l));const c=o.properties.get("color");return{u_matrix:e,u_lightpos:s,u_lightintensity:o.properties.get("intensity"),u_lightcolor:[c.r,c.g,c.b],u_vertical_gradient:+n,u_opacity:r}},yi=(e,i,n,r,o,a,s)=>t.extend(gi(e,i,n,r),mi(a,i,s),{u_height_factor:-Math.pow(2,o.overscaledZ)/s.tileSize/8}),_i=t=>({u_matrix:t}),vi=(e,i,n,r)=>t.extend(_i(e),mi(n,i,r)),xi=(t,e)=>({u_matrix:t,u_world:e}),bi=(e,i,n,r,o)=>t.extend(vi(e,i,n,r),{u_world:o}),wi=(e,i,n,r)=>{const o=e.transform;let a;return a="map"===r.paint.get("circle-pitch-alignment")?o.calculatePixelsToTileUnitsMatrix(n):new Float32Array([o.pixelsToGLUnits[0],0,0,o.pixelsToGLUnits[1]]),{u_camera_to_center_distance:o.cameraToCenterDistance,u_matrix:e.translatePosMatrix(i.projMatrix,n,r.paint.get("circle-translate"),r.paint.get("circle-translate-anchor")),u_device_pixel_ratio:t.exported.devicePixelRatio,u_extrude_scale:a}},Mi=t=>{const e=[];return"map"===t.paint.get("circle-pitch-alignment")&&e.push("PITCH_WITH_MAP"),"map"===t.paint.get("circle-pitch-scale")&&e.push("SCALE_WITH_MAP"),e},Ti=(e,i,n)=>{const r=t.EXTENT/n.tileSize;return{u_matrix:e,u_camera_to_center_distance:i.cameraToCenterDistance,u_extrude_scale:[i.pixelsToGLUnits[0]/r,i.pixelsToGLUnits[1]/r]}},Si=(t,e,i=1)=>({u_matrix:t,u_color:e,u_overlay:0,u_overlay_scale:i}),Ei=(t,e,i,n)=>({u_matrix:t,u_extrude_scale:E(e,1,i),u_intensity:n}),Ci=(e,i,n,r,o,a)=>{const s=e.transform,l=s.calculatePixelsToTileUnitsMatrix(i),c={u_matrix:Li(e,i,n,o),u_pixels_to_tile_units:l,u_device_pixel_ratio:t.exported.devicePixelRatio,u_units_to_pixels:[1/s.pixelsToGLUnits[0],1/s.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:a,u_texsize:[0,0],u_scale:[0,0,0],u_mix:0,u_alpha_discard_threshold:0};if(Ii(n)){const t=Pi(i,e.transform);c.u_texsize=i.lineAtlasTexture.size,c.u_scale=[t,r.fromScale,r.toScale],c.u_mix=r.t}return c},Ai=(e,i,n,r,o)=>{const a=e.transform,s=Pi(i,a);return{u_matrix:Li(e,i,n,o),u_texsize:i.imageAtlasTexture.size,u_pixels_to_tile_units:a.calculatePixelsToTileUnitsMatrix(i),u_device_pixel_ratio:t.exported.devicePixelRatio,u_image:0,u_scale:[s,r.fromScale,r.toScale],u_fade:r.t,u_units_to_pixels:[1/a.pixelsToGLUnits[0],1/a.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function Pi(t,e){return 1/E(t,1,e.tileZoom)}function Li(t,e,i,n){return t.translatePosMatrix(n||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}function Ii(t){const e=t.paint.get("line-dasharray").value;return e.value||"constant"!==e.kind}const Ri=(t,e,i,n,r,o)=>{return{u_matrix:t,u_tl_parent:e,u_scale_parent:i,u_fade_t:n.mix,u_opacity:n.opacity*r.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:r.paint.get("raster-brightness-min"),u_brightness_high:r.paint.get("raster-brightness-max"),u_saturation_factor:(s=r.paint.get("raster-saturation"),s>0?1-1/(1.001-s):-s),u_contrast_factor:(a=r.paint.get("raster-contrast"),a>0?1/(1-a):1+a),u_spin_weights:Di(r.paint.get("raster-hue-rotate")),u_perspective_transform:o};var a,s};function Di(t){t*=Math.PI/180;const e=Math.sin(t),i=Math.cos(t);return[(2*i+1)/3,(-Math.sqrt(3)*e-i+1)/3,(Math.sqrt(3)*e-i+1)/3]}const ki=(t,e,i,n,r,o,a,s,l,c,h,u,d,p)=>{const f=r.transform;return{u_is_size_zoom_constant:+("constant"===t||"source"===t),u_is_size_feature_constant:+("constant"===t||"camera"===t),u_size_t:e?e.uSizeT:0,u_size:e?e.uSize:0,u_camera_to_center_distance:f.cameraToCenterDistance,u_pitch:f.pitch/360*2*Math.PI,u_rotate_symbol:+i,u_aspect_ratio:f.width/f.height,u_fade_change:r.options.fadeDuration?r.symbolFadeChange:1,u_matrix:o,u_label_plane_matrix:a,u_coord_matrix:s,u_is_text:+l,u_pitch_with_map:+n,u_texsize:c,u_tile_id:h,u_zoom_transition:u,u_inv_rot_matrix:d,u_merc_center:p,u_texture:0}},Oi=(e,i,n,r,o,a,s,l,c,h,u,d,p,f,m)=>{const{cameraToCenterDistance:g,_pitch:y}=o.transform;return t.extend(ki(e,i,n,r,o,a,s,l,c,h,d,p,f,m),{u_gamma_scale:r?g*Math.cos(o.terrain?0:y):1,u_device_pixel_ratio:t.exported.devicePixelRatio,u_is_halo:+u})},zi=(e,i,n,r,o,a,s,l,c,h,u,d,p,f)=>t.extend(Oi(e,i,n,r,o,a,s,l,!0,c,!0,u,d,p,f),{u_texsize_icon:h,u_texture_icon:1}),Bi=(t,e,i)=>({u_matrix:t,u_opacity:e,u_color:i}),Fi=(e,i,n,r,o,a)=>t.extend(function(t,e,i,n){const r=i.imageManager.getPattern(t.from.toString()),o=i.imageManager.getPattern(t.to.toString()),{width:a,height:s}=i.imageManager.getPixelSize(),l=Math.pow(2,n.tileID.overscaledZ),c=n.tileSize*Math.pow(2,i.transform.tileZoom)/l,h=c*(n.tileID.canonical.x+n.tileID.wrap*l),u=c*n.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:r.tl,u_pattern_br_a:r.br,u_pattern_tl_b:o.tl,u_pattern_br_b:o.br,u_texsize:[a,s],u_mix:e.t,u_pattern_size_a:r.displaySize,u_pattern_size_b:o.displaySize,u_scale_a:e.fromScale,u_scale_b:e.toScale,u_tile_units_to_pixels:1/E(n,1,i.transform.tileZoom),u_pixel_coord_upper:[h>>16,u>>16],u_pixel_coord_lower:[65535&h,65535&u]}}(r,a,n,o),{u_matrix:e,u_opacity:i}),Ni={fillExtrusion:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_lightpos:new t.Uniform3f(e,i.u_lightpos),u_lightintensity:new t.Uniform1f(e,i.u_lightintensity),u_lightcolor:new t.Uniform3f(e,i.u_lightcolor),u_vertical_gradient:new t.Uniform1f(e,i.u_vertical_gradient),u_opacity:new t.Uniform1f(e,i.u_opacity)}),fillExtrusionPattern:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_lightpos:new t.Uniform3f(e,i.u_lightpos),u_lightintensity:new t.Uniform1f(e,i.u_lightintensity),u_lightcolor:new t.Uniform3f(e,i.u_lightcolor),u_vertical_gradient:new t.Uniform1f(e,i.u_vertical_gradient),u_height_factor:new t.Uniform1f(e,i.u_height_factor),u_image:new t.Uniform1i(e,i.u_image),u_texsize:new t.Uniform2f(e,i.u_texsize),u_pixel_coord_upper:new t.Uniform2f(e,i.u_pixel_coord_upper),u_pixel_coord_lower:new t.Uniform2f(e,i.u_pixel_coord_lower),u_scale:new t.Uniform3f(e,i.u_scale),u_fade:new t.Uniform1f(e,i.u_fade),u_opacity:new t.Uniform1f(e,i.u_opacity)}),fill:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix)}),fillPattern:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_image:new t.Uniform1i(e,i.u_image),u_texsize:new t.Uniform2f(e,i.u_texsize),u_pixel_coord_upper:new t.Uniform2f(e,i.u_pixel_coord_upper),u_pixel_coord_lower:new t.Uniform2f(e,i.u_pixel_coord_lower),u_scale:new t.Uniform3f(e,i.u_scale),u_fade:new t.Uniform1f(e,i.u_fade)}),fillOutline:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_world:new t.Uniform2f(e,i.u_world)}),fillOutlinePattern:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_world:new t.Uniform2f(e,i.u_world),u_image:new t.Uniform1i(e,i.u_image),u_texsize:new t.Uniform2f(e,i.u_texsize),u_pixel_coord_upper:new t.Uniform2f(e,i.u_pixel_coord_upper),u_pixel_coord_lower:new t.Uniform2f(e,i.u_pixel_coord_lower),u_scale:new t.Uniform3f(e,i.u_scale),u_fade:new t.Uniform1f(e,i.u_fade)}),circle:(e,i)=>({u_camera_to_center_distance:new t.Uniform1f(e,i.u_camera_to_center_distance),u_extrude_scale:new t.UniformMatrix2f(e,i.u_extrude_scale),u_device_pixel_ratio:new t.Uniform1f(e,i.u_device_pixel_ratio),u_matrix:new t.UniformMatrix4f(e,i.u_matrix)}),collisionBox:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_camera_to_center_distance:new t.Uniform1f(e,i.u_camera_to_center_distance),u_extrude_scale:new t.Uniform2f(e,i.u_extrude_scale)}),collisionCircle:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_inv_matrix:new t.UniformMatrix4f(e,i.u_inv_matrix),u_camera_to_center_distance:new t.Uniform1f(e,i.u_camera_to_center_distance),u_viewport_size:new t.Uniform2f(e,i.u_viewport_size)}),debug:(e,i)=>({u_color:new t.UniformColor(e,i.u_color),u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_overlay:new t.Uniform1i(e,i.u_overlay),u_overlay_scale:new t.Uniform1f(e,i.u_overlay_scale)}),clippingMask:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix)}),heatmap:(e,i)=>({u_extrude_scale:new t.Uniform1f(e,i.u_extrude_scale),u_intensity:new t.Uniform1f(e,i.u_intensity),u_matrix:new t.UniformMatrix4f(e,i.u_matrix)}),heatmapTexture:(e,i)=>({u_image:new t.Uniform1i(e,i.u_image),u_color_ramp:new t.Uniform1i(e,i.u_color_ramp),u_opacity:new t.Uniform1f(e,i.u_opacity)}),hillshade:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_image:new t.Uniform1i(e,i.u_image),u_latrange:new t.Uniform2f(e,i.u_latrange),u_light:new t.Uniform2f(e,i.u_light),u_shadow:new t.UniformColor(e,i.u_shadow),u_highlight:new t.UniformColor(e,i.u_highlight),u_accent:new t.UniformColor(e,i.u_accent)}),hillshadePrepare:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_image:new t.Uniform1i(e,i.u_image),u_dimension:new t.Uniform2f(e,i.u_dimension),u_zoom:new t.Uniform1f(e,i.u_zoom),u_unpack:new t.Uniform4f(e,i.u_unpack)}),line:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_pixels_to_tile_units:new t.UniformMatrix2f(e,i.u_pixels_to_tile_units),u_device_pixel_ratio:new t.Uniform1f(e,i.u_device_pixel_ratio),u_units_to_pixels:new t.Uniform2f(e,i.u_units_to_pixels),u_dash_image:new t.Uniform1i(e,i.u_dash_image),u_gradient_image:new t.Uniform1i(e,i.u_gradient_image),u_image_height:new t.Uniform1f(e,i.u_image_height),u_texsize:new t.Uniform2f(e,i.u_texsize),u_scale:new t.Uniform3f(e,i.u_scale),u_mix:new t.Uniform1f(e,i.u_mix),u_alpha_discard_threshold:new t.Uniform1f(e,i.u_alpha_discard_threshold)}),linePattern:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_texsize:new t.Uniform2f(e,i.u_texsize),u_pixels_to_tile_units:new t.UniformMatrix2f(e,i.u_pixels_to_tile_units),u_device_pixel_ratio:new t.Uniform1f(e,i.u_device_pixel_ratio),u_image:new t.Uniform1i(e,i.u_image),u_units_to_pixels:new t.Uniform2f(e,i.u_units_to_pixels),u_scale:new t.Uniform3f(e,i.u_scale),u_fade:new t.Uniform1f(e,i.u_fade),u_alpha_discard_threshold:new t.Uniform1f(e,i.u_alpha_discard_threshold)}),raster:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_tl_parent:new t.Uniform2f(e,i.u_tl_parent),u_scale_parent:new t.Uniform1f(e,i.u_scale_parent),u_fade_t:new t.Uniform1f(e,i.u_fade_t),u_opacity:new t.Uniform1f(e,i.u_opacity),u_image0:new t.Uniform1i(e,i.u_image0),u_image1:new t.Uniform1i(e,i.u_image1),u_brightness_low:new t.Uniform1f(e,i.u_brightness_low),u_brightness_high:new t.Uniform1f(e,i.u_brightness_high),u_saturation_factor:new t.Uniform1f(e,i.u_saturation_factor),u_contrast_factor:new t.Uniform1f(e,i.u_contrast_factor),u_spin_weights:new t.Uniform3f(e,i.u_spin_weights),u_perspective_transform:new t.Uniform2f(e,i.u_perspective_transform)}),symbolIcon:(e,i)=>({u_is_size_zoom_constant:new t.Uniform1i(e,i.u_is_size_zoom_constant),u_is_size_feature_constant:new t.Uniform1i(e,i.u_is_size_feature_constant),u_size_t:new t.Uniform1f(e,i.u_size_t),u_size:new t.Uniform1f(e,i.u_size),u_camera_to_center_distance:new t.Uniform1f(e,i.u_camera_to_center_distance),u_pitch:new t.Uniform1f(e,i.u_pitch),u_rotate_symbol:new t.Uniform1i(e,i.u_rotate_symbol),u_aspect_ratio:new t.Uniform1f(e,i.u_aspect_ratio),u_fade_change:new t.Uniform1f(e,i.u_fade_change),u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_label_plane_matrix:new t.UniformMatrix4f(e,i.u_label_plane_matrix),u_coord_matrix:new t.UniformMatrix4f(e,i.u_coord_matrix),u_is_text:new t.Uniform1i(e,i.u_is_text),u_pitch_with_map:new t.Uniform1i(e,i.u_pitch_with_map),u_texsize:new t.Uniform2f(e,i.u_texsize),u_tile_id:new t.Uniform3f(e,i.u_tile_id),u_zoom_transition:new t.Uniform1f(e,i.u_zoom_transition),u_inv_rot_matrix:new t.UniformMatrix4f(e,i.u_inv_rot_matrix),u_merc_center:new t.Uniform2f(e,i.u_merc_center),u_texture:new t.Uniform1i(e,i.u_texture)}),symbolSDF:(e,i)=>({u_is_size_zoom_constant:new t.Uniform1i(e,i.u_is_size_zoom_constant),u_is_size_feature_constant:new t.Uniform1i(e,i.u_is_size_feature_constant),u_size_t:new t.Uniform1f(e,i.u_size_t),u_size:new t.Uniform1f(e,i.u_size),u_camera_to_center_distance:new t.Uniform1f(e,i.u_camera_to_center_distance),u_pitch:new t.Uniform1f(e,i.u_pitch),u_rotate_symbol:new t.Uniform1i(e,i.u_rotate_symbol),u_aspect_ratio:new t.Uniform1f(e,i.u_aspect_ratio),u_fade_change:new t.Uniform1f(e,i.u_fade_change),u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_label_plane_matrix:new t.UniformMatrix4f(e,i.u_label_plane_matrix),u_coord_matrix:new t.UniformMatrix4f(e,i.u_coord_matrix),u_is_text:new t.Uniform1i(e,i.u_is_text),u_pitch_with_map:new t.Uniform1i(e,i.u_pitch_with_map),u_texsize:new t.Uniform2f(e,i.u_texsize),u_texture:new t.Uniform1i(e,i.u_texture),u_gamma_scale:new t.Uniform1f(e,i.u_gamma_scale),u_device_pixel_ratio:new t.Uniform1f(e,i.u_device_pixel_ratio),u_tile_id:new t.Uniform3f(e,i.u_tile_id),u_zoom_transition:new t.Uniform1f(e,i.u_zoom_transition),u_inv_rot_matrix:new t.UniformMatrix4f(e,i.u_inv_rot_matrix),u_merc_center:new t.Uniform2f(e,i.u_merc_center),u_is_halo:new t.Uniform1i(e,i.u_is_halo)}),symbolTextAndIcon:(e,i)=>({u_is_size_zoom_constant:new t.Uniform1i(e,i.u_is_size_zoom_constant),u_is_size_feature_constant:new t.Uniform1i(e,i.u_is_size_feature_constant),u_size_t:new t.Uniform1f(e,i.u_size_t),u_size:new t.Uniform1f(e,i.u_size),u_camera_to_center_distance:new t.Uniform1f(e,i.u_camera_to_center_distance),u_pitch:new t.Uniform1f(e,i.u_pitch),u_rotate_symbol:new t.Uniform1i(e,i.u_rotate_symbol),u_aspect_ratio:new t.Uniform1f(e,i.u_aspect_ratio),u_fade_change:new t.Uniform1f(e,i.u_fade_change),u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_label_plane_matrix:new t.UniformMatrix4f(e,i.u_label_plane_matrix),u_coord_matrix:new t.UniformMatrix4f(e,i.u_coord_matrix),u_is_text:new t.Uniform1i(e,i.u_is_text),u_pitch_with_map:new t.Uniform1i(e,i.u_pitch_with_map),u_texsize:new t.Uniform2f(e,i.u_texsize),u_texsize_icon:new t.Uniform2f(e,i.u_texsize_icon),u_texture:new t.Uniform1i(e,i.u_texture),u_texture_icon:new t.Uniform1i(e,i.u_texture_icon),u_gamma_scale:new t.Uniform1f(e,i.u_gamma_scale),u_device_pixel_ratio:new t.Uniform1f(e,i.u_device_pixel_ratio),u_is_halo:new t.Uniform1i(e,i.u_is_halo)}),background:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_opacity:new t.Uniform1f(e,i.u_opacity),u_color:new t.UniformColor(e,i.u_color)}),backgroundPattern:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_opacity:new t.Uniform1f(e,i.u_opacity),u_image:new t.Uniform1i(e,i.u_image),u_pattern_tl_a:new t.Uniform2f(e,i.u_pattern_tl_a),u_pattern_br_a:new t.Uniform2f(e,i.u_pattern_br_a),u_pattern_tl_b:new t.Uniform2f(e,i.u_pattern_tl_b),u_pattern_br_b:new t.Uniform2f(e,i.u_pattern_br_b),u_texsize:new t.Uniform2f(e,i.u_texsize),u_mix:new t.Uniform1f(e,i.u_mix),u_pattern_size_a:new t.Uniform2f(e,i.u_pattern_size_a),u_pattern_size_b:new t.Uniform2f(e,i.u_pattern_size_b),u_scale_a:new t.Uniform1f(e,i.u_scale_a),u_scale_b:new t.Uniform1f(e,i.u_scale_b),u_pixel_coord_upper:new t.Uniform2f(e,i.u_pixel_coord_upper),u_pixel_coord_lower:new t.Uniform2f(e,i.u_pixel_coord_lower),u_tile_units_to_pixels:new t.Uniform1f(e,i.u_tile_units_to_pixels)}),terrainRaster:ti,terrainDepth:ti,skybox:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_sun_direction:new t.Uniform3f(e,i.u_sun_direction),u_cubemap:new t.Uniform1i(e,i.u_cubemap),u_opacity:new t.Uniform1f(e,i.u_opacity),u_temporal_offset:new t.Uniform1f(e,i.u_temporal_offset)}),skyboxGradient:(e,i)=>({u_matrix:new t.UniformMatrix4f(e,i.u_matrix),u_color_ramp:new t.Uniform1i(e,i.u_color_ramp),u_center_direction:new t.Uniform3f(e,i.u_center_direction),u_radius:new t.Uniform1f(e,i.u_radius),u_opacity:new t.Uniform1f(e,i.u_opacity),u_temporal_offset:new t.Uniform1f(e,i.u_temporal_offset)}),skyboxCapture:(e,i)=>({u_matrix_3f:new t.UniformMatrix3f(e,i.u_matrix_3f),u_sun_direction:new t.Uniform3f(e,i.u_sun_direction),u_sun_intensity:new t.Uniform1f(e,i.u_sun_intensity),u_color_tint_r:new t.Uniform4f(e,i.u_color_tint_r),u_color_tint_m:new t.Uniform4f(e,i.u_color_tint_m),u_luminance:new t.Uniform1f(e,i.u_luminance)}),globeRaster:(e,i)=>({u_proj_matrix:new t.UniformMatrix4f(e,i.u_proj_matrix),u_globe_matrix:new t.UniformMatrix4f(e,i.u_globe_matrix),u_merc_matrix:new t.UniformMatrix4f(e,i.u_merc_matrix),u_zoom_transition:new t.Uniform1f(e,i.u_zoom_transition),u_merc_center:new t.Uniform2f(e,i.u_merc_center),u_image0:new t.Uniform1i(e,i.u_image0)}),globeAtmosphere:(e,i)=>({u_center:new t.Uniform2f(e,i.u_center),u_radius:new t.Uniform1f(e,i.u_radius),u_screen_size:new t.Uniform2f(e,i.u_screen_size),u_pixel_ratio:new t.Uniform1f(e,i.u_pixel_ratio),u_opacity:new t.Uniform1f(e,i.u_opacity),u_fadeout_range:new t.Uniform1f(e,i.u_fadeout_range),u_start_color:new t.Uniform3f(e,i.u_start_color),u_end_color:new t.Uniform3f(e,i.u_end_color)})};let ji;function Gi(e,i,n,r,o,a,s){const l=e.context,c=l.gl,h=e.useProgram("collisionBox"),u=[];let d=0,p=0;for(let f=0;f<r.length;f++){const m=r[f],g=i.getTile(m),y=g.getBucket(n);if(!y)continue;let _=m.projMatrix;0===o[0]&&0===o[1]||(_=e.translatePosMatrix(m.projMatrix,g,o,a));const v=s?y.textCollisionBox:y.iconCollisionBox,x=y.collisionCircleArray;if(x.length>0){const i=t.create(),n=_;t.mul(i,y.placementInvProjMatrix,e.transform.glCoordMatrix),t.mul(i,i,y.placementViewportMatrix),u.push({circleArray:x,circleOffset:p,transform:n,invTransform:i}),d+=x.length/4,p=d}v&&(e.terrain&&e.terrain.setupElevationDraw(g,h),h.draw(l,c.LINES,t.DepthMode.disabled,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.disabled,Ti(_,e.transform,g),n.id,v.layoutVertexBuffer,v.indexBuffer,v.segments,null,e.transform.zoom,null,v.collisionVertexBuffer,v.collisionVertexBufferExt))}if(!s||!u.length)return;const f=e.useProgram("collisionCircle"),m=new t.StructArrayLayout2f1f2i16;m.resize(4*d),m._trim();let g=0;for(const t of u)for(let e=0;e<t.circleArray.length/4;e++){const i=4*e,n=t.circleArray[i+0],r=t.circleArray[i+1],o=t.circleArray[i+2],a=t.circleArray[i+3];m.emplace(g++,n,r,o,a,0),m.emplace(g++,n,r,o,a,1),m.emplace(g++,n,r,o,a,2),m.emplace(g++,n,r,o,a,3)}(!ji||ji.length<2*d)&&(ji=function(e){const i=2*e,n=new t.StructArrayLayout3ui6;n.resize(i),n._trim();for(let t=0;t<i;t++){const e=6*t;n.uint16[e+0]=4*t+0,n.uint16[e+1]=4*t+1,n.uint16[e+2]=4*t+2,n.uint16[e+3]=4*t+2,n.uint16[e+4]=4*t+3,n.uint16[e+5]=4*t+0}return n}(d));const y=l.createIndexBuffer(ji,!0),_=l.createVertexBuffer(m,t.collisionCircleLayout.members,!0);for(const i of u){const r={u_matrix:i.transform,u_inv_matrix:i.invTransform,u_camera_to_center_distance:(v=e.transform).cameraToCenterDistance,u_viewport_size:[v.width,v.height]};f.draw(l,c.TRIANGLES,t.DepthMode.disabled,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.disabled,r,n.id,_,y,t.SegmentVector.simpleSegment(0,2*i.circleOffset,i.circleArray.length,i.circleArray.length/2),null,e.transform.zoom,null,null,null)}var v;_.destroy(),y.destroy()}const Ui=t.identity(new Float32Array(16));function Vi(e,i,n,r,o,a){const{horizontalAlign:s,verticalAlign:l}=t.getAnchorAlignment(e),c=-(s-.5)*i,h=-(l-.5)*n,u=t.evaluateVariableOffset(e,r);return new t.pointGeometry((c/o+u[0])*a,(h/o+u[1])*a)}function Hi(e,i,n,r,o,a,s,l,c,h,u,d){const p=e.text.placedSymbolArray,f=e.text.dynamicLayoutVertexArray,m=e.icon.dynamicLayoutVertexArray,g={},y=l.projMatrix,_=a.elevation,v=_?_.getAtTileOffsetFunc(l,d):t=>[0,0,0];f.clear();for(let l=0;l<p.length;l++){const d=p.get(l),m=e.allowVerticalPlacement&&!d.placedOrientation,_=d.hidden||!d.crossTileID||m?null:r[d.crossTileID];if(_){const r=new t.pointGeometry(d.tileAnchorX,d.tileAnchorY),l=v(r),p=Xt(r,n?y:s,l[2]),m=Yt(a.cameraToCenterDistance,p.signedDistanceFromCamera);let x=o.evaluateSizeForFeature(e.textSizeData,h,d)*m/t.ONE_EM;n&&(x*=e.tilePixelRatio/c);const{width:b,height:w,anchor:M,textOffset:T,textScale:S}=_,E=Vi(M,b,w,T,S,x),C=n?Xt(r.add(E),s,l[2]).point:p.point.add(i?E.rotate(-a.angle):E),A=e.allowVerticalPlacement&&d.placedOrientation===t.WritingMode.vertical?Math.PI/2:0;for(let e=0;e<d.numGlyphs;e++)t.addDynamicAttributes(f,C,A);u&&d.associatedIconIndex>=0&&(g[d.associatedIconIndex]={shiftedAnchor:C,angle:A})}else oe(d.numGlyphs,f)}if(u){m.clear();const i=e.icon.placedSymbolArray;for(let e=0;e<i.length;e++){const n=i.get(e);if(n.hidden)oe(n.numGlyphs,m);else{const i=g[e];if(i)for(let e=0;e<n.numGlyphs;e++)t.addDynamicAttributes(m,i.shiftedAnchor,i.angle);else oe(n.numGlyphs,m)}}e.icon.dynamicLayoutVertexBuffer.updateData(m)}e.text.dynamicLayoutVertexBuffer.updateData(f)}function Zi(t,e,i){return i.iconsInText&&e?"symbolTextAndIcon":t?"symbolSDF":"symbolIcon"}function Wi(e,i,n,r,o,a,s,l,c,h,u,d){const p=e.context,f=p.gl,m=e.transform,g=m.projection.createTileTransform(m,m.worldSize),y="map"===l,_="map"===c,v=y&&"point"!==n.layout.get("symbol-placement"),x=y&&!_&&!v,b=void 0!==n.layout.get("symbol-sort-key").constantOr(1);let w=!1;const M=e.depthModeForSublayer(0,t.DepthMode.ReadOnly),T=[t.mercatorXfromLng(m.center.lng),t.mercatorYfromLat(m.center.lat)],S=n.layout.get("text-variable-anchor"),E="globe"===m.projection.name,C=E?t.globeToMercatorTransition(m.zoom):0,A=[],P=[];e.terrain&&_&&P.push("PITCH_WITH_MAP_TERRAIN"),E&&P.push("PROJECTION_GLOBE_VIEW"),v&&P.push("PROJECTED_POS_ON_VIEWPORT");for(const l of r){const r=i.getTile(l),c=r.getBucket(n);if(!c||c.projection!==m.projection.name)continue;const u=o?c.text:c.icon;if(!u||c.fullyClipped||!u.segments.get().length)continue;const d=u.programConfigurations.get(n.id),p=o||c.sdfIcons,M=o?c.textSizeData:c.iconSizeData,E=_||0!==m.pitch,L=e.useProgram(Zi(p,o,c),d,P),I=t.evaluateSizeForZoom(M,m.zoom),R=[l.canonical.x,l.canonical.y,1<<l.canonical.z];let D,k,O,z,B=[0,0],F=null;if(o){if(k=r.glyphAtlasTexture,O=f.LINEAR,D=r.glyphAtlasTexture.size,c.iconsInText){B=r.imageAtlasTexture.size,F=r.imageAtlasTexture;const t="composite"===M.kind||"camera"===M.kind;z=E||e.options.rotating||e.options.zooming||t?f.LINEAR:f.NEAREST}}else{const t=1!==n.layout.get("icon-size").constantOr(0)||c.iconsNeedLinear;k=r.imageAtlasTexture,O=p||e.options.rotating||e.options.zooming||t||E?f.LINEAR:f.NEAREST,D=r.imageAtlasTexture.size}const N=e.transform.calculatePixelsToTileUnitsMatrix(r),j=Wt(l.projMatrix,r.tileID.canonical,_,y,e.transform,N),G=e.terrain&&_&&v?t.invert(new Float32Array(16),j):Ui,U=qt(l.projMatrix,r.tileID.canonical,_,y,e.transform,N),V=S&&c.hasTextData(),H="none"!==n.layout.get("icon-text-fit")&&V&&c.hasIconData();if(v){const t=m.elevation,i=t?t.getAtTileOffsetFunc(l,g):t=>[0,0,0];Jt(c,l.projMatrix,e,o,j,U,_,h,i,l)}const Z=e.translatePosMatrix(l.projMatrix,r,a,s),W=v||o&&S||H?Ui:j,q=e.translatePosMatrix(U,r,a,s,!0),X=p&&0!==n.paint.get(o?"text-halo-width":"icon-halo-width").constantOr(1);let Y;const $=g.createInversionMatrix(l.toUnwrapped());Y=p?c.iconsInText?zi(M.kind,I,x,_,e,Z,W,q,D,B,R,C,$,T):Oi(M.kind,I,x,_,e,Z,W,q,o,D,!0,R,C,$,T):ki(M.kind,I,x,_,e,Z,W,q,o,D,R,C,$,T);const J={program:L,buffers:u,uniformValues:Y,atlasTexture:k,atlasTextureIcon:F,atlasInterpolation:O,atlasInterpolationIcon:z,isSDF:p,hasHalo:X,tile:r,labelPlaneMatrixInv:G};if(b&&c.canOverlap){w=!0;const e=u.segments.get();for(const i of e)A.push({segments:new t.SegmentVector([i]),sortKey:i.sortKey,state:J})}else A.push({segments:u.segments,sortKey:0,state:J})}w&&A.sort((t,e)=>t.sortKey-e.sortKey);for(const t of A){const i=t.state;if(e.terrain&&e.terrain.setupElevationDraw(i.tile,i.program,{useDepthForOcclusion:!E,labelPlaneMatrixInv:i.labelPlaneMatrixInv}),p.activeTexture.set(f.TEXTURE0),i.atlasTexture.bind(i.atlasInterpolation,f.CLAMP_TO_EDGE),i.atlasTextureIcon&&(p.activeTexture.set(f.TEXTURE1),i.atlasTextureIcon&&i.atlasTextureIcon.bind(i.atlasInterpolationIcon,f.CLAMP_TO_EDGE)),i.isSDF){const r=i.uniformValues;i.hasHalo&&(r.u_is_halo=1,qi(i.buffers,t.segments,n,e,i.program,M,u,d,r)),r.u_is_halo=0}qi(i.buffers,t.segments,n,e,i.program,M,u,d,i.uniformValues)}}function qi(e,i,n,r,o,a,s,l,c){const h=r.context;o.draw(h,h.gl.TRIANGLES,a,s,l,t.CullFaceMode.disabled,c,n.id,e.layoutVertexBuffer,e.indexBuffer,i,n.paint,r.transform.zoom,e.programConfigurations.get(n.id),e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer)}function Xi(e,i,n,r,o,a,s){const l=e.context.gl,c=n.paint.get("fill-pattern"),h=c&&c.constantOr(1),u=n.getCrossfadeParameters();let d,p,f,m,g;s?(p=h&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",d=l.LINES):(p=h?"fillPattern":"fill",d=l.TRIANGLES);for(const y of r){const r=i.getTile(y);if(h&&!r.patternsLoaded())continue;const _=r.getBucket(n);if(!_)continue;e.prepareDrawTile(y);const v=_.programConfigurations.get(n.id),x=e.useProgram(p,v);h&&(e.context.activeTexture.set(l.TEXTURE0),r.imageAtlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE),v.updatePaintBuffers(u));const b=c.constantOr(null);if(b&&r.imageAtlas){const t=r.imageAtlas,e=t.patternPositions[b.to.toString()],i=t.patternPositions[b.from.toString()];e&&i&&v.setConstantPatternPositions(e,i)}const w=e.translatePosMatrix(y.projMatrix,r,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));if(s){m=_.indexBuffer2,g=_.segments2;const t=e.terrain&&e.terrain.renderingToTexture?e.terrain.drapeBufferSize:[l.drawingBufferWidth,l.drawingBufferHeight];f="fillOutlinePattern"===p&&h?bi(w,e,u,r,t):xi(w,t)}else m=_.indexBuffer,g=_.segments,f=h?vi(w,e,u,r):_i(w);e.prepareDrawProgram(e.context,x,y.toUnwrapped()),x.draw(e.context,d,o,e.stencilModeForClipping(y),a,t.CullFaceMode.disabled,f,n.id,_.layoutVertexBuffer,m,g,n.paint,e.transform.zoom,v)}}function Yi(e,i,n,r,o,a,s){const l=e.context,c=l.gl,h=n.paint.get("fill-extrusion-pattern"),u=h.constantOr(1),d=n.getCrossfadeParameters(),p=n.paint.get("fill-extrusion-opacity");for(const f of r){const r=i.getTile(f),m=r.getBucket(n);if(!m)continue;const g=m.programConfigurations.get(n.id),y=e.useProgram(u?"fillExtrusionPattern":"fillExtrusion",g);if(e.terrain){const t=e.terrain;if(!m.enableTerrain)continue;if(t.setupElevationDraw(r,y,{useMeterToDem:!0}),$i(l,i,f,m,n,t),!m.centroidVertexBuffer){const t=y.attributes.a_centroid_pos;void 0!==t&&c.vertexAttrib2f(t,0,0)}}u&&(e.context.activeTexture.set(c.TEXTURE0),r.imageAtlasTexture.bind(c.LINEAR,c.CLAMP_TO_EDGE),g.updatePaintBuffers(d));const _=h.constantOr(null);if(_&&r.imageAtlas){const t=r.imageAtlas,e=t.patternPositions[_.to.toString()],i=t.patternPositions[_.from.toString()];e&&i&&g.setConstantPatternPositions(e,i)}const v=e.translatePosMatrix(f.projMatrix,r,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),x=n.paint.get("fill-extrusion-vertical-gradient"),b=u?yi(v,e,x,p,f,d,r):gi(v,e,x,p);e.prepareDrawProgram(l,y,f.toUnwrapped()),y.draw(l,l.gl.TRIANGLES,o,a,s,t.CullFaceMode.backCCW,b,n.id,m.layoutVertexBuffer,m.indexBuffer,m.segments,n.paint,e.transform.zoom,g,e.terrain?m.centroidVertexBuffer:null)}}function $i(e,i,n,r,o,a){const s=[e=>{let i=e.canonical.x-1,n=e.wrap;return i<0&&(i=(1<<e.canonical.z)-1,n--),new t.OverscaledTileID(e.overscaledZ,n,e.canonical.z,i,e.canonical.y)},e=>{let i=e.canonical.x+1,n=e.wrap;return i===1<<e.canonical.z&&(i=0,n++),new t.OverscaledTileID(e.overscaledZ,n,e.canonical.z,i,e.canonical.y)},e=>new t.OverscaledTileID(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,(0===e.canonical.y?1<<e.canonical.z:e.canonical.y)-1),e=>new t.OverscaledTileID(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y===(1<<e.canonical.z)-1?0:e.canonical.y+1)],l=t=>{const e=i.getSource().maxzoom,n=t=>{const e=i.getTileByID(t);if(e&&e.hasData())return e.getBucket(o)};let r,a,s;return(t.overscaledZ===t.canonical.z||t.overscaledZ>=e)&&(r=n(t.key)),t.overscaledZ>=e&&(a=n(t.calculateScaledKey(t.overscaledZ+1))),t.overscaledZ>e&&(s=n(t.calculateScaledKey(t.overscaledZ-1))),r||a||s},c=[0,0,0],h=(e,i)=>(c[0]=Math.min(e.min.y,i.min.y),c[1]=Math.max(e.max.y,i.max.y),c[2]=t.EXTENT-i.min.x>e.max.x?i.min.x-t.EXTENT:e.max.x,c),u=(e,i)=>(c[0]=Math.min(e.min.x,i.min.x),c[1]=Math.max(e.max.x,i.max.x),c[2]=t.EXTENT-i.min.y>e.max.y?i.min.y-t.EXTENT:e.max.y,c),d=[(t,e)=>h(t,e),(t,e)=>h(e,t),(t,e)=>u(t,e),(t,e)=>u(e,t)],p=new t.pointGeometry(0,0);let f,m,g;const y=(e,i,r,o,s)=>{const l=[[o?r:e,o?e:r,0],[o?r:i,o?i:r,0]],c=s<0?t.EXTENT+s:s,h=[o?c:(e+i)/2,o?(e+i)/2:c,0];return 0===r&&s<0||0!==r&&s>0?a.getForTilePoints(g,[h],!0,m):l.push(h),a.getForTilePoints(n,l,!0,f),Math.max(l[0][2],l[1][2],h[2])/a.exaggeration()};for(let e=0;e<4;e++){const i=r.borders[e];if(0===i.length&&(r.borderDone[e]=!0),r.borderDone[e])continue;const o=g=s[e](n),c=l(o);if(!c||!c.enableTerrain)continue;if(m=a.findDEMTileFor(o),!m||!m.dem)continue;if(!f){const t=a.findDEMTileFor(n);if(!t||!t.dem)return;f=t}const h=(e<2?1:5)-e,u=c.borders[h];let _=0;for(let n=0;n<i.length;n++){const o=r.featuresOnBorder[i[n]],a=o.borders[e];let s;for(;_<u.length&&(s=c.featuresOnBorder[u[_]],!(s.borders[h][1]>a[0]+3));)c.borderDone[h]||c.encodeCentroid(void 0,s,!1),_++;if(s&&_<u.length){const i=_;let n=0;for(;!(s.borders[h][0]>a[1]-3)&&(n++,++_!==u.length);)s=c.featuresOnBorder[u[_]];if(s=c.featuresOnBorder[u[i]],o.intersectsCount()>1||s.intersectsCount()>1||1!==n){1!==n&&(_=i),r.encodeCentroid(void 0,o,!1),c.borderDone[h]||c.encodeCentroid(void 0,s,!1);continue}const l=d[e](o,s),f=e%2?t.EXTENT-1:0;p.x=y(l[0],Math.min(t.EXTENT-1,l[1]),f,e<2,l[2]),p.y=0,r.encodeCentroid(p,o,!1),c.borderDone[h]||c.encodeCentroid(p,s,!1)}else r.encodeCentroid(void 0,o,!1)}r.borderDone[e]=r.needsCentroidUpdate=!0,c.borderDone[h]||(c.borderDone[h]=c.needsCentroidUpdate=!0)}(r.needsCentroidUpdate||!r.centroidVertexBuffer&&0!==r.centroidVertexArray.length)&&r.uploadCentroid(e)}const Ji=new t.Color(1,0,0,1),Ki=new t.Color(0,1,0,1),Qi=new t.Color(0,0,1,1),tn=new t.Color(1,0,1,1),en=new t.Color(0,1,1,1);function nn(t,e,i,n){on(t,0,e+i/2,t.transform.width,i,n)}function rn(t,e,i,n){on(t,e-i/2,0,i,t.transform.height,n)}function on(e,i,n,r,o,a){const s=e.context,l=s.gl;l.enable(l.SCISSOR_TEST),l.scissor(i*t.exported.devicePixelRatio,n*t.exported.devicePixelRatio,r*t.exported.devicePixelRatio,o*t.exported.devicePixelRatio),s.clear({color:a}),l.disable(l.SCISSOR_TEST)}function an(e,i,n){const r=e.context,o=r.gl,a=n.projMatrix,s=e.useProgram("debug"),l=i.getTileByID(n.key);e.terrain&&e.terrain.setupElevationDraw(l,s);const c=t.DepthMode.disabled,h=t.StencilMode.disabled,u=e.colorModeForRenderPass(),d="$debug";r.activeTexture.set(o.TEXTURE0),e.emptyTexture.bind(o.LINEAR,o.CLAMP_TO_EDGE),l._makeDebugTileBoundsBuffers(e.context,e.transform.projection);const p=l._tileDebugBuffer||e.debugBuffer,f=l._tileDebugIndexBuffer||e.debugIndexBuffer,m=l._tileDebugSegments||e.debugSegments;s.draw(r,o.LINE_STRIP,c,h,u,t.CullFaceMode.disabled,Si(a,t.Color.red),d,p,f,m);const g=l.latestRawTileData,y=Math.floor((g&&g.byteLength||0)/1024),_=i.getTile(n).tileSize,v=512/Math.min(_,512)*(n.overscaledZ/e.transform.zoom)*.5;let x=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(x+=" => "+n.overscaledZ),function(t,e){t.initDebugOverlayCanvas();const i=t.debugOverlayCanvas,n=t.context.gl,r=t.debugOverlayCanvas.getContext("2d");r.clearRect(0,0,i.width,i.height),r.shadowColor="white",r.shadowBlur=2,r.lineWidth=1.5,r.strokeStyle="white",r.textBaseline="top",r.font="bold 36px Open Sans, sans-serif",r.fillText(e,5,5),r.strokeText(e,5,5),t.debugOverlayTexture.update(i),t.debugOverlayTexture.bind(n.LINEAR,n.CLAMP_TO_EDGE)}(e,`${x} ${y}kb`),s.draw(r,o.TRIANGLES,c,h,t.ColorMode.alphaBlended,t.CullFaceMode.disabled,Si(a,t.Color.transparent,v),d,e.debugBuffer,e.quadTriangleIndexBuffer,e.debugSegments)}const sn=t.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:ln}=sn;function cn(t,e,i,n){t.emplaceBack(e,i,n)}class hn{constructor(e){this.vertexArray=new t.StructArrayLayout3f12,this.indices=new t.StructArrayLayout3ui6,cn(this.vertexArray,-1,-1,1),cn(this.vertexArray,1,-1,1),cn(this.vertexArray,-1,1,1),cn(this.vertexArray,1,1,1),cn(this.vertexArray,-1,-1,-1),cn(this.vertexArray,1,-1,-1),cn(this.vertexArray,-1,1,-1),cn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=e.createVertexBuffer(this.vertexArray,ln),this.indexBuffer=e.createIndexBuffer(this.indices),this.segment=t.SegmentVector.simpleSegment(0,0,36,12)}}function un(e,i,n,r,o,a){const s=e.gl,l=i.paint.get("sky-atmosphere-color"),c=i.paint.get("sky-atmosphere-halo-color"),h=i.paint.get("sky-atmosphere-sun-intensity"),u=((t,e,i,n,r)=>({u_matrix_3f:t,u_sun_direction:e,u_sun_intensity:i,u_color_tint_r:[n.r,n.g,n.b,n.a],u_color_tint_m:[r.r,r.g,r.b,r.a],u_luminance:5e-5}))(t.fromMat4([],r),o,h,l,c);s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+a,i.skyboxTexture,0),n.draw(e,s.TRIANGLES,t.DepthMode.disabled,t.StencilMode.disabled,t.ColorMode.unblended,t.CullFaceMode.frontCW,u,"skyboxCapture",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}const dn={symbol:function(e,i,n,r,o){if("translucent"!==e.renderPass)return;const a=t.StencilMode.disabled,s=e.colorModeForRenderPass();n.layout.get("text-variable-anchor")&&function(e,i,n,r,o,a,s){const l=i.transform,c="map"===o,h="map"===a,u=l.projection.createTileTransform(l,l.worldSize);for(const o of e){const e=r.getTile(o),a=e.getBucket(n);if(!a||a.projection!==l.projection.name||!a.text||!a.text.segments.get().length)continue;const d=t.evaluateSizeForZoom(a.textSizeData,l.zoom),p=i.transform.calculatePixelsToTileUnitsMatrix(e),f=Wt(o.projMatrix,e.tileID.canonical,h,c,i.transform,p),m="none"!==n.layout.get("icon-text-fit")&&a.hasIconData();if(d){const i=Math.pow(2,l.zoom-e.tileID.overscaledZ);Hi(a,c,h,s,t.symbolSize,l,f,o,i,d,m,u)}}}(r,e,n,i,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),o),0!==n.paint.get("icon-opacity").constantOr(1)&&Wi(e,i,n,r,!1,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),n.layout.get("icon-rotation-alignment"),n.layout.get("icon-pitch-alignment"),n.layout.get("icon-keep-upright"),a,s),0!==n.paint.get("text-opacity").constantOr(1)&&Wi(e,i,n,r,!0,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),n.layout.get("text-keep-upright"),a,s),i.map.showCollisionBoxes&&(Gi(e,i,n,r,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),Gi(e,i,n,r,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(e,i,n,r){if("translucent"!==e.renderPass)return;const o=n.paint.get("circle-opacity"),a=n.paint.get("circle-stroke-width"),s=n.paint.get("circle-stroke-opacity"),l=void 0!==n.layout.get("circle-sort-key").constantOr(1);if(0===o.constantOr(1)&&(0===a.constantOr(1)||0===s.constantOr(1)))return;const c=e.context,h=c.gl,u=e.depthModeForSublayer(0,t.DepthMode.ReadOnly),d=t.StencilMode.disabled,p=e.colorModeForRenderPass(),f=[];for(let o=0;o<r.length;o++){const a=r[o],s=i.getTile(a),c=s.getBucket(n);if(!c)continue;const h=c.programConfigurations.get(n.id),u=Mi(n),d={programConfiguration:h,program:e.useProgram("circle",h,u),layoutVertexBuffer:c.layoutVertexBuffer,indexBuffer:c.indexBuffer,uniformValues:wi(e,a,s,n),tile:s};if(l){const e=c.segments.get();for(const i of e)f.push({segments:new t.SegmentVector([i]),sortKey:i.sortKey,state:d})}else f.push({segments:c.segments,sortKey:0,state:d})}l&&f.sort((t,e)=>t.sortKey-e.sortKey);const m={useDepthForOcclusion:!("globe"===e.transform.projection.name)};for(const i of f){const{programConfiguration:r,program:o,layoutVertexBuffer:a,indexBuffer:s,uniformValues:l,tile:f}=i.state,g=i.segments;e.terrain&&e.terrain.setupElevationDraw(f,o,m),e.prepareDrawProgram(c,o,f.tileID.toUnwrapped()),o.draw(c,h.TRIANGLES,u,d,p,t.CullFaceMode.disabled,l,n.id,a,s,g,n.paint,e.transform.zoom,r)}},heatmap:function(e,i,n,r){if(0!==n.paint.get("heatmap-opacity"))if("offscreen"===e.renderPass){const o=e.context,a=o.gl,s=t.StencilMode.disabled,l=new t.ColorMode([a.ONE,a.ONE],t.Color.transparent,[!0,!0,!0,!0]);!function(t,e,i){const n=t.gl;t.activeTexture.set(n.TEXTURE1),t.viewport.set([0,0,e.width/4,e.height/4]);let r=i.heatmapFbo;if(r)n.bindTexture(n.TEXTURE_2D,r.colorAttachment.get()),t.bindFramebuffer.set(r.framebuffer);else{const o=n.createTexture();n.bindTexture(n.TEXTURE_2D,o),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),r=i.heatmapFbo=t.createFramebuffer(e.width/4,e.height/4,!1),function(t,e,i,n){const r=t.gl;r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e.width/4,e.height/4,0,r.RGBA,t.extRenderToTextureHalfFloat?t.extTextureHalfFloat.HALF_FLOAT_OES:r.UNSIGNED_BYTE,null),n.colorAttachment.set(i)}(t,e,o,r)}}(o,e,n),o.clear({color:t.Color.transparent});for(let c=0;c<r.length;c++){const h=r[c];if(i.hasRenderableParent(h))continue;const u=i.getTile(h),d=u.getBucket(n);if(!d)continue;const p=d.programConfigurations.get(n.id),f=e.useProgram("heatmap",p),{zoom:m}=e.transform;e.terrain&&e.terrain.setupElevationDraw(u,f),e.prepareDrawProgram(o,f,h.toUnwrapped()),f.draw(o,a.TRIANGLES,t.DepthMode.disabled,s,l,t.CullFaceMode.disabled,Ei(h.projMatrix,u,m,n.paint.get("heatmap-intensity")),n.id,d.layoutVertexBuffer,d.indexBuffer,d.segments,n.paint,e.transform.zoom,p)}o.viewport.set([0,0,e.width,e.height])}else"translucent"===e.renderPass&&(e.context.setColorMode(e.colorModeForRenderPass()),function(e,i){const n=e.context,r=n.gl,o=i.heatmapFbo;if(!o)return;n.activeTexture.set(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,o.colorAttachment.get()),n.activeTexture.set(r.TEXTURE1);let a=i.colorRampTexture;a||(a=i.colorRampTexture=new t.Texture(n,i.colorRamp,r.RGBA)),a.bind(r.LINEAR,r.CLAMP_TO_EDGE),e.useProgram("heatmapTexture").draw(n,r.TRIANGLES,t.DepthMode.disabled,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.disabled,((t,e,i,n)=>({u_image:0,u_color_ramp:1,u_opacity:e.paint.get("heatmap-opacity")}))(0,i),i.id,e.viewportBuffer,e.quadTriangleIndexBuffer,e.viewportSegments,i.paint,e.transform.zoom)}(e,n))},line:function(e,i,n,r){if("translucent"!==e.renderPass)return;const o=n.paint.get("line-opacity"),a=n.paint.get("line-width");if(0===o.constantOr(1)||0===a.constantOr(1))return;const s=e.depthModeForSublayer(0,t.DepthMode.ReadOnly),l=e.colorModeForRenderPass(),c=n.paint.get("line-dasharray"),h=c.constantOr(1),u=n.layout.get("line-cap"),d=n.paint.get("line-pattern"),p=d.constantOr(1),f=n.paint.get("line-gradient"),m=n.getCrossfadeParameters(),g=p?"linePattern":"line",y=e.context,_=y.gl,v=(t=>{const e=[];Ii(t)&&e.push("RENDER_LINE_DASH"),t.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=t.paint.get("line-pattern").constantOr(1),n=1!==t.paint.get("line-opacity").constantOr(1);return!i&&n&&e.push("RENDER_LINE_ALPHA_DISCARD"),e})(n);let x=v.includes("RENDER_LINE_ALPHA_DISCARD");e.terrain&&e.terrain.clipOrMaskOverlapStencilType()&&(x=!1);for(const o of r){const r=i.getTile(o);if(p&&!r.patternsLoaded())continue;const a=r.getBucket(n);if(!a)continue;e.prepareDrawTile(o);const b=a.programConfigurations.get(n.id),w=e.useProgram(g,b,v),M=d.constantOr(null);if(M&&r.imageAtlas){const t=r.imageAtlas,e=t.patternPositions[M.to.toString()],i=t.patternPositions[M.from.toString()];e&&i&&b.setConstantPatternPositions(e,i)}const T=c.constantOr(null),S=u.constantOr(null);if(!p&&T&&S&&r.lineAtlas){const t=r.lineAtlas,e=t.getDash(T.to,S),i=t.getDash(T.from,S);e&&i&&b.setConstantPatternPositions(e,i)}const E=e.terrain?o.projMatrix:null,C=p?Ai(e,r,n,m,E):Ci(e,r,n,m,E,a.lineClipsArray.length);if(f){const r=a.gradients[n.id];let s=r.texture;if(n.gradientVersion!==r.version){let l=256;if(n.stepInterpolant){const n=i.getSource().maxzoom,r=o.canonical.z===n?Math.ceil(1<<e.transform.maxZoom-o.canonical.z):1;l=t.clamp(t.nextPowerOfTwo(a.maxLineLength/t.EXTENT*1024*r),256,y.maxTextureSize)}r.gradient=t.renderColorRamp({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:l,image:r.gradient||void 0,clips:a.lineClipsArray}),r.texture?r.texture.update(r.gradient):r.texture=new t.Texture(y,r.gradient,_.RGBA),r.version=n.gradientVersion,s=r.texture}y.activeTexture.set(_.TEXTURE1),s.bind(n.stepInterpolant?_.NEAREST:_.LINEAR,_.CLAMP_TO_EDGE)}h&&(y.activeTexture.set(_.TEXTURE0),r.lineAtlasTexture.bind(_.LINEAR,_.REPEAT),b.updatePaintBuffers(m)),p&&(y.activeTexture.set(_.TEXTURE0),r.imageAtlasTexture.bind(_.LINEAR,_.CLAMP_TO_EDGE),b.updatePaintBuffers(m)),e.prepareDrawProgram(y,w,o.toUnwrapped());const A=i=>{w.draw(y,_.TRIANGLES,s,i,l,t.CullFaceMode.disabled,C,n.id,a.layoutVertexBuffer,a.indexBuffer,a.segments,n.paint,e.transform.zoom,b,a.layoutVertexBuffer2)};if(x){const i=e.stencilModeForClipping(o).ref;0===i&&e.terrain&&y.clear({stencil:0});const n={func:_.EQUAL,mask:255};C.u_alpha_discard_threshold=.8,A(new t.StencilMode(n,i,255,_.KEEP,_.KEEP,_.INVERT)),C.u_alpha_discard_threshold=0,A(new t.StencilMode(n,i,255,_.KEEP,_.KEEP,_.KEEP))}else A(e.stencilModeForClipping(o))}x&&(e.resetStencilClippingMasks(),e.terrain&&y.clear({stencil:0}))},fill:function(e,i,n,r){const o=n.paint.get("fill-color"),a=n.paint.get("fill-opacity");if(0===a.constantOr(1))return;const s=e.colorModeForRenderPass(),l=n.paint.get("fill-pattern"),c=e.opaquePassEnabledForLayer()&&!l.constantOr(1)&&1===o.constantOr(t.Color.transparent).a&&1===a.constantOr(0)?"opaque":"translucent";if(e.renderPass===c){const o=e.depthModeForSublayer(1,"opaque"===e.renderPass?t.DepthMode.ReadWrite:t.DepthMode.ReadOnly);Xi(e,i,n,r,o,s,!1)}if("translucent"===e.renderPass&&n.paint.get("fill-antialias")){const o=e.depthModeForSublayer(n.getPaintProperty("fill-outline-color")?2:0,t.DepthMode.ReadOnly);Xi(e,i,n,r,o,s,!0)}},"fill-extrusion":function(e,i,n,r){const o=n.paint.get("fill-extrusion-opacity");if(0!==o&&"translucent"===e.renderPass){const a=new t.DepthMode(e.context.gl.LEQUAL,t.DepthMode.ReadWrite,e.depthRangeFor3D);if(1!==o||n.paint.get("fill-extrusion-pattern").constantOr(1))Yi(e,i,n,r,a,t.StencilMode.disabled,t.ColorMode.disabled),Yi(e,i,n,r,a,e.stencilModeFor3D(),e.colorModeForRenderPass()),e.resetStencilClippingMasks();else{const o=e.colorModeForRenderPass();Yi(e,i,n,r,a,t.StencilMode.disabled,o)}}},hillshade:function(e,i,n,r){if("offscreen"!==e.renderPass&&"translucent"!==e.renderPass)return;const o=e.context,a=e.depthModeForSublayer(0,t.DepthMode.ReadOnly),s=e.colorModeForRenderPass(),l=e.terrain&&e.terrain.renderingToTexture,[c,h]="translucent"!==e.renderPass||l?[{},r]:e.stencilConfigForOverlap(r);for(const r of h){const o=i.getTile(r);if(o.needsHillshadePrepare&&"offscreen"===e.renderPass)Qe(e,o,n,a,t.StencilMode.disabled,s);else if("translucent"===e.renderPass){const t=l&&e.terrain?e.terrain.stencilModeForRTTOverlap(r):c[r.overscaledZ];Je(e,r,o,n,a,t,s)}}o.viewport.set([0,0,e.width,e.height]),e.resetStencilClippingMasks()},raster:function(e,i,n,r,o,a){if("translucent"!==e.renderPass)return;if(0===n.paint.get("raster-opacity"))return;if(!r.length)return;const s=e.context,l=s.gl,c=i.getSource(),h=e.useProgram("raster"),u=e.colorModeForRenderPass(),d=e.terrain&&e.terrain.renderingToTexture,[p,f]=c instanceof bt||d?[{},r]:e.stencilConfigForOverlap(r),m=f[f.length-1].overscaledZ,g=!e.options.moving;for(const r of f){const o=d?t.DepthMode.disabled:e.depthModeForSublayer(r.overscaledZ-m,1===n.paint.get("raster-opacity")?t.DepthMode.ReadWrite:t.DepthMode.ReadOnly,l.LESS),f=r.toUnwrapped(),y=i.getTile(r);if(d&&(!y||!y.hasData()))continue;const _=d?r.projMatrix:e.transform.calculateProjMatrix(f,g),v=e.terrain&&d?e.terrain.stencilModeForRTTOverlap(r):p[r.overscaledZ],x=a?0:n.paint.get("raster-fade-duration");y.registerFadeDuration(x);const b=i.findLoadedParent(r,0),w=li(y,b,i,e.transform,x);let M,T;e.terrain&&e.terrain.prepareDrawTile(r);const S="nearest"===n.paint.get("raster-resampling")?l.NEAREST:l.LINEAR;s.activeTexture.set(l.TEXTURE0),y.texture.bind(S,l.CLAMP_TO_EDGE),s.activeTexture.set(l.TEXTURE1),b?(b.texture.bind(S,l.CLAMP_TO_EDGE),M=Math.pow(2,b.tileID.overscaledZ-y.tileID.overscaledZ),T=[y.tileID.canonical.x*M%1,y.tileID.canonical.y*M%1]):y.texture.bind(S,l.CLAMP_TO_EDGE);const E=Ri(_,T||[0,0],M||1,w,n,c instanceof bt?c.perspectiveTransform:[0,0]);if(e.prepareDrawProgram(s,h,f),c instanceof bt)h.draw(s,l.TRIANGLES,o,t.StencilMode.disabled,u,t.CullFaceMode.disabled,E,n.id,c.boundsBuffer,e.quadTriangleIndexBuffer,c.boundsSegments);else{const{tileBoundsBuffer:i,tileBoundsIndexBuffer:r,tileBoundsSegments:a}=e.getTileBoundsBuffers(y);h.draw(s,l.TRIANGLES,o,v,u,t.CullFaceMode.disabled,E,n.id,i,r,a)}}e.resetStencilClippingMasks()},background:function(e,i,n,r){const o=n.paint.get("background-color"),a=n.paint.get("background-opacity");if(0===a)return;const s=e.context,l=s.gl,c=e.transform,h=c.tileSize,u=n.paint.get("background-pattern");if(e.isPatternMissing(u))return;const d=!u&&1===o.a&&1===a&&e.opaquePassEnabledForLayer()?"opaque":"translucent";if(e.renderPass!==d)return;const p=t.StencilMode.disabled,f=e.depthModeForSublayer(0,"opaque"===d?t.DepthMode.ReadWrite:t.DepthMode.ReadOnly),m=e.colorModeForRenderPass(),g=e.useProgram(u?"backgroundPattern":"background");let y,_=r;_||(y=e.getBackgroundTiles(),_=Object.values(y).map(t=>t.tileID)),u&&(s.activeTexture.set(l.TEXTURE0),e.imageManager.bind(e.context));const v=n.getCrossfadeParameters();for(const d of _){const _=d.toUnwrapped(),x=r?d.projMatrix:e.transform.calculateProjMatrix(_);e.prepareDrawTile(d);const b=i?i.getTile(d):y?y[d.key]:new t.Tile(d,h,c.zoom,e),w=u?Fi(x,a,e,u,{tileID:d,tileSize:h},v):Bi(x,a,o);e.prepareDrawProgram(s,g,_);const{tileBoundsBuffer:M,tileBoundsIndexBuffer:T,tileBoundsSegments:S}=e.getTileBoundsBuffers(b);g.draw(s,l.TRIANGLES,f,p,m,t.CullFaceMode.disabled,w,n.id,M,T,S)}},sky:function(e,i,n){const r=e.transform,o="mercator"===r.projection.name||"globe"===r.projection.name?1:t.smoothstep(7,8,r.zoom),a=n.paint.get("sky-opacity")*o;if(0===a)return;const s=e.context,l=n.paint.get("sky-type"),c=new t.DepthMode(s.gl.LEQUAL,t.DepthMode.ReadOnly,[0,1]),h=e.frameCounter/1e3%1;"atmosphere"===l?"offscreen"===e.renderPass?n.needsSkyboxCapture(e)&&(function(e,i,n,r){const o=e.context,a=o.gl;let s=i.skyboxFbo;if(!s){s=i.skyboxFbo=o.createFramebuffer(32,32,!1),i.skyboxGeometry=new hn(o),i.skyboxTexture=o.gl.createTexture(),a.bindTexture(a.TEXTURE_CUBE_MAP,i.skyboxTexture),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR);for(let t=0;t<6;++t)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,a.RGBA,32,32,0,a.RGBA,a.UNSIGNED_BYTE,null)}o.bindFramebuffer.set(s.framebuffer),o.viewport.set([0,0,32,32]);const l=i.getCenter(e,!0),c=e.useProgram("skyboxCapture"),h=new Float64Array(16);t.identity(h),t.rotateY(h,h,.5*-Math.PI),un(o,i,c,h,l,0),t.identity(h),t.rotateY(h,h,.5*Math.PI),un(o,i,c,h,l,1),t.identity(h),t.rotateX(h,h,.5*-Math.PI),un(o,i,c,h,l,2),t.identity(h),t.rotateX(h,h,.5*Math.PI),un(o,i,c,h,l,3),t.identity(h),un(o,i,c,h,l,4),t.identity(h),t.rotateY(h,h,Math.PI),un(o,i,c,h,l,5),o.viewport.set([0,0,e.width,e.height])}(e,n),n.markSkyboxValid(e)):"sky"===e.renderPass&&function(e,i,n,r,o){const a=e.context,s=a.gl,l=e.transform,c=e.useProgram("skybox");a.activeTexture.set(s.TEXTURE0),s.bindTexture(s.TEXTURE_CUBE_MAP,i.skyboxTexture);const h=((t,e,i,n,r)=>({u_matrix:t,u_sun_direction:e,u_cubemap:0,u_opacity:n,u_temporal_offset:r}))(l.skyboxMatrix,i.getCenter(e,!1),0,r,o);e.prepareDrawProgram(a,c),c.draw(a,s.TRIANGLES,n,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.backCW,h,"skybox",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}(e,n,c,a,h):"gradient"===l&&"sky"===e.renderPass&&function(e,i,n,r,o){const a=e.context,s=a.gl,l=e.transform,c=e.useProgram("skyboxGradient");i.skyboxGeometry||(i.skyboxGeometry=new hn(a)),a.activeTexture.set(s.TEXTURE0);let h=i.colorRampTexture;h||(h=i.colorRampTexture=new t.Texture(a,i.colorRamp,s.RGBA)),h.bind(s.LINEAR,s.CLAMP_TO_EDGE);const u=((e,i,n,r,o)=>({u_matrix:e,u_color_ramp:0,u_center_direction:i,u_radius:t.degToRad(n),u_opacity:r,u_temporal_offset:o}))(l.skyboxMatrix,i.getCenter(e,!1),i.paint.get("sky-gradient-radius"),r,o);e.prepareDrawProgram(a,c),c.draw(a,s.TRIANGLES,n,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.backCW,u,"skyboxGradient",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}(e,n,c,a,h)},debug:function(t,e,i){for(let n=0;n<i.length;n++)an(t,e,i[n])},custom:function(e,i,n){const r=e.context,o=n.implementation;if(e.transform.projection.unsupportedLayers&&e.transform.projection.unsupportedLayers.includes("custom"))t.warnOnce("Custom layers are not yet supported with non-mercator projections. Use mercator to enable custom layers.");else if("offscreen"===e.renderPass){const t=o.prerender;t&&(e.setCustomLayerDefaults(),r.setColorMode(e.colorModeForRenderPass()),t.call(o,r.gl,e.transform.customLayerMatrix()),r.setDirty(),e.setBaseState())}else if("translucent"===e.renderPass){e.setCustomLayerDefaults(),r.setColorMode(e.colorModeForRenderPass()),r.setStencilMode(t.StencilMode.disabled);const i="3d"===o.renderingMode?new t.DepthMode(e.context.gl.LEQUAL,t.DepthMode.ReadWrite,e.depthRangeFor3D):e.depthModeForSublayer(0,t.DepthMode.ReadOnly);r.setDepthMode(i),o.render(r.gl,e.transform.customLayerMatrix()),r.setDirty(),e.setBaseState(),r.bindFramebuffer.set(null)}}};class pn{constructor(e,i){this.context=new pt(e),this.transform=i,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=t.SourceCache.maxUnderzooming+t.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new ke,this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={}}updateTerrain(t,e){const i=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(i||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new di(this,t));const n=this._terrain;this.transform.elevation=i?n:null,n.update(t,this.transform,e)}_updateFog(t){const e=t.fog;if(!e||e.getOpacity(this.transform.pitch)<1||e.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[i,n]=e.getFovAdjustedRange(this.transform._fov);if(i>n)return void(this.transform.fogCullDistSq=null);const r=i+.78*(n-i);this.transform.fogCullDistSq=r*r}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(e,i){if(this.width=e*t.exported.devicePixelRatio,this.height=i*t.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const t of this.style.order)this.style._layers[t].resize()}setup(){const e=this.context,i=new t.StructArrayLayout2i4;i.emplaceBack(0,0),i.emplaceBack(t.EXTENT,0),i.emplaceBack(0,t.EXTENT),i.emplaceBack(t.EXTENT,t.EXTENT),this.tileExtentBuffer=e.createVertexBuffer(i,t.posAttributes.members),this.tileExtentSegments=t.SegmentVector.simpleSegment(0,0,4,2);const n=new t.StructArrayLayout2i4;n.emplaceBack(0,0),n.emplaceBack(t.EXTENT,0),n.emplaceBack(0,t.EXTENT),n.emplaceBack(t.EXTENT,t.EXTENT),this.debugBuffer=e.createVertexBuffer(n,t.posAttributes.members),this.debugSegments=t.SegmentVector.simpleSegment(0,0,4,5);const r=new t.StructArrayLayout2i4;r.emplaceBack(-1,-1),r.emplaceBack(1,-1),r.emplaceBack(-1,1),r.emplaceBack(1,1),this.viewportBuffer=e.createVertexBuffer(r,t.posAttributes.members),this.viewportSegments=t.SegmentVector.simpleSegment(0,0,4,2);const o=new t.StructArrayLayout4i8;o.emplaceBack(0,0,0,0),o.emplaceBack(t.EXTENT,0,t.EXTENT,0),o.emplaceBack(0,t.EXTENT,0,t.EXTENT),o.emplaceBack(t.EXTENT,t.EXTENT,t.EXTENT,t.EXTENT),this.mercatorBoundsBuffer=e.createVertexBuffer(o,t.boundsAttributes.members),this.mercatorBoundsSegments=t.SegmentVector.simpleSegment(0,0,4,2);const a=new t.StructArrayLayout3ui6;a.emplaceBack(0,1,2),a.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=e.createIndexBuffer(a);const s=new t.StructArrayLayout1ui2;for(const t of[0,1,3,2,0])s.emplaceBack(t);this.debugIndexBuffer=e.createIndexBuffer(s),this.emptyTexture=new t.Texture(e,{width:1,height:1,data:new Uint8Array([0,0,0,0])},e.gl.RGBA),this.identityMat=t.create();const l=this.context.gl;this.stencilClearMode=new t.StencilMode({func:l.ALWAYS,mask:0},0,255,l.ZERO,l.ZERO,l.ZERO),this.loadTimeStamps.push(t.window.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const e=this.context,i=e.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.useProgram("clippingMask").draw(e,i.TRIANGLES,t.DepthMode.disabled,this.stencilClearMode,t.ColorMode.disabled,t.CullFaceMode.disabled,si(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(e,i,n){if(!i||this.currentStencilSource===i.id||!e.isTileClipped()||!n||0===n.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let t=!1;for(const e of n)if(void 0===this._tileClippingMaskIDs[e.key]){t=!0;break}if(!t)return}this.currentStencilSource=i.id;const r=this.context,o=r.gl;this.nextStencilID+n.length>256&&this.clearStencil(),r.setColorMode(t.ColorMode.disabled),r.setDepthMode(t.DepthMode.disabled);const a=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const e of n){const n=i.getTile(e),s=this._tileClippingMaskIDs[e.key]=this.nextStencilID++,{tileBoundsBuffer:l,tileBoundsIndexBuffer:c,tileBoundsSegments:h}=this.getTileBoundsBuffers(n);a.draw(r,o.TRIANGLES,t.DepthMode.disabled,new t.StencilMode({func:o.ALWAYS,mask:0},s,255,o.KEEP,o.KEEP,o.REPLACE),t.ColorMode.disabled,t.CullFaceMode.disabled,si(e.projMatrix),"$clipping",l,c,h)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,i=this.context.gl;return new t.StencilMode({func:i.NOTEQUAL,mask:255},e,255,i.KEEP,i.KEEP,i.REPLACE)}stencilModeForClipping(e){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(e);const i=this.context.gl;return new t.StencilMode({func:i.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,i.KEEP,i.KEEP,i.REPLACE)}stencilConfigForOverlap(e){const i=this.context.gl,n=e.sort((t,e)=>e.overscaledZ-t.overscaledZ),r=n[n.length-1].overscaledZ,o=n[0].overscaledZ-r+1;if(o>1){this.currentStencilSource=void 0,this.nextStencilID+o>256&&this.clearStencil();const e={};for(let n=0;n<o;n++)e[n+r]=new t.StencilMode({func:i.GEQUAL,mask:255},n+this.nextStencilID,255,i.KEEP,i.KEEP,i.REPLACE);return this.nextStencilID+=o,[e,n]}return[{[r]:t.StencilMode.disabled},n]}colorModeForRenderPass(){const e=this.context.gl;if(this._showOverdrawInspector){const i=1/8;return new t.ColorMode([e.CONSTANT_COLOR,e.ONE],new t.Color(i,i,i,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?t.ColorMode.unblended:t.ColorMode.alphaBlended}depthModeForSublayer(e,i,n){if(!this.opaquePassEnabledForLayer())return t.DepthMode.disabled;const r=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new t.DepthMode(n||this.context.gl.LEQUAL,i,[r,r])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(e,i){this.style=e,this.options=i,this.lineAtlas=e.lineAtlas,this.imageManager=e.imageManager,this.glyphManager=e.glyphManager,this.symbolFadeChange=e.placement.symbolFadeChange(t.exported.now()),this.imageManager.beginFrame();const n=this.style.order,r=this.style._sourceCaches;for(const t in r){const e=r[t];e.used&&e.prepare(this.context)}const o={},a={},s={};for(const t in r){const e=r[t];o[t]=e.getVisibleCoordinates(),a[t]=o[t].slice().reverse(),s[t]=e.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let t=0;t<n.length;t++)if(this.style._layers[n[t]].is3D()){this.opaquePassCutoff=t;break}if(this.terrain&&(this.terrain.updateTileBinding(s),this.opaquePassCutoff=0),"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new t.GlobeSharedBuffers(this.context)),!t.isMapAuthenticated(this.context.gl))return;this.renderPass="offscreen";for(const t of n){const i=this.style._layers[t],n=e._getLayerSourceCache(i);if(!i.hasOffscreenPass()||i.isHidden(this.transform.zoom))continue;const r=n?a[n.id]:void 0;("custom"===i.type||i.isSky()||r&&r.length)&&this.renderLayer(this,n,i,r)}this.depthRangeFor3D=[0,1-(e.order.length+2)*this.numSublayers*this.depthEpsilon],this.terrain&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&this.terrain.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let l=t.Color.transparent;if(this.style.fog&&this.style.fog.getOpacity(this.transform.pitch)&&(l=this.style.fog.properties.get("color")),this.context.clear({color:i.showOverdrawInspector?t.Color.black:l,depth:1}),this.clearStencil(),this._showOverdrawInspector=i.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=n.length-1;this.currentLayer>=0;this.currentLayer--){const t=this.style._layers[n[this.currentLayer]],i=e._getLayerSourceCache(t);if(t.isSky())continue;const r=i?a[i.id]:void 0;this._renderTileClippingMasks(t,i,r),this.renderLayer(this,i,t,r)}if(this.renderPass="sky",(t.globeToMercatorTransition(this.transform.zoom)>0||"globe"!==this.transform.projection.name)&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<n.length;this.currentLayer++){const t=this.style._layers[n[this.currentLayer]],i=e._getLayerSourceCache(t);t.isSky()&&this.renderLayer(this,i,t,i?a[i.id]:void 0)}for("globe"===this.transform.projection.name&&function(e){const i=e.context,n=i.gl,r=e.transform,o=new t.DepthMode(n.LEQUAL,t.DepthMode.ReadOnly,[0,1]),a=e.useProgram("globeAtmosphere"),s=r._camera.getWorldToCamera(r.worldSize,1),l=r._camera.getCameraToClipPerspective(r._fov,r.width/r.height,r._nearZ,r._farZ),c=t.mul([],s,t.calculateGlobeMatrix(r,r.worldSize)),h=t.mul([],r.labelPlaneMatrix,l),u=t.transformMat4([],[0,0,0],c),d=t.add([],u,[r.worldSize/Math.PI/2,0,0]),p=t.transformMat4([],u,h),f=t.transformMat4([],d,h),m=t.length(t.sub([],f,p)),g=1-t.globeToMercatorTransition(r.zoom),y={u_center:p,u_radius:m,u_screen_size:[r.width,r.height],u_pixel_ratio:t.exported.devicePixelRatio,u_opacity:g,u_fadeout_range:2,u_start_color:[1,1,1],u_end_color:[.0118,.7451,.9882]};e.prepareDrawProgram(i,a);const _=e.globeSharedBuffers;_&&a.draw(i,n.TRIANGLES,o,t.StencilMode.disabled,t.ColorMode.alphaBlended,t.CullFaceMode.backCW,y,"skybox",_.atmosphereVertexBuffer,_.atmosphereIndexBuffer,_.atmosphereSegments)}(this),this.renderPass="translucent",this.currentLayer=0;this.currentLayer<n.length;){const t=this.style._layers[n[this.currentLayer]],i=e._getLayerSourceCache(t);if(t.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(t)){if(t.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const r=i?("symbol"===t.type?s:a)[i.id]:void 0;this._renderTileClippingMasks(t,i,i?o[i.id]:void 0),this.renderLayer(this,i,t,r),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry){let i=null;t.values(this.style._layers).forEach(t=>{const n=e._getLayerSourceCache(t);n&&!t.isHidden(this.transform.zoom)&&(!i||i.getSource().maxzoom<n.getSource().maxzoom)&&(i=n)}),i&&this.options.showTileBoundaries&&dn.debug(this,i,i.getVisibleCoordinates())}this.options.showPadding&&function(t){const e=t.transform.padding;nn(t,t.transform.height-(e.top||0),3,Ji),nn(t,e.bottom||0,3,Ki),rn(t,e.left||0,3,Qi),rn(t,t.transform.width-(e.right||0),3,tn);const i=t.transform.centerPoint;!function(t,e,i,n){on(t,e-1,i-10,2,20,n),on(t,e-10,i-1,20,2,n)}(t,i.x,t.transform.height-i.y,en)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(t.window.performance.now()),this.saveCanvasCopy())}renderLayer(t,e,i,n){i.isHidden(this.transform.zoom)||("background"===i.type||"sky"===i.type||"custom"===i.type||n&&n.length)&&(this.id=i.id,this.gpuTimingStart(i),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(i.type)||dn[i.type](t,e,i,n,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const e=this.context.extTimerQuery;let i=this.gpuTimers[t.id];i||(i=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:e.createQueryEXT()}),i.calls++,e.beginQueryEXT(e.TIME_ELAPSED_EXT,i.query)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const t=this.context.extTimerQuery;t.endQueryEXT(t.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}queryGpuTimers(t){const e={};for(const i in t){const n=t[i],r=this.context.extTimerQuery,o=r.getQueryObjectEXT(n.query,r.QUERY_RESULT_EXT)/1e6;r.deleteQueryEXT(n.query),e[i]=o}return e}translatePosMatrix(e,i,n,r,o){if(!n[0]&&!n[1])return e;const a=o?"map"===r?this.transform.angle:0:"viewport"===r?-this.transform.angle:0;if(a){const t=Math.sin(a),e=Math.cos(a);n=[n[0]*e-n[1]*t,n[0]*t+n[1]*e]}const s=[o?n[0]:E(i,n[0],this.transform.zoom),o?n[1]:E(i,n[1],this.transform.zoom),0],l=new Float32Array(16);return t.translate(l,e,s),l}saveTileTexture(t){const e=this._tileTextures[t.size[0]];e?e.push(t):this._tileTextures[t.size[0]]=[t]}getTileTexture(t){const e=this._tileTextures[t];return e&&e.length>0?e.pop():null}isPatternMissing(t){if(!t)return!1;if(!t.from||!t.to)return!0;const e=this.imageManager.getPattern(t.from.toString()),i=this.imageManager.getPattern(t.to.toString());return!e||!i}currentGlobalDefines(){const t=this.terrain&&this.terrain.renderingToTexture,e=this.style&&this.style.fog,i=[];return this.terrain&&!this.terrain.renderingToTexture&&i.push("TERRAIN"),e&&!t&&0!==e.getOpacity(this.transform.pitch)&&i.push("FOG"),t&&i.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&i.push("OVERDRAW_INSPECTOR"),i}useProgram(t,e,i){this.cache=this.cache||{};const n=i||[],r=this.currentGlobalDefines().concat(n),o=fi.cacheKey(t,r,e);return this.cache[o]||(this.cache[o]=new fi(this.context,t,qe[t],e,Ni[t],r)),this.cache[o]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=t.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new t.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}prepareDrawTile(t){this.terrain&&this.terrain.prepareDrawTile(t)}prepareDrawProgram(t,e,i){if(this.terrain&&this.terrain.renderingToTexture)return;const n=this.style.fog;if(n){const r=n.getOpacity(this.transform.pitch);0!==r&&e.setFogUniformValues(t,((t,e,i,n)=>{const r=e.properties.get("color"),o=t.frameCounter/1e3%1,a=[r.r/r.a,r.g/r.a,r.b/r.a,n];return{u_fog_matrix:i?t.transform.calculateFogTileMatrix(i):t.identityMat,u_fog_range:e.getFovAdjustedRange(t.transform._fov),u_fog_color:a,u_fog_horizon_blend:e.properties.get("horizon-blend"),u_fog_temporal_offset:o}})(this,n,i,r))}}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){this.frameCopies.push(this.canvasCopy()),this.tileLoaded=!1}canvasCopy(){const t=this.context.gl,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),e}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&0!==t.getOpacity(this.transform.pitch)}getBackgroundTiles(){const e=this._backgroundTiles,i=this._backgroundTiles={},n=this.transform.coveringTiles({tileSize:512});for(const r of n)i[r.key]=e[r.key]||new t.Tile(r,512,this.transform.tileZoom,this);return i}clearBackgroundTiles(){this._backgroundTiles={}}}class fn{constructor(t=0,e=0,i=0,n=0){if(isNaN(t)||t<0||isNaN(e)||e<0||isNaN(i)||i<0||isNaN(n)||n<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=e,this.left=i,this.right=n}interpolate(e,i,n){return null!=i.top&&null!=e.top&&(this.top=t.number(e.top,i.top,n)),null!=i.bottom&&null!=e.bottom&&(this.bottom=t.number(e.bottom,i.bottom,n)),null!=i.left&&null!=e.left&&(this.left=t.number(e.left,i.left,n)),null!=i.right&&null!=e.right&&(this.right=t.number(e.right,i.right,n)),this}getCenter(e,i){const n=t.clamp((this.left+e-this.right)/2,0,e),r=t.clamp((this.top+i-this.bottom)/2,0,i);return new t.pointGeometry(n,r)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new fn(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function mn(e,i){const n=t.getColumn(e,3);t.fromQuat(e,i),t.setColumn(e,3,n)}function gn(e,i){t.setColumn(e,3,[i[0],i[1],i[2],1])}function yn(e,i){const n=t.identity$1([]);return t.rotateZ$1(n,n,-i),t.rotateX$1(n,n,-e),n}function _n(e,i){const n=[e[0],e[1],0],r=[i[0],i[1],0];if(t.length(n)>=1e-15){const e=t.normalize([],n);t.scale$2(r,e,t.dot(r,e)),i[0]=r[0],i[1]=r[1]}const o=t.cross([],i,e);if(t.len(o)<1e-15)return null;const a=Math.atan2(-o[1],o[0]);return yn(Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2]),a)}class vn{constructor(t,e){this.position=t,this.orientation=e}get position(){return this._position}set position(e){this._position=this._renderWorldCopies?function(e){if(!e)return;const i=Array.isArray(e)?new t.MercatorCoordinate(e[0],e[1],e[2]):e;return i.x=t.wrap(i.x,0,1),i}(e):e}lookAtPoint(e,i){if(this.orientation=null,!this.position)return;const n=this._elevation?this._elevation.getAtPointOrZero(t.MercatorCoordinate.fromLngLat(e)):0,r=this.position,o=t.MercatorCoordinate.fromLngLat(e,n),a=[o.x-r.x,o.y-r.y,o.z-r.z];i||(i=[0,0,1]),i[2]=Math.abs(i[2]),this.orientation=_n(a,i)}setPitchBearing(e,i){this.orientation=yn(t.degToRad(e),t.degToRad(-i))}}class xn{constructor(e,i){this._transform=t.identity([]),this._orientation=t.identity$1([]),i&&(this._orientation=i,mn(this._transform,this._orientation)),e&&gn(this._transform,e)}get mercatorPosition(){const e=this.position;return new t.MercatorCoordinate(e[0],e[1],e[2])}get position(){const e=t.getColumn(this._transform,3);return[e[0],e[1],e[2]]}set position(t){gn(this._transform,t)}get orientation(){return this._orientation}set orientation(t){this._orientation=t,mn(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),e=this.right();return{bearing:Math.atan2(-e[1],e[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,e){this._orientation=yn(t,e),mn(this._transform,this._orientation)}forward(){const e=t.getColumn(this._transform,2);return[-e[0],-e[1],-e[2]]}up(){const e=t.getColumn(this._transform,1);return[-e[0],-e[1],-e[2]]}right(){const e=t.getColumn(this._transform,0);return[e[0],e[1],e[2]]}getCameraToWorld(e,i){const n=new Float64Array(16);return t.invert(n,this.getWorldToCamera(e,i)),n}getWorldToCameraPosition(e,i,n){const r=this.position;t.scale$2(r,r,-e);const o=new Float64Array(16);return t.fromScaling(o,[n,n,n]),t.translate(o,o,r),o[10]*=i,o}getWorldToCamera(e,i){const n=new Float64Array(16),r=new Float64Array(4),o=this.position;return t.conjugate(r,this._orientation),t.scale$2(o,o,-e),t.fromQuat(n,r),t.translate(n,n,o),n[1]*=-1,n[5]*=-1,n[9]*=-1,n[13]*=-1,n[8]*=i,n[9]*=i,n[10]*=i,n[11]*=i,n}getCameraToClipPerspective(e,i,n,r){const o=new Float64Array(16);return t.perspective(o,e,i,n,r),o}getDistanceToElevation(e){const i=0===e?0:t.mercatorZfromAltitude(e,this.position[1]),n=this.forward();return(i-this.position[2])/n[2]}clone(){return new xn([...this.position],[...this.orientation])}}function bn(e,i){const n=Mn(e),r=function(e,i,n,r,o){const a=new t.LngLat(n.lng-180*Tn,n.lat),s=new t.LngLat(n.lng+180*Tn,n.lat),l=e.project(a.lng,a.lat),c=e.project(s.lng,s.lat),h=-Math.atan2(c.y-l.y,c.x-l.x),u=t.MercatorCoordinate.fromLngLat(n);u.y=t.clamp(u.y,-.999975,.999975);const d=u.toLngLat(),p=e.project(d.lng,d.lat),f=t.MercatorCoordinate.fromLngLat(d);f.x+=Tn;const m=f.toLngLat(),g=e.project(m.lng,m.lat),y=En(g.x-p.x,g.y-p.y,h),_=t.MercatorCoordinate.fromLngLat(d);_.y+=Tn;const v=_.toLngLat(),x=e.project(v.lng,v.lat),b=En(x.x-p.x,x.y-p.y,h),w=Math.abs(y.x)/Math.abs(b.y),M=t.identity([]);t.rotateZ(M,M,-h*(1-(o?0:r)));const T=t.identity([]);return t.scale(T,T,[1,1-(1-w)*r,1]),T[4]=-b.x/b.y*r,t.rotateZ(T,T,h),t.multiply$1(T,M,T),T}(e.projection,0,e.center,n,i),o=wn(e);return t.scale(r,r,[o,o,1]),r}function wn(e){const i=e.projection,n=Mn(e),r=Sn(i,e.center),o=Sn(i,t.LngLat.convert(i.center));return Math.pow(2,r*n+(1-n)*o)}function Mn(e){const i=e.projection.range;if(!i)return 0;const n=Math.max(e.width,e.height),r=Math.log(n/1024)/Math.LN2;return t.smoothstep(i[0]+r,i[1]+r,e.zoom)}const Tn=1/4e4;function Sn(e,i){const n=t.clamp(i.lat,-t.MAX_MERCATOR_LATITUDE,t.MAX_MERCATOR_LATITUDE),r=new t.LngLat(i.lng-180*Tn,n),o=new t.LngLat(i.lng+180*Tn,n),a=e.project(r.lng,n),s=e.project(o.lng,n),l=t.MercatorCoordinate.fromLngLat(r),c=t.MercatorCoordinate.fromLngLat(o),h=s.x-a.x,u=s.y-a.y,d=c.x-l.x,p=c.y-l.y,f=Math.sqrt((d*d+p*p)/(h*h+u*u));return Math.log(f)/Math.LN2}function En(t,e,i){const n=Math.cos(i),r=Math.sin(i);return{x:t*n-e*r,y:t*r+e*n}}class Cn{constructor(e,i,n,r,o){this.tileSize=512,this._renderWorldCopies=void 0===o||o,this._minZoom=e||0,this._maxZoom=i||22,this._minPitch=null==n?0:n,this._maxPitch=null==r?60:r,this.setProjection(),this.setMaxBounds(),this.width=0,this.height=0,this._center=new t.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new fn,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new xn,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._projectionScaler=1,this._horizonShift=.1}clone(){const t=new Cn(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return t.setProjection(this.getProjection()),t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t.tileSize=this.tileSize,t.setMaxBounds(this.getMaxBounds()),t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._cameraZoom=this._cameraZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,t?this._updateCenterElevation()&&this._updateCameraOnTerrain():(this._cameraZoom=null,this._centerAltitude=0),this._calcMatrices())}updateElevation(t){this._terrainEnabled()&&null==this._cameraZoom&&this._updateCenterElevation()&&this._updateCameraOnTerrain(),t&&this._constrainCameraAltitude(),this._calcMatrices()}getProjection(){return t.pick(this.projection,["name","center","parallels"])}setProjection(e){null==e&&(e={name:"mercator"}),this.projectionOptions=e;const i=this.projection?this.getProjection():void 0;return this.projection=t.getProjection(e),!o(i,this.getProjection())&&(this._calcMatrices(),!0)}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(t){void 0===t?t=!0:null===t&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.cameraWorldSize)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new t.pointGeometry(this.width,this.height)}get bearing(){return t.wrap(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(e){const i=-e*Math.PI/180;var n;this.angle!==i&&(this._unmodified=!1,this.angle=i,this._calcMatrices(),this.rotationMatrix=(n=new t.ARRAY_TYPE(4),t.ARRAY_TYPE!=Float32Array&&(n[1]=0,n[2]=0),n[0]=1,n[3]=1,n),function(t,e,i){var n=e[0],r=e[1],o=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);t[0]=n*l+o*s,t[1]=r*l+a*s,t[2]=n*-s+o*l,t[3]=r*-s+a*l}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(e){const i=t.clamp(e,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==i&&(this._unmodified=!1,this._pitch=i,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=t/180*Math.PI,this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices()}get zoom(){return this._zoom}set zoom(t){const e=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==e&&(this._unmodified=!1,this._setZoom(e),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}_updateCenterElevation(){if(!this._elevation)return!1;const t=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center),-1);return-1===t?(this._cameraZoom=null,!1):(this._centerAltitude=t,!0)}_updateCameraOnTerrain(){this._cameraZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize)}sampleAverageElevation(){if(!this._elevation)return 0;const e=this._elevation,i=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],n=this.horizonLineFromTop();let r=0,o=0;for(let a=0;a<i.length;a++){const s=new t.pointGeometry(i[a][0]*this.width,n+i[a][1]*(this.height-n)),l=e.pointCoordinate(s);if(!l)continue;const c=1/Math.hypot(l[0]-this._camera.position[0],l[1]-this._camera.position[1]);r+=l[3]*c,o+=c}return 0===o?NaN:r/o}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCenterElevation()?this._updateCameraOnTerrain():this._cameraZoom=null:this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._cameraZoom||!this._elevation)return;const t=this._cameraZoom,e=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),i=this.pixelsPerMeter/this.worldSize*e,n=this._mercatorZfromZoom(t),r=this._mercatorZfromZoom(this._maxZoom),o=Math.max(n-i,r);this._setZoom(this._zoomFromMercatorZ(o))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(e){const i=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,e.toAltitude()));let n;n=e.z<this._camera.position[2]?[i.x,i.y,i.z]:[e.x,e.y,e.z];const r=t.length(t.sub([],this._camera.position,n));return t.clamp(this._zoomFromMercatorZ(r),this._minZoom,this._maxZoom)}setFreeCameraOptions(e){if(!this.height)return;if(!e.position&&!e.orientation)return;this._updateCameraState();let i=!1;if(e.orientation&&!t.exactEquals(e.orientation,this._camera.orientation)&&(i=this._setCameraOrientation(e.orientation)),e.position){const n=[e.position.x,e.position.y,e.position.z];t.exactEquals$1(n,this._camera.position)||(this._setCameraPosition(n),i=!0)}i&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const e=this._camera.position,i=new vn;return i.position=new t.MercatorCoordinate(e[0],e[1],e[2]),i.orientation=this._camera.orientation,i._elevation=this.elevation,i._renderWorldCopies=this.renderWorldCopies,i}_setCameraOrientation(e){if(!t.length$1(e))return!1;t.normalize$1(e,e);const i=t.transformQuat([],[0,0,-1],e),n=t.transformQuat([],[0,-1,0],e);if(n[2]<0)return!1;const r=_n(i,n);return!!r&&(this._camera.orientation=r,!0)}_setCameraPosition(e){const i=this.zoomScale(this.minZoom)*this.tileSize,n=this.zoomScale(this.maxZoom)*this.tileSize,r=this.cameraToCenterDistance;e[2]=t.clamp(e[2],r/n,r/i),this._camera.position=e}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,e,i){this._unmodified=!1,this._edgeInsets.interpolate(t,e,i),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const e=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,e)}getVisibleUnwrappedCoordinates(e){const i=[new t.UnwrappedTileID(0,e)];if(this.renderWorldCopies){const n=this.pointCoordinate(new t.pointGeometry(0,0)),r=this.pointCoordinate(new t.pointGeometry(this.width,0)),o=this.pointCoordinate(new t.pointGeometry(this.width,this.height)),a=this.pointCoordinate(new t.pointGeometry(0,this.height)),s=Math.floor(Math.min(n.x,r.x,o.x,a.x)),l=Math.floor(Math.max(n.x,r.x,o.x,a.x)),c=1;for(let n=s-c;n<=l+c;n++)0!==n&&i.push(new t.UnwrappedTileID(n,e))}return i}coveringTiles(e){let i=this.coveringZoomLevel(e);const n=i,r=this.elevation&&!e.isTerrainDEM,o="mercator"===this.projection.name;if(void 0!==e.minzoom&&i<e.minzoom)return[];void 0!==e.maxzoom&&i>e.maxzoom&&(i=e.maxzoom);const a=this.locationCoordinate(this.center),s=1<<i,l=[s*a.x,s*a.y,0],c=t.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,i,"globe"!==this.projection.name),h=this.pointCoordinate(this.getCameraPoint()),u=s*t.mercatorZfromAltitude(1,this.center.lat),d=this._camera.position[2]/t.mercatorZfromAltitude(1,this.center.lat),p=[s*h.x,s*h.y,d],f=this.cameraToCenterDistance/e.tileSize*(e.roundZoom?1:.502),m=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?i:0,g=e.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,y=e.isTerrainDEM?-g:this._elevation?this._elevation.getMinElevationBelowMSL():0,_=this.projection.isReprojectedInTileSpace?wn(this):1,v=e=>{const i=1/4e4,n=new t.MercatorCoordinate(e.x+i,e.y,e.z),r=new t.MercatorCoordinate(e.x,e.y+i,e.z),o=e.toLngLat(),a=n.toLngLat(),s=r.toLngLat(),l=this.locationCoordinate(o),c=this.locationCoordinate(a),h=this.locationCoordinate(s),u=Math.hypot(c.x-l.x,c.y-l.y),d=Math.hypot(h.x-l.x,h.y-l.y);return Math.sqrt(u*d)*_/i},x=e=>{const i=g,n=y;return{aabb:t.tileAABB(this,s,0,0,0,e,n,i,this.projection),zoom:0,x:0,y:0,minZ:n,maxZ:i,wrap:e,fullyVisible:!1}},b=[];let w=[];const M=i,T=e.reparseOverscaled?n:i,S=t=>t*t,E=S((d-this._centerAltitude)*u),C=t=>{if(!this._elevation||!t.tileID||!o)return;const e=this._elevation.getMinMaxForTile(t.tileID),i=t.aabb;e?(i.min[2]=e.min,i.max[2]=e.max,i.center[2]=(i.min[2]+i.max[2])/2):(t.shouldSplit=A(t),t.shouldSplit||(i.min[2]=i.max[2]=i.center[2]=this._centerAltitude))},A=e=>{if(e.zoom<m)return!0;if(e.zoom===M)return!1;if(null!=e.shouldSplit)return e.shouldSplit;const i=e.aabb.distanceX(p),o=e.aabb.distanceY(p);let a=E;r&&(a=S(e.aabb.distanceZ(p)*u));let s=1;if(this.projection.isReprojectedInTileSpace&&n<=5){const i=Math.pow(2,e.zoom),n=v(new t.MercatorCoordinate((e.x+.5)/i,(e.y+.5)/i));s=n>.85?1:n}const l=i*i+o*o+a;return l<S((1<<M-e.zoom)*f*s*((t,e)=>{if(e*S(.707)<t)return 1;const i=Math.sqrt(e/t);return i/(1.4144271570014144+(Math.pow(1.1,i-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(a,E),l))};if(this.renderWorldCopies)for(let t=1;t<=3;t++)b.push(x(-t)),b.push(x(t));for(b.push(x(0));b.length>0;){const n=b.pop(),a=n.x,h=n.y;let u=n.fullyVisible;if(!u){const t=n.aabb.intersects(c);if(0===t)continue;u=2===t}if(n.zoom!==M&&A(n))for(let e=0;e<4;e++){const i=(a<<1)+e%2,l=(h<<1)+(e>>1),c={aabb:o?n.aabb.quadrant(e):t.tileAABB(this,s,n.zoom+1,i,l,n.wrap,n.minZ,n.maxZ,this.projection),zoom:n.zoom+1,x:i,y:l,wrap:n.wrap,fullyVisible:u,tileID:void 0,shouldSplit:void 0,minZ:n.minZ,maxZ:n.maxZ};r&&(c.tileID=new t.OverscaledTileID(n.zoom+1===M?T:n.zoom+1,n.wrap,n.zoom+1,i,l),C(c)),b.push(c)}else{const r=n.zoom===M?T:n.zoom;if(e.minzoom&&e.minzoom>r)continue;const o=l[0]-(.5+a+(n.wrap<<n.zoom))*(1<<i-n.zoom),s=l[1]-.5-h,c=n.tileID?n.tileID:new t.OverscaledTileID(r,n.wrap,n.zoom,a,h);w.push({tileID:c,distanceSq:o*o+s*s})}}if(this.fogCullDistSq){const i=this.fogCullDistSq,n=this.horizonLineFromTop();w=w.filter(r=>{const o=[0,0,0,1],a=[t.EXTENT,t.EXTENT,0,1],s=this.calculateFogTileMatrix(r.tileID.toUnwrapped());t.transformMat4$1(o,o,s),t.transformMat4$1(a,a,s);const l=t.getAABBPointSquareDist(o,a);if(0===l)return!0;let c=!1;const h=this._elevation;if(h&&l>i&&0!==n){const i=this.calculateProjMatrix(r.tileID.toUnwrapped());let o;e.isTerrainDEM||(o=h.getMinMaxForTile(r.tileID)),o||(o={min:y,max:g});const a=t.furthestTileCorner(this.rotation),s=[a[0]*t.EXTENT,a[1]*t.EXTENT,o.max];t.transformMat4(s,s,i),c=(1-s[1])*this.height*.5<n}return l<i||c})}return w.sort((t,e)=>t.distanceSq-e.distanceSq).map(t=>t.tileID)}resize(t,e){this.width=t,this.height=e,this.pixelsToGLUnits=[2/t,-2/e],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(e){const i=t.clamp(e.lat,-t.MAX_MERCATOR_LATITUDE,t.MAX_MERCATOR_LATITUDE),n=this.projection.project(e.lng,i);return new t.pointGeometry(n.x*this.worldSize,n.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}setLocationAtPoint(e,i){const n=this.pointCoordinate(i),r=this.pointCoordinate(this.centerPoint),o=this.locationCoordinate(e);this.setLocation(new t.MercatorCoordinate(o.x-(n.x-r.x),o.y-(n.y-r.y)))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t){return this.projection.locationPoint(this,t)}locationPoint3D(t){return this._coordinatePoint(this.locationCoordinate(t),!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t){return this.coordinateLocation(this.pointCoordinate3D(t))}locationCoordinate(e,i){const n=i?t.mercatorZfromAltitude(i,e.lat):void 0,r=this.projection.project(e.lng,e.lat);return new t.MercatorCoordinate(r.x,r.y,n)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(e,i){const n=null!=i?i:this._centerAltitude,r=[e.x,e.y,0,1],o=[e.x,e.y,1,1];t.transformMat4$1(r,r,this.pixelMatrixInverse),t.transformMat4$1(o,o,this.pixelMatrixInverse);const a=o[3];t.scale$1(r,r,1/r[3]),t.scale$1(o,o,1/a);const s=r[2],l=o[2];return{p0:r,p1:o,t:s===l?0:(n-s)/(l-s)}}screenPointToMercatorRay(e){const i=[e.x,e.y,0,1],n=[e.x,e.y,1,1];return t.transformMat4$1(i,i,this.pixelMatrixInverse),t.transformMat4$1(n,n,this.pixelMatrixInverse),t.scale$1(i,i,1/i[3]),t.scale$1(n,n,1/n[3]),i[2]=t.mercatorZfromAltitude(i[2],this._center.lat)*this.worldSize,n[2]=t.mercatorZfromAltitude(n[2],this._center.lat)*this.worldSize,t.scale$1(i,i,1/this.worldSize),t.scale$1(n,n,1/this.worldSize),new t.Ray([i[0],i[1],i[2]],t.normalize([],t.sub([],n,i)))}rayIntersectionCoordinate(e){const{p0:i,p1:n,t:r}=e,o=t.mercatorZfromAltitude(i[2],this._center.lat),a=t.mercatorZfromAltitude(n[2],this._center.lat);return new t.MercatorCoordinate(t.number(i[0],n[0],r)/this.worldSize,t.number(i[1],n[1],r)/this.worldSize,t.number(o,a,r))}pointCoordinate(t,e=this._centerAltitude){return this.projection.createTileTransform(this,this.worldSize).pointCoordinate(t.x,t.y,e)}pointCoordinate3D(e){if(!this.elevation)return this.pointCoordinate(e);const i=this.elevation;let n=this.elevation.pointCoordinate(e);if(n)return new t.MercatorCoordinate(n[0],n[1],n[2]);let r=0,o=this.horizonLineFromTop();if(e.y>o)return this.pointCoordinate(e);const a=.02*o,s=e.clone();for(let e=0;e<10&&o-r>a;e++){s.y=t.number(r,o,.66);const e=i.pointCoordinate(s);e?(o=s.y,n=e):r=s.y}return n?new t.MercatorCoordinate(n[0],n[1],n[2]):this.pointCoordinate(e)}isPointAboveHorizon(t){if(this.elevation)return!this.elevation.pointCoordinate(t);{const e=this.horizonLineFromTop();return t.y<e}}_coordinatePoint(e,i){const n=i&&this.elevation?this.elevation.getAtPointOrZero(e,this._centerAltitude):this._centerAltitude,r=[e.x*this.worldSize,e.y*this.worldSize,n+e.toAltitude(),1];return t.transformMat4$1(r,r,this.pixelMatrix),r[3]>0?new t.pointGeometry(r[0]/r[3],r[1]/r[3]):new t.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE)}_getBounds(e,i){const n=new t.pointGeometry(this._edgeInsets.left,this._edgeInsets.top),r=new t.pointGeometry(this.width-this._edgeInsets.right,this._edgeInsets.top),o=new t.pointGeometry(this.width-this._edgeInsets.right,this.height-this._edgeInsets.bottom),a=new t.pointGeometry(this._edgeInsets.left,this.height-this._edgeInsets.bottom);let s=this.pointCoordinate(n,e),l=this.pointCoordinate(r,e);const c=this.pointCoordinate(o,i),h=this.pointCoordinate(a,i),u=(t,e)=>(e.y-t.y)/(e.x-t.x);return s.y>1&&l.y>=0?s=new t.MercatorCoordinate((1-h.y)/u(h,s)+h.x,1):s.y<0&&l.y<=1&&(s=new t.MercatorCoordinate(-h.y/u(h,s)+h.x,0)),l.y>1&&s.y>=0?l=new t.MercatorCoordinate((1-c.y)/u(c,l)+c.x,1):l.y<0&&s.y<=1&&(l=new t.MercatorCoordinate(-c.y/u(c,l)+c.x,0)),(new t.LngLatBounds).extend(this.coordinateLocation(s)).extend(this.coordinateLocation(l)).extend(this.coordinateLocation(h)).extend(this.coordinateLocation(c))}_getBounds3D(){const t=this.elevation;if(!t.visibleDemTiles.length)return this._getBounds(0,0);const e=t.visibleDemTiles.reduce((t,e)=>{if(e.dem){const i=e.dem.tree;t.min=Math.min(t.min,i.minimums[0]),t.max=Math.max(t.max,i.maximums[0])}return t},{min:Number.MAX_VALUE,max:0});return this._getBounds(e.min*t.exaggeration(),e.max*t.exaggeration())}getBounds(){return this._terrainEnabled()?this._getBounds3D():this._getBounds(0,0)}horizonLineFromTop(t=!0){const e=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,i=this.height/2-e*(1-this._horizonShift);return t?Math.max(0,i):i}getMaxBounds(){return this.maxBounds}setMaxBounds(e){this.maxBounds=e,this.minLat=-t.MAX_MERCATOR_LATITUDE,this.maxLat=t.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,e&&(this.minLat=e.getSouth(),this.maxLat=e.getNorth(),this.minLng=e.getWest(),this.maxLng=e.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=t.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=t.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=t.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=t.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,e){return this.projection.createTileTransform(this,e).createTileMatrix(t)}calculateDistanceTileData(e){const i=e.key,n=this._distanceTileDataCache;if(n[i])return n[i];const r=e.canonical,o=1/this.height,a=this.cameraWorldSize/this.zoomScale(r.z),s=(r.x+Math.pow(2,r.z)*e.wrap)*a,l=r.y*a,c=this.point,h=this.angle,u=Math.sin(-h),d=-Math.cos(-h);return n[i]={bearing:[u,d],center:[(c.x-s)*o,(c.y-l)*o],scale:a/t.EXTENT*o},n[i]}calculateFogTileMatrix(e){const i=e.key,n=this._fogTileMatrixCache;if(n[i])return n[i];const r=this.calculatePosMatrix(e,this.cameraWorldSize);return t.multiply$1(r,this.worldToFogMatrix,r),n[i]=new Float32Array(r),n[i]}calculateProjMatrix(e,i=!1){const n=e.key,r=i?this._alignedProjMatrixCache:this._projMatrixCache;if(r[n])return r[n];const o=this.calculatePosMatrix(e,this.worldSize);return t.multiply$1(o,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:i?this.alignedProjMatrix:this.projMatrix,o),r[n]=new Float32Array(o),r[n]}calculatePixelsToTileUnitsMatrix(e){const i=e.tileID.key,n=this._pixelsToTileUnitsCache;if(n[i])return n[i];const r=function(e,i){const{scale:n}=e.tileTransform,r=n*t.EXTENT/(e.tileSize*Math.pow(2,i.zoom-e.tileID.overscaledZ+e.tileID.canonical.z));return o=new Float32Array(4),l=(a=i.inverseAdjustmentMatrix)[1],c=a[2],h=a[3],d=(s=[r,r])[1],o[0]=a[0]*(u=s[0]),o[1]=l*u,o[2]=c*d,o[3]=h*d,o;var o,a,s,l,c,h,u,d}(e,this);return n[i]=r,n[i]}customLayerMatrix(){return this.mercatorMatrix.slice()}recenterOnTerrain(){if(!this._elevation)return;const e=this._elevation;this._updateCameraState();const i=t.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,n=this._computeCameraPosition(i),r=this._camera.forward(),o=t.mercatorZfromAltitude(1,this._center.lat);n[2]/=o,r[2]/=o,t.normalize(r,r);const a=e.raycast(n,r,e.exaggeration());if(a){const e=t.scaleAndAdd([],n,r,a),i=new t.MercatorCoordinate(e[0],e[1],t.mercatorZfromAltitude(e[2],t.latFromMercatorY(e[1]))),s=(i.z+t.length([i.x-n[0],i.y-n[1],i.z-n[2]*o]))*this._projectionScaler;this._cameraZoom=this._zoomFromMercatorZ(s),this._centerAltitude=i.toAltitude(),this._center=this.coordinateLocation(i),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCameraAltitude(){if(!this._elevation)return;const e=this._elevation;this._updateCameraState();const i=t.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,n=this._computeCameraPosition(i),r=e.getAtPointOrZero(new t.MercatorCoordinate(...n)),o=this._minimumHeightOverTerrain()*Math.cos(t.degToRad(this._maxPitch)),a=this._camera.position[2]-this.pixelsPerMeter/this.worldSize*r;if(a<o){const e=this.locationCoordinate(this._center,this._centerAltitude),i=[e.x-n[0],e.y-n[1],e.z-n[2]],r=t.length(i);i[2]-=(o-a)/this._projectionScaler;const s=t.length(i);if(0===s)return;t.scale$2(i,i,r/s*this._projectionScaler),this._camera.position=[e.x-i[0],e.y-i[1],e.z*this._projectionScaler-i[2]],this._camera.orientation=_n(i,this._camera.up()),this._updateStateFromCamera()}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;if(this._constraining=!0,this.projection.isReprojectedInTileSpace){const e=this.center;return e.lat=t.clamp(e.lat,this.minLat,this.maxLat),!this.maxBounds&&this.renderWorldCopies||(e.lng=t.clamp(e.lng,this.minLng,this.maxLng)),this.center=e,void(this._constraining=!1)}const e=this._unmodified,{x:i,y:n}=this.point;let r=0,o=i,a=n;const s=this.width/2,l=this.height/2,c=this.worldMinY*this.scale,h=this.worldMaxY*this.scale;if(n-l<c&&(a=c+l),n+l>h&&(a=h-l),h-c<this.height&&(r=Math.max(r,this.height/(h-c)),a=(h+c)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const t=this.worldMinX*this.scale,e=this.worldMaxX*this.scale,n=this.worldSize/2-(t+e)/2;o=(i+n+this.worldSize)%this.worldSize-n,o-s<t&&(o=t+s),o+s>e&&(o=e-s),e-t<this.width&&(r=Math.max(r,this.width/(e-t)),o=(e+t)/2)}o===i&&a===n||(this.center=this.unproject(new t.pointGeometry(o,a))),r&&(this.zoom+=this.scaleZoom(r)),this._constrainCameraAltitude(),this._unmodified=e,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const e=this._fov/2,i=this.centerOffset,n=this.pixelsPerMeter;this._projectionScaler=n/(t.mercatorZfromAltitude(1,this.center.lat)*this.worldSize),this.cameraToCenterDistance=.5/Math.tan(e)*this.height*this._projectionScaler,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const o=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?n:1),a=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);a[8]=2*-i.x/this.width,a[9]=2*i.y/this.height;let s=t.mul([],a,o);if(this.projection.isReprojectedInTileSpace){const e=this.locationCoordinate(this.center),i=t.identity([]);t.translate(i,i,[e.x*this.worldSize,e.y*this.worldSize,0]),t.multiply$1(i,i,bn(this)),t.translate(i,i,[-e.x*this.worldSize,-e.y*this.worldSize,0]),t.multiply$1(s,s,i),this.inverseAdjustmentMatrix=function(t){const e=bn(t,!0);return r([],[e[0],e[1],e[4],e[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=t.scale([],s,[this.worldSize,this.worldSize,this.worldSize/n,1]),this.projMatrix=s,this.invProjMatrix=t.invert(new Float64Array(16),this.projMatrix);const l=new Float32Array(16);t.identity(l),t.scale(l,l,[1,-1,1]),t.rotateX(l,l,this._pitch),t.rotateZ(l,l,this.angle);const c=t.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),h=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;c[8]=2*-i.x/this.width,c[9]=2*(i.y+h)/this.height,this.skyboxMatrix=t.multiply$1(l,c,l);const u=this.point,d=u.x,p=u.y,f=this.width%2/2,m=this.height%2/2,g=Math.cos(this.angle),y=Math.sin(this.angle),_=d-Math.round(d)+g*f+y*m,v=p-Math.round(p)+g*m+y*f,x=new Float64Array(s);if(t.translate(x,x,[_>.5?_-1:_,v>.5?v-1:v,0]),this.alignedProjMatrix=x,s=t.create(),t.scale(s,s,[this.width/2,-this.height/2,1]),t.translate(s,s,[1,-1,0]),this.labelPlaneMatrix=s,s=t.create(),t.scale(s,s,[1,-1,1]),t.translate(s,s,[-1,-1,0]),t.scale(s,s,[2/this.width,2/this.height,1]),this.glCoordMatrix=s,this.pixelMatrix=t.multiply$1(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},s=t.invert(new Float64Array(16),this.pixelMatrix),!s)throw new Error("failed to invert matrix");this.pixelMatrixInverse=s,this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const e=this.cameraWorldSize,i=this.cameraPixelsPerMeter,n=this._camera.position,r=1/this.height,o=[e,e,i];t.scale$2(o,o,r),t.scale$2(n,n,-1),t.multiply$2(n,n,o);const a=t.create();t.translate(a,a,n),t.scale(a,a,o),this.mercatorFogMatrix=a,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(e,i,r)}_computeCameraPosition(t){const e=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,i=this._camera.forward(),n=this.point,r=this._mercatorZfromZoom(this._cameraZoom?this._cameraZoom:this._zoom)*e-t/this.worldSize*this._centerAltitude;return[n.x/this.worldSize-i[0]*r,n.y/this.worldSize-i[1]*r,t/this.worldSize*this._centerAltitude-i[2]*r]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(e){const i=this._maxCameraBoundsDistance()*Math.cos(this._pitch),n=e[2];let r=1;n>0&&(r=Math.min((i-this._camera.position[2])/n,1)),this._camera.position=t.scaleAndAdd([],this._camera.position,e,r),this._updateStateFromCamera()}_updateStateFromCamera(){const e=this._camera.position,i=this._camera.forward(),{pitch:n,bearing:r}=this._camera.getPitchBearing(),o=t.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._projectionScaler,a=this._mercatorZfromZoom(this._maxZoom)*Math.cos(t.degToRad(this._maxPitch)),s=Math.max((e[2]-o)/Math.cos(n),a),l=this._zoomFromMercatorZ(s);t.scaleAndAdd(e,e,i,s),this._pitch=t.clamp(n,t.degToRad(this.minPitch),t.degToRad(this.maxPitch)),this.angle=t.wrap(r,-Math.PI,Math.PI),this._setZoom(t.clamp(l,this._minZoom,this._maxZoom)),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._center=this.coordinateLocation(new t.MercatorCoordinate(e[0],e[1],e[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min((null!=this._cameraZoom?this._cameraZoom:this._zoom)+2,this._maxZoom);return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(t.warnOnce("Terrain is not yet supported with alternate projections. Use mercator to enable terrain."),1))}anyCornerOffEdge(e,i){const n=Math.min(e.x,i.x),r=Math.max(e.x,i.x),o=Math.min(e.y,i.y),a=Math.max(e.y,i.y);if(o<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const s=[new t.pointGeometry(n,o),new t.pointGeometry(r,a),new t.pointGeometry(n,a),new t.pointGeometry(r,o)],l=this.renderWorldCopies?-3:0,c=this.renderWorldCopies?4:1;for(const t of s){const e=this.pointRayIntersection(t);if(e.t<0)return!0;const i=this.rayIntersectionCoordinate(e);if(i.x<l||i.y<0||i.x>c||i.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+t.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new t.pointGeometry(0,0),new t.pointGeometry(this.width,this.height))}zoomDeltaToMovement(e,i){const n=t.length(t.sub([],this._camera.position,e)),r=this._zoomFromMercatorZ(n)+i;return n-this._mercatorZfromZoom(r)}getCameraPoint(){const e=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new t.pointGeometry(0,e))}}function An(t,e){let i=!1,n=null;const r=()=>{n=null,i&&(t(),n=setTimeout(r,e),i=!1)};return()=>(i=!0,n||r(),n)}class Pn{constructor(e){this._hashName=e&&encodeURIComponent(e),t.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=An(this._updateHashUnthrottled.bind(this),300)}addTo(e){return this._map=e,t.window.addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return t.window.removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(e){const i=this._map.getCenter(),n=Math.round(100*this._map.getZoom())/100,r=Math.ceil((n*Math.LN2+Math.log(512/360/.5))/Math.LN10),o=Math.pow(10,r),a=Math.round(i.lng*o)/o,s=Math.round(i.lat*o)/o,l=this._map.getBearing(),c=this._map.getPitch();let h="";if(h+=e?`/${a}/${s}/${n}`:`${n}/${s}/${a}`,(l||c)&&(h+="/"+Math.round(10*l)/10),c&&(h+="/"+Math.round(c)),this._hashName){const e=this._hashName;let i=!1;const n=t.window.location.hash.slice(1).split("&").map(t=>{const n=t.split("=")[0];return n===e?(i=!0,`${n}=${h}`):t}).filter(t=>t);return i||n.push(`${e}=${h}`),"#"+n.join("&")}return"#"+h}_getCurrentHash(){const e=t.window.location.hash.replace("#","");if(this._hashName){let t;return e.split("&").map(t=>t.split("=")).forEach(e=>{e[0]===this._hashName&&(t=e)}),(t&&t[1]||"").split("/")}return e.split("/")}_onHashChange(){const t=this._getCurrentHash();if(t.length>=3&&!t.some(t=>isNaN(t))){const e=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(t[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+t[2],+t[1]],zoom:+t[0],bearing:e,pitch:+(t[4]||0)}),!0}return!1}_updateHashUnthrottled(){const e=t.window.location.href.replace(/(#.+)?$/,this.getHashString());t.window.history.replaceState(t.window.history.state,null,e)}}const Ln={linearity:.3,easing:t.bezier(0,0,.3,1)},In=t.extend({deceleration:2500,maxSpeed:1400},Ln),Rn=t.extend({deceleration:20,maxSpeed:1400},Ln),Dn=t.extend({deceleration:1e3,maxSpeed:360},Ln),kn=t.extend({deceleration:1e3,maxSpeed:90},Ln);class On{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(e){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:t.exported.now(),settings:e})}_drainInertiaBuffer(){const e=this._inertiaBuffer,i=t.exported.now();for(;e.length>0&&i-e[0].time>160;)e.shift()}_onMoveEnd(e){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const i={zoom:0,bearing:0,pitch:0,pan:new t.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:t}of this._inertiaBuffer)i.zoom+=t.zoomDelta||0,i.bearing+=t.bearingDelta||0,i.pitch+=t.pitchDelta||0,t.panDelta&&i.pan._add(t.panDelta),t.around&&(i.around=t.around),t.pinchAround&&(i.pinchAround=t.pinchAround);const n=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,r={};if(i.pan.mag()){const o=Bn(i.pan.mag(),n,t.extend({},In,e||{}));r.offset=i.pan.mult(o.amount/i.pan.mag()),r.center=this._map.transform.center,zn(r,o)}if(i.zoom){const t=Bn(i.zoom,n,Rn);r.zoom=this._map.transform.zoom+t.amount,zn(r,t)}if(i.bearing){const e=Bn(i.bearing,n,Dn);r.bearing=this._map.transform.bearing+t.clamp(e.amount,-179,179),zn(r,e)}if(i.pitch){const t=Bn(i.pitch,n,kn);r.pitch=this._map.transform.pitch+t.amount,zn(r,t)}if(r.zoom||r.bearing){const t=void 0===i.pinchAround?i.around:i.pinchAround;r.around=t?this._map.unproject(t):this._map.getCenter()}return this.clear(),t.extend(r,{noMoveStart:!0})}}function zn(t,e){(!t.duration||t.duration<e.duration)&&(t.duration=e.duration,t.easing=e.easing)}function Bn(e,i,n){const{maxSpeed:r,linearity:o,deceleration:a}=n,s=t.clamp(e*o/(i/1e3),-r,r),l=Math.abs(s)/(a*o);return{easing:n.easing,duration:1e3*l,amount:s*(l/2)}}class Fn extends t.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,i,n,r={}){const o=a.mousePos(i.getCanvasContainer(),n),s=i.unproject(o);super(e,t.extend({point:o,lngLat:s,originalEvent:n},r)),this._defaultPrevented=!1,this.target=i}}class Nn extends t.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,i,n){const r="touchend"===e?n.changedTouches:n.touches,o=a.touchPos(i.getCanvasContainer(),r),s=o.map(t=>i.unproject(t)),l=o.reduce((t,e,i,n)=>t.add(e.div(n.length)),new t.pointGeometry(0,0));super(e,{points:o,point:l,lngLats:s,lngLat:i.unproject(l),originalEvent:n}),this._defaultPrevented=!1}}class jn extends t.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,e,i){super(t,{originalEvent:i}),this._defaultPrevented=!1}}class Gn{constructor(t,e){this._map=t,this._clickTolerance=e.clickTolerance}reset(){delete this._mousedownPos}wheel(t){return this._firePreventable(new jn(t.type,this._map,t))}mousedown(t,e){return this._mousedownPos=e,this._firePreventable(new Fn(t.type,this._map,t))}mouseup(t){this._map.fire(new Fn(t.type,this._map,t))}preclick(e){const i=t.extend({},e);i.type="preclick",this._map.fire(new Fn(i.type,this._map,i))}click(t,e){this._mousedownPos&&this._mousedownPos.dist(e)>=this._clickTolerance||(this.preclick(t),this._map.fire(new Fn(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new Fn(t.type,this._map,t))}mouseover(t){this._map.fire(new Fn(t.type,this._map,t))}mouseout(t){this._map.fire(new Fn(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Nn(t.type,this._map,t))}touchmove(t){this._map.fire(new Nn(t.type,this._map,t))}touchend(t){this._map.fire(new Nn(t.type,this._map,t))}touchcancel(t){this._map.fire(new Nn(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Un{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,delete this._contextMenuEvent}mousemove(t){this._map.fire(new Fn(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Fn("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new Fn(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Vn{constructor(t,e){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=e.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,e){this.isEnabled()&&t.shiftKey&&0===t.button&&(a.disableDrag(),this._startPos=this._lastPos=e,this._active=!0)}mousemoveWindow(t,e){if(!this._active)return;const i=e;if(this._lastPos.equals(i)||!this._box&&i.dist(this._startPos)<this._clickTolerance)return;const n=this._startPos;this._lastPos=i,this._box||(this._box=a.create("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const r=Math.min(n.x,i.x),o=Math.max(n.x,i.x),s=Math.min(n.y,i.y),l=Math.max(n.y,i.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${r}px,${s}px)`,this._box.style.width=o-r+"px",this._box.style.height=l-s+"px")})}mouseupWindow(e,i){if(!this._active)return;if(0!==e.button)return;const n=this._startPos,r=i;if(this.reset(),a.suppressClick(),n.x!==r.x||n.y!==r.y)return this._map.fire(new t.Event("boxzoomend",{originalEvent:e})),{cameraAnimation:t=>t.fitScreenCoordinates(n,r,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",e)}keydown(t){this._active&&27===t.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),a.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(e,i){return this._map.fire(new t.Event(e,{originalEvent:i}))}}function Hn(t,e){const i={};for(let n=0;n<t.length;n++)i[t[n].identifier]=e[n];return i}class Zn{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(e,i,n){(this.centroid||n.length>this.numTouches)&&(this.aborted=!0),this.aborted||(void 0===this.startTime&&(this.startTime=e.timeStamp),n.length===this.numTouches&&(this.centroid=function(e){const i=new t.pointGeometry(0,0);for(const t of e)i._add(t);return i.div(e.length)}(i),this.touches=Hn(n,i)))}touchmove(t,e,i){if(this.aborted||!this.centroid)return;const n=Hn(i,e);for(const t in this.touches){const e=this.touches[t],i=n[t];(!i||i.dist(e)>30)&&(this.aborted=!0)}}touchend(t,e,i){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),0===i.length){const t=!this.aborted&&this.centroid;if(this.reset(),t)return t}}}class Wn{constructor(t){this.singleTap=new Zn(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(t,e,i){this.singleTap.touchstart(t,e,i)}touchmove(t,e,i){this.singleTap.touchmove(t,e,i)}touchend(t,e,i){const n=this.singleTap.touchend(t,e,i);if(n){const e=t.timeStamp-this.lastTime<500,i=!this.lastTap||this.lastTap.dist(n)<30;if(e&&i||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=n,this.count===this.numTaps)return this.reset(),n}}}class qn{constructor(){this._zoomIn=new Wn({numTouches:1,numTaps:2}),this._zoomOut=new Wn({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,e,i){this._zoomIn.touchstart(t,e,i),this._zoomOut.touchstart(t,e,i)}touchmove(t,e,i){this._zoomIn.touchmove(t,e,i),this._zoomOut.touchmove(t,e,i)}touchend(t,e,i){const n=this._zoomIn.touchend(t,e,i),r=this._zoomOut.touchend(t,e,i);return n?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:e=>e.easeTo({duration:300,zoom:e.getZoom()+1,around:e.unproject(n)},{originalEvent:t})}):r?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:e=>e.easeTo({duration:300,zoom:e.getZoom()-1,around:e.unproject(r)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Xn={0:1,2:2};class Yn{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,delete this._lastPoint,delete this._eventButton}_correctButton(t,e){return!1}_move(t,e){return{}}mousedown(t,e){if(this._lastPoint)return;const i=a.mouseButton(t);this._correctButton(t,i)&&(this._lastPoint=e,this._eventButton=i)}mousemoveWindow(t,e){const i=this._lastPoint;if(i)if(t.preventDefault(),function(t,e){const i=Xn[e];return void 0===t.buttons||(t.buttons&i)!==i}(t,this._eventButton))this.reset();else if(this._moved||!(e.dist(i)<this._clickTolerance))return this._moved=!0,this._lastPoint=e,this._move(i,e)}mouseupWindow(t){this._lastPoint&&a.mouseButton(t)===this._eventButton&&(this._moved&&a.suppressClick(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class $n extends Yn{mousedown(t,e){super.mousedown(t,e),this._lastPoint&&(this._active=!0)}_correctButton(t,e){return 0===e&&!t.ctrlKey}_move(t,e){return{around:e,panDelta:e.sub(t)}}}class Jn extends Yn{_correctButton(t,e){return 0===e&&t.ctrlKey||2===e}_move(t,e){const i=.8*(e.x-t.x);if(i)return this._active=!0,{bearingDelta:i}}contextmenu(t){t.preventDefault()}}class Kn extends Yn{_correctButton(t,e){return 0===e&&t.ctrlKey||2===e}_move(t,e){const i=-.5*(e.y-t.y);if(i)return this._active=!0,{pitchDelta:i}}contextmenu(t){t.preventDefault()}}class Qn{constructor(e,i){this._map=e,this._el=e.getCanvasContainer(),this._minTouches=1,this._clickTolerance=i.clickTolerance||1,this.reset(),t.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new t.pointGeometry(0,0)}touchstart(t,e,i){return this._calculateTransform(t,e,i)}touchmove(t,e,i){if(this._active&&!(i.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===i.length)return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.preventDefault(),this._calculateTransform(t,e,i)}}touchend(t,e,i){this._calculateTransform(t,e,i),this._active&&i.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(e,i,n){n.length>0&&(this._active=!0);const r=Hn(n,i),o=new t.pointGeometry(0,0),a=new t.pointGeometry(0,0);let s=0;for(const t in r){const e=r[t],i=this._touches[t];i&&(o._add(e),a._add(e.sub(i)),s++,r[t]=e)}if(this._touches=r,s<this._minTouches||!a.mag())return;const l=a.div(s);return this._sum._add(l),this._sum.mag()<this._clickTolerance?void 0:{around:o.div(s),panDelta:l}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=a.create("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))+"px")}_showTouchPanBlockerAlert(){"hidden"===this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show")},500)}}class tr{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}_start(t){}_move(t,e,i){return{}}touchstart(t,e,i){this._firstTwoTouches||i.length<2||(this._firstTwoTouches=[i[0].identifier,i[1].identifier],this._start([e[0],e[1]]))}touchmove(t,e,i){if(!this._firstTwoTouches)return;t.preventDefault();const[n,r]=this._firstTwoTouches,o=er(i,e,n),a=er(i,e,r);if(!o||!a)return;const s=this._aroundCenter?null:o.add(a).div(2);return this._move([o,a],s,t)}touchend(t,e,i){if(!this._firstTwoTouches)return;const[n,r]=this._firstTwoTouches,o=er(i,e,n),s=er(i,e,r);o&&s||(this._active&&a.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function er(t,e,i){for(let n=0;n<t.length;n++)if(t[n].identifier===i)return e[n]}function ir(t,e){return Math.log(t/e)/Math.LN2}class nr extends tr{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,e){const i=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(ir(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:ir(this._distance,i),pinchAround:e}}}function rr(t,e){return 180*t.angleWith(e)/Math.PI}class or extends tr{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,e){const i=this._vector;if(this._vector=t[0].sub(t[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:rr(this._vector,i),pinchAround:e}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const e=25/(Math.PI*this._minDiameter)*360,i=rr(t,this._startVector);return Math.abs(i)<e}}function ar(t){return Math.abs(t.y)>Math.abs(t.x)}class sr extends tr{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}_start(t){this._lastPoints=t,ar(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,e,i){const n=t[0].sub(this._lastPoints[0]),r=t[1].sub(this._lastPoints[1]);if(!(this._map._cooperativeGestures&&i.touches.length<3)&&(this._valid=this.gestureBeginsVertically(n,r,i.timeStamp),this._valid))return this._lastPoints=t,this._active=!0,{pitchDelta:(n.y+r.y)/2*-.5}}gestureBeginsVertically(t,e,i){if(void 0!==this._valid)return this._valid;const n=t.mag()>=2,r=e.mag()>=2;if(!n&&!r)return;if(!n||!r)return void 0===this._firstMove&&(this._firstMove=i),i-this._firstMove<100&&void 0;const o=t.y>0==e.y>0;return ar(t)&&ar(e)&&o}}const lr={panStep:100,bearingStep:15,pitchStep:10};class cr{constructor(){const t=lr;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let e=0,i=0,n=0,r=0,o=0;switch(t.keyCode){case 61:case 107:case 171:case 187:e=1;break;case 189:case 109:case 173:e=-1;break;case 37:t.shiftKey?i=-1:(t.preventDefault(),r=-1);break;case 39:t.shiftKey?i=1:(t.preventDefault(),r=1);break;case 38:t.shiftKey?n=1:(t.preventDefault(),o=-1);break;case 40:t.shiftKey?n=-1:(t.preventDefault(),o=1);break;default:return}return this._rotationDisabled&&(i=0,n=0),{cameraAnimation:a=>{const s=a.getZoom();a.easeTo({duration:300,easeId:"keyboardHandler",easing:hr,zoom:e?Math.round(s)+e*(t.shiftKey?2:1):s,bearing:a.getBearing()+i*this._bearingStep,pitch:a.getPitch()+n*this._pitchStep,offset:[-r*this._panStep,-o*this._panStep],center:a.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function hr(t){return t*(2-t)}const ur=4.000244140625;class dr{constructor(e,i){this._map=e,this._el=e.getCanvasContainer(),this._handler=i,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,t.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert","_isFullscreen"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return!!this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(e){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(e.ctrlKey||e.metaKey||this.isZooming()||this._isFullscreen()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let i=e.deltaMode===t.window.WheelEvent.DOM_DELTA_LINE?40*e.deltaY:e.deltaY;const n=t.exported.now(),r=n-(this._lastWheelEventTime||0);this._lastWheelEventTime=n,0!==i&&i%ur==0?this._type="wheel":0!==i&&Math.abs(i)<4?this._type="trackpad":r>400?(this._type=null,this._lastValue=i,this._timeout=setTimeout(this._onTimeout,40,e)):this._type||(this._type=Math.abs(r*i)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,i+=this._lastValue)),e.shiftKey&&i&&(i/=4),this._type&&(this._lastWheelEvent=e,this._delta-=i,this._active||this._start(e)),e.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const e=a.mousePos(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:e,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const e=this._map.transform,i=()=>e._terrainEnabled()&&this._aroundCoord?e.computeZoomRelativeTo(this._aroundCoord):e.zoom;if(0!==this._delta){const t="wheel"===this._type&&Math.abs(this._delta)>ur?this._wheelZoomRate:this._defaultZoomRate;let n=2/(1+Math.exp(-Math.abs(this._delta*t)));this._delta<0&&0!==n&&(n=1/n);const r=i(),o=Math.pow(2,r),a="number"==typeof this._targetZoom?e.zoomScale(this._targetZoom):o;this._targetZoom=Math.min(e.maxZoom,Math.max(e.minZoom,e.scaleZoom(a*n))),"wheel"===this._type&&(this._startZoom=i(),this._easing=this._smoothOutEasing(200)),this._delta=0}const n="number"==typeof this._targetZoom?this._targetZoom:i(),r=this._startZoom,o=this._easing;let a,s=!1;if("wheel"===this._type&&r&&o){const e=Math.min((t.exported.now()-this._lastWheelEventTime)/200,1),i=o(e);a=t.number(r,n,i),e<1?this._frameId||(this._frameId=!0):s=!0}else a=n,s=!0;return this._active=!0,s&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!s,zoomDelta:a-i(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(e){let i=t.ease;if(this._prevEase){const e=this._prevEase,n=(t.exported.now()-e.start)/e.duration,r=e.easing(n+.01)-e.easing(n),o=.27/Math.sqrt(r*r+1e-4)*.01,a=Math.sqrt(.0729-o*o);i=t.bezier(o,a,.25,1)}return this._prevEase={start:t.exported.now(),duration:e,easing:i},i}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=a.create("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(t.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))+"px")}_isFullscreen(){return!!t.window.document.fullscreenElement}_showBlockerAlert(){"hidden"===this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show")},200)}}class pr{constructor(t,e){this._clickZoom=t,this._tapZoom=e}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class fr{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,e){return t.preventDefault(),{cameraAnimation:i=>{i.easeTo({duration:300,zoom:i.getZoom()+(t.shiftKey?-1:1),around:i.unproject(e)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class mr{constructor(){this._tap=new Wn({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,this._tap.reset()}touchstart(t,e,i){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?i.length>0&&(this._swipePoint=e[0],this._swipeTouch=i[0].identifier):this._tap.touchstart(t,e,i))}touchmove(t,e,i){if(this._tapTime){if(this._swipePoint){if(i[0].identifier!==this._swipeTouch)return;const n=e[0],r=n.y-this._swipePoint.y;return this._swipePoint=n,t.preventDefault(),this._active=!0,{zoomDelta:r/128}}}else this._tap.touchmove(t,e,i)}touchend(t,e,i){this._tapTime?this._swipePoint&&0===i.length&&this.reset():this._tap.touchend(t,e,i)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class gr{constructor(t,e,i){this._el=t,this._mousePan=e,this._touchPan=i}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class yr{constructor(t,e,i){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=e,this._mousePitch=i}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class _r{constructor(t,e,i,n){this._el=t,this._touchZoom=e,this._touchRotate=i,this._tapDragZoom=n,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const vr=t=>t.zoom||t.drag||t.pitch||t.rotate;class xr extends t.Event{}class br{constructor(){this.constants=[1,1,.01],this.radius=0}setup(e,i){const n=t.sub([],i,e);this.radius=t.length(n[2]<0?t.div([],n,this.constants):[n[0],n[1],0])}projectRay(e){t.div(e,e,this.constants),t.normalize(e,e),t.mul$1(e,e,this.constants);const i=t.scale$2([],e,this.radius);if(i[2]>0){const e=t.scale$2([],[0,0,1],t.dot(i,[0,0,1])),n=t.scale$2([],t.normalize([],[i[0],i[1],0]),this.radius),r=t.add([],i,t.scale$2([],t.sub([],t.add([],n,e),i),2));i[0]=r[0],i[1]=r[1]}return i}}function wr(t){return t.panDelta&&t.panDelta.mag()||t.zoomDelta||t.bearingDelta||t.pitchDelta}class Mr{constructor(e,i){this._map=e,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new On(e),this._bearingSnap=i.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new br,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(i),t.bindAll(["handleEvent","handleWindowEvent"],this);const n=this._el;this._listeners=[[n,"touchstart",{passive:!0}],[n,"touchmove",{passive:!1}],[n,"touchend",void 0],[n,"touchcancel",void 0],[n,"mousedown",void 0],[n,"mousemove",void 0],[n,"mouseup",void 0],[t.window.document,"mousemove",{capture:!0}],[t.window.document,"mouseup",void 0],[n,"mouseover",void 0],[n,"mouseout",void 0],[n,"dblclick",void 0],[n,"click",void 0],[n,"keydown",{capture:!1}],[n,"keyup",void 0],[n,"wheel",{passive:!1}],[n,"contextmenu",void 0],[t.window,"blur",void 0]];for(const[e,i,n]of this._listeners)e.addEventListener(i,e===t.window.document?this.handleWindowEvent:this.handleEvent,n)}destroy(){for(const[e,i,n]of this._listeners)e.removeEventListener(i,e===t.window.document?this.handleWindowEvent:this.handleEvent,n)}_addDefaultHandlers(t){const e=this._map,i=e.getCanvasContainer();this._add("mapEvent",new Gn(e,t));const n=e.boxZoom=new Vn(e,t);this._add("boxZoom",n);const r=new qn,o=new fr;e.doubleClickZoom=new pr(o,r),this._add("tapZoom",r),this._add("clickZoom",o);const a=new mr;this._add("tapDragZoom",a);const s=e.touchPitch=new sr(e);this._add("touchPitch",s);const l=new Jn(t),c=new Kn(t);e.dragRotate=new yr(t,l,c),this._add("mouseRotate",l,["mousePitch"]),this._add("mousePitch",c,["mouseRotate"]);const h=new $n(t),u=new Qn(e,t);e.dragPan=new gr(i,h,u),this._add("mousePan",h),this._add("touchPan",u,["touchZoom","touchRotate"]);const d=new or,p=new nr;e.touchZoomRotate=new _r(i,p,d,a),this._add("touchRotate",d,["touchPan","touchZoom"]),this._add("touchZoom",p,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Un(e));const f=e.scrollZoom=new dr(e,this);this._add("scrollZoom",f,["mousePan"]);const m=e.keyboard=new cr;this._add("keyboard",m);for(const i of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[i]&&e[i].enable(t[i])}_add(t,e,i){this._handlers.push({handlerName:t,handler:e,allowed:i}),this._handlersById[t]=e}stop(t){if(!this._updatingCamera){for(const{handler:t}of this._handlers)t.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[]}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return Boolean(vr(this._eventsInProgress))||this.isZooming()}_blockedByActive(t,e,i){for(const n in t)if(n!==i&&(!e||e.indexOf(n)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,t.type+"Window")}_getMapTouches(t){const e=[];for(const i of t)this._el.contains(i.target)&&e.push(i);return e}handleEvent(t,e){this._updatingCamera=!0;const i="renderFrame"===t.type,n=i?void 0:t,r={needsRenderFrame:!1},o={},s={},l=t.touches?this._getMapTouches(t.touches):void 0,c=l?a.touchPos(this._el,l):i?void 0:a.mousePos(this._el,t);for(const{handlerName:i,handler:a,allowed:h}of this._handlers){if(!a.isEnabled())continue;let u;this._blockedByActive(s,h,i)?a.reset():a[e||t.type]&&(u=a[e||t.type](t,c,l),this.mergeHandlerResult(r,o,u,i,n),u&&u.needsRenderFrame&&this._triggerRenderFrame()),(u||a.isActive())&&(s[i]=a)}const h={};for(const t in this._previousActiveHandlers)s[t]||(h[t]=n);this._previousActiveHandlers=s,(Object.keys(h).length||wr(r))&&(this._changes.push([r,o,h]),this._triggerRenderFrame()),(Object.keys(s).length||wr(r))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:u}=r;u&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],u(this._map))}mergeHandlerResult(e,i,n,r,o){if(!n)return;t.extend(e,n);const a={handlerName:r,originalEvent:n.originalEvent||o};void 0!==n.zoomDelta&&(i.zoom=a),void 0!==n.panDelta&&(i.drag=a),void 0!==n.pitchDelta&&(i.pitch=a),void 0!==n.bearingDelta&&(i.rotate=a)}_applyChanges(){const e={},i={},n={};for(const[r,o,a]of this._changes)r.panDelta&&(e.panDelta=(e.panDelta||new t.pointGeometry(0,0))._add(r.panDelta)),r.zoomDelta&&(e.zoomDelta=(e.zoomDelta||0)+r.zoomDelta),r.bearingDelta&&(e.bearingDelta=(e.bearingDelta||0)+r.bearingDelta),r.pitchDelta&&(e.pitchDelta=(e.pitchDelta||0)+r.pitchDelta),void 0!==r.around&&(e.around=r.around),void 0!==r.aroundCoord&&(e.aroundCoord=r.aroundCoord),void 0!==r.pinchAround&&(e.pinchAround=r.pinchAround),r.noInertia&&(e.noInertia=r.noInertia),t.extend(i,o),t.extend(n,a);this._updateMapTransform(e,i,n),this._changes=[]}_updateMapTransform(e,i,n){const r=this._map,o=r.transform,a=t=>[t.x,t.y,t.z];if((t=>{const e=this._eventsInProgress.drag;return e&&!this._handlersById[e.handlerName].isActive()})()&&!wr(e)){const t=o.zoom;o.cameraElevationReference="sea",o.recenterOnTerrain(),o.cameraElevationReference="ground",t!==o.zoom&&this._map._update(!0)}if(!wr(e))return this._fireEvents(i,n,!0);let{panDelta:s,zoomDelta:l,bearingDelta:c,pitchDelta:h,around:u,aroundCoord:d,pinchAround:p}=e;void 0!==p&&(u=p),(t=>i.drag&&!this._eventsInProgress.drag)()&&u&&(this._dragOrigin=a(o.pointCoordinate3D(u)),this._trackingEllipsoid.setup(o._camera.position,this._dragOrigin)),o.cameraElevationReference="sea",r._stop(!0),u=u||r.transform.centerPoint,c&&(o.bearing+=c),h&&(o.pitch+=h),o._updateCameraState();const f=[0,0,0];if(s){const t=o.pointCoordinate(u),e=o.pointCoordinate(u.sub(s));t&&e&&(f[0]=e.x-t.x,f[1]=e.y-t.y)}const m=o.zoom,g=[0,0,0];if(l){const e=a(d||o.pointCoordinate3D(u)),i={dir:t.normalize([],t.sub([],e,o._camera.position))};if(i.dir[2]<0){const n=o.zoomDeltaToMovement(e,l);t.scale$2(g,i.dir,n)}}const y=t.add(f,f,g);o._translateCameraConstrained(y),l&&Math.abs(o.zoom-m)>1e-4&&o.recenterOnTerrain(),o.cameraElevationReference="ground",this._map._update(),e.noInertia||this._inertia.record(e),this._fireEvents(i,n,!0)}_fireEvents(e,i,n){const r=vr(this._eventsInProgress),o=vr(e),a={};for(const t in e){const{originalEvent:i}=e[t];this._eventsInProgress[t]||(a[t+"start"]=i),this._eventsInProgress[t]=e[t]}!r&&o&&this._fireEvent("movestart",o.originalEvent);for(const t in a)this._fireEvent(t,a[t]);o&&this._fireEvent("move",o.originalEvent);for(const t in e){const{originalEvent:i}=e[t];this._fireEvent(t,i)}const s={};let l;for(const t in this._eventsInProgress){const{handlerName:e,originalEvent:n}=this._eventsInProgress[t];this._handlersById[e].isActive()||(delete this._eventsInProgress[t],l=i[e]||n,s[t+"end"]=l)}for(const t in s)this._fireEvent(t,s[t]);const c=vr(this._eventsInProgress);if(n&&(r||o)&&!c){this._updatingCamera=!0;const e=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=t=>0!==t&&-this._bearingSnap<t&&t<this._bearingSnap;e?(i(e.bearing||this._map.getBearing())&&(e.bearing=0),this._map.easeTo(e,{originalEvent:l})):(this._map.fire(new t.Event("moveend",{originalEvent:l})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(e,i){this._map.fire(new t.Event(e,i?{originalEvent:i}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{delete this._frameId,this.handleEvent(new xr("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const Tr="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Sr extends t.Evented{constructor(e,i){super(),this._moving=!1,this._zooming=!1,this.transform=e,this._bearingSnap=i.bearingSnap,t.bindAll(["_renderFrameCallback"],this)}getCenter(){return new t.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(t,e){return this.jumpTo({center:t},e)}panBy(e,i,n){return e=t.pointGeometry.convert(e).mult(-1),this.panTo(this.transform.center,t.extend({offset:e},i),n)}panTo(e,i,n){return this.easeTo(t.extend({center:e},i),n)}getZoom(){return this.transform.zoom}setZoom(t,e){return this.jumpTo({zoom:t},e),this}zoomTo(e,i,n){return this.easeTo(t.extend({zoom:e},i),n)}zoomIn(t,e){return this.zoomTo(this.getZoom()+1,t,e),this}zoomOut(t,e){return this.zoomTo(this.getZoom()-1,t,e),this}getBearing(){return this.transform.bearing}setBearing(t,e){return this.jumpTo({bearing:t},e),this}getPadding(){return this.transform.padding}setPadding(t,e){return this.jumpTo({padding:t},e),this}rotateTo(e,i,n){return this.easeTo(t.extend({bearing:e},i),n)}resetNorth(e,i){return this.rotateTo(0,t.extend({duration:1e3},e),i),this}resetNorthPitch(e,i){return this.easeTo(t.extend({bearing:0,pitch:0,duration:1e3},e),i),this}snapToNorth(t,e){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,e):this}getPitch(){return this.transform.pitch}setPitch(t,e){return this.jumpTo({pitch:t},e),this}cameraForBounds(e,i){e=t.LngLatBounds.convert(e);const n=i&&i.bearing||0;return this._cameraForBoxAndBearing(e.getNorthWest(),e.getSouthEast(),n,i)}_extendCameraOptions(e){const i={top:0,bottom:0,right:0,left:0};if("number"==typeof(e=t.extend({padding:i,offset:[0,0],maxZoom:this.transform.maxZoom},e)).padding){const t=e.padding;e.padding={top:t,bottom:t,right:t,left:t}}return e.padding=t.extend(i,e.padding),e}_cameraForBoxAndBearing(e,i,n,r){const o=this._extendCameraOptions(r),a=this.transform,s=a.padding,l=a.project(t.LngLat.convert(e)),c=a.project(t.LngLat.convert(i)),h=l.rotate(-t.degToRad(n)),u=c.rotate(-t.degToRad(n)),d=new t.pointGeometry(Math.max(h.x,u.x),Math.max(h.y,u.y)),p=new t.pointGeometry(Math.min(h.x,u.x),Math.min(h.y,u.y)),f=d.sub(p),m=(a.width-(s.left+s.right+o.padding.left+o.padding.right))/f.x,g=(a.height-(s.top+s.bottom+o.padding.top+o.padding.bottom))/f.y;if(g<0||m<0)return void t.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const y=Math.min(a.scaleZoom(a.scale*Math.min(m,g)),o.maxZoom),_="number"==typeof o.offset.x?new t.pointGeometry(o.offset.x,o.offset.y):t.pointGeometry.convert(o.offset),v=new t.pointGeometry((o.padding.left-o.padding.right)/2,(o.padding.top-o.padding.bottom)/2).rotate(n*Math.PI/180),x=_.add(v).mult(a.scale/a.zoomScale(y));return{center:a.unproject(l.add(c).div(2).sub(x)),zoom:y,bearing:n}}_cameraForBox(e,i,n,r,o){const a=this._extendCameraOptions(o);n=n||0,r=r||0,e=t.LngLat.convert(e),i=t.LngLat.convert(i);const s=this.transform.clone();s.padding=a.padding;const l=this.getFreeCameraOptions(),c=new t.LngLat(.5*(e.lng+i.lng),.5*(e.lat+i.lat)),h=.5*(n+r);if(s._camera.position[2]<t.mercatorZfromAltitude(h,c.lat))return void t.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");l.lookAtPoint(c),s.setFreeCameraOptions(l);const u=t.MercatorCoordinate.fromLngLat(e),d=t.MercatorCoordinate.fromLngLat(i),p=s.pointRayIntersection(s.centerPoint,h),f=[(m=s.rayIntersectionCoordinate(p)).x,m.y,m.z];var m;const g=s.screenPointToMercatorRay(s.centerPoint),y="globe"!==s.projection.name;let _,v=0;do{const i=Math.floor(s.zoom),o=1<<i,a=Math.min(o*u.x,o*d.x),l=Math.min(o*u.y,o*d.y),c=Math.max(o*u.x,o*d.x),h=Math.max(o*u.y,o*d.y),p=new t.Aabb([a,l,n],[c,h,r]),m=t.Frustum.fromInvProjectionMatrix(s.invProjMatrix,s.worldSize,i,y);if(2!==p.intersects(m)){_&&(s._camera.position=t.scaleAndAdd([],s._camera.position,g.dir,-_),s._updateStateFromCamera());break}const v=t.sub([],s._camera.position,f);_=.5*t.length(v),s._camera.position=t.scaleAndAdd([],s._camera.position,g.dir,_);try{s._updateStateFromCamera()}catch(e){return void t.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}}while(++v<10);return{center:s.center,zoom:s.zoom,bearing:s.bearing,pitch:s.pitch}}fitBounds(t,e,i){return this._fitInternal(this.cameraForBounds(t,e),e,i)}_raycastElevationBox(e,i){const n=this.transform.elevation;if(!n)return;const r=new t.pointGeometry(e.x,i.y),o=new t.pointGeometry(i.x,e.y),a=n.pointCoordinate(e);if(!a)return;const s=n.pointCoordinate(i);if(!s)return;const l=n.pointCoordinate(r);if(!l)return;const c=n.pointCoordinate(o);if(!c)return;const h=new t.MercatorCoordinate(a[0],a[1]).toLngLat(),u=new t.MercatorCoordinate(s[0],s[1]).toLngLat(),d=new t.MercatorCoordinate(l[0],l[1]).toLngLat(),p=new t.MercatorCoordinate(c[0],c[1]).toLngLat(),f=Math.min(h.lng,Math.min(u.lng,Math.min(d.lng,p.lng))),m=Math.min(h.lat,Math.min(u.lat,Math.min(d.lat,p.lat))),g=Math.max(h.lng,Math.max(u.lng,Math.max(d.lng,p.lng))),y=Math.max(h.lat,Math.max(u.lat,Math.max(d.lat,p.lat))),_=Math.min(a[3],Math.min(s[3],Math.min(l[3],c[3]))),v=Math.max(a[3],Math.max(s[3],Math.max(l[3],c[3])));return{minLngLat:new t.LngLat(f,m),maxLngLat:new t.LngLat(g,y),minAltitude:_,maxAltitude:v}}fitScreenCoordinates(e,i,n,r,o){let a,s,l,c;const h=t.pointGeometry.convert(e),u=t.pointGeometry.convert(i),d=this._raycastElevationBox(h,u);if(d)a=d.minLngLat,s=d.maxLngLat,l=d.minAltitude,c=d.maxAltitude;else{if(this.transform.anyCornerOffEdge(h,u))return this;a=this.transform.pointLocation(h),s=this.transform.pointLocation(u)}return this._fitInternal(0===this.transform.pitch?this._cameraForBoxAndBearing(this.transform.pointLocation(t.pointGeometry.convert(e)),this.transform.pointLocation(t.pointGeometry.convert(i)),n,r):this._cameraForBox(a,s,l,c,r),r,o)}_fitInternal(e,i,n){return e?(delete(i=t.extend(e,i)).padding,i.linear?this.easeTo(i,n):this.flyTo(i,n)):this}jumpTo(e,i){this.stop();const n=e.preloadOnly?this.transform.clone():this.transform;let r=!1,o=!1,a=!1;return"zoom"in e&&n.zoom!==+e.zoom&&(r=!0,n.zoom=+e.zoom),void 0!==e.center&&(n.center=t.LngLat.convert(e.center)),"bearing"in e&&n.bearing!==+e.bearing&&(o=!0,n.bearing=+e.bearing),"pitch"in e&&n.pitch!==+e.pitch&&(a=!0,n.pitch=+e.pitch),null==e.padding||n.isPaddingEqual(e.padding)||(n.padding=e.padding),e.preloadOnly?(this._preloadTiles(n),this):(this.fire(new t.Event("movestart",i)).fire(new t.Event("move",i)),r&&this.fire(new t.Event("zoomstart",i)).fire(new t.Event("zoom",i)).fire(new t.Event("zoomend",i)),o&&this.fire(new t.Event("rotatestart",i)).fire(new t.Event("rotate",i)).fire(new t.Event("rotateend",i)),a&&this.fire(new t.Event("pitchstart",i)).fire(new t.Event("pitch",i)).fire(new t.Event("pitchend",i)),this.fire(new t.Event("moveend",i)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||t.warnOnce(Tr),this.transform.getFreeCameraOptions()}setFreeCameraOptions(e,i){const n=this.transform;if(!n.projection.supportsFreeCamera)return void t.warnOnce(Tr);this.stop();const r=n.zoom,o=n.pitch,a=n.bearing;n.setFreeCameraOptions(e);const s=r!==n.zoom,l=o!==n.pitch,c=a!==n.bearing;return this.fire(new t.Event("movestart",i)).fire(new t.Event("move",i)),s&&this.fire(new t.Event("zoomstart",i)).fire(new t.Event("zoom",i)).fire(new t.Event("zoomend",i)),c&&this.fire(new t.Event("rotatestart",i)).fire(new t.Event("rotate",i)).fire(new t.Event("rotateend",i)),l&&this.fire(new t.Event("pitchstart",i)).fire(new t.Event("pitch",i)).fire(new t.Event("pitchend",i)),this.fire(new t.Event("moveend",i)),this}easeTo(e,i){this._stop(!1,e.easeId),(!1===(e=t.extend({offset:[0,0],duration:500,easing:t.ease},e)).animate||!e.essential&&t.exported.prefersReducedMotion)&&(e.duration=0);const n=this.transform,r=this.getZoom(),o=this.getBearing(),a=this.getPitch(),s=this.getPadding(),l="zoom"in e?+e.zoom:r,c="bearing"in e?this._normalizeBearing(e.bearing,o):o,h="pitch"in e?+e.pitch:a,u="padding"in e?e.padding:n.padding,d=t.pointGeometry.convert(e.offset);let p=n.centerPoint.add(d);const f="globe"===n.projection.name?n.pointCoordinate(p).toLngLat():n.pointLocation(p),m=t.LngLat.convert(e.center||f);this._normalizeCenter(m);const g=n.project(f),y=n.project(m).sub(g),_=n.zoomScale(l-r);let v,x;e.around&&(v=t.LngLat.convert(e.around),x=n.locationPoint(v));const b=this._zooming||l!==r,w=this._rotating||o!==c,M=this._pitching||h!==a,T=!n.isPaddingEqual(u),S=n=>f=>{if(b&&(n.zoom=t.number(r,l,f)),w&&(n.bearing=t.number(o,c,f)),M&&(n.pitch=t.number(a,h,f)),T&&(n.interpolatePadding(s,u,f),p=n.centerPoint.add(d)),v)n.setLocationAtPoint(v,x);else{const t=n.zoomScale(n.zoom-r),e=l>r?Math.min(2,_):Math.max(.5,_),i=Math.pow(e,1-f),o=n.unproject(g.add(y.mult(f*i)).mult(t));n.setLocationAtPoint(n.renderWorldCopies?o.wrap():o,p)}return e.preloadOnly||this._fireMoveEvents(i),n};if(e.preloadOnly){const t=this._emulate(S,e.duration,n);return this._preloadTiles(t),this}const E={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=b,this._rotating=w,this._pitching=M,this._padding=T,this._easeId=e.easeId,this._prepareEase(i,e.noMoveStart,E),this._ease(S(n),t=>{n.recenterOnTerrain(),this._afterEase(i,t)},e),this}_prepareEase(e,i,n={}){this._moving=!0,this.transform.cameraElevationReference="sea",i||n.moving||this.fire(new t.Event("movestart",e)),this._zooming&&!n.zooming&&this.fire(new t.Event("zoomstart",e)),this._rotating&&!n.rotating&&this.fire(new t.Event("rotatestart",e)),this._pitching&&!n.pitching&&this.fire(new t.Event("pitchstart",e))}_fireMoveEvents(e){this.fire(new t.Event("move",e)),this._zooming&&this.fire(new t.Event("zoom",e)),this._rotating&&this.fire(new t.Event("rotate",e)),this._pitching&&this.fire(new t.Event("pitch",e))}_afterEase(e,i){if(this._easeId&&i&&this._easeId===i)return;delete this._easeId,this.transform.cameraElevationReference="ground";const n=this._zooming,r=this._rotating,o=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,n&&this.fire(new t.Event("zoomend",e)),r&&this.fire(new t.Event("rotateend",e)),o&&this.fire(new t.Event("pitchend",e)),this.fire(new t.Event("moveend",e))}flyTo(e,i){if(!e.essential&&t.exported.prefersReducedMotion){const n=t.pick(e,["center","zoom","bearing","pitch","around"]);return this.jumpTo(n,i)}this.stop(),e=t.extend({offset:[0,0],speed:1.2,curve:1.42,easing:t.ease},e);const n=this.transform,r=this.getZoom(),o=this.getBearing(),a=this.getPitch(),s=this.getPadding(),l="zoom"in e?t.clamp(+e.zoom,n.minZoom,n.maxZoom):r,c="bearing"in e?this._normalizeBearing(e.bearing,o):o,h="pitch"in e?+e.pitch:a,u="padding"in e?e.padding:n.padding,d=n.zoomScale(l-r),p=t.pointGeometry.convert(e.offset);let f=n.centerPoint.add(p);const m=n.pointLocation(f),g=t.LngLat.convert(e.center||m);this._normalizeCenter(g);const y=n.project(m),_=n.project(g).sub(y);let v=e.curve;const x=Math.max(n.width,n.height),b=x/d,w=_.mag();if("minZoom"in e){const i=t.clamp(Math.min(e.minZoom,r,l),n.minZoom,n.maxZoom),o=x/n.zoomScale(i-r);v=Math.sqrt(o/w*2)}const M=v*v;function T(t){const e=(b*b-x*x+(t?-1:1)*M*M*w*w)/(2*(t?b:x)*M*w);return Math.log(Math.sqrt(e*e+1)-e)}function S(t){return(Math.exp(t)-Math.exp(-t))/2}function E(t){return(Math.exp(t)+Math.exp(-t))/2}const C=T(0);let A=function(t){return E(C)/E(C+v*t)},P=function(t){return x*((E(C)*(S(e=C+v*t)/E(e))-S(C))/M)/w;var e},L=(T(1)-C)/v;if(Math.abs(w)<1e-6||!isFinite(L)){if(Math.abs(x-b)<1e-6)return this.easeTo(e,i);const t=b<x?-1:1;L=Math.abs(Math.log(b/x))/v,P=function(){return 0},A=function(e){return Math.exp(t*v*e)}}e.duration="duration"in e?+e.duration:1e3*L/("screenSpeed"in e?+e.screenSpeed/v:+e.speed),e.maxDuration&&e.duration>e.maxDuration&&(e.duration=0);const I=o!==c,R=h!==a,D=!n.isPaddingEqual(u),k=n=>d=>{const m=d*L,v=1/A(m);n.zoom=1===d?l:r+n.scaleZoom(v),I&&(n.bearing=t.number(o,c,d)),R&&(n.pitch=t.number(a,h,d)),D&&(n.interpolatePadding(s,u,d),f=n.centerPoint.add(p));const x=1===d?g:n.unproject(y.add(_.mult(P(m))).mult(v));return n.setLocationAtPoint(n.renderWorldCopies?x.wrap():x,f),n._updateCenterElevation(),e.preloadOnly||this._fireMoveEvents(i),n};if(e.preloadOnly){const t=this._emulate(k,e.duration,n);return this._preloadTiles(t),this}return this._zooming=!0,this._rotating=I,this._pitching=R,this._padding=D,this._prepareEase(i,!1),this._ease(k(n),()=>this._afterEase(i),e),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,e){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const t=this._onEaseEnd;delete this._onEaseEnd,t.call(this,e)}if(!t){const t=this.handlers;t&&t.stop(!1)}return this}_ease(e,i,n){!1===n.animate||0===n.duration?(e(1),i()):(this._easeStart=t.exported.now(),this._easeOptions=n,this._onEaseFrame=e,this._onEaseEnd=i,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const e=Math.min((t.exported.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(e)),e<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(e,i){e=t.wrap(e,-180,180);const n=Math.abs(e-i);return Math.abs(e-360-i)<n&&(e-=360),Math.abs(e+360-i)<n&&(e+=360),e}_normalizeCenter(t){const e=this.transform;if(!e.renderWorldCopies||e.maxBounds)return;const i=t.lng-e.center.lng;t.lng+=i>180?-360:i<-180?360:0}_emulate(t,e,i){const n=Math.ceil(15*e/1e3),r=[],o=t(i.clone());for(let t=0;t<=n;t++){const e=o(t/n);r.push(e.clone())}return r}}class Er{constructor(e={}){this.options=e,t.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const e=this.options&&this.options.compact;return this._map=t,this._container=a.create("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=a.create("button","mapboxgl-ctrl-attrib-button",this._container),a.create("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden",!0),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=a.create("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),e&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===e&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(t,e){const i=this._map._getUIString("AttributionControl."+e);t.setAttribute("aria-label",i),t.removeAttribute("title"),t.firstElementChild&&t.firstElementChild.setAttribute("title",i)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let e=this._editLink;e||(e=this._editLink=this._container.querySelector(".mapbox-improve-map"));const i=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||t.config.ACCESS_TOKEN}];if(e){const n=i.reduce((t,e,n)=>(e.value&&(t+=`${e.key}=${e.value}${n<i.length-1?"&":""}`),t),"?");e.href=`${t.config.FEEDBACK_URL}/${n}${this._map._hash?this._map._hash.getHashString(!0):""}`,e.rel="noopener nofollow",this._setElementTitle(e,"MapFeedback")}}_updateData(t){!t||"metadata"!==t.sourceDataType&&"visibility"!==t.sourceDataType&&"style"!==t.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const t=this._map.style.stylesheet;this.styleOwner=t.owner,this.styleId=t.id}const e=this._map.style._sourceCaches;for(const i in e){const n=e[i];if(n.used){const e=n.getSource();e.attribution&&t.indexOf(e.attribution)<0&&t.push(e.attribution)}}t.sort((t,e)=>t.length-e.length),t=t.filter((e,i)=>{for(let n=i+1;n<t.length;n++)if(t[n].indexOf(e)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const i=t.join(" | ");i!==this._attribHTML&&(this._attribHTML=i,t.length?(this._innerContainer.innerHTML=i,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Cr{constructor(){t.bindAll(["_updateLogo"],this),t.bindAll(["_updateCompact"],this)}onAdd(t){this._map=t,this._container=a.create("div","mapboxgl-ctrl");const e=a.create("a","mapboxgl-ctrl-logo");return e.target="_blank",e.rel="noopener nofollow",e.href="https://www.mapbox.com/",e.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),e.setAttribute("rel","noopener nofollow"),this._container.appendChild(e),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&"metadata"!==t.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(0===Object.entries(t).length)return!0;for(const e in t){const i=t[e].getSource();if(i.hasOwnProperty("mapbox_logo")&&!i.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const e=t[0];this._map.getCanvasContainer().offsetWidth<250?e.classList.add("mapboxgl-compact"):e.classList.remove("mapboxgl-compact")}}}class Ar{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const e=++this._id;return this._queue.push({callback:t,id:e,cancelled:!1}),e}remove(t){const e=this._currentlyRunning,i=e?this._queue.concat(e):this._queue;for(const e of i)if(e.id===t)return void(e.cancelled=!0)}run(t=0){const e=this._currentlyRunning=this._queue;this._queue=[];for(const i of e)if(!i.cancelled&&(i.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Pr(e,i,n){if(e=new t.LngLat(e.lng,e.lat),i){const r=new t.LngLat(e.lng-360,e.lat),o=new t.LngLat(e.lng+360,e.lat),a=360*Math.ceil(Math.abs(e.lng-n.center.lng)/360),s=n.locationPoint(e).distSqr(i),l=i.x<0||i.y<0||i.x>n.width||i.y>n.height;n.locationPoint(r).distSqr(i)<s&&(l||Math.abs(r.lng-n.center.lng)<a)?e=r:n.locationPoint(o).distSqr(i)<s&&(l||Math.abs(o.lng-n.center.lng)<a)&&(e=o)}for(;Math.abs(e.lng-n.center.lng)>180;){const t=n.locationPoint(e);if(t.x>=0&&t.y>=0&&t.x<=n.width&&t.y<=n.height)break;e.lng>n.center.lng?e.lng-=360:e.lng+=360}return e}const Lr={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Ir extends t.Evented{constructor(e,i){if(super(),(e instanceof t.window.HTMLElement||i)&&(e=t.extend({element:e},i)),t.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=e&&e.anchor||"center",this._color=e&&e.color||"#3FB1CE",this._scale=e&&e.scale||1,this._draggable=e&&e.draggable||!1,this._clickTolerance=e&&e.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=e&&e.rotation||0,this._rotationAlignment=e&&e.rotationAlignment||"auto",this._pitchAlignment=e&&e.pitchAlignment&&"auto"!==e.pitchAlignment?e.pitchAlignment:this._rotationAlignment,this._updateMoving=()=>this._update(!0),e&&e.element)this._element=e.element,this._offset=t.pointGeometry.convert(e&&e.offset||[0,0]);else{this._defaultMarker=!0,this._element=a.create("div");const i=41,n=27,r=a.createSVG("svg",{display:"block",height:i*this._scale+"px",width:n*this._scale+"px",viewBox:`0 0 ${n} ${i}`},this._element),o=a.createSVG("radialGradient",{id:"shadowGradient"},a.createSVG("defs",{},r));a.createSVG("stop",{offset:"10%","stop-opacity":.4},o),a.createSVG("stop",{offset:"100%","stop-opacity":.05},o),a.createSVG("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},r),a.createSVG("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},r),a.createSVG("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},r),a.createSVG("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},r),this._offset=t.pointGeometry.convert(e&&e.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",t=>{t.preventDefault()}),this._element.addEventListener("mousedown",t=>{t.preventDefault()});const n=this._element.classList;for(const t in Lr)n.remove("mapboxgl-marker-anchor-"+t);n.add("mapboxgl-marker-anchor-"+this._anchor),this._popup=null}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick)),this}remove(){return this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._updateMoving),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._map.off("remove",this._clearFadeTimer),this._map._removeMarker(this),delete this._map),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(e){return this._lngLat=t.LngLat.convert(e),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const e=38.1,i=13.5,n=Math.sqrt(Math.pow(i,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-e],"bottom-left":[n,-1*(e-i+n)],"bottom-right":[-n,-1*(e-i+n)],left:[i,-1*(e-i)],right:[-i,-1*(e-i)]}:this._offset}this._popup=t,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const e=t.code,i=t.charCode||t.keyCode;"Space"!==e&&"Enter"!==e&&32!==i&&13!==i||this.togglePopup()}_onMapClick(t){const e=t.originalEvent.target,i=this._element;this._popup&&(e===i||i.contains(e))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_evaluateOpacity(){const t=this._pos?this._pos.sub(this._transformedOffset()):null;if(!this._withinScreenBounds(t))return void this._clearFadeTimer();const e=this._map.unproject(t);let i=!1;if(this._map.transform._terrainEnabled()&&this._map.getTerrain()){const t=this._map.getFreeCameraOptions();if(t.position){const n=t.position.toLngLat();i=n.distanceTo(e)<.9*n.distanceTo(this._lngLat)}}const n=(1-this._map._queryFogOpacity(e))*(i?.2:1);this._element.style.opacity=""+n,this._popup&&this._popup._setOpacity(""+n),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_withinScreenBounds(t){const e=this._map.transform;return!!t&&t.x>=0&&t.x<e.width&&t.y>=0&&t.y<e.height}_updateDOM(){const e=this._pos||new t.pointGeometry(0,0),i=this._calculatePitch(),n=this._calculateRotation();this._element.style.transform=`${Lr[this._anchor]} translate(${e.x}px, ${e.y}px) rotateX(${i}deg) rotateZ(${n}deg)`}_calculatePitch(){return"viewport"===this._pitchAlignment||"auto"===this._pitchAlignment?0:"map"===this._pitchAlignment?this._map.getPitch():0}_calculateRotation(){return"viewport"===this._rotationAlignment||"auto"===this._rotationAlignment?this._rotation:"map"===this._rotationAlignment?this._rotation-this._map.getBearing():0}_update(e){t.window.cancelAnimationFrame(this._updateFrameId),this._map&&(this._map.transform.renderWorldCopies&&(this._lngLat=Pr(this._lngLat,this._pos,this._map.transform)),this._pos=this._map.project(this._lngLat)._add(this._transformedOffset()),!0===e?this._updateFrameId=t.window.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),this._map._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),!this._map.getTerrain()&&!this._map.getFog()||this._fadeTimer||(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}_transformedOffset(){if(!this._defaultMarker)return this._offset;const t=this._map.transform,e=this._offset.mult(this._scale);return"map"===this._rotationAlignment&&e._rotate(t.angle),"map"===this._pitchAlignment&&(e.y*=Math.cos(t._pitch)),e}getOffset(){return this._offset}setOffset(e){return this._offset=t.pointGeometry.convert(e),this._update(),this}_onMove(e){if(!this._isDragging){const t=this._clickTolerance||this._map._clickTolerance;this._isDragging=e.point.dist(this._pointerdownPos)>=t}this._isDragging&&(this._pos=e.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new t.Event("dragstart"))),this.fire(new t.Event("drag")))}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),"active"===this._state&&this.fire(new t.Event("dragend")),this._state="inactive"}_addDragHandler(t){this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(this._pos).add(this._transformedOffset()),this._pointerdownPos=t.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))}setDraggable(t){return this._draggable=!!t,this._map&&(t?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t&&"auto"!==t?t:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}}class Rr{constructor(t){this.jumpTo(t)}getValue(e){if(e<=this._startTime)return this._start;if(e>=this._endTime)return this._end;const i=t.easeCubicInOut((e-this._startTime)/(this._endTime-this._startTime));return this._start*(1-i)+this._end*i}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,e,i){this._start=this.getValue(e),this._end=t,this._startTime=e,this._endTime=e+i}}const Dr={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},{HTMLImageElement:kr,HTMLElement:Or,ImageBitmap:zr}=t.window,Br={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0};function Fr(t){t.parentNode&&t.parentNode.removeChild(t)}const Nr={showCompass:!0,showZoom:!0,visualizePitch:!1};class jr{constructor(e,i,n=!1){this._clickTolerance=10,this.element=i,this.mouseRotate=new Jn({clickTolerance:e.dragRotate._mouseRotate._clickTolerance}),this.map=e,n&&(this.mousePitch=new Kn({clickTolerance:e.dragRotate._mousePitch._clickTolerance})),t.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),i.addEventListener("mousedown",this.mousedown),i.addEventListener("touchstart",this.touchstart,{passive:!1}),i.addEventListener("touchmove",this.touchmove),i.addEventListener("touchend",this.touchend),i.addEventListener("touchcancel",this.reset)}down(t,e){this.mouseRotate.mousedown(t,e),this.mousePitch&&this.mousePitch.mousedown(t,e),a.disableDrag()}move(t,e){const i=this.map,n=this.mouseRotate.mousemoveWindow(t,e);if(n&&n.bearingDelta&&i.setBearing(i.getBearing()+n.bearingDelta),this.mousePitch){const n=this.mousePitch.mousemoveWindow(t,e);n&&n.pitchDelta&&i.setPitch(i.getPitch()+n.pitchDelta)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart,{passive:!1}),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){a.enableDrag(),t.window.removeEventListener("mousemove",this.mousemove),t.window.removeEventListener("mouseup",this.mouseup)}mousedown(e){this.down(t.extend({},e,{ctrlKey:!0,preventDefault:()=>e.preventDefault()}),a.mousePos(this.element,e)),t.window.addEventListener("mousemove",this.mousemove),t.window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,a.mousePos(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){1!==t.targetTouches.length?this.reset():(this._startPos=this._lastPos=a.touchPos(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){1!==t.targetTouches.length?this.reset():(this._lastPos=a.touchPos(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){0===t.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const Gr={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1};let Ur,Vr=0,Hr=!1;const Zr={maxWidth:100,unit:"metric"};function Wr(t,e,i){const n=i&&i.maxWidth||100,r=t._containerHeight/2,o=t.unproject([0,r]),a=t.unproject([n,r]),s=o.distanceTo(a);if(i&&"imperial"===i.unit){const i=3.2808*s;i>5280?qr(e,n,i/5280,t._getUIString("ScaleControl.Miles"),t):qr(e,n,i,t._getUIString("ScaleControl.Feet"),t)}else i&&"nautical"===i.unit?qr(e,n,s/1852,t._getUIString("ScaleControl.NauticalMiles"),t):s>=1e3?qr(e,n,s/1e3,t._getUIString("ScaleControl.Kilometers"),t):qr(e,n,s,t._getUIString("ScaleControl.Meters"),t)}function qr(t,e,i,n,r){const o=function(t){const e=Math.pow(10,(""+Math.floor(t)).length-1);let i=t/e;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:i>=1?1:function(t){const e=Math.pow(10,Math.ceil(-Math.log(t)/Math.LN10));return Math.round(t*e)/e}(i),e*i}(i),a=o/i;r._requestDomTask(()=>{t.style.width=e*a+"px",t.innerHTML=`${o}&nbsp;${n}`})}const Xr={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Yr=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", "),$r={version:t.version,supported:e,setRTLTextPlugin:t.setRTLTextPlugin,getRTLTextPluginStatus:t.getRTLTextPluginStatus,Map:class extends Sr{constructor(e){if(null!=(e=t.extend({},Br,e)).minZoom&&null!=e.maxZoom&&e.minZoom>e.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=e.minPitch&&null!=e.maxPitch&&e.minPitch>e.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=e.minPitch&&e.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=e.maxPitch&&e.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new Cn(e.minZoom,e.maxZoom,e.minPitch,e.maxPitch,e.renderWorldCopies),e),this._interactive=e.interactive,this._minTileCacheSize=e.minTileCacheSize,this._maxTileCacheSize=e.maxTileCacheSize,this._failIfMajorPerformanceCaveat=e.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=e.preserveDrawingBuffer,this._antialias=e.antialias,this._trackResize=e.trackResize,this._bearingSnap=e.bearingSnap,this._refreshExpiredTiles=e.refreshExpiredTiles,this._fadeDuration=e.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=e.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=e.collectResourceTiming,this._optimizeForTerrain=e.optimizeForTerrain,this._renderTaskQueue=new Ar,this._domRenderTaskQueue=new Ar,this._controls=[],this._markers=[],this._mapId=t.uniqueId(),this._locale=t.extend({},Dr,e.locale),this._clickTolerance=e.clickTolerance,this._cooperativeGestures=e.cooperativeGestures,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevation=new Rr(0),this._requestManager=new t.RequestManager(e.transformRequest,e.accessToken,e.testMode),this._silenceAuthErrors=!!e.testMode,"string"==typeof e.container){if(this._container=t.window.document.getElementById(e.container),!this._container)throw new Error(`Container '${e.container}' not found.`)}else{if(!(e.container instanceof Or))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=e.container}if(this._container.childNodes.length>0&&t.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),e.maxBounds&&this.setMaxBounds(e.maxBounds),t.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),void 0!==t.window&&(t.window.addEventListener("online",this._onWindowOnline,!1),t.window.addEventListener("resize",this._onWindowResize,!1),t.window.addEventListener("orientationchange",this._onWindowResize,!1),t.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1)),this.handlers=new Mr(this,e),this._localFontFamily=e.localFontFamily,this._localIdeographFontFamily=e.localIdeographFontFamily,e.style&&this.setStyle(e.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),e.projection&&this.setProjection(e.projection),this._hash=e.hash&&new Pn("string"==typeof e.hash&&e.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:e.center,zoom:e.zoom,bearing:e.bearing,pitch:e.pitch}),e.bounds&&(this.resize(),this.fitBounds(e.bounds,t.extend({},e.fitBoundsOptions,{duration:0})))),this.resize(),e.attributionControl&&this.addControl(new Er({customAttribution:e.customAttribution})),this._logoControl=new Cr,this.addControl(this._logoControl,e.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",e=>{this._update("style"===e.dataType),this.fire(new t.Event(e.dataType+"data",e))}),this.on("dataloading",e=>{this.fire(new t.Event(e.dataType+"dataloading",e))})}_getMapId(){return this._mapId}addControl(e,i){if(void 0===i&&(i=e.getDefaultPosition?e.getDefaultPosition():"top-right"),!e||!e.onAdd)return this.fire(new t.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=e.onAdd(this);this._controls.push(e);const r=this._controlPositions[i];return-1!==i.indexOf("bottom")?r.insertBefore(n,r.firstChild):r.appendChild(n),this}removeControl(e){if(!e||!e.onRemove)return this.fire(new t.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const i=this._controls.indexOf(e);return i>-1&&this._controls.splice(i,1),e.onRemove(this),this}hasControl(t){return this._controls.indexOf(t)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(e){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const i=!this._moving;return i&&this.fire(new t.Event("movestart",e)).fire(new t.Event("move",e)),this.fire(new t.Event("resize",e)),i&&this.fire(new t.Event("moveend",e)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(e){return this.transform.setMaxBounds(t.LngLatBounds.convert(e)),this._update()}setMinZoom(e){if((e=null==e?-2:e)>=-2&&e<=this.transform.maxZoom)return this.transform.minZoom=e,this._update(),this.getZoom()<e?this.setZoom(e):this.fire(new t.Event("zoomstart")).fire(new t.Event("zoom")).fire(new t.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(e){if((e=null==e?22:e)>=this.transform.minZoom)return this.transform.maxZoom=e,this._update(),this.getZoom()>e?this.setZoom(e):this.fire(new t.Event("zoomstart")).fire(new t.Event("zoom")).fire(new t.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(e){if((e=null==e?0:e)<0)throw new Error("minPitch must be greater than or equal to 0");if(e>=0&&e<=this.transform.maxPitch)return this.transform.minPitch=e,this._update(),this.getPitch()<e?this.setPitch(e):this.fire(new t.Event("pitchstart")).fire(new t.Event("pitch")).fire(new t.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(e){if((e=null==e?85:e)>85)throw new Error("maxPitch must be less than or equal to 85");if(e>=this.transform.minPitch)return this.transform.maxPitch=e,this._update(),this.getPitch()>e?this.setPitch(e):this.fire(new t.Event("pitchstart")).fire(new t.Event("pitch")).fire(new t.Event("pitchend")),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(t){return this.transform.renderWorldCopies=t,this._update()}getProjection(){return this.transform.getProjection()}setProjection(t){return this._lazyInitEmptyStyle(),"string"==typeof t&&(t={name:t}),this._runtimeProjection=t,this.style.updateProjection(),this._transitionFromGlobe=!1,this}project(e){return this.transform.locationPoint3D(t.LngLat.convert(e))}unproject(e){return this.transform.pointLocation3D(t.pointGeometry.convert(e))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()}_createDelegatedListener(t,e,i){if("mouseenter"===t||"mouseover"===t){let n=!1;const r=r=>{const o=e.filter(t=>this.getLayer(t)),a=o.length?this.queryRenderedFeatures(r.point,{layers:o}):[];a.length?n||(n=!0,i.call(this,new Fn(t,this,r.originalEvent,{features:a}))):n=!1},o=()=>{n=!1};return{layers:new Set(e),listener:i,delegates:{mousemove:r,mouseout:o}}}if("mouseleave"===t||"mouseout"===t){let n=!1;const r=r=>{const o=e.filter(t=>this.getLayer(t));(o.length?this.queryRenderedFeatures(r.point,{layers:o}):[]).length?n=!0:n&&(n=!1,i.call(this,new Fn(t,this,r.originalEvent)))},o=e=>{n&&(n=!1,i.call(this,new Fn(t,this,e.originalEvent)))};return{layers:new Set(e),listener:i,delegates:{mousemove:r,mouseout:o}}}{const n=t=>{const n=e.filter(t=>this.getLayer(t)),r=n.length?this.queryRenderedFeatures(t.point,{layers:n}):[];r.length&&(t.features=r,i.call(this,t),delete t.features)};return{layers:new Set(e),listener:i,delegates:{[t]:n}}}}on(t,e,i){if(void 0===i)return super.on(t,e);Array.isArray(e)||(e=[e]);const n=this._createDelegatedListener(t,e,i);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[t]=this._delegatedListeners[t]||[],this._delegatedListeners[t].push(n);for(const t in n.delegates)this.on(t,n.delegates[t]);return this}once(t,e,i){if(void 0===i)return super.once(t,e);Array.isArray(e)||(e=[e]);const n=this._createDelegatedListener(t,e,i);for(const t in n.delegates)this.once(t,n.delegates[t]);return this}off(t,e,i){if(void 0===i)return super.off(t,e);e=new Set(Array.isArray(e)?e:[e]);const n=(t,e)=>{if(t.size!==e.size)return!1;for(const i of t)if(!e.has(i))return!1;return!0},r=this._delegatedListeners?this._delegatedListeners[t]:void 0;return r&&(t=>{for(let r=0;r<t.length;r++){const o=t[r];if(o.listener===i&&n(o.layers,e)){for(const t in o.delegates)this.off(t,o.delegates[t]);return t.splice(r,1),this}}})(r),this}queryRenderedFeatures(e,i){return this.style?(void 0!==i||void 0===e||e instanceof t.pointGeometry||Array.isArray(e)||(i=e,e=void 0),this.style.queryRenderedFeatures(e=e||[[0,0],[this.transform.width,this.transform.height]],i=i||{},this.transform)):[]}querySourceFeatures(t,e){return this.style.querySourceFeatures(t,e)}queryTerrainElevation(e,i){const n=this.transform.elevation;return n?(i=t.extend({},{exaggerated:!0},i),n.getAtPoint(t.MercatorCoordinate.fromLngLat(e),null,i.exaggerated)):null}setStyle(e,i){return!1!==(i=t.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},i)).diff&&i.localIdeographFontFamily===this._localIdeographFontFamily&&i.localFontFamily===this._localFontFamily&&this.style&&e?(this._diffStyle(e,i),this):(this._localIdeographFontFamily=i.localIdeographFontFamily,this._localFontFamily=i.localFontFamily,this._updateStyle(e,i))}_getUIString(t){const e=this._locale[t];if(null==e)throw new Error(`Missing UI string '${t}'`);return e}_updateStyle(t,e){return this.style&&(this.style.setEventedParent(null),this.style._remove(),delete this.style),t&&(this.style=new je(this,e||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof t?this.style.loadURL(t):this.style.loadJSON(t)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new je(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(e,i){if("string"==typeof e){const n=this._requestManager.normalizeStyleURL(e),r=this._requestManager.transformRequest(n,t.ResourceType.Style);t.getJSON(r,(e,n)=>{e?this.fire(new t.ErrorEvent(e)):n&&this._updateDiff(n,i)})}else"object"==typeof e&&this._updateDiff(e,i)}_updateDiff(e,i){try{this.style.setState(e)&&this._update(!0)}catch(n){t.warnOnce(`Unable to perform style diff: ${n.message||n.error||n}.  Rebuilding the style from scratch.`),this._updateStyle(e,i)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():t.warnOnce("There is no style added to the map.")}addSource(t,e){return this._lazyInitEmptyStyle(),this.style.addSource(t,e),this._update(!0)}isSourceLoaded(e){const i=this.style&&this.style._getSourceCaches(e);if(0!==i.length)return i.every(t=>t.loaded());this.fire(new t.ErrorEvent(new Error(`There is no source with ID '${e}'`)))}areTilesLoaded(){const t=this.style&&this.style._sourceCaches;for(const e in t){const i=t[e]._tiles;for(const t in i){const e=i[t];if("loaded"!==e.state&&"errored"!==e.state)return!1}}return!0}addSourceType(t,e,i){return this._lazyInitEmptyStyle(),this.style.addSourceType(t,e,i)}removeSource(t){return this.style.removeSource(t),this._updateTerrain(),this._update(!0)}getSource(t){return this.style.getSource(t)}addImage(e,i,{pixelRatio:n=1,sdf:r=!1,stretchX:o,stretchY:a,content:s}={}){if(this._lazyInitEmptyStyle(),i instanceof kr||zr&&i instanceof zr){const{width:l,height:c,data:h}=t.exported.getImageData(i);this.style.addImage(e,{data:new t.RGBAImage({width:l,height:c},h),pixelRatio:n,stretchX:o,stretchY:a,content:s,sdf:r,version:0})}else{if(void 0===i.width||void 0===i.height)return this.fire(new t.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:l,height:c,data:h}=i,u=i;this.style.addImage(e,{data:new t.RGBAImage({width:l,height:c},new Uint8Array(h)),pixelRatio:n,stretchX:o,stretchY:a,content:s,sdf:r,version:0,userImage:u}),u.onAdd&&u.onAdd(this,e)}}}updateImage(e,i){const n=this.style.getImage(e);if(!n)return this.fire(new t.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const r=i instanceof kr||zr&&i instanceof zr?t.exported.getImageData(i):i,{width:o,height:a,data:s}=r;return void 0===o||void 0===a?this.fire(new t.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`"))):o!==n.data.width||a!==n.data.height?this.fire(new t.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image"))):(n.data.replace(s,!(i instanceof kr||zr&&i instanceof zr)),void this.style.updateImage(e,n))}hasImage(e){return e?!!this.style.getImage(e):(this.fire(new t.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(t){this.style.removeImage(t)}loadImage(e,i){t.getImage(this._requestManager.transformRequest(e,t.ResourceType.Image),(e,n)=>{i(e,n instanceof kr?t.exported.getImageData(n):n)})}listImages(){return this.style.listImages()}addLayer(t,e){return this._lazyInitEmptyStyle(),this.style.addLayer(t,e),this._update(!0)}moveLayer(t,e){return this.style.moveLayer(t,e),this._update(!0)}removeLayer(t){return this.style.removeLayer(t),this._update(!0)}getLayer(t){return this.style.getLayer(t)}setLayerZoomRange(t,e,i){return this.style.setLayerZoomRange(t,e,i),this._update(!0)}setFilter(t,e,i={}){return this.style.setFilter(t,e,i),this._update(!0)}getFilter(t){return this.style.getFilter(t)}setPaintProperty(t,e,i,n={}){return this.style.setPaintProperty(t,e,i,n),this._update(!0)}getPaintProperty(t,e){return this.style.getPaintProperty(t,e)}setLayoutProperty(t,e,i,n={}){return this.style.setLayoutProperty(t,e,i,n),this._update(!0)}getLayoutProperty(t,e){return this.style.getLayoutProperty(t,e)}setLight(t,e={}){return this._lazyInitEmptyStyle(),this.style.setLight(t,e),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(t){return this._lazyInitEmptyStyle(),!t&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(t),this._averageElevationLastSampledAt=-1/0,this._update(!0)}_updateProjection(){"globe"===this.transform.projection.name&&this.transform.zoom>=t.GLOBE_ZOOM_THRESHOLD_MAX&&!this._transitionFromGlobe&&(this.setProjection({name:"mercator"}),this._transitionFromGlobe=!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(t){return this._lazyInitEmptyStyle(),this.style.setFog(t),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(e){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(t.LngLat.convert(e),this.transform):0}setFeatureState(t,e){return this.style.setFeatureState(t,e),this._update()}removeFeatureState(t,e){return this.style.removeFeatureState(t,e),this._update()}getFeatureState(t){return this.style.getFeatureState(t)}_updateContainerDimensions(){if(!this._container)return;const e=this._container.getBoundingClientRect().width||400,i=this._container.getBoundingClientRect().height||300;let n,r=this._container;for(;r&&!n;){const e=t.window.getComputedStyle(r).transform;e&&"none"!==e&&(n=e.match(/matrix.*\((.+)\)/)[1].split(", ")),r=r.parentElement}n?(this._containerWidth=n[0]&&"0"!==n[0]?Math.abs(e/n[0]):e,this._containerHeight=n[3]&&"0"!==n[3]?Math.abs(i/n[3]):i):(this._containerWidth=e,this._containerHeight=i)}_detectMissingCSS(){"rgb(250, 128, 114)"!==t.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&t.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const t=this._container;t.classList.add("mapboxgl-map"),(this._missingCSSCanary=a.create("div","mapboxgl-canary",t)).style.visibility="hidden",this._detectMissingCSS();const e=this._canvasContainer=a.create("div","mapboxgl-canvas-container",t);this._interactive&&e.classList.add("mapboxgl-interactive"),this._canvas=a.create("canvas","mapboxgl-canvas",e),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const i=this._controlContainer=a.create("div","mapboxgl-control-container",t),n=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(t=>{n[t]=a.create("div","mapboxgl-ctrl-"+t,i)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(e,i){const n=t.exported.devicePixelRatio||1;this._canvas.width=n*Math.ceil(e),this._canvas.height=n*Math.ceil(i),this._canvas.style.width=e+"px",this._canvas.style.height=i+"px"}_addMarker(t){this._markers.push(t)}_removeMarker(t){const e=this._markers.indexOf(t);-1!==e&&this._markers.splice(e,1)}_setupPainter(){const i=t.extend({},e.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),n=this._canvas.getContext("webgl",i)||this._canvas.getContext("experimental-webgl",i);n?(t.storeAuthState(n,!0),this.painter=new pn(n,this.transform),this.on("data",t=>{"source"===t.dataType&&this.painter.setTileLoadedFlag(!0)}),t.exported$1.testSupport(n)):this.fire(new t.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(e){e.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new t.Event("webglcontextlost",{originalEvent:e}))}_contextRestored(e){this._setupPainter(),this.resize(),this._update(),this.fire(new t.Event("webglcontextrestored",{originalEvent:e}))}_onMapScroll(t){if(t.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(t){return this.style?(this._styleDirty=this._styleDirty||t,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(t){return this._update(),this._renderTaskQueue.add(t)}_cancelRenderFrame(t){this._renderTaskQueue.remove(t)}_requestDomTask(t){!this.loaded()||this.loaded()&&!this.isMoving()?t():this._domRenderTaskQueue.add(t)}_render(e){let i;const n=this.painter.context.extTimerQuery,r=t.exported.now();this.listens("gpu-timing-frame")&&(i=n.createQueryEXT(),n.beginQueryEXT(n.TIME_ELAPSED_EXT,i));let o=this._updateAverageElevation(r);if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(e),this._domRenderTaskQueue.run(e),this._removed)return;this._updateProjection();let a=!1;const s=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const e=this.transform.zoom,i=this.transform.pitch,n=t.exported.now();this.style.zoomHistory.update(e,n);const r=new t.EvaluationParameters(e,{now:n,fadeDuration:s,pitch:i,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),o=r.crossFadingFactor();1===o&&o===this._crossFadingFactor||(a=!0,this._crossFadingFactor=o),this.style.update(r)}if(this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0),this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),this.style._updateSources(this.transform),this._forceMarkerUpdate()),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,s,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:s,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),speedIndexTiming:this.speedIndexTiming}),this.fire(new t.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new t.Event("load"))),this.style&&(this.style.hasTransitions()||a)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),this.listens("gpu-timing-frame")){const e=t.exported.now()-r;n.endQueryEXT(n.TIME_ELAPSED_EXT,i),setTimeout(()=>{const r=n.getQueryObjectEXT(i,n.QUERY_RESULT_EXT)/1e6;n.deleteQueryEXT(i),this.fire(new t.Event("gpu-timing-frame",{cpuTime:e,gpuTime:r}))},50)}if(this.listens("gpu-timing-layer")){const e=this.painter.collectGpuTimers();setTimeout(()=>{const i=this.painter.queryGpuTimers(e);this.fire(new t.Event("gpu-timing-layer",{layerTimes:i}))},50)}const l=this._sourcesDirty||this._styleDirty||this._placementDirty||o;if(l||this._repaint)this.triggerRepaint();else{const e=!this.isMoving()&&this.loaded();if(e&&(o=this._updateAverageElevation(r,!0)),o)this.triggerRepaint();else if(this._triggerFrame(!1),e&&(this.fire(new t.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const e=this._calculateSpeedIndex();this.fire(new t.Event("speedindexcompleted",{speedIndex:e})),this.speedIndexTiming=!1}}return!this._loaded||this._fullyLoaded||l||(this._fullyLoaded=!0,this._authenticate()),this}_forceMarkerUpdate(){for(const t of this._markers)t._update()}_updateAverageElevation(t,e=!1){const i=t=>(this.transform.averageElevation=t,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);if((e||t-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(t)){const e=this.transform.averageElevation;let n=this.transform.sampleAverageElevation();isNaN(n)?n=0:this._averageElevationLastSampledAt=t;const r=Math.abs(e-n);if(r>1){if(this._isInitialLoad)return this._averageElevation.jumpTo(n),i(n);this._averageElevation.easeTo(n,t,300)}else if(r>1e-4)return this._averageElevation.jumpTo(n),i(n)}return!!this._averageElevation.isEasing(t)&&i(this._averageElevation.getValue(t))}_authenticate(){t.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,e=>{if(e&&(e.message===t.AUTH_ERR_MSG||401===e.status)){const e=this.painter.context.gl;t.storeAuthState(e,!1),this._logoControl instanceof Cr&&this._logoControl._updateLogo(),e&&e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new t.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),t.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){this.painter.updateTerrain(this.style,this.isMoving()||this.isRotating()||this.isZooming())}_calculateSpeedIndex(){const t=this.painter.canvasCopy(),e=this.painter.getCanvasCopiesAndTimestamps();e.timeStamps.push(performance.now());const i=this.painter.context.gl,n=i.createFramebuffer();function r(t){i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0);const e=new Uint8Array(i.drawingBufferWidth*i.drawingBufferHeight*4);return i.readPixels(0,0,i.drawingBufferWidth,i.drawingBufferHeight,i.RGBA,i.UNSIGNED_BYTE,e),e}return i.bindFramebuffer(i.FRAMEBUFFER,n),this._canvasPixelComparison(r(t),e.canvasCopies.map(r),e.timeStamps)}_canvasPixelComparison(t,e,i){let n=i[1]-i[0];const r=t.length/4;for(let o=0;o<e.length;o++){const a=e[o];let s=0;for(let e=0;e<a.length;e+=4)a[e]===t[e]&&a[e+1]===t[e+1]&&a[e+2]===t[e+2]&&a[e+3]===t[e+3]&&(s+=1);n+=(i[o+2]-i[o+1])*(1-s/r)}return n}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),void 0!==t.window&&(t.window.removeEventListener("resize",this._onWindowResize,!1),t.window.removeEventListener("orientationchange",this._onWindowResize,!1),t.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),t.window.removeEventListener("online",this._onWindowOnline,!1));const e=this.painter.context.gl.getExtension("WEBGL_lose_context");e&&e.loseContext(),Fr(this._canvasContainer),Fr(this._controlContainer),Fr(this._missingCSSCanary),this._container.classList.remove("mapboxgl-map"),t.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new t.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(e){this._renderNextFrame=this._renderNextFrame||e,this.style&&!this._frame&&(this._frame=t.exported.frame(t=>{const e=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,e&&this._render(t)}))}_preloadTiles(e){const i=this.style&&Object.values(this.style._sourceCaches)||[];return t.asyncAll(i,(t,i)=>t._preloadTiles(e,i),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(t){this._trackResize&&this.resize({originalEvent:t})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(t){this._showTileBoundaries!==t&&(this._showTileBoundaries=t,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(t){this._showTerrainWireframe!==t&&(this._showTerrainWireframe=t,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(t){this._speedIndexTiming!==t&&(this._speedIndexTiming=t,this._update())}get showPadding(){return!!this._showPadding}set showPadding(t){this._showPadding!==t&&(this._showPadding=t,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(t){this._showCollisionBoxes!==t&&(this._showCollisionBoxes=t,t?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(t){this._showOverdrawInspector!==t&&(this._showOverdrawInspector=t,this._update())}get repaint(){return!!this._repaint}set repaint(t){this._repaint!==t&&(this._repaint=t,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(t){this._vertices=t,this._update()}_setCacheLimits(e,i){t.setCacheLimits(e,i)}get version(){return t.version}},NavigationControl:class{constructor(e){this.options=t.extend({},Nr,e),this._container=a.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(t.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>this._map.zoomIn({},{originalEvent:t})),a.create("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden",!0),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>this._map.zoomOut({},{originalEvent:t})),a.create("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden",!0)),this.options.showCompass&&(t.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:t}):this._map.resetNorth({},{originalEvent:t})}),this._compassIcon=a.create("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden",!0))}_updateZoomButtons(){const t=this._map.getZoom(),e=t===this._map.getMaxZoom(),i=t===this._map.getMinZoom();this._zoomInButton.disabled=e,this._zoomOutButton.disabled=i,this._zoomInButton.setAttribute("aria-disabled",e.toString()),this._zoomOutButton.setAttribute("aria-disabled",i.toString())}_rotateCompassArrow(){const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._map._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(t){return this._map=t,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new jr(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){this._container.remove(),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(t,e){const i=a.create("button",t,this._container);return i.type="button",i.addEventListener("click",e),i}_setButtonTitle(t,e){const i=this._map._getUIString("NavigationControl."+e);t.setAttribute("aria-label",i),t.firstElementChild&&t.firstElementChild.setAttribute("title",i)}},GeolocateControl:class extends t.Evented{constructor(e){super(),this.options=t.extend({},Gr,e),t.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation"],this),this._onDeviceOrientationListener=this._onDeviceOrientation.bind(this),this._updateMarkerRotationThrottled=An(this._updateMarkerRotation,20)}onAdd(e){var i;return this._map=e,this._container=a.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),i=this._setupUI,void 0!==Ur?i(Ur):void 0!==t.window.navigator.permissions?t.window.navigator.permissions.query({name:"geolocation"}).then(t=>{Ur="denied"!==t.state,i(Ur)}):(Ur=!!t.window.navigator.geolocation,i(Ur)),this._container}onRemove(){void 0!==this._geolocationWatchID&&(t.window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,Vr=0,Hr=!1}_isOutOfMapMaxBounds(t){const e=this._map.getMaxBounds(),i=t.coords;return e&&(i.longitude<e.getWest()||i.longitude>e.getEast()||i.latitude<e.getSouth()||i.latitude>e.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(e){if(this._map){if(this._isOutOfMapMaxBounds(e))return this._setErrorState(),this.fire(new t.Event("outofmaxbounds",e)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=e,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(e),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(e),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new t.Event("geolocate",e)),this._finish()}}_updateCamera(e){const i=new t.LngLat(e.coords.longitude,e.coords.latitude),n=e.coords.accuracy,r=this._map.getBearing(),o=t.extend({bearing:r},this.options.fitBoundsOptions);this._map.fitBounds(i.toBounds(n),o,{geolocateSource:!0})}_updateMarker(e){if(e){const i=new t.LngLat(e.coords.longitude,e.coords.latitude);this._accuracyCircleMarker.setLngLat(i).addTo(this._map),this._userLocationDotMarker.setLngLat(i).addTo(this._map),this._accuracy=e.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const t=this._map._containerHeight/2,e=this._map.unproject([0,t]),i=this._map.unproject([100,t]),n=e.distanceTo(i)/100,r=Math.ceil(2*this._accuracy/n);this._circleElement.style.width=r+"px",this._circleElement.style.height=r+"px"}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(e){if(this._map){if(this.options.trackUserLocation)if(1===e.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===e.code&&Hr)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new t.Event("error",e)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(e){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=a.create("button","mapboxgl-ctrl-geolocate",this._container),a.create("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden",!0),this._geolocateButton.type="button",!1===e){t.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=a.create("div","mapboxgl-user-location"),this._dotElement.appendChild(a.create("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(a.create("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Ir({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=a.create("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ir({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",e=>{e.geolocateSource||"ACTIVE_LOCK"!==this._watchState||e.originalEvent&&"resize"===e.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new t.Event("trackuserlocationend")))})}_onDeviceOrientation(t){this._userLocationDotMarker&&(t.webkitCompassHeading?this._heading=t.webkitCompassHeading:!0===t.absolute&&(this._heading=-1*t.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return t.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new t.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Vr--,Hr=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new t.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new t.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let e;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Vr++,Vr>1?(e={maximumAge:6e5,timeout:0},Hr=!0):(e=this.options.positionOptions,Hr=!1),this._geolocationWatchID=t.window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,e),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else t.window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{t.window.addEventListener("ondeviceorientationabsolute"in t.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientationListener)};void 0!==t.window.DeviceMotionEvent&&"function"==typeof t.window.DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(t=>{"granted"===t&&e()}).catch(console.error):e()}_clearWatch(){t.window.navigator.geolocation.clearWatch(this._geolocationWatchID),t.window.removeEventListener("deviceorientation",this._onDeviceOrientationListener),t.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientationListener),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Er,ScaleControl:class{constructor(e){this.options=t.extend({},Zr,e),t.bindAll(["_onMove","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_onMove(){Wr(this._map,this._container,this.options)}onAdd(t){return this._map=t,this._container=a.create("div","mapboxgl-ctrl mapboxgl-ctrl-scale",t.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._onMove),this._map=void 0}setUnit(t){this.options.unit=t,Wr(this._map,this._container,this.options)}},FullscreenControl:class{constructor(e){this._fullscreen=!1,e&&e.container&&(e.container instanceof t.window.HTMLElement?this._container=e.container:t.warnOnce("Full screen control 'container' must be a DOM element.")),t.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in t.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in t.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(e){return this._map=e,this._container||(this._container=this._map.getContainer()),this._controlContainer=a.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",t.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,t.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!t.window.document.fullscreenEnabled&&!t.window.document.webkitFullscreenEnabled)}_setupUI(){const e=this._fullscreenButton=a.create("button","mapboxgl-ctrl-fullscreen",this._controlContainer);a.create("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden",!0),e.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),t.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const t=this._getTitle();this._fullscreenButton.setAttribute("aria-label",t),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",t)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(t.window.document.fullscreenElement||t.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?t.window.document.exitFullscreen?t.window.document.exitFullscreen():t.window.document.webkitCancelFullScreen&&t.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends t.Evented{constructor(e){super(),this.options=t.extend(Object.create(Xr),e),t.bindAll(["_update","_onClose","remove","_onMouseMove","_onMouseUp","_onDrag"],this),this._classList=new Set(e&&e.className?e.className.trim().split(/\s+/):[])}addTo(e){return this._map&&this.remove(),this._map=e,this.options.closeOnClick&&this._map.on("preclick",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")):this._map.on("move",this._update),this.fire(new t.Event("open")),this}isOpen(){return!!this._map}remove(){return this._content&&this._content.remove(),this._container&&(this._container.remove(),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),delete this._map),this.fire(new t.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(e){return this._lngLat=t.LngLat.convert(e),this._pos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._map._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(e){return this.setDOMContent(t.window.document.createTextNode(e))}setHTML(e){const i=t.window.document.createDocumentFragment(),n=t.window.document.createElement("body");let r;for(n.innerHTML=e;r=n.firstChild,r;)i.appendChild(r);return this.setDOMContent(i)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(t){return this.options.maxWidth=t,this._update(),this}setDOMContent(t){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=a.create("div","mapboxgl-popup-content",this._container);return this._content.appendChild(t),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(t){return this._classList.add(t),this._container&&this._updateClassList(),this}removeClassName(t){return this._classList.delete(t),this._container&&this._updateClassList(),this}setOffset(t){return this.options.offset=t,this._update(),this}toggleClassName(t){let e;return this._classList.delete(t)?e=!1:(this._classList.add(t),e=!0),this._container&&this._updateClassList(),e}_createCloseButton(){this.options.closeButton&&(this._closeButton=a.create("button","mapboxgl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.setAttribute("aria-hidden","true"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_onMouseUp(t){this._update(t.point)}_onMouseMove(t){this._update(t.point)}_onDrag(t){this._update(t.point)}_getAnchor(t){if(this.options.anchor)return this.options.anchor;const e=this._pos,i=this._container.offsetWidth,n=this._container.offsetHeight;let r;return r=e.y+t.bottom.y<n?["top"]:e.y>this._map.transform.height-n?["bottom"]:[],e.x<i/2?r.push("left"):e.x>this._map.transform.width-i/2&&r.push("right"),0===r.length?"bottom":r.join("-")}_updateClassList(){const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push("mapboxgl-popup-anchor-"+this._anchor),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),this._container.className=t.join(" ")}_update(e){if(this._map&&(this._lngLat||this._trackPointer)&&this._content){if(this._container||(this._container=a.create("div","mapboxgl-popup",this._map.getContainer()),this._tip=a.create("div","mapboxgl-popup-tip",this._container),this._container.appendChild(this._content)),this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._map.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Pr(this._lngLat,this._pos,this._map.transform)),!this._trackPointer||e){const i=this._pos=this._trackPointer&&e?e:this._map.project(this._lngLat),n=function(e){if(e||(e=new t.pointGeometry(0,0)),"number"==typeof e){const i=Math.round(Math.sqrt(.5*Math.pow(e,2)));return{center:new t.pointGeometry(0,0),top:new t.pointGeometry(0,e),"top-left":new t.pointGeometry(i,i),"top-right":new t.pointGeometry(-i,i),bottom:new t.pointGeometry(0,-e),"bottom-left":new t.pointGeometry(i,-i),"bottom-right":new t.pointGeometry(-i,-i),left:new t.pointGeometry(e,0),right:new t.pointGeometry(-e,0)}}if(e instanceof t.pointGeometry||Array.isArray(e)){const i=t.pointGeometry.convert(e);return{center:i,top:i,"top-left":i,"top-right":i,bottom:i,"bottom-left":i,"bottom-right":i,left:i,right:i}}return{center:t.pointGeometry.convert(e.center||[0,0]),top:t.pointGeometry.convert(e.top||[0,0]),"top-left":t.pointGeometry.convert(e["top-left"]||[0,0]),"top-right":t.pointGeometry.convert(e["top-right"]||[0,0]),bottom:t.pointGeometry.convert(e.bottom||[0,0]),"bottom-left":t.pointGeometry.convert(e["bottom-left"]||[0,0]),"bottom-right":t.pointGeometry.convert(e["bottom-right"]||[0,0]),left:t.pointGeometry.convert(e.left||[0,0]),right:t.pointGeometry.convert(e.right||[0,0])}}(this.options.offset),r=this._anchor=this._getAnchor(n),o=i.add(n[r]).round();this._map._requestDomTask(()=>{this._container&&r&&(this._container.style.transform=`${Lr[r]} translate(${o.x}px,${o.y}px)`)})}this._updateClassList()}}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const t=this._container.querySelector(Yr);t&&t.focus()}_onClose(){this.remove()}_setOpacity(t){this._content&&(this._content.style.opacity=t),this._tip&&(this._tip.style.opacity=t)}},Marker:Ir,Style:je,LngLat:t.LngLat,LngLatBounds:t.LngLatBounds,Point:t.pointGeometry,MercatorCoordinate:t.MercatorCoordinate,FreeCameraOptions:vn,Evented:t.Evented,config:t.config,prewarm:function(){Rt().acquire(Pt)},clearPrewarmedResources:function(){const t=It;t&&(t.isPreloaded()&&1===t.numActive()?(t.release(Pt),It=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return t.config.ACCESS_TOKEN},set accessToken(e){t.config.ACCESS_TOKEN=e},get baseApiUrl(){return t.config.API_URL},set baseApiUrl(e){t.config.API_URL=e},get workerCount(){return Lt.workerCount},set workerCount(t){Lt.workerCount=t},get maxParallelImageRequests(){return t.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(e){t.config.MAX_PARALLEL_IMAGE_REQUESTS=e},clearStorage(e){t.clearTileCache(e)},workerUrl:"",workerClass:null,setNow:t.exported.setNow,restoreNow:t.exported.restoreNow};return $r})),n}()}).call(this,i(20))},function(t,e){var i,n,r=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function s(t){if(i===setTimeout)return setTimeout(t,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(t){i=o}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(t){n=a}}();var l,c=[],h=!1,u=-1;function d(){h&&l&&(h=!1,l.length?c=l.concat(c):u=-1,c.length&&p())}function p(){if(!h){var t=s(d);h=!0;for(var e=c.length;e;){for(l=c,c=[];++u<e;)l&&l[u].run();u=-1,e=c.length}l=null,h=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function m(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];c.push(new f(t,e)),1!==c.length||h||s(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=m,r.addListener=m,r.once=m,r.off=m,r.removeListener=m,r.removeAllListeners=m,r.emit=m,r.prependListener=m,r.prependOnceListener=m,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(t,e,i){var n,r,o;o=function(){var t,e={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},i=function(){var t=function(t){this._coordinator={},this._data=[],this._radi=[],this._min=10,this._max=1,this._xField=t.xField||t.defaultXField,this._yField=t.yField||t.defaultYField,this._valueField=t.valueField||t.defaultValueField,t.radius&&(this._cfgRadius=t.radius)},i=e.defaultRadius;return t.prototype={_organiseData:function(t,e){var n=t[this._xField],r=t[this._yField],o=this._radi,a=this._data,s=this._max,l=this._min,c=t[this._valueField]||1,h=t.radius||this._cfgRadius||i;a[n]||(a[n]=[],o[n]=[]),a[n][r]?a[n][r]+=c:(a[n][r]=c,o[n][r]=h);var u=a[n][r];return u>s?(e?this.setDataMax(u):this._max=u,!1):u<l?(e?this.setDataMin(u):this._min=u,!1):{x:n,y:r,value:c,radius:h,min:l,max:s}},_unOrganizeData:function(){var t=[],e=this._data,i=this._radi;for(var n in e)for(var r in e[n])t.push({x:n,y:r,radius:i[n][r],value:e[n][r]});return{min:this._min,max:this._max,data:t}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var t=arguments[0],e=t.length;e--;)this.addData.call(this,t[e]);else{var i=this._organiseData(arguments[0],!0);i&&(0===this._data.length&&(this._min=this._max=i.value),this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[i]}))}return this},setData:function(t){var e=t.data,i=e.length;this._data=[],this._radi=[];for(var n=0;n<i;n++)this._organiseData(e[n],!1);return this._max=t.max,this._min=t.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(t){return this._max=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(t){return this._min=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(t){this._coordinator=t},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},t}(),n=function(){var t=function(t){var e=t.gradient||t.defaultGradient,i=document.createElement("canvas"),n=i.getContext("2d");i.width=256,i.height=1;var r=n.createLinearGradient(0,0,256,1);for(var o in e)r.addColorStop(o,e[o]);return n.fillStyle=r,n.fillRect(0,0,256,1),n.getImageData(0,0,256,1).data},e=function(t,e){var i=document.createElement("canvas"),n=i.getContext("2d"),r=t,o=t;if(i.width=i.height=2*t,1==e)n.beginPath(),n.arc(r,o,t,0,2*Math.PI,!1),n.fillStyle="rgba(0,0,0,1)",n.fill();else{var a=n.createRadialGradient(r,o,t*e,r,o,t);a.addColorStop(0,"rgba(0,0,0,1)"),a.addColorStop(1,"rgba(0,0,0,0)"),n.fillStyle=a,n.fillRect(0,0,2*t,2*t)}return i};function i(e){var i=e.container,n=this.shadowCanvas=document.createElement("canvas"),r=this.canvas=e.canvas||document.createElement("canvas"),o=(this._renderBoundaries=[1e4,1e4,0,0],getComputedStyle(e.container)||{});r.className="heatmap-canvas",this._width=r.width=n.width=e.width||+o.width.replace(/px/,""),this._height=r.height=n.height=e.height||+o.height.replace(/px/,""),this.shadowCtx=n.getContext("2d"),this.ctx=r.getContext("2d"),r.style.cssText=n.style.cssText="position:absolute;left:0;top:0;",i.style.position="relative",i.appendChild(r),this._palette=t(e),this._templates={},this._setStyles(e)}return i.prototype={renderPartial:function(t){t.data.length>0&&(this._drawAlpha(t),this._colorize())},renderAll:function(t){this._clear(),t.data.length>0&&(this._drawAlpha(function(t){for(var e=[],i=t.min,n=t.max,r=t.radi,o=(t=t.data,Object.keys(t)),a=o.length;a--;)for(var s=o[a],l=Object.keys(t[s]),c=l.length;c--;){var h=l[c],u=t[s][h],d=r[s][h];e.push({x:s,y:h,value:u,radius:d})}return{min:i,max:n,data:e}}(t)),this._colorize())},_updateGradient:function(e){this._palette=t(e)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,e){this._width=t,this._height=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=0==t.blur?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=t.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=t.height||this._height,this._opacity=255*(t.opacity||0),this._maxOpacity=255*(t.maxOpacity||t.defaultMaxOpacity),this._minOpacity=255*(t.minOpacity||t.defaultMinOpacity),this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(t){for(var i=this._min=t.min,n=this._max=t.max,r=(t=t.data||[]).length,o=1-this._blur;r--;){var a,s=t[r],l=s.x,c=s.y,h=s.radius,u=Math.min(s.value,n),d=l-h,p=c-h,f=this.shadowCtx;this._templates[h]?a=this._templates[h]:this._templates[h]=a=e(h,o);var m=(u-i)/(n-i);f.globalAlpha=m<.01?.01:m,f.drawImage(a,d,p),d<this._renderBoundaries[0]&&(this._renderBoundaries[0]=d),p<this._renderBoundaries[1]&&(this._renderBoundaries[1]=p),d+2*h>this._renderBoundaries[2]&&(this._renderBoundaries[2]=d+2*h),p+2*h>this._renderBoundaries[3]&&(this._renderBoundaries[3]=p+2*h)}},_colorize:function(){var t=this._renderBoundaries[0],e=this._renderBoundaries[1],i=this._renderBoundaries[2]-t,n=this._renderBoundaries[3]-e,r=this._width,o=this._height,a=this._opacity,s=this._maxOpacity,l=this._minOpacity,c=this._useGradientOpacity;t<0&&(t=0),e<0&&(e=0),t+i>r&&(i=r-t),e+n>o&&(n=o-e);for(var h=this.shadowCtx.getImageData(t,e,i,n),u=h.data,d=u.length,p=this._palette,f=3;f<d;f+=4){var m,g=u[f],y=4*g;y&&(m=a>0?a:g<s?g<l?l:g:s,u[f-3]=p[y],u[f-2]=p[y+1],u[f-1]=p[y+2],u[f]=c?p[y+3]:m)}h.data=u,this.ctx.putImageData(h,t,e),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var e=this.shadowCtx.getImageData(t.x,t.y,1,1).data[3],i=this._max,n=this._min;return Math.abs(i-n)*(e/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}},i}(),r=(t=!1,"canvas2d"===e.defaultRenderer&&(t=n),t),o=function(){for(var t={},e=arguments.length,i=0;i<e;i++){var n=arguments[i];for(var r in n)t[r]=n[r]}return t},a=function(){var t=function(){function t(){this.cStore={}}return t.prototype={on:function(t,e,i){var n=this.cStore;n[t]||(n[t]=[]),n[t].push((function(t){return e.call(i,t)}))},emit:function(t,e){var i=this.cStore;if(i[t])for(var n=i[t].length,r=0;r<n;r++)(0,i[t][r])(e)}},t}(),n=function(t){var e=t._renderer,i=t._coordinator,n=t._store;i.on("renderpartial",e.renderPartial,e),i.on("renderall",e.renderAll,e),i.on("extremachange",(function(e){t._config.onExtremaChange&&t._config.onExtremaChange({min:e.min,max:e.max,gradient:t._config.gradient||t._config.defaultGradient})})),n.setCoordinator(i)};function a(){var a=this._config=o(e,arguments[0]||{});if(this._coordinator=new t,a.plugin){var s=a.plugin;if(!e.plugins[s])throw new Error("Plugin '"+s+"' not found. Maybe it was not registered.");var l=e.plugins[s];this._renderer=new l.renderer(a),this._store=new l.store(a)}else this._renderer=new r(a),this._store=new i(a);n(this)}return a.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(t){return this._config=o(this._config,t),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(t){return this._store.getValueAt?this._store.getValueAt(t):this._renderer.getValueAt?this._renderer.getValueAt(t):null}},a}();return{create:function(t){return new a(t)},register:function(t,i){e.plugins[t]=i}}},t.exports?t.exports=o():void 0===(r="function"==typeof(n=o)?n.call(e,i,e,t):n)||(t.exports=r)},function(t,e,i){function n(t){if(t=Object.assign({},t),!(this instanceof n))throw new Error("MapboxLanguage needs to be called with the new keyword");this.setLanguage=this.setLanguage.bind(this),this._initialStyleUpdate=this._initialStyleUpdate.bind(this),this._defaultLanguage=t.defaultLanguage,this._isLanguageField=t.languageField||/^\{name/,this._getLanguageField=t.getLanguageField||function(t){return"mul"===t?"{name}":"{name_"+t+"}"},this._languageSource=t.languageSource||null,this._languageTransform=t.languageTransform||function(t,e){return"ar"===e?function(t){var e=t.layers.map((function(t){if(!(t.layout||{})["text-field"])return t;return Object.assign({},t,{layout:Object.assign({},t.layout,{"text-letter-spacing":0})})}));return Object.assign({},t,{layers:e})}(t):function(t){var e=t.layers.map((function(t){if(!(t.layout||{})["text-field"])return t;var e=0;return"state_label"===t["source-layer"]&&(e=.15),"marine_label"===t["source-layer"]&&(/-lg/.test(t.id)&&(e=.25),/-md/.test(t.id)&&(e=.15),/-sm/.test(t.id)&&(e=.1)),"place_label"===t["source-layer"]&&(/-suburb/.test(t.id)&&(e=.15),/-neighbour/.test(t.id)&&(e=.1),/-islet/.test(t.id)&&(e=.01)),"airport_label"===t["source-layer"]&&(e=.01),"rail_station_label"===t["source-layer"]&&(e=.01),"poi_label"===t["source-layer"]&&/-scalerank/.test(t.id)&&(e=.01),"road_label"===t["source-layer"]&&(/-label-/.test(t.id)&&(e=.01),/-shields/.test(t.id)&&(e=.05)),Object.assign({},t,{layout:Object.assign({},t.layout,{"text-letter-spacing":e})})}));return Object.assign({},t,{layers:e})}(t)},this._excludedLayerIds=t.excludedLayerIds||[],this.supportedLanguages=t.supportedLanguages||["ar","en","es","fr","de","ja","ko","mul","pt","ru","zh"]}function r(t,e,i){if(function(t,e){return"string"==typeof e&&t.test(e)}(t,e))return i;if(function(t,e){return e.stops&&e.stops.filter((function(e){return t.test(e[1])})).length>0}(t,e)){var n=e.stops.map((function(e){return t.test(e[1])?[e[0],i]:e}));return Object.assign({},e,{stops:n})}return e}n.prototype.setLanguage=function(t,e){if(this.supportedLanguages.indexOf(e)<0)throw new Error("Language "+e+" is not supported");var i=this._languageSource||function(t){return Object.keys(t.sources).filter((function(e){var i=t.sources[e];return/mapbox-streets-v\d/.test(i.url)}))[0]}(t);if(!i)return t;var n=this._getLanguageField(e),o=this._isLanguageField,a=this._excludedLayerIds,s=t.layers.map((function(t){return t.source===i?function(t,e,i,n){return e.layout&&e.layout["text-field"]&&-1===n.indexOf(e.id)?Object.assign({},e,{layout:Object.assign({},e.layout,{"text-field":r(t,e.layout["text-field"],i)})}):e}(o,t,n,a):t})),l=Object.assign({},t,{layers:s});return this._languageTransform(l,e)},n.prototype._initialStyleUpdate=function(){var t=this._map.getStyle(),e=this._defaultLanguage||function(t){var e=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage,i=e.split("-"),n=e;i.length>1&&(n=i[0]);if(t.indexOf(n)>-1)return n;return null}(this.supportedLanguages);this._map.off("styledata",this._initialStyleUpdate),this._map.setStyle(this.setLanguage(t,e))},n.prototype.onAdd=function(t){return this._map=t,this._map.on("styledata",this._initialStyleUpdate),this._container=document.createElement("div"),this._container},n.prototype.onRemove=function(){this._map.off("styledata",this._initialStyleUpdate),this._map=void 0},void 0!==t.exports?t.exports=n:("function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){"use strict";if(null===t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),n=1;n<arguments.length;n++){var r=arguments[n];if(null!==r)for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(i[o]=r[o])}return i},writable:!0,configurable:!0}),window.MapboxLanguage=n)},function(t,e,i){"use strict";(function(t){i.d(e,"a",(function(){return f}));var n=i(8),r=i(4),o=i(5),a=i(6),s=i(14),l=i(10),c=i(9),h=i(2),u=i(7),d=i(11),p=i(3),f=function(e){Object(l.a)(d,e);var i=Object(c.a)(d);function d(e,a){var l;Object(o.a)(this,d),(l=i.call(this,e)).onZoom=function(t){var e=t&&null!=t.to?t.to:l.parent.map.getZoom(),i=Object(r.a)(l.config.baseConfig.showLevel,2),n=i[0],o=i[1];l.group.visible=!(e<n||e>o)},l.showData=function(){l.loadItem=Object(p.d)(Object(s.a)(l));var e=l.config.baseConfig,i=e.system,r=e.depthTest,o=e.renderOrder,a=l.config.styleConfig,c=a.backStyle,h=c.url,u=c.size,d=u.width,f=u.height,m=c.scale,g=c.center,y=a.contentStyle,_=y.simpleTextStyle,v=_.color,x=_.fontFamily,b=_.fontSize,w=y.textAlign,M=y.offset,T=0;"left"==w?T=M.x:"center"==w?T=d/2+M.x:"right"==w&&(T=d+M.x);var S=new Image;S.setAttribute("crossOrigin","anonymous"),S.src="".concat(window.appConfig.ASSETS_URL).concat(h),S.onload=function(){l.data.map((function(e){var a=e.lng,s=e.lat,c=e.name,h=e.height,u=void 0===h?0:h,y=document.createElement("canvas");y.setAttribute("width",d),y.setAttribute("height",f),y.style.position="absolute";var _=y.getContext("2d");_.drawImage(S,0,0,d,f),_.font="normal ".concat(b,"px ").concat(x),_.fillStyle=v,_.textAlign=w,_.textBaseline="middle",_.fillText(c,T,M.y);var E=new t.Texture(y);E.needsUpdate=!0,E.encoding=t.sRGBEncoding;var C=new t.SpriteMaterial({map:E,side:t.DoubleSide,depthWrite:!1,transparent:!0,depthTest:!r}),A=new t.Sprite(C);A.renderOrder=o;var P=Object(p.e)(g);A.center.set(P[0],P[1]),A.userData=Object(n.a)(Object(n.a)({},e),{},{drill:l.config.animateConfig.drill});var L=l.parent.threeLayer.distanceToVector3(0,1).y,I=l.parent.threeLayer.coordinateToVector3(l.parent.matchSystem(i,[a,s]),u*L);A.scale.set(d*m,f*m,1),A.position.copy(I),A.interactive=!0,A.componentId=l.id,l.group.add(A)})),l.loadItem.loaded=!0,l.parent.checkLoading()},l.onZoom()},l.id=e.id,l.config=e.configuration,l.interaction=e.configuration.interaction,l.data=e.data,l.parent=a,l.scene=a.extend.scene,l.group=new t.Group,l.group.name="标牌",l.meterScale=a.threeLayer.distanceToVector3(0,1).y;var c=l.config.baseConfig.altitude;return l.group.position.z=l.meterScale*c,l.scene.add(l.group),l.showData(),l.parent.map.on("zooming",l.onZoom),l}return Object(a.a)(d,[{key:"updateComponent",value:function(t){var e=this.config,i=this.data,n=e.baseConfig.altitude;this.config=t.configuration,this.interaction=t.configuration.interaction,this.data=t.data;var r=this.config.baseConfig.altitude;n!==r?this.group.position.z=this.meterScale*r:Object(h.isEqual)(e,this.config)&&Object(h.isEqual)(i,this.data)||(this.dispose(),this.showData())}},{key:"getSupportObjects",value:function(){return this.group}},{key:"selectAction",value:function(t){if(t&&t.componentId&&t.componentId===this.id){var e=this.parent.props,i=e.id,r=e.onRelative,o=e.emit,a=this.interaction.callback;if(r){var s=Object.values(a),l={};s.map((function(e){l[e.target]=t.userData[e.origin]||null})),r(i,l)}var c=t.userData,h=c.drill,u=c.zoom,d=c.lng,p=c.lat;if(h&&h.show&&d&&p){var f=this.parent.map.getMinZoom(),m=this.parent.map.getMaxZoom();u<f&&(u=f),u>m&&(u=m);var g=this.config.baseConfig.system;this.parent.map.animateTo({center:this.parent.matchSystem(g,[d,p]),zoom:u||this.parent.map.getZoom(),pitch:this.parent.map.getPitch(),bearing:this.parent.map.getBearing()},{duration:h.duration,easing:"in"})}o&&o("click",[Object(n.a)({},t.userData)],this.id)}}},{key:"update",value:function(){}},{key:"dispose",value:function(){Object(u.deepDispose)(this.group),this.group.children.length=0}},{key:"destroy",value:function(){this.scene.remove(this.group),this.dispose(),this.group=null,this.parent.map.off("zooming",this.onZoom)}}]),d}(d.a)}).call(this,i(0))},function(t,e,i){"use strict";(function(t){i.d(e,"a",(function(){return d}));var n=i(8),r=i(4),o=i(5),a=i(6),s=i(10),l=i(9),c=i(2),h=i(11),u=(i(1),i(7)),d=function(e){Object(s.a)(h,e);var i=Object(l.a)(h);function h(e,n){var a;return Object(o.a)(this,h),(a=i.call(this,e)).onZoom=function(t){var e=t&&null!=t.to?t.to:a.parent.map.getZoom(),i=Object(r.a)(a.config.baseConfig.showLevel,2),n=i[0],o=i[1];a.group.visible=!(e<n||e>o)},a.selectAction=function(t){if(t&&t.componentId&&t.componentId===a.id){var e=a.parent,i=e.id,n=e.onRelative,r=e.emit,o=a.interaction.callback,s=t.userData;if(n){var l=Object.values(o),c={};l.map((function(t){c[t.target]=s&&s[t.origin]||null})),n(i,c)}r&&r("click",[s],a.id)}},a.id=e.id,a.config=e.configuration,a.interaction=e.configuration.interaction,a.data=e.data,a.parent=n,a.scene=n.extend.scene,a.camera=n.extend.camera,a.renderer=n.extend.renderer,a.container=n.container,a.parent.map.on("zooming",a.onZoom),a.group=new t.Group,a.group.name="自定义模型",a.scene.add(a.group),a.init(),a}return Object(a.a)(h,[{key:"getExtend",value:function(t){var e=this.config.baseConfig.system,i=this.parent.matchSystem(e,[t.lngMin,t.latMin]),n=Object(r.a)(i,2),o=n[0],a=n[1],s=this.parent.matchSystem(e,[t.lngMax,t.latMax]),l=Object(r.a)(s,2);return[o,a,l[0],l[1]]}},{key:"addImage",value:function(e){var i=e.extent,n=e.url,r=e.opacity,o=e.data,a=this.parent.threeLayer.coordinateToVector3(i.slice(0,2)),s=this.parent.threeLayer.coordinateToVector3(i.slice(2,4)),l=s.x-a.x,c=s.y-a.y,h=(new t.TextureLoader).load(n);h.encoding=this.renderer.outputEncoding;var u=new t.PlaneBufferGeometry(l,c),d=new t.MeshBasicMaterial({map:h,depthTest:!1,opacity:r,transparent:!0}),p=new t.Mesh(u,d),f=[(i[2]+i[0])/2,(i[3]+i[1])/2],m=this.parent.threeLayer.coordinateToVector3(f);return p.position.copy(m),p.interactive=!0,p.componentId=this.id,p.renderOrder=-1,p.userData=o,this.group.add(p),p}},{key:"init",value:function(){var t=this,e=this.config.styleConfig,i=e.url,r=e.bound,o=e.opacity;if(this.data&&this.data.length)this.data.map((function(e){var i={url:e.url,extent:t.getExtend(e),opacity:e.opacity,data:e};t.addImage(i)}));else{var a={url:window.appConfig.ASSETS_URL+i,extent:this.getExtend(r),opacity:o,data:Object(n.a)(Object(n.a)({},r),{},{url:window.appConfig.ASSETS_URL+i,opacity:o})};this.addImage(a)}this.onZoom()}},{key:"getSupportObjects",value:function(){return this.group}},{key:"updateComponent",value:function(t){var e=this.config,i=this.data;this.config=t.configuration,this.data=t.data,Object(c.isEqual)(this.config,e)&&Object(c.isEqual)(this.data,i)||(this.dispose(),this.init())}},{key:"dispose",value:function(){Object(u.deepDisposeGroup)(this.group),this.group.children.length=0}},{key:"destroy",value:function(){this.parent.map.off("zooming",this.onZoom),this.dispose()}}]),h}(h.a)}).call(this,i(0))},function(t,e){t.exports=i},function(t,e,i){"use strict";i.r(e),i.d(e,"ACESFilmicToneMapping",(function(){return it})),i.d(e,"AddEquation",(function(){return S})),i.d(e,"AddOperation",(function(){return J})),i.d(e,"AdditiveAnimationBlendMode",(function(){return We})),i.d(e,"AdditiveBlending",(function(){return b})),i.d(e,"AlphaFormat",(function(){return zt})),i.d(e,"AlwaysDepth",(function(){return U})),i.d(e,"AlwaysStencilFunc",(function(){return Mi})),i.d(e,"AmbientLight",(function(){return au})),i.d(e,"AmbientLightProbe",(function(){return Au})),i.d(e,"AnimationClip",(function(){return ph})),i.d(e,"AnimationLoader",(function(){return bh})),i.d(e,"AnimationMixer",(function(){return od})),i.d(e,"AnimationObjectGroup",(function(){return nd})),i.d(e,"AnimationUtils",(function(){return th})),i.d(e,"ArcCurve",(function(){return Ph})),i.d(e,"ArrayCamera",(function(){return As})),i.d(e,"ArrowHelper",(function(){return Xd})),i.d(e,"Audio",(function(){return Nu})),i.d(e,"AudioAnalyser",(function(){return Zu})),i.d(e,"AudioContext",(function(){return Su})),i.d(e,"AudioListener",(function(){return Fu})),i.d(e,"AudioLoader",(function(){return Eu})),i.d(e,"AxesHelper",(function(){return Yd})),i.d(e,"AxisHelper",(function(){return Kp})),i.d(e,"BackSide",(function(){return m})),i.d(e,"BasicDepthPacking",(function(){return ri})),i.d(e,"BasicShadowMap",(function(){return h})),i.d(e,"BinaryTextureLoader",(function(){return rf})),i.d(e,"Bone",(function(){return dl})),i.d(e,"BooleanKeyframeTrack",(function(){return ah})),i.d(e,"BoundingBoxHelper",(function(){return Qp})),i.d(e,"Box2",(function(){return md})),i.d(e,"Box3",(function(){return Qi})),i.d(e,"Box3Helper",(function(){return Vd})),i.d(e,"BoxBufferGeometry",(function(){return po})),i.d(e,"BoxGeometry",(function(){return po})),i.d(e,"BoxHelper",(function(){return Ud})),i.d(e,"BufferAttribute",(function(){return Sr})),i.d(e,"BufferGeometry",(function(){return Wr})),i.d(e,"BufferGeometryLoader",(function(){return fu})),i.d(e,"ByteType",(function(){return St})),i.d(e,"Cache",(function(){return mh})),i.d(e,"Camera",(function(){return _o})),i.d(e,"CameraHelper",(function(){return Nd})),i.d(e,"CanvasRenderer",(function(){return sf})),i.d(e,"CanvasTexture",(function(){return Gl})),i.d(e,"CatmullRomCurve3",(function(){return Oh})),i.d(e,"CineonToneMapping",(function(){return et})),i.d(e,"CircleBufferGeometry",(function(){return Vl})),i.d(e,"CircleGeometry",(function(){return Vl})),i.d(e,"ClampToEdgeWrapping",(function(){return dt})),i.d(e,"Clock",(function(){return Ru})),i.d(e,"ClosedSplineCurve3",(function(){return Yp})),i.d(e,"Color",(function(){return _r})),i.d(e,"ColorKeyframeTrack",(function(){return sh})),i.d(e,"CompressedTexture",(function(){return jl})),i.d(e,"CompressedTextureLoader",(function(){return wh})),i.d(e,"ConeBufferGeometry",(function(){return Zl})),i.d(e,"ConeGeometry",(function(){return Zl})),i.d(e,"CubeCamera",(function(){return xo})),i.d(e,"CubeReflectionMapping",(function(){return ot})),i.d(e,"CubeRefractionMapping",(function(){return at})),i.d(e,"CubeTexture",(function(){return bo})),i.d(e,"CubeTextureLoader",(function(){return Th})),i.d(e,"CubeUVReflectionMapping",(function(){return ct})),i.d(e,"CubeUVRefractionMapping",(function(){return ht})),i.d(e,"CubicBezierCurve",(function(){return Nh})),i.d(e,"CubicBezierCurve3",(function(){return jh})),i.d(e,"CubicInterpolant",(function(){return ih})),i.d(e,"CullFaceBack",(function(){return s})),i.d(e,"CullFaceFront",(function(){return l})),i.d(e,"CullFaceFrontBack",(function(){return c})),i.d(e,"CullFaceNone",(function(){return a})),i.d(e,"Curve",(function(){return Ch})),i.d(e,"CurvePath",(function(){return qh})),i.d(e,"CustomBlending",(function(){return T})),i.d(e,"CustomToneMapping",(function(){return nt})),i.d(e,"CylinderBufferGeometry",(function(){return Hl})),i.d(e,"CylinderGeometry",(function(){return Hl})),i.d(e,"Cylindrical",(function(){return pd})),i.d(e,"DataTexture",(function(){return Mo})),i.d(e,"DataTexture2DArray",(function(){return qo})),i.d(e,"DataTexture3D",(function(){return Xo})),i.d(e,"DataTextureLoader",(function(){return Sh})),i.d(e,"DataUtils",(function(){return Kd})),i.d(e,"DecrementStencilOp",(function(){return di})),i.d(e,"DecrementWrapStencilOp",(function(){return fi})),i.d(e,"DefaultLoadingManager",(function(){return yh})),i.d(e,"DepthFormat",(function(){return Ut})),i.d(e,"DepthStencilFormat",(function(){return Vt})),i.d(e,"DepthTexture",(function(){return Ul})),i.d(e,"DirectionalLight",(function(){return ou})),i.d(e,"DirectionalLightHelper",(function(){return zd})),i.d(e,"DiscreteInterpolant",(function(){return rh})),i.d(e,"DodecahedronBufferGeometry",(function(){return ql})),i.d(e,"DodecahedronGeometry",(function(){return ql})),i.d(e,"DoubleSide",(function(){return g})),i.d(e,"DstAlphaFactor",(function(){return z})),i.d(e,"DstColorFactor",(function(){return F})),i.d(e,"DynamicBufferAttribute",(function(){return Np})),i.d(e,"DynamicCopyUsage",(function(){return Ii})),i.d(e,"DynamicDrawUsage",(function(){return Si})),i.d(e,"DynamicReadUsage",(function(){return Ai})),i.d(e,"EdgesGeometry",(function(){return Kl})),i.d(e,"EdgesHelper",(function(){return tf})),i.d(e,"EllipseCurve",(function(){return Ah})),i.d(e,"EqualDepth",(function(){return Z})),i.d(e,"EqualStencilFunc",(function(){return _i})),i.d(e,"EquirectangularReflectionMapping",(function(){return st})),i.d(e,"EquirectangularRefractionMapping",(function(){return lt})),i.d(e,"Euler",(function(){return Dn})),i.d(e,"EventDispatcher",(function(){return Oi})),i.d(e,"ExtrudeBufferGeometry",(function(){return Cc})),i.d(e,"ExtrudeGeometry",(function(){return Cc})),i.d(e,"Face3",(function(){return vr})),i.d(e,"Face4",(function(){return Tp})),i.d(e,"FaceColors",(function(){return Ap})),i.d(e,"FileLoader",(function(){return xh})),i.d(e,"FlatShading",(function(){return y})),i.d(e,"Float16BufferAttribute",(function(){return Dr})),i.d(e,"Float32Attribute",(function(){return qp})),i.d(e,"Float32BufferAttribute",(function(){return kr})),i.d(e,"Float64Attribute",(function(){return Xp})),i.d(e,"Float64BufferAttribute",(function(){return Or})),i.d(e,"FloatType",(function(){return Lt})),i.d(e,"Fog",(function(){return zs})),i.d(e,"FogExp2",(function(){return Os})),i.d(e,"Font",(function(){return bu})),i.d(e,"FontLoader",(function(){return Mu})),i.d(e,"FrontSide",(function(){return f})),i.d(e,"Frustum",(function(){return Eo})),i.d(e,"GLBufferAttribute",(function(){return ld})),i.d(e,"GLSL1",(function(){return Di})),i.d(e,"GLSL3",(function(){return ki})),i.d(e,"GammaEncoding",(function(){return Ke})),i.d(e,"GeometryUtils",(function(){return af})),i.d(e,"GreaterDepth",(function(){return q})),i.d(e,"GreaterEqualDepth",(function(){return W})),i.d(e,"GreaterEqualStencilFunc",(function(){return wi})),i.d(e,"GreaterStencilFunc",(function(){return xi})),i.d(e,"GridHelper",(function(){return Id})),i.d(e,"Group",(function(){return Ps})),i.d(e,"HalfFloatType",(function(){return It})),i.d(e,"HemisphereLight",(function(){return Jh})),i.d(e,"HemisphereLightHelper",(function(){return Ld})),i.d(e,"HemisphereLightProbe",(function(){return Cu})),i.d(e,"IcosahedronBufferGeometry",(function(){return Pc})),i.d(e,"IcosahedronGeometry",(function(){return Pc})),i.d(e,"ImageBitmapLoader",(function(){return vu})),i.d(e,"ImageLoader",(function(){return Mh})),i.d(e,"ImageUtils",(function(){return Ui})),i.d(e,"ImmediateRenderObject",(function(){return vd})),i.d(e,"IncrementStencilOp",(function(){return ui})),i.d(e,"IncrementWrapStencilOp",(function(){return pi})),i.d(e,"InstancedBufferAttribute",(function(){return pu})),i.d(e,"InstancedBufferGeometry",(function(){return du})),i.d(e,"InstancedInterleavedBuffer",(function(){return sd})),i.d(e,"InstancedMesh",(function(){return xl})),i.d(e,"Int16Attribute",(function(){return Vp})),i.d(e,"Int16BufferAttribute",(function(){return Pr})),i.d(e,"Int32Attribute",(function(){return Zp})),i.d(e,"Int32BufferAttribute",(function(){return Ir})),i.d(e,"Int8Attribute",(function(){return jp})),i.d(e,"Int8BufferAttribute",(function(){return Er})),i.d(e,"IntType",(function(){return At})),i.d(e,"InterleavedBuffer",(function(){return Fs})),i.d(e,"InterleavedBufferAttribute",(function(){return js})),i.d(e,"Interpolant",(function(){return eh})),i.d(e,"InterpolateDiscrete",(function(){return Ne})),i.d(e,"InterpolateLinear",(function(){return je})),i.d(e,"InterpolateSmooth",(function(){return Ge})),i.d(e,"InvertStencilOp",(function(){return mi})),i.d(e,"JSONLoader",(function(){return lf})),i.d(e,"KeepStencilOp",(function(){return ci})),i.d(e,"KeyframeTrack",(function(){return oh})),i.d(e,"LOD",(function(){return ol})),i.d(e,"LatheBufferGeometry",(function(){return Lc})),i.d(e,"LatheGeometry",(function(){return Lc})),i.d(e,"Layers",(function(){return zn})),i.d(e,"LensFlare",(function(){return hf})),i.d(e,"LessDepth",(function(){return V})),i.d(e,"LessEqualDepth",(function(){return H})),i.d(e,"LessEqualStencilFunc",(function(){return vi})),i.d(e,"LessStencilFunc",(function(){return yi})),i.d(e,"Light",(function(){return $h})),i.d(e,"LightProbe",(function(){return cu})),i.d(e,"Line",(function(){return Cl})),i.d(e,"Line3",(function(){return _d})),i.d(e,"LineBasicMaterial",(function(){return bl})),i.d(e,"LineCurve",(function(){return Gh})),i.d(e,"LineCurve3",(function(){return Uh})),i.d(e,"LineDashedMaterial",(function(){return Kc})),i.d(e,"LineLoop",(function(){return Il})),i.d(e,"LinePieces",(function(){return Ep})),i.d(e,"LineSegments",(function(){return Ll})),i.d(e,"LineStrip",(function(){return Sp})),i.d(e,"LinearEncoding",(function(){return $e})),i.d(e,"LinearFilter",(function(){return vt})),i.d(e,"LinearInterpolant",(function(){return nh})),i.d(e,"LinearMipMapLinearFilter",(function(){return Mt})),i.d(e,"LinearMipMapNearestFilter",(function(){return bt})),i.d(e,"LinearMipmapLinearFilter",(function(){return wt})),i.d(e,"LinearMipmapNearestFilter",(function(){return xt})),i.d(e,"LinearToneMapping",(function(){return Q})),i.d(e,"Loader",(function(){return _h})),i.d(e,"LoaderUtils",(function(){return uu})),i.d(e,"LoadingManager",(function(){return gh})),i.d(e,"LogLuvEncoding",(function(){return ti})),i.d(e,"LoopOnce",(function(){return ze})),i.d(e,"LoopPingPong",(function(){return Fe})),i.d(e,"LoopRepeat",(function(){return Be})),i.d(e,"LuminanceAlphaFormat",(function(){return jt})),i.d(e,"LuminanceFormat",(function(){return Nt})),i.d(e,"MOUSE",(function(){return r})),i.d(e,"Material",(function(){return br})),i.d(e,"MaterialLoader",(function(){return hu})),i.d(e,"Math",(function(){return Fi})),i.d(e,"MathUtils",(function(){return Fi})),i.d(e,"Matrix3",(function(){return ji})),i.d(e,"Matrix4",(function(){return Sn})),i.d(e,"MaxEquation",(function(){return P})),i.d(e,"Mesh",(function(){return ho})),i.d(e,"MeshBasicMaterial",(function(){return wr})),i.d(e,"MeshDepthMaterial",(function(){return ws})),i.d(e,"MeshDistanceMaterial",(function(){return Ms})),i.d(e,"MeshFaceMaterial",(function(){return Lp})),i.d(e,"MeshLambertMaterial",(function(){return $c})),i.d(e,"MeshMatcapMaterial",(function(){return Jc})),i.d(e,"MeshNormalMaterial",(function(){return Yc})),i.d(e,"MeshPhongMaterial",(function(){return qc})),i.d(e,"MeshPhysicalMaterial",(function(){return Wc})),i.d(e,"MeshStandardMaterial",(function(){return Zc})),i.d(e,"MeshToonMaterial",(function(){return Xc})),i.d(e,"MinEquation",(function(){return A})),i.d(e,"MirroredRepeatWrapping",(function(){return pt})),i.d(e,"MixOperation",(function(){return $})),i.d(e,"MultiMaterial",(function(){return Ip})),i.d(e,"MultiplyBlending",(function(){return M})),i.d(e,"MultiplyOperation",(function(){return Y})),i.d(e,"NearestFilter",(function(){return ft})),i.d(e,"NearestMipMapLinearFilter",(function(){return _t})),i.d(e,"NearestMipMapNearestFilter",(function(){return gt})),i.d(e,"NearestMipmapLinearFilter",(function(){return yt})),i.d(e,"NearestMipmapNearestFilter",(function(){return mt})),i.d(e,"NeverDepth",(function(){return G})),i.d(e,"NeverStencilFunc",(function(){return gi})),i.d(e,"NoBlending",(function(){return v})),i.d(e,"NoColors",(function(){return Cp})),i.d(e,"NoToneMapping",(function(){return K})),i.d(e,"NormalAnimationBlendMode",(function(){return Ze})),i.d(e,"NormalBlending",(function(){return x})),i.d(e,"NotEqualDepth",(function(){return X})),i.d(e,"NotEqualStencilFunc",(function(){return bi})),i.d(e,"NumberKeyframeTrack",(function(){return lh})),i.d(e,"Object3D",(function(){return $n})),i.d(e,"ObjectLoader",(function(){return mu})),i.d(e,"ObjectSpaceNormalMap",(function(){return si})),i.d(e,"OctahedronBufferGeometry",(function(){return Ic})),i.d(e,"OctahedronGeometry",(function(){return Ic})),i.d(e,"OneFactor",(function(){return I})),i.d(e,"OneMinusDstAlphaFactor",(function(){return B})),i.d(e,"OneMinusDstColorFactor",(function(){return N})),i.d(e,"OneMinusSrcAlphaFactor",(function(){return O})),i.d(e,"OneMinusSrcColorFactor",(function(){return D})),i.d(e,"OrthographicCamera",(function(){return nu})),i.d(e,"PCFShadowMap",(function(){return u})),i.d(e,"PCFSoftShadowMap",(function(){return d})),i.d(e,"PMREMGenerator",(function(){return mp})),i.d(e,"ParametricBufferGeometry",(function(){return Rc})),i.d(e,"ParametricGeometry",(function(){return Rc})),i.d(e,"Particle",(function(){return Dp})),i.d(e,"ParticleBasicMaterial",(function(){return zp})),i.d(e,"ParticleSystem",(function(){return kp})),i.d(e,"ParticleSystemMaterial",(function(){return Bp})),i.d(e,"Path",(function(){return Xh})),i.d(e,"PerspectiveCamera",(function(){return vo})),i.d(e,"Plane",(function(){return tr})),i.d(e,"PlaneBufferGeometry",(function(){return Po})),i.d(e,"PlaneGeometry",(function(){return Po})),i.d(e,"PlaneHelper",(function(){return Hd})),i.d(e,"PointCloud",(function(){return Rp})),i.d(e,"PointCloudMaterial",(function(){return Op})),i.d(e,"PointLight",(function(){return iu})),i.d(e,"PointLightHelper",(function(){return Ed})),i.d(e,"Points",(function(){return Bl})),i.d(e,"PointsMaterial",(function(){return Rl})),i.d(e,"PolarGridHelper",(function(){return Rd})),i.d(e,"PolyhedronBufferGeometry",(function(){return Wl})),i.d(e,"PolyhedronGeometry",(function(){return Wl})),i.d(e,"PositionalAudio",(function(){return Hu})),i.d(e,"PropertyBinding",(function(){return id})),i.d(e,"PropertyMixer",(function(){return Wu})),i.d(e,"QuadraticBezierCurve",(function(){return Vh})),i.d(e,"QuadraticBezierCurve3",(function(){return Hh})),i.d(e,"Quaternion",(function(){return Yi})),i.d(e,"QuaternionKeyframeTrack",(function(){return hh})),i.d(e,"QuaternionLinearInterpolant",(function(){return ch})),i.d(e,"REVISION",(function(){return n})),i.d(e,"RGBADepthPacking",(function(){return oi})),i.d(e,"RGBAFormat",(function(){return Ft})),i.d(e,"RGBAIntegerFormat",(function(){return Yt})),i.d(e,"RGBA_ASTC_10x10_Format",(function(){return _e})),i.d(e,"RGBA_ASTC_10x5_Format",(function(){return me})),i.d(e,"RGBA_ASTC_10x6_Format",(function(){return ge})),i.d(e,"RGBA_ASTC_10x8_Format",(function(){return ye})),i.d(e,"RGBA_ASTC_12x10_Format",(function(){return ve})),i.d(e,"RGBA_ASTC_12x12_Format",(function(){return xe})),i.d(e,"RGBA_ASTC_4x4_Format",(function(){return se})),i.d(e,"RGBA_ASTC_5x4_Format",(function(){return le})),i.d(e,"RGBA_ASTC_5x5_Format",(function(){return ce})),i.d(e,"RGBA_ASTC_6x5_Format",(function(){return he})),i.d(e,"RGBA_ASTC_6x6_Format",(function(){return ue})),i.d(e,"RGBA_ASTC_8x5_Format",(function(){return de})),i.d(e,"RGBA_ASTC_8x6_Format",(function(){return pe})),i.d(e,"RGBA_ASTC_8x8_Format",(function(){return fe})),i.d(e,"RGBA_BPTC_Format",(function(){return be})),i.d(e,"RGBA_ETC2_EAC_Format",(function(){return ae})),i.d(e,"RGBA_PVRTC_2BPPV1_Format",(function(){return ne})),i.d(e,"RGBA_PVRTC_4BPPV1_Format",(function(){return ie})),i.d(e,"RGBA_S3TC_DXT1_Format",(function(){return Jt})),i.d(e,"RGBA_S3TC_DXT3_Format",(function(){return Kt})),i.d(e,"RGBA_S3TC_DXT5_Format",(function(){return Qt})),i.d(e,"RGBDEncoding",(function(){return ni})),i.d(e,"RGBEEncoding",(function(){return Qe})),i.d(e,"RGBEFormat",(function(){return Gt})),i.d(e,"RGBFormat",(function(){return Bt})),i.d(e,"RGBIntegerFormat",(function(){return Xt})),i.d(e,"RGBM16Encoding",(function(){return ii})),i.d(e,"RGBM7Encoding",(function(){return ei})),i.d(e,"RGB_ETC1_Format",(function(){return re})),i.d(e,"RGB_ETC2_Format",(function(){return oe})),i.d(e,"RGB_PVRTC_2BPPV1_Format",(function(){return ee})),i.d(e,"RGB_PVRTC_4BPPV1_Format",(function(){return te})),i.d(e,"RGB_S3TC_DXT1_Format",(function(){return $t})),i.d(e,"RGFormat",(function(){return Wt})),i.d(e,"RGIntegerFormat",(function(){return qt})),i.d(e,"RawShaderMaterial",(function(){return Hc})),i.d(e,"Ray",(function(){return Tn})),i.d(e,"Raycaster",(function(){return cd})),i.d(e,"RectAreaLight",(function(){return su})),i.d(e,"RedFormat",(function(){return Ht})),i.d(e,"RedIntegerFormat",(function(){return Zt})),i.d(e,"ReinhardToneMapping",(function(){return tt})),i.d(e,"RepeatWrapping",(function(){return ut})),i.d(e,"ReplaceStencilOp",(function(){return hi})),i.d(e,"ReverseSubtractEquation",(function(){return C})),i.d(e,"RingBufferGeometry",(function(){return Dc})),i.d(e,"RingGeometry",(function(){return Dc})),i.d(e,"SRGB8_ALPHA8_ASTC_10x10_Format",(function(){return De})),i.d(e,"SRGB8_ALPHA8_ASTC_10x5_Format",(function(){return Le})),i.d(e,"SRGB8_ALPHA8_ASTC_10x6_Format",(function(){return Ie})),i.d(e,"SRGB8_ALPHA8_ASTC_10x8_Format",(function(){return Re})),i.d(e,"SRGB8_ALPHA8_ASTC_12x10_Format",(function(){return ke})),i.d(e,"SRGB8_ALPHA8_ASTC_12x12_Format",(function(){return Oe})),i.d(e,"SRGB8_ALPHA8_ASTC_4x4_Format",(function(){return we})),i.d(e,"SRGB8_ALPHA8_ASTC_5x4_Format",(function(){return Me})),i.d(e,"SRGB8_ALPHA8_ASTC_5x5_Format",(function(){return Te})),i.d(e,"SRGB8_ALPHA8_ASTC_6x5_Format",(function(){return Se})),i.d(e,"SRGB8_ALPHA8_ASTC_6x6_Format",(function(){return Ee})),i.d(e,"SRGB8_ALPHA8_ASTC_8x5_Format",(function(){return Ce})),i.d(e,"SRGB8_ALPHA8_ASTC_8x6_Format",(function(){return Ae})),i.d(e,"SRGB8_ALPHA8_ASTC_8x8_Format",(function(){return Pe})),i.d(e,"Scene",(function(){return Bs})),i.d(e,"SceneUtils",(function(){return cf})),i.d(e,"ShaderChunk",(function(){return Lo})),i.d(e,"ShaderLib",(function(){return Ro})),i.d(e,"ShaderMaterial",(function(){return yo})),i.d(e,"ShadowMaterial",(function(){return Vc})),i.d(e,"Shape",(function(){return Yh})),i.d(e,"ShapeBufferGeometry",(function(){return kc})),i.d(e,"ShapeGeometry",(function(){return kc})),i.d(e,"ShapePath",(function(){return xu})),i.d(e,"ShapeUtils",(function(){return Tc})),i.d(e,"ShortType",(function(){return Et})),i.d(e,"Skeleton",(function(){return ml})),i.d(e,"SkeletonHelper",(function(){return Sd})),i.d(e,"SkinnedMesh",(function(){return ul})),i.d(e,"SmoothShading",(function(){return _})),i.d(e,"Sphere",(function(){return gn})),i.d(e,"SphereBufferGeometry",(function(){return Oc})),i.d(e,"SphereGeometry",(function(){return Oc})),i.d(e,"Spherical",(function(){return dd})),i.d(e,"SphericalHarmonics3",(function(){return lu})),i.d(e,"Spline",(function(){return Jp})),i.d(e,"SplineCurve",(function(){return Zh})),i.d(e,"SplineCurve3",(function(){return $p})),i.d(e,"SpotLight",(function(){return tu})),i.d(e,"SpotLightHelper",(function(){return bd})),i.d(e,"Sprite",(function(){return el})),i.d(e,"SpriteMaterial",(function(){return Gs})),i.d(e,"SrcAlphaFactor",(function(){return k})),i.d(e,"SrcAlphaSaturateFactor",(function(){return j})),i.d(e,"SrcColorFactor",(function(){return R})),i.d(e,"StaticCopyUsage",(function(){return Li})),i.d(e,"StaticDrawUsage",(function(){return Ti})),i.d(e,"StaticReadUsage",(function(){return Ci})),i.d(e,"StereoCamera",(function(){return Iu})),i.d(e,"StreamCopyUsage",(function(){return Ri})),i.d(e,"StreamDrawUsage",(function(){return Ei})),i.d(e,"StreamReadUsage",(function(){return Pi})),i.d(e,"StringKeyframeTrack",(function(){return uh})),i.d(e,"SubtractEquation",(function(){return E})),i.d(e,"SubtractiveBlending",(function(){return w})),i.d(e,"TOUCH",(function(){return o})),i.d(e,"TangentSpaceNormalMap",(function(){return ai})),i.d(e,"TetrahedronBufferGeometry",(function(){return zc})),i.d(e,"TetrahedronGeometry",(function(){return zc})),i.d(e,"TextBufferGeometry",(function(){return Bc})),i.d(e,"TextGeometry",(function(){return Bc})),i.d(e,"Texture",(function(){return Hi})),i.d(e,"TextureLoader",(function(){return Eh})),i.d(e,"TorusBufferGeometry",(function(){return Fc})),i.d(e,"TorusGeometry",(function(){return Fc})),i.d(e,"TorusKnotBufferGeometry",(function(){return Nc})),i.d(e,"TorusKnotGeometry",(function(){return Nc})),i.d(e,"Triangle",(function(){return ur})),i.d(e,"TriangleFanDrawMode",(function(){return Ye})),i.d(e,"TriangleStripDrawMode",(function(){return Xe})),i.d(e,"TrianglesDrawMode",(function(){return qe})),i.d(e,"TubeBufferGeometry",(function(){return jc})),i.d(e,"TubeGeometry",(function(){return jc})),i.d(e,"UVMapping",(function(){return rt})),i.d(e,"Uint16Attribute",(function(){return Hp})),i.d(e,"Uint16BufferAttribute",(function(){return Lr})),i.d(e,"Uint32Attribute",(function(){return Wp})),i.d(e,"Uint32BufferAttribute",(function(){return Rr})),i.d(e,"Uint8Attribute",(function(){return Gp})),i.d(e,"Uint8BufferAttribute",(function(){return Cr})),i.d(e,"Uint8ClampedAttribute",(function(){return Up})),i.d(e,"Uint8ClampedBufferAttribute",(function(){return Ar})),i.d(e,"Uniform",(function(){return ad})),i.d(e,"UniformsLib",(function(){return Io})),i.d(e,"UniformsUtils",(function(){return go})),i.d(e,"UnsignedByteType",(function(){return Tt})),i.d(e,"UnsignedInt248Type",(function(){return Ot})),i.d(e,"UnsignedIntType",(function(){return Pt})),i.d(e,"UnsignedShort4444Type",(function(){return Rt})),i.d(e,"UnsignedShort5551Type",(function(){return Dt})),i.d(e,"UnsignedShort565Type",(function(){return kt})),i.d(e,"UnsignedShortType",(function(){return Ct})),i.d(e,"VSMShadowMap",(function(){return p})),i.d(e,"Vector2",(function(){return Ni})),i.d(e,"Vector3",(function(){return $i})),i.d(e,"Vector4",(function(){return Wi})),i.d(e,"VectorKeyframeTrack",(function(){return dh})),i.d(e,"Vertex",(function(){return Fp})),i.d(e,"VertexColors",(function(){return Pp})),i.d(e,"VideoTexture",(function(){return Nl})),i.d(e,"WebGL1Renderer",(function(){return ks})),i.d(e,"WebGLCubeRenderTarget",(function(){return wo})),i.d(e,"WebGLMultisampleRenderTarget",(function(){return Xi})),i.d(e,"WebGLRenderTarget",(function(){return qi})),i.d(e,"WebGLRenderTargetCube",(function(){return of})),i.d(e,"WebGLRenderer",(function(){return Ds})),i.d(e,"WebGLUtils",(function(){return Cs})),i.d(e,"WireframeGeometry",(function(){return Gc})),i.d(e,"WireframeHelper",(function(){return ef})),i.d(e,"WrapAroundEnding",(function(){return He})),i.d(e,"XHRLoader",(function(){return nf})),i.d(e,"ZeroCurvatureEnding",(function(){return Ue})),i.d(e,"ZeroFactor",(function(){return L})),i.d(e,"ZeroSlopeEnding",(function(){return Ve})),i.d(e,"ZeroStencilOp",(function(){return li})),i.d(e,"sRGBEncoding",(function(){return Je}));const n="125",r={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},o={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},a=0,s=1,l=2,c=3,h=0,u=1,d=2,p=3,f=0,m=1,g=2,y=1,_=2,v=0,x=1,b=2,w=3,M=4,T=5,S=100,E=101,C=102,A=103,P=104,L=200,I=201,R=202,D=203,k=204,O=205,z=206,B=207,F=208,N=209,j=210,G=0,U=1,V=2,H=3,Z=4,W=5,q=6,X=7,Y=0,$=1,J=2,K=0,Q=1,tt=2,et=3,it=4,nt=5,rt=300,ot=301,at=302,st=303,lt=304,ct=306,ht=307,ut=1e3,dt=1001,pt=1002,ft=1003,mt=1004,gt=1004,yt=1005,_t=1005,vt=1006,xt=1007,bt=1007,wt=1008,Mt=1008,Tt=1009,St=1010,Et=1011,Ct=1012,At=1013,Pt=1014,Lt=1015,It=1016,Rt=1017,Dt=1018,kt=1019,Ot=1020,zt=1021,Bt=1022,Ft=1023,Nt=1024,jt=1025,Gt=Ft,Ut=1026,Vt=1027,Ht=1028,Zt=1029,Wt=1030,qt=1031,Xt=1032,Yt=1033,$t=33776,Jt=33777,Kt=33778,Qt=33779,te=35840,ee=35841,ie=35842,ne=35843,re=36196,oe=37492,ae=37496,se=37808,le=37809,ce=37810,he=37811,ue=37812,de=37813,pe=37814,fe=37815,me=37816,ge=37817,ye=37818,_e=37819,ve=37820,xe=37821,be=36492,we=37840,Me=37841,Te=37842,Se=37843,Ee=37844,Ce=37845,Ae=37846,Pe=37847,Le=37848,Ie=37849,Re=37850,De=37851,ke=37852,Oe=37853,ze=2200,Be=2201,Fe=2202,Ne=2300,je=2301,Ge=2302,Ue=2400,Ve=2401,He=2402,Ze=2500,We=2501,qe=0,Xe=1,Ye=2,$e=3e3,Je=3001,Ke=3007,Qe=3002,ti=3003,ei=3004,ii=3005,ni=3006,ri=3200,oi=3201,ai=0,si=1,li=0,ci=7680,hi=7681,ui=7682,di=7683,pi=34055,fi=34056,mi=5386,gi=512,yi=513,_i=514,vi=515,xi=516,bi=517,wi=518,Mi=519,Ti=35044,Si=35048,Ei=35040,Ci=35045,Ai=35049,Pi=35041,Li=35046,Ii=35050,Ri=35042,Di="100",ki="300 es";function Oi(){}Object.assign(Oi.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},removeEventListener:function(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}},dispatchEvent:function(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,n=i.length;e<n;e++)i[e].call(this,t)}}});const zi=[];for(let t=0;t<256;t++)zi[t]=(t<16?"0":"")+t.toString(16);let Bi=1234567;const Fi={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(zi[255&t]+zi[t>>8&255]+zi[t>>16&255]+zi[t>>24&255]+"-"+zi[255&e]+zi[e>>8&255]+"-"+zi[e>>16&15|64]+zi[e>>24&255]+"-"+zi[63&i|128]+zi[i>>8&255]+"-"+zi[i>>16&255]+zi[i>>24&255]+zi[255&n]+zi[n>>8&255]+zi[n>>16&255]+zi[n>>24&255]).toUpperCase()},clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,i,n,r){return n+(t-e)*(r-n)/(i-e)},lerp:function(t,e,i){return(1-i)*t+i*e},damp:function(t,e,i,n){return Fi.lerp(t,e,1-Math.exp(-i*n))},pingpong:function(t,e=1){return e-Math.abs(Fi.euclideanModulo(t,2*e)-e)},smoothstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*(3-2*t)},smootherstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){return void 0!==t&&(Bi=t%2147483647),Bi=16807*Bi%2147483647,(Bi-1)/2147483646},degToRad:function(t){return t*Fi.DEG2RAD},radToDeg:function(t){return t*Fi.RAD2DEG},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,i,n,r){const o=Math.cos,a=Math.sin,s=o(i/2),l=a(i/2),c=o((e+n)/2),h=a((e+n)/2),u=o((e-n)/2),d=a((e-n)/2),p=o((n-e)/2),f=a((n-e)/2);switch(r){case"XYX":t.set(s*h,l*u,l*d,s*c);break;case"YZY":t.set(l*d,s*h,l*u,s*c);break;case"ZXZ":t.set(l*u,l*d,s*h,s*c);break;case"XZX":t.set(s*h,l*f,l*p,s*c);break;case"YXY":t.set(l*p,s*h,l*f,s*c);break;case"ZYZ":t.set(l*f,l*p,s*h,s*c);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}}};class Ni{constructor(t=0,e=0){Object.defineProperty(this,"isVector2",{value:!0}),this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this)}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this)}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,i=this.y,n=t.elements;return this.x=n[0]*e+n[3]*i+n[6],this.y=n[1]*e+n[4]*i+n[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const i=Math.cos(e),n=Math.sin(e),r=this.x-t.x,o=this.y-t.y;return this.x=r*i-o*n+t.x,this.y=r*n+o*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}}class ji{constructor(){Object.defineProperty(this,"isMatrix3",{value:!0}),this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,n,r,o,a,s,l){const c=this.elements;return c[0]=t,c[1]=n,c[2]=a,c[3]=e,c[4]=r,c[5]=s,c[6]=i,c[7]=o,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}clone(){return(new this.constructor).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,o=i[0],a=i[3],s=i[6],l=i[1],c=i[4],h=i[7],u=i[2],d=i[5],p=i[8],f=n[0],m=n[3],g=n[6],y=n[1],_=n[4],v=n[7],x=n[2],b=n[5],w=n[8];return r[0]=o*f+a*y+s*x,r[3]=o*m+a*_+s*b,r[6]=o*g+a*v+s*w,r[1]=l*f+c*y+h*x,r[4]=l*m+c*_+h*b,r[7]=l*g+c*v+h*w,r[2]=u*f+d*y+p*x,r[5]=u*m+d*_+p*b,r[8]=u*g+d*v+p*w,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],o=t[4],a=t[5],s=t[6],l=t[7],c=t[8];return e*o*c-e*a*l-i*r*c+i*a*s+n*r*l-n*o*s}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],o=t[4],a=t[5],s=t[6],l=t[7],c=t[8],h=c*o-a*l,u=a*s-c*r,d=l*r-o*s,p=e*h+i*u+n*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const f=1/p;return t[0]=h*f,t[1]=(n*l-c*i)*f,t[2]=(a*i-n*o)*f,t[3]=u*f,t[4]=(c*e-n*s)*f,t[5]=(n*r-a*e)*f,t[6]=d*f,t[7]=(i*s-l*e)*f,t[8]=(o*e-i*r)*f,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).copy(this).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,n,r,o,a){const s=Math.cos(r),l=Math.sin(r);return this.set(i*s,i*l,-i*(s*o+l*a)+o+t,-n*l,n*s,-n*(-l*o+s*a)+a+e,0,0,1),this}scale(t,e){const i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=e,i[4]*=e,i[7]*=e,this}rotate(t){const e=Math.cos(t),i=Math.sin(t),n=this.elements,r=n[0],o=n[3],a=n[6],s=n[1],l=n[4],c=n[7];return n[0]=e*r+i*s,n[3]=e*o+i*l,n[6]=e*a+i*c,n[1]=-i*r+e*s,n[4]=-i*o+e*l,n[7]=-i*a+e*c,this}translate(t,e){const i=this.elements;return i[0]+=t*i[2],i[3]+=t*i[5],i[6]+=t*i[8],i[1]+=e*i[2],i[4]+=e*i[5],i[7]+=e*i[8],this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<9;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<9;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}}let Gi;const Ui={getDataURL:function(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===Gi&&(Gi=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),Gi.width=t.width,Gi.height=t.height;const i=Gi.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),e=Gi}return e.width>2048||e.height>2048?e.toDataURL("image/jpeg",.6):e.toDataURL("image/png")}};let Vi=0;function Hi(t=Hi.DEFAULT_IMAGE,e=Hi.DEFAULT_MAPPING,i=dt,n=dt,r=vt,o=wt,a=Ft,s=Tt,l=1,c=$e){Object.defineProperty(this,"id",{value:Vi++}),this.uuid=Fi.generateUUID(),this.name="",this.image=t,this.mipmaps=[],this.mapping=e,this.wrapS=i,this.wrapT=n,this.magFilter=r,this.minFilter=o,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=s,this.offset=new Ni(0,0),this.repeat=new Ni(1,1),this.center=new Ni(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new ji,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=c,this.version=0,this.onUpdate=null}function Zi(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?Ui.getDataURL(t):t.data?{data:Array.prototype.slice.call(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}Hi.DEFAULT_IMAGE=void 0,Hi.DEFAULT_MAPPING=rt,Hi.prototype=Object.assign(Object.create(Oi.prototype),{constructor:Hi,isTexture:!0,updateMatrix:function(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.name=t.name,this.image=t.image,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.encoding=t.encoding,this},toJSON:function(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){const n=this.image;if(void 0===n.uuid&&(n.uuid=Fi.generateUUID()),!e&&void 0===t.images[n.uuid]){let e;if(Array.isArray(n)){e=[];for(let t=0,i=n.length;t<i;t++)n[t].isDataTexture?e.push(Zi(n[t].image)):e.push(Zi(n[t]))}else e=Zi(n);t.images[n.uuid]={uuid:n.uuid,url:e}}i.image=n.uuid}return e||(t.textures[this.uuid]=i),i},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(t){if(this.mapping!==rt)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case ut:t.x=t.x-Math.floor(t.x);break;case dt:t.x=t.x<0?0:1;break;case pt:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case ut:t.y=t.y-Math.floor(t.y);break;case dt:t.y=t.y<0?0:1;break;case pt:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}}),Object.defineProperty(Hi.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}});class Wi{constructor(t=0,e=0,i=0,n=1){Object.defineProperty(this,"isVector4",{value:!0}),this.x=t,this.y=e,this.z=i,this.w=n}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=this.w,o=t.elements;return this.x=o[0]*e+o[4]*i+o[8]*n+o[12]*r,this.y=o[1]*e+o[5]*i+o[9]*n+o[13]*r,this.z=o[2]*e+o[6]*i+o[10]*n+o[14]*r,this.w=o[3]*e+o[7]*i+o[11]*n+o[15]*r,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,i,n,r;const o=t.elements,a=o[0],s=o[4],l=o[8],c=o[1],h=o[5],u=o[9],d=o[2],p=o[6],f=o[10];if(Math.abs(s-c)<.01&&Math.abs(l-d)<.01&&Math.abs(u-p)<.01){if(Math.abs(s+c)<.1&&Math.abs(l+d)<.1&&Math.abs(u+p)<.1&&Math.abs(a+h+f-3)<.1)return this.set(1,0,0,0),this;e=Math.PI;const t=(a+1)/2,o=(h+1)/2,m=(f+1)/2,g=(s+c)/4,y=(l+d)/4,_=(u+p)/4;return t>o&&t>m?t<.01?(i=0,n=.707106781,r=.707106781):(i=Math.sqrt(t),n=g/i,r=y/i):o>m?o<.01?(i=.707106781,n=0,r=.707106781):(n=Math.sqrt(o),i=g/n,r=_/n):m<.01?(i=.707106781,n=.707106781,r=0):(r=Math.sqrt(m),i=y/r,n=_/r),this.set(i,n,r,e),this}let m=Math.sqrt((p-u)*(p-u)+(l-d)*(l-d)+(c-s)*(c-s));return Math.abs(m)<.001&&(m=1),this.x=(p-u)/m,this.y=(l-d)/m,this.z=(c-s)/m,this.w=Math.acos((a+h+f-1)/2),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this.w=t.w+(e.w-t.w)*i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}}class qi extends Oi{constructor(t,e,i){super(),Object.defineProperty(this,"isWebGLRenderTarget",{value:!0}),this.width=t,this.height=e,this.scissor=new Wi(0,0,t,e),this.scissorTest=!1,this.viewport=new Wi(0,0,t,e),i=i||{},this.texture=new Hi(void 0,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.image={},this.texture.image.width=t,this.texture.image.height=e,this.texture.generateMipmaps=void 0!==i.generateMipmaps&&i.generateMipmaps,this.texture.minFilter=void 0!==i.minFilter?i.minFilter:vt,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0!==i.stencilBuffer&&i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}setSize(t,e){this.width===t&&this.height===e||(this.width=t,this.height=e,this.texture.image.width=t,this.texture.image.height=e,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.width=t.width,this.height=t.height,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.depthTexture=t.depthTexture,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Xi extends qi{constructor(t,e,i){super(t,e,i),Object.defineProperty(this,"isWebGLMultisampleRenderTarget",{value:!0}),this.samples=4}copy(t){return super.copy.call(this,t),this.samples=t.samples,this}}class Yi{constructor(t=0,e=0,i=0,n=1){Object.defineProperty(this,"isQuaternion",{value:!0}),this._x=t,this._y=e,this._z=i,this._w=n}static slerp(t,e,i,n){return i.copy(t).slerp(e,n)}static slerpFlat(t,e,i,n,r,o,a){let s=i[n+0],l=i[n+1],c=i[n+2],h=i[n+3];const u=r[o+0],d=r[o+1],p=r[o+2],f=r[o+3];if(h!==f||s!==u||l!==d||c!==p){let t=1-a;const e=s*u+l*d+c*p+h*f,i=e>=0?1:-1,n=1-e*e;if(n>Number.EPSILON){const r=Math.sqrt(n),o=Math.atan2(r,e*i);t=Math.sin(t*o)/r,a=Math.sin(a*o)/r}const r=a*i;if(s=s*t+u*r,l=l*t+d*r,c=c*t+p*r,h=h*t+f*r,t===1-a){const t=1/Math.sqrt(s*s+l*l+c*c+h*h);s*=t,l*=t,c*=t,h*=t}}t[e]=s,t[e+1]=l,t[e+2]=c,t[e+3]=h}static multiplyQuaternionsFlat(t,e,i,n,r,o){const a=i[n],s=i[n+1],l=i[n+2],c=i[n+3],h=r[o],u=r[o+1],d=r[o+2],p=r[o+3];return t[e]=a*p+c*h+s*d-l*u,t[e+1]=s*p+c*u+l*h-a*d,t[e+2]=l*p+c*d+a*u-s*h,t[e+3]=c*p-a*h-s*u-l*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=t._x,n=t._y,r=t._z,o=t._order,a=Math.cos,s=Math.sin,l=a(i/2),c=a(n/2),h=a(r/2),u=s(i/2),d=s(n/2),p=s(r/2);switch(o){case"XYZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"YXZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"ZXY":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"ZYX":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"YZX":this._x=u*c*h+l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h-u*d*p;break;case"XZY":this._x=u*c*h-l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h+u*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+o)}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],n=e[4],r=e[8],o=e[1],a=e[5],s=e[9],l=e[2],c=e[6],h=e[10],u=i+a+h;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(c-s)*t,this._y=(r-l)*t,this._z=(o-n)*t}else if(i>a&&i>h){const t=2*Math.sqrt(1+i-a-h);this._w=(c-s)/t,this._x=.25*t,this._y=(n+o)/t,this._z=(r+l)/t}else if(a>h){const t=2*Math.sqrt(1+a-i-h);this._w=(r-l)/t,this._x=(n+o)/t,this._y=.25*t,this._z=(s+c)/t}else{const t=2*Math.sqrt(1+h-i-a);this._w=(o-n)/t,this._x=(r+l)/t,this._y=(s+c)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return i<1e-6?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(Fi.clamp(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const n=Math.min(1,e/i);return this.slerp(t,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const i=t._x,n=t._y,r=t._z,o=t._w,a=e._x,s=e._y,l=e._z,c=e._w;return this._x=i*c+o*a+n*l-r*s,this._y=n*c+o*s+r*a-i*l,this._z=r*c+o*l+i*s-n*a,this._w=o*c-i*a-n*s-r*l,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const i=this._x,n=this._y,r=this._z,o=this._w;let a=o*t._w+i*t._x+n*t._y+r*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=o,this._x=i,this._y=n,this._z=r,this;const s=1-a*a;if(s<=Number.EPSILON){const t=1-e;return this._w=t*o+e*this._w,this._x=t*i+e*this._x,this._y=t*n+e*this._y,this._z=t*r+e*this._z,this.normalize(),this._onChangeCallback(),this}const l=Math.sqrt(s),c=Math.atan2(l,a),h=Math.sin((1-e)*c)/l,u=Math.sin(e*c)/l;return this._w=o*h+this._w*u,this._x=i*h+this._x*u,this._y=n*h+this._y*u,this._z=r*h+this._z*u,this._onChangeCallback(),this}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}class $i{constructor(t=0,e=0,i=0){Object.defineProperty(this,"isVector3",{value:!0}),this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Ki.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(Ki.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[3]*i+r[6]*n,this.y=r[1]*e+r[4]*i+r[7]*n,this.z=r[2]*e+r[5]*i+r[8]*n,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=t.elements,o=1/(r[3]*e+r[7]*i+r[11]*n+r[15]);return this.x=(r[0]*e+r[4]*i+r[8]*n+r[12])*o,this.y=(r[1]*e+r[5]*i+r[9]*n+r[13])*o,this.z=(r[2]*e+r[6]*i+r[10]*n+r[14])*o,this}applyQuaternion(t){const e=this.x,i=this.y,n=this.z,r=t.x,o=t.y,a=t.z,s=t.w,l=s*e+o*n-a*i,c=s*i+a*e-r*n,h=s*n+r*i-o*e,u=-r*e-o*i-a*n;return this.x=l*s+u*-r+c*-a-h*-o,this.y=c*s+u*-o+h*-r-l*-a,this.z=h*s+u*-a+l*-o-c*-r,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[4]*i+r[8]*n,this.y=r[1]*e+r[5]*i+r[9]*n,this.z=r[2]*e+r[6]*i+r[10]*n,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,n=t.y,r=t.z,o=e.x,a=e.y,s=e.z;return this.x=n*s-r*a,this.y=r*o-i*s,this.z=i*a-n*o,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return Ji.copy(this).projectOnVector(t),this.sub(Ji)}reflect(t){return this.sub(Ji.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(Fi.clamp(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const n=Math.sin(e)*t;return this.x=n*Math.sin(i),this.y=Math.cos(e)*t,this.z=n*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}const Ji=new $i,Ki=new Yi;class Qi{constructor(t,e){Object.defineProperty(this,"isBox3",{value:!0}),this.min=void 0!==t?t:new $i(1/0,1/0,1/0),this.max=void 0!==e?e:new $i(-1/0,-1/0,-1/0)}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){let e=1/0,i=1/0,n=1/0,r=-1/0,o=-1/0,a=-1/0;for(let s=0,l=t.length;s<l;s+=3){const l=t[s],c=t[s+1],h=t[s+2];l<e&&(e=l),c<i&&(i=c),h<n&&(n=h),l>r&&(r=l),c>o&&(o=c),h>a&&(a=h)}return this.min.set(e,i,n),this.max.set(r,o,a),this}setFromBufferAttribute(t){let e=1/0,i=1/0,n=1/0,r=-1/0,o=-1/0,a=-1/0;for(let s=0,l=t.count;s<l;s++){const l=t.getX(s),c=t.getY(s),h=t.getZ(s);l<e&&(e=l),c<i&&(i=c),h<n&&(n=h),l>r&&(r=l),c>o&&(o=c),h>a&&(a=h)}return this.min.set(e,i,n),this.max.set(r,o,a),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=nn.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}setFromObject(t){return this.makeEmpty(),this.expandByObject(t)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return void 0===t&&(console.warn("THREE.Box3: .getCenter() target is now required"),t=new $i),this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return void 0===t&&(console.warn("THREE.Box3: .getSize() target is now required"),t=new $i),this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t){t.updateWorldMatrix(!1,!1);const e=t.geometry;void 0!==e&&(null===e.boundingBox&&e.computeBoundingBox(),rn.copy(e.boundingBox),rn.applyMatrix4(t.matrixWorld),this.union(rn));const i=t.children;for(let t=0,e=i.length;t<e;t++)this.expandByObject(i[t]);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return void 0===e&&(console.warn("THREE.Box3: .getParameter() target is now required"),e=new $i),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return this.clampPoint(t.center,nn),nn.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,i;return t.normal.x>0?(e=t.normal.x*this.min.x,i=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,i=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(un),dn.subVectors(this.max,un),on.subVectors(t.a,un),an.subVectors(t.b,un),sn.subVectors(t.c,un),ln.subVectors(an,on),cn.subVectors(sn,an),hn.subVectors(on,sn);let e=[0,-ln.z,ln.y,0,-cn.z,cn.y,0,-hn.z,hn.y,ln.z,0,-ln.x,cn.z,0,-cn.x,hn.z,0,-hn.x,-ln.y,ln.x,0,-cn.y,cn.x,0,-hn.y,hn.x,0];return!!tn(e,on,an,sn,dn)&&(e=[1,0,0,0,1,0,0,0,1],!!tn(e,on,an,sn,dn)&&(pn.crossVectors(ln,cn),e=[pn.x,pn.y,pn.z],tn(e,on,an,sn,dn)))}clampPoint(t,e){return void 0===e&&(console.warn("THREE.Box3: .clampPoint() target is now required"),e=new $i),e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return nn.copy(t).clamp(this.min,this.max).sub(t).length()}getBoundingSphere(t){return void 0===t&&console.error("THREE.Box3: .getBoundingSphere() target is now required"),this.getCenter(t.center),t.radius=.5*this.getSize(nn).length(),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(en[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),en[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),en[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),en[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),en[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),en[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),en[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),en[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(en)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}function tn(t,e,i,n,r){for(let o=0,a=t.length-3;o<=a;o+=3){fn.fromArray(t,o);const a=r.x*Math.abs(fn.x)+r.y*Math.abs(fn.y)+r.z*Math.abs(fn.z),s=e.dot(fn),l=i.dot(fn),c=n.dot(fn);if(Math.max(-Math.max(s,l,c),Math.min(s,l,c))>a)return!1}return!0}const en=[new $i,new $i,new $i,new $i,new $i,new $i,new $i,new $i],nn=new $i,rn=new Qi,on=new $i,an=new $i,sn=new $i,ln=new $i,cn=new $i,hn=new $i,un=new $i,dn=new $i,pn=new $i,fn=new $i,mn=new Qi;class gn{constructor(t,e){this.center=void 0!==t?t:new $i,this.radius=void 0!==e?e:-1}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const i=this.center;void 0!==e?i.copy(e):mn.setFromPoints(t).getCenter(i);let n=0;for(let e=0,r=t.length;e<r;e++)n=Math.max(n,i.distanceToSquared(t[e]));return this.radius=Math.sqrt(n),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const i=this.center.distanceToSquared(t);return void 0===e&&(console.warn("THREE.Sphere: .clampPoint() target is now required"),e=new $i),e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return void 0===t&&(console.warn("THREE.Sphere: .getBoundingBox() target is now required"),t=new Qi),this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}}const yn=new $i,_n=new $i,vn=new $i,xn=new $i,bn=new $i,wn=new $i,Mn=new $i;class Tn{constructor(t,e){this.origin=void 0!==t?t:new $i,this.direction=void 0!==e?e:new $i(0,0,-1)}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return void 0===e&&(console.warn("THREE.Ray: .at() target is now required"),e=new $i),e.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,yn)),this}closestPointToPoint(t,e){void 0===e&&(console.warn("THREE.Ray: .closestPointToPoint() target is now required"),e=new $i),e.subVectors(t,this.origin);const i=e.dot(this.direction);return i<0?e.copy(this.origin):e.copy(this.direction).multiplyScalar(i).add(this.origin)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=yn.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(yn.copy(this.direction).multiplyScalar(e).add(this.origin),yn.distanceToSquared(t))}distanceSqToSegment(t,e,i,n){_n.copy(t).add(e).multiplyScalar(.5),vn.copy(e).sub(t).normalize(),xn.copy(this.origin).sub(_n);const r=.5*t.distanceTo(e),o=-this.direction.dot(vn),a=xn.dot(this.direction),s=-xn.dot(vn),l=xn.lengthSq(),c=Math.abs(1-o*o);let h,u,d,p;if(c>0)if(h=o*s-a,u=o*a-s,p=r*c,h>=0)if(u>=-p)if(u<=p){const t=1/c;h*=t,u*=t,d=h*(h+o*u+2*a)+u*(o*h+u+2*s)+l}else u=r,h=Math.max(0,-(o*u+a)),d=-h*h+u*(u+2*s)+l;else u=-r,h=Math.max(0,-(o*u+a)),d=-h*h+u*(u+2*s)+l;else u<=-p?(h=Math.max(0,-(-o*r+a)),u=h>0?-r:Math.min(Math.max(-r,-s),r),d=-h*h+u*(u+2*s)+l):u<=p?(h=0,u=Math.min(Math.max(-r,-s),r),d=u*(u+2*s)+l):(h=Math.max(0,-(o*r+a)),u=h>0?r:Math.min(Math.max(-r,-s),r),d=-h*h+u*(u+2*s)+l);else u=o>0?-r:r,h=Math.max(0,-(o*u+a)),d=-h*h+u*(u+2*s)+l;return i&&i.copy(this.direction).multiplyScalar(h).add(this.origin),n&&n.copy(vn).multiplyScalar(u).add(_n),d}intersectSphere(t,e){yn.subVectors(t.center,this.origin);const i=yn.dot(this.direction),n=yn.dot(yn)-i*i,r=t.radius*t.radius;if(n>r)return null;const o=Math.sqrt(r-n),a=i-o,s=i+o;return a<0&&s<0?null:a<0?this.at(s,e):this.at(a,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(t.normal)+t.constant)/e;return i>=0?i:null}intersectPlane(t,e){const i=this.distanceToPlane(t);return null===i?null:this.at(i,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);if(0===e)return!0;return t.normal.dot(this.direction)*e<0}intersectBox(t,e){let i,n,r,o,a,s;const l=1/this.direction.x,c=1/this.direction.y,h=1/this.direction.z,u=this.origin;return l>=0?(i=(t.min.x-u.x)*l,n=(t.max.x-u.x)*l):(i=(t.max.x-u.x)*l,n=(t.min.x-u.x)*l),c>=0?(r=(t.min.y-u.y)*c,o=(t.max.y-u.y)*c):(r=(t.max.y-u.y)*c,o=(t.min.y-u.y)*c),i>o||r>n?null:((r>i||i!=i)&&(i=r),(o<n||n!=n)&&(n=o),h>=0?(a=(t.min.z-u.z)*h,s=(t.max.z-u.z)*h):(a=(t.max.z-u.z)*h,s=(t.min.z-u.z)*h),i>s||a>n?null:((a>i||i!=i)&&(i=a),(s<n||n!=n)&&(n=s),n<0?null:this.at(i>=0?i:n,e)))}intersectsBox(t){return null!==this.intersectBox(t,yn)}intersectTriangle(t,e,i,n,r){bn.subVectors(e,t),wn.subVectors(i,t),Mn.crossVectors(bn,wn);let o,a=this.direction.dot(Mn);if(a>0){if(n)return null;o=1}else{if(!(a<0))return null;o=-1,a=-a}xn.subVectors(this.origin,t);const s=o*this.direction.dot(wn.crossVectors(xn,wn));if(s<0)return null;const l=o*this.direction.dot(bn.cross(xn));if(l<0)return null;if(s+l>a)return null;const c=-o*xn.dot(Mn);return c<0?null:this.at(c/a,r)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}}class Sn{constructor(){Object.defineProperty(this,"isMatrix4",{value:!0}),this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,n,r,o,a,s,l,c,h,u,d,p,f,m){const g=this.elements;return g[0]=t,g[4]=e,g[8]=i,g[12]=n,g[1]=r,g[5]=o,g[9]=a,g[13]=s,g[2]=l,g[6]=c,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Sn).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,i=t.elements,n=1/En.setFromMatrixColumn(t,0).length(),r=1/En.setFromMatrixColumn(t,1).length(),o=1/En.setFromMatrixColumn(t,2).length();return e[0]=i[0]*n,e[1]=i[1]*n,e[2]=i[2]*n,e[3]=0,e[4]=i[4]*r,e[5]=i[5]*r,e[6]=i[6]*r,e[7]=0,e[8]=i[8]*o,e[9]=i[9]*o,e[10]=i[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const e=this.elements,i=t.x,n=t.y,r=t.z,o=Math.cos(i),a=Math.sin(i),s=Math.cos(n),l=Math.sin(n),c=Math.cos(r),h=Math.sin(r);if("XYZ"===t.order){const t=o*c,i=o*h,n=a*c,r=a*h;e[0]=s*c,e[4]=-s*h,e[8]=l,e[1]=i+n*l,e[5]=t-r*l,e[9]=-a*s,e[2]=r-t*l,e[6]=n+i*l,e[10]=o*s}else if("YXZ"===t.order){const t=s*c,i=s*h,n=l*c,r=l*h;e[0]=t+r*a,e[4]=n*a-i,e[8]=o*l,e[1]=o*h,e[5]=o*c,e[9]=-a,e[2]=i*a-n,e[6]=r+t*a,e[10]=o*s}else if("ZXY"===t.order){const t=s*c,i=s*h,n=l*c,r=l*h;e[0]=t-r*a,e[4]=-o*h,e[8]=n+i*a,e[1]=i+n*a,e[5]=o*c,e[9]=r-t*a,e[2]=-o*l,e[6]=a,e[10]=o*s}else if("ZYX"===t.order){const t=o*c,i=o*h,n=a*c,r=a*h;e[0]=s*c,e[4]=n*l-i,e[8]=t*l+r,e[1]=s*h,e[5]=r*l+t,e[9]=i*l-n,e[2]=-l,e[6]=a*s,e[10]=o*s}else if("YZX"===t.order){const t=o*s,i=o*l,n=a*s,r=a*l;e[0]=s*c,e[4]=r-t*h,e[8]=n*h+i,e[1]=h,e[5]=o*c,e[9]=-a*c,e[2]=-l*c,e[6]=i*h+n,e[10]=t-r*h}else if("XZY"===t.order){const t=o*s,i=o*l,n=a*s,r=a*l;e[0]=s*c,e[4]=-h,e[8]=l*c,e[1]=t*h+r,e[5]=o*c,e[9]=i*h-n,e[2]=n*h-i,e[6]=a*c,e[10]=r*h+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(An,t,Pn)}lookAt(t,e,i){const n=this.elements;return Rn.subVectors(t,e),0===Rn.lengthSq()&&(Rn.z=1),Rn.normalize(),Ln.crossVectors(i,Rn),0===Ln.lengthSq()&&(1===Math.abs(i.z)?Rn.x+=1e-4:Rn.z+=1e-4,Rn.normalize(),Ln.crossVectors(i,Rn)),Ln.normalize(),In.crossVectors(Rn,Ln),n[0]=Ln.x,n[4]=In.x,n[8]=Rn.x,n[1]=Ln.y,n[5]=In.y,n[9]=Rn.y,n[2]=Ln.z,n[6]=In.z,n[10]=Rn.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,o=i[0],a=i[4],s=i[8],l=i[12],c=i[1],h=i[5],u=i[9],d=i[13],p=i[2],f=i[6],m=i[10],g=i[14],y=i[3],_=i[7],v=i[11],x=i[15],b=n[0],w=n[4],M=n[8],T=n[12],S=n[1],E=n[5],C=n[9],A=n[13],P=n[2],L=n[6],I=n[10],R=n[14],D=n[3],k=n[7],O=n[11],z=n[15];return r[0]=o*b+a*S+s*P+l*D,r[4]=o*w+a*E+s*L+l*k,r[8]=o*M+a*C+s*I+l*O,r[12]=o*T+a*A+s*R+l*z,r[1]=c*b+h*S+u*P+d*D,r[5]=c*w+h*E+u*L+d*k,r[9]=c*M+h*C+u*I+d*O,r[13]=c*T+h*A+u*R+d*z,r[2]=p*b+f*S+m*P+g*D,r[6]=p*w+f*E+m*L+g*k,r[10]=p*M+f*C+m*I+g*O,r[14]=p*T+f*A+m*R+g*z,r[3]=y*b+_*S+v*P+x*D,r[7]=y*w+_*E+v*L+x*k,r[11]=y*M+_*C+v*I+x*O,r[15]=y*T+_*A+v*R+x*z,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[4],n=t[8],r=t[12],o=t[1],a=t[5],s=t[9],l=t[13],c=t[2],h=t[6],u=t[10],d=t[14];return t[3]*(+r*s*h-n*l*h-r*a*u+i*l*u+n*a*d-i*s*d)+t[7]*(+e*s*d-e*l*u+r*o*u-n*o*d+n*l*c-r*s*c)+t[11]*(+e*l*h-e*a*d-r*o*h+i*o*d+r*a*c-i*l*c)+t[15]*(-n*a*c-e*s*h+e*a*u+n*o*h-i*o*u+i*s*c)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){const n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=i),this}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],o=t[4],a=t[5],s=t[6],l=t[7],c=t[8],h=t[9],u=t[10],d=t[11],p=t[12],f=t[13],m=t[14],g=t[15],y=h*m*l-f*u*l+f*s*d-a*m*d-h*s*g+a*u*g,_=p*u*l-c*m*l-p*s*d+o*m*d+c*s*g-o*u*g,v=c*f*l-p*h*l+p*a*d-o*f*d-c*a*g+o*h*g,x=p*h*s-c*f*s-p*a*u+o*f*u+c*a*m-o*h*m,b=e*y+i*_+n*v+r*x;if(0===b)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/b;return t[0]=y*w,t[1]=(f*u*r-h*m*r-f*n*d+i*m*d+h*n*g-i*u*g)*w,t[2]=(a*m*r-f*s*r+f*n*l-i*m*l-a*n*g+i*s*g)*w,t[3]=(h*s*r-a*u*r-h*n*l+i*u*l+a*n*d-i*s*d)*w,t[4]=_*w,t[5]=(c*m*r-p*u*r+p*n*d-e*m*d-c*n*g+e*u*g)*w,t[6]=(p*s*r-o*m*r-p*n*l+e*m*l+o*n*g-e*s*g)*w,t[7]=(o*u*r-c*s*r+c*n*l-e*u*l-o*n*d+e*s*d)*w,t[8]=v*w,t[9]=(p*h*r-c*f*r-p*i*d+e*f*d+c*i*g-e*h*g)*w,t[10]=(o*f*r-p*a*r+p*i*l-e*f*l-o*i*g+e*a*g)*w,t[11]=(c*a*r-o*h*r-c*i*l+e*h*l+o*i*d-e*a*d)*w,t[12]=x*w,t[13]=(c*f*n-p*h*n+p*i*u-e*f*u-c*i*m+e*h*m)*w,t[14]=(p*a*n-o*f*n-p*i*s+e*f*s+o*i*m-e*a*m)*w,t[15]=(o*h*n-c*a*n+c*i*s-e*h*s-o*i*u+e*a*u)*w,this}scale(t){const e=this.elements,i=t.x,n=t.y,r=t.z;return e[0]*=i,e[4]*=n,e[8]*=r,e[1]*=i,e[5]*=n,e[9]*=r,e[2]*=i,e[6]*=n,e[10]*=r,e[3]*=i,e[7]*=n,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,n))}makeTranslation(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const i=Math.cos(e),n=Math.sin(e),r=1-i,o=t.x,a=t.y,s=t.z,l=r*o,c=r*a;return this.set(l*o+i,l*a-n*s,l*s+n*a,0,l*a+n*s,c*a+i,c*s-n*o,0,l*s-n*a,c*s+n*o,r*s*s+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i){return this.set(1,e,i,0,t,1,i,0,t,e,1,0,0,0,0,1),this}compose(t,e,i){const n=this.elements,r=e._x,o=e._y,a=e._z,s=e._w,l=r+r,c=o+o,h=a+a,u=r*l,d=r*c,p=r*h,f=o*c,m=o*h,g=a*h,y=s*l,_=s*c,v=s*h,x=i.x,b=i.y,w=i.z;return n[0]=(1-(f+g))*x,n[1]=(d+v)*x,n[2]=(p-_)*x,n[3]=0,n[4]=(d-v)*b,n[5]=(1-(u+g))*b,n[6]=(m+y)*b,n[7]=0,n[8]=(p+_)*w,n[9]=(m-y)*w,n[10]=(1-(u+f))*w,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this}decompose(t,e,i){const n=this.elements;let r=En.set(n[0],n[1],n[2]).length();const o=En.set(n[4],n[5],n[6]).length(),a=En.set(n[8],n[9],n[10]).length();this.determinant()<0&&(r=-r),t.x=n[12],t.y=n[13],t.z=n[14],Cn.copy(this);const s=1/r,l=1/o,c=1/a;return Cn.elements[0]*=s,Cn.elements[1]*=s,Cn.elements[2]*=s,Cn.elements[4]*=l,Cn.elements[5]*=l,Cn.elements[6]*=l,Cn.elements[8]*=c,Cn.elements[9]*=c,Cn.elements[10]*=c,e.setFromRotationMatrix(Cn),i.x=r,i.y=o,i.z=a,this}makePerspective(t,e,i,n,r,o){void 0===o&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const a=this.elements,s=2*r/(e-t),l=2*r/(i-n),c=(e+t)/(e-t),h=(i+n)/(i-n),u=-(o+r)/(o-r),d=-2*o*r/(o-r);return a[0]=s,a[4]=0,a[8]=c,a[12]=0,a[1]=0,a[5]=l,a[9]=h,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=d,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(t,e,i,n,r,o){const a=this.elements,s=1/(e-t),l=1/(i-n),c=1/(o-r),h=(e+t)*s,u=(i+n)*l,d=(o+r)*c;return a[0]=2*s,a[4]=0,a[8]=0,a[12]=-h,a[1]=0,a[5]=2*l,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2*c,a[14]=-d,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<16;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<16;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}const En=new $i,Cn=new Sn,An=new $i(0,0,0),Pn=new $i(1,1,1),Ln=new $i,In=new $i,Rn=new $i;class Dn{constructor(t=0,e=0,i=0,n=Dn.DefaultOrder){Object.defineProperty(this,"isEuler",{value:!0}),this._x=t,this._y=e,this._z=i,this._order=n}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._order=n||this._order,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e,i){const n=Fi.clamp,r=t.elements,o=r[0],a=r[4],s=r[8],l=r[1],c=r[5],h=r[9],u=r[2],d=r[6],p=r[10];switch(e=e||this._order){case"XYZ":this._y=Math.asin(n(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-a,o)):(this._x=Math.atan2(d,c),this._z=0);break;case"YXZ":this._x=Math.asin(-n(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(s,p),this._z=Math.atan2(l,c)):(this._y=Math.atan2(-u,o),this._z=0);break;case"ZXY":this._x=Math.asin(n(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-a,c)):(this._y=0,this._z=Math.atan2(l,o));break;case"ZYX":this._y=Math.asin(-n(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,p),this._z=Math.atan2(l,o)):(this._x=0,this._z=Math.atan2(-a,c));break;case"YZX":this._z=Math.asin(n(l,-1,1)),Math.abs(l)<.9999999?(this._x=Math.atan2(-h,c),this._y=Math.atan2(-u,o)):(this._x=0,this._y=Math.atan2(s,p));break;case"XZY":this._z=Math.asin(-n(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(d,c),this._y=Math.atan2(s,o)):(this._x=Math.atan2(-h,p),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!1!==i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return kn.makeRotationFromQuaternion(t),this.setFromRotationMatrix(kn,e,i)}setFromVector3(t,e){return this.set(t.x,t.y,t.z,e||this._order)}reorder(t){return On.setFromEuler(this),this.setFromQuaternion(On,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}toVector3(t){return t?t.set(this._x,this._y,this._z):new $i(this._x,this._y,this._z)}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}Dn.DefaultOrder="XYZ",Dn.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];const kn=new Sn,On=new Yi;class zn{constructor(){this.mask=1}set(t){this.mask=1<<t|0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}}let Bn=0;const Fn=new $i,Nn=new Yi,jn=new Sn,Gn=new $i,Un=new $i,Vn=new $i,Hn=new Yi,Zn=new $i(1,0,0),Wn=new $i(0,1,0),qn=new $i(0,0,1),Xn={type:"added"},Yn={type:"removed"};function $n(){Object.defineProperty(this,"id",{value:Bn++}),this.uuid=Fi.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=$n.DefaultUp.clone();const t=new $i,e=new Dn,i=new Yi,n=new $i(1,1,1);e._onChange((function(){i.setFromEuler(e,!1)})),i._onChange((function(){e.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new Sn},normalMatrix:{value:new ji}}),this.matrix=new Sn,this.matrixWorld=new Sn,this.matrixAutoUpdate=$n.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new zn,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}$n.DefaultUp=new $i(0,1,0),$n.DefaultMatrixAutoUpdate=!0,$n.prototype=Object.assign(Object.create(Oi.prototype),{constructor:$n,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(t){return this.quaternion.premultiply(t),this},setRotationFromAxisAngle:function(t,e){this.quaternion.setFromAxisAngle(t,e)},setRotationFromEuler:function(t){this.quaternion.setFromEuler(t,!0)},setRotationFromMatrix:function(t){this.quaternion.setFromRotationMatrix(t)},setRotationFromQuaternion:function(t){this.quaternion.copy(t)},rotateOnAxis:function(t,e){return Nn.setFromAxisAngle(t,e),this.quaternion.multiply(Nn),this},rotateOnWorldAxis:function(t,e){return Nn.setFromAxisAngle(t,e),this.quaternion.premultiply(Nn),this},rotateX:function(t){return this.rotateOnAxis(Zn,t)},rotateY:function(t){return this.rotateOnAxis(Wn,t)},rotateZ:function(t){return this.rotateOnAxis(qn,t)},translateOnAxis:function(t,e){return Fn.copy(t).applyQuaternion(this.quaternion),this.position.add(Fn.multiplyScalar(e)),this},translateX:function(t){return this.translateOnAxis(Zn,t)},translateY:function(t){return this.translateOnAxis(Wn,t)},translateZ:function(t){return this.translateOnAxis(qn,t)},localToWorld:function(t){return t.applyMatrix4(this.matrixWorld)},worldToLocal:function(t){return t.applyMatrix4(jn.copy(this.matrixWorld).invert())},lookAt:function(t,e,i){t.isVector3?Gn.copy(t):Gn.set(t,e,i);const n=this.parent;this.updateWorldMatrix(!0,!1),Un.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?jn.lookAt(Un,Gn,this.up):jn.lookAt(Gn,Un,this.up),this.quaternion.setFromRotationMatrix(jn),n&&(jn.extractRotation(n.matrixWorld),Nn.setFromRotationMatrix(jn),this.quaternion.premultiply(Nn.invert()))},add:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(Xn)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)},remove:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Yn)),this},clear:function(){for(let t=0;t<this.children.length;t++){const e=this.children[t];e.parent=null,e.dispatchEvent(Yn)}return this.children.length=0,this},attach:function(t){return this.updateWorldMatrix(!0,!1),jn.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),jn.multiply(t.parent.matrixWorld)),t.applyMatrix4(jn),t.updateWorldMatrix(!1,!1),this.add(t),this},getObjectById:function(t){return this.getObjectByProperty("id",t)},getObjectByName:function(t){return this.getObjectByProperty("name",t)},getObjectByProperty:function(t,e){if(this[t]===e)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(t,e);if(void 0!==n)return n}},getWorldPosition:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),t=new $i),this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),t=new Yi),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Un,t,Vn),t},getWorldScale:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),t=new $i),this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Un,Hn,t),t},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),t=new $i),this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()},raycast:function(){},traverse:function(t){t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverse(t)},traverseVisible:function(t){if(!1===this.visible)return;t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverseVisible(t)},traverseAncestors:function(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].updateMatrixWorld(t)},updateWorldMatrix:function(t,e){const i=this.parent;if(!0===t&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,i=t.length;e<i;e++)t[e].updateWorldMatrix(!1,!0)}},toJSON:function(t){const e=void 0===t||"string"==typeof t,i={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const n={};function r(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON()),this.isMesh||this.isLine||this.isPoints){n.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const i=e.shapes;if(Array.isArray(i))for(let e=0,n=i.length;e<n;e++){const n=i[e];r(t.shapes,n)}else r(t.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let i=0,n=this.material.length;i<n;i++)e.push(r(t.materials,this.material[i]));n.material=e}else n.material=r(t.materials,this.material);if(this.children.length>0){n.children=[];for(let e=0;e<this.children.length;e++)n.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){n.animations=[];for(let e=0;e<this.animations.length;e++){const i=this.animations[e];n.animations.push(r(t.animations,i))}}if(e){const e=o(t.geometries),n=o(t.materials),r=o(t.textures),a=o(t.images),s=o(t.shapes),l=o(t.skeletons),c=o(t.animations);e.length>0&&(i.geometries=e),n.length>0&&(i.materials=n),r.length>0&&(i.textures=r),a.length>0&&(i.images=a),s.length>0&&(i.shapes=s),l.length>0&&(i.skeletons=l),c.length>0&&(i.animations=c)}return i.object=n,i;function o(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}},clone:function(t){return(new this.constructor).copy(this,t)},copy:function(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const i=t.children[e];this.add(i.clone())}return this}});const Jn=new $i,Kn=new $i,Qn=new ji;class tr{constructor(t,e){Object.defineProperty(this,"isPlane",{value:!0}),this.normal=void 0!==t?t:new $i(1,0,0),this.constant=void 0!==e?e:0}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,i,n){return this.normal.set(t,e,i),this.constant=n,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){const n=Jn.subVectors(i,e).cross(Kn.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(n,t),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return void 0===e&&(console.warn("THREE.Plane: .projectPoint() target is now required"),e=new $i),e.copy(this.normal).multiplyScalar(-this.distanceToPoint(t)).add(t)}intersectLine(t,e){void 0===e&&(console.warn("THREE.Plane: .intersectLine() target is now required"),e=new $i);const i=t.delta(Jn),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(t.start)?e.copy(t.start):void 0;const r=-(t.start.dot(this.normal)+this.constant)/n;return r<0||r>1?void 0:e.copy(i).multiplyScalar(r).add(t.start)}intersectsLine(t){const e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return void 0===t&&(console.warn("THREE.Plane: .coplanarPoint() target is now required"),t=new $i),t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const i=e||Qn.getNormalMatrix(t),n=this.coplanarPoint(Jn).applyMatrix4(t),r=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(r),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}}const er=new $i,ir=new $i,nr=new $i,rr=new $i,or=new $i,ar=new $i,sr=new $i,lr=new $i,cr=new $i,hr=new $i;class ur{constructor(t,e,i){this.a=void 0!==t?t:new $i,this.b=void 0!==e?e:new $i,this.c=void 0!==i?i:new $i}static getNormal(t,e,i,n){void 0===n&&(console.warn("THREE.Triangle: .getNormal() target is now required"),n=new $i),n.subVectors(i,e),er.subVectors(t,e),n.cross(er);const r=n.lengthSq();return r>0?n.multiplyScalar(1/Math.sqrt(r)):n.set(0,0,0)}static getBarycoord(t,e,i,n,r){er.subVectors(n,e),ir.subVectors(i,e),nr.subVectors(t,e);const o=er.dot(er),a=er.dot(ir),s=er.dot(nr),l=ir.dot(ir),c=ir.dot(nr),h=o*l-a*a;if(void 0===r&&(console.warn("THREE.Triangle: .getBarycoord() target is now required"),r=new $i),0===h)return r.set(-2,-1,-1);const u=1/h,d=(l*s-a*c)*u,p=(o*c-a*s)*u;return r.set(1-d-p,p,d)}static containsPoint(t,e,i,n){return this.getBarycoord(t,e,i,n,rr),rr.x>=0&&rr.y>=0&&rr.x+rr.y<=1}static getUV(t,e,i,n,r,o,a,s){return this.getBarycoord(t,e,i,n,rr),s.set(0,0),s.addScaledVector(r,rr.x),s.addScaledVector(o,rr.y),s.addScaledVector(a,rr.z),s}static isFrontFacing(t,e,i,n){return er.subVectors(i,e),ir.subVectors(t,e),er.cross(ir).dot(n)<0}set(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this}setFromPointsAndIndices(t,e,i,n){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[n]),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return er.subVectors(this.c,this.b),ir.subVectors(this.a,this.b),.5*er.cross(ir).length()}getMidpoint(t){return void 0===t&&(console.warn("THREE.Triangle: .getMidpoint() target is now required"),t=new $i),t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return ur.getNormal(this.a,this.b,this.c,t)}getPlane(t){return void 0===t&&(console.warn("THREE.Triangle: .getPlane() target is now required"),t=new tr),t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return ur.getBarycoord(t,this.a,this.b,this.c,e)}getUV(t,e,i,n,r){return ur.getUV(t,this.a,this.b,this.c,e,i,n,r)}containsPoint(t){return ur.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return ur.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){void 0===e&&(console.warn("THREE.Triangle: .closestPointToPoint() target is now required"),e=new $i);const i=this.a,n=this.b,r=this.c;let o,a;or.subVectors(n,i),ar.subVectors(r,i),lr.subVectors(t,i);const s=or.dot(lr),l=ar.dot(lr);if(s<=0&&l<=0)return e.copy(i);cr.subVectors(t,n);const c=or.dot(cr),h=ar.dot(cr);if(c>=0&&h<=c)return e.copy(n);const u=s*h-c*l;if(u<=0&&s>=0&&c<=0)return o=s/(s-c),e.copy(i).addScaledVector(or,o);hr.subVectors(t,r);const d=or.dot(hr),p=ar.dot(hr);if(p>=0&&d<=p)return e.copy(r);const f=d*l-s*p;if(f<=0&&l>=0&&p<=0)return a=l/(l-p),e.copy(i).addScaledVector(ar,a);const m=c*p-d*h;if(m<=0&&h-c>=0&&d-p>=0)return sr.subVectors(r,n),a=(h-c)/(h-c+(d-p)),e.copy(n).addScaledVector(sr,a);const g=1/(m+f+u);return o=f*g,a=u*g,e.copy(i).addScaledVector(or,o).addScaledVector(ar,a)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const dr={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},pr={h:0,s:0,l:0},fr={h:0,s:0,l:0};function mr(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}function gr(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function yr(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}class _r{constructor(t,e,i){return Object.defineProperty(this,"isColor",{value:!0}),void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}set(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this}setRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}setHSL(t,e,i){if(t=Fi.euclideanModulo(t,1),e=Fi.clamp(e,0,1),i=Fi.clamp(i,0,1),0===e)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+e):i+e-i*e,r=2*i-n;this.r=mr(r,n,t+1/3),this.g=mr(r,n,t),this.b=mr(r,n,t-1/3)}return this}setStyle(t){function e(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(t)){let t;const n=i[1],r=i[2];switch(n){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,e(t[4]),this;if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,e(t[4]),this;break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r)){const i=parseFloat(t[1])/360,n=parseInt(t[2],10)/100,r=parseInt(t[3],10)/100;return e(t[4]),this.setHSL(i,n,r)}}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=i[1],e=t.length;if(3===e)return this.r=parseInt(t.charAt(0)+t.charAt(0),16)/255,this.g=parseInt(t.charAt(1)+t.charAt(1),16)/255,this.b=parseInt(t.charAt(2)+t.charAt(2),16)/255,this;if(6===e)return this.r=parseInt(t.charAt(0)+t.charAt(1),16)/255,this.g=parseInt(t.charAt(2)+t.charAt(3),16)/255,this.b=parseInt(t.charAt(4)+t.charAt(5),16)/255,this}return t&&t.length>0?this.setColorName(t):this}setColorName(t){const e=dr[t];return void 0!==e?this.setHex(e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copyGammaToLinear(t,e=2){return this.r=Math.pow(t.r,e),this.g=Math.pow(t.g,e),this.b=Math.pow(t.b,e),this}copyLinearToGamma(t,e=2){const i=e>0?1/e:1;return this.r=Math.pow(t.r,i),this.g=Math.pow(t.g,i),this.b=Math.pow(t.b,i),this}convertGammaToLinear(t){return this.copyGammaToLinear(this,t),this}convertLinearToGamma(t){return this.copyLinearToGamma(this,t),this}copySRGBToLinear(t){return this.r=gr(t.r),this.g=gr(t.g),this.b=gr(t.b),this}copyLinearToSRGB(t){return this.r=yr(t.r),this.g=yr(t.g),this.b=yr(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(t){void 0===t&&(console.warn("THREE.Color: .getHSL() target is now required"),t={h:0,s:0,l:0});const e=this.r,i=this.g,n=this.b,r=Math.max(e,i,n),o=Math.min(e,i,n);let a,s;const l=(o+r)/2;if(o===r)a=0,s=0;else{const t=r-o;switch(s=l<=.5?t/(r+o):t/(2-r-o),r){case e:a=(i-n)/t+(i<n?6:0);break;case i:a=(n-e)/t+2;break;case n:a=(e-i)/t+4}a/=6}return t.h=a,t.s=s,t.l=l,t}getStyle(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"}offsetHSL(t,e,i){return this.getHSL(pr),pr.h+=t,pr.s+=e,pr.l+=i,this.setHSL(pr.h,pr.s,pr.l),this}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,i){return this.r=t.r+(e.r-t.r)*i,this.g=t.g+(e.g-t.g)*i,this.b=t.b+(e.b-t.b)*i,this}lerpHSL(t,e){this.getHSL(pr),t.getHSL(fr);const i=Fi.lerp(pr.h,fr.h,e),n=Fi.lerp(pr.s,fr.s,e),r=Fi.lerp(pr.l,fr.l,e);return this.setHSL(i,n,r),this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),!0===t.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}_r.NAMES=dr,_r.prototype.r=1,_r.prototype.g=1,_r.prototype.b=1;class vr{constructor(t,e,i,n,r,o=0){this.a=t,this.b=e,this.c=i,this.normal=n&&n.isVector3?n:new $i,this.vertexNormals=Array.isArray(n)?n:[],this.color=r&&r.isColor?r:new _r,this.vertexColors=Array.isArray(r)?r:[],this.materialIndex=o}clone(){return(new this.constructor).copy(this)}copy(t){this.a=t.a,this.b=t.b,this.c=t.c,this.normal.copy(t.normal),this.color.copy(t.color),this.materialIndex=t.materialIndex;for(let e=0,i=t.vertexNormals.length;e<i;e++)this.vertexNormals[e]=t.vertexNormals[e].clone();for(let e=0,i=t.vertexColors.length;e<i;e++)this.vertexColors[e]=t.vertexColors[e].clone();return this}}let xr=0;function br(){Object.defineProperty(this,"id",{value:xr++}),this.uuid=Fi.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.blending=x,this.side=f,this.flatShading=!1,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=k,this.blendDst=O,this.blendEquation=S,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=H,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=Mi,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=ci,this.stencilZFail=ci,this.stencilZPass=ci,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0}function wr(t){br.call(this),this.type="MeshBasicMaterial",this.color=new _r(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Y,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.setValues(t)}br.prototype=Object.assign(Object.create(Oi.prototype),{constructor:br,isMaterial:!0,onBeforeCompile:function(){},customProgramCacheKey:function(){return this.onBeforeCompile.toString()},setValues:function(t){if(void 0!==t)for(const e in t){const i=t[e];if(void 0===i){console.warn("THREE.Material: '"+e+"' parameter is undefined.");continue}if("shading"===e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=i===y;continue}const n=this[e];void 0!==n?n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[e]=i:console.warn("THREE."+this.type+": '"+e+"' is not a property of this material.")}},toJSON:function(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function n(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),this.sheen&&this.sheen.isColor&&(i.sheen=this.sheen.getHex()),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,i.reflectivity=this.reflectivity,i.refractionRatio=this.refractionRatio,void 0!==this.combine&&(i.combine=this.combine),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity)),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.size&&(i.size=this.size),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),this.blending!==x&&(i.blending=this.blending),!0===this.flatShading&&(i.flatShading=this.flatShading),this.side!==f&&(i.side=this.side),this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,i.stencilWrite=this.stencilWrite,i.stencilWriteMask=this.stencilWriteMask,i.stencilFunc=this.stencilFunc,i.stencilRef=this.stencilRef,i.stencilFuncMask=this.stencilFuncMask,i.stencilFail=this.stencilFail,i.stencilZFail=this.stencilZFail,i.stencilZPass=this.stencilZPass,this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(i.morphTargets=!0),!0===this.morphNormals&&(i.morphNormals=!0),!0===this.skinning&&(i.skinning=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),e){const e=n(t.textures),r=n(t.images);e.length>0&&(i.textures=e),r.length>0&&(i.images=r)}return i},clone:function(){return(new this.constructor).copy(this)},copy:function(t){this.name=t.name,this.fog=t.fog,this.blending=t.blending,this.side=t.side,this.flatShading=t.flatShading,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let i=null;if(null!==e){const t=e.length;i=new Array(t);for(let n=0;n!==t;++n)i[n]=e[n].clone()}return this.clippingPlanes=i,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.premultipliedAlpha=t.premultipliedAlpha,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(br.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),wr.prototype=Object.create(br.prototype),wr.prototype.constructor=wr,wr.prototype.isMeshBasicMaterial=!0,wr.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this};const Mr=new $i,Tr=new Ni;function Sr(t,e,i){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=!0===i,this.usage=Ti,this.updateRange={offset:0,count:-1},this.version=0}function Er(t,e,i){Sr.call(this,new Int8Array(t),e,i)}function Cr(t,e,i){Sr.call(this,new Uint8Array(t),e,i)}function Ar(t,e,i){Sr.call(this,new Uint8ClampedArray(t),e,i)}function Pr(t,e,i){Sr.call(this,new Int16Array(t),e,i)}function Lr(t,e,i){Sr.call(this,new Uint16Array(t),e,i)}function Ir(t,e,i){Sr.call(this,new Int32Array(t),e,i)}function Rr(t,e,i){Sr.call(this,new Uint32Array(t),e,i)}function Dr(t,e,i){Sr.call(this,new Uint16Array(t),e,i)}function kr(t,e,i){Sr.call(this,new Float32Array(t),e,i)}function Or(t,e,i){Sr.call(this,new Float64Array(t),e,i)}function zr(t){if(0===t.length)return-1/0;let e=t[0];for(let i=1,n=t.length;i<n;++i)t[i]>e&&(e=t[i]);return e}Object.defineProperty(Sr.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(Sr.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setUsage:function(t){return this.usage=t,this},copy:function(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this},copyAt:function(t,e,i){t*=this.itemSize,i*=e.itemSize;for(let n=0,r=this.itemSize;n<r;n++)this.array[t+n]=e.array[i+n];return this},copyArray:function(t){return this.array.set(t),this},copyColorsArray:function(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),r=new _r),e[i++]=r.r,e[i++]=r.g,e[i++]=r.b}return this},copyVector2sArray:function(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",n),r=new Ni),e[i++]=r.x,e[i++]=r.y}return this},copyVector3sArray:function(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),r=new $i),e[i++]=r.x,e[i++]=r.y,e[i++]=r.z}return this},copyVector4sArray:function(t){const e=this.array;let i=0;for(let n=0,r=t.length;n<r;n++){let r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),r=new Wi),e[i++]=r.x,e[i++]=r.y,e[i++]=r.z,e[i++]=r.w}return this},applyMatrix3:function(t){if(2===this.itemSize)for(let e=0,i=this.count;e<i;e++)Tr.fromBufferAttribute(this,e),Tr.applyMatrix3(t),this.setXY(e,Tr.x,Tr.y);else if(3===this.itemSize)for(let e=0,i=this.count;e<i;e++)Mr.fromBufferAttribute(this,e),Mr.applyMatrix3(t),this.setXYZ(e,Mr.x,Mr.y,Mr.z);return this},applyMatrix4:function(t){for(let e=0,i=this.count;e<i;e++)Mr.x=this.getX(e),Mr.y=this.getY(e),Mr.z=this.getZ(e),Mr.applyMatrix4(t),this.setXYZ(e,Mr.x,Mr.y,Mr.z);return this},applyNormalMatrix:function(t){for(let e=0,i=this.count;e<i;e++)Mr.x=this.getX(e),Mr.y=this.getY(e),Mr.z=this.getZ(e),Mr.applyNormalMatrix(t),this.setXYZ(e,Mr.x,Mr.y,Mr.z);return this},transformDirection:function(t){for(let e=0,i=this.count;e<i;e++)Mr.x=this.getX(e),Mr.y=this.getY(e),Mr.z=this.getZ(e),Mr.transformDirection(t),this.setXYZ(e,Mr.x,Mr.y,Mr.z);return this},set:function(t,e=0){return this.array.set(t,e),this},getX:function(t){return this.array[t*this.itemSize]},setX:function(t,e){return this.array[t*this.itemSize]=e,this},getY:function(t){return this.array[t*this.itemSize+1]},setY:function(t,e){return this.array[t*this.itemSize+1]=e,this},getZ:function(t){return this.array[t*this.itemSize+2]},setZ:function(t,e){return this.array[t*this.itemSize+2]=e,this},getW:function(t){return this.array[t*this.itemSize+3]},setW:function(t,e){return this.array[t*this.itemSize+3]=e,this},setXY:function(t,e,i){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this},setXYZ:function(t,e,i,n){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this},setXYZW:function(t,e,i,n,r){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this.array[t+3]=r,this},onUpload:function(t){return this.onUploadCallback=t,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)},toJSON:function(){return{itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized}}}),Er.prototype=Object.create(Sr.prototype),Er.prototype.constructor=Er,Cr.prototype=Object.create(Sr.prototype),Cr.prototype.constructor=Cr,Ar.prototype=Object.create(Sr.prototype),Ar.prototype.constructor=Ar,Pr.prototype=Object.create(Sr.prototype),Pr.prototype.constructor=Pr,Lr.prototype=Object.create(Sr.prototype),Lr.prototype.constructor=Lr,Ir.prototype=Object.create(Sr.prototype),Ir.prototype.constructor=Ir,Rr.prototype=Object.create(Sr.prototype),Rr.prototype.constructor=Rr,Dr.prototype=Object.create(Sr.prototype),Dr.prototype.constructor=Dr,Dr.prototype.isFloat16BufferAttribute=!0,kr.prototype=Object.create(Sr.prototype),kr.prototype.constructor=kr,Or.prototype=Object.create(Sr.prototype),Or.prototype.constructor=Or;const Br={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:"undefined"!=typeof Uint8ClampedArray?Uint8ClampedArray:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function Fr(t,e){return new Br[t](e)}let Nr=0;const jr=new Sn,Gr=new $n,Ur=new $i,Vr=new Qi,Hr=new Qi,Zr=new $i;function Wr(){Object.defineProperty(this,"id",{value:Nr++}),this.uuid=Fi.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}Wr.prototype=Object.assign(Object.create(Oi.prototype),{constructor:Wr,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(t){return Array.isArray(t)?this.index=new(zr(t)>65535?Rr:Lr)(t,1):this.index=t,this},getAttribute:function(t){return this.attributes[t]},setAttribute:function(t,e){return this.attributes[t]=e,this},deleteAttribute:function(t){return delete this.attributes[t],this},hasAttribute:function(t){return void 0!==this.attributes[t]},addGroup:function(t,e,i=0){this.groups.push({start:t,count:e,materialIndex:i})},clearGroups:function(){this.groups=[]},setDrawRange:function(t,e){this.drawRange.start=t,this.drawRange.count=e},applyMatrix4:function(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const e=(new ji).getNormalMatrix(t);i.applyNormalMatrix(e),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(t),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(t){return jr.makeRotationX(t),this.applyMatrix4(jr),this},rotateY:function(t){return jr.makeRotationY(t),this.applyMatrix4(jr),this},rotateZ:function(t){return jr.makeRotationZ(t),this.applyMatrix4(jr),this},translate:function(t,e,i){return jr.makeTranslation(t,e,i),this.applyMatrix4(jr),this},scale:function(t,e,i){return jr.makeScale(t,e,i),this.applyMatrix4(jr),this},lookAt:function(t){return Gr.lookAt(t),Gr.updateMatrix(),this.applyMatrix4(Gr.matrix),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(Ur).negate(),this.translate(Ur.x,Ur.y,Ur.z),this},setFromPoints:function(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new kr(e,3)),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Qi);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new $i(-1/0,-1/0,-1/0),new $i(1/0,1/0,1/0));if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];Vr.setFromBufferAttribute(i),this.morphTargetsRelative?(Zr.addVectors(this.boundingBox.min,Vr.min),this.boundingBox.expandByPoint(Zr),Zr.addVectors(this.boundingBox.max,Vr.max),this.boundingBox.expandByPoint(Zr)):(this.boundingBox.expandByPoint(Vr.min),this.boundingBox.expandByPoint(Vr.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new gn);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new $i,1/0);if(t){const i=this.boundingSphere.center;if(Vr.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];Hr.setFromBufferAttribute(i),this.morphTargetsRelative?(Zr.addVectors(Vr.min,Hr.min),Vr.expandByPoint(Zr),Zr.addVectors(Vr.max,Hr.max),Vr.expandByPoint(Zr)):(Vr.expandByPoint(Hr.min),Vr.expandByPoint(Hr.max))}Vr.getCenter(i);let n=0;for(let e=0,r=t.count;e<r;e++)Zr.fromBufferAttribute(t,e),n=Math.max(n,i.distanceToSquared(Zr));if(e)for(let r=0,o=e.length;r<o;r++){const o=e[r],a=this.morphTargetsRelative;for(let e=0,r=o.count;e<r;e++)Zr.fromBufferAttribute(o,e),a&&(Ur.fromBufferAttribute(t,e),Zr.add(Ur)),n=Math.max(n,i.distanceToSquared(Zr))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}},computeFaceNormals:function(){},computeTangents:function(){const t=this.index,e=this.attributes;if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const i=t.array,n=e.position.array,r=e.normal.array,o=e.uv.array,a=n.length/3;void 0===e.tangent&&this.setAttribute("tangent",new Sr(new Float32Array(4*a),4));const s=e.tangent.array,l=[],c=[];for(let t=0;t<a;t++)l[t]=new $i,c[t]=new $i;const h=new $i,u=new $i,d=new $i,p=new Ni,f=new Ni,m=new Ni,g=new $i,y=new $i;function _(t,e,i){h.fromArray(n,3*t),u.fromArray(n,3*e),d.fromArray(n,3*i),p.fromArray(o,2*t),f.fromArray(o,2*e),m.fromArray(o,2*i),u.sub(h),d.sub(h),f.sub(p),m.sub(p);const r=1/(f.x*m.y-m.x*f.y);isFinite(r)&&(g.copy(u).multiplyScalar(m.y).addScaledVector(d,-f.y).multiplyScalar(r),y.copy(d).multiplyScalar(f.x).addScaledVector(u,-m.x).multiplyScalar(r),l[t].add(g),l[e].add(g),l[i].add(g),c[t].add(y),c[e].add(y),c[i].add(y))}let v=this.groups;0===v.length&&(v=[{start:0,count:i.length}]);for(let t=0,e=v.length;t<e;++t){const e=v[t],n=e.start;for(let t=n,r=n+e.count;t<r;t+=3)_(i[t+0],i[t+1],i[t+2])}const x=new $i,b=new $i,w=new $i,M=new $i;function T(t){w.fromArray(r,3*t),M.copy(w);const e=l[t];x.copy(e),x.sub(w.multiplyScalar(w.dot(e))).normalize(),b.crossVectors(M,e);const i=b.dot(c[t])<0?-1:1;s[4*t]=x.x,s[4*t+1]=x.y,s[4*t+2]=x.z,s[4*t+3]=i}for(let t=0,e=v.length;t<e;++t){const e=v[t],n=e.start;for(let t=n,r=n+e.count;t<r;t+=3)T(i[t+0]),T(i[t+1]),T(i[t+2])}},computeVertexNormals:function(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let i=this.getAttribute("normal");if(void 0===i)i=new Sr(new Float32Array(3*e.count),3),this.setAttribute("normal",i);else for(let t=0,e=i.count;t<e;t++)i.setXYZ(t,0,0,0);const n=new $i,r=new $i,o=new $i,a=new $i,s=new $i,l=new $i,c=new $i,h=new $i;if(t)for(let u=0,d=t.count;u<d;u+=3){const d=t.getX(u+0),p=t.getX(u+1),f=t.getX(u+2);n.fromBufferAttribute(e,d),r.fromBufferAttribute(e,p),o.fromBufferAttribute(e,f),c.subVectors(o,r),h.subVectors(n,r),c.cross(h),a.fromBufferAttribute(i,d),s.fromBufferAttribute(i,p),l.fromBufferAttribute(i,f),a.add(c),s.add(c),l.add(c),i.setXYZ(d,a.x,a.y,a.z),i.setXYZ(p,s.x,s.y,s.z),i.setXYZ(f,l.x,l.y,l.z)}else for(let t=0,a=e.count;t<a;t+=3)n.fromBufferAttribute(e,t+0),r.fromBufferAttribute(e,t+1),o.fromBufferAttribute(e,t+2),c.subVectors(o,r),h.subVectors(n,r),c.cross(h),i.setXYZ(t+0,c.x,c.y,c.z),i.setXYZ(t+1,c.x,c.y,c.z),i.setXYZ(t+2,c.x,c.y,c.z);this.normalizeNormals(),i.needsUpdate=!0}},merge:function(t,e){if(!t||!t.isBufferGeometry)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",t);void 0===e&&(e=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const i=this.attributes;for(const n in i){if(void 0===t.attributes[n])continue;const r=i[n].array,o=t.attributes[n],a=o.array,s=o.itemSize*e,l=Math.min(a.length,r.length-s);for(let t=0,e=s;t<l;t++,e++)r[e]=a[t]}return this},normalizeNormals:function(){const t=this.attributes.normal;for(let e=0,i=t.count;e<i;e++)Zr.fromBufferAttribute(t,e),Zr.normalize(),t.setXYZ(e,Zr.x,Zr.y,Zr.z)},toNonIndexed:function(){function t(t,e){const i=t.array,n=t.itemSize,r=t.normalized,o=new i.constructor(e.length*n);let a=0,s=0;for(let t=0,r=e.length;t<r;t++){a=e[t]*n;for(let t=0;t<n;t++)o[s++]=i[a++]}return new Sr(o,n,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const e=new Wr,i=this.index.array,n=this.attributes;for(const r in n){const o=t(n[r],i);e.setAttribute(r,o)}const r=this.morphAttributes;for(const n in r){const o=[],a=r[n];for(let e=0,n=a.length;e<n;e++){const n=t(a[e],i);o.push(n)}e.morphAttributes[n]=o}e.morphTargetsRelative=this.morphTargetsRelative;const o=this.groups;for(let t=0,i=o.length;t<i;t++){const i=o[t];e.addGroup(i.start,i.count,i.materialIndex)}return e},toJSON:function(){const t={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const i in e)void 0!==e[i]&&(t[i]=e[i]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const i=this.attributes;for(const e in i){const n=i[e],r=n.toJSON(t.data);""!==n.name&&(r.name=n.name),t.data.attributes[e]=r}const n={};let r=!1;for(const e in this.morphAttributes){const i=this.morphAttributes[e],o=[];for(let e=0,n=i.length;e<n;e++){const n=i[e],r=n.toJSON(t.data);""!==n.name&&(r.name=n.name),o.push(r)}o.length>0&&(n[e]=o,r=!0)}r&&(t.data.morphAttributes=n,t.data.morphTargetsRelative=this.morphTargetsRelative);const o=this.groups;o.length>0&&(t.data.groups=JSON.parse(JSON.stringify(o)));const a=this.boundingSphere;return null!==a&&(t.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),t},clone:function(){return(new Wr).copy(this)},copy:function(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const i=t.index;null!==i&&this.setIndex(i.clone(e));const n=t.attributes;for(const t in n){const i=n[t];this.setAttribute(t,i.clone(e))}const r=t.morphAttributes;for(const t in r){const i=[],n=r[t];for(let t=0,r=n.length;t<r;t++)i.push(n[t].clone(e));this.morphAttributes[t]=i}this.morphTargetsRelative=t.morphTargetsRelative;const o=t.groups;for(let t=0,e=o.length;t<e;t++){const e=o[t];this.addGroup(e.start,e.count,e.materialIndex)}const a=t.boundingBox;null!==a&&(this.boundingBox=a.clone());const s=t.boundingSphere;return null!==s&&(this.boundingSphere=s.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});const qr=new Sn,Xr=new Tn,Yr=new gn,$r=new $i,Jr=new $i,Kr=new $i,Qr=new $i,to=new $i,eo=new $i,io=new $i,no=new $i,ro=new $i,oo=new Ni,ao=new Ni,so=new Ni,lo=new $i,co=new $i;function ho(t=new Wr,e=new wr){$n.call(this),this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}function uo(t,e,i,n,r,o,a,s,l,c,h,u){$r.fromBufferAttribute(r,c),Jr.fromBufferAttribute(r,h),Kr.fromBufferAttribute(r,u);const d=t.morphTargetInfluences;if(e.morphTargets&&o&&d){io.set(0,0,0),no.set(0,0,0),ro.set(0,0,0);for(let t=0,e=o.length;t<e;t++){const e=d[t],i=o[t];0!==e&&(Qr.fromBufferAttribute(i,c),to.fromBufferAttribute(i,h),eo.fromBufferAttribute(i,u),a?(io.addScaledVector(Qr,e),no.addScaledVector(to,e),ro.addScaledVector(eo,e)):(io.addScaledVector(Qr.sub($r),e),no.addScaledVector(to.sub(Jr),e),ro.addScaledVector(eo.sub(Kr),e)))}$r.add(io),Jr.add(no),Kr.add(ro)}t.isSkinnedMesh&&(t.boneTransform(c,$r),t.boneTransform(h,Jr),t.boneTransform(u,Kr));const p=function(t,e,i,n,r,o,a,s){let l;if(l=e.side===m?n.intersectTriangle(a,o,r,!0,s):n.intersectTriangle(r,o,a,e.side!==g,s),null===l)return null;co.copy(s),co.applyMatrix4(t.matrixWorld);const c=i.ray.origin.distanceTo(co);return c<i.near||c>i.far?null:{distance:c,point:co.clone(),object:t}}(t,e,i,n,$r,Jr,Kr,lo);if(p){s&&(oo.fromBufferAttribute(s,c),ao.fromBufferAttribute(s,h),so.fromBufferAttribute(s,u),p.uv=ur.getUV(lo,$r,Jr,Kr,oo,ao,so,new Ni)),l&&(oo.fromBufferAttribute(l,c),ao.fromBufferAttribute(l,h),so.fromBufferAttribute(l,u),p.uv2=ur.getUV(lo,$r,Jr,Kr,oo,ao,so,new Ni));const t=new vr(c,h,u);ur.getNormal($r,Jr,Kr,t.normal),p.face=t}return p}ho.prototype=Object.assign(Object.create($n.prototype),{constructor:ho,isMesh:!0,copy:function(t){return $n.prototype.copy.call(this,t),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=t.material,this.geometry=t.geometry,this},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}},raycast:function(t,e){const i=this.geometry,n=this.material,r=this.matrixWorld;if(void 0===n)return;if(null===i.boundingSphere&&i.computeBoundingSphere(),Yr.copy(i.boundingSphere),Yr.applyMatrix4(r),!1===t.ray.intersectsSphere(Yr))return;if(qr.copy(r).invert(),Xr.copy(t.ray).applyMatrix4(qr),null!==i.boundingBox&&!1===Xr.intersectsBox(i.boundingBox))return;let o;if(i.isBufferGeometry){const r=i.index,a=i.attributes.position,s=i.morphAttributes.position,l=i.morphTargetsRelative,c=i.attributes.uv,h=i.attributes.uv2,u=i.groups,d=i.drawRange;if(null!==r)if(Array.isArray(n))for(let i=0,p=u.length;i<p;i++){const p=u[i],f=n[p.materialIndex];for(let i=Math.max(p.start,d.start),n=Math.min(p.start+p.count,d.start+d.count);i<n;i+=3){const n=r.getX(i),u=r.getX(i+1),d=r.getX(i+2);o=uo(this,f,t,Xr,a,s,l,c,h,n,u,d),o&&(o.faceIndex=Math.floor(i/3),o.face.materialIndex=p.materialIndex,e.push(o))}}else{for(let i=Math.max(0,d.start),u=Math.min(r.count,d.start+d.count);i<u;i+=3){const u=r.getX(i),d=r.getX(i+1),p=r.getX(i+2);o=uo(this,n,t,Xr,a,s,l,c,h,u,d,p),o&&(o.faceIndex=Math.floor(i/3),e.push(o))}}else if(void 0!==a)if(Array.isArray(n))for(let i=0,r=u.length;i<r;i++){const r=u[i],p=n[r.materialIndex];for(let i=Math.max(r.start,d.start),n=Math.min(r.start+r.count,d.start+d.count);i<n;i+=3){o=uo(this,p,t,Xr,a,s,l,c,h,i,i+1,i+2),o&&(o.faceIndex=Math.floor(i/3),o.face.materialIndex=r.materialIndex,e.push(o))}}else{for(let i=Math.max(0,d.start),r=Math.min(a.count,d.start+d.count);i<r;i+=3){o=uo(this,n,t,Xr,a,s,l,c,h,i,i+1,i+2),o&&(o.faceIndex=Math.floor(i/3),e.push(o))}}}else i.isGeometry&&console.error("THREE.Mesh.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}});class po extends Wr{constructor(t=1,e=1,i=1,n=1,r=1,o=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:n,heightSegments:r,depthSegments:o};const a=this;n=Math.floor(n),r=Math.floor(r),o=Math.floor(o);const s=[],l=[],c=[],h=[];let u=0,d=0;function p(t,e,i,n,r,o,p,f,m,g,y){const _=o/m,v=p/g,x=o/2,b=p/2,w=f/2,M=m+1,T=g+1;let S=0,E=0;const C=new $i;for(let o=0;o<T;o++){const a=o*v-b;for(let s=0;s<M;s++){const u=s*_-x;C[t]=u*n,C[e]=a*r,C[i]=w,l.push(C.x,C.y,C.z),C[t]=0,C[e]=0,C[i]=f>0?1:-1,c.push(C.x,C.y,C.z),h.push(s/m),h.push(1-o/g),S+=1}}for(let t=0;t<g;t++)for(let e=0;e<m;e++){const i=u+e+M*t,n=u+e+M*(t+1),r=u+(e+1)+M*(t+1),o=u+(e+1)+M*t;s.push(i,n,o),s.push(n,r,o),E+=6}a.addGroup(d,E,y),d+=E,u+=S}p("z","y","x",-1,-1,i,e,t,o,r,0),p("z","y","x",1,-1,i,e,-t,o,r,1),p("x","z","y",1,1,t,i,e,n,o,2),p("x","z","y",1,-1,t,i,-e,n,o,3),p("x","y","z",1,-1,t,e,i,n,r,4),p("x","y","z",-1,-1,t,e,-i,n,r,5),this.setIndex(s),this.setAttribute("position",new kr(l,3)),this.setAttribute("normal",new kr(c,3)),this.setAttribute("uv",new kr(h,2))}}function fo(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const r=t[i][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture)?e[i][n]=r.clone():Array.isArray(r)?e[i][n]=r.slice():e[i][n]=r}}return e}function mo(t){const e={};for(let i=0;i<t.length;i++){const n=fo(t[i]);for(const t in n)e[t]=n[t]}return e}const go={clone:fo,merge:mo};function yo(t){br.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&(void 0!==t.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(t))}function _o(){$n.call(this),this.type="Camera",this.matrixWorldInverse=new Sn,this.projectionMatrix=new Sn,this.projectionMatrixInverse=new Sn}function vo(t=50,e=1,i=.1,n=2e3){_o.call(this),this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}yo.prototype=Object.create(br.prototype),yo.prototype.constructor=yo,yo.prototype.isShaderMaterial=!0,yo.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=fo(t.uniforms),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.lights=t.lights,this.clipping=t.clipping,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this},yo.prototype.toJSON=function(t){const e=br.prototype.toJSON.call(this,t);e.glslVersion=this.glslVersion,e.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;n&&n.isTexture?e.uniforms[i]={type:"t",value:n.toJSON(t).uuid}:n&&n.isColor?e.uniforms[i]={type:"c",value:n.getHex()}:n&&n.isVector2?e.uniforms[i]={type:"v2",value:n.toArray()}:n&&n.isVector3?e.uniforms[i]={type:"v3",value:n.toArray()}:n&&n.isVector4?e.uniforms[i]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?e.uniforms[i]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?e.uniforms[i]={type:"m4",value:n.toArray()}:e.uniforms[i]={value:n}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader;const i={};for(const t in this.extensions)!0===this.extensions[t]&&(i[t]=!0);return Object.keys(i).length>0&&(e.extensions=i),e},_o.prototype=Object.assign(Object.create($n.prototype),{constructor:_o,isCamera:!0,copy:function(t,e){return $n.prototype.copy.call(this,t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Camera: .getWorldDirection() target is now required"),t=new $i),this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(-e[8],-e[9],-e[10]).normalize()},updateMatrixWorld:function(t){$n.prototype.updateMatrixWorld.call(this,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()},updateWorldMatrix:function(t,e){$n.prototype.updateWorldMatrix.call(this,t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()},clone:function(){return(new this.constructor).copy(this)}}),vo.prototype=Object.assign(Object.create(_o.prototype),{constructor:vo,isPerspectiveCamera:!0,copy:function(t,e){return _o.prototype.copy.call(this,t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this},setFocalLength:function(t){const e=.5*this.getFilmHeight()/t;this.fov=2*Fi.RAD2DEG*Math.atan(e),this.updateProjectionMatrix()},getFocalLength:function(){const t=Math.tan(.5*Fi.DEG2RAD*this.fov);return.5*this.getFilmHeight()/t},getEffectiveFOV:function(){return 2*Fi.RAD2DEG*Math.atan(Math.tan(.5*Fi.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(t,e,i,n,r,o){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=o,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const t=this.near;let e=t*Math.tan(.5*Fi.DEG2RAD*this.fov)/this.zoom,i=2*e,n=this.aspect*i,r=-.5*n;const o=this.view;if(null!==this.view&&this.view.enabled){const t=o.fullWidth,a=o.fullHeight;r+=o.offsetX*n/t,e-=o.offsetY*i/a,n*=o.width/t,i*=o.height/a}const a=this.filmOffset;0!==a&&(r+=t*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,e,e-i,t,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()},toJSON:function(t){const e=$n.prototype.toJSON.call(this,t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}});function xo(t,e,i){if($n.call(this),this.type="CubeCamera",!0!==i.isWebGLCubeRenderTarget)return void console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");this.renderTarget=i;const n=new vo(90,1,t,e);n.layers=this.layers,n.up.set(0,-1,0),n.lookAt(new $i(1,0,0)),this.add(n);const r=new vo(90,1,t,e);r.layers=this.layers,r.up.set(0,-1,0),r.lookAt(new $i(-1,0,0)),this.add(r);const o=new vo(90,1,t,e);o.layers=this.layers,o.up.set(0,0,1),o.lookAt(new $i(0,1,0)),this.add(o);const a=new vo(90,1,t,e);a.layers=this.layers,a.up.set(0,0,-1),a.lookAt(new $i(0,-1,0)),this.add(a);const s=new vo(90,1,t,e);s.layers=this.layers,s.up.set(0,-1,0),s.lookAt(new $i(0,0,1)),this.add(s);const l=new vo(90,1,t,e);l.layers=this.layers,l.up.set(0,-1,0),l.lookAt(new $i(0,0,-1)),this.add(l),this.update=function(t,e){null===this.parent&&this.updateMatrixWorld();const c=t.xr.enabled,h=t.getRenderTarget();t.xr.enabled=!1;const u=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,t.setRenderTarget(i,0),t.render(e,n),t.setRenderTarget(i,1),t.render(e,r),t.setRenderTarget(i,2),t.render(e,o),t.setRenderTarget(i,3),t.render(e,a),t.setRenderTarget(i,4),t.render(e,s),i.texture.generateMipmaps=u,t.setRenderTarget(i,5),t.render(e,l),t.setRenderTarget(h),t.xr.enabled=c}}function bo(t,e,i,n,r,o,a,s,l,c){t=void 0!==t?t:[],e=void 0!==e?e:ot,a=void 0!==a?a:Bt,Hi.call(this,t,e,i,n,r,o,a,s,l,c),this.flipY=!1,this._needsFlipEnvMap=!0}xo.prototype=Object.create($n.prototype),xo.prototype.constructor=xo,bo.prototype=Object.create(Hi.prototype),bo.prototype.constructor=bo,bo.prototype.isCubeTexture=!0,Object.defineProperty(bo.prototype,"images",{get:function(){return this.image},set:function(t){this.image=t}});class wo extends qi{constructor(t,e,i){Number.isInteger(e)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),e=i),super(t,t,e),Object.defineProperty(this,"isWebGLCubeRenderTarget",{value:!0}),e=e||{},this.texture=new bo(void 0,e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.encoding),this.texture._needsFlipEnvMap=!1}fromEquirectangularTexture(t,e){this.texture.type=e.type,this.texture.format=Ft,this.texture.encoding=e.encoding,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},n=new po(5,5,5),r=new yo({name:"CubemapFromEquirect",uniforms:fo(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:m,blending:v});r.uniforms.tEquirect.value=e;const o=new ho(n,r),a=e.minFilter;e.minFilter===wt&&(e.minFilter=vt);return new xo(1,10,this).update(t,o),e.minFilter=a,o.geometry.dispose(),o.material.dispose(),this}clear(t,e,i,n){const r=t.getRenderTarget();for(let r=0;r<6;r++)t.setRenderTarget(this,r),t.clear(e,i,n);t.setRenderTarget(r)}}function Mo(t,e,i,n,r,o,a,s,l,c,h,u){Hi.call(this,null,o,a,s,l,c,n,r,h,u),this.image={data:t||null,width:e||1,height:i||1},this.magFilter=void 0!==l?l:ft,this.minFilter=void 0!==c?c:ft,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}Mo.prototype=Object.create(Hi.prototype),Mo.prototype.constructor=Mo,Mo.prototype.isDataTexture=!0;const To=new gn,So=new $i;class Eo{constructor(t,e,i,n,r,o){this.planes=[void 0!==t?t:new tr,void 0!==e?e:new tr,void 0!==i?i:new tr,void 0!==n?n:new tr,void 0!==r?r:new tr,void 0!==o?o:new tr]}set(t,e,i,n,r,o){const a=this.planes;return a[0].copy(t),a[1].copy(e),a[2].copy(i),a[3].copy(n),a[4].copy(r),a[5].copy(o),this}clone(){return(new this.constructor).copy(this)}copy(t){const e=this.planes;for(let i=0;i<6;i++)e[i].copy(t.planes[i]);return this}setFromProjectionMatrix(t){const e=this.planes,i=t.elements,n=i[0],r=i[1],o=i[2],a=i[3],s=i[4],l=i[5],c=i[6],h=i[7],u=i[8],d=i[9],p=i[10],f=i[11],m=i[12],g=i[13],y=i[14],_=i[15];return e[0].setComponents(a-n,h-s,f-u,_-m).normalize(),e[1].setComponents(a+n,h+s,f+u,_+m).normalize(),e[2].setComponents(a+r,h+l,f+d,_+g).normalize(),e[3].setComponents(a-r,h-l,f-d,_-g).normalize(),e[4].setComponents(a-o,h-c,f-p,_-y).normalize(),e[5].setComponents(a+o,h+c,f+p,_+y).normalize(),this}intersectsObject(t){const e=t.geometry;return null===e.boundingSphere&&e.computeBoundingSphere(),To.copy(e.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(To)}intersectsSprite(t){return To.center.set(0,0,0),To.radius=.7071067811865476,To.applyMatrix4(t.matrixWorld),this.intersectsSphere(To)}intersectsSphere(t){const e=this.planes,i=t.center,n=-t.radius;for(let t=0;t<6;t++){if(e[t].distanceToPoint(i)<n)return!1}return!0}intersectsBox(t){const e=this.planes;for(let i=0;i<6;i++){const n=e[i];if(So.x=n.normal.x>0?t.max.x:t.min.x,So.y=n.normal.y>0?t.max.y:t.min.y,So.z=n.normal.z>0?t.max.z:t.min.z,n.distanceToPoint(So)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let i=0;i<6;i++)if(e[i].distanceToPoint(t)<0)return!1;return!0}}function Co(){let t=null,e=!1,i=null,n=null;function r(e,o){i(e,o),n=t.requestAnimationFrame(r)}return{start:function(){!0!==e&&null!==i&&(n=t.requestAnimationFrame(r),e=!0)},stop:function(){t.cancelAnimationFrame(n),e=!1},setAnimationLoop:function(t){i=t},setContext:function(e){t=e}}}function Ao(t,e){const i=e.isWebGL2,n=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),n.get(t)},remove:function(e){e.isInterleavedBufferAttribute&&(e=e.data);const i=n.get(e);i&&(t.deleteBuffer(i.buffer),n.delete(e))},update:function(e,r){if(e.isGLBufferAttribute){const t=n.get(e);return void((!t||t.version<e.version)&&n.set(e,{buffer:e.buffer,type:e.type,bytesPerElement:e.elementSize,version:e.version}))}e.isInterleavedBufferAttribute&&(e=e.data);const o=n.get(e);void 0===o?n.set(e,function(e,n){const r=e.array,o=e.usage,a=t.createBuffer();t.bindBuffer(n,a),t.bufferData(n,r,o),e.onUploadCallback();let s=5126;return r instanceof Float32Array?s=5126:r instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):r instanceof Uint16Array?e.isFloat16BufferAttribute?i?s=5131:console.warn("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2."):s=5123:r instanceof Int16Array?s=5122:r instanceof Uint32Array?s=5125:r instanceof Int32Array?s=5124:r instanceof Int8Array?s=5120:r instanceof Uint8Array&&(s=5121),{buffer:a,type:s,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version}}(e,r)):o.version<e.version&&(!function(e,n,r){const o=n.array,a=n.updateRange;t.bindBuffer(r,e),-1===a.count?t.bufferSubData(r,0,o):(i?t.bufferSubData(r,a.offset*o.BYTES_PER_ELEMENT,o,a.offset,a.count):t.bufferSubData(r,a.offset*o.BYTES_PER_ELEMENT,o.subarray(a.offset,a.offset+a.count)),a.count=-1)}(o.buffer,e,r),o.version=e.version)}}}class Po extends Wr{constructor(t=1,e=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:n};const r=t/2,o=e/2,a=Math.floor(i),s=Math.floor(n),l=a+1,c=s+1,h=t/a,u=e/s,d=[],p=[],f=[],m=[];for(let t=0;t<c;t++){const e=t*u-o;for(let i=0;i<l;i++){const n=i*h-r;p.push(n,-e,0),f.push(0,0,1),m.push(i/a),m.push(1-t/s)}}for(let t=0;t<s;t++)for(let e=0;e<a;e++){const i=e+l*t,n=e+l*(t+1),r=e+1+l*(t+1),o=e+1+l*t;d.push(i,n,o),d.push(n,r,o)}this.setIndex(d),this.setAttribute("position",new kr(p,3)),this.setAttribute("normal",new kr(f,3)),this.setAttribute("uv",new kr(m,2))}}const Lo={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n}\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n#else\n\tif( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t}\n\treturn 1.0;\n#endif\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nvec3 F_Schlick_RoughnessDependent( const in vec3 F0, const in float dotNV, const in float roughness ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );\n\tvec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;\n\treturn Fr * fresnel + F0;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + viewDir );\n\tfloat dotNL = saturate( dot( normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\nvec3 BRDF_Specular_GGX_Environment( const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\treturn specularColor * brdf.x + brdf.y;\n}\nvoid BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tvec3 F = F_Schlick_RoughnessDependent( specularColor, dotNV, roughness );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\tvec3 FssEss = F * brdf.x + brdf.y;\n\tfloat Ess = brdf.x + brdf.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie(float roughness, float NoH) {\n\tfloat invAlpha = 1.0 / roughness;\n\tfloat cos2h = NoH * NoH;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\treturn (2.0 + invAlpha) * pow(sin2h, invAlpha * 0.5) / (2.0 * PI);\n}\nfloat V_Neubelt(float NoV, float NoL) {\n\treturn saturate(1.0 / (4.0 * (NoL + NoV - NoL * NoV)));\n}\nvec3 BRDF_Specular_Sheen( const in float roughness, const in vec3 L, const in GeometricContext geometry, vec3 specularColor ) {\n\tvec3 N = geometry.normal;\n\tvec3 V = geometry.viewDir;\n\tvec3 H = normalize( V + L );\n\tfloat dotNH = saturate( dot( N, H ) );\n\treturn specularColor * D_Charlie( roughness, dotNH ) * V_Neubelt( dot(N, V), dot(N, L) );\n}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor.xyz *= color.xyz;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat max3( vec3 v ) { return max( max( v.x, v.y ), v.z ); }\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n#ifdef CLEARCOAT\n\tvec3 clearcoatNormal;\n#endif\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_maxMipLevel 8.0\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_maxTileSize 256.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\tfloat texelSize = 1.0 / ( 3.0 * cubeUV_maxTileSize );\n\t\tvec2 uv = getUV( direction, face ) * ( faceSize - 1.0 );\n\t\tvec2 f = fract( uv );\n\t\tuv += 0.5 - f;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tif ( mipInt < cubeUV_maxMipLevel ) {\n\t\t\tuv.y += 2.0 * cubeUV_maxTileSize;\n\t\t}\n\t\tuv.y += filterInt * 2.0 * cubeUV_minTileSize;\n\t\tuv.x += 3.0 * max( 0.0, cubeUV_maxTileSize - 2.0 * faceSize );\n\t\tuv *= texelSize;\n\t\tvec3 tl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x += texelSize;\n\t\tvec3 tr = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.y += texelSize;\n\t\tvec3 br = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tuv.x -= texelSize;\n\t\tvec3 bl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;\n\t\tvec3 tm = mix( tl, tr, f.x );\n\t\tvec3 bm = mix( bl, br, f.x );\n\t\treturn mix( tm, bm, f.y );\n\t}\n\t#define r0 1.0\n\t#define v0 0.339\n\t#define m0 - 2.0\n\t#define r1 0.8\n\t#define v1 0.276\n\t#define m1 - 1.0\n\t#define r4 0.4\n\t#define v4 0.046\n\t#define m4 2.0\n\t#define r5 0.305\n\t#define v5 0.016\n\t#define m5 3.0\n\t#define r6 0.21\n\t#define v6 0.0038\n\t#define m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= r1 ) {\n\t\t\tmip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;\n\t\t} else if ( roughness >= r4 ) {\n\t\t\tmip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;\n\t\t} else if ( roughness >= r5 ) {\n\t\t\tmip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;\n\t\t} else if ( roughness >= r6 ) {\n\t\t\tmip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), m0, cubeUV_maxMipLevel );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",encodings_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * value.a * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat M = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat D = max( maxRange / maxRGB, 1.0 );\n\tD = clamp( floor( D ) / 255.0, 0.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value ) {\n\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;\n\tXp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract( Le );\n\tvResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;\n\treturn vec4( max( vRGB, 0.0 ), 1.0 );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifndef ENVMAP_TYPE_CUBE_UV\n\t\tenvColor = envMapTexelToLinear( envColor );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform int maxMipLevel;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#if defined( USE_ENVMAP )\n\t#ifdef ENVMAP_MODE_REFRACTION\n\t\tuniform float refractionRatio;\n\t#endif\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float roughness, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat sigma = PI * roughness * roughness / ( 1.0 + roughness );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + log2( sigma );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -viewDir, normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( roughness, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tfogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float fogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * fogDepth * fogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn texture2D( gradientMap, coord ).rgb;\n\t#else\n\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\treflectedLight.indirectDiffuse += PI * lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\nvIndirectFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n\tvIndirectBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\nvIndirectFront += getAmbientLightIrradiance( ambientLightColor );\nvIndirectFront += getLightProbeIrradiance( lightProbe, geometry );\n#ifdef DOUBLE_SIDED\n\tvIndirectBack += getAmbientLightIrradiance( ambientLightColor );\n\tvIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry );\n#endif\n#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n#endif",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\nuniform vec3 lightProbe[ 9 ];\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {\n\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon\n#define Material_LightProbeLOD( material )\t(0)",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.specularRoughness = max( roughnessFactor, 0.0525 );material.specularRoughness += geometryRoughness;\nmaterial.specularRoughness = min( material.specularRoughness, 1.0 );\n#ifdef REFLECTIVITY\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#endif\n#ifdef CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheen;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat specularRoughness;\n\tvec3 specularColor;\n#ifdef CLEARCOAT\n\tfloat clearcoat;\n\tfloat clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tvec3 sheenColor;\n#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearcoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNL = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = ccDotNL * directLight.color;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tccIrradiance *= PI;\n\t\t#endif\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t\treflectedLight.directSpecular += ccIrradiance * material.clearcoat * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_Sheen(\n\t\t\tmaterial.specularRoughness,\n\t\t\tdirectLight.direction,\n\t\t\tgeometry,\n\t\t\tmaterial.sheenColor\n\t\t);\n\t#else\n\t\treflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.normal, material.specularColor, material.specularRoughness);\n\t#endif\n\treflectedLight.directDiffuse += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef CLEARCOAT\n\t\tfloat ccDotNV = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular += clearcoatRadiance * material.clearcoat * BRDF_Specular_GGX_Environment( geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );\n\t\tfloat ccDotNL = ccDotNV;\n\t\tfloat clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );\n\t#else\n\t\tfloat clearcoatDHR = 0.0;\n\t#endif\n\tfloat clearcoatInv = 1.0 - clearcoatDHR;\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\tBRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );\n\treflectedLight.indirectSpecular += clearcoatInv * radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n#ifdef CLEARCOAT\n\tgeometry.clearcoatNormal = clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry );\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\tvec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tradiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, maxMipLevel );\n\t#ifdef CLEARCOAT\n\t\tclearcoatRadiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, maxMipLevel );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n#endif\n#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\tuniform mat3 uvTransform;\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifndef USE_MORPHNORMALS\n\t\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\t\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t#endif\n#endif",normal_fragment_begin:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n\t#ifdef USE_TANGENT\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\ttangent = tangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t\tbitangent = bitangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t#endif\n\t\t#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\t\t#endif\n\t#endif\n#endif\nvec3 geometryNormal = normal;",normal_fragment_maps:"#ifdef OBJECTSPACE_NORMALMAP\n\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( TANGENTSPACE_NORMALMAP )\n\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\t#ifdef USE_TANGENT\n\t\tnormal = normalize( vTBN * mapN );\n\t#else\n\t\tnormal = perturbNormal2Arb( -vViewPosition, normal, mapN );\n\t#endif\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN ) {\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tfloat scale = sign( st1.t * st0.s - st0.t * st1.s );\n\t\tvec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );\n\t\tvec3 T = normalize( ( - q0 * st1.s + q1 * st0.s ) * scale );\n\t\tvec3 N = normalize( surf_norm );\n\t\tmat3 tsn = mat3( S, T, N );\n\t\tmapN.xy *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef CLEARCOAT\n\tvec3 clearcoatNormal = geometryNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\t#ifdef USE_TANGENT\n\t\tclearcoatNormal = normalize( vTBN * clearcoatMapN );\n\t#else\n\t\tclearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN );\n\t#endif\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0\n\t\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\tvec4 shadowWorldPosition;\n\t#endif\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform highp sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmissionmap_fragment:"#ifdef USE_TRANSMISSIONMAP\n\ttotalTransmission *= texture2D( transmissionMap, vUv ).r;\n#endif",transmissionmap_pars_fragment:"#ifdef USE_TRANSMISSIONMAP\n\tuniform sampler2D transmissionMap;\n#endif",uv_pars_fragment:"#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#ifdef USE_UV\n\t#ifdef UVS_VERTEX_ONLY\n\t\tvec2 vUv;\n\t#else\n\t\tvarying vec2 vUv;\n\t#endif\n\tuniform mat3 uvTransform;\n#endif",uv_vertex:"#ifdef USE_UV\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n\tuniform mat3 uv2Transform;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_frag:"uniform sampler2D t2D;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",cube_frag:"#include <envmap_common_pars_fragment>\nuniform float opacity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\tvec3 vReflect = vWorldDirection;\n\t#include <envmap_fragment>\n\tgl_FragColor = envColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tvec4 texColor = texture2D( tEquirect, sampleUV );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\t#else\n\t\treflectedLight.indirectDiffuse += vIndirectFront;\n\t#endif\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t\tmatcapColor = matcapTexelToLinear( matcapColor );\n\t#else\n\t\tvec4 matcapColor = vec4( 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#ifndef FLAT_SHADED\n\t\tvNormal = normalize( transformedNormal );\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define REFLECTIVITY\n\t#define CLEARCOAT\n\t#define TRANSMISSION\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef TRANSMISSION\n\tuniform float transmission;\n#endif\n#ifdef REFLECTIVITY\n\tuniform float reflectivity;\n#endif\n#ifdef CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheen;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <transmissionmap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#ifdef TRANSMISSION\n\t\tfloat totalTransmission = transmission;\n\t#endif\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <transmissionmap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#ifdef TRANSMISSION\n\t\tdiffuseColor.a *= mix( saturate( 1. - totalTransmission + linearToRelativeLuminance( reflectedLight.directSpecular + reflectedLight.indirectSpecular ) ), 1.0, metalness );\n\t#endif\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}"},Io={common:{diffuse:{value:new _r(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new ji},uv2Transform:{value:new ji},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Ni(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new _r(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new _r(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},uvTransform:{value:new ji}},sprite:{diffuse:{value:new _r(15658734)},opacity:{value:1},center:{value:new Ni(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},uvTransform:{value:new ji}}},Ro={basic:{uniforms:mo([Io.common,Io.specularmap,Io.envmap,Io.aomap,Io.lightmap,Io.fog]),vertexShader:Lo.meshbasic_vert,fragmentShader:Lo.meshbasic_frag},lambert:{uniforms:mo([Io.common,Io.specularmap,Io.envmap,Io.aomap,Io.lightmap,Io.emissivemap,Io.fog,Io.lights,{emissive:{value:new _r(0)}}]),vertexShader:Lo.meshlambert_vert,fragmentShader:Lo.meshlambert_frag},phong:{uniforms:mo([Io.common,Io.specularmap,Io.envmap,Io.aomap,Io.lightmap,Io.emissivemap,Io.bumpmap,Io.normalmap,Io.displacementmap,Io.fog,Io.lights,{emissive:{value:new _r(0)},specular:{value:new _r(1118481)},shininess:{value:30}}]),vertexShader:Lo.meshphong_vert,fragmentShader:Lo.meshphong_frag},standard:{uniforms:mo([Io.common,Io.envmap,Io.aomap,Io.lightmap,Io.emissivemap,Io.bumpmap,Io.normalmap,Io.displacementmap,Io.roughnessmap,Io.metalnessmap,Io.fog,Io.lights,{emissive:{value:new _r(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Lo.meshphysical_vert,fragmentShader:Lo.meshphysical_frag},toon:{uniforms:mo([Io.common,Io.aomap,Io.lightmap,Io.emissivemap,Io.bumpmap,Io.normalmap,Io.displacementmap,Io.gradientmap,Io.fog,Io.lights,{emissive:{value:new _r(0)}}]),vertexShader:Lo.meshtoon_vert,fragmentShader:Lo.meshtoon_frag},matcap:{uniforms:mo([Io.common,Io.bumpmap,Io.normalmap,Io.displacementmap,Io.fog,{matcap:{value:null}}]),vertexShader:Lo.meshmatcap_vert,fragmentShader:Lo.meshmatcap_frag},points:{uniforms:mo([Io.points,Io.fog]),vertexShader:Lo.points_vert,fragmentShader:Lo.points_frag},dashed:{uniforms:mo([Io.common,Io.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Lo.linedashed_vert,fragmentShader:Lo.linedashed_frag},depth:{uniforms:mo([Io.common,Io.displacementmap]),vertexShader:Lo.depth_vert,fragmentShader:Lo.depth_frag},normal:{uniforms:mo([Io.common,Io.bumpmap,Io.normalmap,Io.displacementmap,{opacity:{value:1}}]),vertexShader:Lo.normal_vert,fragmentShader:Lo.normal_frag},sprite:{uniforms:mo([Io.sprite,Io.fog]),vertexShader:Lo.sprite_vert,fragmentShader:Lo.sprite_frag},background:{uniforms:{uvTransform:{value:new ji},t2D:{value:null}},vertexShader:Lo.background_vert,fragmentShader:Lo.background_frag},cube:{uniforms:mo([Io.envmap,{opacity:{value:1}}]),vertexShader:Lo.cube_vert,fragmentShader:Lo.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Lo.equirect_vert,fragmentShader:Lo.equirect_frag},distanceRGBA:{uniforms:mo([Io.common,Io.displacementmap,{referencePosition:{value:new $i},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Lo.distanceRGBA_vert,fragmentShader:Lo.distanceRGBA_frag},shadow:{uniforms:mo([Io.lights,Io.fog,{color:{value:new _r(0)},opacity:{value:1}}]),vertexShader:Lo.shadow_vert,fragmentShader:Lo.shadow_frag}};function Do(t,e,i,n,r){const o=new _r(0);let a,s,l=0,c=null,h=0,u=null;function d(t,e){i.buffers.color.setClear(t.r,t.g,t.b,e,r)}return{getClearColor:function(){return o},setClearColor:function(t,e=1){o.set(t),l=e,d(o,l)},getClearAlpha:function(){return l},setClearAlpha:function(t){l=t,d(o,l)},render:function(i,r,p,g){let y=!0===r.isScene?r.background:null;y&&y.isTexture&&(y=e.get(y));const _=t.xr,v=_.getSession&&_.getSession();v&&"additive"===v.environmentBlendMode&&(y=null),null===y?d(o,l):y&&y.isColor&&(d(y,1),g=!0),(t.autoClear||g)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),y&&(y.isCubeTexture||y.isWebGLCubeRenderTarget||y.mapping===ct)?(void 0===s&&(s=new ho(new po(1,1,1),new yo({name:"BackgroundCubeMaterial",uniforms:fo(Ro.cube.uniforms),vertexShader:Ro.cube.vertexShader,fragmentShader:Ro.cube.fragmentShader,side:m,depthTest:!1,depthWrite:!1,fog:!1})),s.geometry.deleteAttribute("normal"),s.geometry.deleteAttribute("uv"),s.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(s.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(s)),y.isWebGLCubeRenderTarget&&(y=y.texture),s.material.uniforms.envMap.value=y,s.material.uniforms.flipEnvMap.value=y.isCubeTexture&&y._needsFlipEnvMap?-1:1,c===y&&h===y.version&&u===t.toneMapping||(s.material.needsUpdate=!0,c=y,h=y.version,u=t.toneMapping),i.unshift(s,s.geometry,s.material,0,0,null)):y&&y.isTexture&&(void 0===a&&(a=new ho(new Po(2,2),new yo({name:"BackgroundMaterial",uniforms:fo(Ro.background.uniforms),vertexShader:Ro.background.vertexShader,fragmentShader:Ro.background.fragmentShader,side:f,depthTest:!1,depthWrite:!1,fog:!1})),a.geometry.deleteAttribute("normal"),Object.defineProperty(a.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(a)),a.material.uniforms.t2D.value=y,!0===y.matrixAutoUpdate&&y.updateMatrix(),a.material.uniforms.uvTransform.value.copy(y.matrix),c===y&&h===y.version&&u===t.toneMapping||(a.material.needsUpdate=!0,c=y,h=y.version,u=t.toneMapping),i.unshift(a,a.geometry,a.material,0,0,null))}}}function ko(t,e,i,n){const r=t.getParameter(34921),o=n.isWebGL2?null:e.get("OES_vertex_array_object"),a=n.isWebGL2||null!==o,s={},l=d(null);let c=l;function h(e){return n.isWebGL2?t.bindVertexArray(e):o.bindVertexArrayOES(e)}function u(e){return n.isWebGL2?t.deleteVertexArray(e):o.deleteVertexArrayOES(e)}function d(t){const e=[],i=[],n=[];for(let t=0;t<r;t++)e[t]=0,i[t]=0,n[t]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:e,enabledAttributes:i,attributeDivisors:n,object:t,attributes:{},index:null}}function p(){const t=c.newAttributes;for(let e=0,i=t.length;e<i;e++)t[e]=0}function f(t){m(t,0)}function m(i,r){const o=c.newAttributes,a=c.enabledAttributes,s=c.attributeDivisors;if(o[i]=1,0===a[i]&&(t.enableVertexAttribArray(i),a[i]=1),s[i]!==r){(n.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,r),s[i]=r}}function g(){const e=c.newAttributes,i=c.enabledAttributes;for(let n=0,r=i.length;n<r;n++)i[n]!==e[n]&&(t.disableVertexAttribArray(n),i[n]=0)}function y(e,i,r,o,a,s){!0!==n.isWebGL2||5124!==r&&5125!==r?t.vertexAttribPointer(e,i,r,o,a,s):t.vertexAttribIPointer(e,i,r,a,s)}function _(){v(),c!==l&&(c=l,h(c.object))}function v(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(r,l,u,_,v){let x=!1;if(a){const e=function(e,i,r){const a=!0===r.wireframe;let l=s[e.id];void 0===l&&(l={},s[e.id]=l);let c=l[i.id];void 0===c&&(c={},l[i.id]=c);let h=c[a];void 0===h&&(h=d(n.isWebGL2?t.createVertexArray():o.createVertexArrayOES()),c[a]=h);return h}(_,u,l);c!==e&&(c=e,h(c.object)),x=function(t,e){const i=c.attributes,n=t.attributes;let r=0;for(const t in n){const e=i[t],o=n[t];if(void 0===e)return!0;if(e.attribute!==o)return!0;if(e.data!==o.data)return!0;r++}return c.attributesNum!==r||c.index!==e}(_,v),x&&function(t,e){const i={},n=t.attributes;let r=0;for(const t in n){const e=n[t],o={};o.attribute=e,e.data&&(o.data=e.data),i[t]=o,r++}c.attributes=i,c.attributesNum=r,c.index=e}(_,v)}else{const t=!0===l.wireframe;c.geometry===_.id&&c.program===u.id&&c.wireframe===t||(c.geometry=_.id,c.program=u.id,c.wireframe=t,x=!0)}!0===r.isInstancedMesh&&(x=!0),null!==v&&i.update(v,34963),x&&(!function(r,o,a,s){if(!1===n.isWebGL2&&(r.isInstancedMesh||s.isInstancedBufferGeometry)&&null===e.get("ANGLE_instanced_arrays"))return;p();const l=s.attributes,c=a.getAttributes(),h=o.defaultAttributeValues;for(const e in c){const n=c[e];if(n>=0){const o=l[e];if(void 0!==o){const e=o.normalized,r=o.itemSize,a=i.get(o);if(void 0===a)continue;const l=a.buffer,c=a.type,h=a.bytesPerElement;if(o.isInterleavedBufferAttribute){const i=o.data,a=i.stride,u=o.offset;i&&i.isInstancedInterleavedBuffer?(m(n,i.meshPerAttribute),void 0===s._maxInstanceCount&&(s._maxInstanceCount=i.meshPerAttribute*i.count)):f(n),t.bindBuffer(34962,l),y(n,r,c,e,a*h,u*h)}else o.isInstancedBufferAttribute?(m(n,o.meshPerAttribute),void 0===s._maxInstanceCount&&(s._maxInstanceCount=o.meshPerAttribute*o.count)):f(n),t.bindBuffer(34962,l),y(n,r,c,e,0,0)}else if("instanceMatrix"===e){const e=i.get(r.instanceMatrix);if(void 0===e)continue;const o=e.buffer,a=e.type;m(n+0,1),m(n+1,1),m(n+2,1),m(n+3,1),t.bindBuffer(34962,o),t.vertexAttribPointer(n+0,4,a,!1,64,0),t.vertexAttribPointer(n+1,4,a,!1,64,16),t.vertexAttribPointer(n+2,4,a,!1,64,32),t.vertexAttribPointer(n+3,4,a,!1,64,48)}else if("instanceColor"===e){const e=i.get(r.instanceColor);if(void 0===e)continue;const o=e.buffer,a=e.type;m(n,1),t.bindBuffer(34962,o),t.vertexAttribPointer(n,3,a,!1,12,0)}else if(void 0!==h){const i=h[e];if(void 0!==i)switch(i.length){case 2:t.vertexAttrib2fv(n,i);break;case 3:t.vertexAttrib3fv(n,i);break;case 4:t.vertexAttrib4fv(n,i);break;default:t.vertexAttrib1fv(n,i)}}}}g()}(r,l,u,_),null!==v&&t.bindBuffer(34963,i.get(v).buffer))},reset:_,resetDefaultState:v,dispose:function(){_();for(const t in s){const e=s[t];for(const t in e){const i=e[t];for(const t in i)u(i[t].object),delete i[t];delete e[t]}delete s[t]}},releaseStatesOfGeometry:function(t){if(void 0===s[t.id])return;const e=s[t.id];for(const t in e){const i=e[t];for(const t in i)u(i[t].object),delete i[t];delete e[t]}delete s[t.id]},releaseStatesOfProgram:function(t){for(const e in s){const i=s[e];if(void 0===i[t.id])continue;const n=i[t.id];for(const t in n)u(n[t].object),delete n[t];delete i[t.id]}},initAttributes:p,enableAttribute:f,disableUnusedAttributes:g}}function Oo(t,e,i,n){const r=n.isWebGL2;let o;this.setMode=function(t){o=t},this.render=function(e,n){t.drawArrays(o,e,n),i.update(n,o,1)},this.renderInstances=function(n,a,s){if(0===s)return;let l,c;if(r)l=t,c="drawArraysInstanced";else if(l=e.get("ANGLE_instanced_arrays"),c="drawArraysInstancedANGLE",null===l)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[c](o,n,a,s),i.update(a,o,s)}}function zo(t,e,i){let n;function r(e){if("highp"===e){if(t.getShaderPrecisionFormat(35633,36338).precision>0&&t.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";e="mediump"}return"mediump"===e&&t.getShaderPrecisionFormat(35633,36337).precision>0&&t.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const o="undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&t instanceof WebGL2ComputeRenderingContext;let a=void 0!==i.precision?i.precision:"highp";const s=r(a);s!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",s,"instead."),a=s);const l=!0===i.logarithmicDepthBuffer,c=t.getParameter(34930),h=t.getParameter(35660),u=t.getParameter(3379),d=t.getParameter(34076),p=t.getParameter(34921),f=t.getParameter(36347),m=t.getParameter(36348),g=t.getParameter(36349),y=h>0,_=o||!!e.get("OES_texture_float");return{isWebGL2:o,getMaxAnisotropy:function(){if(void 0!==n)return n;const i=e.get("EXT_texture_filter_anisotropic");return n=null!==i?t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,n},getMaxPrecision:r,precision:a,logarithmicDepthBuffer:l,maxTextures:c,maxVertexTextures:h,maxTextureSize:u,maxCubemapSize:d,maxAttributes:p,maxVertexUniforms:f,maxVaryings:m,maxFragmentUniforms:g,vertexTextures:y,floatFragmentTextures:_,floatVertexTextures:y&&_,maxSamples:o?t.getParameter(36183):0}}function Bo(t){const e=this;let i=null,n=0,r=!1,o=!1;const a=new tr,s=new ji,l={value:null,needsUpdate:!1};function c(){l.value!==i&&(l.value=i,l.needsUpdate=n>0),e.numPlanes=n,e.numIntersection=0}function h(t,i,n,r){const o=null!==t?t.length:0;let c=null;if(0!==o){if(c=l.value,!0!==r||null===c){const e=n+4*o,r=i.matrixWorldInverse;s.getNormalMatrix(r),(null===c||c.length<e)&&(c=new Float32Array(e));for(let e=0,i=n;e!==o;++e,i+=4)a.copy(t[e]).applyMatrix4(r,s),a.normal.toArray(c,i),c[i+3]=a.constant}l.value=c,l.needsUpdate=!0}return e.numPlanes=o,e.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(t,e,o){const a=0!==t.length||e||0!==n||r;return r=e,i=h(t,o,0),n=t.length,a},this.beginShadows=function(){o=!0,h(null)},this.endShadows=function(){o=!1,c()},this.setState=function(e,a,s){const u=e.clippingPlanes,d=e.clipIntersection,p=e.clipShadows,f=t.get(e);if(!r||null===u||0===u.length||o&&!p)o?h(null):c();else{const t=o?0:n,e=4*t;let r=f.clippingState||null;l.value=r,r=h(u,a,e,s);for(let t=0;t!==e;++t)r[t]=i[t];f.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=t}}}function Fo(t){let e=new WeakMap;function i(t,e){return e===st?t.mapping=ot:e===lt&&(t.mapping=at),t}function n(t){const i=t.target;i.removeEventListener("dispose",n);const r=e.get(i);void 0!==r&&(e.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture){const o=r.mapping;if(o===st||o===lt){if(e.has(r)){return i(e.get(r).texture,r.mapping)}{const o=r.image;if(o&&o.height>0){const a=t.getRenderList(),s=t.getRenderTarget(),l=new wo(o.height/2);return l.fromEquirectangularTexture(t,r),e.set(r,l),t.setRenderTarget(s),t.setRenderList(a),r.addEventListener("dispose",n),i(l.texture,r.mapping)}return null}}}return r},dispose:function(){e=new WeakMap}}}function No(t){const e={};function i(i){if(void 0!==e[i])return e[i];let n;switch(i){case"WEBGL_depth_texture":n=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=t.getExtension(i)}return e[i]=n,n}return{has:function(t){return null!==i(t)},init:function(t){t.isWebGL2?i("EXT_color_buffer_float"):(i("WEBGL_depth_texture"),i("OES_texture_float"),i("OES_texture_half_float"),i("OES_texture_half_float_linear"),i("OES_standard_derivatives"),i("OES_element_index_uint"),i("OES_vertex_array_object"),i("ANGLE_instanced_arrays")),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float")},get:function(t){const e=i(t);return null===e&&console.warn("THREE.WebGLRenderer: "+t+" extension not supported."),e}}}function jo(t,e,i,n){const r={},o=new WeakMap;function a(t){const s=t.target;null!==s.index&&e.remove(s.index);for(const t in s.attributes)e.remove(s.attributes[t]);s.removeEventListener("dispose",a),delete r[s.id];const l=o.get(s);l&&(e.remove(l),o.delete(s)),n.releaseStatesOfGeometry(s),!0===s.isInstancedBufferGeometry&&delete s._maxInstanceCount,i.memory.geometries--}function s(t){const i=[],n=t.index,r=t.attributes.position;let a=0;if(null!==n){const t=n.array;a=n.version;for(let e=0,n=t.length;e<n;e+=3){const n=t[e+0],r=t[e+1],o=t[e+2];i.push(n,r,r,o,o,n)}}else{const t=r.array;a=r.version;for(let e=0,n=t.length/3-1;e<n;e+=3){const t=e+0,n=e+1,r=e+2;i.push(t,n,n,r,r,t)}}const s=new(zr(i)>65535?Rr:Lr)(i,1);s.version=a;const l=o.get(t);l&&e.remove(l),o.set(t,s)}return{get:function(t,e){return!0===r[e.id]||(e.addEventListener("dispose",a),r[e.id]=!0,i.memory.geometries++),e},update:function(t){const i=t.attributes;for(const t in i)e.update(i[t],34962);const n=t.morphAttributes;for(const t in n){const i=n[t];for(let t=0,n=i.length;t<n;t++)e.update(i[t],34962)}},getWireframeAttribute:function(t){const e=o.get(t);if(e){const i=t.index;null!==i&&e.version<i.version&&s(t)}else s(t);return o.get(t)}}}function Go(t,e,i,n){const r=n.isWebGL2;let o,a,s;this.setMode=function(t){o=t},this.setIndex=function(t){a=t.type,s=t.bytesPerElement},this.render=function(e,n){t.drawElements(o,n,a,e*s),i.update(n,o,1)},this.renderInstances=function(n,l,c){if(0===c)return;let h,u;if(r)h=t,u="drawElementsInstanced";else if(h=e.get("ANGLE_instanced_arrays"),u="drawElementsInstancedANGLE",null===h)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");h[u](o,l,a,n*s,c),i.update(l,o,c)}}function Uo(t){const e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.frame++,e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(t,i,n){switch(e.calls++,i){case 4:e.triangles+=n*(t/3);break;case 1:e.lines+=n*(t/2);break;case 3:e.lines+=n*(t-1);break;case 2:e.lines+=n*t;break;case 0:e.points+=n*t;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",i)}}}}function Vo(t,e){return t[0]-e[0]}function Ho(t,e){return Math.abs(e[1])-Math.abs(t[1])}function Zo(t){const e={},i=new Float32Array(8),n=[];for(let t=0;t<8;t++)n[t]=[t,0];return{update:function(r,o,a,s){const l=r.morphTargetInfluences,c=void 0===l?0:l.length;let h=e[o.id];if(void 0===h){h=[];for(let t=0;t<c;t++)h[t]=[t,0];e[o.id]=h}for(let t=0;t<c;t++){const e=h[t];e[0]=t,e[1]=l[t]}h.sort(Ho);for(let t=0;t<8;t++)t<c&&h[t][1]?(n[t][0]=h[t][0],n[t][1]=h[t][1]):(n[t][0]=Number.MAX_SAFE_INTEGER,n[t][1]=0);n.sort(Vo);const u=a.morphTargets&&o.morphAttributes.position,d=a.morphNormals&&o.morphAttributes.normal;let p=0;for(let t=0;t<8;t++){const e=n[t],r=e[0],a=e[1];r!==Number.MAX_SAFE_INTEGER&&a?(u&&o.getAttribute("morphTarget"+t)!==u[r]&&o.setAttribute("morphTarget"+t,u[r]),d&&o.getAttribute("morphNormal"+t)!==d[r]&&o.setAttribute("morphNormal"+t,d[r]),i[t]=a,p+=a):(u&&!0===o.hasAttribute("morphTarget"+t)&&o.deleteAttribute("morphTarget"+t),d&&!0===o.hasAttribute("morphNormal"+t)&&o.deleteAttribute("morphNormal"+t),i[t]=0)}const f=o.morphTargetsRelative?1:1-p;s.getUniforms().setValue(t,"morphTargetBaseInfluence",f),s.getUniforms().setValue(t,"morphTargetInfluences",i)}}}function Wo(t,e,i,n){let r=new WeakMap;function o(t){const e=t.target;e.removeEventListener("dispose",o),i.remove(e.instanceMatrix),null!==e.instanceColor&&i.remove(e.instanceColor)}return{update:function(t){const a=n.render.frame,s=t.geometry,l=e.get(t,s);return r.get(l)!==a&&(e.update(l),r.set(l,a)),t.isInstancedMesh&&(!1===t.hasEventListener("dispose",o)&&t.addEventListener("dispose",o),i.update(t.instanceMatrix,34962),null!==t.instanceColor&&i.update(t.instanceColor,34962)),l},dispose:function(){r=new WeakMap}}}function qo(t=null,e=1,i=1,n=1){Hi.call(this,null),this.image={data:t,width:e,height:i,depth:n},this.magFilter=ft,this.minFilter=ft,this.wrapR=dt,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}function Xo(t=null,e=1,i=1,n=1){Hi.call(this,null),this.image={data:t,width:e,height:i,depth:n},this.magFilter=ft,this.minFilter=ft,this.wrapR=dt,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}Ro.physical={uniforms:mo([Ro.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new Ni(1,1)},clearcoatNormalMap:{value:null},sheen:{value:new _r(0)},transmission:{value:0},transmissionMap:{value:null}}]),vertexShader:Lo.meshphysical_vert,fragmentShader:Lo.meshphysical_frag},qo.prototype=Object.create(Hi.prototype),qo.prototype.constructor=qo,qo.prototype.isDataTexture2DArray=!0,Xo.prototype=Object.create(Hi.prototype),Xo.prototype.constructor=Xo,Xo.prototype.isDataTexture3D=!0;const Yo=new Hi,$o=new qo,Jo=new Xo,Ko=new bo,Qo=[],ta=[],ea=new Float32Array(16),ia=new Float32Array(9),na=new Float32Array(4);function ra(t,e,i){const n=t[0];if(n<=0||n>0)return t;const r=e*i;let o=Qo[r];if(void 0===o&&(o=new Float32Array(r),Qo[r]=o),0!==e){n.toArray(o,0);for(let n=1,r=0;n!==e;++n)r+=i,t[n].toArray(o,r)}return o}function oa(t,e){if(t.length!==e.length)return!1;for(let i=0,n=t.length;i<n;i++)if(t[i]!==e[i])return!1;return!0}function aa(t,e){for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}function sa(t,e){let i=ta[e];void 0===i&&(i=new Int32Array(e),ta[e]=i);for(let n=0;n!==e;++n)i[n]=t.allocateTextureUnit();return i}function la(t,e){const i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function ca(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(oa(i,e))return;t.uniform2fv(this.addr,e),aa(i,e)}}function ha(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else if(void 0!==e.r)i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b);else{if(oa(i,e))return;t.uniform3fv(this.addr,e),aa(i,e)}}function ua(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(oa(i,e))return;t.uniform4fv(this.addr,e),aa(i,e)}}function da(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(oa(i,e))return;t.uniformMatrix2fv(this.addr,!1,e),aa(i,e)}else{if(oa(i,n))return;na.set(n),t.uniformMatrix2fv(this.addr,!1,na),aa(i,n)}}function pa(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(oa(i,e))return;t.uniformMatrix3fv(this.addr,!1,e),aa(i,e)}else{if(oa(i,n))return;ia.set(n),t.uniformMatrix3fv(this.addr,!1,ia),aa(i,n)}}function fa(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(oa(i,e))return;t.uniformMatrix4fv(this.addr,!1,e),aa(i,e)}else{if(oa(i,n))return;ea.set(n),t.uniformMatrix4fv(this.addr,!1,ea),aa(i,n)}}function ma(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.safeSetTexture2D(e||Yo,r)}function ga(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture2DArray(e||$o,r)}function ya(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture3D(e||Jo,r)}function _a(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.safeSetTextureCube(e||Ko,r)}function va(t,e){const i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function xa(t,e){const i=this.cache;oa(i,e)||(t.uniform2iv(this.addr,e),aa(i,e))}function ba(t,e){const i=this.cache;oa(i,e)||(t.uniform3iv(this.addr,e),aa(i,e))}function wa(t,e){const i=this.cache;oa(i,e)||(t.uniform4iv(this.addr,e),aa(i,e))}function Ma(t,e){const i=this.cache;i[0]!==e&&(t.uniform1ui(this.addr,e),i[0]=e)}function Ta(t,e){t.uniform1fv(this.addr,e)}function Sa(t,e){t.uniform1iv(this.addr,e)}function Ea(t,e){t.uniform2iv(this.addr,e)}function Ca(t,e){t.uniform3iv(this.addr,e)}function Aa(t,e){t.uniform4iv(this.addr,e)}function Pa(t,e){const i=ra(e,this.size,2);t.uniform2fv(this.addr,i)}function La(t,e){const i=ra(e,this.size,3);t.uniform3fv(this.addr,i)}function Ia(t,e){const i=ra(e,this.size,4);t.uniform4fv(this.addr,i)}function Ra(t,e){const i=ra(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,i)}function Da(t,e){const i=ra(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,i)}function ka(t,e){const i=ra(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,i)}function Oa(t,e,i){const n=e.length,r=sa(i,n);t.uniform1iv(this.addr,r);for(let t=0;t!==n;++t)i.safeSetTexture2D(e[t]||Yo,r[t])}function za(t,e,i){const n=e.length,r=sa(i,n);t.uniform1iv(this.addr,r);for(let t=0;t!==n;++t)i.safeSetTextureCube(e[t]||Ko,r[t])}function Ba(t,e,i){this.id=t,this.addr=i,this.cache=[],this.setValue=function(t){switch(t){case 5126:return la;case 35664:return ca;case 35665:return ha;case 35666:return ua;case 35674:return da;case 35675:return pa;case 35676:return fa;case 5124:case 35670:return va;case 35667:case 35671:return xa;case 35668:case 35672:return ba;case 35669:case 35673:return wa;case 5125:return Ma;case 35678:case 36198:case 36298:case 36306:case 35682:return ma;case 35679:case 36299:case 36307:return ya;case 35680:case 36300:case 36308:case 36293:return _a;case 36289:case 36303:case 36311:case 36292:return ga}}(e.type)}function Fa(t,e,i){this.id=t,this.addr=i,this.cache=[],this.size=e.size,this.setValue=function(t){switch(t){case 5126:return Ta;case 35664:return Pa;case 35665:return La;case 35666:return Ia;case 35674:return Ra;case 35675:return Da;case 35676:return ka;case 5124:case 35670:return Sa;case 35667:case 35671:return Ea;case 35668:case 35672:return Ca;case 35669:case 35673:return Aa;case 35678:case 36198:case 36298:case 36306:case 35682:return Oa;case 35680:case 36300:case 36308:case 36293:return za}}(e.type)}function Na(t){this.id=t,this.seq=[],this.map={}}Fa.prototype.updateCache=function(t){const e=this.cache;t instanceof Float32Array&&e.length!==t.length&&(this.cache=new Float32Array(t.length)),aa(e,t)},Na.prototype.setValue=function(t,e,i){const n=this.seq;for(let r=0,o=n.length;r!==o;++r){const o=n[r];o.setValue(t,e[o.id],i)}};const ja=/(\w+)(\])?(\[|\.)?/g;function Ga(t,e){t.seq.push(e),t.map[e.id]=e}function Ua(t,e,i){const n=t.name,r=n.length;for(ja.lastIndex=0;;){const o=ja.exec(n),a=ja.lastIndex;let s=o[1];const l="]"===o[2],c=o[3];if(l&&(s|=0),void 0===c||"["===c&&a+2===r){Ga(i,void 0===c?new Ba(s,t,e):new Fa(s,t,e));break}{let t=i.map[s];void 0===t&&(t=new Na(s),Ga(i,t)),i=t}}}function Va(t,e){this.seq=[],this.map={};const i=t.getProgramParameter(e,35718);for(let n=0;n<i;++n){const i=t.getActiveUniform(e,n);Ua(i,t.getUniformLocation(e,i.name),this)}}function Ha(t,e,i){const n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),n}Va.prototype.setValue=function(t,e,i,n){const r=this.map[e];void 0!==r&&r.setValue(t,i,n)},Va.prototype.setOptional=function(t,e,i){const n=e[i];void 0!==n&&this.setValue(t,i,n)},Va.upload=function(t,e,i,n){for(let r=0,o=e.length;r!==o;++r){const o=e[r],a=i[o.id];!1!==a.needsUpdate&&o.setValue(t,a.value,n)}},Va.seqWithValue=function(t,e){const i=[];for(let n=0,r=t.length;n!==r;++n){const r=t[n];r.id in e&&i.push(r)}return i};let Za=0;function Wa(t){switch(t){case $e:return["Linear","( value )"];case Je:return["sRGB","( value )"];case Qe:return["RGBE","( value )"];case ei:return["RGBM","( value, 7.0 )"];case ii:return["RGBM","( value, 16.0 )"];case ni:return["RGBD","( value, 256.0 )"];case Ke:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case ti:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",t),["Linear","( value )"]}}function qa(t,e,i){const n=t.getShaderParameter(e,35713),r=t.getShaderInfoLog(e).trim();if(n&&""===r)return"";return"THREE.WebGLShader: gl.getShaderInfoLog() "+i+"\n"+r+function(t){const e=t.split("\n");for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join("\n")}(t.getShaderSource(e))}function Xa(t,e){const i=Wa(e);return"vec4 "+t+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function Ya(t,e){const i=Wa(e);return"vec4 "+t+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function $a(t,e){let i;switch(e){case Q:i="Linear";break;case tt:i="Reinhard";break;case et:i="OptimizedCineon";break;case it:i="ACESFilmic";break;case nt:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),i="Linear"}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function Ja(t){return""!==t}function Ka(t,e){return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function Qa(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const ts=/^[ \t]*#include +<([\w\d./]+)>/gm;function es(t){return t.replace(ts,is)}function is(t,e){const i=Lo[e];if(void 0===i)throw new Error("Can not resolve #include <"+e+">");return es(i)}const ns=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,rs=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function os(t){return t.replace(rs,ss).replace(ns,as)}function as(t,e,i,n){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),ss(t,e,i,n)}function ss(t,e,i,n){let r="";for(let t=parseInt(e);t<parseInt(i);t++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+t+" ]").replace(/UNROLLED_LOOP_INDEX/g,t);return r}function ls(t){let e="precision "+t.precision+" float;\nprecision "+t.precision+" int;";return"highp"===t.precision?e+="\n#define HIGH_PRECISION":"mediump"===t.precision?e+="\n#define MEDIUM_PRECISION":"lowp"===t.precision&&(e+="\n#define LOW_PRECISION"),e}function cs(t,e,i,n){const r=t.getContext(),o=i.defines;let a=i.vertexShader,s=i.fragmentShader;const l=function(t){let e="SHADOWMAP_TYPE_BASIC";return t.shadowMapType===u?e="SHADOWMAP_TYPE_PCF":t.shadowMapType===d?e="SHADOWMAP_TYPE_PCF_SOFT":t.shadowMapType===p&&(e="SHADOWMAP_TYPE_VSM"),e}(i),c=function(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case ot:case at:e="ENVMAP_TYPE_CUBE";break;case ct:case ht:e="ENVMAP_TYPE_CUBE_UV"}return e}(i),h=function(t){let e="ENVMAP_MODE_REFLECTION";if(t.envMap)switch(t.envMapMode){case at:case ht:e="ENVMAP_MODE_REFRACTION"}return e}(i),f=function(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case Y:e="ENVMAP_BLENDING_MULTIPLY";break;case $:e="ENVMAP_BLENDING_MIX";break;case J:e="ENVMAP_BLENDING_ADD"}return e}(i),m=t.gammaFactor>0?t.gammaFactor:1,g=i.isWebGL2?"":function(t){return[t.extensionDerivatives||t.envMapCubeUV||t.bumpMap||t.tangentSpaceNormalMap||t.clearcoatNormalMap||t.flatShading||"physical"===t.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(t.extensionFragDepth||t.logarithmicDepthBuffer)&&t.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",t.extensionDrawBuffers&&t.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(t.extensionShaderTextureLOD||t.envMap)&&t.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Ja).join("\n")}(i),y=function(t){const e=[];for(const i in t){const n=t[i];!1!==n&&e.push("#define "+i+" "+n)}return e.join("\n")}(o),_=r.createProgram();let v,x,b=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(v=[y].filter(Ja).join("\n"),v.length>0&&(v+="\n"),x=[g,y].filter(Ja).join("\n"),x.length>0&&(x+="\n")):(v=[ls(i),"#define SHADER_NAME "+i.shaderName,y,i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+m,"#define MAX_BONES "+i.maxBones,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+h:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Ja).join("\n"),x=[g,ls(i),"#define SHADER_NAME "+i.shaderName,y,i.alphaTest?"#define ALPHATEST "+i.alphaTest+(i.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+m,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.envMap?"#define "+h:"",i.envMap?"#define "+f:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.sheen?"#define USE_SHEEN":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(i.extensionShaderTextureLOD||i.envMap)&&i.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",i.toneMapping!==K?"#define TONE_MAPPING":"",i.toneMapping!==K?Lo.tonemapping_pars_fragment:"",i.toneMapping!==K?$a("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",Lo.encodings_pars_fragment,i.map?Xa("mapTexelToLinear",i.mapEncoding):"",i.matcap?Xa("matcapTexelToLinear",i.matcapEncoding):"",i.envMap?Xa("envMapTexelToLinear",i.envMapEncoding):"",i.emissiveMap?Xa("emissiveMapTexelToLinear",i.emissiveMapEncoding):"",i.lightMap?Xa("lightMapTexelToLinear",i.lightMapEncoding):"",Ya("linearToOutputTexel",i.outputEncoding),i.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(Ja).join("\n")),a=es(a),a=Ka(a,i),a=Qa(a,i),s=es(s),s=Ka(s,i),s=Qa(s,i),a=os(a),s=os(s),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(b="#version 300 es\n",v=["#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+v,x=["#define varying in",i.glslVersion===ki?"":"out highp vec4 pc_fragColor;",i.glslVersion===ki?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+x);const w=b+x+s,M=Ha(r,35633,b+v+a),T=Ha(r,35632,w);if(r.attachShader(_,M),r.attachShader(_,T),void 0!==i.index0AttributeName?r.bindAttribLocation(_,0,i.index0AttributeName):!0===i.morphTargets&&r.bindAttribLocation(_,0,"position"),r.linkProgram(_),t.debug.checkShaderErrors){const t=r.getProgramInfoLog(_).trim(),e=r.getShaderInfoLog(M).trim(),i=r.getShaderInfoLog(T).trim();let n=!0,o=!0;if(!1===r.getProgramParameter(_,35714)){n=!1;const e=qa(r,M,"vertex"),i=qa(r,T,"fragment");console.error("THREE.WebGLProgram: shader error: ",r.getError(),"35715",r.getProgramParameter(_,35715),"gl.getProgramInfoLog",t,e,i)}else""!==t?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",t):""!==e&&""!==i||(o=!1);o&&(this.diagnostics={runnable:n,programLog:t,vertexShader:{log:e,prefix:v},fragmentShader:{log:i,prefix:x}})}let S,E;return r.deleteShader(M),r.deleteShader(T),this.getUniforms=function(){return void 0===S&&(S=new Va(r,_)),S},this.getAttributes=function(){return void 0===E&&(E=function(t,e){const i={},n=t.getProgramParameter(e,35721);for(let r=0;r<n;r++){const n=t.getActiveAttrib(e,r).name;i[n]=t.getAttribLocation(e,n)}return i}(r,_)),E},this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(_),this.program=void 0},this.name=i.shaderName,this.id=Za++,this.cacheKey=e,this.usedTimes=1,this.program=_,this.vertexShader=M,this.fragmentShader=T,this}function hs(t,e,i,n,r,o){const a=[],s=n.isWebGL2,l=n.logarithmicDepthBuffer,c=n.floatVertexTextures,h=n.maxVertexUniforms,u=n.vertexTextures;let d=n.precision;const p={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},f=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen","transmissionMap"];function y(t){let e;return t&&t.isTexture?e=t.encoding:t&&t.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),e=t.texture.encoding):e=$e,e}return{getParameters:function(r,a,f,_,v){const x=_.fog,b=r.isMeshStandardMaterial?_.environment:null,w=e.get(r.envMap||b),M=p[r.type],T=v.isSkinnedMesh?function(t){const e=t.skeleton.bones;if(c)return 1024;{const t=h,i=Math.floor((t-20)/4),n=Math.min(i,e.length);return n<e.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+e.length+" bones. This GPU supports "+n+"."),0):n}}(v):0;let S,E;if(null!==r.precision&&(d=n.getMaxPrecision(r.precision),d!==r.precision&&console.warn("THREE.WebGLProgram.getParameters:",r.precision,"not supported, using",d,"instead.")),M){const t=Ro[M];S=t.vertexShader,E=t.fragmentShader}else S=r.vertexShader,E=r.fragmentShader;const C=t.getRenderTarget();return{isWebGL2:s,shaderID:M,shaderName:r.type,vertexShader:S,fragmentShader:E,defines:r.defines,isRawShaderMaterial:!0===r.isRawShaderMaterial,glslVersion:r.glslVersion,precision:d,instancing:!0===v.isInstancedMesh,instancingColor:!0===v.isInstancedMesh&&null!==v.instanceColor,supportsVertexTextures:u,outputEncoding:null!==C?y(C.texture):t.outputEncoding,map:!!r.map,mapEncoding:y(r.map),matcap:!!r.matcap,matcapEncoding:y(r.matcap),envMap:!!w,envMapMode:w&&w.mapping,envMapEncoding:y(w),envMapCubeUV:!!w&&(w.mapping===ct||w.mapping===ht),lightMap:!!r.lightMap,lightMapEncoding:y(r.lightMap),aoMap:!!r.aoMap,emissiveMap:!!r.emissiveMap,emissiveMapEncoding:y(r.emissiveMap),bumpMap:!!r.bumpMap,normalMap:!!r.normalMap,objectSpaceNormalMap:r.normalMapType===si,tangentSpaceNormalMap:r.normalMapType===ai,clearcoatMap:!!r.clearcoatMap,clearcoatRoughnessMap:!!r.clearcoatRoughnessMap,clearcoatNormalMap:!!r.clearcoatNormalMap,displacementMap:!!r.displacementMap,roughnessMap:!!r.roughnessMap,metalnessMap:!!r.metalnessMap,specularMap:!!r.specularMap,alphaMap:!!r.alphaMap,gradientMap:!!r.gradientMap,sheen:!!r.sheen,transmissionMap:!!r.transmissionMap,combine:r.combine,vertexTangents:r.normalMap&&r.vertexTangents,vertexColors:r.vertexColors,vertexUvs:!!(r.map||r.bumpMap||r.normalMap||r.specularMap||r.alphaMap||r.emissiveMap||r.roughnessMap||r.metalnessMap||r.clearcoatMap||r.clearcoatRoughnessMap||r.clearcoatNormalMap||r.displacementMap||r.transmissionMap),uvsVertexOnly:!(r.map||r.bumpMap||r.normalMap||r.specularMap||r.alphaMap||r.emissiveMap||r.roughnessMap||r.metalnessMap||r.clearcoatNormalMap||r.transmissionMap||!r.displacementMap),fog:!!x,useFog:r.fog,fogExp2:x&&x.isFogExp2,flatShading:r.flatShading,sizeAttenuation:r.sizeAttenuation,logarithmicDepthBuffer:l,skinning:r.skinning&&T>0,maxBones:T,useVertexTexture:c,morphTargets:r.morphTargets,morphNormals:r.morphNormals,maxMorphTargets:t.maxMorphTargets,maxMorphNormals:t.maxMorphNormals,numDirLights:a.directional.length,numPointLights:a.point.length,numSpotLights:a.spot.length,numRectAreaLights:a.rectArea.length,numHemiLights:a.hemi.length,numDirLightShadows:a.directionalShadowMap.length,numPointLightShadows:a.pointShadowMap.length,numSpotLightShadows:a.spotShadowMap.length,numClippingPlanes:o.numPlanes,numClipIntersection:o.numIntersection,dithering:r.dithering,shadowMapEnabled:t.shadowMap.enabled&&f.length>0,shadowMapType:t.shadowMap.type,toneMapping:r.toneMapped?t.toneMapping:K,physicallyCorrectLights:t.physicallyCorrectLights,premultipliedAlpha:r.premultipliedAlpha,alphaTest:r.alphaTest,doubleSided:r.side===g,flipSided:r.side===m,depthPacking:void 0!==r.depthPacking&&r.depthPacking,index0AttributeName:r.index0AttributeName,extensionDerivatives:r.extensions&&r.extensions.derivatives,extensionFragDepth:r.extensions&&r.extensions.fragDepth,extensionDrawBuffers:r.extensions&&r.extensions.drawBuffers,extensionShaderTextureLOD:r.extensions&&r.extensions.shaderTextureLOD,rendererExtensionFragDepth:s||i.has("EXT_frag_depth"),rendererExtensionDrawBuffers:s||i.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:s||i.has("EXT_shader_texture_lod"),customProgramCacheKey:r.customProgramCacheKey()}},getProgramCacheKey:function(e){const i=[];if(e.shaderID?i.push(e.shaderID):(i.push(e.fragmentShader),i.push(e.vertexShader)),void 0!==e.defines)for(const t in e.defines)i.push(t),i.push(e.defines[t]);if(!1===e.isRawShaderMaterial){for(let t=0;t<f.length;t++)i.push(e[f[t]]);i.push(t.outputEncoding),i.push(t.gammaFactor)}return i.push(e.customProgramCacheKey),i.join()},getUniforms:function(t){const e=p[t.type];let i;if(e){const t=Ro[e];i=go.clone(t.uniforms)}else i=t.uniforms;return i},acquireProgram:function(e,i){let n;for(let t=0,e=a.length;t<e;t++){const e=a[t];if(e.cacheKey===i){n=e,++n.usedTimes;break}}return void 0===n&&(n=new cs(t,i,e,r),a.push(n)),n},releaseProgram:function(t){if(0==--t.usedTimes){const e=a.indexOf(t);a[e]=a[a.length-1],a.pop(),t.destroy()}},programs:a}}function us(){let t=new WeakMap;return{get:function(e){let i=t.get(e);return void 0===i&&(i={},t.set(e,i)),i},remove:function(e){t.delete(e)},update:function(e,i,n){t.get(e)[i]=n},dispose:function(){t=new WeakMap}}}function ds(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program!==e.program?t.program.id-e.program.id:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function ps(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function fs(t){const e=[];let i=0;const n=[],r=[],o={id:-1};function a(n,r,a,s,l,c){let h=e[i];const u=t.get(a);return void 0===h?(h={id:n.id,object:n,geometry:r,material:a,program:u.program||o,groupOrder:s,renderOrder:n.renderOrder,z:l,group:c},e[i]=h):(h.id=n.id,h.object=n,h.geometry=r,h.material=a,h.program=u.program||o,h.groupOrder=s,h.renderOrder=n.renderOrder,h.z=l,h.group=c),i++,h}return{opaque:n,transparent:r,init:function(){i=0,n.length=0,r.length=0},push:function(t,e,i,o,s,l){const c=a(t,e,i,o,s,l);(!0===i.transparent?r:n).push(c)},unshift:function(t,e,i,o,s,l){const c=a(t,e,i,o,s,l);(!0===i.transparent?r:n).unshift(c)},finish:function(){for(let t=i,n=e.length;t<n;t++){const i=e[t];if(null===i.id)break;i.id=null,i.object=null,i.geometry=null,i.material=null,i.program=null,i.group=null}},sort:function(t,e){n.length>1&&n.sort(t||ds),r.length>1&&r.sort(e||ps)}}}function ms(t){let e=new WeakMap;return{get:function(i,n){const r=e.get(i);let o;return void 0===r?(o=new fs(t),e.set(i,new WeakMap),e.get(i).set(n,o)):(o=r.get(n),void 0===o&&(o=new fs(t),r.set(n,o))),o},dispose:function(){e=new WeakMap}}}function gs(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":i={direction:new $i,color:new _r};break;case"SpotLight":i={position:new $i,direction:new $i,color:new _r,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new $i,color:new _r,distance:0,decay:0};break;case"HemisphereLight":i={direction:new $i,skyColor:new _r,groundColor:new _r};break;case"RectAreaLight":i={color:new _r,position:new $i,halfWidth:new $i,halfHeight:new $i}}return t[e.id]=i,i}}}let ys=0;function _s(t,e){return(e.castShadow?1:0)-(t.castShadow?1:0)}function vs(t,e){const i=new gs,n=function(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Ni};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Ni,shadowCameraNear:1,shadowCameraFar:1e3}}return t[e.id]=i,i}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let t=0;t<9;t++)r.probe.push(new $i);const o=new $i,a=new Sn,s=new Sn;return{setup:function(o){let a=0,s=0,l=0;for(let t=0;t<9;t++)r.probe[t].set(0,0,0);let c=0,h=0,u=0,d=0,p=0,f=0,m=0,g=0;o.sort(_s);for(let t=0,e=o.length;t<e;t++){const e=o[t],y=e.color,_=e.intensity,v=e.distance,x=e.shadow&&e.shadow.map?e.shadow.map.texture:null;if(e.isAmbientLight)a+=y.r*_,s+=y.g*_,l+=y.b*_;else if(e.isLightProbe)for(let t=0;t<9;t++)r.probe[t].addScaledVector(e.sh.coefficients[t],_);else if(e.isDirectionalLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity),e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,r.directionalShadow[c]=i,r.directionalShadowMap[c]=x,r.directionalShadowMatrix[c]=e.shadow.matrix,f++}r.directional[c]=t,c++}else if(e.isSpotLight){const t=i.get(e);if(t.position.setFromMatrixPosition(e.matrixWorld),t.color.copy(y).multiplyScalar(_),t.distance=v,t.coneCos=Math.cos(e.angle),t.penumbraCos=Math.cos(e.angle*(1-e.penumbra)),t.decay=e.decay,e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,r.spotShadow[u]=i,r.spotShadowMap[u]=x,r.spotShadowMatrix[u]=e.shadow.matrix,g++}r.spot[u]=t,u++}else if(e.isRectAreaLight){const t=i.get(e);t.color.copy(y).multiplyScalar(_),t.halfWidth.set(.5*e.width,0,0),t.halfHeight.set(0,.5*e.height,0),r.rectArea[d]=t,d++}else if(e.isPointLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity),t.distance=e.distance,t.decay=e.decay,e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,i.shadowCameraNear=t.camera.near,i.shadowCameraFar=t.camera.far,r.pointShadow[h]=i,r.pointShadowMap[h]=x,r.pointShadowMatrix[h]=e.shadow.matrix,m++}r.point[h]=t,h++}else if(e.isHemisphereLight){const t=i.get(e);t.skyColor.copy(e.color).multiplyScalar(_),t.groundColor.copy(e.groundColor).multiplyScalar(_),r.hemi[p]=t,p++}}d>0&&(e.isWebGL2||!0===t.has("OES_texture_float_linear")?(r.rectAreaLTC1=Io.LTC_FLOAT_1,r.rectAreaLTC2=Io.LTC_FLOAT_2):!0===t.has("OES_texture_half_float_linear")?(r.rectAreaLTC1=Io.LTC_HALF_1,r.rectAreaLTC2=Io.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),r.ambient[0]=a,r.ambient[1]=s,r.ambient[2]=l;const y=r.hash;y.directionalLength===c&&y.pointLength===h&&y.spotLength===u&&y.rectAreaLength===d&&y.hemiLength===p&&y.numDirectionalShadows===f&&y.numPointShadows===m&&y.numSpotShadows===g||(r.directional.length=c,r.spot.length=u,r.rectArea.length=d,r.point.length=h,r.hemi.length=p,r.directionalShadow.length=f,r.directionalShadowMap.length=f,r.pointShadow.length=m,r.pointShadowMap.length=m,r.spotShadow.length=g,r.spotShadowMap.length=g,r.directionalShadowMatrix.length=f,r.pointShadowMatrix.length=m,r.spotShadowMatrix.length=g,y.directionalLength=c,y.pointLength=h,y.spotLength=u,y.rectAreaLength=d,y.hemiLength=p,y.numDirectionalShadows=f,y.numPointShadows=m,y.numSpotShadows=g,r.version=ys++)},setupView:function(t,e){let i=0,n=0,l=0,c=0,h=0;const u=e.matrixWorldInverse;for(let e=0,d=t.length;e<d;e++){const d=t[e];if(d.isDirectionalLight){const t=r.directional[i];t.direction.setFromMatrixPosition(d.matrixWorld),o.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(o),t.direction.transformDirection(u),i++}else if(d.isSpotLight){const t=r.spot[l];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),t.direction.setFromMatrixPosition(d.matrixWorld),o.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(o),t.direction.transformDirection(u),l++}else if(d.isRectAreaLight){const t=r.rectArea[c];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),s.identity(),a.copy(d.matrixWorld),a.premultiply(u),s.extractRotation(a),t.halfWidth.set(.5*d.width,0,0),t.halfHeight.set(0,.5*d.height,0),t.halfWidth.applyMatrix4(s),t.halfHeight.applyMatrix4(s),c++}else if(d.isPointLight){const t=r.point[n];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),n++}else if(d.isHemisphereLight){const t=r.hemi[h];t.direction.setFromMatrixPosition(d.matrixWorld),t.direction.transformDirection(u),t.direction.normalize(),h++}}},state:r}}function xs(t,e){const i=new vs(t,e),n=[],r=[];return{init:function(){n.length=0,r.length=0},state:{lightsArray:n,shadowsArray:r,lights:i},setupLights:function(){i.setup(n)},setupLightsView:function(t){i.setupView(n,t)},pushLight:function(t){n.push(t)},pushShadow:function(t){r.push(t)}}}function bs(t,e){let i=new WeakMap;return{get:function(n,r=0){let o;return!1===i.has(n)?(o=new xs(t,e),i.set(n,[]),i.get(n).push(o)):r>=i.get(n).length?(o=new xs(t,e),i.get(n).push(o)):o=i.get(n)[r],o},dispose:function(){i=new WeakMap}}}function ws(t){br.call(this),this.type="MeshDepthMaterial",this.depthPacking=ri,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(t)}function Ms(t){br.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new $i,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(t)}ws.prototype=Object.create(br.prototype),ws.prototype.constructor=ws,ws.prototype.isMeshDepthMaterial=!0,ws.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.depthPacking=t.depthPacking,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this},Ms.prototype=Object.create(br.prototype),Ms.prototype.constructor=Ms,Ms.prototype.isMeshDistanceMaterial=!0,Ms.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.referencePosition.copy(t.referencePosition),this.nearDistance=t.nearDistance,this.farDistance=t.farDistance,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this};function Ts(t,e,i){let n=new Eo;const r=new Ni,o=new Ni,a=new Wi,s=[],l=[],c={},h={0:m,1:f,2:g},d=new yo({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new Ni},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy ) / resolution ) );\n\tfor ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, i ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean * HALF_SAMPLE_RATE;\n\tsquared_mean = squared_mean * HALF_SAMPLE_RATE;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),y=d.clone();y.defines.HORIZONTAL_PASS=1;const _=new Wr;_.setAttribute("position",new Sr(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const x=new ho(_,d),b=this;function w(i,n){const r=e.update(x);d.uniforms.shadow_pass.value=i.map.texture,d.uniforms.resolution.value=i.mapSize,d.uniforms.radius.value=i.radius,t.setRenderTarget(i.mapPass),t.clear(),t.renderBufferDirect(n,null,r,d,x,null),y.uniforms.shadow_pass.value=i.mapPass.texture,y.uniforms.resolution.value=i.mapSize,y.uniforms.radius.value=i.radius,t.setRenderTarget(i.map),t.clear(),t.renderBufferDirect(n,null,r,y,x,null)}function M(t,e,i){const n=t<<0|e<<1|i<<2;let r=s[n];return void 0===r&&(r=new ws({depthPacking:oi,morphTargets:t,skinning:e}),s[n]=r),r}function T(t,e,i){const n=t<<0|e<<1|i<<2;let r=l[n];return void 0===r&&(r=new Ms({morphTargets:t,skinning:e}),l[n]=r),r}function S(e,i,n,r,o,a,s){let l=null,u=M,d=e.customDepthMaterial;if(!0===r.isPointLight&&(u=T,d=e.customDistanceMaterial),void 0===d){let t=!1;!0===n.morphTargets&&(t=i.morphAttributes&&i.morphAttributes.position&&i.morphAttributes.position.length>0);let r=!1;!0===e.isSkinnedMesh&&(!0===n.skinning?r=!0:console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",e));l=u(t,r,!0===e.isInstancedMesh)}else l=d;if(t.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length){const t=l.uuid,e=n.uuid;let i=c[t];void 0===i&&(i={},c[t]=i);let r=i[e];void 0===r&&(r=l.clone(),i[e]=r),l=r}return l.visible=n.visible,l.wireframe=n.wireframe,l.side=s===p?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:h[n.side],l.clipShadows=n.clipShadows,l.clippingPlanes=n.clippingPlanes,l.clipIntersection=n.clipIntersection,l.wireframeLinewidth=n.wireframeLinewidth,l.linewidth=n.linewidth,!0===r.isPointLight&&!0===l.isMeshDistanceMaterial&&(l.referencePosition.setFromMatrixPosition(r.matrixWorld),l.nearDistance=o,l.farDistance=a),l}function E(i,r,o,a,s){if(!1===i.visible)return;if(i.layers.test(r.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&s===p)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,i.matrixWorld);const n=e.update(i),r=i.material;if(Array.isArray(r)){const e=n.groups;for(let l=0,c=e.length;l<c;l++){const c=e[l],h=r[c.materialIndex];if(h&&h.visible){const e=S(i,n,h,a,o.near,o.far,s);t.renderBufferDirect(o,null,n,e,i,c)}}}else if(r.visible){const e=S(i,n,r,a,o.near,o.far,s);t.renderBufferDirect(o,null,n,e,i,null)}}const l=i.children;for(let t=0,e=l.length;t<e;t++)E(l[t],r,o,a,s)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=u,this.render=function(e,s,l){if(!1===b.enabled)return;if(!1===b.autoUpdate&&!1===b.needsUpdate)return;if(0===e.length)return;const c=t.getRenderTarget(),h=t.getActiveCubeFace(),u=t.getActiveMipmapLevel(),d=t.state;d.setBlending(v),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(let c=0,h=e.length;c<h;c++){const h=e[c],u=h.shadow;if(void 0===u){console.warn("THREE.WebGLShadowMap:",h,"has no shadow.");continue}if(!1===u.autoUpdate&&!1===u.needsUpdate)continue;r.copy(u.mapSize);const f=u.getFrameExtents();if(r.multiply(f),o.copy(u.mapSize),(r.x>i||r.y>i)&&(r.x>i&&(o.x=Math.floor(i/f.x),r.x=o.x*f.x,u.mapSize.x=o.x),r.y>i&&(o.y=Math.floor(i/f.y),r.y=o.y*f.y,u.mapSize.y=o.y)),null===u.map&&!u.isPointLightShadow&&this.type===p){const t={minFilter:vt,magFilter:vt,format:Ft};u.map=new qi(r.x,r.y,t),u.map.texture.name=h.name+".shadowMap",u.mapPass=new qi(r.x,r.y,t),u.camera.updateProjectionMatrix()}if(null===u.map){const t={minFilter:ft,magFilter:ft,format:Ft};u.map=new qi(r.x,r.y,t),u.map.texture.name=h.name+".shadowMap",u.camera.updateProjectionMatrix()}t.setRenderTarget(u.map),t.clear();const m=u.getViewportCount();for(let t=0;t<m;t++){const e=u.getViewport(t);a.set(o.x*e.x,o.y*e.y,o.x*e.z,o.y*e.w),d.viewport(a),u.updateMatrices(h,t),n=u.getFrustum(),E(s,l,u.camera,h,this.type)}u.isPointLightShadow||this.type!==p||w(u,l),u.needsUpdate=!1}b.needsUpdate=!1,t.setRenderTarget(c,h,u)}}function Ss(t,e,i){const n=i.isWebGL2;const r=new function(){let e=!1;const i=new Wi;let n=null;const r=new Wi(0,0,0,0);return{setMask:function(i){n===i||e||(t.colorMask(i,i,i,i),n=i)},setLocked:function(t){e=t},setClear:function(e,n,o,a,s){!0===s&&(e*=a,n*=a,o*=a),i.set(e,n,o,a),!1===r.equals(i)&&(t.clearColor(e,n,o,a),r.copy(i))},reset:function(){e=!1,n=null,r.set(-1,0,0,0)}}},o=new function(){let e=!1,i=null,n=null,r=null;return{setTest:function(t){t?ft(2929):mt(2929)},setMask:function(n){i===n||e||(t.depthMask(n),i=n)},setFunc:function(e){if(n!==e){if(e)switch(e){case G:t.depthFunc(512);break;case U:t.depthFunc(519);break;case V:t.depthFunc(513);break;case H:t.depthFunc(515);break;case Z:t.depthFunc(514);break;case W:t.depthFunc(518);break;case q:t.depthFunc(516);break;case X:t.depthFunc(517);break;default:t.depthFunc(515)}else t.depthFunc(515);n=e}},setLocked:function(t){e=t},setClear:function(e){r!==e&&(t.clearDepth(e),r=e)},reset:function(){e=!1,i=null,n=null,r=null}}},c=new function(){let e=!1,i=null,n=null,r=null,o=null,a=null,s=null,l=null,c=null;return{setTest:function(t){e||(t?ft(2960):mt(2960))},setMask:function(n){i===n||e||(t.stencilMask(n),i=n)},setFunc:function(e,i,a){n===e&&r===i&&o===a||(t.stencilFunc(e,i,a),n=e,r=i,o=a)},setOp:function(e,i,n){a===e&&s===i&&l===n||(t.stencilOp(e,i,n),a=e,s=i,l=n)},setLocked:function(t){e=t},setClear:function(e){c!==e&&(t.clearStencil(e),c=e)},reset:function(){e=!1,i=null,n=null,r=null,o=null,a=null,s=null,l=null,c=null}}};let h={},u=null,d=null,p=null,f=null,y=null,_=null,Y=null,$=null,J=null,K=!1,Q=null,tt=null,et=null,it=null,nt=null;const rt=t.getParameter(35661);let ot=!1,at=0;const st=t.getParameter(7938);-1!==st.indexOf("WebGL")?(at=parseFloat(/^WebGL (\d)/.exec(st)[1]),ot=at>=1):-1!==st.indexOf("OpenGL ES")&&(at=parseFloat(/^OpenGL ES (\d)/.exec(st)[1]),ot=at>=2);let lt=null,ct={};const ht=new Wi,ut=new Wi;function dt(e,i,n){const r=new Uint8Array(4),o=t.createTexture();t.bindTexture(e,o),t.texParameteri(e,10241,9728),t.texParameteri(e,10240,9728);for(let e=0;e<n;e++)t.texImage2D(i+e,0,6408,1,1,0,6408,5121,r);return o}const pt={};function ft(e){!0!==h[e]&&(t.enable(e),h[e]=!0)}function mt(e){!1!==h[e]&&(t.disable(e),h[e]=!1)}pt[3553]=dt(3553,3553,1),pt[34067]=dt(34067,34069,6),r.setClear(0,0,0,1),o.setClear(1),c.setClear(0),ft(2929),o.setFunc(H),vt(!1),xt(s),ft(2884),_t(v);const gt={[S]:32774,[E]:32778,[C]:32779};if(n)gt[A]=32775,gt[P]=32776;else{const t=e.get("EXT_blend_minmax");null!==t&&(gt[A]=t.MIN_EXT,gt[P]=t.MAX_EXT)}const yt={[L]:0,[I]:1,[R]:768,[k]:770,[j]:776,[F]:774,[z]:772,[D]:769,[O]:771,[N]:775,[B]:773};function _t(e,i,n,r,o,a,s,l){if(e!==v){if(d||(ft(3042),d=!0),e===T)o=o||i,a=a||n,s=s||r,i===f&&o===Y||(t.blendEquationSeparate(gt[i],gt[o]),f=i,Y=o),n===y&&r===_&&a===$&&s===J||(t.blendFuncSeparate(yt[n],yt[r],yt[a],yt[s]),y=n,_=r,$=a,J=s),p=e,K=null;else if(e!==p||l!==K){if(f===S&&Y===S||(t.blendEquation(32774),f=S,Y=S),l)switch(e){case x:t.blendFuncSeparate(1,771,1,771);break;case b:t.blendFunc(1,1);break;case w:t.blendFuncSeparate(0,0,769,771);break;case M:t.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case x:t.blendFuncSeparate(770,771,1,771);break;case b:t.blendFunc(770,1);break;case w:t.blendFunc(0,769);break;case M:t.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}y=null,_=null,$=null,J=null,p=e,K=l}}else d&&(mt(3042),d=!1)}function vt(e){Q!==e&&(e?t.frontFace(2304):t.frontFace(2305),Q=e)}function xt(e){e!==a?(ft(2884),e!==tt&&(e===s?t.cullFace(1029):e===l?t.cullFace(1028):t.cullFace(1032))):mt(2884),tt=e}function bt(e,i,n){e?(ft(32823),it===i&&nt===n||(t.polygonOffset(i,n),it=i,nt=n)):mt(32823)}function wt(e){void 0===e&&(e=33984+rt-1),lt!==e&&(t.activeTexture(e),lt=e)}return{buffers:{color:r,depth:o,stencil:c},enable:ft,disable:mt,useProgram:function(e){return u!==e&&(t.useProgram(e),u=e,!0)},setBlending:_t,setMaterial:function(t,e){t.side===g?mt(2884):ft(2884);let i=t.side===m;e&&(i=!i),vt(i),t.blending===x&&!1===t.transparent?_t(v):_t(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha),o.setFunc(t.depthFunc),o.setTest(t.depthTest),o.setMask(t.depthWrite),r.setMask(t.colorWrite);const n=t.stencilWrite;c.setTest(n),n&&(c.setMask(t.stencilWriteMask),c.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),c.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),bt(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)},setFlipSided:vt,setCullFace:xt,setLineWidth:function(e){e!==et&&(ot&&t.lineWidth(e),et=e)},setPolygonOffset:bt,setScissorTest:function(t){t?ft(3089):mt(3089)},activeTexture:wt,bindTexture:function(e,i){null===lt&&wt();let n=ct[lt];void 0===n&&(n={type:void 0,texture:void 0},ct[lt]=n),n.type===e&&n.texture===i||(t.bindTexture(e,i||pt[e]),n.type=e,n.texture=i)},unbindTexture:function(){const e=ct[lt];void 0!==e&&void 0!==e.type&&(t.bindTexture(e.type,null),e.type=void 0,e.texture=void 0)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage3D:function(){try{t.texImage3D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},scissor:function(e){!1===ht.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),ht.copy(e))},viewport:function(e){!1===ut.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),ut.copy(e))},reset:function(){h={},lt=null,ct={},u=null,d=null,p=null,f=null,y=null,_=null,Y=null,$=null,J=null,K=!1,Q=null,tt=null,et=null,it=null,nt=null,r.reset(),o.reset(),c.reset()}}}function Es(t,e,i,n,r,o,a){const s=r.isWebGL2,l=r.maxTextures,c=r.maxCubemapSize,h=r.maxTextureSize,u=r.maxSamples,d=new WeakMap;let p,f=!1;try{f="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(t){}function m(t,e){return f?new OffscreenCanvas(t,e):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function g(t,e,i,n){let r=1;if((t.width>n||t.height>n)&&(r=n/Math.max(t.width,t.height)),r<1||!0===e){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const n=e?Fi.floorPowerOfTwo:Math.floor,o=n(r*t.width),a=n(r*t.height);void 0===p&&(p=m(o,a));const s=i?m(o,a):p;s.width=o,s.height=a;return s.getContext("2d").drawImage(t,0,0,o,a),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+t.width+"x"+t.height+") to ("+o+"x"+a+")."),s}return"data"in t&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+t.width+"x"+t.height+")."),t}return t}function y(t){return Fi.isPowerOfTwo(t.width)&&Fi.isPowerOfTwo(t.height)}function _(t,e){return t.generateMipmaps&&e&&t.minFilter!==ft&&t.minFilter!==vt}function v(e,i,r,o){t.generateMipmap(e);n.get(i).__maxMipLevel=Math.log(Math.max(r,o))*Math.LOG2E}function x(i,n,r){if(!1===s)return n;if(null!==i){if(void 0!==t[i])return t[i];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let o=n;return 6403===n&&(5126===r&&(o=33326),5131===r&&(o=33325),5121===r&&(o=33321)),6407===n&&(5126===r&&(o=34837),5131===r&&(o=34843),5121===r&&(o=32849)),6408===n&&(5126===r&&(o=34836),5131===r&&(o=34842),5121===r&&(o=32856)),33325!==o&&33326!==o&&34842!==o&&34836!==o||e.get("EXT_color_buffer_float"),o}function b(t){return t===ft||t===mt||t===yt?9728:9729}function w(e){const i=e.target;i.removeEventListener("dispose",w),function(e){const i=n.get(e);if(void 0===i.__webglInit)return;t.deleteTexture(i.__webglTexture),n.remove(e)}(i),i.isVideoTexture&&d.delete(i),a.memory.textures--}function M(e){const i=e.target;i.removeEventListener("dispose",M),function(e){const i=n.get(e),r=n.get(e.texture);if(!e)return;void 0!==r.__webglTexture&&t.deleteTexture(r.__webglTexture);e.depthTexture&&e.depthTexture.dispose();if(e.isWebGLCubeRenderTarget)for(let e=0;e<6;e++)t.deleteFramebuffer(i.__webglFramebuffer[e]),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer[e]);else t.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&t.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer&&t.deleteRenderbuffer(i.__webglColorRenderbuffer),i.__webglDepthRenderbuffer&&t.deleteRenderbuffer(i.__webglDepthRenderbuffer);n.remove(e.texture),n.remove(e)}(i),a.memory.textures--}let T=0;function S(t,e){const r=n.get(t);if(t.isVideoTexture&&function(t){const e=a.render.frame;d.get(t)!==e&&(d.set(t,e),t.update())}(t),t.version>0&&r.__version!==t.version){const i=t.image;if(void 0===i)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else{if(!1!==i.complete)return void I(r,t,e);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}i.activeTexture(33984+e),i.bindTexture(3553,r.__webglTexture)}function E(e,r){const a=n.get(e);e.version>0&&a.__version!==e.version?function(e,n,r){if(6!==n.image.length)return;L(e,n),i.activeTexture(33984+r),i.bindTexture(34067,e.__webglTexture),t.pixelStorei(37440,n.flipY),t.pixelStorei(37441,n.premultiplyAlpha),t.pixelStorei(3317,n.unpackAlignment);const a=n&&(n.isCompressedTexture||n.image[0].isCompressedTexture),l=n.image[0]&&n.image[0].isDataTexture,h=[];for(let t=0;t<6;t++)h[t]=a||l?l?n.image[t].image:n.image[t]:g(n.image[t],!1,!0,c);const u=h[0],d=y(u)||s,p=o.convert(n.format),f=o.convert(n.type),m=x(n.internalFormat,p,f);let b;if(P(34067,n,d),a){for(let t=0;t<6;t++){b=h[t].mipmaps;for(let e=0;e<b.length;e++){const r=b[e];n.format!==Ft&&n.format!==Bt?null!==p?i.compressedTexImage2D(34069+t,e,m,r.width,r.height,0,r.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(34069+t,e,m,r.width,r.height,0,p,f,r.data)}}e.__maxMipLevel=b.length-1}else{b=n.mipmaps;for(let t=0;t<6;t++)if(l){i.texImage2D(34069+t,0,m,h[t].width,h[t].height,0,p,f,h[t].data);for(let e=0;e<b.length;e++){const n=b[e].image[t].image;i.texImage2D(34069+t,e+1,m,n.width,n.height,0,p,f,n.data)}}else{i.texImage2D(34069+t,0,m,p,f,h[t]);for(let e=0;e<b.length;e++){const n=b[e];i.texImage2D(34069+t,e+1,m,p,f,n.image[t])}}e.__maxMipLevel=b.length}_(n,d)&&v(34067,n,u.width,u.height);e.__version=n.version,n.onUpdate&&n.onUpdate(n)}(a,e,r):(i.activeTexture(33984+r),i.bindTexture(34067,a.__webglTexture))}const C={[ut]:10497,[dt]:33071,[pt]:33648},A={[ft]:9728,[mt]:9984,[yt]:9986,[vt]:9729,[xt]:9985,[wt]:9987};function P(i,o,a){a?(t.texParameteri(i,10242,C[o.wrapS]),t.texParameteri(i,10243,C[o.wrapT]),32879!==i&&35866!==i||t.texParameteri(i,32882,C[o.wrapR]),t.texParameteri(i,10240,A[o.magFilter]),t.texParameteri(i,10241,A[o.minFilter])):(t.texParameteri(i,10242,33071),t.texParameteri(i,10243,33071),32879!==i&&35866!==i||t.texParameteri(i,32882,33071),o.wrapS===dt&&o.wrapT===dt||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),t.texParameteri(i,10240,b(o.magFilter)),t.texParameteri(i,10241,b(o.minFilter)),o.minFilter!==ft&&o.minFilter!==vt&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter."));const l=e.get("EXT_texture_filter_anisotropic");if(l){if(o.type===Lt&&null===e.get("OES_texture_float_linear"))return;if(o.type===It&&null===(s||e.get("OES_texture_half_float_linear")))return;(o.anisotropy>1||n.get(o).__currentAnisotropy)&&(t.texParameterf(i,l.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o.anisotropy,r.getMaxAnisotropy())),n.get(o).__currentAnisotropy=o.anisotropy)}}function L(e,i){void 0===e.__webglInit&&(e.__webglInit=!0,i.addEventListener("dispose",w),e.__webglTexture=t.createTexture(),a.memory.textures++)}function I(e,n,r){let a=3553;n.isDataTexture2DArray&&(a=35866),n.isDataTexture3D&&(a=32879),L(e,n),i.activeTexture(33984+r),i.bindTexture(a,e.__webglTexture),t.pixelStorei(37440,n.flipY),t.pixelStorei(37441,n.premultiplyAlpha),t.pixelStorei(3317,n.unpackAlignment);const l=function(t){return!s&&(t.wrapS!==dt||t.wrapT!==dt||t.minFilter!==ft&&t.minFilter!==vt)}(n)&&!1===y(n.image),c=g(n.image,l,!1,h),u=y(c)||s,d=o.convert(n.format);let p,f=o.convert(n.type),m=x(n.internalFormat,d,f);P(a,n,u);const b=n.mipmaps;if(n.isDepthTexture)m=6402,s?m=n.type===Lt?36012:n.type===Pt?33190:n.type===Ot?35056:33189:n.type===Lt&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),n.format===Ut&&6402===m&&n.type!==Ct&&n.type!==Pt&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=Ct,f=o.convert(n.type)),n.format===Vt&&6402===m&&(m=34041,n.type!==Ot&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=Ot,f=o.convert(n.type))),i.texImage2D(3553,0,m,c.width,c.height,0,d,f,null);else if(n.isDataTexture)if(b.length>0&&u){for(let t=0,e=b.length;t<e;t++)p=b[t],i.texImage2D(3553,t,m,p.width,p.height,0,d,f,p.data);n.generateMipmaps=!1,e.__maxMipLevel=b.length-1}else i.texImage2D(3553,0,m,c.width,c.height,0,d,f,c.data),e.__maxMipLevel=0;else if(n.isCompressedTexture){for(let t=0,e=b.length;t<e;t++)p=b[t],n.format!==Ft&&n.format!==Bt?null!==d?i.compressedTexImage2D(3553,t,m,p.width,p.height,0,p.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(3553,t,m,p.width,p.height,0,d,f,p.data);e.__maxMipLevel=b.length-1}else if(n.isDataTexture2DArray)i.texImage3D(35866,0,m,c.width,c.height,c.depth,0,d,f,c.data),e.__maxMipLevel=0;else if(n.isDataTexture3D)i.texImage3D(32879,0,m,c.width,c.height,c.depth,0,d,f,c.data),e.__maxMipLevel=0;else if(b.length>0&&u){for(let t=0,e=b.length;t<e;t++)p=b[t],i.texImage2D(3553,t,m,d,f,p);n.generateMipmaps=!1,e.__maxMipLevel=b.length-1}else i.texImage2D(3553,0,m,d,f,c),e.__maxMipLevel=0;_(n,u)&&v(a,n,c.width,c.height),e.__version=n.version,n.onUpdate&&n.onUpdate(n)}function R(e,r,a,s){const l=o.convert(r.texture.format),c=o.convert(r.texture.type),h=x(r.texture.internalFormat,l,c);i.texImage2D(s,0,h,r.width,r.height,0,l,c,null),t.bindFramebuffer(36160,e),t.framebufferTexture2D(36160,a,s,n.get(r.texture).__webglTexture,0),t.bindFramebuffer(36160,null)}function D(e,i,n){if(t.bindRenderbuffer(36161,e),i.depthBuffer&&!i.stencilBuffer){let r=33189;if(n){const e=i.depthTexture;e&&e.isDepthTexture&&(e.type===Lt?r=36012:e.type===Pt&&(r=33190));const n=O(i);t.renderbufferStorageMultisample(36161,n,r,i.width,i.height)}else t.renderbufferStorage(36161,r,i.width,i.height);t.framebufferRenderbuffer(36160,36096,36161,e)}else if(i.depthBuffer&&i.stencilBuffer){if(n){const e=O(i);t.renderbufferStorageMultisample(36161,e,35056,i.width,i.height)}else t.renderbufferStorage(36161,34041,i.width,i.height);t.framebufferRenderbuffer(36160,33306,36161,e)}else{const e=o.convert(i.texture.format),r=o.convert(i.texture.type),a=x(i.texture.internalFormat,e,r);if(n){const e=O(i);t.renderbufferStorageMultisample(36161,e,a,i.width,i.height)}else t.renderbufferStorage(36161,a,i.width,i.height)}t.bindRenderbuffer(36161,null)}function k(e){const i=n.get(e),r=!0===e.isWebGLCubeRenderTarget;if(e.depthTexture){if(r)throw new Error("target.depthTexture not supported in Cube render targets");!function(e,i){if(i&&i.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(36160,e),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(i.depthTexture).__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),S(i.depthTexture,0);const r=n.get(i.depthTexture).__webglTexture;if(i.depthTexture.format===Ut)t.framebufferTexture2D(36160,36096,3553,r,0);else{if(i.depthTexture.format!==Vt)throw new Error("Unknown depthTexture format");t.framebufferTexture2D(36160,33306,3553,r,0)}}(i.__webglFramebuffer,e)}else if(r){i.__webglDepthbuffer=[];for(let n=0;n<6;n++)t.bindFramebuffer(36160,i.__webglFramebuffer[n]),i.__webglDepthbuffer[n]=t.createRenderbuffer(),D(i.__webglDepthbuffer[n],e,!1)}else t.bindFramebuffer(36160,i.__webglFramebuffer),i.__webglDepthbuffer=t.createRenderbuffer(),D(i.__webglDepthbuffer,e,!1);t.bindFramebuffer(36160,null)}function O(t){return s&&t.isWebGLMultisampleRenderTarget?Math.min(u,t.samples):0}let z=!1,B=!1;this.allocateTextureUnit=function(){const t=T;return t>=l&&console.warn("THREE.WebGLTextures: Trying to use "+t+" texture units while this GPU supports only "+l),T+=1,t},this.resetTextureUnits=function(){T=0},this.setTexture2D=S,this.setTexture2DArray=function(t,e){const r=n.get(t);t.version>0&&r.__version!==t.version?I(r,t,e):(i.activeTexture(33984+e),i.bindTexture(35866,r.__webglTexture))},this.setTexture3D=function(t,e){const r=n.get(t);t.version>0&&r.__version!==t.version?I(r,t,e):(i.activeTexture(33984+e),i.bindTexture(32879,r.__webglTexture))},this.setTextureCube=E,this.setupRenderTarget=function(e){const r=n.get(e),l=n.get(e.texture);e.addEventListener("dispose",M),l.__webglTexture=t.createTexture(),a.memory.textures++;const c=!0===e.isWebGLCubeRenderTarget,h=!0===e.isWebGLMultisampleRenderTarget,u=y(e)||s;if(!s||e.texture.format!==Bt||e.texture.type!==Lt&&e.texture.type!==It||(e.texture.format=Ft,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),c){r.__webglFramebuffer=[];for(let e=0;e<6;e++)r.__webglFramebuffer[e]=t.createFramebuffer()}else if(r.__webglFramebuffer=t.createFramebuffer(),h)if(s){r.__webglMultisampledFramebuffer=t.createFramebuffer(),r.__webglColorRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,r.__webglColorRenderbuffer);const i=o.convert(e.texture.format),n=o.convert(e.texture.type),a=x(e.texture.internalFormat,i,n),s=O(e);t.renderbufferStorageMultisample(36161,s,a,e.width,e.height),t.bindFramebuffer(36160,r.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(36160,36064,36161,r.__webglColorRenderbuffer),t.bindRenderbuffer(36161,null),e.depthBuffer&&(r.__webglDepthRenderbuffer=t.createRenderbuffer(),D(r.__webglDepthRenderbuffer,e,!0)),t.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(c){i.bindTexture(34067,l.__webglTexture),P(34067,e.texture,u);for(let t=0;t<6;t++)R(r.__webglFramebuffer[t],e,36064,34069+t);_(e.texture,u)&&v(34067,e.texture,e.width,e.height),i.bindTexture(34067,null)}else i.bindTexture(3553,l.__webglTexture),P(3553,e.texture,u),R(r.__webglFramebuffer,e,36064,3553),_(e.texture,u)&&v(3553,e.texture,e.width,e.height),i.bindTexture(3553,null);e.depthBuffer&&k(e)},this.updateRenderTargetMipmap=function(t){const e=t.texture;if(_(e,y(t)||s)){const r=t.isWebGLCubeRenderTarget?34067:3553,o=n.get(e).__webglTexture;i.bindTexture(r,o),v(r,e,t.width,t.height),i.bindTexture(r,null)}},this.updateMultisampleRenderTarget=function(e){if(e.isWebGLMultisampleRenderTarget)if(s){const i=n.get(e);t.bindFramebuffer(36008,i.__webglMultisampledFramebuffer),t.bindFramebuffer(36009,i.__webglFramebuffer);const r=e.width,o=e.height;let a=16384;e.depthBuffer&&(a|=256),e.stencilBuffer&&(a|=1024),t.blitFramebuffer(0,0,r,o,0,0,r,o,a,9728),t.bindFramebuffer(36160,i.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")},this.safeSetTexture2D=function(t,e){t&&t.isWebGLRenderTarget&&(!1===z&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),z=!0),t=t.texture),S(t,e)},this.safeSetTextureCube=function(t,e){t&&t.isWebGLCubeRenderTarget&&(!1===B&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),B=!0),t=t.texture),E(t,e)}}function Cs(t,e,i){const n=i.isWebGL2;return{convert:function(t){let i;if(t===Tt)return 5121;if(t===Rt)return 32819;if(t===Dt)return 32820;if(t===kt)return 33635;if(t===St)return 5120;if(t===Et)return 5122;if(t===Ct)return 5123;if(t===At)return 5124;if(t===Pt)return 5125;if(t===Lt)return 5126;if(t===It)return n?5131:(i=e.get("OES_texture_half_float"),null!==i?i.HALF_FLOAT_OES:null);if(t===zt)return 6406;if(t===Bt)return 6407;if(t===Ft)return 6408;if(t===Nt)return 6409;if(t===jt)return 6410;if(t===Ut)return 6402;if(t===Vt)return 34041;if(t===Ht)return 6403;if(t===Zt)return 36244;if(t===Wt)return 33319;if(t===qt)return 33320;if(t===Xt)return 36248;if(t===Yt)return 36249;if(t===$t||t===Jt||t===Kt||t===Qt){if(i=e.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(t===$t)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===Jt)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===Kt)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===Qt)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(t===te||t===ee||t===ie||t===ne){if(i=e.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(t===te)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===ee)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===ie)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(t===ne)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(t===re)return i=e.get("WEBGL_compressed_texture_etc1"),null!==i?i.COMPRESSED_RGB_ETC1_WEBGL:null;if((t===oe||t===ae)&&(i=e.get("WEBGL_compressed_texture_etc"),null!==i)){if(t===oe)return i.COMPRESSED_RGB8_ETC2;if(t===ae)return i.COMPRESSED_RGBA8_ETC2_EAC}return t===se||t===le||t===ce||t===he||t===ue||t===de||t===pe||t===fe||t===me||t===ge||t===ye||t===_e||t===ve||t===xe||t===we||t===Me||t===Te||t===Se||t===Ee||t===Ce||t===Ae||t===Pe||t===Le||t===Ie||t===Re||t===De||t===ke||t===Oe?(i=e.get("WEBGL_compressed_texture_astc"),null!==i?t:null):t===be?(i=e.get("EXT_texture_compression_bptc"),null!==i?t:null):t===Ot?n?34042:(i=e.get("WEBGL_depth_texture"),null!==i?i.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}function As(t=[]){vo.call(this),this.cameras=t}function Ps(){$n.call(this),this.type="Group"}function Ls(){this._targetRay=null,this._grip=null,this._hand=null}function Is(t,e){const i=this;let n=null,r=1,o=null,a="local-floor",s=null;const l=[],c=new Map,h=new vo;h.layers.enable(1),h.viewport=new Wi;const u=new vo;u.layers.enable(2),u.viewport=new Wi;const d=[h,u],p=new As;p.layers.enable(1),p.layers.enable(2);let f=null,m=null;function g(t){const e=c.get(t.inputSource);e&&e.dispatchEvent({type:t.type,data:t.inputSource})}function y(){c.forEach((function(t,e){t.disconnect(e)})),c.clear(),f=null,m=null,t.setFramebuffer(null),t.setRenderTarget(t.getRenderTarget()),M.stop(),i.isPresenting=!1,i.dispatchEvent({type:"sessionend"})}function _(t){const e=n.inputSources;for(let t=0;t<l.length;t++)c.set(e[t],l[t]);for(let e=0;e<t.removed.length;e++){const i=t.removed[e],n=c.get(i);n&&(n.dispatchEvent({type:"disconnected",data:i}),c.delete(i))}for(let e=0;e<t.added.length;e++){const i=t.added[e],n=c.get(i);n&&n.dispatchEvent({type:"connected",data:i})}}this.enabled=!1,this.isPresenting=!1,this.getController=function(t){let e=l[t];return void 0===e&&(e=new Ls,l[t]=e),e.getTargetRaySpace()},this.getControllerGrip=function(t){let e=l[t];return void 0===e&&(e=new Ls,l[t]=e),e.getGripSpace()},this.getHand=function(t){let e=l[t];return void 0===e&&(e=new Ls,l[t]=e),e.getHandSpace()},this.setFramebufferScaleFactor=function(t){r=t,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(t){a=t,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return o},this.getSession=function(){return n},this.setSession=async function(t){if(n=t,null!==n){n.addEventListener("select",g),n.addEventListener("selectstart",g),n.addEventListener("selectend",g),n.addEventListener("squeeze",g),n.addEventListener("squeezestart",g),n.addEventListener("squeezeend",g),n.addEventListener("end",y),n.addEventListener("inputsourceschange",_);const t=e.getContextAttributes();!0!==t.xrCompatible&&await e.makeXRCompatible();const s={antialias:t.antialias,alpha:t.alpha,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:r},l=new XRWebGLLayer(n,e,s);n.updateRenderState({baseLayer:l}),o=await n.requestReferenceSpace(a),M.setContext(n),M.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}};const v=new $i,x=new $i;function b(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.copy(t.matrixWorld).invert()}this.getCamera=function(t){p.near=u.near=h.near=t.near,p.far=u.far=h.far=t.far,f===p.near&&m===p.far||(n.updateRenderState({depthNear:p.near,depthFar:p.far}),f=p.near,m=p.far);const e=t.parent,i=p.cameras;b(p,e);for(let t=0;t<i.length;t++)b(i[t],e);t.matrixWorld.copy(p.matrixWorld),t.matrix.copy(p.matrix),t.matrix.decompose(t.position,t.quaternion,t.scale);const r=t.children;for(let t=0,e=r.length;t<e;t++)r[t].updateMatrixWorld(!0);return 2===i.length?function(t,e,i){v.setFromMatrixPosition(e.matrixWorld),x.setFromMatrixPosition(i.matrixWorld);const n=v.distanceTo(x),r=e.projectionMatrix.elements,o=i.projectionMatrix.elements,a=r[14]/(r[10]-1),s=r[14]/(r[10]+1),l=(r[9]+1)/r[5],c=(r[9]-1)/r[5],h=(r[8]-1)/r[0],u=(o[8]+1)/o[0],d=a*h,p=a*u,f=n/(-h+u),m=f*-h;e.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(m),t.translateZ(f),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.copy(t.matrixWorld).invert();const g=a+f,y=s+f,_=d-m,b=p+(n-m),w=l*s/y*g,M=c*s/y*g;t.projectionMatrix.makePerspective(_,b,w,M,g,y)}(p,h,u):p.projectionMatrix.copy(h.projectionMatrix),p};let w=null;const M=new Co;M.setAnimationLoop((function(e,i){if(s=i.getViewerPose(o),null!==s){const e=s.views,i=n.renderState.baseLayer;t.setFramebuffer(i.framebuffer);let r=!1;e.length!==p.cameras.length&&(p.cameras.length=0,r=!0);for(let t=0;t<e.length;t++){const n=e[t],o=i.getViewport(n),a=d[t];a.matrix.fromArray(n.transform.matrix),a.projectionMatrix.fromArray(n.projectionMatrix),a.viewport.set(o.x,o.y,o.width,o.height),0===t&&p.matrix.copy(a.matrix),!0===r&&p.cameras.push(a)}}const r=n.inputSources;for(let t=0;t<l.length;t++){const e=l[t],n=r[t];e.update(n,i,o)}w&&w(e,i)})),this.setAnimationLoop=function(t){w=t},this.dispose=function(){}}function Rs(t){function e(e,i){e.opacity.value=i.opacity,i.color&&e.diffuse.value.copy(i.color),i.emissive&&e.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(e.map.value=i.map),i.alphaMap&&(e.alphaMap.value=i.alphaMap),i.specularMap&&(e.specularMap.value=i.specularMap);const n=t.get(i).envMap;if(n){e.envMap.value=n,e.flipEnvMap.value=n.isCubeTexture&&n._needsFlipEnvMap?-1:1,e.reflectivity.value=i.reflectivity,e.refractionRatio.value=i.refractionRatio;const r=t.get(n).__maxMipLevel;void 0!==r&&(e.maxMipLevel.value=r)}let r,o;i.lightMap&&(e.lightMap.value=i.lightMap,e.lightMapIntensity.value=i.lightMapIntensity),i.aoMap&&(e.aoMap.value=i.aoMap,e.aoMapIntensity.value=i.aoMapIntensity),i.map?r=i.map:i.specularMap?r=i.specularMap:i.displacementMap?r=i.displacementMap:i.normalMap?r=i.normalMap:i.bumpMap?r=i.bumpMap:i.roughnessMap?r=i.roughnessMap:i.metalnessMap?r=i.metalnessMap:i.alphaMap?r=i.alphaMap:i.emissiveMap?r=i.emissiveMap:i.clearcoatMap?r=i.clearcoatMap:i.clearcoatNormalMap?r=i.clearcoatNormalMap:i.clearcoatRoughnessMap&&(r=i.clearcoatRoughnessMap),void 0!==r&&(r.isWebGLRenderTarget&&(r=r.texture),!0===r.matrixAutoUpdate&&r.updateMatrix(),e.uvTransform.value.copy(r.matrix)),i.aoMap?o=i.aoMap:i.lightMap&&(o=i.lightMap),void 0!==o&&(o.isWebGLRenderTarget&&(o=o.texture),!0===o.matrixAutoUpdate&&o.updateMatrix(),e.uv2Transform.value.copy(o.matrix))}function i(e,i){e.roughness.value=i.roughness,e.metalness.value=i.metalness,i.roughnessMap&&(e.roughnessMap.value=i.roughnessMap),i.metalnessMap&&(e.metalnessMap.value=i.metalnessMap),i.emissiveMap&&(e.emissiveMap.value=i.emissiveMap),i.bumpMap&&(e.bumpMap.value=i.bumpMap,e.bumpScale.value=i.bumpScale,i.side===m&&(e.bumpScale.value*=-1)),i.normalMap&&(e.normalMap.value=i.normalMap,e.normalScale.value.copy(i.normalScale),i.side===m&&e.normalScale.value.negate()),i.displacementMap&&(e.displacementMap.value=i.displacementMap,e.displacementScale.value=i.displacementScale,e.displacementBias.value=i.displacementBias);t.get(i).envMap&&(e.envMapIntensity.value=i.envMapIntensity)}return{refreshFogUniforms:function(t,e){t.fogColor.value.copy(e.color),e.isFog?(t.fogNear.value=e.near,t.fogFar.value=e.far):e.isFogExp2&&(t.fogDensity.value=e.density)},refreshMaterialUniforms:function(t,n,r,o){n.isMeshBasicMaterial?e(t,n):n.isMeshLambertMaterial?(e(t,n),function(t,e){e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap)}(t,n)):n.isMeshToonMaterial?(e(t,n),function(t,e){e.gradientMap&&(t.gradientMap.value=e.gradientMap);e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap);e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===m&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===m&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshPhongMaterial?(e(t,n),function(t,e){t.specular.value.copy(e.specular),t.shininess.value=Math.max(e.shininess,1e-4),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap);e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===m&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===m&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshStandardMaterial?(e(t,n),n.isMeshPhysicalMaterial?function(t,e){i(t,e),t.reflectivity.value=e.reflectivity,t.clearcoat.value=e.clearcoat,t.clearcoatRoughness.value=e.clearcoatRoughness,e.sheen&&t.sheen.value.copy(e.sheen);e.clearcoatMap&&(t.clearcoatMap.value=e.clearcoatMap);e.clearcoatRoughnessMap&&(t.clearcoatRoughnessMap.value=e.clearcoatRoughnessMap);e.clearcoatNormalMap&&(t.clearcoatNormalScale.value.copy(e.clearcoatNormalScale),t.clearcoatNormalMap.value=e.clearcoatNormalMap,e.side===m&&t.clearcoatNormalScale.value.negate());t.transmission.value=e.transmission,e.transmissionMap&&(t.transmissionMap.value=e.transmissionMap)}(t,n):i(t,n)):n.isMeshMatcapMaterial?(e(t,n),function(t,e){e.matcap&&(t.matcap.value=e.matcap);e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===m&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===m&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshDepthMaterial?(e(t,n),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isMeshDistanceMaterial?(e(t,n),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias);t.referencePosition.value.copy(e.referencePosition),t.nearDistance.value=e.nearDistance,t.farDistance.value=e.farDistance}(t,n)):n.isMeshNormalMaterial?(e(t,n),function(t,e){e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===m&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===m&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(t,n)):n.isLineBasicMaterial?(function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity}(t,n),n.isLineDashedMaterial&&function(t,e){t.dashSize.value=e.dashSize,t.totalSize.value=e.dashSize+e.gapSize,t.scale.value=e.scale}(t,n)):n.isPointsMaterial?function(t,e,i,n){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.size.value=e.size*i,t.scale.value=.5*n,e.map&&(t.map.value=e.map);e.alphaMap&&(t.alphaMap.value=e.alphaMap);let r;e.map?r=e.map:e.alphaMap&&(r=e.alphaMap);void 0!==r&&(!0===r.matrixAutoUpdate&&r.updateMatrix(),t.uvTransform.value.copy(r.matrix))}(t,n,r,o):n.isSpriteMaterial?function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.rotation.value=e.rotation,e.map&&(t.map.value=e.map);e.alphaMap&&(t.alphaMap.value=e.alphaMap);let i;e.map?i=e.map:e.alphaMap&&(i=e.alphaMap);void 0!==i&&(!0===i.matrixAutoUpdate&&i.updateMatrix(),t.uvTransform.value.copy(i.matrix))}(t,n):n.isShadowMaterial?(t.color.value.copy(n.color),t.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function Ds(t){const e=void 0!==(t=t||{}).canvas?t.canvas:function(){const t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return t.style.display="block",t}(),i=void 0!==t.context?t.context:null,n=void 0!==t.alpha&&t.alpha,r=void 0===t.depth||t.depth,o=void 0===t.stencil||t.stencil,a=void 0!==t.antialias&&t.antialias,s=void 0===t.premultipliedAlpha||t.premultipliedAlpha,l=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,c=void 0!==t.powerPreference?t.powerPreference:"default",h=void 0!==t.failIfMajorPerformanceCaveat&&t.failIfMajorPerformanceCaveat;let u=null,d=null;const p=[];this.domElement=e,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=$e,this.physicallyCorrectLights=!1,this.toneMapping=K,this.toneMappingExposure=1,this.maxMorphTargets=8,this.maxMorphNormals=4;const f=this;let m=!1,g=null,y=0,_=0,v=null,x=null,b=-1,w=null;const M=new Wi,T=new Wi;let S=null,E=e.width,C=e.height,A=1,P=null,L=null;const I=new Wi(0,0,E,C),R=new Wi(0,0,E,C);let D=!1;const k=new Eo;let O=!1,z=!1;const B=new Sn,F=new $i,N={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function j(){return null===v?A:1}let G,U,V,H,Z,W,q,X,Y,$,J,Q,tt,et,it,nt,rt,ot,at,st,lt,ct=i;function ht(t,i){for(let n=0;n<t.length;n++){const r=t[n],o=e.getContext(r,i);if(null!==o)return o}return null}try{const t={alpha:n,depth:r,stencil:o,antialias:a,premultipliedAlpha:s,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:h};if(e.addEventListener("webglcontextlost",ft,!1),e.addEventListener("webglcontextrestored",mt,!1),null===ct){const e=["webgl2","webgl","experimental-webgl"];if(!0===f.isWebGL1Renderer&&e.shift(),ct=ht(e,t),null===ct)throw ht(e)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===ct.getShaderPrecisionFormat&&(ct.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(t){throw console.error("THREE.WebGLRenderer: "+t.message),t}function ut(){G=new No(ct),U=new zo(ct,G,t),G.init(U),st=new Cs(ct,G,U),V=new Ss(ct,G,U),V.scissor(T.copy(R).multiplyScalar(A).floor()),V.viewport(M.copy(I).multiplyScalar(A).floor()),H=new Uo(ct),Z=new us,W=new Es(ct,G,V,Z,U,st,H),q=new Fo(f),X=new Ao(ct,U),lt=new ko(ct,G,X,U),Y=new jo(ct,X,H,lt),$=new Wo(ct,Y,X,H),rt=new Zo(ct),it=new Bo(Z),J=new hs(f,q,G,U,lt,it),Q=new Rs(Z),tt=new ms(Z),et=new bs(G,U),nt=new Do(f,q,V,$,s),ot=new Oo(ct,G,H,U),at=new Go(ct,G,H,U),H.programs=J.programs,f.capabilities=U,f.extensions=G,f.properties=Z,f.renderLists=tt,f.state=V,f.info=H}ut();const dt=new Is(f,ct);this.xr=dt;const pt=new Ts(f,$,U.maxTextureSize);function ft(t){t.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),m=!0}function mt(){console.log("THREE.WebGLRenderer: Context Restored."),m=!1,ut()}function gt(t){const e=t.target;e.removeEventListener("dispose",gt),function(t){yt(t),Z.remove(t)}(e)}function yt(t){const e=Z.get(t).program;void 0!==e&&J.releaseProgram(e)}this.shadowMap=pt,this.getContext=function(){return ct},this.getContextAttributes=function(){return ct.getContextAttributes()},this.forceContextLoss=function(){const t=G.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){const t=G.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return A},this.setPixelRatio=function(t){void 0!==t&&(A=t,this.setSize(E,C,!1))},this.getSize=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),t=new Ni),t.set(E,C)},this.setSize=function(t,i,n){dt.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(E=t,C=i,e.width=Math.floor(t*A),e.height=Math.floor(i*A),!1!==n&&(e.style.width=t+"px",e.style.height=i+"px"),this.setViewport(0,0,t,i))},this.getDrawingBufferSize=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),t=new Ni),t.set(E*A,C*A).floor()},this.setDrawingBufferSize=function(t,i,n){E=t,C=i,A=n,e.width=Math.floor(t*n),e.height=Math.floor(i*n),this.setViewport(0,0,t,i)},this.getCurrentViewport=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),t=new Wi),t.copy(M)},this.getViewport=function(t){return t.copy(I)},this.setViewport=function(t,e,i,n){t.isVector4?I.set(t.x,t.y,t.z,t.w):I.set(t,e,i,n),V.viewport(M.copy(I).multiplyScalar(A).floor())},this.getScissor=function(t){return t.copy(R)},this.setScissor=function(t,e,i,n){t.isVector4?R.set(t.x,t.y,t.z,t.w):R.set(t,e,i,n),V.scissor(T.copy(R).multiplyScalar(A).floor())},this.getScissorTest=function(){return D},this.setScissorTest=function(t){V.setScissorTest(D=t)},this.setOpaqueSort=function(t){P=t},this.setTransparentSort=function(t){L=t},this.getClearColor=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getClearColor() now requires a Color as an argument"),t=new _r),t.copy(nt.getClearColor())},this.setClearColor=function(){nt.setClearColor.apply(nt,arguments)},this.getClearAlpha=function(){return nt.getClearAlpha()},this.setClearAlpha=function(){nt.setClearAlpha.apply(nt,arguments)},this.clear=function(t,e,i){let n=0;(void 0===t||t)&&(n|=16384),(void 0===e||e)&&(n|=256),(void 0===i||i)&&(n|=1024),ct.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",ft,!1),e.removeEventListener("webglcontextrestored",mt,!1),tt.dispose(),et.dispose(),Z.dispose(),q.dispose(),$.dispose(),lt.dispose(),dt.dispose(),vt.stop()},this.renderBufferImmediate=function(t,e){lt.initAttributes();const i=Z.get(t);t.hasPositions&&!i.position&&(i.position=ct.createBuffer()),t.hasNormals&&!i.normal&&(i.normal=ct.createBuffer()),t.hasUvs&&!i.uv&&(i.uv=ct.createBuffer()),t.hasColors&&!i.color&&(i.color=ct.createBuffer());const n=e.getAttributes();t.hasPositions&&(ct.bindBuffer(34962,i.position),ct.bufferData(34962,t.positionArray,35048),lt.enableAttribute(n.position),ct.vertexAttribPointer(n.position,3,5126,!1,0,0)),t.hasNormals&&(ct.bindBuffer(34962,i.normal),ct.bufferData(34962,t.normalArray,35048),lt.enableAttribute(n.normal),ct.vertexAttribPointer(n.normal,3,5126,!1,0,0)),t.hasUvs&&(ct.bindBuffer(34962,i.uv),ct.bufferData(34962,t.uvArray,35048),lt.enableAttribute(n.uv),ct.vertexAttribPointer(n.uv,2,5126,!1,0,0)),t.hasColors&&(ct.bindBuffer(34962,i.color),ct.bufferData(34962,t.colorArray,35048),lt.enableAttribute(n.color),ct.vertexAttribPointer(n.color,3,5126,!1,0,0)),lt.disableUnusedAttributes(),ct.drawArrays(4,0,t.count),t.count=0},this.renderBufferDirect=function(t,e,i,n,r,o){null===e&&(e=N);const a=r.isMesh&&r.matrixWorld.determinant()<0,s=St(t,e,n,r);V.setMaterial(n,a);let l=i.index;const c=i.attributes.position;if(null===l){if(void 0===c||0===c.count)return}else if(0===l.count)return;let h,u=1;!0===n.wireframe&&(l=Y.getWireframeAttribute(i),u=2),(n.morphTargets||n.morphNormals)&&rt.update(r,i,n,s),lt.setup(r,n,s,i,l);let d=ot;null!==l&&(h=X.get(l),d=at,d.setIndex(h));const p=null!==l?l.count:c.count,f=i.drawRange.start*u,m=i.drawRange.count*u,g=null!==o?o.start*u:0,y=null!==o?o.count*u:1/0,_=Math.max(f,g),v=Math.min(p,f+m,g+y)-1,x=Math.max(0,v-_+1);if(0!==x){if(r.isMesh)!0===n.wireframe?(V.setLineWidth(n.wireframeLinewidth*j()),d.setMode(1)):d.setMode(4);else if(r.isLine){let t=n.linewidth;void 0===t&&(t=1),V.setLineWidth(t*j()),r.isLineSegments?d.setMode(1):r.isLineLoop?d.setMode(2):d.setMode(3)}else r.isPoints?d.setMode(0):r.isSprite&&d.setMode(4);if(r.isInstancedMesh)d.renderInstances(_,x,r.count);else if(i.isInstancedBufferGeometry){const t=Math.min(i.instanceCount,i._maxInstanceCount);d.renderInstances(_,x,t)}else d.render(_,x)}},this.compile=function(t,e){d=et.get(t),d.init(),t.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(d.pushLight(t),t.castShadow&&d.pushShadow(t))})),d.setupLights();const i=new WeakMap;t.traverse((function(e){const n=e.material;if(n)if(Array.isArray(n))for(let r=0;r<n.length;r++){const o=n[r];!1===i.has(o)&&(Mt(o,t,e),i.set(o))}else!1===i.has(n)&&(Mt(n,t,e),i.set(n))}))};let _t=null;const vt=new Co;function xt(t,e,i,n){if(!1===t.visible)return;if(t.layers.test(e.layers))if(t.isGroup)i=t.renderOrder;else if(t.isLOD)!0===t.autoUpdate&&t.update(e);else if(t.isLight)d.pushLight(t),t.castShadow&&d.pushShadow(t);else if(t.isSprite){if(!t.frustumCulled||k.intersectsSprite(t)){n&&F.setFromMatrixPosition(t.matrixWorld).applyMatrix4(B);const e=$.update(t),r=t.material;r.visible&&u.push(t,e,r,i,F.z,null)}}else if(t.isImmediateRenderObject)n&&F.setFromMatrixPosition(t.matrixWorld).applyMatrix4(B),u.push(t,null,t.material,i,F.z,null);else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.frame!==H.render.frame&&(t.skeleton.update(),t.skeleton.frame=H.render.frame),!t.frustumCulled||k.intersectsObject(t))){n&&F.setFromMatrixPosition(t.matrixWorld).applyMatrix4(B);const e=$.update(t),r=t.material;if(Array.isArray(r)){const n=e.groups;for(let o=0,a=n.length;o<a;o++){const a=n[o],s=r[a.materialIndex];s&&s.visible&&u.push(t,e,s,i,F.z,a)}}else r.visible&&u.push(t,e,r,i,F.z,null)}const r=t.children;for(let t=0,o=r.length;t<o;t++)xt(r[t],e,i,n)}function bt(t,e,i){const n=!0===e.isScene?e.overrideMaterial:null;for(let r=0,o=t.length;r<o;r++){const o=t[r],a=o.object,s=o.geometry,l=null===n?o.material:n,c=o.group;if(i.isArrayCamera){const t=i.cameras;for(let i=0,n=t.length;i<n;i++){const n=t[i];a.layers.test(n.layers)&&(V.viewport(M.copy(n.viewport)),d.setupLightsView(n),wt(a,e,n,s,l,c))}}else wt(a,e,i,s,l,c)}}function wt(t,e,i,n,r,o){if(t.onBeforeRender(f,e,i,n,r,o),t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),t.isImmediateRenderObject){const n=St(i,e,r,t);V.setMaterial(r),lt.reset(),function(t,e){t.render((function(t){f.renderBufferImmediate(t,e)}))}(t,n)}else f.renderBufferDirect(i,e,n,r,t,o);t.onAfterRender(f,e,i,n,r,o)}function Mt(t,e,i){!0!==e.isScene&&(e=N);const n=Z.get(t),r=d.state.lights,o=d.state.shadowsArray,a=r.state.version,s=J.getParameters(t,r.state,o,e,i),l=J.getProgramCacheKey(s);let c=n.program,h=!0;if(n.environment=t.isMeshStandardMaterial?e.environment:null,n.fog=e.fog,n.envMap=q.get(t.envMap||n.environment),void 0===c)t.addEventListener("dispose",gt);else if(c.cacheKey!==l)yt(t);else if(n.lightsStateVersion!==a)h=!1;else{if(void 0!==s.shaderID)return;h=!1}h&&(s.uniforms=J.getUniforms(t),t.onBeforeCompile(s,f),c=J.acquireProgram(s,l),n.program=c,n.uniforms=s.uniforms,n.outputEncoding=s.outputEncoding);const u=n.uniforms;(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(n.numClippingPlanes=it.numPlanes,n.numIntersection=it.numIntersection,u.clippingPlanes=it.uniform),n.needsLights=function(t){return t.isMeshLambertMaterial||t.isMeshToonMaterial||t.isMeshPhongMaterial||t.isMeshStandardMaterial||t.isShadowMaterial||t.isShaderMaterial&&!0===t.lights}(t),n.lightsStateVersion=a,n.needsLights&&(u.ambientLightColor.value=r.state.ambient,u.lightProbe.value=r.state.probe,u.directionalLights.value=r.state.directional,u.directionalLightShadows.value=r.state.directionalShadow,u.spotLights.value=r.state.spot,u.spotLightShadows.value=r.state.spotShadow,u.rectAreaLights.value=r.state.rectArea,u.ltc_1.value=r.state.rectAreaLTC1,u.ltc_2.value=r.state.rectAreaLTC2,u.pointLights.value=r.state.point,u.pointLightShadows.value=r.state.pointShadow,u.hemisphereLights.value=r.state.hemi,u.directionalShadowMap.value=r.state.directionalShadowMap,u.directionalShadowMatrix.value=r.state.directionalShadowMatrix,u.spotShadowMap.value=r.state.spotShadowMap,u.spotShadowMatrix.value=r.state.spotShadowMatrix,u.pointShadowMap.value=r.state.pointShadowMap,u.pointShadowMatrix.value=r.state.pointShadowMatrix);const p=n.program.getUniforms(),m=Va.seqWithValue(p.seq,u);n.uniformsList=m}function St(t,e,i,n){!0!==e.isScene&&(e=N),W.resetTextureUnits();const r=e.fog,o=i.isMeshStandardMaterial?e.environment:null,a=null===v?f.outputEncoding:v.texture.encoding,s=q.get(i.envMap||o),l=Z.get(i),c=d.state.lights;if(!0===O&&(!0===z||t!==w)){const e=t===w&&i.id===b;it.setState(i,t,e)}i.version===l.__version?i.fog&&l.fog!==r||l.environment!==o||l.needsLights&&l.lightsStateVersion!==c.state.version?Mt(i,e,n):void 0===l.numClippingPlanes||l.numClippingPlanes===it.numPlanes&&l.numIntersection===it.numIntersection?(l.outputEncoding!==a||l.envMap!==s)&&Mt(i,e,n):Mt(i,e,n):(Mt(i,e,n),l.__version=i.version);let h=!1,u=!1,p=!1;const m=l.program,g=m.getUniforms(),y=l.uniforms;if(V.useProgram(m.program)&&(h=!0,u=!0,p=!0),i.id!==b&&(b=i.id,u=!0),h||w!==t){if(g.setValue(ct,"projectionMatrix",t.projectionMatrix),U.logarithmicDepthBuffer&&g.setValue(ct,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),w!==t&&(w=t,u=!0,p=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshStandardMaterial||i.envMap){const e=g.map.cameraPosition;void 0!==e&&e.setValue(ct,F.setFromMatrixPosition(t.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&g.setValue(ct,"isOrthographic",!0===t.isOrthographicCamera),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.isShadowMaterial||i.skinning)&&g.setValue(ct,"viewMatrix",t.matrixWorldInverse)}if(i.skinning){g.setOptional(ct,n,"bindMatrix"),g.setOptional(ct,n,"bindMatrixInverse");const t=n.skeleton;if(t){const e=t.bones;if(U.floatVertexTextures){if(null===t.boneTexture){let i=Math.sqrt(4*e.length);i=Fi.ceilPowerOfTwo(i),i=Math.max(i,4);const n=new Float32Array(i*i*4);n.set(t.boneMatrices);const r=new Mo(n,i,i,Ft,Lt);t.boneMatrices=n,t.boneTexture=r,t.boneTextureSize=i}g.setValue(ct,"boneTexture",t.boneTexture,W),g.setValue(ct,"boneTextureSize",t.boneTextureSize)}else g.setOptional(ct,t,"boneMatrices")}}var _,x;return(u||l.receiveShadow!==n.receiveShadow)&&(l.receiveShadow=n.receiveShadow,g.setValue(ct,"receiveShadow",n.receiveShadow)),u&&(g.setValue(ct,"toneMappingExposure",f.toneMappingExposure),l.needsLights&&(x=p,(_=y).ambientLightColor.needsUpdate=x,_.lightProbe.needsUpdate=x,_.directionalLights.needsUpdate=x,_.directionalLightShadows.needsUpdate=x,_.pointLights.needsUpdate=x,_.pointLightShadows.needsUpdate=x,_.spotLights.needsUpdate=x,_.spotLightShadows.needsUpdate=x,_.rectAreaLights.needsUpdate=x,_.hemisphereLights.needsUpdate=x),r&&i.fog&&Q.refreshFogUniforms(y,r),Q.refreshMaterialUniforms(y,i,A,C),Va.upload(ct,l.uniformsList,y,W)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(Va.upload(ct,l.uniformsList,y,W),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&g.setValue(ct,"center",n.center),g.setValue(ct,"modelViewMatrix",n.modelViewMatrix),g.setValue(ct,"normalMatrix",n.normalMatrix),g.setValue(ct,"modelMatrix",n.matrixWorld),m}vt.setAnimationLoop((function(t){dt.isPresenting||_t&&_t(t)})),"undefined"!=typeof window&&vt.setContext(window),this.setAnimationLoop=function(t){_t=t,dt.setAnimationLoop(t),null===t?vt.stop():vt.start()},this.render=function(t,e){let i,n;if(void 0!==arguments[2]&&(console.warn("THREE.WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),i=arguments[2]),void 0!==arguments[3]&&(console.warn("THREE.WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead."),n=arguments[3]),void 0!==e&&!0!==e.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===m)return;lt.resetDefaultState(),b=-1,w=null,!0===t.autoUpdate&&t.updateMatrixWorld(),null===e.parent&&e.updateMatrixWorld(),!0===dt.enabled&&!0===dt.isPresenting&&(e=dt.getCamera(e)),!0===t.isScene&&t.onBeforeRender(f,t,e,i||v),d=et.get(t,p.length),d.init(),p.push(d),B.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),k.setFromProjectionMatrix(B),z=this.localClippingEnabled,O=it.init(this.clippingPlanes,z,e),u=tt.get(t,e),u.init(),xt(t,e,0,f.sortObjects),u.finish(),!0===f.sortObjects&&u.sort(P,L),!0===O&&it.beginShadows();const r=d.state.shadowsArray;pt.render(r,t,e),d.setupLights(),d.setupLightsView(e),!0===O&&it.endShadows(),!0===this.info.autoReset&&this.info.reset(),void 0!==i&&this.setRenderTarget(i),nt.render(u,t,e,n);const o=u.opaque,a=u.transparent;o.length>0&&bt(o,t,e),a.length>0&&bt(a,t,e),!0===t.isScene&&t.onAfterRender(f,t,e),null!==v&&(W.updateRenderTargetMipmap(v),W.updateMultisampleRenderTarget(v)),V.buffers.depth.setTest(!0),V.buffers.depth.setMask(!0),V.buffers.color.setMask(!0),V.setPolygonOffset(!1),p.pop(),d=p.length>0?p[p.length-1]:null,u=null},this.setFramebuffer=function(t){g!==t&&null===v&&ct.bindFramebuffer(36160,t),g=t},this.getActiveCubeFace=function(){return y},this.getActiveMipmapLevel=function(){return _},this.getRenderList=function(){return u},this.setRenderList=function(t){u=t},this.getRenderTarget=function(){return v},this.setRenderTarget=function(t,e=0,i=0){v=t,y=e,_=i,t&&void 0===Z.get(t).__webglFramebuffer&&W.setupRenderTarget(t);let n=g,r=!1;if(t){const i=Z.get(t).__webglFramebuffer;t.isWebGLCubeRenderTarget?(n=i[e],r=!0):n=t.isWebGLMultisampleRenderTarget?Z.get(t).__webglMultisampledFramebuffer:i,M.copy(t.viewport),T.copy(t.scissor),S=t.scissorTest}else M.copy(I).multiplyScalar(A).floor(),T.copy(R).multiplyScalar(A).floor(),S=D;if(x!==n&&(ct.bindFramebuffer(36160,n),x=n),V.viewport(M),V.scissor(T),V.setScissorTest(S),r){const n=Z.get(t.texture);ct.framebufferTexture2D(36160,36064,34069+e,n.__webglTexture,i)}},this.readRenderTargetPixels=function(t,e,i,n,r,o,a){if(!t||!t.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let s=Z.get(t).__webglFramebuffer;if(t.isWebGLCubeRenderTarget&&void 0!==a&&(s=s[a]),s){let a=!1;s!==x&&(ct.bindFramebuffer(36160,s),a=!0);try{const s=t.texture,l=s.format,c=s.type;if(l!==Ft&&st.convert(l)!==ct.getParameter(35739))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const h=c===It&&(G.has("EXT_color_buffer_half_float")||U.isWebGL2&&G.has("EXT_color_buffer_float"));if(!(c===Tt||st.convert(c)===ct.getParameter(35738)||c===Lt&&(U.isWebGL2||G.has("OES_texture_float")||G.has("WEBGL_color_buffer_float"))||h))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");36053===ct.checkFramebufferStatus(36160)?e>=0&&e<=t.width-n&&i>=0&&i<=t.height-r&&ct.readPixels(e,i,n,r,st.convert(l),st.convert(c),o):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{a&&ct.bindFramebuffer(36160,x)}}},this.copyFramebufferToTexture=function(t,e,i=0){const n=Math.pow(2,-i),r=Math.floor(e.image.width*n),o=Math.floor(e.image.height*n),a=st.convert(e.format);W.setTexture2D(e,0),ct.copyTexImage2D(3553,i,a,t.x,t.y,r,o,0),V.unbindTexture()},this.copyTextureToTexture=function(t,e,i,n=0){const r=e.image.width,o=e.image.height,a=st.convert(i.format),s=st.convert(i.type);W.setTexture2D(i,0),ct.pixelStorei(37440,i.flipY),ct.pixelStorei(37441,i.premultiplyAlpha),ct.pixelStorei(3317,i.unpackAlignment),e.isDataTexture?ct.texSubImage2D(3553,n,t.x,t.y,r,o,a,s,e.image.data):e.isCompressedTexture?ct.compressedTexSubImage2D(3553,n,t.x,t.y,e.mipmaps[0].width,e.mipmaps[0].height,a,e.mipmaps[0].data):ct.texSubImage2D(3553,n,t.x,t.y,a,s,e.image),0===n&&i.generateMipmaps&&ct.generateMipmap(3553),V.unbindTexture()},this.initTexture=function(t){W.setTexture2D(t,0),V.unbindTexture()},this.resetState=function(){V.reset(),lt.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}function ks(t){Ds.call(this,t)}As.prototype=Object.assign(Object.create(vo.prototype),{constructor:As,isArrayCamera:!0}),Ps.prototype=Object.assign(Object.create($n.prototype),{constructor:Ps,isGroup:!0}),Object.assign(Ls.prototype,{constructor:Ls,getHandSpace:function(){return null===this._hand&&(this._hand=new Ps,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand},getTargetRaySpace:function(){return null===this._targetRay&&(this._targetRay=new Ps,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1),this._targetRay},getGripSpace:function(){return null===this._grip&&(this._grip=new Ps,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1),this._grip},dispatchEvent:function(t){return null!==this._targetRay&&this._targetRay.dispatchEvent(t),null!==this._grip&&this._grip.dispatchEvent(t),null!==this._hand&&this._hand.dispatchEvent(t),this},disconnect:function(t){return this.dispatchEvent({type:"disconnected",data:t}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this},update:function(t,e,i){let n=null,r=null,o=null;const a=this._targetRay,s=this._grip,l=this._hand;if(t&&"visible-blurred"!==e.session.visibilityState)if(l&&t.hand){o=!0;for(const n of t.hand.values()){const t=e.getJointPose(n,i);if(void 0===l.joints[n.jointName]){const t=new Ps;t.matrixAutoUpdate=!1,t.visible=!1,l.joints[n.jointName]=t,l.add(t)}const r=l.joints[n.jointName];null!==t&&(r.matrix.fromArray(t.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.jointRadius=t.radius),r.visible=null!==t}const n=l.joints["index-finger-tip"],r=l.joints["thumb-tip"],a=n.position.distanceTo(r.position),s=.02,c=.005;l.inputState.pinching&&a>s+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!l.inputState.pinching&&a<=s-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}else null!==a&&(n=e.getPose(t.targetRaySpace,i),null!==n&&(a.matrix.fromArray(n.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale))),null!==s&&t.gripSpace&&(r=e.getPose(t.gripSpace,i),null!==r&&(s.matrix.fromArray(r.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale)));return null!==a&&(a.visible=null!==n),null!==s&&(s.visible=null!==r),null!==l&&(l.visible=null!==o),this}}),Object.assign(Is.prototype,Oi.prototype),ks.prototype=Object.assign(Object.create(Ds.prototype),{constructor:ks,isWebGL1Renderer:!0});class Os{constructor(t,e){Object.defineProperty(this,"isFogExp2",{value:!0}),this.name="",this.color=new _r(t),this.density=void 0!==e?e:25e-5}clone(){return new Os(this.color,this.density)}toJSON(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}}}class zs{constructor(t,e,i){Object.defineProperty(this,"isFog",{value:!0}),this.name="",this.color=new _r(t),this.near=void 0!==e?e:1,this.far=void 0!==i?i:1e3}clone(){return new zs(this.color,this.near,this.far)}toJSON(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}}class Bs extends $n{constructor(){super(),Object.defineProperty(this,"isScene",{value:!0}),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.autoUpdate=t.autoUpdate,this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return null!==this.background&&(e.object.background=this.background.toJSON(t)),null!==this.environment&&(e.object.environment=this.environment.toJSON(t)),null!==this.fog&&(e.object.fog=this.fog.toJSON()),e}}function Fs(t,e){this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=Ti,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=Fi.generateUUID()}Object.defineProperty(Fs.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(Fs.prototype,{isInterleavedBuffer:!0,onUploadCallback:function(){},setUsage:function(t){return this.usage=t,this},copy:function(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this},copyAt:function(t,e,i){t*=this.stride,i*=e.stride;for(let n=0,r=this.stride;n<r;n++)this.array[t+n]=e.array[i+n];return this},set:function(t,e=0){return this.array.set(t,e),this},clone:function(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Fi.generateUUID()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new Fs(new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),this.stride);return e.setUsage(this.usage),e},onUpload:function(t){return this.onUploadCallback=t,this},toJSON:function(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Fi.generateUUID()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}});const Ns=new $i;function js(t,e,i,n){this.name="",this.data=t,this.itemSize=e,this.offset=i,this.normalized=!0===n}function Gs(t){br.call(this),this.type="SpriteMaterial",this.color=new _r(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.setValues(t)}let Us;Object.defineProperties(js.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}},needsUpdate:{set:function(t){this.data.needsUpdate=t}}}),Object.assign(js.prototype,{isInterleavedBufferAttribute:!0,applyMatrix4:function(t){for(let e=0,i=this.data.count;e<i;e++)Ns.x=this.getX(e),Ns.y=this.getY(e),Ns.z=this.getZ(e),Ns.applyMatrix4(t),this.setXYZ(e,Ns.x,Ns.y,Ns.z);return this},setX:function(t,e){return this.data.array[t*this.data.stride+this.offset]=e,this},setY:function(t,e){return this.data.array[t*this.data.stride+this.offset+1]=e,this},setZ:function(t,e){return this.data.array[t*this.data.stride+this.offset+2]=e,this},setW:function(t,e){return this.data.array[t*this.data.stride+this.offset+3]=e,this},getX:function(t){return this.data.array[t*this.data.stride+this.offset]},getY:function(t){return this.data.array[t*this.data.stride+this.offset+1]},getZ:function(t){return this.data.array[t*this.data.stride+this.offset+2]},getW:function(t){return this.data.array[t*this.data.stride+this.offset+3]},setXY:function(t,e,i){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this},setXYZ:function(t,e,i,n){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this},setXYZW:function(t,e,i,n,r){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this.data.array[t+3]=r,this},clone:function(t){if(void 0===t){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return new Sr(new this.array.constructor(t),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new js(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)},toJSON:function(t){if(void 0===t){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}),Gs.prototype=Object.create(br.prototype),Gs.prototype.constructor=Gs,Gs.prototype.isSpriteMaterial=!0,Gs.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.rotation=t.rotation,this.sizeAttenuation=t.sizeAttenuation,this};const Vs=new $i,Hs=new $i,Zs=new $i,Ws=new Ni,qs=new Ni,Xs=new Sn,Ys=new $i,$s=new $i,Js=new $i,Ks=new Ni,Qs=new Ni,tl=new Ni;function el(t){if($n.call(this),this.type="Sprite",void 0===Us){Us=new Wr;const t=new Fs(new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),5);Us.setIndex([0,1,2,0,2,3]),Us.setAttribute("position",new js(t,3,0,!1)),Us.setAttribute("uv",new js(t,2,3,!1))}this.geometry=Us,this.material=void 0!==t?t:new Gs,this.center=new Ni(.5,.5)}function il(t,e,i,n,r,o){Ws.subVectors(t,i).addScalar(.5).multiply(n),void 0!==r?(qs.x=o*Ws.x-r*Ws.y,qs.y=r*Ws.x+o*Ws.y):qs.copy(Ws),t.copy(e),t.x+=qs.x,t.y+=qs.y,t.applyMatrix4(Xs)}el.prototype=Object.assign(Object.create($n.prototype),{constructor:el,isSprite:!0,raycast:function(t,e){null===t.camera&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),Hs.setFromMatrixScale(this.matrixWorld),Xs.copy(t.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(t.camera.matrixWorldInverse,this.matrixWorld),Zs.setFromMatrixPosition(this.modelViewMatrix),t.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&Hs.multiplyScalar(-Zs.z);const i=this.material.rotation;let n,r;0!==i&&(r=Math.cos(i),n=Math.sin(i));const o=this.center;il(Ys.set(-.5,-.5,0),Zs,o,Hs,n,r),il($s.set(.5,-.5,0),Zs,o,Hs,n,r),il(Js.set(.5,.5,0),Zs,o,Hs,n,r),Ks.set(0,0),Qs.set(1,0),tl.set(1,1);let a=t.ray.intersectTriangle(Ys,$s,Js,!1,Vs);if(null===a&&(il($s.set(-.5,.5,0),Zs,o,Hs,n,r),Qs.set(0,1),a=t.ray.intersectTriangle(Ys,Js,$s,!1,Vs),null===a))return;const s=t.ray.origin.distanceTo(Vs);s<t.near||s>t.far||e.push({distance:s,point:Vs.clone(),uv:ur.getUV(Vs,Ys,$s,Js,Ks,Qs,tl,new Ni),face:null,object:this})},copy:function(t){return $n.prototype.copy.call(this,t),void 0!==t.center&&this.center.copy(t.center),this.material=t.material,this}});const nl=new $i,rl=new $i;function ol(){$n.call(this),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}}),this.autoUpdate=!0}ol.prototype=Object.assign(Object.create($n.prototype),{constructor:ol,isLOD:!0,copy:function(t){$n.prototype.copy.call(this,t,!1);const e=t.levels;for(let t=0,i=e.length;t<i;t++){const i=e[t];this.addLevel(i.object.clone(),i.distance)}return this.autoUpdate=t.autoUpdate,this},addLevel:function(t,e=0){e=Math.abs(e);const i=this.levels;let n;for(n=0;n<i.length&&!(e<i[n].distance);n++);return i.splice(n,0,{distance:e,object:t}),this.add(t),this},getCurrentLevel:function(){return this._currentLevel},getObjectForDistance:function(t){const e=this.levels;if(e.length>0){let i,n;for(i=1,n=e.length;i<n&&!(t<e[i].distance);i++);return e[i-1].object}return null},raycast:function(t,e){if(this.levels.length>0){nl.setFromMatrixPosition(this.matrixWorld);const i=t.ray.origin.distanceTo(nl);this.getObjectForDistance(i).raycast(t,e)}},update:function(t){const e=this.levels;if(e.length>1){nl.setFromMatrixPosition(t.matrixWorld),rl.setFromMatrixPosition(this.matrixWorld);const i=nl.distanceTo(rl)/t.zoom;let n,r;for(e[0].object.visible=!0,n=1,r=e.length;n<r&&i>=e[n].distance;n++)e[n-1].object.visible=!1,e[n].object.visible=!0;for(this._currentLevel=n-1;n<r;n++)e[n].object.visible=!1}},toJSON:function(t){const e=$n.prototype.toJSON.call(this,t);!1===this.autoUpdate&&(e.object.autoUpdate=!1),e.object.levels=[];const i=this.levels;for(let t=0,n=i.length;t<n;t++){const n=i[t];e.object.levels.push({object:n.object.uuid,distance:n.distance})}return e}});const al=new $i,sl=new Wi,ll=new Wi,cl=new $i,hl=new Sn;function ul(t,e){t&&t.isGeometry&&console.error("THREE.SkinnedMesh no longer supports THREE.Geometry. Use THREE.BufferGeometry instead."),ho.call(this,t,e),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Sn,this.bindMatrixInverse=new Sn}function dl(){$n.call(this),this.type="Bone"}ul.prototype=Object.assign(Object.create(ho.prototype),{constructor:ul,isSkinnedMesh:!0,copy:function(t){return ho.prototype.copy.call(this,t),this.bindMode=t.bindMode,this.bindMatrix.copy(t.bindMatrix),this.bindMatrixInverse.copy(t.bindMatrixInverse),this.skeleton=t.skeleton,this},bind:function(t,e){this.skeleton=t,void 0===e&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),e=this.matrixWorld),this.bindMatrix.copy(e),this.bindMatrixInverse.copy(e).invert()},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){const t=new Wi,e=this.geometry.attributes.skinWeight;for(let i=0,n=e.count;i<n;i++){t.x=e.getX(i),t.y=e.getY(i),t.z=e.getZ(i),t.w=e.getW(i);const n=1/t.manhattanLength();n!==1/0?t.multiplyScalar(n):t.set(1,0,0,0),e.setXYZW(i,t.x,t.y,t.z,t.w)}},updateMatrixWorld:function(t){ho.prototype.updateMatrixWorld.call(this,t),"attached"===this.bindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},boneTransform:function(t,e){const i=this.skeleton,n=this.geometry;sl.fromBufferAttribute(n.attributes.skinIndex,t),ll.fromBufferAttribute(n.attributes.skinWeight,t),al.fromBufferAttribute(n.attributes.position,t).applyMatrix4(this.bindMatrix),e.set(0,0,0);for(let t=0;t<4;t++){const n=ll.getComponent(t);if(0!==n){const r=sl.getComponent(t);hl.multiplyMatrices(i.bones[r].matrixWorld,i.boneInverses[r]),e.addScaledVector(cl.copy(al).applyMatrix4(hl),n)}}return e.applyMatrix4(this.bindMatrixInverse)}}),dl.prototype=Object.assign(Object.create($n.prototype),{constructor:dl,isBone:!0});const pl=new Sn,fl=new Sn;function ml(t=[],e=[]){this.uuid=Fi.generateUUID(),this.bones=t.slice(0),this.boneInverses=e,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.frame=-1,this.init()}Object.assign(ml.prototype,{init:function(){const t=this.bones,e=this.boneInverses;if(this.boneMatrices=new Float32Array(16*t.length),0===e.length)this.calculateInverses();else if(t.length!==e.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let t=0,e=this.bones.length;t<e;t++)this.boneInverses.push(new Sn)}},calculateInverses:function(){this.boneInverses.length=0;for(let t=0,e=this.bones.length;t<e;t++){const e=new Sn;this.bones[t]&&e.copy(this.bones[t].matrixWorld).invert(),this.boneInverses.push(e)}},pose:function(){for(let t=0,e=this.bones.length;t<e;t++){const e=this.bones[t];e&&e.matrixWorld.copy(this.boneInverses[t]).invert()}for(let t=0,e=this.bones.length;t<e;t++){const e=this.bones[t];e&&(e.parent&&e.parent.isBone?(e.matrix.copy(e.parent.matrixWorld).invert(),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))}},update:function(){const t=this.bones,e=this.boneInverses,i=this.boneMatrices,n=this.boneTexture;for(let n=0,r=t.length;n<r;n++){const r=t[n]?t[n].matrixWorld:fl;pl.multiplyMatrices(r,e[n]),pl.toArray(i,16*n)}null!==n&&(n.needsUpdate=!0)},clone:function(){return new ml(this.bones,this.boneInverses)},getBoneByName:function(t){for(let e=0,i=this.bones.length;e<i;e++){const i=this.bones[e];if(i.name===t)return i}},dispose:function(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)},fromJSON:function(t,e){this.uuid=t.uuid;for(let i=0,n=t.bones.length;i<n;i++){const n=t.bones[i];let r=e[n];void 0===r&&(console.warn("THREE.Skeleton: No bone found with UUID:",n),r=new dl),this.bones.push(r),this.boneInverses.push((new Sn).fromArray(t.boneInverses[i]))}return this.init(),this},toJSON:function(){const t={metadata:{version:4.5,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};t.uuid=this.uuid;const e=this.bones,i=this.boneInverses;for(let n=0,r=e.length;n<r;n++){const r=e[n];t.bones.push(r.uuid);const o=i[n];t.boneInverses.push(o.toArray())}return t}});const gl=new Sn,yl=new Sn,_l=[],vl=new ho;function xl(t,e,i){ho.call(this,t,e),this.instanceMatrix=new Sr(new Float32Array(16*i),16),this.instanceColor=null,this.count=i,this.frustumCulled=!1}function bl(t){br.call(this),this.type="LineBasicMaterial",this.color=new _r(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.morphTargets=!1,this.setValues(t)}xl.prototype=Object.assign(Object.create(ho.prototype),{constructor:xl,isInstancedMesh:!0,copy:function(t){return ho.prototype.copy.call(this,t),this.instanceMatrix.copy(t.instanceMatrix),null!==t.instanceColor&&(this.instanceColor=t.instanceColor.clone()),this.count=t.count,this},getColorAt:function(t,e){e.fromArray(this.instanceColor.array,3*t)},getMatrixAt:function(t,e){e.fromArray(this.instanceMatrix.array,16*t)},raycast:function(t,e){const i=this.matrixWorld,n=this.count;if(vl.geometry=this.geometry,vl.material=this.material,void 0!==vl.material)for(let r=0;r<n;r++){this.getMatrixAt(r,gl),yl.multiplyMatrices(i,gl),vl.matrixWorld=yl,vl.raycast(t,_l);for(let t=0,i=_l.length;t<i;t++){const i=_l[t];i.instanceId=r,i.object=this,e.push(i)}_l.length=0}},setColorAt:function(t,e){null===this.instanceColor&&(this.instanceColor=new Sr(new Float32Array(3*this.count),3)),e.toArray(this.instanceColor.array,3*t)},setMatrixAt:function(t,e){e.toArray(this.instanceMatrix.array,16*t)},updateMorphTargets:function(){},dispose:function(){this.dispatchEvent({type:"dispose"})}}),bl.prototype=Object.create(br.prototype),bl.prototype.constructor=bl,bl.prototype.isLineBasicMaterial=!0,bl.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.morphTargets=t.morphTargets,this};const wl=new $i,Ml=new $i,Tl=new Sn,Sl=new Tn,El=new gn;function Cl(t=new Wr,e=new bl){$n.call(this),this.type="Line",this.geometry=t,this.material=e,this.updateMorphTargets()}Cl.prototype=Object.assign(Object.create($n.prototype),{constructor:Cl,isLine:!0,copy:function(t){return $n.prototype.copy.call(this,t),this.material=t.material,this.geometry=t.geometry,this},computeLineDistances:function(){const t=this.geometry;if(t.isBufferGeometry)if(null===t.index){const e=t.attributes.position,i=[0];for(let t=1,n=e.count;t<n;t++)wl.fromBufferAttribute(e,t-1),Ml.fromBufferAttribute(e,t),i[t]=i[t-1],i[t]+=wl.distanceTo(Ml);t.setAttribute("lineDistance",new kr(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else t.isGeometry&&console.error("THREE.Line.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this},raycast:function(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Line.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),El.copy(i.boundingSphere),El.applyMatrix4(n),El.radius+=r,!1===t.ray.intersectsSphere(El))return;Tl.copy(n).invert(),Sl.copy(t.ray).applyMatrix4(Tl);const o=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o,s=new $i,l=new $i,c=new $i,h=new $i,u=this.isLineSegments?2:1;if(i.isBufferGeometry){const n=i.index,r=i.attributes.position;if(null!==n){const i=n.array;for(let n=0,o=i.length-1;n<o;n+=u){const o=i[n],u=i[n+1];s.fromBufferAttribute(r,o),l.fromBufferAttribute(r,u);if(Sl.distanceSqToSegment(s,l,h,c)>a)continue;h.applyMatrix4(this.matrixWorld);const d=t.ray.origin.distanceTo(h);d<t.near||d>t.far||e.push({distance:d,point:c.clone().applyMatrix4(this.matrixWorld),index:n,face:null,faceIndex:null,object:this})}}else for(let i=0,n=r.count-1;i<n;i+=u){s.fromBufferAttribute(r,i),l.fromBufferAttribute(r,i+1);if(Sl.distanceSqToSegment(s,l,h,c)>a)continue;h.applyMatrix4(this.matrixWorld);const n=t.ray.origin.distanceTo(h);n<t.near||n>t.far||e.push({distance:n,point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else i.isGeometry&&console.error("THREE.Line.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});const Al=new $i,Pl=new $i;function Ll(t,e){Cl.call(this,t,e),this.type="LineSegments"}function Il(t,e){Cl.call(this,t,e),this.type="LineLoop"}function Rl(t){br.call(this),this.type="PointsMaterial",this.color=new _r(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.setValues(t)}Ll.prototype=Object.assign(Object.create(Cl.prototype),{constructor:Ll,isLineSegments:!0,computeLineDistances:function(){const t=this.geometry;if(t.isBufferGeometry)if(null===t.index){const e=t.attributes.position,i=[];for(let t=0,n=e.count;t<n;t+=2)Al.fromBufferAttribute(e,t),Pl.fromBufferAttribute(e,t+1),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+Al.distanceTo(Pl);t.setAttribute("lineDistance",new kr(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else t.isGeometry&&console.error("THREE.LineSegments.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}}),Il.prototype=Object.assign(Object.create(Cl.prototype),{constructor:Il,isLineLoop:!0}),Rl.prototype=Object.create(br.prototype),Rl.prototype.constructor=Rl,Rl.prototype.isPointsMaterial=!0,Rl.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.morphTargets=t.morphTargets,this};const Dl=new Sn,kl=new Tn,Ol=new gn,zl=new $i;function Bl(t=new Wr,e=new Rl){$n.call(this),this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}function Fl(t,e,i,n,r,o,a){const s=kl.distanceSqToPoint(t);if(s<i){const i=new $i;kl.closestPointToPoint(t,i),i.applyMatrix4(n);const l=r.ray.origin.distanceTo(i);if(l<r.near||l>r.far)return;o.push({distance:l,distanceToRay:Math.sqrt(s),point:i,index:e,face:null,object:a})}}function Nl(t,e,i,n,r,o,a,s,l){Hi.call(this,t,e,i,n,r,o,a,s,l),this.format=void 0!==a?a:Bt,this.minFilter=void 0!==o?o:vt,this.magFilter=void 0!==r?r:vt,this.generateMipmaps=!1;const c=this;"requestVideoFrameCallback"in t&&t.requestVideoFrameCallback((function e(){c.needsUpdate=!0,t.requestVideoFrameCallback(e)}))}function jl(t,e,i,n,r,o,a,s,l,c,h,u){Hi.call(this,null,o,a,s,l,c,n,r,h,u),this.image={width:e,height:i},this.mipmaps=t,this.flipY=!1,this.generateMipmaps=!1}function Gl(t,e,i,n,r,o,a,s,l){Hi.call(this,t,e,i,n,r,o,a,s,l),this.needsUpdate=!0}function Ul(t,e,i,n,r,o,a,s,l,c){if((c=void 0!==c?c:Ut)!==Ut&&c!==Vt)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&c===Ut&&(i=Ct),void 0===i&&c===Vt&&(i=Ot),Hi.call(this,null,n,r,o,a,s,c,i,l),this.image={width:t,height:e},this.magFilter=void 0!==a?a:ft,this.minFilter=void 0!==s?s:ft,this.flipY=!1,this.generateMipmaps=!1}Bl.prototype=Object.assign(Object.create($n.prototype),{constructor:Bl,isPoints:!0,copy:function(t){return $n.prototype.copy.call(this,t),this.material=t.material,this.geometry=t.geometry,this},raycast:function(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Points.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),Ol.copy(i.boundingSphere),Ol.applyMatrix4(n),Ol.radius+=r,!1===t.ray.intersectsSphere(Ol))return;Dl.copy(n).invert(),kl.copy(t.ray).applyMatrix4(Dl);const o=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o;if(i.isBufferGeometry){const r=i.index,o=i.attributes.position;if(null!==r){const i=r.array;for(let r=0,s=i.length;r<s;r++){const s=i[r];zl.fromBufferAttribute(o,s),Fl(zl,s,a,n,t,e,this)}}else for(let i=0,r=o.count;i<r;i++)zl.fromBufferAttribute(o,i),Fl(zl,i,a,n,t,e,this)}else console.error("THREE.Points.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,i=Object.keys(e);if(i.length>0){const t=e[i[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=t.length;e<i;e++){const i=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}),Nl.prototype=Object.assign(Object.create(Hi.prototype),{constructor:Nl,clone:function(){return new this.constructor(this.image).copy(this)},isVideoTexture:!0,update:function(){const t=this.image;!1==="requestVideoFrameCallback"in t&&t.readyState>=t.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}),jl.prototype=Object.create(Hi.prototype),jl.prototype.constructor=jl,jl.prototype.isCompressedTexture=!0,Gl.prototype=Object.create(Hi.prototype),Gl.prototype.constructor=Gl,Gl.prototype.isCanvasTexture=!0,Ul.prototype=Object.create(Hi.prototype),Ul.prototype.constructor=Ul,Ul.prototype.isDepthTexture=!0;class Vl extends Wr{constructor(t=1,e=8,i=0,n=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:t,segments:e,thetaStart:i,thetaLength:n},e=Math.max(3,e);const r=[],o=[],a=[],s=[],l=new $i,c=new Ni;o.push(0,0,0),a.push(0,0,1),s.push(.5,.5);for(let r=0,h=3;r<=e;r++,h+=3){const u=i+r/e*n;l.x=t*Math.cos(u),l.y=t*Math.sin(u),o.push(l.x,l.y,l.z),a.push(0,0,1),c.x=(o[h]/t+1)/2,c.y=(o[h+1]/t+1)/2,s.push(c.x,c.y)}for(let t=1;t<=e;t++)r.push(t,t+1,0);this.setIndex(r),this.setAttribute("position",new kr(o,3)),this.setAttribute("normal",new kr(a,3)),this.setAttribute("uv",new kr(s,2))}}class Hl extends Wr{constructor(t=1,e=1,i=1,n=8,r=1,o=!1,a=0,s=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:i,radialSegments:n,heightSegments:r,openEnded:o,thetaStart:a,thetaLength:s};const l=this;n=Math.floor(n),r=Math.floor(r);const c=[],h=[],u=[],d=[];let p=0;const f=[],m=i/2;let g=0;function y(i){const r=p,o=new Ni,f=new $i;let y=0;const _=!0===i?t:e,v=!0===i?1:-1;for(let t=1;t<=n;t++)h.push(0,m*v,0),u.push(0,v,0),d.push(.5,.5),p++;const x=p;for(let t=0;t<=n;t++){const e=t/n*s+a,i=Math.cos(e),r=Math.sin(e);f.x=_*r,f.y=m*v,f.z=_*i,h.push(f.x,f.y,f.z),u.push(0,v,0),o.x=.5*i+.5,o.y=.5*r*v+.5,d.push(o.x,o.y),p++}for(let t=0;t<n;t++){const e=r+t,n=x+t;!0===i?c.push(n,n+1,e):c.push(n+1,n,e),y+=3}l.addGroup(g,y,!0===i?1:2),g+=y}!function(){const o=new $i,y=new $i;let _=0;const v=(e-t)/i;for(let l=0;l<=r;l++){const c=[],g=l/r,_=g*(e-t)+t;for(let t=0;t<=n;t++){const e=t/n,r=e*s+a,l=Math.sin(r),f=Math.cos(r);y.x=_*l,y.y=-g*i+m,y.z=_*f,h.push(y.x,y.y,y.z),o.set(l,v,f).normalize(),u.push(o.x,o.y,o.z),d.push(e,1-g),c.push(p++)}f.push(c)}for(let t=0;t<n;t++)for(let e=0;e<r;e++){const i=f[e][t],n=f[e+1][t],r=f[e+1][t+1],o=f[e][t+1];c.push(i,n,o),c.push(n,r,o),_+=6}l.addGroup(g,_,0),g+=_}(),!1===o&&(t>0&&y(!0),e>0&&y(!1)),this.setIndex(c),this.setAttribute("position",new kr(h,3)),this.setAttribute("normal",new kr(u,3)),this.setAttribute("uv",new kr(d,2))}}class Zl extends Hl{constructor(t=1,e=1,i=8,n=1,r=!1,o=0,a=2*Math.PI){super(0,t,e,i,n,r,o,a),this.type="ConeGeometry",this.parameters={radius:t,height:e,radialSegments:i,heightSegments:n,openEnded:r,thetaStart:o,thetaLength:a}}}class Wl extends Wr{constructor(t,e,i=1,n=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:t,indices:e,radius:i,detail:n};const r=[],o=[];function a(t,e,i,n){const r=n+1,o=[];for(let n=0;n<=r;n++){o[n]=[];const a=t.clone().lerp(i,n/r),s=e.clone().lerp(i,n/r),l=r-n;for(let t=0;t<=l;t++)o[n][t]=0===t&&n===r?a:a.clone().lerp(s,t/l)}for(let t=0;t<r;t++)for(let e=0;e<2*(r-t)-1;e++){const i=Math.floor(e/2);e%2==0?(s(o[t][i+1]),s(o[t+1][i]),s(o[t][i])):(s(o[t][i+1]),s(o[t+1][i+1]),s(o[t+1][i]))}}function s(t){r.push(t.x,t.y,t.z)}function l(e,i){const n=3*e;i.x=t[n+0],i.y=t[n+1],i.z=t[n+2]}function c(t,e,i,n){n<0&&1===t.x&&(o[e]=t.x-1),0===i.x&&0===i.z&&(o[e]=n/2/Math.PI+.5)}function h(t){return Math.atan2(t.z,-t.x)}!function(t){const i=new $i,n=new $i,r=new $i;for(let o=0;o<e.length;o+=3)l(e[o+0],i),l(e[o+1],n),l(e[o+2],r),a(i,n,r,t)}(n),function(t){const e=new $i;for(let i=0;i<r.length;i+=3)e.x=r[i+0],e.y=r[i+1],e.z=r[i+2],e.normalize().multiplyScalar(t),r[i+0]=e.x,r[i+1]=e.y,r[i+2]=e.z}(i),function(){const t=new $i;for(let i=0;i<r.length;i+=3){t.x=r[i+0],t.y=r[i+1],t.z=r[i+2];const n=h(t)/2/Math.PI+.5,a=(e=t,Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))/Math.PI+.5);o.push(n,1-a)}var e;(function(){const t=new $i,e=new $i,i=new $i,n=new $i,a=new Ni,s=new Ni,l=new Ni;for(let u=0,d=0;u<r.length;u+=9,d+=6){t.set(r[u+0],r[u+1],r[u+2]),e.set(r[u+3],r[u+4],r[u+5]),i.set(r[u+6],r[u+7],r[u+8]),a.set(o[d+0],o[d+1]),s.set(o[d+2],o[d+3]),l.set(o[d+4],o[d+5]),n.copy(t).add(e).add(i).divideScalar(3);const p=h(n);c(a,d+0,t,p),c(s,d+2,e,p),c(l,d+4,i,p)}})(),function(){for(let t=0;t<o.length;t+=6){const e=o[t+0],i=o[t+2],n=o[t+4],r=Math.max(e,i,n),a=Math.min(e,i,n);r>.9&&a<.1&&(e<.2&&(o[t+0]+=1),i<.2&&(o[t+2]+=1),n<.2&&(o[t+4]+=1))}}()}(),this.setAttribute("position",new kr(r,3)),this.setAttribute("normal",new kr(r.slice(),3)),this.setAttribute("uv",new kr(o,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}}class ql extends Wl{constructor(t=1,e=0){const i=(1+Math.sqrt(5))/2,n=1/i;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-i,0,-n,i,0,n,-i,0,n,i,-n,-i,0,-n,i,0,n,-i,0,n,i,0,-i,0,-n,i,0,-n,-i,0,n,i,0,n],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],t,e),this.type="DodecahedronGeometry",this.parameters={radius:t,detail:e}}}const Xl=new $i,Yl=new $i,$l=new $i,Jl=new ur;class Kl extends Wr{constructor(t,e){if(super(),this.type="EdgesGeometry",this.parameters={thresholdAngle:e},e=void 0!==e?e:1,!0===t.isGeometry)return void console.error("THREE.EdgesGeometry no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");const i=Math.pow(10,4),n=Math.cos(Fi.DEG2RAD*e),r=t.getIndex(),o=t.getAttribute("position"),a=r?r.count:o.count,s=[0,0,0],l=["a","b","c"],c=new Array(3),h={},u=[];for(let t=0;t<a;t+=3){r?(s[0]=r.getX(t),s[1]=r.getX(t+1),s[2]=r.getX(t+2)):(s[0]=t,s[1]=t+1,s[2]=t+2);const{a:e,b:a,c:d}=Jl;if(e.fromBufferAttribute(o,s[0]),a.fromBufferAttribute(o,s[1]),d.fromBufferAttribute(o,s[2]),Jl.getNormal($l),c[0]=`${Math.round(e.x*i)},${Math.round(e.y*i)},${Math.round(e.z*i)}`,c[1]=`${Math.round(a.x*i)},${Math.round(a.y*i)},${Math.round(a.z*i)}`,c[2]=`${Math.round(d.x*i)},${Math.round(d.y*i)},${Math.round(d.z*i)}`,c[0]!==c[1]&&c[1]!==c[2]&&c[2]!==c[0])for(let t=0;t<3;t++){const e=(t+1)%3,i=c[t],r=c[e],o=Jl[l[t]],a=Jl[l[e]],d=`${i}_${r}`,p=`${r}_${i}`;p in h&&h[p]?($l.dot(h[p].normal)<=n&&(u.push(o.x,o.y,o.z),u.push(a.x,a.y,a.z)),h[p]=null):d in h||(h[d]={index0:s[t],index1:s[e],normal:$l.clone()})}}for(const t in h)if(h[t]){const{index0:e,index1:i}=h[t];Xl.fromBufferAttribute(o,e),Yl.fromBufferAttribute(o,i),u.push(Xl.x,Xl.y,Xl.z),u.push(Yl.x,Yl.y,Yl.z)}this.setAttribute("position",new kr(u,3))}}const Ql=function(t,e,i){i=i||2;const n=e&&e.length,r=n?e[0]*i:t.length;let o=tc(t,0,r,i,!0);const a=[];if(!o||o.next===o.prev)return a;let s,l,c,h,u,d,p;if(n&&(o=function(t,e,i,n){const r=[];let o,a,s,l,c;for(o=0,a=e.length;o<a;o++)s=e[o]*n,l=o<a-1?e[o+1]*n:t.length,c=tc(t,s,l,n,!1),c===c.next&&(c.steiner=!0),r.push(uc(c));for(r.sort(sc),o=0;o<r.length;o++)lc(r[o],i),i=ec(i,i.next);return i}(t,e,o,i)),t.length>80*i){s=c=t[0],l=h=t[1];for(let e=i;e<r;e+=i)u=t[e],d=t[e+1],u<s&&(s=u),d<l&&(l=d),u>c&&(c=u),d>h&&(h=d);p=Math.max(c-s,h-l),p=0!==p?1/p:0}return ic(o,a,i,s,l,p),a};function tc(t,e,i,n,r){let o,a;if(r===function(t,e,i,n){let r=0;for(let o=e,a=i-n;o<i;o+=n)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}(t,e,i,n)>0)for(o=e;o<i;o+=n)a=bc(o,t[o],t[o+1],a);else for(o=i-n;o>=e;o-=n)a=bc(o,t[o],t[o+1],a);return a&&mc(a,a.next)&&(wc(a),a=a.next),a}function ec(t,e){if(!t)return t;e||(e=t);let i,n=t;do{if(i=!1,n.steiner||!mc(n,n.next)&&0!==fc(n.prev,n,n.next))n=n.next;else{if(wc(n),n=e=n.prev,n===n.next)break;i=!0}}while(i||n!==e);return e}function ic(t,e,i,n,r,o,a){if(!t)return;!a&&o&&function(t,e,i,n){let r=t;do{null===r.z&&(r.z=hc(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){let e,i,n,r,o,a,s,l,c=1;do{for(i=t,t=null,o=null,a=0;i;){for(a++,n=i,s=0,e=0;e<c&&(s++,n=n.nextZ,n);e++);for(l=c;s>0||l>0&&n;)0!==s&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,s--):(r=n,n=n.nextZ,l--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;i=n}o.nextZ=null,c*=2}while(a>1)}(r)}(t,n,r,o);let s,l,c=t;for(;t.prev!==t.next;)if(s=t.prev,l=t.next,o?rc(t,n,r,o):nc(t))e.push(s.i/i),e.push(t.i/i),e.push(l.i/i),wc(t),t=l.next,c=l.next;else if((t=l)===c){a?1===a?ic(t=oc(ec(t),e,i),e,i,n,r,o,2):2===a&&ac(t,e,i,n,r,o):ic(ec(t),e,i,n,r,o,1);break}}function nc(t){const e=t.prev,i=t,n=t.next;if(fc(e,i,n)>=0)return!1;let r=t.next.next;for(;r!==t.prev;){if(dc(e.x,e.y,i.x,i.y,n.x,n.y,r.x,r.y)&&fc(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function rc(t,e,i,n){const r=t.prev,o=t,a=t.next;if(fc(r,o,a)>=0)return!1;const s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,l=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,c=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,h=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,u=hc(s,l,e,i,n),d=hc(c,h,e,i,n);let p=t.prevZ,f=t.nextZ;for(;p&&p.z>=u&&f&&f.z<=d;){if(p!==t.prev&&p!==t.next&&dc(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&fc(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,f!==t.prev&&f!==t.next&&dc(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&fc(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;p&&p.z>=u;){if(p!==t.prev&&p!==t.next&&dc(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&fc(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;f&&f.z<=d;){if(f!==t.prev&&f!==t.next&&dc(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&fc(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function oc(t,e,i){let n=t;do{const r=n.prev,o=n.next.next;!mc(r,o)&&gc(r,n,n.next,o)&&vc(r,o)&&vc(o,r)&&(e.push(r.i/i),e.push(n.i/i),e.push(o.i/i),wc(n),wc(n.next),n=t=o),n=n.next}while(n!==t);return ec(n)}function ac(t,e,i,n,r,o){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.i!==t.i&&pc(a,t)){let s=xc(a,t);return a=ec(a,a.next),s=ec(s,s.next),ic(a,e,i,n,r,o),void ic(s,e,i,n,r,o)}t=t.next}a=a.next}while(a!==t)}function sc(t,e){return t.x-e.x}function lc(t,e){if(e=function(t,e){let i=e;const n=t.x,r=t.y;let o,a=-1/0;do{if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const t=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=n&&t>a){if(a=t,t===n){if(r===i.y)return i;if(r===i.next.y)return i.next}o=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!o)return null;if(n===a)return o;const s=o,l=o.x,c=o.y;let h,u=1/0;i=o;do{n>=i.x&&i.x>=l&&n!==i.x&&dc(r<c?n:a,r,l,c,r<c?a:n,r,i.x,i.y)&&(h=Math.abs(r-i.y)/(n-i.x),vc(i,t)&&(h<u||h===u&&(i.x>o.x||i.x===o.x&&cc(o,i)))&&(o=i,u=h)),i=i.next}while(i!==s);return o}(t,e)){const i=xc(e,t);ec(e,e.next),ec(i,i.next)}}function cc(t,e){return fc(t.prev,t,e.prev)<0&&fc(e.next,t,t.next)<0}function hc(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function uc(t){let e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function dc(t,e,i,n,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(n-s)-(i-a)*(e-s)>=0&&(i-a)*(o-s)-(r-a)*(n-s)>=0}function pc(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&gc(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(vc(t,e)&&vc(e,t)&&function(t,e){let i=t,n=!1;const r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)&&(fc(t.prev,t,e.prev)||fc(t,e.prev,e))||mc(t,e)&&fc(t.prev,t,t.next)>0&&fc(e.prev,e,e.next)>0)}function fc(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function mc(t,e){return t.x===e.x&&t.y===e.y}function gc(t,e,i,n){const r=_c(fc(t,e,i)),o=_c(fc(t,e,n)),a=_c(fc(i,n,t)),s=_c(fc(i,n,e));return r!==o&&a!==s||(!(0!==r||!yc(t,i,e))||(!(0!==o||!yc(t,n,e))||(!(0!==a||!yc(i,t,n))||!(0!==s||!yc(i,e,n)))))}function yc(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function _c(t){return t>0?1:t<0?-1:0}function vc(t,e){return fc(t.prev,t,t.next)<0?fc(t,e,t.next)>=0&&fc(t,t.prev,e)>=0:fc(t,e,t.prev)<0||fc(t,t.next,e)<0}function xc(t,e){const i=new Mc(t.i,t.x,t.y),n=new Mc(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function bc(t,e,i,n){const r=new Mc(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function wc(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Mc(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}const Tc={area:function(t){const e=t.length;let i=0;for(let n=e-1,r=0;r<e;n=r++)i+=t[n].x*t[r].y-t[r].x*t[n].y;return.5*i},isClockWise:function(t){return Tc.area(t)<0},triangulateShape:function(t,e){const i=[],n=[],r=[];Sc(t),Ec(i,t);let o=t.length;e.forEach(Sc);for(let t=0;t<e.length;t++)n.push(o),o+=e[t].length,Ec(i,e[t]);const a=Ql(i,n);for(let t=0;t<a.length;t+=3)r.push(a.slice(t,t+3));return r}};function Sc(t){const e=t.length;e>2&&t[e-1].equals(t[0])&&t.pop()}function Ec(t,e){for(let i=0;i<e.length;i++)t.push(e[i].x),t.push(e[i].y)}class Cc extends Wr{constructor(t,e){super(),this.type="ExtrudeGeometry",this.parameters={shapes:t,options:e},t=Array.isArray(t)?t:[t];const i=this,n=[],r=[];for(let e=0,i=t.length;e<i;e++){o(t[e])}function o(t){const o=[],a=void 0!==e.curveSegments?e.curveSegments:12,s=void 0!==e.steps?e.steps:1;let l=void 0!==e.depth?e.depth:100,c=void 0===e.bevelEnabled||e.bevelEnabled,h=void 0!==e.bevelThickness?e.bevelThickness:6,u=void 0!==e.bevelSize?e.bevelSize:h-2,d=void 0!==e.bevelOffset?e.bevelOffset:0,p=void 0!==e.bevelSegments?e.bevelSegments:3;const f=e.extrudePath,m=void 0!==e.UVGenerator?e.UVGenerator:Ac;void 0!==e.amount&&(console.warn("THREE.ExtrudeBufferGeometry: amount has been renamed to depth."),l=e.amount);let g,y,_,v,x,b=!1;f&&(g=f.getSpacedPoints(s),b=!0,c=!1,y=f.computeFrenetFrames(s,!1),_=new $i,v=new $i,x=new $i),c||(p=0,h=0,u=0,d=0);const w=t.extractPoints(a);let M=w.shape;const T=w.holes;if(!Tc.isClockWise(M)){M=M.reverse();for(let t=0,e=T.length;t<e;t++){const e=T[t];Tc.isClockWise(e)&&(T[t]=e.reverse())}}const S=Tc.triangulateShape(M,T),E=M;for(let t=0,e=T.length;t<e;t++){const e=T[t];M=M.concat(e)}function C(t,e,i){return e||console.error("THREE.ExtrudeGeometry: vec does not exist"),e.clone().multiplyScalar(i).add(t)}const A=M.length,P=S.length;function L(t,e,i){let n,r,o;const a=t.x-e.x,s=t.y-e.y,l=i.x-t.x,c=i.y-t.y,h=a*a+s*s,u=a*c-s*l;if(Math.abs(u)>Number.EPSILON){const u=Math.sqrt(h),d=Math.sqrt(l*l+c*c),p=e.x-s/u,f=e.y+a/u,m=((i.x-c/d-p)*c-(i.y+l/d-f)*l)/(a*c-s*l);n=p+a*m-t.x,r=f+s*m-t.y;const g=n*n+r*r;if(g<=2)return new Ni(n,r);o=Math.sqrt(g/2)}else{let t=!1;a>Number.EPSILON?l>Number.EPSILON&&(t=!0):a<-Number.EPSILON?l<-Number.EPSILON&&(t=!0):Math.sign(s)===Math.sign(c)&&(t=!0),t?(n=-s,r=a,o=Math.sqrt(h)):(n=a,r=s,o=Math.sqrt(h/2))}return new Ni(n/o,r/o)}const I=[];for(let t=0,e=E.length,i=e-1,n=t+1;t<e;t++,i++,n++)i===e&&(i=0),n===e&&(n=0),I[t]=L(E[t],E[i],E[n]);const R=[];let D,k=I.concat();for(let t=0,e=T.length;t<e;t++){const e=T[t];D=[];for(let t=0,i=e.length,n=i-1,r=t+1;t<i;t++,n++,r++)n===i&&(n=0),r===i&&(r=0),D[t]=L(e[t],e[n],e[r]);R.push(D),k=k.concat(D)}for(let t=0;t<p;t++){const e=t/p,i=h*Math.cos(e*Math.PI/2),n=u*Math.sin(e*Math.PI/2)+d;for(let t=0,e=E.length;t<e;t++){const e=C(E[t],I[t],n);B(e.x,e.y,-i)}for(let t=0,e=T.length;t<e;t++){const e=T[t];D=R[t];for(let t=0,r=e.length;t<r;t++){const r=C(e[t],D[t],n);B(r.x,r.y,-i)}}}const O=u+d;for(let t=0;t<A;t++){const e=c?C(M[t],k[t],O):M[t];b?(v.copy(y.normals[0]).multiplyScalar(e.x),_.copy(y.binormals[0]).multiplyScalar(e.y),x.copy(g[0]).add(v).add(_),B(x.x,x.y,x.z)):B(e.x,e.y,0)}for(let t=1;t<=s;t++)for(let e=0;e<A;e++){const i=c?C(M[e],k[e],O):M[e];b?(v.copy(y.normals[t]).multiplyScalar(i.x),_.copy(y.binormals[t]).multiplyScalar(i.y),x.copy(g[t]).add(v).add(_),B(x.x,x.y,x.z)):B(i.x,i.y,l/s*t)}for(let t=p-1;t>=0;t--){const e=t/p,i=h*Math.cos(e*Math.PI/2),n=u*Math.sin(e*Math.PI/2)+d;for(let t=0,e=E.length;t<e;t++){const e=C(E[t],I[t],n);B(e.x,e.y,l+i)}for(let t=0,e=T.length;t<e;t++){const e=T[t];D=R[t];for(let t=0,r=e.length;t<r;t++){const r=C(e[t],D[t],n);b?B(r.x,r.y+g[s-1].y,g[s-1].x+i):B(r.x,r.y,l+i)}}}function z(t,e){let i=t.length;for(;--i>=0;){const n=i;let r=i-1;r<0&&(r=t.length-1);for(let t=0,i=s+2*p;t<i;t++){const i=A*t,o=A*(t+1);N(e+n+i,e+r+i,e+r+o,e+n+o)}}}function B(t,e,i){o.push(t),o.push(e),o.push(i)}function F(t,e,r){j(t),j(e),j(r);const o=n.length/3,a=m.generateTopUV(i,n,o-3,o-2,o-1);G(a[0]),G(a[1]),G(a[2])}function N(t,e,r,o){j(t),j(e),j(o),j(e),j(r),j(o);const a=n.length/3,s=m.generateSideWallUV(i,n,a-6,a-3,a-2,a-1);G(s[0]),G(s[1]),G(s[3]),G(s[1]),G(s[2]),G(s[3])}function j(t){n.push(o[3*t+0]),n.push(o[3*t+1]),n.push(o[3*t+2])}function G(t){r.push(t.x),r.push(t.y)}!function(){const t=n.length/3;if(c){let t=0,e=A*t;for(let t=0;t<P;t++){const i=S[t];F(i[2]+e,i[1]+e,i[0]+e)}t=s+2*p,e=A*t;for(let t=0;t<P;t++){const i=S[t];F(i[0]+e,i[1]+e,i[2]+e)}}else{for(let t=0;t<P;t++){const e=S[t];F(e[2],e[1],e[0])}for(let t=0;t<P;t++){const e=S[t];F(e[0]+A*s,e[1]+A*s,e[2]+A*s)}}i.addGroup(t,n.length/3-t,0)}(),function(){const t=n.length/3;let e=0;z(E,e),e+=E.length;for(let t=0,i=T.length;t<i;t++){const i=T[t];z(i,e),e+=i.length}i.addGroup(t,n.length/3-t,1)}()}this.setAttribute("position",new kr(n,3)),this.setAttribute("uv",new kr(r,2)),this.computeVertexNormals()}toJSON(){const t=Wr.prototype.toJSON.call(this);return function(t,e,i){if(i.shapes=[],Array.isArray(t))for(let e=0,n=t.length;e<n;e++){const n=t[e];i.shapes.push(n.uuid)}else i.shapes.push(t.uuid);void 0!==e.extrudePath&&(i.options.extrudePath=e.extrudePath.toJSON());return i}(this.parameters.shapes,this.parameters.options,t)}}const Ac={generateTopUV:function(t,e,i,n,r){const o=e[3*i],a=e[3*i+1],s=e[3*n],l=e[3*n+1],c=e[3*r],h=e[3*r+1];return[new Ni(o,a),new Ni(s,l),new Ni(c,h)]},generateSideWallUV:function(t,e,i,n,r,o){const a=e[3*i],s=e[3*i+1],l=e[3*i+2],c=e[3*n],h=e[3*n+1],u=e[3*n+2],d=e[3*r],p=e[3*r+1],f=e[3*r+2],m=e[3*o],g=e[3*o+1],y=e[3*o+2];return Math.abs(s-h)<.01?[new Ni(a,1-l),new Ni(c,1-u),new Ni(d,1-f),new Ni(m,1-y)]:[new Ni(s,1-l),new Ni(h,1-u),new Ni(p,1-f),new Ni(g,1-y)]}};class Pc extends Wl{constructor(t=1,e=0){const i=(1+Math.sqrt(5))/2;super([-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],t,e),this.type="IcosahedronGeometry",this.parameters={radius:t,detail:e}}}class Lc extends Wr{constructor(t,e=12,i=0,n=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:t,segments:e,phiStart:i,phiLength:n},e=Math.floor(e),n=Fi.clamp(n,0,2*Math.PI);const r=[],o=[],a=[],s=1/e,l=new $i,c=new Ni;for(let r=0;r<=e;r++){const h=i+r*s*n,u=Math.sin(h),d=Math.cos(h);for(let i=0;i<=t.length-1;i++)l.x=t[i].x*u,l.y=t[i].y,l.z=t[i].x*d,o.push(l.x,l.y,l.z),c.x=r/e,c.y=i/(t.length-1),a.push(c.x,c.y)}for(let i=0;i<e;i++)for(let e=0;e<t.length-1;e++){const n=e+i*t.length,o=n,a=n+t.length,s=n+t.length+1,l=n+1;r.push(o,a,l),r.push(a,s,l)}if(this.setIndex(r),this.setAttribute("position",new kr(o,3)),this.setAttribute("uv",new kr(a,2)),this.computeVertexNormals(),n===2*Math.PI){const i=this.attributes.normal.array,n=new $i,r=new $i,o=new $i,a=e*t.length*3;for(let e=0,s=0;e<t.length;e++,s+=3)n.x=i[s+0],n.y=i[s+1],n.z=i[s+2],r.x=i[a+s+0],r.y=i[a+s+1],r.z=i[a+s+2],o.addVectors(n,r).normalize(),i[s+0]=i[a+s+0]=o.x,i[s+1]=i[a+s+1]=o.y,i[s+2]=i[a+s+2]=o.z}}}class Ic extends Wl{constructor(t=1,e=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],t,e),this.type="OctahedronGeometry",this.parameters={radius:t,detail:e}}}function Rc(t,e,i){Wr.call(this),this.type="ParametricGeometry",this.parameters={func:t,slices:e,stacks:i};const n=[],r=[],o=[],a=[],s=1e-5,l=new $i,c=new $i,h=new $i,u=new $i,d=new $i;t.length<3&&console.error("THREE.ParametricGeometry: Function must now modify a Vector3 as third parameter.");const p=e+1;for(let n=0;n<=i;n++){const p=n/i;for(let i=0;i<=e;i++){const n=i/e;t(n,p,c),r.push(c.x,c.y,c.z),n-s>=0?(t(n-s,p,h),u.subVectors(c,h)):(t(n+s,p,h),u.subVectors(h,c)),p-s>=0?(t(n,p-s,h),d.subVectors(c,h)):(t(n,p+s,h),d.subVectors(h,c)),l.crossVectors(u,d).normalize(),o.push(l.x,l.y,l.z),a.push(n,p)}}for(let t=0;t<i;t++)for(let i=0;i<e;i++){const e=t*p+i,r=t*p+i+1,o=(t+1)*p+i+1,a=(t+1)*p+i;n.push(e,r,a),n.push(r,o,a)}this.setIndex(n),this.setAttribute("position",new kr(r,3)),this.setAttribute("normal",new kr(o,3)),this.setAttribute("uv",new kr(a,2))}Rc.prototype=Object.create(Wr.prototype),Rc.prototype.constructor=Rc;class Dc extends Wr{constructor(t=.5,e=1,i=8,n=1,r=0,o=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:i,phiSegments:n,thetaStart:r,thetaLength:o},i=Math.max(3,i);const a=[],s=[],l=[],c=[];let h=t;const u=(e-t)/(n=Math.max(1,n)),d=new $i,p=new Ni;for(let t=0;t<=n;t++){for(let t=0;t<=i;t++){const n=r+t/i*o;d.x=h*Math.cos(n),d.y=h*Math.sin(n),s.push(d.x,d.y,d.z),l.push(0,0,1),p.x=(d.x/e+1)/2,p.y=(d.y/e+1)/2,c.push(p.x,p.y)}h+=u}for(let t=0;t<n;t++){const e=t*(i+1);for(let t=0;t<i;t++){const n=t+e,r=n,o=n+i+1,s=n+i+2,l=n+1;a.push(r,o,l),a.push(o,s,l)}}this.setIndex(a),this.setAttribute("position",new kr(s,3)),this.setAttribute("normal",new kr(l,3)),this.setAttribute("uv",new kr(c,2))}}class kc extends Wr{constructor(t,e=12){super(),this.type="ShapeGeometry",this.parameters={shapes:t,curveSegments:e};const i=[],n=[],r=[],o=[];let a=0,s=0;if(!1===Array.isArray(t))l(t);else for(let e=0;e<t.length;e++)l(t[e]),this.addGroup(a,s,e),a+=s,s=0;function l(t){const a=n.length/3,l=t.extractPoints(e);let c=l.shape;const h=l.holes;!1===Tc.isClockWise(c)&&(c=c.reverse());for(let t=0,e=h.length;t<e;t++){const e=h[t];!0===Tc.isClockWise(e)&&(h[t]=e.reverse())}const u=Tc.triangulateShape(c,h);for(let t=0,e=h.length;t<e;t++){const e=h[t];c=c.concat(e)}for(let t=0,e=c.length;t<e;t++){const e=c[t];n.push(e.x,e.y,0),r.push(0,0,1),o.push(e.x,e.y)}for(let t=0,e=u.length;t<e;t++){const e=u[t],n=e[0]+a,r=e[1]+a,o=e[2]+a;i.push(n,r,o),s+=3}}this.setIndex(i),this.setAttribute("position",new kr(n,3)),this.setAttribute("normal",new kr(r,3)),this.setAttribute("uv",new kr(o,2))}toJSON(){const t=Wr.prototype.toJSON.call(this);return function(t,e){if(e.shapes=[],Array.isArray(t))for(let i=0,n=t.length;i<n;i++){const n=t[i];e.shapes.push(n.uuid)}else e.shapes.push(t.uuid);return e}(this.parameters.shapes,t)}}class Oc extends Wr{constructor(t=1,e=8,i=6,n=0,r=2*Math.PI,o=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:n,phiLength:r,thetaStart:o,thetaLength:a},e=Math.max(3,Math.floor(e)),i=Math.max(2,Math.floor(i));const s=Math.min(o+a,Math.PI);let l=0;const c=[],h=new $i,u=new $i,d=[],p=[],f=[],m=[];for(let d=0;d<=i;d++){const g=[],y=d/i;let _=0;0==d&&0==o?_=.5/e:d==i&&s==Math.PI&&(_=-.5/e);for(let i=0;i<=e;i++){const s=i/e;h.x=-t*Math.cos(n+s*r)*Math.sin(o+y*a),h.y=t*Math.cos(o+y*a),h.z=t*Math.sin(n+s*r)*Math.sin(o+y*a),p.push(h.x,h.y,h.z),u.copy(h).normalize(),f.push(u.x,u.y,u.z),m.push(s+_,1-y),g.push(l++)}c.push(g)}for(let t=0;t<i;t++)for(let n=0;n<e;n++){const e=c[t][n+1],r=c[t][n],a=c[t+1][n],l=c[t+1][n+1];(0!==t||o>0)&&d.push(e,r,l),(t!==i-1||s<Math.PI)&&d.push(r,a,l)}this.setIndex(d),this.setAttribute("position",new kr(p,3)),this.setAttribute("normal",new kr(f,3)),this.setAttribute("uv",new kr(m,2))}}class zc extends Wl{constructor(t=1,e=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],t,e),this.type="TetrahedronGeometry",this.parameters={radius:t,detail:e}}}class Bc extends Cc{constructor(t,e={}){const i=e.font;if(!i||!i.isFont)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new Wr;const n=i.generateShapes(t,e.size);e.depth=void 0!==e.height?e.height:50,void 0===e.bevelThickness&&(e.bevelThickness=10),void 0===e.bevelSize&&(e.bevelSize=8),void 0===e.bevelEnabled&&(e.bevelEnabled=!1),super(n,e),this.type="TextGeometry"}}class Fc extends Wr{constructor(t=1,e=.4,i=8,n=6,r=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:t,tube:e,radialSegments:i,tubularSegments:n,arc:r},i=Math.floor(i),n=Math.floor(n);const o=[],a=[],s=[],l=[],c=new $i,h=new $i,u=new $i;for(let o=0;o<=i;o++)for(let d=0;d<=n;d++){const p=d/n*r,f=o/i*Math.PI*2;h.x=(t+e*Math.cos(f))*Math.cos(p),h.y=(t+e*Math.cos(f))*Math.sin(p),h.z=e*Math.sin(f),a.push(h.x,h.y,h.z),c.x=t*Math.cos(p),c.y=t*Math.sin(p),u.subVectors(h,c).normalize(),s.push(u.x,u.y,u.z),l.push(d/n),l.push(o/i)}for(let t=1;t<=i;t++)for(let e=1;e<=n;e++){const i=(n+1)*t+e-1,r=(n+1)*(t-1)+e-1,a=(n+1)*(t-1)+e,s=(n+1)*t+e;o.push(i,r,s),o.push(r,a,s)}this.setIndex(o),this.setAttribute("position",new kr(a,3)),this.setAttribute("normal",new kr(s,3)),this.setAttribute("uv",new kr(l,2))}}class Nc extends Wr{constructor(t=1,e=.4,i=64,n=8,r=2,o=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:t,tube:e,tubularSegments:i,radialSegments:n,p:r,q:o},i=Math.floor(i),n=Math.floor(n);const a=[],s=[],l=[],c=[],h=new $i,u=new $i,d=new $i,p=new $i,f=new $i,m=new $i,g=new $i;for(let a=0;a<=i;++a){const _=a/i*r*Math.PI*2;y(_,r,o,t,d),y(_+.01,r,o,t,p),m.subVectors(p,d),g.addVectors(p,d),f.crossVectors(m,g),g.crossVectors(f,m),f.normalize(),g.normalize();for(let t=0;t<=n;++t){const r=t/n*Math.PI*2,o=-e*Math.cos(r),p=e*Math.sin(r);h.x=d.x+(o*g.x+p*f.x),h.y=d.y+(o*g.y+p*f.y),h.z=d.z+(o*g.z+p*f.z),s.push(h.x,h.y,h.z),u.subVectors(h,d).normalize(),l.push(u.x,u.y,u.z),c.push(a/i),c.push(t/n)}}for(let t=1;t<=i;t++)for(let e=1;e<=n;e++){const i=(n+1)*(t-1)+(e-1),r=(n+1)*t+(e-1),o=(n+1)*t+e,s=(n+1)*(t-1)+e;a.push(i,r,s),a.push(r,o,s)}function y(t,e,i,n,r){const o=Math.cos(t),a=Math.sin(t),s=i/e*t,l=Math.cos(s);r.x=n*(2+l)*.5*o,r.y=n*(2+l)*a*.5,r.z=n*Math.sin(s)*.5}this.setIndex(a),this.setAttribute("position",new kr(s,3)),this.setAttribute("normal",new kr(l,3)),this.setAttribute("uv",new kr(c,2))}}class jc extends Wr{constructor(t,e=64,i=1,n=8,r=!1){super(),this.type="TubeGeometry",this.parameters={path:t,tubularSegments:e,radius:i,radialSegments:n,closed:r};const o=t.computeFrenetFrames(e,r);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals;const a=new $i,s=new $i,l=new Ni;let c=new $i;const h=[],u=[],d=[],p=[];function f(r){c=t.getPointAt(r/e,c);const l=o.normals[r],d=o.binormals[r];for(let t=0;t<=n;t++){const e=t/n*Math.PI*2,r=Math.sin(e),o=-Math.cos(e);s.x=o*l.x+r*d.x,s.y=o*l.y+r*d.y,s.z=o*l.z+r*d.z,s.normalize(),u.push(s.x,s.y,s.z),a.x=c.x+i*s.x,a.y=c.y+i*s.y,a.z=c.z+i*s.z,h.push(a.x,a.y,a.z)}}!function(){for(let t=0;t<e;t++)f(t);f(!1===r?e:0),function(){for(let t=0;t<=e;t++)for(let i=0;i<=n;i++)l.x=t/e,l.y=i/n,d.push(l.x,l.y)}(),function(){for(let t=1;t<=e;t++)for(let e=1;e<=n;e++){const i=(n+1)*(t-1)+(e-1),r=(n+1)*t+(e-1),o=(n+1)*t+e,a=(n+1)*(t-1)+e;p.push(i,r,a),p.push(r,o,a)}}()}(),this.setIndex(p),this.setAttribute("position",new kr(h,3)),this.setAttribute("normal",new kr(u,3)),this.setAttribute("uv",new kr(d,2))}toJSON(){const t=Wr.prototype.toJSON.call(this);return t.path=this.parameters.path.toJSON(),t}}class Gc extends Wr{constructor(t){if(super(),this.type="WireframeGeometry",!0===t.isGeometry)return void console.error("THREE.WireframeGeometry no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");const e=[],i=[0,0],n={},r=new $i;if(null!==t.index){const o=t.attributes.position,a=t.index;let s=t.groups;0===s.length&&(s=[{start:0,count:a.count,materialIndex:0}]);for(let t=0,e=s.length;t<e;++t){const e=s[t],r=e.start;for(let t=r,o=r+e.count;t<o;t+=3)for(let e=0;e<3;e++){const r=a.getX(t+e),o=a.getX(t+(e+1)%3);i[0]=Math.min(r,o),i[1]=Math.max(r,o);const s=i[0]+","+i[1];void 0===n[s]&&(n[s]={index1:i[0],index2:i[1]})}}for(const t in n){const i=n[t];r.fromBufferAttribute(o,i.index1),e.push(r.x,r.y,r.z),r.fromBufferAttribute(o,i.index2),e.push(r.x,r.y,r.z)}}else{const i=t.attributes.position;for(let t=0,n=i.count/3;t<n;t++)for(let n=0;n<3;n++){const o=3*t+n;r.fromBufferAttribute(i,o),e.push(r.x,r.y,r.z);const a=3*t+(n+1)%3;r.fromBufferAttribute(i,a),e.push(r.x,r.y,r.z)}}this.setAttribute("position",new kr(e,3))}}var Uc=Object.freeze({__proto__:null,BoxGeometry:po,BoxBufferGeometry:po,CircleGeometry:Vl,CircleBufferGeometry:Vl,ConeGeometry:Zl,ConeBufferGeometry:Zl,CylinderGeometry:Hl,CylinderBufferGeometry:Hl,DodecahedronGeometry:ql,DodecahedronBufferGeometry:ql,EdgesGeometry:Kl,ExtrudeGeometry:Cc,ExtrudeBufferGeometry:Cc,IcosahedronGeometry:Pc,IcosahedronBufferGeometry:Pc,LatheGeometry:Lc,LatheBufferGeometry:Lc,OctahedronGeometry:Ic,OctahedronBufferGeometry:Ic,ParametricGeometry:Rc,ParametricBufferGeometry:Rc,PlaneGeometry:Po,PlaneBufferGeometry:Po,PolyhedronGeometry:Wl,PolyhedronBufferGeometry:Wl,RingGeometry:Dc,RingBufferGeometry:Dc,ShapeGeometry:kc,ShapeBufferGeometry:kc,SphereGeometry:Oc,SphereBufferGeometry:Oc,TetrahedronGeometry:zc,TetrahedronBufferGeometry:zc,TextGeometry:Bc,TextBufferGeometry:Bc,TorusGeometry:Fc,TorusBufferGeometry:Fc,TorusKnotGeometry:Nc,TorusKnotBufferGeometry:Nc,TubeGeometry:jc,TubeBufferGeometry:jc,WireframeGeometry:Gc});function Vc(t){br.call(this),this.type="ShadowMaterial",this.color=new _r(0),this.transparent=!0,this.setValues(t)}function Hc(t){yo.call(this,t),this.type="RawShaderMaterial"}function Zc(t){br.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new _r(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new _r(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ai,this.normalScale=new Ni(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.vertexTangents=!1,this.setValues(t)}function Wc(t){Zc.call(this),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoat=0,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new Ni(1,1),this.clearcoatNormalMap=null,this.reflectivity=.5,Object.defineProperty(this,"ior",{get:function(){return(1+.4*this.reflectivity)/(1-.4*this.reflectivity)},set:function(t){this.reflectivity=Fi.clamp(2.5*(t-1)/(t+1),0,1)}}),this.sheen=null,this.transmission=0,this.transmissionMap=null,this.setValues(t)}function qc(t){br.call(this),this.type="MeshPhongMaterial",this.color=new _r(16777215),this.specular=new _r(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new _r(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ai,this.normalScale=new Ni(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Y,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function Xc(t){br.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new _r(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new _r(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ai,this.normalScale=new Ni(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function Yc(t){br.call(this),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ai,this.normalScale=new Ni(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function $c(t){br.call(this),this.type="MeshLambertMaterial",this.color=new _r(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new _r(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Y,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function Jc(t){br.call(this),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new _r(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ai,this.normalScale=new Ni(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function Kc(t){bl.call(this),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(t)}Vc.prototype=Object.create(br.prototype),Vc.prototype.constructor=Vc,Vc.prototype.isShadowMaterial=!0,Vc.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.color.copy(t.color),this},Hc.prototype=Object.create(yo.prototype),Hc.prototype.constructor=Hc,Hc.prototype.isRawShaderMaterial=!0,Zc.prototype=Object.create(br.prototype),Zc.prototype.constructor=Zc,Zc.prototype.isMeshStandardMaterial=!0,Zc.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapIntensity=t.envMapIntensity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this.vertexTangents=t.vertexTangents,this},Wc.prototype=Object.create(Zc.prototype),Wc.prototype.constructor=Wc,Wc.prototype.isMeshPhysicalMaterial=!0,Wc.prototype.copy=function(t){return Zc.prototype.copy.call(this,t),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=t.clearcoat,this.clearcoatMap=t.clearcoatMap,this.clearcoatRoughness=t.clearcoatRoughness,this.clearcoatRoughnessMap=t.clearcoatRoughnessMap,this.clearcoatNormalMap=t.clearcoatNormalMap,this.clearcoatNormalScale.copy(t.clearcoatNormalScale),this.reflectivity=t.reflectivity,t.sheen?this.sheen=(this.sheen||new _r).copy(t.sheen):this.sheen=null,this.transmission=t.transmission,this.transmissionMap=t.transmissionMap,this},qc.prototype=Object.create(br.prototype),qc.prototype.constructor=qc,qc.prototype.isMeshPhongMaterial=!0,qc.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},Xc.prototype=Object.create(br.prototype),Xc.prototype.constructor=Xc,Xc.prototype.isMeshToonMaterial=!0,Xc.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.gradientMap=t.gradientMap,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},Yc.prototype=Object.create(br.prototype),Yc.prototype.constructor=Yc,Yc.prototype.isMeshNormalMaterial=!0,Yc.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},$c.prototype=Object.create(br.prototype),$c.prototype.constructor=$c,$c.prototype.isMeshLambertMaterial=!0,$c.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},Jc.prototype=Object.create(br.prototype),Jc.prototype.constructor=Jc,Jc.prototype.isMeshMatcapMaterial=!0,Jc.prototype.copy=function(t){return br.prototype.copy.call(this,t),this.defines={MATCAP:""},this.color.copy(t.color),this.matcap=t.matcap,this.map=t.map,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},Kc.prototype=Object.create(bl.prototype),Kc.prototype.constructor=Kc,Kc.prototype.isLineDashedMaterial=!0,Kc.prototype.copy=function(t){return bl.prototype.copy.call(this,t),this.scale=t.scale,this.dashSize=t.dashSize,this.gapSize=t.gapSize,this};var Qc=Object.freeze({__proto__:null,ShadowMaterial:Vc,SpriteMaterial:Gs,RawShaderMaterial:Hc,ShaderMaterial:yo,PointsMaterial:Rl,MeshPhysicalMaterial:Wc,MeshStandardMaterial:Zc,MeshPhongMaterial:qc,MeshToonMaterial:Xc,MeshNormalMaterial:Yc,MeshLambertMaterial:$c,MeshDepthMaterial:ws,MeshDistanceMaterial:Ms,MeshBasicMaterial:wr,MeshMatcapMaterial:Jc,LineDashedMaterial:Kc,LineBasicMaterial:bl,Material:br});const th={arraySlice:function(t,e,i){return th.isTypedArray(t)?new t.constructor(t.subarray(e,void 0!==i?i:t.length)):t.slice(e,i)},convertArray:function(t,e,i){return!t||!i&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)},isTypedArray:function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},getKeyframeOrder:function(t){const e=t.length,i=new Array(e);for(let t=0;t!==e;++t)i[t]=t;return i.sort((function(e,i){return t[e]-t[i]})),i},sortedArray:function(t,e,i){const n=t.length,r=new t.constructor(n);for(let o=0,a=0;a!==n;++o){const n=i[o]*e;for(let i=0;i!==e;++i)r[a++]=t[n+i]}return r},flattenJSON:function(t,e,i,n){let r=1,o=t[0];for(;void 0!==o&&void 0===o[n];)o=t[r++];if(void 0===o)return;let a=o[n];if(void 0!==a)if(Array.isArray(a))do{a=o[n],void 0!==a&&(e.push(o.time),i.push.apply(i,a)),o=t[r++]}while(void 0!==o);else if(void 0!==a.toArray)do{a=o[n],void 0!==a&&(e.push(o.time),a.toArray(i,i.length)),o=t[r++]}while(void 0!==o);else do{a=o[n],void 0!==a&&(e.push(o.time),i.push(a)),o=t[r++]}while(void 0!==o)},subclip:function(t,e,i,n,r=30){const o=t.clone();o.name=e;const a=[];for(let t=0;t<o.tracks.length;++t){const e=o.tracks[t],s=e.getValueSize(),l=[],c=[];for(let t=0;t<e.times.length;++t){const o=e.times[t]*r;if(!(o<i||o>=n)){l.push(e.times[t]);for(let i=0;i<s;++i)c.push(e.values[t*s+i])}}0!==l.length&&(e.times=th.convertArray(l,e.times.constructor),e.values=th.convertArray(c,e.values.constructor),a.push(e))}o.tracks=a;let s=1/0;for(let t=0;t<o.tracks.length;++t)s>o.tracks[t].times[0]&&(s=o.tracks[t].times[0]);for(let t=0;t<o.tracks.length;++t)o.tracks[t].shift(-1*s);return o.resetDuration(),o},makeClipAdditive:function(t,e=0,i=t,n=30){n<=0&&(n=30);const r=i.tracks.length,o=e/n;for(let e=0;e<r;++e){const n=i.tracks[e],r=n.ValueTypeName;if("bool"===r||"string"===r)continue;const a=t.tracks.find((function(t){return t.name===n.name&&t.ValueTypeName===r}));if(void 0===a)continue;let s=0;const l=n.getValueSize();n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(s=l/3);let c=0;const h=a.getValueSize();a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(c=h/3);const u=n.times.length-1;let d;if(o<=n.times[0]){const t=s,e=l-s;d=th.arraySlice(n.values,t,e)}else if(o>=n.times[u]){const t=u*l+s,e=t+l-s;d=th.arraySlice(n.values,t,e)}else{const t=n.createInterpolant(),e=s,i=l-s;t.evaluate(o),d=th.arraySlice(t.resultBuffer,e,i)}if("quaternion"===r){(new Yi).fromArray(d).normalize().conjugate().toArray(d)}const p=a.times.length;for(let t=0;t<p;++t){const e=t*h+c;if("quaternion"===r)Yi.multiplyQuaternionsFlat(a.values,e,d,0,a.values,e);else{const t=h-2*c;for(let i=0;i<t;++i)a.values[e+i]-=d[i]}}}return t.blendMode=We,t}};function eh(t,e,i,n){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new e.constructor(i),this.sampleValues=e,this.valueSize=i}function ih(t,e,i,n){eh.call(this,t,e,i,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function nh(t,e,i,n){eh.call(this,t,e,i,n)}function rh(t,e,i,n){eh.call(this,t,e,i,n)}function oh(t,e,i,n){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=th.convertArray(e,this.TimeBufferType),this.values=th.convertArray(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}function ah(t,e,i){oh.call(this,t,e,i)}function sh(t,e,i,n){oh.call(this,t,e,i,n)}function lh(t,e,i,n){oh.call(this,t,e,i,n)}function ch(t,e,i,n){eh.call(this,t,e,i,n)}function hh(t,e,i,n){oh.call(this,t,e,i,n)}function uh(t,e,i,n){oh.call(this,t,e,i,n)}function dh(t,e,i,n){oh.call(this,t,e,i,n)}function ph(t,e=-1,i,n=Ze){this.name=t,this.tracks=i,this.duration=e,this.blendMode=n,this.uuid=Fi.generateUUID(),this.duration<0&&this.resetDuration()}function fh(t){if(void 0===t.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const e=function(t){switch(t.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return lh;case"vector":case"vector2":case"vector3":case"vector4":return dh;case"color":return sh;case"quaternion":return hh;case"bool":case"boolean":return ah;case"string":return uh}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+t)}(t.type);if(void 0===t.times){const e=[],i=[];th.flattenJSON(t.keys,e,i,"value"),t.times=e,t.values=i}return void 0!==e.parse?e.parse(t):new e(t.name,t.times,t.values,t.interpolation)}Object.assign(eh.prototype,{evaluate:function(t){const e=this.parameterPositions;let i=this._cachedIndex,n=e[i],r=e[i-1];t:{e:{let o;i:{n:if(!(t<n)){for(let o=i+2;;){if(void 0===n){if(t<r)break n;return i=e.length,this._cachedIndex=i,this.afterEnd_(i-1,t,r)}if(i===o)break;if(r=n,n=e[++i],t<n)break e}o=e.length;break i}if(t>=r)break t;{const a=e[1];t<a&&(i=2,r=a);for(let o=i-2;;){if(void 0===r)return this._cachedIndex=0,this.beforeStart_(0,t,n);if(i===o)break;if(n=r,r=e[--i-1],t>=r)break e}o=i,i=0}}for(;i<o;){const n=i+o>>>1;t<e[n]?o=n:i=n+1}if(n=e[i],r=e[i-1],void 0===r)return this._cachedIndex=0,this.beforeStart_(0,t,n);if(void 0===n)return i=e.length,this._cachedIndex=i,this.afterEnd_(i-1,r,t)}this._cachedIndex=i,this.intervalChanged_(i,r,n)}return this.interpolate_(i,r,t,n)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(t){const e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,r=t*n;for(let t=0;t!==n;++t)e[t]=i[r+t];return e},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),Object.assign(eh.prototype,{beforeStart_:eh.prototype.copySampleValue_,afterEnd_:eh.prototype.copySampleValue_}),ih.prototype=Object.assign(Object.create(eh.prototype),{constructor:ih,DefaultSettings_:{endingStart:Ue,endingEnd:Ue},intervalChanged_:function(t,e,i){const n=this.parameterPositions;let r=t-2,o=t+1,a=n[r],s=n[o];if(void 0===a)switch(this.getSettings_().endingStart){case Ve:r=t,a=2*e-i;break;case He:r=n.length-2,a=e+n[r]-n[r+1];break;default:r=t,a=i}if(void 0===s)switch(this.getSettings_().endingEnd){case Ve:o=t,s=2*i-e;break;case He:o=1,s=i+n[1]-n[0];break;default:o=t-1,s=e}const l=.5*(i-e),c=this.valueSize;this._weightPrev=l/(e-a),this._weightNext=l/(s-i),this._offsetPrev=r*c,this._offsetNext=o*c},interpolate_:function(t,e,i,n){const r=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=t*a,l=s-a,c=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(i-e)/(n-e),f=p*p,m=f*p,g=-u*m+2*u*f-u*p,y=(1+u)*m+(-1.5-2*u)*f+(-.5+u)*p+1,_=(-1-d)*m+(1.5+d)*f+.5*p,v=d*m-d*f;for(let t=0;t!==a;++t)r[t]=g*o[c+t]+y*o[l+t]+_*o[s+t]+v*o[h+t];return r}}),nh.prototype=Object.assign(Object.create(eh.prototype),{constructor:nh,interpolate_:function(t,e,i,n){const r=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=t*a,l=s-a,c=(i-e)/(n-e),h=1-c;for(let t=0;t!==a;++t)r[t]=o[l+t]*h+o[s+t]*c;return r}}),rh.prototype=Object.assign(Object.create(eh.prototype),{constructor:rh,interpolate_:function(t){return this.copySampleValue_(t-1)}}),Object.assign(oh,{toJSON:function(t){const e=t.constructor;let i;if(void 0!==e.toJSON)i=e.toJSON(t);else{i={name:t.name,times:th.convertArray(t.times,Array),values:th.convertArray(t.values,Array)};const e=t.getInterpolation();e!==t.DefaultInterpolation&&(i.interpolation=e)}return i.type=t.ValueTypeName,i}}),Object.assign(oh.prototype,{constructor:oh,TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:je,InterpolantFactoryMethodDiscrete:function(t){return new rh(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodLinear:function(t){return new nh(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:function(t){return new ih(this.times,this.values,this.getValueSize(),t)},setInterpolation:function(t){let e;switch(t){case Ne:e=this.InterpolantFactoryMethodDiscrete;break;case je:e=this.InterpolantFactoryMethodLinear;break;case Ge:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){const e="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(e);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",e),this}return this.createInterpolant=e,this},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return Ne;case this.InterpolantFactoryMethodLinear:return je;case this.InterpolantFactoryMethodSmooth:return Ge}},getValueSize:function(){return this.values.length/this.times.length},shift:function(t){if(0!==t){const e=this.times;for(let i=0,n=e.length;i!==n;++i)e[i]+=t}return this},scale:function(t){if(1!==t){const e=this.times;for(let i=0,n=e.length;i!==n;++i)e[i]*=t}return this},trim:function(t,e){const i=this.times,n=i.length;let r=0,o=n-1;for(;r!==n&&i[r]<t;)++r;for(;-1!==o&&i[o]>e;)--o;if(++o,0!==r||o!==n){r>=o&&(o=Math.max(o,1),r=o-1);const t=this.getValueSize();this.times=th.arraySlice(i,r,o),this.values=th.arraySlice(this.values,r*t,o*t)}return this},validate:function(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),t=!1);const i=this.times,n=this.values,r=i.length;0===r&&(console.error("THREE.KeyframeTrack: Track is empty.",this),t=!1);let o=null;for(let e=0;e!==r;e++){const n=i[e];if("number"==typeof n&&isNaN(n)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,e,n),t=!1;break}if(null!==o&&o>n){console.error("THREE.KeyframeTrack: Out of order keys.",this,e,n,o),t=!1;break}o=n}if(void 0!==n&&th.isTypedArray(n))for(let e=0,i=n.length;e!==i;++e){const i=n[e];if(isNaN(i)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,e,i),t=!1;break}}return t},optimize:function(){const t=th.arraySlice(this.times),e=th.arraySlice(this.values),i=this.getValueSize(),n=this.getInterpolation()===Ge,r=t.length-1;let o=1;for(let a=1;a<r;++a){let r=!1;const s=t[a];if(s!==t[a+1]&&(1!==a||s!==t[0]))if(n)r=!0;else{const t=a*i,n=t-i,o=t+i;for(let a=0;a!==i;++a){const i=e[t+a];if(i!==e[n+a]||i!==e[o+a]){r=!0;break}}}if(r){if(a!==o){t[o]=t[a];const n=a*i,r=o*i;for(let t=0;t!==i;++t)e[r+t]=e[n+t]}++o}}if(r>0){t[o]=t[r];for(let t=r*i,n=o*i,a=0;a!==i;++a)e[n+a]=e[t+a];++o}return o!==t.length?(this.times=th.arraySlice(t,0,o),this.values=th.arraySlice(e,0,o*i)):(this.times=t,this.values=e),this},clone:function(){const t=th.arraySlice(this.times,0),e=th.arraySlice(this.values,0),i=new(0,this.constructor)(this.name,t,e);return i.createInterpolant=this.createInterpolant,i}}),ah.prototype=Object.assign(Object.create(oh.prototype),{constructor:ah,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:Ne,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),sh.prototype=Object.assign(Object.create(oh.prototype),{constructor:sh,ValueTypeName:"color"}),lh.prototype=Object.assign(Object.create(oh.prototype),{constructor:lh,ValueTypeName:"number"}),ch.prototype=Object.assign(Object.create(eh.prototype),{constructor:ch,interpolate_:function(t,e,i,n){const r=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=(i-e)/(n-e);let l=t*a;for(let t=l+a;l!==t;l+=4)Yi.slerpFlat(r,0,o,l-a,o,l,s);return r}}),hh.prototype=Object.assign(Object.create(oh.prototype),{constructor:hh,ValueTypeName:"quaternion",DefaultInterpolation:je,InterpolantFactoryMethodLinear:function(t){return new ch(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:void 0}),uh.prototype=Object.assign(Object.create(oh.prototype),{constructor:uh,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:Ne,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),dh.prototype=Object.assign(Object.create(oh.prototype),{constructor:dh,ValueTypeName:"vector"}),Object.assign(ph,{parse:function(t){const e=[],i=t.tracks,n=1/(t.fps||1);for(let t=0,r=i.length;t!==r;++t)e.push(fh(i[t]).scale(n));const r=new ph(t.name,t.duration,e,t.blendMode);return r.uuid=t.uuid,r},toJSON:function(t){const e=[],i=t.tracks,n={name:t.name,duration:t.duration,tracks:e,uuid:t.uuid,blendMode:t.blendMode};for(let t=0,n=i.length;t!==n;++t)e.push(oh.toJSON(i[t]));return n},CreateFromMorphTargetSequence:function(t,e,i,n){const r=e.length,o=[];for(let t=0;t<r;t++){let a=[],s=[];a.push((t+r-1)%r,t,(t+1)%r),s.push(0,1,0);const l=th.getKeyframeOrder(a);a=th.sortedArray(a,1,l),s=th.sortedArray(s,1,l),n||0!==a[0]||(a.push(r),s.push(s[0])),o.push(new lh(".morphTargetInfluences["+e[t].name+"]",a,s).scale(1/i))}return new ph(t,-1,o)},findByName:function(t,e){let i=t;if(!Array.isArray(t)){const e=t;i=e.geometry&&e.geometry.animations||e.animations}for(let t=0;t<i.length;t++)if(i[t].name===e)return i[t];return null},CreateClipsFromMorphTargetSequences:function(t,e,i){const n={},r=/^([\w-]*?)([\d]+)$/;for(let e=0,i=t.length;e<i;e++){const i=t[e],o=i.name.match(r);if(o&&o.length>1){const t=o[1];let e=n[t];e||(n[t]=e=[]),e.push(i)}}const o=[];for(const t in n)o.push(ph.CreateFromMorphTargetSequence(t,n[t],e,i));return o},parseAnimation:function(t,e){if(!t)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const i=function(t,e,i,n,r){if(0!==i.length){const o=[],a=[];th.flattenJSON(i,o,a,n),0!==o.length&&r.push(new t(e,o,a))}},n=[],r=t.name||"default",o=t.fps||30,a=t.blendMode;let s=t.length||-1;const l=t.hierarchy||[];for(let t=0;t<l.length;t++){const r=l[t].keys;if(r&&0!==r.length)if(r[0].morphTargets){const t={};let e;for(e=0;e<r.length;e++)if(r[e].morphTargets)for(let i=0;i<r[e].morphTargets.length;i++)t[r[e].morphTargets[i]]=-1;for(const i in t){const t=[],o=[];for(let n=0;n!==r[e].morphTargets.length;++n){const n=r[e];t.push(n.time),o.push(n.morphTarget===i?1:0)}n.push(new lh(".morphTargetInfluence["+i+"]",t,o))}s=t.length*(o||1)}else{const o=".bones["+e[t].name+"]";i(dh,o+".position",r,"pos",n),i(hh,o+".quaternion",r,"rot",n),i(dh,o+".scale",r,"scl",n)}}if(0===n.length)return null;return new ph(r,s,n,a)}}),Object.assign(ph.prototype,{resetDuration:function(){let t=0;for(let e=0,i=this.tracks.length;e!==i;++e){const i=this.tracks[e];t=Math.max(t,i.times[i.times.length-1])}return this.duration=t,this},trim:function(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].trim(0,this.duration);return this},validate:function(){let t=!0;for(let e=0;e<this.tracks.length;e++)t=t&&this.tracks[e].validate();return t},optimize:function(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].optimize();return this},clone:function(){const t=[];for(let e=0;e<this.tracks.length;e++)t.push(this.tracks[e].clone());return new ph(this.name,this.duration,t,this.blendMode)},toJSON:function(){return ph.toJSON(this)}});const mh={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};function gh(t,e,i){const n=this;let r=!1,o=0,a=0,s=void 0;const l=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.itemStart=function(t){a++,!1===r&&void 0!==n.onStart&&n.onStart(t,o,a),r=!0},this.itemEnd=function(t){o++,void 0!==n.onProgress&&n.onProgress(t,o,a),o===a&&(r=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(t){void 0!==n.onError&&n.onError(t)},this.resolveURL=function(t){return s?s(t):t},this.setURLModifier=function(t){return s=t,this},this.addHandler=function(t,e){return l.push(t,e),this},this.removeHandler=function(t){const e=l.indexOf(t);return-1!==e&&l.splice(e,2),this},this.getHandler=function(t){for(let e=0,i=l.length;e<i;e+=2){const i=l[e],n=l[e+1];if(i.global&&(i.lastIndex=0),i.test(t))return n}return null}}const yh=new gh;function _h(t){this.manager=void 0!==t?t:yh,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}Object.assign(_h.prototype,{load:function(){},loadAsync:function(t,e){const i=this;return new Promise((function(n,r){i.load(t,n,e,r)}))},parse:function(){},setCrossOrigin:function(t){return this.crossOrigin=t,this},setWithCredentials:function(t){return this.withCredentials=t,this},setPath:function(t){return this.path=t,this},setResourcePath:function(t){return this.resourcePath=t,this},setRequestHeader:function(t){return this.requestHeader=t,this}});const vh={};function xh(t){_h.call(this,t)}function bh(t){_h.call(this,t)}function wh(t){_h.call(this,t)}function Mh(t){_h.call(this,t)}function Th(t){_h.call(this,t)}function Sh(t){_h.call(this,t)}function Eh(t){_h.call(this,t)}function Ch(){this.type="Curve",this.arcLengthDivisions=200}function Ah(t,e,i,n,r,o,a,s){Ch.call(this),this.type="EllipseCurve",this.aX=t||0,this.aY=e||0,this.xRadius=i||1,this.yRadius=n||1,this.aStartAngle=r||0,this.aEndAngle=o||2*Math.PI,this.aClockwise=a||!1,this.aRotation=s||0}function Ph(t,e,i,n,r,o){Ah.call(this,t,e,i,i,n,r,o),this.type="ArcCurve"}function Lh(){let t=0,e=0,i=0,n=0;function r(r,o,a,s){t=r,e=a,i=-3*r+3*o-2*a-s,n=2*r-2*o+a+s}return{initCatmullRom:function(t,e,i,n,o){r(e,i,o*(i-t),o*(n-e))},initNonuniformCatmullRom:function(t,e,i,n,o,a,s){let l=(e-t)/o-(i-t)/(o+a)+(i-e)/a,c=(i-e)/a-(n-e)/(a+s)+(n-i)/s;l*=a,c*=a,r(e,i,l,c)},calc:function(r){const o=r*r;return t+e*r+i*o+n*(o*r)}}}xh.prototype=Object.assign(Object.create(_h.prototype),{constructor:xh,load:function(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,o=mh.get(t);if(void 0!==o)return r.manager.itemStart(t),setTimeout((function(){e&&e(o),r.manager.itemEnd(t)}),0),o;if(void 0!==vh[t])return void vh[t].push({onLoad:e,onProgress:i,onError:n});const a=t.match(/^data:(.*?)(;base64)?,(.*)$/);let s;if(a){const i=a[1],o=!!a[2];let s=a[3];s=decodeURIComponent(s),o&&(s=atob(s));try{let n;const o=(this.responseType||"").toLowerCase();switch(o){case"arraybuffer":case"blob":const t=new Uint8Array(s.length);for(let e=0;e<s.length;e++)t[e]=s.charCodeAt(e);n="blob"===o?new Blob([t.buffer],{type:i}):t.buffer;break;case"document":const e=new DOMParser;n=e.parseFromString(s,i);break;case"json":n=JSON.parse(s);break;default:n=s}setTimeout((function(){e&&e(n),r.manager.itemEnd(t)}),0)}catch(e){setTimeout((function(){n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)}),0)}}else{vh[t]=[],vh[t].push({onLoad:e,onProgress:i,onError:n}),s=new XMLHttpRequest,s.open("GET",t,!0),s.addEventListener("load",(function(e){const i=this.response,n=vh[t];if(delete vh[t],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),mh.add(t,i);for(let t=0,e=n.length;t<e;t++){const e=n[t];e.onLoad&&e.onLoad(i)}r.manager.itemEnd(t)}else{for(let t=0,i=n.length;t<i;t++){const i=n[t];i.onError&&i.onError(e)}r.manager.itemError(t),r.manager.itemEnd(t)}}),!1),s.addEventListener("progress",(function(e){const i=vh[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onProgress&&n.onProgress(e)}}),!1),s.addEventListener("error",(function(e){const i=vh[t];delete vh[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onError&&n.onError(e)}r.manager.itemError(t),r.manager.itemEnd(t)}),!1),s.addEventListener("abort",(function(e){const i=vh[t];delete vh[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onError&&n.onError(e)}r.manager.itemError(t),r.manager.itemEnd(t)}),!1),void 0!==this.responseType&&(s.responseType=this.responseType),void 0!==this.withCredentials&&(s.withCredentials=this.withCredentials),s.overrideMimeType&&s.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(const t in this.requestHeader)s.setRequestHeader(t,this.requestHeader[t]);s.send(null)}return r.manager.itemStart(t),s},setResponseType:function(t){return this.responseType=t,this},setMimeType:function(t){return this.mimeType=t,this}}),bh.prototype=Object.assign(Object.create(_h.prototype),{constructor:bh,load:function(t,e,i,n){const r=this,o=new xh(r.manager);o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(t,(function(i){try{e(r.parse(JSON.parse(i)))}catch(e){n?n(e):console.error(e),r.manager.itemError(t)}}),i,n)},parse:function(t){const e=[];for(let i=0;i<t.length;i++){const n=ph.parse(t[i]);e.push(n)}return e}}),wh.prototype=Object.assign(Object.create(_h.prototype),{constructor:wh,load:function(t,e,i,n){const r=this,o=[],a=new jl,s=new xh(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(r.withCredentials);let l=0;function c(c){s.load(t[c],(function(t){const i=r.parse(t,!0);o[c]={width:i.width,height:i.height,format:i.format,mipmaps:i.mipmaps},l+=1,6===l&&(1===i.mipmapCount&&(a.minFilter=vt),a.image=o,a.format=i.format,a.needsUpdate=!0,e&&e(a))}),i,n)}if(Array.isArray(t))for(let e=0,i=t.length;e<i;++e)c(e);else s.load(t,(function(t){const i=r.parse(t,!0);if(i.isCubemap){const t=i.mipmaps.length/i.mipmapCount;for(let e=0;e<t;e++){o[e]={mipmaps:[]};for(let t=0;t<i.mipmapCount;t++)o[e].mipmaps.push(i.mipmaps[e*i.mipmapCount+t]),o[e].format=i.format,o[e].width=i.width,o[e].height=i.height}a.image=o}else a.image.width=i.width,a.image.height=i.height,a.mipmaps=i.mipmaps;1===i.mipmapCount&&(a.minFilter=vt),a.format=i.format,a.needsUpdate=!0,e&&e(a)}),i,n);return a}}),Mh.prototype=Object.assign(Object.create(_h.prototype),{constructor:Mh,load:function(t,e,i,n){void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,o=mh.get(t);if(void 0!==o)return r.manager.itemStart(t),setTimeout((function(){e&&e(o),r.manager.itemEnd(t)}),0),o;const a=document.createElementNS("http://www.w3.org/1999/xhtml","img");function s(){a.removeEventListener("load",s,!1),a.removeEventListener("error",l,!1),mh.add(t,this),e&&e(this),r.manager.itemEnd(t)}function l(e){a.removeEventListener("load",s,!1),a.removeEventListener("error",l,!1),n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)}return a.addEventListener("load",s,!1),a.addEventListener("error",l,!1),"data:"!==t.substr(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),r.manager.itemStart(t),a.src=t,a}}),Th.prototype=Object.assign(Object.create(_h.prototype),{constructor:Th,load:function(t,e,i,n){const r=new bo,o=new Mh(this.manager);o.setCrossOrigin(this.crossOrigin),o.setPath(this.path);let a=0;function s(i){o.load(t[i],(function(t){r.images[i]=t,a++,6===a&&(r.needsUpdate=!0,e&&e(r))}),void 0,n)}for(let e=0;e<t.length;++e)s(e);return r}}),Sh.prototype=Object.assign(Object.create(_h.prototype),{constructor:Sh,load:function(t,e,i,n){const r=this,o=new Mo,a=new xh(this.manager);return a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setPath(this.path),a.setWithCredentials(r.withCredentials),a.load(t,(function(t){const i=r.parse(t);i&&(void 0!==i.image?o.image=i.image:void 0!==i.data&&(o.image.width=i.width,o.image.height=i.height,o.image.data=i.data),o.wrapS=void 0!==i.wrapS?i.wrapS:dt,o.wrapT=void 0!==i.wrapT?i.wrapT:dt,o.magFilter=void 0!==i.magFilter?i.magFilter:vt,o.minFilter=void 0!==i.minFilter?i.minFilter:vt,o.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,void 0!==i.encoding&&(o.encoding=i.encoding),void 0!==i.flipY&&(o.flipY=i.flipY),void 0!==i.format&&(o.format=i.format),void 0!==i.type&&(o.type=i.type),void 0!==i.mipmaps&&(o.mipmaps=i.mipmaps,o.minFilter=wt),1===i.mipmapCount&&(o.minFilter=vt),o.needsUpdate=!0,e&&e(o,i))}),i,n),o}}),Eh.prototype=Object.assign(Object.create(_h.prototype),{constructor:Eh,load:function(t,e,i,n){const r=new Hi,o=new Mh(this.manager);return o.setCrossOrigin(this.crossOrigin),o.setPath(this.path),o.load(t,(function(i){r.image=i;const n=t.search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/);r.format=n?Bt:Ft,r.needsUpdate=!0,void 0!==e&&e(r)}),i,n),r}}),Object.assign(Ch.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(t,e){const i=this.getUtoTmapping(t);return this.getPoint(i,e)},getPoints:function(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return e},getSpacedPoints:function(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPointAt(i/t));return e},getLength:function(){const t=this.getLengths();return t[t.length-1]},getLengths:function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const e=[];let i,n=this.getPoint(0),r=0;e.push(0);for(let o=1;o<=t;o++)i=this.getPoint(o/t),r+=i.distanceTo(n),e.push(r),n=i;return this.cacheArcLengths=e,e},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(t,e){const i=this.getLengths();let n=0;const r=i.length;let o;o=e||t*i[r-1];let a,s=0,l=r-1;for(;s<=l;)if(n=Math.floor(s+(l-s)/2),a=i[n]-o,a<0)s=n+1;else{if(!(a>0)){l=n;break}l=n-1}if(n=l,i[n]===o)return n/(r-1);const c=i[n];return(n+(o-c)/(i[n+1]-c))/(r-1)},getTangent:function(t,e){let i=t-1e-4,n=t+1e-4;i<0&&(i=0),n>1&&(n=1);const r=this.getPoint(i),o=this.getPoint(n),a=e||(r.isVector2?new Ni:new $i);return a.copy(o).sub(r).normalize(),a},getTangentAt:function(t,e){const i=this.getUtoTmapping(t);return this.getTangent(i,e)},computeFrenetFrames:function(t,e){const i=new $i,n=[],r=[],o=[],a=new $i,s=new Sn;for(let e=0;e<=t;e++){const i=e/t;n[e]=this.getTangentAt(i,new $i),n[e].normalize()}r[0]=new $i,o[0]=new $i;let l=Number.MAX_VALUE;const c=Math.abs(n[0].x),h=Math.abs(n[0].y),u=Math.abs(n[0].z);c<=l&&(l=c,i.set(1,0,0)),h<=l&&(l=h,i.set(0,1,0)),u<=l&&i.set(0,0,1),a.crossVectors(n[0],i).normalize(),r[0].crossVectors(n[0],a),o[0].crossVectors(n[0],r[0]);for(let e=1;e<=t;e++){if(r[e]=r[e-1].clone(),o[e]=o[e-1].clone(),a.crossVectors(n[e-1],n[e]),a.length()>Number.EPSILON){a.normalize();const t=Math.acos(Fi.clamp(n[e-1].dot(n[e]),-1,1));r[e].applyMatrix4(s.makeRotationAxis(a,t))}o[e].crossVectors(n[e],r[e])}if(!0===e){let e=Math.acos(Fi.clamp(r[0].dot(r[t]),-1,1));e/=t,n[0].dot(a.crossVectors(r[0],r[t]))>0&&(e=-e);for(let i=1;i<=t;i++)r[i].applyMatrix4(s.makeRotationAxis(n[i],e*i)),o[i].crossVectors(n[i],r[i])}return{tangents:n,normals:r,binormals:o}},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this},toJSON:function(){const t={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t},fromJSON:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}),Ah.prototype=Object.create(Ch.prototype),Ah.prototype.constructor=Ah,Ah.prototype.isEllipseCurve=!0,Ah.prototype.getPoint=function(t,e){const i=e||new Ni,n=2*Math.PI;let r=this.aEndAngle-this.aStartAngle;const o=Math.abs(r)<Number.EPSILON;for(;r<0;)r+=n;for(;r>n;)r-=n;r<Number.EPSILON&&(r=o?0:n),!0!==this.aClockwise||o||(r===n?r=-n:r-=n);const a=this.aStartAngle+t*r;let s=this.aX+this.xRadius*Math.cos(a),l=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){const t=Math.cos(this.aRotation),e=Math.sin(this.aRotation),i=s-this.aX,n=l-this.aY;s=i*t-n*e+this.aX,l=i*e+n*t+this.aY}return i.set(s,l)},Ah.prototype.copy=function(t){return Ch.prototype.copy.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this},Ah.prototype.toJSON=function(){const t=Ch.prototype.toJSON.call(this);return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t},Ah.prototype.fromJSON=function(t){return Ch.prototype.fromJSON.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this},Ph.prototype=Object.create(Ah.prototype),Ph.prototype.constructor=Ph,Ph.prototype.isArcCurve=!0;const Ih=new $i,Rh=new Lh,Dh=new Lh,kh=new Lh;function Oh(t=[],e=!1,i="centripetal",n=.5){Ch.call(this),this.type="CatmullRomCurve3",this.points=t,this.closed=e,this.curveType=i,this.tension=n}function zh(t,e,i,n,r){const o=.5*(n-e),a=.5*(r-i),s=t*t;return(2*i-2*n+o+a)*(t*s)+(-3*i+3*n-2*o-a)*s+o*t+i}function Bh(t,e,i,n){return function(t,e){const i=1-t;return i*i*e}(t,e)+function(t,e){return 2*(1-t)*t*e}(t,i)+function(t,e){return t*t*e}(t,n)}function Fh(t,e,i,n,r){return function(t,e){const i=1-t;return i*i*i*e}(t,e)+function(t,e){const i=1-t;return 3*i*i*t*e}(t,i)+function(t,e){return 3*(1-t)*t*t*e}(t,n)+function(t,e){return t*t*t*e}(t,r)}function Nh(t=new Ni,e=new Ni,i=new Ni,n=new Ni){Ch.call(this),this.type="CubicBezierCurve",this.v0=t,this.v1=e,this.v2=i,this.v3=n}function jh(t=new $i,e=new $i,i=new $i,n=new $i){Ch.call(this),this.type="CubicBezierCurve3",this.v0=t,this.v1=e,this.v2=i,this.v3=n}function Gh(t=new Ni,e=new Ni){Ch.call(this),this.type="LineCurve",this.v1=t,this.v2=e}function Uh(t=new $i,e=new $i){Ch.call(this),this.type="LineCurve3",this.v1=t,this.v2=e}function Vh(t=new Ni,e=new Ni,i=new Ni){Ch.call(this),this.type="QuadraticBezierCurve",this.v0=t,this.v1=e,this.v2=i}function Hh(t=new $i,e=new $i,i=new $i){Ch.call(this),this.type="QuadraticBezierCurve3",this.v0=t,this.v1=e,this.v2=i}function Zh(t=[]){Ch.call(this),this.type="SplineCurve",this.points=t}Oh.prototype=Object.create(Ch.prototype),Oh.prototype.constructor=Oh,Oh.prototype.isCatmullRomCurve3=!0,Oh.prototype.getPoint=function(t,e=new $i){const i=e,n=this.points,r=n.length,o=(r-(this.closed?0:1))*t;let a,s,l=Math.floor(o),c=o-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/r)+1)*r:0===c&&l===r-1&&(l=r-2,c=1),this.closed||l>0?a=n[(l-1)%r]:(Ih.subVectors(n[0],n[1]).add(n[0]),a=Ih);const h=n[l%r],u=n[(l+1)%r];if(this.closed||l+2<r?s=n[(l+2)%r]:(Ih.subVectors(n[r-1],n[r-2]).add(n[r-1]),s=Ih),"centripetal"===this.curveType||"chordal"===this.curveType){const t="chordal"===this.curveType?.5:.25;let e=Math.pow(a.distanceToSquared(h),t),i=Math.pow(h.distanceToSquared(u),t),n=Math.pow(u.distanceToSquared(s),t);i<1e-4&&(i=1),e<1e-4&&(e=i),n<1e-4&&(n=i),Rh.initNonuniformCatmullRom(a.x,h.x,u.x,s.x,e,i,n),Dh.initNonuniformCatmullRom(a.y,h.y,u.y,s.y,e,i,n),kh.initNonuniformCatmullRom(a.z,h.z,u.z,s.z,e,i,n)}else"catmullrom"===this.curveType&&(Rh.initCatmullRom(a.x,h.x,u.x,s.x,this.tension),Dh.initCatmullRom(a.y,h.y,u.y,s.y,this.tension),kh.initCatmullRom(a.z,h.z,u.z,s.z,this.tension));return i.set(Rh.calc(c),Dh.calc(c),kh.calc(c)),i},Oh.prototype.copy=function(t){Ch.prototype.copy.call(this,t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push(i.clone())}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this},Oh.prototype.toJSON=function(){const t=Ch.prototype.toJSON.call(this);t.points=[];for(let e=0,i=this.points.length;e<i;e++){const i=this.points[e];t.points.push(i.toArray())}return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t},Oh.prototype.fromJSON=function(t){Ch.prototype.fromJSON.call(this,t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new $i).fromArray(i))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this},Nh.prototype=Object.create(Ch.prototype),Nh.prototype.constructor=Nh,Nh.prototype.isCubicBezierCurve=!0,Nh.prototype.getPoint=function(t,e=new Ni){const i=e,n=this.v0,r=this.v1,o=this.v2,a=this.v3;return i.set(Fh(t,n.x,r.x,o.x,a.x),Fh(t,n.y,r.y,o.y,a.y)),i},Nh.prototype.copy=function(t){return Ch.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this},Nh.prototype.toJSON=function(){const t=Ch.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t},Nh.prototype.fromJSON=function(t){return Ch.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this},jh.prototype=Object.create(Ch.prototype),jh.prototype.constructor=jh,jh.prototype.isCubicBezierCurve3=!0,jh.prototype.getPoint=function(t,e=new $i){const i=e,n=this.v0,r=this.v1,o=this.v2,a=this.v3;return i.set(Fh(t,n.x,r.x,o.x,a.x),Fh(t,n.y,r.y,o.y,a.y),Fh(t,n.z,r.z,o.z,a.z)),i},jh.prototype.copy=function(t){return Ch.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this},jh.prototype.toJSON=function(){const t=Ch.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t},jh.prototype.fromJSON=function(t){return Ch.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this},Gh.prototype=Object.create(Ch.prototype),Gh.prototype.constructor=Gh,Gh.prototype.isLineCurve=!0,Gh.prototype.getPoint=function(t,e=new Ni){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i},Gh.prototype.getPointAt=function(t,e){return this.getPoint(t,e)},Gh.prototype.getTangent=function(t,e){const i=e||new Ni;return i.copy(this.v2).sub(this.v1).normalize(),i},Gh.prototype.copy=function(t){return Ch.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this},Gh.prototype.toJSON=function(){const t=Ch.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},Gh.prototype.fromJSON=function(t){return Ch.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},Uh.prototype=Object.create(Ch.prototype),Uh.prototype.constructor=Uh,Uh.prototype.isLineCurve3=!0,Uh.prototype.getPoint=function(t,e=new $i){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i},Uh.prototype.getPointAt=function(t,e){return this.getPoint(t,e)},Uh.prototype.copy=function(t){return Ch.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this},Uh.prototype.toJSON=function(){const t=Ch.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},Uh.prototype.fromJSON=function(t){return Ch.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},Vh.prototype=Object.create(Ch.prototype),Vh.prototype.constructor=Vh,Vh.prototype.isQuadraticBezierCurve=!0,Vh.prototype.getPoint=function(t,e=new Ni){const i=e,n=this.v0,r=this.v1,o=this.v2;return i.set(Bh(t,n.x,r.x,o.x),Bh(t,n.y,r.y,o.y)),i},Vh.prototype.copy=function(t){return Ch.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this},Vh.prototype.toJSON=function(){const t=Ch.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},Vh.prototype.fromJSON=function(t){return Ch.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},Hh.prototype=Object.create(Ch.prototype),Hh.prototype.constructor=Hh,Hh.prototype.isQuadraticBezierCurve3=!0,Hh.prototype.getPoint=function(t,e=new $i){const i=e,n=this.v0,r=this.v1,o=this.v2;return i.set(Bh(t,n.x,r.x,o.x),Bh(t,n.y,r.y,o.y),Bh(t,n.z,r.z,o.z)),i},Hh.prototype.copy=function(t){return Ch.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this},Hh.prototype.toJSON=function(){const t=Ch.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},Hh.prototype.fromJSON=function(t){return Ch.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},Zh.prototype=Object.create(Ch.prototype),Zh.prototype.constructor=Zh,Zh.prototype.isSplineCurve=!0,Zh.prototype.getPoint=function(t,e=new Ni){const i=e,n=this.points,r=(n.length-1)*t,o=Math.floor(r),a=r-o,s=n[0===o?o:o-1],l=n[o],c=n[o>n.length-2?n.length-1:o+1],h=n[o>n.length-3?n.length-1:o+2];return i.set(zh(a,s.x,l.x,c.x,h.x),zh(a,s.y,l.y,c.y,h.y)),i},Zh.prototype.copy=function(t){Ch.prototype.copy.call(this,t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push(i.clone())}return this},Zh.prototype.toJSON=function(){const t=Ch.prototype.toJSON.call(this);t.points=[];for(let e=0,i=this.points.length;e<i;e++){const i=this.points[e];t.points.push(i.toArray())}return t},Zh.prototype.fromJSON=function(t){Ch.prototype.fromJSON.call(this,t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new Ni).fromArray(i))}return this};var Wh=Object.freeze({__proto__:null,ArcCurve:Ph,CatmullRomCurve3:Oh,CubicBezierCurve:Nh,CubicBezierCurve3:jh,EllipseCurve:Ah,LineCurve:Gh,LineCurve3:Uh,QuadraticBezierCurve:Vh,QuadraticBezierCurve3:Hh,SplineCurve:Zh});function qh(){Ch.call(this),this.type="CurvePath",this.curves=[],this.autoClose=!1}function Xh(t){qh.call(this),this.type="Path",this.currentPoint=new Ni,t&&this.setFromPoints(t)}function Yh(t){Xh.call(this,t),this.uuid=Fi.generateUUID(),this.type="Shape",this.holes=[]}function $h(t,e=1){$n.call(this),this.type="Light",this.color=new _r(t),this.intensity=e}function Jh(t,e,i){$h.call(this,t,i),this.type="HemisphereLight",this.position.copy($n.DefaultUp),this.updateMatrix(),this.groundColor=new _r(e)}function Kh(t){this.camera=t,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new Ni(512,512),this.map=null,this.mapPass=null,this.matrix=new Sn,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Eo,this._frameExtents=new Ni(1,1),this._viewportCount=1,this._viewports=[new Wi(0,0,1,1)]}function Qh(){Kh.call(this,new vo(50,1,.5,500)),this.focus=1}function tu(t,e,i,n,r,o){$h.call(this,t,e),this.type="SpotLight",this.position.copy($n.DefaultUp),this.updateMatrix(),this.target=new $n,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(t){this.intensity=t/Math.PI}}),this.distance=void 0!==i?i:0,this.angle=void 0!==n?n:Math.PI/3,this.penumbra=void 0!==r?r:0,this.decay=void 0!==o?o:1,this.shadow=new Qh}function eu(){Kh.call(this,new vo(90,1,.5,500)),this._frameExtents=new Ni(4,2),this._viewportCount=6,this._viewports=[new Wi(2,1,1,1),new Wi(0,1,1,1),new Wi(3,1,1,1),new Wi(1,1,1,1),new Wi(3,0,1,1),new Wi(1,0,1,1)],this._cubeDirections=[new $i(1,0,0),new $i(-1,0,0),new $i(0,0,1),new $i(0,0,-1),new $i(0,1,0),new $i(0,-1,0)],this._cubeUps=[new $i(0,1,0),new $i(0,1,0),new $i(0,1,0),new $i(0,1,0),new $i(0,0,1),new $i(0,0,-1)]}function iu(t,e,i,n){$h.call(this,t,e),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(t){this.intensity=t/(4*Math.PI)}}),this.distance=void 0!==i?i:0,this.decay=void 0!==n?n:1,this.shadow=new eu}function nu(t=-1,e=1,i=1,n=-1,r=.1,o=2e3){_o.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=n,this.near=r,this.far=o,this.updateProjectionMatrix()}function ru(){Kh.call(this,new nu(-5,5,5,-5,.5,500))}function ou(t,e){$h.call(this,t,e),this.type="DirectionalLight",this.position.copy($n.DefaultUp),this.updateMatrix(),this.target=new $n,this.shadow=new ru}function au(t,e){$h.call(this,t,e),this.type="AmbientLight"}function su(t,e,i,n){$h.call(this,t,e),this.type="RectAreaLight",this.width=void 0!==i?i:10,this.height=void 0!==n?n:10}qh.prototype=Object.assign(Object.create(Ch.prototype),{constructor:qh,add:function(t){this.curves.push(t)},closePath:function(){const t=this.curves[0].getPoint(0),e=this.curves[this.curves.length-1].getPoint(1);t.equals(e)||this.curves.push(new Gh(e,t))},getPoint:function(t){const e=t*this.getLength(),i=this.getCurveLengths();let n=0;for(;n<i.length;){if(i[n]>=e){const t=i[n]-e,r=this.curves[n],o=r.getLength(),a=0===o?0:1-t/o;return r.getPointAt(a)}n++}return null},getLength:function(){const t=this.getCurveLengths();return t[t.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const t=[];let e=0;for(let i=0,n=this.curves.length;i<n;i++)e+=this.curves[i].getLength(),t.push(e);return this.cacheLengths=t,t},getSpacedPoints:function(t=40){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return this.autoClose&&e.push(e[0]),e},getPoints:function(t=12){const e=[];let i;for(let n=0,r=this.curves;n<r.length;n++){const o=r[n],a=o&&o.isEllipseCurve?2*t:o&&(o.isLineCurve||o.isLineCurve3)?1:o&&o.isSplineCurve?t*o.points.length:t,s=o.getPoints(a);for(let t=0;t<s.length;t++){const n=s[t];i&&i.equals(n)||(e.push(n),i=n)}}return this.autoClose&&e.length>1&&!e[e.length-1].equals(e[0])&&e.push(e[0]),e},copy:function(t){Ch.prototype.copy.call(this,t),this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){const i=t.curves[e];this.curves.push(i.clone())}return this.autoClose=t.autoClose,this},toJSON:function(){const t=Ch.prototype.toJSON.call(this);t.autoClose=this.autoClose,t.curves=[];for(let e=0,i=this.curves.length;e<i;e++){const i=this.curves[e];t.curves.push(i.toJSON())}return t},fromJSON:function(t){Ch.prototype.fromJSON.call(this,t),this.autoClose=t.autoClose,this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){const i=t.curves[e];this.curves.push((new Wh[i.type]).fromJSON(i))}return this}}),Xh.prototype=Object.assign(Object.create(qh.prototype),{constructor:Xh,setFromPoints:function(t){this.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;e++)this.lineTo(t[e].x,t[e].y);return this},moveTo:function(t,e){return this.currentPoint.set(t,e),this},lineTo:function(t,e){const i=new Gh(this.currentPoint.clone(),new Ni(t,e));return this.curves.push(i),this.currentPoint.set(t,e),this},quadraticCurveTo:function(t,e,i,n){const r=new Vh(this.currentPoint.clone(),new Ni(t,e),new Ni(i,n));return this.curves.push(r),this.currentPoint.set(i,n),this},bezierCurveTo:function(t,e,i,n,r,o){const a=new Nh(this.currentPoint.clone(),new Ni(t,e),new Ni(i,n),new Ni(r,o));return this.curves.push(a),this.currentPoint.set(r,o),this},splineThru:function(t){const e=new Zh([this.currentPoint.clone()].concat(t));return this.curves.push(e),this.currentPoint.copy(t[t.length-1]),this},arc:function(t,e,i,n,r,o){const a=this.currentPoint.x,s=this.currentPoint.y;return this.absarc(t+a,e+s,i,n,r,o),this},absarc:function(t,e,i,n,r,o){return this.absellipse(t,e,i,i,n,r,o),this},ellipse:function(t,e,i,n,r,o,a,s){const l=this.currentPoint.x,c=this.currentPoint.y;return this.absellipse(t+l,e+c,i,n,r,o,a,s),this},absellipse:function(t,e,i,n,r,o,a,s){const l=new Ah(t,e,i,n,r,o,a,s);if(this.curves.length>0){const t=l.getPoint(0);t.equals(this.currentPoint)||this.lineTo(t.x,t.y)}this.curves.push(l);const c=l.getPoint(1);return this.currentPoint.copy(c),this},copy:function(t){return qh.prototype.copy.call(this,t),this.currentPoint.copy(t.currentPoint),this},toJSON:function(){const t=qh.prototype.toJSON.call(this);return t.currentPoint=this.currentPoint.toArray(),t},fromJSON:function(t){return qh.prototype.fromJSON.call(this,t),this.currentPoint.fromArray(t.currentPoint),this}}),Yh.prototype=Object.assign(Object.create(Xh.prototype),{constructor:Yh,getPointsHoles:function(t){const e=[];for(let i=0,n=this.holes.length;i<n;i++)e[i]=this.holes[i].getPoints(t);return e},extractPoints:function(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}},copy:function(t){Xh.prototype.copy.call(this,t),this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){const i=t.holes[e];this.holes.push(i.clone())}return this},toJSON:function(){const t=Xh.prototype.toJSON.call(this);t.uuid=this.uuid,t.holes=[];for(let e=0,i=this.holes.length;e<i;e++){const i=this.holes[e];t.holes.push(i.toJSON())}return t},fromJSON:function(t){Xh.prototype.fromJSON.call(this,t),this.uuid=t.uuid,this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){const i=t.holes[e];this.holes.push((new Xh).fromJSON(i))}return this}}),$h.prototype=Object.assign(Object.create($n.prototype),{constructor:$h,isLight:!0,copy:function(t){return $n.prototype.copy.call(this,t),this.color.copy(t.color),this.intensity=t.intensity,this},toJSON:function(t){const e=$n.prototype.toJSON.call(this,t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}),Jh.prototype=Object.assign(Object.create($h.prototype),{constructor:Jh,isHemisphereLight:!0,copy:function(t){return $h.prototype.copy.call(this,t),this.groundColor.copy(t.groundColor),this}}),Object.assign(Kh.prototype,{_projScreenMatrix:new Sn,_lightPositionWorld:new $i,_lookTarget:new $i,getViewportCount:function(){return this._viewportCount},getFrustum:function(){return this._frustum},updateMatrices:function(t){const e=this.camera,i=this.matrix,n=this._projScreenMatrix,r=this._lookTarget,o=this._lightPositionWorld;o.setFromMatrixPosition(t.matrixWorld),e.position.copy(o),r.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(r),e.updateMatrixWorld(),n.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(n),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(e.projectionMatrix),i.multiply(e.matrixWorldInverse)},getViewport:function(t){return this._viewports[t]},getFrameExtents:function(){return this._frameExtents},copy:function(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const t={};return 0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}),Qh.prototype=Object.assign(Object.create(Kh.prototype),{constructor:Qh,isSpotLightShadow:!0,updateMatrices:function(t){const e=this.camera,i=2*Fi.RAD2DEG*t.angle*this.focus,n=this.mapSize.width/this.mapSize.height,r=t.distance||e.far;i===e.fov&&n===e.aspect&&r===e.far||(e.fov=i,e.aspect=n,e.far=r,e.updateProjectionMatrix()),Kh.prototype.updateMatrices.call(this,t)}}),tu.prototype=Object.assign(Object.create($h.prototype),{constructor:tu,isSpotLight:!0,copy:function(t){return $h.prototype.copy.call(this,t),this.distance=t.distance,this.angle=t.angle,this.penumbra=t.penumbra,this.decay=t.decay,this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}),eu.prototype=Object.assign(Object.create(Kh.prototype),{constructor:eu,isPointLightShadow:!0,updateMatrices:function(t,e=0){const i=this.camera,n=this.matrix,r=this._lightPositionWorld,o=this._lookTarget,a=this._projScreenMatrix;r.setFromMatrixPosition(t.matrixWorld),i.position.copy(r),o.copy(i.position),o.add(this._cubeDirections[e]),i.up.copy(this._cubeUps[e]),i.lookAt(o),i.updateMatrixWorld(),n.makeTranslation(-r.x,-r.y,-r.z),a.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(a)}}),iu.prototype=Object.assign(Object.create($h.prototype),{constructor:iu,isPointLight:!0,copy:function(t){return $h.prototype.copy.call(this,t),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}),nu.prototype=Object.assign(Object.create(_o.prototype),{constructor:nu,isOrthographicCamera:!0,copy:function(t,e){return _o.prototype.copy.call(this,t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this},setViewOffset:function(t,e,i,n,r,o){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=o,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let r=i-t,o=i+t,a=n+e,s=n-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=t*this.view.offsetX,o=r+t*this.view.width,a-=e*this.view.offsetY,s=a-e*this.view.height}this.projectionMatrix.makeOrthographic(r,o,a,s,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()},toJSON:function(t){const e=$n.prototype.toJSON.call(this,t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}),ru.prototype=Object.assign(Object.create(Kh.prototype),{constructor:ru,isDirectionalLightShadow:!0,updateMatrices:function(t){Kh.prototype.updateMatrices.call(this,t)}}),ou.prototype=Object.assign(Object.create($h.prototype),{constructor:ou,isDirectionalLight:!0,copy:function(t){return $h.prototype.copy.call(this,t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}),au.prototype=Object.assign(Object.create($h.prototype),{constructor:au,isAmbientLight:!0}),su.prototype=Object.assign(Object.create($h.prototype),{constructor:su,isRectAreaLight:!0,copy:function(t){return $h.prototype.copy.call(this,t),this.width=t.width,this.height=t.height,this},toJSON:function(t){const e=$h.prototype.toJSON.call(this,t);return e.object.width=this.width,e.object.height=this.height,e}});class lu{constructor(){Object.defineProperty(this,"isSphericalHarmonics3",{value:!0}),this.coefficients=[];for(let t=0;t<9;t++)this.coefficients.push(new $i)}set(t){for(let e=0;e<9;e++)this.coefficients[e].copy(t[e]);return this}zero(){for(let t=0;t<9;t++)this.coefficients[t].set(0,0,0);return this}getAt(t,e){const i=t.x,n=t.y,r=t.z,o=this.coefficients;return e.copy(o[0]).multiplyScalar(.282095),e.addScaledVector(o[1],.488603*n),e.addScaledVector(o[2],.488603*r),e.addScaledVector(o[3],.488603*i),e.addScaledVector(o[4],i*n*1.092548),e.addScaledVector(o[5],n*r*1.092548),e.addScaledVector(o[6],.315392*(3*r*r-1)),e.addScaledVector(o[7],i*r*1.092548),e.addScaledVector(o[8],.546274*(i*i-n*n)),e}getIrradianceAt(t,e){const i=t.x,n=t.y,r=t.z,o=this.coefficients;return e.copy(o[0]).multiplyScalar(.886227),e.addScaledVector(o[1],1.023328*n),e.addScaledVector(o[2],1.023328*r),e.addScaledVector(o[3],1.023328*i),e.addScaledVector(o[4],.858086*i*n),e.addScaledVector(o[5],.858086*n*r),e.addScaledVector(o[6],.743125*r*r-.247708),e.addScaledVector(o[7],.858086*i*r),e.addScaledVector(o[8],.429043*(i*i-n*n)),e}add(t){for(let e=0;e<9;e++)this.coefficients[e].add(t.coefficients[e]);return this}addScaledSH(t,e){for(let i=0;i<9;i++)this.coefficients[i].addScaledVector(t.coefficients[i],e);return this}scale(t){for(let e=0;e<9;e++)this.coefficients[e].multiplyScalar(t);return this}lerp(t,e){for(let i=0;i<9;i++)this.coefficients[i].lerp(t.coefficients[i],e);return this}equals(t){for(let e=0;e<9;e++)if(!this.coefficients[e].equals(t.coefficients[e]))return!1;return!0}copy(t){return this.set(t.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(t,e=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].fromArray(t,e+3*n);return this}toArray(t=[],e=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].toArray(t,e+3*n);return t}static getBasisAt(t,e){const i=t.x,n=t.y,r=t.z;e[0]=.282095,e[1]=.488603*n,e[2]=.488603*r,e[3]=.488603*i,e[4]=1.092548*i*n,e[5]=1.092548*n*r,e[6]=.315392*(3*r*r-1),e[7]=1.092548*i*r,e[8]=.546274*(i*i-n*n)}}function cu(t,e){$h.call(this,void 0,e),this.type="LightProbe",this.sh=void 0!==t?t:new lu}function hu(t){_h.call(this,t),this.textures={}}cu.prototype=Object.assign(Object.create($h.prototype),{constructor:cu,isLightProbe:!0,copy:function(t){return $h.prototype.copy.call(this,t),this.sh.copy(t.sh),this},fromJSON:function(t){return this.intensity=t.intensity,this.sh.fromArray(t.sh),this},toJSON:function(t){const e=$h.prototype.toJSON.call(this,t);return e.object.sh=this.sh.toArray(),e}}),hu.prototype=Object.assign(Object.create(_h.prototype),{constructor:hu,load:function(t,e,i,n){const r=this,o=new xh(r.manager);o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(t,(function(i){try{e(r.parse(JSON.parse(i)))}catch(e){n?n(e):console.error(e),r.manager.itemError(t)}}),i,n)},parse:function(t){const e=this.textures;function i(t){return void 0===e[t]&&console.warn("THREE.MaterialLoader: Undefined texture",t),e[t]}const n=new Qc[t.type];if(void 0!==t.uuid&&(n.uuid=t.uuid),void 0!==t.name&&(n.name=t.name),void 0!==t.color&&void 0!==n.color&&n.color.setHex(t.color),void 0!==t.roughness&&(n.roughness=t.roughness),void 0!==t.metalness&&(n.metalness=t.metalness),void 0!==t.sheen&&(n.sheen=(new _r).setHex(t.sheen)),void 0!==t.emissive&&void 0!==n.emissive&&n.emissive.setHex(t.emissive),void 0!==t.specular&&void 0!==n.specular&&n.specular.setHex(t.specular),void 0!==t.shininess&&(n.shininess=t.shininess),void 0!==t.clearcoat&&(n.clearcoat=t.clearcoat),void 0!==t.clearcoatRoughness&&(n.clearcoatRoughness=t.clearcoatRoughness),void 0!==t.fog&&(n.fog=t.fog),void 0!==t.flatShading&&(n.flatShading=t.flatShading),void 0!==t.blending&&(n.blending=t.blending),void 0!==t.combine&&(n.combine=t.combine),void 0!==t.side&&(n.side=t.side),void 0!==t.opacity&&(n.opacity=t.opacity),void 0!==t.transparent&&(n.transparent=t.transparent),void 0!==t.alphaTest&&(n.alphaTest=t.alphaTest),void 0!==t.depthTest&&(n.depthTest=t.depthTest),void 0!==t.depthWrite&&(n.depthWrite=t.depthWrite),void 0!==t.colorWrite&&(n.colorWrite=t.colorWrite),void 0!==t.stencilWrite&&(n.stencilWrite=t.stencilWrite),void 0!==t.stencilWriteMask&&(n.stencilWriteMask=t.stencilWriteMask),void 0!==t.stencilFunc&&(n.stencilFunc=t.stencilFunc),void 0!==t.stencilRef&&(n.stencilRef=t.stencilRef),void 0!==t.stencilFuncMask&&(n.stencilFuncMask=t.stencilFuncMask),void 0!==t.stencilFail&&(n.stencilFail=t.stencilFail),void 0!==t.stencilZFail&&(n.stencilZFail=t.stencilZFail),void 0!==t.stencilZPass&&(n.stencilZPass=t.stencilZPass),void 0!==t.wireframe&&(n.wireframe=t.wireframe),void 0!==t.wireframeLinewidth&&(n.wireframeLinewidth=t.wireframeLinewidth),void 0!==t.wireframeLinecap&&(n.wireframeLinecap=t.wireframeLinecap),void 0!==t.wireframeLinejoin&&(n.wireframeLinejoin=t.wireframeLinejoin),void 0!==t.rotation&&(n.rotation=t.rotation),1!==t.linewidth&&(n.linewidth=t.linewidth),void 0!==t.dashSize&&(n.dashSize=t.dashSize),void 0!==t.gapSize&&(n.gapSize=t.gapSize),void 0!==t.scale&&(n.scale=t.scale),void 0!==t.polygonOffset&&(n.polygonOffset=t.polygonOffset),void 0!==t.polygonOffsetFactor&&(n.polygonOffsetFactor=t.polygonOffsetFactor),void 0!==t.polygonOffsetUnits&&(n.polygonOffsetUnits=t.polygonOffsetUnits),void 0!==t.skinning&&(n.skinning=t.skinning),void 0!==t.morphTargets&&(n.morphTargets=t.morphTargets),void 0!==t.morphNormals&&(n.morphNormals=t.morphNormals),void 0!==t.dithering&&(n.dithering=t.dithering),void 0!==t.vertexTangents&&(n.vertexTangents=t.vertexTangents),void 0!==t.visible&&(n.visible=t.visible),void 0!==t.toneMapped&&(n.toneMapped=t.toneMapped),void 0!==t.userData&&(n.userData=t.userData),void 0!==t.vertexColors&&("number"==typeof t.vertexColors?n.vertexColors=t.vertexColors>0:n.vertexColors=t.vertexColors),void 0!==t.uniforms)for(const e in t.uniforms){const r=t.uniforms[e];switch(n.uniforms[e]={},r.type){case"t":n.uniforms[e].value=i(r.value);break;case"c":n.uniforms[e].value=(new _r).setHex(r.value);break;case"v2":n.uniforms[e].value=(new Ni).fromArray(r.value);break;case"v3":n.uniforms[e].value=(new $i).fromArray(r.value);break;case"v4":n.uniforms[e].value=(new Wi).fromArray(r.value);break;case"m3":n.uniforms[e].value=(new ji).fromArray(r.value);break;case"m4":n.uniforms[e].value=(new Sn).fromArray(r.value);break;default:n.uniforms[e].value=r.value}}if(void 0!==t.defines&&(n.defines=t.defines),void 0!==t.vertexShader&&(n.vertexShader=t.vertexShader),void 0!==t.fragmentShader&&(n.fragmentShader=t.fragmentShader),void 0!==t.extensions)for(const e in t.extensions)n.extensions[e]=t.extensions[e];if(void 0!==t.shading&&(n.flatShading=1===t.shading),void 0!==t.size&&(n.size=t.size),void 0!==t.sizeAttenuation&&(n.sizeAttenuation=t.sizeAttenuation),void 0!==t.map&&(n.map=i(t.map)),void 0!==t.matcap&&(n.matcap=i(t.matcap)),void 0!==t.alphaMap&&(n.alphaMap=i(t.alphaMap)),void 0!==t.bumpMap&&(n.bumpMap=i(t.bumpMap)),void 0!==t.bumpScale&&(n.bumpScale=t.bumpScale),void 0!==t.normalMap&&(n.normalMap=i(t.normalMap)),void 0!==t.normalMapType&&(n.normalMapType=t.normalMapType),void 0!==t.normalScale){let e=t.normalScale;!1===Array.isArray(e)&&(e=[e,e]),n.normalScale=(new Ni).fromArray(e)}return void 0!==t.displacementMap&&(n.displacementMap=i(t.displacementMap)),void 0!==t.displacementScale&&(n.displacementScale=t.displacementScale),void 0!==t.displacementBias&&(n.displacementBias=t.displacementBias),void 0!==t.roughnessMap&&(n.roughnessMap=i(t.roughnessMap)),void 0!==t.metalnessMap&&(n.metalnessMap=i(t.metalnessMap)),void 0!==t.emissiveMap&&(n.emissiveMap=i(t.emissiveMap)),void 0!==t.emissiveIntensity&&(n.emissiveIntensity=t.emissiveIntensity),void 0!==t.specularMap&&(n.specularMap=i(t.specularMap)),void 0!==t.envMap&&(n.envMap=i(t.envMap)),void 0!==t.envMapIntensity&&(n.envMapIntensity=t.envMapIntensity),void 0!==t.reflectivity&&(n.reflectivity=t.reflectivity),void 0!==t.refractionRatio&&(n.refractionRatio=t.refractionRatio),void 0!==t.lightMap&&(n.lightMap=i(t.lightMap)),void 0!==t.lightMapIntensity&&(n.lightMapIntensity=t.lightMapIntensity),void 0!==t.aoMap&&(n.aoMap=i(t.aoMap)),void 0!==t.aoMapIntensity&&(n.aoMapIntensity=t.aoMapIntensity),void 0!==t.gradientMap&&(n.gradientMap=i(t.gradientMap)),void 0!==t.clearcoatMap&&(n.clearcoatMap=i(t.clearcoatMap)),void 0!==t.clearcoatRoughnessMap&&(n.clearcoatRoughnessMap=i(t.clearcoatRoughnessMap)),void 0!==t.clearcoatNormalMap&&(n.clearcoatNormalMap=i(t.clearcoatNormalMap)),void 0!==t.clearcoatNormalScale&&(n.clearcoatNormalScale=(new Ni).fromArray(t.clearcoatNormalScale)),void 0!==t.transmission&&(n.transmission=t.transmission),void 0!==t.transmissionMap&&(n.transmissionMap=i(t.transmissionMap)),n},setTextures:function(t){return this.textures=t,this}});const uu={decodeText:function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);let e="";for(let i=0,n=t.length;i<n;i++)e+=String.fromCharCode(t[i]);try{return decodeURIComponent(escape(e))}catch(t){return e}},extractUrlBase:function(t){const e=t.lastIndexOf("/");return-1===e?"./":t.substr(0,e+1)}};function du(){Wr.call(this),this.type="InstancedBufferGeometry",this.instanceCount=1/0}function pu(t,e,i,n){"number"==typeof i&&(n=i,i=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),Sr.call(this,t,e,i),this.meshPerAttribute=n||1}function fu(t){_h.call(this,t)}du.prototype=Object.assign(Object.create(Wr.prototype),{constructor:du,isInstancedBufferGeometry:!0,copy:function(t){return Wr.prototype.copy.call(this,t),this.instanceCount=t.instanceCount,this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const t=Wr.prototype.toJSON.call(this);return t.instanceCount=this.instanceCount,t.isInstancedBufferGeometry=!0,t}}),pu.prototype=Object.assign(Object.create(Sr.prototype),{constructor:pu,isInstancedBufferAttribute:!0,copy:function(t){return Sr.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this},toJSON:function(){const t=Sr.prototype.toJSON.call(this);return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}),fu.prototype=Object.assign(Object.create(_h.prototype),{constructor:fu,load:function(t,e,i,n){const r=this,o=new xh(r.manager);o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(t,(function(i){try{e(r.parse(JSON.parse(i)))}catch(e){n?n(e):console.error(e),r.manager.itemError(t)}}),i,n)},parse:function(t){const e={},i={};function n(t,n){if(void 0!==e[n])return e[n];const r=t.interleavedBuffers[n],o=function(t,e){if(void 0!==i[e])return i[e];const n=t.arrayBuffers[e],r=new Uint32Array(n).buffer;return i[e]=r,r}(t,r.buffer),a=new Fs(Fr(r.type,o),r.stride);return a.uuid=r.uuid,e[n]=a,a}const r=t.isInstancedBufferGeometry?new du:new Wr,o=t.data.index;if(void 0!==o){const t=Fr(o.type,o.array);r.setIndex(new Sr(t,1))}const a=t.data.attributes;for(const e in a){const i=a[e];let o;if(i.isInterleavedBufferAttribute){o=new js(n(t.data,i.data),i.itemSize,i.offset,i.normalized)}else{const t=Fr(i.type,i.array);o=new(i.isInstancedBufferAttribute?pu:Sr)(t,i.itemSize,i.normalized)}void 0!==i.name&&(o.name=i.name),r.setAttribute(e,o)}const s=t.data.morphAttributes;if(s)for(const e in s){const i=s[e],o=[];for(let e=0,r=i.length;e<r;e++){const r=i[e];let a;if(r.isInterleavedBufferAttribute){a=new js(n(t.data,r.data),r.itemSize,r.offset,r.normalized)}else{a=new Sr(Fr(r.type,r.array),r.itemSize,r.normalized)}void 0!==r.name&&(a.name=r.name),o.push(a)}r.morphAttributes[e]=o}t.data.morphTargetsRelative&&(r.morphTargetsRelative=!0);const l=t.data.groups||t.data.drawcalls||t.data.offsets;if(void 0!==l)for(let t=0,e=l.length;t!==e;++t){const e=l[t];r.addGroup(e.start,e.count,e.materialIndex)}const c=t.data.boundingSphere;if(void 0!==c){const t=new $i;void 0!==c.center&&t.fromArray(c.center),r.boundingSphere=new gn(t,c.radius)}return t.name&&(r.name=t.name),t.userData&&(r.userData=t.userData),r}});class mu extends _h{constructor(t){super(t)}load(t,e,i,n){const r=this,o=""===this.path?uu.extractUrlBase(t):this.path;this.resourcePath=this.resourcePath||o;const a=new xh(this.manager);a.setPath(this.path),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(t,(function(i){let o=null;try{o=JSON.parse(i)}catch(e){return void 0!==n&&n(e),void console.error("THREE:ObjectLoader: Can't parse "+t+".",e.message)}const a=o.metadata;void 0!==a&&void 0!==a.type&&"geometry"!==a.type.toLowerCase()?r.parse(o,e):console.error("THREE.ObjectLoader: Can't load "+t)}),i,n)}parse(t,e){const i=this.parseAnimations(t.animations),n=this.parseShapes(t.shapes),r=this.parseGeometries(t.geometries,n),o=this.parseImages(t.images,(function(){void 0!==e&&e(l)})),a=this.parseTextures(t.textures,o),s=this.parseMaterials(t.materials,a),l=this.parseObject(t.object,r,s,i),c=this.parseSkeletons(t.skeletons,l);if(this.bindSkeletons(l,c),void 0!==e){let t=!1;for(const e in o)if(o[e]instanceof HTMLImageElement){t=!0;break}!1===t&&e(l)}return l}parseShapes(t){const e={};if(void 0!==t)for(let i=0,n=t.length;i<n;i++){const n=(new Yh).fromJSON(t[i]);e[n.uuid]=n}return e}parseSkeletons(t,e){const i={},n={};if(e.traverse((function(t){t.isBone&&(n[t.uuid]=t)})),void 0!==t)for(let e=0,r=t.length;e<r;e++){const r=(new ml).fromJSON(t[e],n);i[r.uuid]=r}return i}parseGeometries(t,e){const i={};let n;if(void 0!==t){const r=new fu;for(let o=0,a=t.length;o<a;o++){let a;const s=t[o];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new Uc[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":a=new Uc[s.type](s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":a=new Uc[s.type](s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":a=new Uc[s.type](s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":a=new Uc[s.type](s.radius,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":a=new Uc[s.type](s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":case"DodecahedronBufferGeometry":case"IcosahedronGeometry":case"IcosahedronBufferGeometry":case"OctahedronGeometry":case"OctahedronBufferGeometry":case"TetrahedronGeometry":case"TetrahedronBufferGeometry":a=new Uc[s.type](s.radius,s.detail);break;case"RingGeometry":case"RingBufferGeometry":a=new Uc[s.type](s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":a=new Uc[s.type](s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":a=new Uc[s.type](s.radius,s.tube,s.tubularSegments,s.radialSegments,s.p,s.q);break;case"TubeGeometry":case"TubeBufferGeometry":a=new Uc[s.type]((new Wh[s.path.type]).fromJSON(s.path),s.tubularSegments,s.radius,s.radialSegments,s.closed);break;case"LatheGeometry":case"LatheBufferGeometry":a=new Uc[s.type](s.points,s.segments,s.phiStart,s.phiLength);break;case"PolyhedronGeometry":case"PolyhedronBufferGeometry":a=new Uc[s.type](s.vertices,s.indices,s.radius,s.details);break;case"ShapeGeometry":case"ShapeBufferGeometry":n=[];for(let t=0,i=s.shapes.length;t<i;t++){const i=e[s.shapes[t]];n.push(i)}a=new Uc[s.type](n,s.curveSegments);break;case"ExtrudeGeometry":case"ExtrudeBufferGeometry":n=[];for(let t=0,i=s.shapes.length;t<i;t++){const i=e[s.shapes[t]];n.push(i)}const t=s.options.extrudePath;void 0!==t&&(s.options.extrudePath=(new Wh[t.type]).fromJSON(t)),a=new Uc[s.type](n,s.options);break;case"BufferGeometry":case"InstancedBufferGeometry":a=r.parse(s);break;case"Geometry":console.error('THREE.ObjectLoader: Loading "Geometry" is not supported anymore.');break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),!0===a.isBufferGeometry&&void 0!==s.userData&&(a.userData=s.userData),i[s.uuid]=a}}return i}parseMaterials(t,e){const i={},n={};if(void 0!==t){const r=new hu;r.setTextures(e);for(let e=0,o=t.length;e<o;e++){const o=t[e];if("MultiMaterial"===o.type){const t=[];for(let e=0;e<o.materials.length;e++){const n=o.materials[e];void 0===i[n.uuid]&&(i[n.uuid]=r.parse(n)),t.push(i[n.uuid])}n[o.uuid]=t}else void 0===i[o.uuid]&&(i[o.uuid]=r.parse(o)),n[o.uuid]=i[o.uuid]}}return n}parseAnimations(t){const e={};if(void 0!==t)for(let i=0;i<t.length;i++){const n=t[i],r=ph.parse(n);e[r.uuid]=r}return e}parseImages(t,e){const i=this,n={};let r;function o(t){if("string"==typeof t){const e=t;return function(t){return i.manager.itemStart(t),r.load(t,(function(){i.manager.itemEnd(t)}),void 0,(function(){i.manager.itemError(t),i.manager.itemEnd(t)}))}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(e)?e:i.resourcePath+e)}return t.data?{data:Fr(t.type,t.data),width:t.width,height:t.height}:null}if(void 0!==t&&t.length>0){const i=new gh(e);r=new Mh(i),r.setCrossOrigin(this.crossOrigin);for(let e=0,i=t.length;e<i;e++){const i=t[e],r=i.url;if(Array.isArray(r)){n[i.uuid]=[];for(let t=0,e=r.length;t<e;t++){const e=o(r[t]);null!==e&&(e instanceof HTMLImageElement?n[i.uuid].push(e):n[i.uuid].push(new Mo(e.data,e.width,e.height)))}}else{const t=o(i.url);null!==t&&(n[i.uuid]=t)}}}return n}parseTextures(t,e){function i(t,e){return"number"==typeof t?t:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",t),e[t])}const n={};if(void 0!==t)for(let r=0,o=t.length;r<o;r++){const o=t[r];let a;void 0===o.image&&console.warn('THREE.ObjectLoader: No "image" specified for',o.uuid),void 0===e[o.image]&&console.warn("THREE.ObjectLoader: Undefined image",o.image);const s=e[o.image];Array.isArray(s)?(a=new bo(s),6===s.length&&(a.needsUpdate=!0)):(a=s&&s.data?new Mo(s.data,s.width,s.height):new Hi(s),s&&(a.needsUpdate=!0)),a.uuid=o.uuid,void 0!==o.name&&(a.name=o.name),void 0!==o.mapping&&(a.mapping=i(o.mapping,gu)),void 0!==o.offset&&a.offset.fromArray(o.offset),void 0!==o.repeat&&a.repeat.fromArray(o.repeat),void 0!==o.center&&a.center.fromArray(o.center),void 0!==o.rotation&&(a.rotation=o.rotation),void 0!==o.wrap&&(a.wrapS=i(o.wrap[0],yu),a.wrapT=i(o.wrap[1],yu)),void 0!==o.format&&(a.format=o.format),void 0!==o.type&&(a.type=o.type),void 0!==o.encoding&&(a.encoding=o.encoding),void 0!==o.minFilter&&(a.minFilter=i(o.minFilter,_u)),void 0!==o.magFilter&&(a.magFilter=i(o.magFilter,_u)),void 0!==o.anisotropy&&(a.anisotropy=o.anisotropy),void 0!==o.flipY&&(a.flipY=o.flipY),void 0!==o.premultiplyAlpha&&(a.premultiplyAlpha=o.premultiplyAlpha),void 0!==o.unpackAlignment&&(a.unpackAlignment=o.unpackAlignment),n[o.uuid]=a}return n}parseObject(t,e,i,n){let r,o,a;function s(t){return void 0===e[t]&&console.warn("THREE.ObjectLoader: Undefined geometry",t),e[t]}function l(t){if(void 0!==t){if(Array.isArray(t)){const e=[];for(let n=0,r=t.length;n<r;n++){const r=t[n];void 0===i[r]&&console.warn("THREE.ObjectLoader: Undefined material",r),e.push(i[r])}return e}return void 0===i[t]&&console.warn("THREE.ObjectLoader: Undefined material",t),i[t]}}switch(t.type){case"Scene":r=new Bs,void 0!==t.background&&Number.isInteger(t.background)&&(r.background=new _r(t.background)),void 0!==t.fog&&("Fog"===t.fog.type?r.fog=new zs(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(r.fog=new Os(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":r=new vo(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(r.focus=t.focus),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.filmGauge&&(r.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(r.filmOffset=t.filmOffset),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"OrthographicCamera":r=new nu(t.left,t.right,t.top,t.bottom,t.near,t.far),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"AmbientLight":r=new au(t.color,t.intensity);break;case"DirectionalLight":r=new ou(t.color,t.intensity);break;case"PointLight":r=new iu(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":r=new su(t.color,t.intensity,t.width,t.height);break;case"SpotLight":r=new tu(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":r=new Jh(t.color,t.groundColor,t.intensity);break;case"LightProbe":r=(new cu).fromJSON(t);break;case"SkinnedMesh":o=s(t.geometry),a=l(t.material),r=new ul(o,a),void 0!==t.bindMode&&(r.bindMode=t.bindMode),void 0!==t.bindMatrix&&r.bindMatrix.fromArray(t.bindMatrix),void 0!==t.skeleton&&(r.skeleton=t.skeleton);break;case"Mesh":o=s(t.geometry),a=l(t.material),r=new ho(o,a);break;case"InstancedMesh":o=s(t.geometry),a=l(t.material);const e=t.count,i=t.instanceMatrix;r=new xl(o,a,e),r.instanceMatrix=new Sr(new Float32Array(i.array),16);break;case"LOD":r=new ol;break;case"Line":r=new Cl(s(t.geometry),l(t.material));break;case"LineLoop":r=new Il(s(t.geometry),l(t.material));break;case"LineSegments":r=new Ll(s(t.geometry),l(t.material));break;case"PointCloud":case"Points":r=new Bl(s(t.geometry),l(t.material));break;case"Sprite":r=new el(l(t.material));break;case"Group":r=new Ps;break;case"Bone":r=new dl;break;default:r=new $n}if(r.uuid=t.uuid,void 0!==t.name&&(r.name=t.name),void 0!==t.matrix?(r.matrix.fromArray(t.matrix),void 0!==t.matrixAutoUpdate&&(r.matrixAutoUpdate=t.matrixAutoUpdate),r.matrixAutoUpdate&&r.matrix.decompose(r.position,r.quaternion,r.scale)):(void 0!==t.position&&r.position.fromArray(t.position),void 0!==t.rotation&&r.rotation.fromArray(t.rotation),void 0!==t.quaternion&&r.quaternion.fromArray(t.quaternion),void 0!==t.scale&&r.scale.fromArray(t.scale)),void 0!==t.castShadow&&(r.castShadow=t.castShadow),void 0!==t.receiveShadow&&(r.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(r.shadow.bias=t.shadow.bias),void 0!==t.shadow.normalBias&&(r.shadow.normalBias=t.shadow.normalBias),void 0!==t.shadow.radius&&(r.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&r.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(r.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(r.visible=t.visible),void 0!==t.frustumCulled&&(r.frustumCulled=t.frustumCulled),void 0!==t.renderOrder&&(r.renderOrder=t.renderOrder),void 0!==t.userData&&(r.userData=t.userData),void 0!==t.layers&&(r.layers.mask=t.layers),void 0!==t.children){const o=t.children;for(let t=0;t<o.length;t++)r.add(this.parseObject(o[t],e,i,n))}if(void 0!==t.animations){const e=t.animations;for(let t=0;t<e.length;t++){const i=e[t];r.animations.push(n[i])}}if("LOD"===t.type){void 0!==t.autoUpdate&&(r.autoUpdate=t.autoUpdate);const e=t.levels;for(let t=0;t<e.length;t++){const i=e[t],n=r.getObjectByProperty("uuid",i.object);void 0!==n&&r.addLevel(n,i.distance)}}return r}bindSkeletons(t,e){0!==Object.keys(e).length&&t.traverse((function(t){if(!0===t.isSkinnedMesh&&void 0!==t.skeleton){const i=e[t.skeleton];void 0===i?console.warn("THREE.ObjectLoader: No skeleton found with UUID:",t.skeleton):t.bind(i,t.bindMatrix)}}))}setTexturePath(t){return console.warn("THREE.ObjectLoader: .setTexturePath() has been renamed to .setResourcePath()."),this.setResourcePath(t)}}const gu={UVMapping:rt,CubeReflectionMapping:ot,CubeRefractionMapping:at,EquirectangularReflectionMapping:st,EquirectangularRefractionMapping:lt,CubeUVReflectionMapping:ct,CubeUVRefractionMapping:ht},yu={RepeatWrapping:ut,ClampToEdgeWrapping:dt,MirroredRepeatWrapping:pt},_u={NearestFilter:ft,NearestMipmapNearestFilter:mt,NearestMipmapLinearFilter:yt,LinearFilter:vt,LinearMipmapNearestFilter:xt,LinearMipmapLinearFilter:wt};function vu(t){"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),_h.call(this,t),this.options={premultiplyAlpha:"none"}}function xu(){this.type="ShapePath",this.color=new _r,this.subPaths=[],this.currentPath=null}vu.prototype=Object.assign(Object.create(_h.prototype),{constructor:vu,isImageBitmapLoader:!0,setOptions:function(t){return this.options=t,this},load:function(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,o=mh.get(t);if(void 0!==o)return r.manager.itemStart(t),setTimeout((function(){e&&e(o),r.manager.itemEnd(t)}),0),o;const a={};a.credentials="anonymous"===this.crossOrigin?"same-origin":"include",fetch(t,a).then((function(t){return t.blob()})).then((function(t){return createImageBitmap(t,r.options)})).then((function(i){mh.add(t,i),e&&e(i),r.manager.itemEnd(t)})).catch((function(e){n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)})),r.manager.itemStart(t)}}),Object.assign(xu.prototype,{moveTo:function(t,e){return this.currentPath=new Xh,this.subPaths.push(this.currentPath),this.currentPath.moveTo(t,e),this},lineTo:function(t,e){return this.currentPath.lineTo(t,e),this},quadraticCurveTo:function(t,e,i,n){return this.currentPath.quadraticCurveTo(t,e,i,n),this},bezierCurveTo:function(t,e,i,n,r,o){return this.currentPath.bezierCurveTo(t,e,i,n,r,o),this},splineThru:function(t){return this.currentPath.splineThru(t),this},toShapes:function(t,e){function i(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i],r=new Yh;r.curves=n.curves,e.push(r)}return e}function n(t,e){const i=e.length;let n=!1;for(let r=i-1,o=0;o<i;r=o++){let i=e[r],a=e[o],s=a.x-i.x,l=a.y-i.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(i=e[o],s=-s,a=e[r],l=-l),t.y<i.y||t.y>a.y)continue;if(t.y===i.y){if(t.x===i.x)return!0}else{const e=l*(t.x-i.x)-s*(t.y-i.y);if(0===e)return!0;if(e<0)continue;n=!n}}else{if(t.y!==i.y)continue;if(a.x<=t.x&&t.x<=i.x||i.x<=t.x&&t.x<=a.x)return!0}}return n}const r=Tc.isClockWise,o=this.subPaths;if(0===o.length)return[];if(!0===e)return i(o);let a,s,l;const c=[];if(1===o.length)return s=o[0],l=new Yh,l.curves=s.curves,c.push(l),c;let h=!r(o[0].getPoints());h=t?!h:h;const u=[],d=[];let p,f,m=[],g=0;d[g]=void 0,m[g]=[];for(let e=0,i=o.length;e<i;e++)s=o[e],p=s.getPoints(),a=r(p),a=t?!a:a,a?(!h&&d[g]&&g++,d[g]={s:new Yh,p:p},d[g].s.curves=s.curves,h&&g++,m[g]=[]):m[g].push({h:s,p:p[0]});if(!d[0])return i(o);if(d.length>1){let t=!1;const e=[];for(let t=0,e=d.length;t<e;t++)u[t]=[];for(let i=0,r=d.length;i<r;i++){const r=m[i];for(let o=0;o<r.length;o++){const a=r[o];let s=!0;for(let r=0;r<d.length;r++)n(a.p,d[r].p)&&(i!==r&&e.push({froms:i,tos:r,hole:o}),s?(s=!1,u[r].push(a)):t=!0);s&&u[i].push(a)}}e.length>0&&(t||(m=u))}for(let t=0,e=d.length;t<e;t++){l=d[t].s,c.push(l),f=m[t];for(let t=0,e=f.length;t<e;t++)l.holes.push(f[t].h)}return c}});class bu{constructor(t){Object.defineProperty(this,"isFont",{value:!0}),this.type="Font",this.data=t}generateShapes(t,e=100){const i=[],n=function(t,e,i){const n=Array.from?Array.from(t):String(t).split(""),r=e/i.resolution,o=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*r,a=[];let s=0,l=0;for(let t=0;t<n.length;t++){const e=n[t];if("\n"===e)s=0,l-=o;else{const t=wu(e,r,s,l,i);s+=t.offsetX,a.push(t.path)}}return a}(t,e,this.data);for(let t=0,e=n.length;t<e;t++)Array.prototype.push.apply(i,n[t].toShapes());return i}}function wu(t,e,i,n,r){const o=r.glyphs[t]||r.glyphs["?"];if(!o)return void console.error('THREE.Font: character "'+t+'" does not exists in font family '+r.familyName+".");const a=new xu;let s,l,c,h,u,d,p,f;if(o.o){const t=o._cachedOutline||(o._cachedOutline=o.o.split(" "));for(let r=0,o=t.length;r<o;){switch(t[r++]){case"m":s=t[r++]*e+i,l=t[r++]*e+n,a.moveTo(s,l);break;case"l":s=t[r++]*e+i,l=t[r++]*e+n,a.lineTo(s,l);break;case"q":c=t[r++]*e+i,h=t[r++]*e+n,u=t[r++]*e+i,d=t[r++]*e+n,a.quadraticCurveTo(u,d,c,h);break;case"b":c=t[r++]*e+i,h=t[r++]*e+n,u=t[r++]*e+i,d=t[r++]*e+n,p=t[r++]*e+i,f=t[r++]*e+n,a.bezierCurveTo(u,d,p,f,c,h)}}}return{offsetX:o.ha*e,path:a}}function Mu(t){_h.call(this,t)}let Tu;Mu.prototype=Object.assign(Object.create(_h.prototype),{constructor:Mu,load:function(t,e,i,n){const r=this,o=new xh(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(r.withCredentials),o.load(t,(function(t){let i;try{i=JSON.parse(t)}catch(e){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),i=JSON.parse(t.substring(65,t.length-2))}const n=r.parse(i);e&&e(n)}),i,n)},parse:function(t){return new bu(t)}});const Su={getContext:function(){return void 0===Tu&&(Tu=new(window.AudioContext||window.webkitAudioContext)),Tu},setContext:function(t){Tu=t}};function Eu(t){_h.call(this,t)}function Cu(t,e,i){cu.call(this,void 0,i);const n=(new _r).set(t),r=(new _r).set(e),o=new $i(n.r,n.g,n.b),a=new $i(r.r,r.g,r.b),s=Math.sqrt(Math.PI),l=s*Math.sqrt(.75);this.sh.coefficients[0].copy(o).add(a).multiplyScalar(s),this.sh.coefficients[1].copy(o).sub(a).multiplyScalar(l)}function Au(t,e){cu.call(this,void 0,e);const i=(new _r).set(t);this.sh.coefficients[0].set(i.r,i.g,i.b).multiplyScalar(2*Math.sqrt(Math.PI))}Eu.prototype=Object.assign(Object.create(_h.prototype),{constructor:Eu,load:function(t,e,i,n){const r=this,o=new xh(r.manager);o.setResponseType("arraybuffer"),o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(t,(function(i){try{const t=i.slice(0);Su.getContext().decodeAudioData(t,(function(t){e(t)}))}catch(e){n?n(e):console.error(e),r.manager.itemError(t)}}),i,n)}}),Cu.prototype=Object.assign(Object.create(cu.prototype),{constructor:Cu,isHemisphereLightProbe:!0,copy:function(t){return cu.prototype.copy.call(this,t),this},toJSON:function(t){return cu.prototype.toJSON.call(this,t)}}),Au.prototype=Object.assign(Object.create(cu.prototype),{constructor:Au,isAmbientLightProbe:!0,copy:function(t){return cu.prototype.copy.call(this,t),this},toJSON:function(t){return cu.prototype.toJSON.call(this,t)}});const Pu=new Sn,Lu=new Sn;function Iu(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new vo,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new vo,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}Object.assign(Iu.prototype,{update:function(t){const e=this._cache;if(e.focus!==t.focus||e.fov!==t.fov||e.aspect!==t.aspect*this.aspect||e.near!==t.near||e.far!==t.far||e.zoom!==t.zoom||e.eyeSep!==this.eyeSep){e.focus=t.focus,e.fov=t.fov,e.aspect=t.aspect*this.aspect,e.near=t.near,e.far=t.far,e.zoom=t.zoom,e.eyeSep=this.eyeSep;const i=t.projectionMatrix.clone(),n=e.eyeSep/2,r=n*e.near/e.focus,o=e.near*Math.tan(Fi.DEG2RAD*e.fov*.5)/e.zoom;let a,s;Lu.elements[12]=-n,Pu.elements[12]=n,a=-o*e.aspect+r,s=o*e.aspect+r,i.elements[0]=2*e.near/(s-a),i.elements[8]=(s+a)/(s-a),this.cameraL.projectionMatrix.copy(i),a=-o*e.aspect-r,s=o*e.aspect-r,i.elements[0]=2*e.near/(s-a),i.elements[8]=(s+a)/(s-a),this.cameraR.projectionMatrix.copy(i)}this.cameraL.matrixWorld.copy(t.matrixWorld).multiply(Lu),this.cameraR.matrixWorld.copy(t.matrixWorld).multiply(Pu)}});class Ru{constructor(t){this.autoStart=void 0===t||t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=Du(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=Du();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}function Du(){return("undefined"==typeof performance?Date:performance).now()}const ku=new $i,Ou=new Yi,zu=new $i,Bu=new $i;class Fu extends $n{constructor(){super(),this.type="AudioListener",this.context=Su.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new Ru}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(t){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=t,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this}updateMatrixWorld(t){super.updateMatrixWorld(t);const e=this.context.listener,i=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(ku,Ou,zu),Bu.set(0,0,-1).applyQuaternion(Ou),e.positionX){const t=this.context.currentTime+this.timeDelta;e.positionX.linearRampToValueAtTime(ku.x,t),e.positionY.linearRampToValueAtTime(ku.y,t),e.positionZ.linearRampToValueAtTime(ku.z,t),e.forwardX.linearRampToValueAtTime(Bu.x,t),e.forwardY.linearRampToValueAtTime(Bu.y,t),e.forwardZ.linearRampToValueAtTime(Bu.z,t),e.upX.linearRampToValueAtTime(i.x,t),e.upY.linearRampToValueAtTime(i.y,t),e.upZ.linearRampToValueAtTime(i.z,t)}else e.setPosition(ku.x,ku.y,ku.z),e.setOrientation(Bu.x,Bu.y,Bu.z,i.x,i.y,i.z)}}class Nu extends $n{constructor(t){super(),this.type="Audio",this.listener=t,this.context=t.context,this.gain=this.context.createGain(),this.gain.connect(t.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(t){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=t,this.connect(),this}setMediaElementSource(t){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(t),this.connect(),this}setMediaStreamSource(t){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(t),this.connect(),this}setBuffer(t){return this.buffer=t,this.sourceType="buffer",this.autoplay&&this.play(),this}play(t=0){if(!0===this.isPlaying)return void console.warn("THREE.Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void console.warn("THREE.Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+t;const e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.loopStart=this.loopStart,e.loopEnd=this.loopEnd,e.onended=this.onEnded.bind(this),e.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=e,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")}stop(){if(!1!==this.hasPlaybackControl)return this._progress=0,this.source.stop(),this.source.onended=null,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let t=1,e=this.filters.length;t<e;t++)this.filters[t-1].connect(this.filters[t]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let t=1,e=this.filters.length;t<e;t++)this.filters[t-1].disconnect(this.filters[t]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}getFilters(){return this.filters}setFilters(t){return t||(t=[]),!0===this._connected?(this.disconnect(),this.filters=t.slice(),this.connect()):this.filters=t.slice(),this}setDetune(t){if(this.detune=t,void 0!==this.source.detune)return!0===this.isPlaying&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(t){return this.setFilters(t?[t]:[])}setPlaybackRate(t){if(!1!==this.hasPlaybackControl)return this.playbackRate=t,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;console.warn("THREE.Audio: this Audio has no playback control.")}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop}setLoop(t){if(!1!==this.hasPlaybackControl)return this.loop=t,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")}setLoopStart(t){return this.loopStart=t,this}setLoopEnd(t){return this.loopEnd=t,this}getVolume(){return this.gain.gain.value}setVolume(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this}}const ju=new $i,Gu=new Yi,Uu=new $i,Vu=new $i;class Hu extends Nu{constructor(t){super(t),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}getOutput(){return this.panner}getRefDistance(){return this.panner.refDistance}setRefDistance(t){return this.panner.refDistance=t,this}getRolloffFactor(){return this.panner.rolloffFactor}setRolloffFactor(t){return this.panner.rolloffFactor=t,this}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(t){return this.panner.distanceModel=t,this}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(t){return this.panner.maxDistance=t,this}setDirectionalCone(t,e,i){return this.panner.coneInnerAngle=t,this.panner.coneOuterAngle=e,this.panner.coneOuterGain=i,this}updateMatrixWorld(t){if(super.updateMatrixWorld(t),!0===this.hasPlaybackControl&&!1===this.isPlaying)return;this.matrixWorld.decompose(ju,Gu,Uu),Vu.set(0,0,1).applyQuaternion(Gu);const e=this.panner;if(e.positionX){const t=this.context.currentTime+this.listener.timeDelta;e.positionX.linearRampToValueAtTime(ju.x,t),e.positionY.linearRampToValueAtTime(ju.y,t),e.positionZ.linearRampToValueAtTime(ju.z,t),e.orientationX.linearRampToValueAtTime(Vu.x,t),e.orientationY.linearRampToValueAtTime(Vu.y,t),e.orientationZ.linearRampToValueAtTime(Vu.z,t)}else e.setPosition(ju.x,ju.y,ju.z),e.setOrientation(Vu.x,Vu.y,Vu.z)}}class Zu{constructor(t,e=2048){this.analyser=t.context.createAnalyser(),this.analyser.fftSize=e,this.data=new Uint8Array(this.analyser.frequencyBinCount),t.getOutput().connect(this.analyser)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.data),this.data}getAverageFrequency(){let t=0;const e=this.getFrequencyData();for(let i=0;i<e.length;i++)t+=e[i];return t/e.length}}function Wu(t,e,i){let n,r,o;switch(this.binding=t,this.valueSize=i,e){case"quaternion":n=this._slerp,r=this._slerpAdditive,o=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*i),this._workIndex=5;break;case"string":case"bool":n=this._select,r=this._select,o=this._setAdditiveIdentityOther,this.buffer=new Array(5*i);break;default:n=this._lerp,r=this._lerpAdditive,o=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*i)}this._mixBufferRegion=n,this._mixBufferRegionAdditive=r,this._setIdentity=o,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}Object.assign(Wu.prototype,{accumulate:function(t,e){const i=this.buffer,n=this.valueSize,r=t*n+n;let o=this.cumulativeWeight;if(0===o){for(let t=0;t!==n;++t)i[r+t]=i[t];o=e}else{o+=e;const t=e/o;this._mixBufferRegion(i,r,0,t,n)}this.cumulativeWeight=o},accumulateAdditive:function(t){const e=this.buffer,i=this.valueSize,n=i*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(e,n,0,t,i),this.cumulativeWeightAdditive+=t},apply:function(t){const e=this.valueSize,i=this.buffer,n=t*e+e,r=this.cumulativeWeight,o=this.cumulativeWeightAdditive,a=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,r<1){const t=e*this._origIndex;this._mixBufferRegion(i,n,t,1-r,e)}o>0&&this._mixBufferRegionAdditive(i,n,this._addIndex*e,1,e);for(let t=e,r=e+e;t!==r;++t)if(i[t]!==i[t+e]){a.setValue(i,n);break}},saveOriginalState:function(){const t=this.binding,e=this.buffer,i=this.valueSize,n=i*this._origIndex;t.getValue(e,n);for(let t=i,r=n;t!==r;++t)e[t]=e[n+t%i];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0},restoreOriginalState:function(){const t=3*this.valueSize;this.binding.setValue(this.buffer,t)},_setAdditiveIdentityNumeric:function(){const t=this._addIndex*this.valueSize,e=t+this.valueSize;for(let i=t;i<e;i++)this.buffer[i]=0},_setAdditiveIdentityQuaternion:function(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1},_setAdditiveIdentityOther:function(){const t=this._origIndex*this.valueSize,e=this._addIndex*this.valueSize;for(let i=0;i<this.valueSize;i++)this.buffer[e+i]=this.buffer[t+i]},_select:function(t,e,i,n,r){if(n>=.5)for(let n=0;n!==r;++n)t[e+n]=t[i+n]},_slerp:function(t,e,i,n){Yi.slerpFlat(t,e,t,e,t,i,n)},_slerpAdditive:function(t,e,i,n,r){const o=this._workIndex*r;Yi.multiplyQuaternionsFlat(t,o,t,e,t,i),Yi.slerpFlat(t,e,t,e,t,o,n)},_lerp:function(t,e,i,n,r){const o=1-n;for(let a=0;a!==r;++a){const r=e+a;t[r]=t[r]*o+t[i+a]*n}},_lerpAdditive:function(t,e,i,n,r){for(let o=0;o!==r;++o){const r=e+o;t[r]=t[r]+t[i+o]*n}}});const qu=new RegExp("[\\[\\]\\.:\\/]","g"),Xu="[^"+"\\[\\]\\.:\\/".replace("\\.","")+"]",Yu=/((?:WC+[\/:])*)/.source.replace("WC","[^\\[\\]\\.:\\/]"),$u=/(WCOD+)?/.source.replace("WCOD",Xu),Ju=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC","[^\\[\\]\\.:\\/]"),Ku=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC","[^\\[\\]\\.:\\/]"),Qu=new RegExp("^"+Yu+$u+Ju+Ku+"$"),td=["material","materials","bones"];function ed(t,e,i){const n=i||id.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,n)}function id(t,e,i){this.path=e,this.parsedPath=i||id.parseTrackName(e),this.node=id.findNode(t,this.parsedPath.nodeName)||t,this.rootNode=t}function nd(){this.uuid=Fi.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const t={};this._indicesByUUID=t;for(let e=0,i=arguments.length;e!==i;++e)t[arguments[e].uuid]=e;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const e=this;this.stats={objects:{get total(){return e._objects.length},get inUse(){return this.total-e.nCachedObjects_}},get bindingsPerObject(){return e._bindings.length}}}Object.assign(ed.prototype,{getValue:function(t,e){this.bind();const i=this._targetGroup.nCachedObjects_,n=this._bindings[i];void 0!==n&&n.getValue(t,e)},setValue:function(t,e){const i=this._bindings;for(let n=this._targetGroup.nCachedObjects_,r=i.length;n!==r;++n)i[n].setValue(t,e)},bind:function(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].bind()},unbind:function(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].unbind()}}),Object.assign(id,{Composite:ed,create:function(t,e,i){return t&&t.isAnimationObjectGroup?new id.Composite(t,e,i):new id(t,e,i)},sanitizeNodeName:function(t){return t.replace(/\s/g,"_").replace(qu,"")},parseTrackName:function(t){const e=Qu.exec(t);if(!e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);const i={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},n=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){const t=i.nodeName.substring(n+1);-1!==td.indexOf(t)&&(i.nodeName=i.nodeName.substring(0,n),i.objectName=t)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return i},findNode:function(t,e){if(!e||""===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){const i=t.skeleton.getBoneByName(e);if(void 0!==i)return i}if(t.children){const i=function(t){for(let n=0;n<t.length;n++){const r=t[n];if(r.name===e||r.uuid===e)return r;const o=i(r.children);if(o)return o}return null},n=i(t.children);if(n)return n}return null}}),Object.assign(id.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(t,e){t[e]=this.node[this.propertyName]},function(t,e){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)t[e++]=i[n]},function(t,e){t[e]=this.resolvedProperty[this.propertyIndex]},function(t,e){this.resolvedProperty.toArray(t,e)}],SetterByBindingTypeAndVersioning:[[function(t,e){this.targetObject[this.propertyName]=t[e]},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=t[e++]},function(t,e){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=t[e++];this.targetObject.needsUpdate=!0},function(t,e){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty[this.propertyIndex]=t[e]},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty.fromArray(t,e)},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(t,e){this.bind(),this.getValue(t,e)},setValue:function(t,e){this.bind(),this.setValue(t,e)},bind:function(){let t=this.node;const e=this.parsedPath,i=e.objectName,n=e.propertyName;let r=e.propertyIndex;if(t||(t=id.findNode(this.rootNode,e.nodeName)||this.rootNode,this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!t)return void console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.");if(i){let n=e.objectIndex;switch(i){case"materials":if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);t=t.material.materials;break;case"bones":if(!t.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);t=t.skeleton.bones;for(let e=0;e<t.length;e++)if(t[e].name===n){n=e;break}break;default:if(void 0===t[i])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);t=t[i]}if(void 0!==n){if(void 0===t[n])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,t);t=t[n]}}const o=t[n];if(void 0===o){const i=e.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+i+"."+n+" but it wasn't found.",t)}let a=this.Versioning.None;this.targetObject=t,void 0!==t.needsUpdate?a=this.Versioning.NeedsUpdate:void 0!==t.matrixWorldNeedsUpdate&&(a=this.Versioning.MatrixWorldNeedsUpdate);let s=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===n){if(!t.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!t.geometry.isBufferGeometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences on THREE.Geometry. Use THREE.BufferGeometry instead.",this);if(!t.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==t.morphTargetDictionary[r]&&(r=t.morphTargetDictionary[r])}s=this.BindingType.ArrayElement,this.resolvedProperty=o,this.propertyIndex=r}else void 0!==o.fromArray&&void 0!==o.toArray?(s=this.BindingType.HasFromToArray,this.resolvedProperty=o):Array.isArray(o)?(s=this.BindingType.EntireArray,this.resolvedProperty=o):this.propertyName=n;this.getValue=this.GetterByBindingType[s],this.setValue=this.SetterByBindingTypeAndVersioning[s][a]},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(id.prototype,{_getValue_unbound:id.prototype.getValue,_setValue_unbound:id.prototype.setValue}),Object.assign(nd.prototype,{isAnimationObjectGroup:!0,add:function(){const t=this._objects,e=this._indicesByUUID,i=this._paths,n=this._parsedPaths,r=this._bindings,o=r.length;let a=void 0,s=t.length,l=this.nCachedObjects_;for(let c=0,h=arguments.length;c!==h;++c){const h=arguments[c],u=h.uuid;let d=e[u];if(void 0===d){d=s++,e[u]=d,t.push(h);for(let t=0,e=o;t!==e;++t)r[t].push(new id(h,i[t],n[t]))}else if(d<l){a=t[d];const s=--l,c=t[s];e[c.uuid]=d,t[d]=c,e[u]=s,t[s]=h;for(let t=0,e=o;t!==e;++t){const e=r[t],o=e[s];let a=e[d];e[d]=o,void 0===a&&(a=new id(h,i[t],n[t])),e[s]=a}}else t[d]!==a&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=l},remove:function(){const t=this._objects,e=this._indicesByUUID,i=this._bindings,n=i.length;let r=this.nCachedObjects_;for(let o=0,a=arguments.length;o!==a;++o){const a=arguments[o],s=a.uuid,l=e[s];if(void 0!==l&&l>=r){const o=r++,c=t[o];e[c.uuid]=l,t[l]=c,e[s]=o,t[o]=a;for(let t=0,e=n;t!==e;++t){const e=i[t],n=e[o],r=e[l];e[l]=n,e[o]=r}}}this.nCachedObjects_=r},uncache:function(){const t=this._objects,e=this._indicesByUUID,i=this._bindings,n=i.length;let r=this.nCachedObjects_,o=t.length;for(let a=0,s=arguments.length;a!==s;++a){const s=arguments[a].uuid,l=e[s];if(void 0!==l)if(delete e[s],l<r){const a=--r,s=t[a],c=--o,h=t[c];e[s.uuid]=l,t[l]=s,e[h.uuid]=a,t[a]=h,t.pop();for(let t=0,e=n;t!==e;++t){const e=i[t],n=e[a],r=e[c];e[l]=n,e[a]=r,e.pop()}}else{const r=--o,a=t[r];r>0&&(e[a.uuid]=l),t[l]=a,t.pop();for(let t=0,e=n;t!==e;++t){const e=i[t];e[l]=e[r],e.pop()}}}this.nCachedObjects_=r},subscribe_:function(t,e){const i=this._bindingsIndicesByPath;let n=i[t];const r=this._bindings;if(void 0!==n)return r[n];const o=this._paths,a=this._parsedPaths,s=this._objects,l=s.length,c=this.nCachedObjects_,h=new Array(l);n=r.length,i[t]=n,o.push(t),a.push(e),r.push(h);for(let i=c,n=s.length;i!==n;++i){const n=s[i];h[i]=new id(n,t,e)}return h},unsubscribe_:function(t){const e=this._bindingsIndicesByPath,i=e[t];if(void 0!==i){const n=this._paths,r=this._parsedPaths,o=this._bindings,a=o.length-1,s=o[a];e[t[a]]=i,o[i]=s,o.pop(),r[i]=r[a],r.pop(),n[i]=n[a],n.pop()}}});class rd{constructor(t,e,i=null,n=e.blendMode){this._mixer=t,this._clip=e,this._localRoot=i,this.blendMode=n;const r=e.tracks,o=r.length,a=new Array(o),s={endingStart:Ue,endingEnd:Ue};for(let t=0;t!==o;++t){const e=r[t].createInterpolant(null);a[t]=e,e.settings=s}this._interpolantSettings=s,this._interpolants=a,this._propertyBindings=new Array(o),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=Be,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(t){return this._startTime=t,this}setLoop(t,e){return this.loop=t,this.repetitions=e,this}setEffectiveWeight(t){return this.weight=t,this._effectiveWeight=this.enabled?t:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(t){return this._scheduleFading(t,0,1)}fadeOut(t){return this._scheduleFading(t,1,0)}crossFadeFrom(t,e,i){if(t.fadeOut(e),this.fadeIn(e),i){const i=this._clip.duration,n=t._clip.duration,r=n/i,o=i/n;t.warp(1,r,e),this.warp(o,1,e)}return this}crossFadeTo(t,e,i){return t.crossFadeFrom(this,e,i)}stopFading(){const t=this._weightInterpolant;return null!==t&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this}setEffectiveTimeScale(t){return this.timeScale=t,this._effectiveTimeScale=this.paused?0:t,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(t){return this.timeScale=this._clip.duration/t,this.stopWarping()}syncWith(t){return this.time=t.time,this.timeScale=t.timeScale,this.stopWarping()}halt(t){return this.warp(this._effectiveTimeScale,0,t)}warp(t,e,i){const n=this._mixer,r=n.time,o=this.timeScale;let a=this._timeScaleInterpolant;null===a&&(a=n._lendControlInterpolant(),this._timeScaleInterpolant=a);const s=a.parameterPositions,l=a.sampleValues;return s[0]=r,s[1]=r+i,l[0]=t/o,l[1]=e/o,this}stopWarping(){const t=this._timeScaleInterpolant;return null!==t&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(t,e,i,n){if(!this.enabled)return void this._updateWeight(t);const r=this._startTime;if(null!==r){const n=(t-r)*i;if(n<0||0===i)return;this._startTime=null,e=i*n}e*=this._updateTimeScale(t);const o=this._updateTime(e),a=this._updateWeight(t);if(a>0){const t=this._interpolants,e=this._propertyBindings;switch(this.blendMode){case We:for(let i=0,n=t.length;i!==n;++i)t[i].evaluate(o),e[i].accumulateAdditive(a);break;case Ze:default:for(let i=0,r=t.length;i!==r;++i)t[i].evaluate(o),e[i].accumulate(n,a)}}}_updateWeight(t){let e=0;if(this.enabled){e=this.weight;const i=this._weightInterpolant;if(null!==i){const n=i.evaluate(t)[0];e*=n,t>i.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=e,e}_updateTimeScale(t){let e=0;if(!this.paused){e=this.timeScale;const i=this._timeScaleInterpolant;if(null!==i){e*=i.evaluate(t)[0],t>i.parameterPositions[1]&&(this.stopWarping(),0===e?this.paused=!0:this.timeScale=e)}}return this._effectiveTimeScale=e,e}_updateTime(t){const e=this._clip.duration,i=this.loop;let n=this.time+t,r=this._loopCount;const o=i===Fe;if(0===t)return-1===r?n:o&&1==(1&r)?e-n:n;if(i===ze){-1===r&&(this._loopCount=0,this._setEndings(!0,!0,!1));t:{if(n>=e)n=e;else{if(!(n<0)){this.time=n;break t}n=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:t<0?-1:1})}}else{if(-1===r&&(t>=0?(r=0,this._setEndings(!0,0===this.repetitions,o)):this._setEndings(0===this.repetitions,!0,o)),n>=e||n<0){const i=Math.floor(n/e);n-=e*i,r+=Math.abs(i);const a=this.repetitions-r;if(a<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,n=t>0?e:0,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:t>0?1:-1});else{if(1===a){const e=t<0;this._setEndings(e,!e,o)}else this._setEndings(!1,!1,o);this._loopCount=r,this.time=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:i})}}else this.time=n;if(o&&1==(1&r))return e-n}return n}_setEndings(t,e,i){const n=this._interpolantSettings;i?(n.endingStart=Ve,n.endingEnd=Ve):(n.endingStart=t?this.zeroSlopeAtStart?Ve:Ue:He,n.endingEnd=e?this.zeroSlopeAtEnd?Ve:Ue:He)}_scheduleFading(t,e,i){const n=this._mixer,r=n.time;let o=this._weightInterpolant;null===o&&(o=n._lendControlInterpolant(),this._weightInterpolant=o);const a=o.parameterPositions,s=o.sampleValues;return a[0]=r,s[0]=e,a[1]=r+t,s[1]=i,this}}function od(t){this._root=t,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}od.prototype=Object.assign(Object.create(Oi.prototype),{constructor:od,_bindAction:function(t,e){const i=t._localRoot||this._root,n=t._clip.tracks,r=n.length,o=t._propertyBindings,a=t._interpolants,s=i.uuid,l=this._bindingsByRootAndName;let c=l[s];void 0===c&&(c={},l[s]=c);for(let t=0;t!==r;++t){const r=n[t],l=r.name;let h=c[l];if(void 0!==h)o[t]=h;else{if(h=o[t],void 0!==h){null===h._cacheIndex&&(++h.referenceCount,this._addInactiveBinding(h,s,l));continue}const n=e&&e._propertyBindings[t].binding.parsedPath;h=new Wu(id.create(i,l,n),r.ValueTypeName,r.getValueSize()),++h.referenceCount,this._addInactiveBinding(h,s,l),o[t]=h}a[t].resultBuffer=h.buffer}},_activateAction:function(t){if(!this._isActiveAction(t)){if(null===t._cacheIndex){const e=(t._localRoot||this._root).uuid,i=t._clip.uuid,n=this._actionsByClip[i];this._bindAction(t,n&&n.knownActions[0]),this._addInactiveAction(t,i,e)}const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==i.useCount++&&(this._lendBinding(i),i.saveOriginalState())}this._lendAction(t)}},_deactivateAction:function(t){if(this._isActiveAction(t)){const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==--i.useCount&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(t)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const t=this;this.stats={actions:{get total(){return t._actions.length},get inUse(){return t._nActiveActions}},bindings:{get total(){return t._bindings.length},get inUse(){return t._nActiveBindings}},controlInterpolants:{get total(){return t._controlInterpolants.length},get inUse(){return t._nActiveControlInterpolants}}}},_isActiveAction:function(t){const e=t._cacheIndex;return null!==e&&e<this._nActiveActions},_addInactiveAction:function(t,e,i){const n=this._actions,r=this._actionsByClip;let o=r[e];if(void 0===o)o={knownActions:[t],actionByRoot:{}},t._byClipCacheIndex=0,r[e]=o;else{const e=o.knownActions;t._byClipCacheIndex=e.length,e.push(t)}t._cacheIndex=n.length,n.push(t),o.actionByRoot[i]=t},_removeInactiveAction:function(t){const e=this._actions,i=e[e.length-1],n=t._cacheIndex;i._cacheIndex=n,e[n]=i,e.pop(),t._cacheIndex=null;const r=t._clip.uuid,o=this._actionsByClip,a=o[r],s=a.knownActions,l=s[s.length-1],c=t._byClipCacheIndex;l._byClipCacheIndex=c,s[c]=l,s.pop(),t._byClipCacheIndex=null;delete a.actionByRoot[(t._localRoot||this._root).uuid],0===s.length&&delete o[r],this._removeInactiveBindingsForAction(t)},_removeInactiveBindingsForAction:function(t){const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==--i.referenceCount&&this._removeInactiveBinding(i)}},_lendAction:function(t){const e=this._actions,i=t._cacheIndex,n=this._nActiveActions++,r=e[n];t._cacheIndex=n,e[n]=t,r._cacheIndex=i,e[i]=r},_takeBackAction:function(t){const e=this._actions,i=t._cacheIndex,n=--this._nActiveActions,r=e[n];t._cacheIndex=n,e[n]=t,r._cacheIndex=i,e[i]=r},_addInactiveBinding:function(t,e,i){const n=this._bindingsByRootAndName,r=this._bindings;let o=n[e];void 0===o&&(o={},n[e]=o),o[i]=t,t._cacheIndex=r.length,r.push(t)},_removeInactiveBinding:function(t){const e=this._bindings,i=t.binding,n=i.rootNode.uuid,r=i.path,o=this._bindingsByRootAndName,a=o[n],s=e[e.length-1],l=t._cacheIndex;s._cacheIndex=l,e[l]=s,e.pop(),delete a[r],0===Object.keys(a).length&&delete o[n]},_lendBinding:function(t){const e=this._bindings,i=t._cacheIndex,n=this._nActiveBindings++,r=e[n];t._cacheIndex=n,e[n]=t,r._cacheIndex=i,e[i]=r},_takeBackBinding:function(t){const e=this._bindings,i=t._cacheIndex,n=--this._nActiveBindings,r=e[n];t._cacheIndex=n,e[n]=t,r._cacheIndex=i,e[i]=r},_lendControlInterpolant:function(){const t=this._controlInterpolants,e=this._nActiveControlInterpolants++;let i=t[e];return void 0===i&&(i=new nh(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),i.__cacheIndex=e,t[e]=i),i},_takeBackControlInterpolant:function(t){const e=this._controlInterpolants,i=t.__cacheIndex,n=--this._nActiveControlInterpolants,r=e[n];t.__cacheIndex=n,e[n]=t,r.__cacheIndex=i,e[i]=r},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(t,e,i){const n=e||this._root,r=n.uuid;let o="string"==typeof t?ph.findByName(n,t):t;const a=null!==o?o.uuid:t,s=this._actionsByClip[a];let l=null;if(void 0===i&&(i=null!==o?o.blendMode:Ze),void 0!==s){const t=s.actionByRoot[r];if(void 0!==t&&t.blendMode===i)return t;l=s.knownActions[0],null===o&&(o=l._clip)}if(null===o)return null;const c=new rd(this,o,e,i);return this._bindAction(c,l),this._addInactiveAction(c,a,r),c},existingAction:function(t,e){const i=e||this._root,n=i.uuid,r="string"==typeof t?ph.findByName(i,t):t,o=r?r.uuid:t,a=this._actionsByClip[o];return void 0!==a&&a.actionByRoot[n]||null},stopAllAction:function(){const t=this._actions;for(let e=this._nActiveActions-1;e>=0;--e)t[e].stop();return this},update:function(t){t*=this.timeScale;const e=this._actions,i=this._nActiveActions,n=this.time+=t,r=Math.sign(t),o=this._accuIndex^=1;for(let a=0;a!==i;++a){e[a]._update(n,t,r,o)}const a=this._bindings,s=this._nActiveBindings;for(let t=0;t!==s;++t)a[t].apply(o);return this},setTime:function(t){this.time=0;for(let t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(t)},getRoot:function(){return this._root},uncacheClip:function(t){const e=this._actions,i=t.uuid,n=this._actionsByClip,r=n[i];if(void 0!==r){const t=r.knownActions;for(let i=0,n=t.length;i!==n;++i){const n=t[i];this._deactivateAction(n);const r=n._cacheIndex,o=e[e.length-1];n._cacheIndex=null,n._byClipCacheIndex=null,o._cacheIndex=r,e[r]=o,e.pop(),this._removeInactiveBindingsForAction(n)}delete n[i]}},uncacheRoot:function(t){const e=t.uuid,i=this._actionsByClip;for(const t in i){const n=i[t].actionByRoot[e];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}const n=this._bindingsByRootAndName[e];if(void 0!==n)for(const t in n){const e=n[t];e.restoreOriginalState(),this._removeInactiveBinding(e)}},uncacheAction:function(t,e){const i=this.existingAction(t,e);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}});class ad{constructor(t){"string"==typeof t&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),t=arguments[1]),this.value=t}clone(){return new ad(void 0===this.value.clone?this.value:this.value.clone())}}function sd(t,e,i){Fs.call(this,t,e),this.meshPerAttribute=i||1}function ld(t,e,i,n,r){this.buffer=t,this.type=e,this.itemSize=i,this.elementSize=n,this.count=r,this.version=0}function cd(t,e,i,n){this.ray=new Tn(t,e),this.near=i||0,this.far=n||1/0,this.camera=null,this.layers=new zn,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function hd(t,e){return t.distance-e.distance}function ud(t,e,i,n){if(t.layers.test(e.layers)&&t.raycast(e,i),!0===n){const n=t.children;for(let t=0,r=n.length;t<r;t++)ud(n[t],e,i,!0)}}sd.prototype=Object.assign(Object.create(Fs.prototype),{constructor:sd,isInstancedInterleavedBuffer:!0,copy:function(t){return Fs.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this},clone:function(t){const e=Fs.prototype.clone.call(this,t);return e.meshPerAttribute=this.meshPerAttribute,e},toJSON:function(t){const e=Fs.prototype.toJSON.call(this,t);return e.isInstancedInterleavedBuffer=!0,e.meshPerAttribute=this.meshPerAttribute,e}}),Object.defineProperty(ld.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(ld.prototype,{isGLBufferAttribute:!0,setBuffer:function(t){return this.buffer=t,this},setType:function(t,e){return this.type=t,this.elementSize=e,this},setItemSize:function(t){return this.itemSize=t,this},setCount:function(t){return this.count=t,this}}),Object.assign(cd.prototype,{set:function(t,e){this.ray.set(t,e)},setFromCamera:function(t,e){e&&e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e&&e.isOrthographicCamera?(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e):console.error("THREE.Raycaster: Unsupported camera type: "+e.type)},intersectObject:function(t,e,i){const n=i||[];return ud(t,this,n,e),n.sort(hd),n},intersectObjects:function(t,e,i){const n=i||[];if(!1===Array.isArray(t))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),n;for(let i=0,r=t.length;i<r;i++)ud(t[i],this,n,e);return n.sort(hd),n}});class dd{constructor(t=1,e=0,i=0){return this.radius=t,this.phi=e,this.theta=i,this}set(t,e,i){return this.radius=t,this.phi=e,this.theta=i,this}clone(){return(new this.constructor).copy(this)}copy(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this}makeSafe(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this}setFromVector3(t){return this.setFromCartesianCoords(t.x,t.y,t.z)}setFromCartesianCoords(t,e,i){return this.radius=Math.sqrt(t*t+e*e+i*i),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t,i),this.phi=Math.acos(Fi.clamp(e/this.radius,-1,1))),this}}class pd{constructor(t,e,i){return this.radius=void 0!==t?t:1,this.theta=void 0!==e?e:0,this.y=void 0!==i?i:0,this}set(t,e,i){return this.radius=t,this.theta=e,this.y=i,this}clone(){return(new this.constructor).copy(this)}copy(t){return this.radius=t.radius,this.theta=t.theta,this.y=t.y,this}setFromVector3(t){return this.setFromCartesianCoords(t.x,t.y,t.z)}setFromCartesianCoords(t,e,i){return this.radius=Math.sqrt(t*t+i*i),this.theta=Math.atan2(t,i),this.y=e,this}}const fd=new Ni;class md{constructor(t,e){Object.defineProperty(this,"isBox2",{value:!0}),this.min=void 0!==t?t:new Ni(1/0,1/0),this.max=void 0!==e?e:new Ni(-1/0,-1/0)}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=fd.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(t){return void 0===t&&(console.warn("THREE.Box2: .getCenter() target is now required"),t=new Ni),this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return void 0===t&&(console.warn("THREE.Box2: .getSize() target is now required"),t=new Ni),this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}getParameter(t,e){return void 0===e&&(console.warn("THREE.Box2: .getParameter() target is now required"),e=new Ni),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}clampPoint(t,e){return void 0===e&&(console.warn("THREE.Box2: .clampPoint() target is now required"),e=new Ni),e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return fd.copy(t).clamp(this.min,this.max).sub(t).length()}intersect(t){return this.min.max(t.min),this.max.min(t.max),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const gd=new $i,yd=new $i;class _d{constructor(t,e){this.start=void 0!==t?t:new $i,this.end=void 0!==e?e:new $i}set(t,e){return this.start.copy(t),this.end.copy(e),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}getCenter(t){return void 0===t&&(console.warn("THREE.Line3: .getCenter() target is now required"),t=new $i),t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t){return void 0===t&&(console.warn("THREE.Line3: .delta() target is now required"),t=new $i),t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e){return void 0===e&&(console.warn("THREE.Line3: .at() target is now required"),e=new $i),this.delta(e).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e){gd.subVectors(t,this.start),yd.subVectors(this.end,this.start);const i=yd.dot(yd);let n=yd.dot(gd)/i;return e&&(n=Fi.clamp(n,0,1)),n}closestPointToPoint(t,e,i){const n=this.closestPointToPointParameter(t,e);return void 0===i&&(console.warn("THREE.Line3: .closestPointToPoint() target is now required"),i=new $i),this.delta(i).multiplyScalar(n).add(this.start)}applyMatrix4(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}}function vd(t){$n.call(this),this.material=t,this.render=function(){},this.hasPositions=!1,this.hasNormals=!1,this.hasColors=!1,this.hasUvs=!1,this.positionArray=null,this.normalArray=null,this.colorArray=null,this.uvArray=null,this.count=0}vd.prototype=Object.create($n.prototype),vd.prototype.constructor=vd,vd.prototype.isImmediateRenderObject=!0;const xd=new $i;class bd extends $n{constructor(t,e){super(),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=e;const i=new Wr,n=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let t=0,e=1,i=32;t<i;t++,e++){const r=t/i*Math.PI*2,o=e/i*Math.PI*2;n.push(Math.cos(r),Math.sin(r),1,Math.cos(o),Math.sin(o),1)}i.setAttribute("position",new kr(n,3));const r=new bl({fog:!1,toneMapped:!1});this.cone=new Ll(i,r),this.add(this.cone),this.update()}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose()}update(){this.light.updateMatrixWorld();const t=this.light.distance?this.light.distance:1e3,e=t*Math.tan(this.light.angle);this.cone.scale.set(e,e,t),xd.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(xd),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}const wd=new $i,Md=new Sn,Td=new Sn;class Sd extends Ll{constructor(t){const e=function t(e){const i=[];e&&e.isBone&&i.push(e);for(let n=0;n<e.children.length;n++)i.push.apply(i,t(e.children[n]));return i}(t),i=new Wr,n=[],r=[],o=new _r(0,0,1),a=new _r(0,1,0);for(let t=0;t<e.length;t++){const i=e[t];i.parent&&i.parent.isBone&&(n.push(0,0,0),n.push(0,0,0),r.push(o.r,o.g,o.b),r.push(a.r,a.g,a.b))}i.setAttribute("position",new kr(n,3)),i.setAttribute("color",new kr(r,3));super(i,new bl({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.type="SkeletonHelper",this.isSkeletonHelper=!0,this.root=t,this.bones=e,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(t){const e=this.bones,i=this.geometry,n=i.getAttribute("position");Td.copy(this.root.matrixWorld).invert();for(let t=0,i=0;t<e.length;t++){const r=e[t];r.parent&&r.parent.isBone&&(Md.multiplyMatrices(Td,r.matrixWorld),wd.setFromMatrixPosition(Md),n.setXYZ(i,wd.x,wd.y,wd.z),Md.multiplyMatrices(Td,r.parent.matrixWorld),wd.setFromMatrixPosition(Md),n.setXYZ(i+1,wd.x,wd.y,wd.z),i+=2)}i.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(t)}}class Ed extends ho{constructor(t,e,i){super(new Oc(e,4,2),new wr({wireframe:!0,fog:!1,toneMapped:!1})),this.light=t,this.light.updateMatrixWorld(),this.color=i,this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}dispose(){this.geometry.dispose(),this.material.dispose()}update(){void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)}}const Cd=new $i,Ad=new _r,Pd=new _r;class Ld extends $n{constructor(t,e,i){super(),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i;const n=new Ic(e);n.rotateY(.5*Math.PI),this.material=new wr({wireframe:!0,fog:!1,toneMapped:!1}),void 0===this.color&&(this.material.vertexColors=!0);const r=n.getAttribute("position"),o=new Float32Array(3*r.count);n.setAttribute("color",new Sr(o,3)),this.add(new ho(n,this.material)),this.update()}dispose(){this.children[0].geometry.dispose(),this.children[0].material.dispose()}update(){const t=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{const e=t.geometry.getAttribute("color");Ad.copy(this.light.color),Pd.copy(this.light.groundColor);for(let t=0,i=e.count;t<i;t++){const n=t<i/2?Ad:Pd;e.setXYZ(t,n.r,n.g,n.b)}e.needsUpdate=!0}t.lookAt(Cd.setFromMatrixPosition(this.light.matrixWorld).negate())}}class Id extends Ll{constructor(t=10,e=10,i=4473924,n=8947848){i=new _r(i),n=new _r(n);const r=e/2,o=t/e,a=t/2,s=[],l=[];for(let t=0,c=0,h=-a;t<=e;t++,h+=o){s.push(-a,0,h,a,0,h),s.push(h,0,-a,h,0,a);const e=t===r?i:n;e.toArray(l,c),c+=3,e.toArray(l,c),c+=3,e.toArray(l,c),c+=3,e.toArray(l,c),c+=3}const c=new Wr;c.setAttribute("position",new kr(s,3)),c.setAttribute("color",new kr(l,3));super(c,new bl({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}}class Rd extends Ll{constructor(t=10,e=16,i=8,n=64,r=4473924,o=8947848){r=new _r(r),o=new _r(o);const a=[],s=[];for(let i=0;i<=e;i++){const n=i/e*(2*Math.PI),l=Math.sin(n)*t,c=Math.cos(n)*t;a.push(0,0,0),a.push(l,0,c);const h=1&i?r:o;s.push(h.r,h.g,h.b),s.push(h.r,h.g,h.b)}for(let e=0;e<=i;e++){const l=1&e?r:o,c=t-t/i*e;for(let t=0;t<n;t++){let e=t/n*(2*Math.PI),i=Math.sin(e)*c,r=Math.cos(e)*c;a.push(i,0,r),s.push(l.r,l.g,l.b),e=(t+1)/n*(2*Math.PI),i=Math.sin(e)*c,r=Math.cos(e)*c,a.push(i,0,r),s.push(l.r,l.g,l.b)}}const l=new Wr;l.setAttribute("position",new kr(a,3)),l.setAttribute("color",new kr(s,3));super(l,new bl({vertexColors:!0,toneMapped:!1})),this.type="PolarGridHelper"}}const Dd=new $i,kd=new $i,Od=new $i;class zd extends $n{constructor(t,e,i){super(),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,void 0===e&&(e=1);let n=new Wr;n.setAttribute("position",new kr([-e,e,0,e,e,0,e,-e,0,-e,-e,0,-e,e,0],3));const r=new bl({fog:!1,toneMapped:!1});this.lightPlane=new Cl(n,r),this.add(this.lightPlane),n=new Wr,n.setAttribute("position",new kr([0,0,0,0,0,1],3)),this.targetLine=new Cl(n,r),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){Dd.setFromMatrixPosition(this.light.matrixWorld),kd.setFromMatrixPosition(this.light.target.matrixWorld),Od.subVectors(kd,Dd),this.lightPlane.lookAt(kd),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(kd),this.targetLine.scale.z=Od.length()}}const Bd=new $i,Fd=new _o;class Nd extends Ll{constructor(t){const e=new Wr,i=new bl({color:16777215,vertexColors:!0,toneMapped:!1}),n=[],r=[],o={},a=new _r(16755200),s=new _r(16711680),l=new _r(43775),c=new _r(16777215),h=new _r(3355443);function u(t,e,i){d(t,i),d(e,i)}function d(t,e){n.push(0,0,0),r.push(e.r,e.g,e.b),void 0===o[t]&&(o[t]=[]),o[t].push(n.length/3-1)}u("n1","n2",a),u("n2","n4",a),u("n4","n3",a),u("n3","n1",a),u("f1","f2",a),u("f2","f4",a),u("f4","f3",a),u("f3","f1",a),u("n1","f1",a),u("n2","f2",a),u("n3","f3",a),u("n4","f4",a),u("p","n1",s),u("p","n2",s),u("p","n3",s),u("p","n4",s),u("u1","u2",l),u("u2","u3",l),u("u3","u1",l),u("c","t",c),u("p","c",h),u("cn1","cn2",h),u("cn3","cn4",h),u("cf1","cf2",h),u("cf3","cf4",h),e.setAttribute("position",new kr(n,3)),e.setAttribute("color",new kr(r,3)),super(e,i),this.type="CameraHelper",this.camera=t,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=o,this.update()}update(){const t=this.geometry,e=this.pointMap;Fd.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),jd("c",e,t,Fd,0,0,-1),jd("t",e,t,Fd,0,0,1),jd("n1",e,t,Fd,-1,-1,-1),jd("n2",e,t,Fd,1,-1,-1),jd("n3",e,t,Fd,-1,1,-1),jd("n4",e,t,Fd,1,1,-1),jd("f1",e,t,Fd,-1,-1,1),jd("f2",e,t,Fd,1,-1,1),jd("f3",e,t,Fd,-1,1,1),jd("f4",e,t,Fd,1,1,1),jd("u1",e,t,Fd,.7,1.1,-1),jd("u2",e,t,Fd,-.7,1.1,-1),jd("u3",e,t,Fd,0,2,-1),jd("cf1",e,t,Fd,-1,0,1),jd("cf2",e,t,Fd,1,0,1),jd("cf3",e,t,Fd,0,-1,1),jd("cf4",e,t,Fd,0,1,1),jd("cn1",e,t,Fd,-1,0,-1),jd("cn2",e,t,Fd,1,0,-1),jd("cn3",e,t,Fd,0,-1,-1),jd("cn4",e,t,Fd,0,1,-1),t.getAttribute("position").needsUpdate=!0}}function jd(t,e,i,n,r,o,a){Bd.set(r,o,a).unproject(n);const s=e[t];if(void 0!==s){const t=i.getAttribute("position");for(let e=0,i=s.length;e<i;e++)t.setXYZ(s[e],Bd.x,Bd.y,Bd.z)}}const Gd=new Qi;class Ud extends Ll{constructor(t,e=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24),r=new Wr;r.setIndex(new Sr(i,1)),r.setAttribute("position",new Sr(n,3)),super(r,new bl({color:e,toneMapped:!1})),this.object=t,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(t){if(void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&Gd.setFromObject(this.object),Gd.isEmpty())return;const e=Gd.min,i=Gd.max,n=this.geometry.attributes.position,r=n.array;r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=e.x,r[4]=i.y,r[5]=i.z,r[6]=e.x,r[7]=e.y,r[8]=i.z,r[9]=i.x,r[10]=e.y,r[11]=i.z,r[12]=i.x,r[13]=i.y,r[14]=e.z,r[15]=e.x,r[16]=i.y,r[17]=e.z,r[18]=e.x,r[19]=e.y,r[20]=e.z,r[21]=i.x,r[22]=e.y,r[23]=e.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(t){return this.object=t,this.update(),this}copy(t){return Ll.prototype.copy.call(this,t),this.object=t.object,this}}class Vd extends Ll{constructor(t,e=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Wr;n.setIndex(new Sr(i,1)),n.setAttribute("position",new kr([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(n,new bl({color:e,toneMapped:!1})),this.box=t,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(t){const e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(t))}}class Hd extends Cl{constructor(t,e=1,i=16776960){const n=i,r=new Wr;r.setAttribute("position",new kr([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),r.computeBoundingSphere(),super(r,new bl({color:n,toneMapped:!1})),this.type="PlaneHelper",this.plane=t,this.size=e;const o=new Wr;o.setAttribute("position",new kr([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),o.computeBoundingSphere(),this.add(new ho(o,new wr({color:n,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(t){let e=-this.plane.constant;Math.abs(e)<1e-8&&(e=1e-8),this.scale.set(.5*this.size,.5*this.size,e),this.children[0].material.side=e<0?m:f,this.lookAt(this.plane.normal),super.updateMatrixWorld(t)}}const Zd=new $i;let Wd,qd;class Xd extends $n{constructor(t,e,i,n,r,o){super(),this.type="ArrowHelper",void 0===t&&(t=new $i(0,0,1)),void 0===e&&(e=new $i(0,0,0)),void 0===i&&(i=1),void 0===n&&(n=16776960),void 0===r&&(r=.2*i),void 0===o&&(o=.2*r),void 0===Wd&&(Wd=new Wr,Wd.setAttribute("position",new kr([0,0,0,0,1,0],3)),qd=new Hl(0,.5,1,5,1),qd.translate(0,-.5,0)),this.position.copy(e),this.line=new Cl(Wd,new bl({color:n,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new ho(qd,new wr({color:n,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(t),this.setLength(i,r,o)}setDirection(t){if(t.y>.99999)this.quaternion.set(0,0,0,1);else if(t.y<-.99999)this.quaternion.set(1,0,0,0);else{Zd.set(t.z,0,-t.x).normalize();const e=Math.acos(t.y);this.quaternion.setFromAxisAngle(Zd,e)}}setLength(t,e,i){void 0===e&&(e=.2*t),void 0===i&&(i=.2*e),this.line.scale.set(1,Math.max(1e-4,t-e),1),this.line.updateMatrix(),this.cone.scale.set(i,e,i),this.cone.position.y=t,this.cone.updateMatrix()}setColor(t){this.line.material.color.set(t),this.cone.material.color.set(t)}copy(t){return super.copy(t,!1),this.line.copy(t.line),this.cone.copy(t.cone),this}}class Yd extends Ll{constructor(t=1){const e=[0,0,0,t,0,0,0,0,0,0,t,0,0,0,0,0,0,t],i=new Wr;i.setAttribute("position",new kr(e,3)),i.setAttribute("color",new kr([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));super(i,new bl({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}}const $d=new Float32Array(1),Jd=new Int32Array($d.buffer),Kd={toHalfFloat:function(t){$d[0]=t;const e=Jd[0];let i=e>>16&32768,n=e>>12&2047;const r=e>>23&255;return r<103?i:r>142?(i|=31744,i|=(255==r?0:1)&&8388607&e,i):r<113?(n|=2048,i|=(n>>114-r)+(n>>113-r&1),i):(i|=r-112<<10|n>>1,i+=1&n,i)}},Qd=Math.pow(2,8),tp=[.125,.215,.35,.446,.526,.582],ep=5+tp.length,ip={[$e]:0,[Je]:1,[Qe]:2,[ei]:3,[ii]:4,[ni]:5,[Ke]:6},np=new wr({side:m,depthWrite:!1,depthTest:!1}),rp=new ho(new po,np),op=new nu,{_lodPlanes:ap,_sizeLods:sp,_sigmas:lp}=yp(),cp=new _r;let hp=null;const up=(1+Math.sqrt(5))/2,dp=1/up,pp=[new $i(1,1,1),new $i(-1,1,1),new $i(1,1,-1),new $i(-1,1,-1),new $i(0,up,dp),new $i(0,up,-dp),new $i(dp,0,up),new $i(-dp,0,up),new $i(up,dp,0),new $i(-up,dp,0)];function fp(t){const e=Math.max(t.r,t.g,t.b),i=Math.min(Math.max(Math.ceil(Math.log2(e)),-128),127);t.multiplyScalar(Math.pow(2,-i));return(i+128)/255}class mp{constructor(t){this._renderer=t,this._pingPongRenderTarget=null,this._blurMaterial=function(t){const e=new Float32Array(t),i=new $i(0,1,0);return new Hc({name:"SphericalGaussianBlur",defines:{n:t},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:e},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:i},inputEncoding:{value:ip[$e]},outputEncoding:{value:ip[$e]}},vertexShader:wp(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t${Mp()}\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:v,depthTest:!1,depthWrite:!1})}(20),this._equirectShader=null,this._cubemapShader=null,this._compileMaterial(this._blurMaterial)}fromScene(t,e=0,i=.1,n=100){hp=this._renderer.getRenderTarget();const r=this._allocateTargets();return this._sceneToCubeUV(t,i,n,r),e>0&&this._blur(r,0,0,e),this._applyPMREM(r),this._cleanup(r),r}fromEquirectangular(t){return this._fromTexture(t)}fromCubemap(t){return this._fromTexture(t)}compileCubemapShader(){null===this._cubemapShader&&(this._cubemapShader=bp(),this._compileMaterial(this._cubemapShader))}compileEquirectangularShader(){null===this._equirectShader&&(this._equirectShader=xp(),this._compileMaterial(this._equirectShader))}dispose(){this._blurMaterial.dispose(),null!==this._cubemapShader&&this._cubemapShader.dispose(),null!==this._equirectShader&&this._equirectShader.dispose();for(let t=0;t<ap.length;t++)ap[t].dispose()}_cleanup(t){this._pingPongRenderTarget.dispose(),this._renderer.setRenderTarget(hp),t.scissorTest=!1,vp(t,0,0,t.width,t.height)}_fromTexture(t){hp=this._renderer.getRenderTarget();const e=this._allocateTargets(t);return this._textureToCubeUV(t,e),this._applyPMREM(e),this._cleanup(e),e}_allocateTargets(t){const e={magFilter:ft,minFilter:ft,generateMipmaps:!1,type:Tt,format:Gt,encoding:gp(t)?t.encoding:Qe,depthBuffer:!1},i=_p(e);return i.depthBuffer=!t,this._pingPongRenderTarget=_p(e),i}_compileMaterial(t){const e=new ho(ap[0],t);this._renderer.compile(e,op)}_sceneToCubeUV(t,e,i,n){const r=new vo(90,1,e,i),o=[1,-1,1,1,1,1],a=[1,1,1,-1,-1,-1],s=this._renderer,l=s.autoClear,c=s.outputEncoding,h=s.toneMapping;s.getClearColor(cp),s.toneMapping=K,s.outputEncoding=$e,s.autoClear=!1;let u=!1;const d=t.background;if(d){if(d.isColor){np.color.copy(d).convertSRGBToLinear(),t.background=null;const e=fp(np.color);np.opacity=e,u=!0}}else{np.color.copy(cp).convertSRGBToLinear();const t=fp(np.color);np.opacity=t,u=!0}for(let e=0;e<6;e++){const i=e%3;0==i?(r.up.set(0,o[e],0),r.lookAt(a[e],0,0)):1==i?(r.up.set(0,0,o[e]),r.lookAt(0,a[e],0)):(r.up.set(0,o[e],0),r.lookAt(0,0,a[e])),vp(n,i*Qd,e>2?Qd:0,Qd,Qd),s.setRenderTarget(n),u&&s.render(rp,r),s.render(t,r)}s.toneMapping=h,s.outputEncoding=c,s.autoClear=l}_textureToCubeUV(t,e){const i=this._renderer;t.isCubeTexture?null==this._cubemapShader&&(this._cubemapShader=bp()):null==this._equirectShader&&(this._equirectShader=xp());const n=t.isCubeTexture?this._cubemapShader:this._equirectShader,r=new ho(ap[0],n),o=n.uniforms;o.envMap.value=t,t.isCubeTexture||o.texelSize.value.set(1/t.image.width,1/t.image.height),o.inputEncoding.value=ip[t.encoding],o.outputEncoding.value=ip[e.texture.encoding],vp(e,0,0,3*Qd,2*Qd),i.setRenderTarget(e),i.render(r,op)}_applyPMREM(t){const e=this._renderer,i=e.autoClear;e.autoClear=!1;for(let e=1;e<ep;e++){const i=Math.sqrt(lp[e]*lp[e]-lp[e-1]*lp[e-1]),n=pp[(e-1)%pp.length];this._blur(t,e-1,e,i,n)}e.autoClear=i}_blur(t,e,i,n,r){const o=this._pingPongRenderTarget;this._halfBlur(t,o,e,i,n,"latitudinal",r),this._halfBlur(o,t,i,i,n,"longitudinal",r)}_halfBlur(t,e,i,n,r,o,a){const s=this._renderer,l=this._blurMaterial;"latitudinal"!==o&&"longitudinal"!==o&&console.error("blur direction must be either latitudinal or longitudinal!");const c=new ho(ap[n],l),h=l.uniforms,u=sp[i]-1,d=isFinite(r)?Math.PI/(2*u):2*Math.PI/39,p=r/d,f=isFinite(r)?1+Math.floor(3*p):20;f>20&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${f} samples when the maximum is set to 20`);const m=[];let g=0;for(let t=0;t<20;++t){const e=t/p,i=Math.exp(-e*e/2);m.push(i),0==t?g+=i:t<f&&(g+=2*i)}for(let t=0;t<m.length;t++)m[t]=m[t]/g;h.envMap.value=t.texture,h.samples.value=f,h.weights.value=m,h.latitudinal.value="latitudinal"===o,a&&(h.poleAxis.value=a),h.dTheta.value=d,h.mipInt.value=8-i,h.inputEncoding.value=ip[t.texture.encoding],h.outputEncoding.value=ip[t.texture.encoding];const y=sp[n];vp(e,3*Math.max(0,Qd-2*y),(0===n?0:2*Qd)+2*y*(n>4?n-8+4:0),3*y,2*y),s.setRenderTarget(e),s.render(c,op)}}function gp(t){return void 0!==t&&t.type===Tt&&(t.encoding===$e||t.encoding===Je||t.encoding===Ke)}function yp(){const t=[],e=[],i=[];let n=8;for(let r=0;r<ep;r++){const o=Math.pow(2,n);e.push(o);let a=1/o;r>4?a=tp[r-8+4-1]:0==r&&(a=0),i.push(a);const s=1/(o-1),l=-s/2,c=1+s/2,h=[l,l,c,l,c,c,l,l,c,c,l,c],u=6,d=6,p=3,f=2,m=1,g=new Float32Array(p*d*u),y=new Float32Array(f*d*u),_=new Float32Array(m*d*u);for(let t=0;t<u;t++){const e=t%3*2/3-1,i=t>2?0:-1,n=[e,i,0,e+2/3,i,0,e+2/3,i+1,0,e,i,0,e+2/3,i+1,0,e,i+1,0];g.set(n,p*d*t),y.set(h,f*d*t);const r=[t,t,t,t,t,t];_.set(r,m*d*t)}const v=new Wr;v.setAttribute("position",new Sr(g,p)),v.setAttribute("uv",new Sr(y,f)),v.setAttribute("faceIndex",new Sr(_,m)),t.push(v),n>4&&n--}return{_lodPlanes:t,_sizeLods:e,_sigmas:i}}function _p(t){const e=new qi(3*Qd,3*Qd,t);return e.texture.mapping=ct,e.texture.name="PMREM.cubeUv",e.scissorTest=!0,e}function vp(t,e,i,n,r){t.viewport.set(e,i,n,r),t.scissor.set(e,i,n,r)}function xp(){return new Hc({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null},texelSize:{value:new Ni(1,1)},inputEncoding:{value:ip[$e]},outputEncoding:{value:ip[$e]}},vertexShader:wp(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform vec2 texelSize;\n\n\t\t\t${Mp()}\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tvec2 f = fract( uv / texelSize - 0.5 );\n\t\t\t\tuv -= f * texelSize;\n\t\t\t\tvec3 tl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.x += texelSize.x;\n\t\t\t\tvec3 tr = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.y += texelSize.y;\n\t\t\t\tvec3 br = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\t\t\t\tuv.x -= texelSize.x;\n\t\t\t\tvec3 bl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;\n\n\t\t\t\tvec3 tm = mix( tl, tr, f.x );\n\t\t\t\tvec3 bm = mix( bl, br, f.x );\n\t\t\t\tgl_FragColor.rgb = mix( tm, bm, f.y );\n\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:v,depthTest:!1,depthWrite:!1})}function bp(){return new Hc({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},inputEncoding:{value:ip[$e]},outputEncoding:{value:ip[$e]}},vertexShader:wp(),fragmentShader:`\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\t${Mp()}\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb = envMapTexelToLinear( textureCube( envMap, vec3( - vOutputDirection.x, vOutputDirection.yz ) ) ).rgb;\n\t\t\t\tgl_FragColor = linearToOutputTexel( gl_FragColor );\n\n\t\t\t}\n\t\t`,blending:v,depthTest:!1,depthWrite:!1})}function wp(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute vec3 position;\n\t\tattribute vec2 uv;\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function Mp(){return"\n\n\t\tuniform int inputEncoding;\n\t\tuniform int outputEncoding;\n\n\t\t#include <encodings_pars_fragment>\n\n\t\tvec4 inputTexelToLinear( vec4 value ) {\n\n\t\t\tif ( inputEncoding == 0 ) {\n\n\t\t\t\treturn value;\n\n\t\t\t} else if ( inputEncoding == 1 ) {\n\n\t\t\t\treturn sRGBToLinear( value );\n\n\t\t\t} else if ( inputEncoding == 2 ) {\n\n\t\t\t\treturn RGBEToLinear( value );\n\n\t\t\t} else if ( inputEncoding == 3 ) {\n\n\t\t\t\treturn RGBMToLinear( value, 7.0 );\n\n\t\t\t} else if ( inputEncoding == 4 ) {\n\n\t\t\t\treturn RGBMToLinear( value, 16.0 );\n\n\t\t\t} else if ( inputEncoding == 5 ) {\n\n\t\t\t\treturn RGBDToLinear( value, 256.0 );\n\n\t\t\t} else {\n\n\t\t\t\treturn GammaToLinear( value, 2.2 );\n\n\t\t\t}\n\n\t\t}\n\n\t\tvec4 linearToOutputTexel( vec4 value ) {\n\n\t\t\tif ( outputEncoding == 0 ) {\n\n\t\t\t\treturn value;\n\n\t\t\t} else if ( outputEncoding == 1 ) {\n\n\t\t\t\treturn LinearTosRGB( value );\n\n\t\t\t} else if ( outputEncoding == 2 ) {\n\n\t\t\t\treturn LinearToRGBE( value );\n\n\t\t\t} else if ( outputEncoding == 3 ) {\n\n\t\t\t\treturn LinearToRGBM( value, 7.0 );\n\n\t\t\t} else if ( outputEncoding == 4 ) {\n\n\t\t\t\treturn LinearToRGBM( value, 16.0 );\n\n\t\t\t} else if ( outputEncoding == 5 ) {\n\n\t\t\t\treturn LinearToRGBD( value, 256.0 );\n\n\t\t\t} else {\n\n\t\t\t\treturn LinearToGamma( value, 2.2 );\n\n\t\t\t}\n\n\t\t}\n\n\t\tvec4 envMapTexelToLinear( vec4 color ) {\n\n\t\t\treturn inputTexelToLinear( color );\n\n\t\t}\n\t"}function Tp(t,e,i,n,r,o,a){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new vr(t,e,i,r,o,a)}const Sp=0,Ep=1,Cp=0,Ap=1,Pp=2;function Lp(t){return console.warn("THREE.MeshFaceMaterial has been removed. Use an Array instead."),t}function Ip(t=[]){return console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),t.isMultiMaterial=!0,t.materials=t,t.clone=function(){return t.slice()},t}function Rp(t,e){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new Bl(t,e)}function Dp(t){return console.warn("THREE.Particle has been renamed to THREE.Sprite."),new el(t)}function kp(t,e){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new Bl(t,e)}function Op(t){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new Rl(t)}function zp(t){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new Rl(t)}function Bp(t){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new Rl(t)}function Fp(t,e,i){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new $i(t,e,i)}function Np(t,e){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setUsage( THREE.DynamicDrawUsage ) instead."),new Sr(t,e).setUsage(Si)}function jp(t,e){return console.warn("THREE.Int8Attribute has been removed. Use new THREE.Int8BufferAttribute() instead."),new Er(t,e)}function Gp(t,e){return console.warn("THREE.Uint8Attribute has been removed. Use new THREE.Uint8BufferAttribute() instead."),new Cr(t,e)}function Up(t,e){return console.warn("THREE.Uint8ClampedAttribute has been removed. Use new THREE.Uint8ClampedBufferAttribute() instead."),new Ar(t,e)}function Vp(t,e){return console.warn("THREE.Int16Attribute has been removed. Use new THREE.Int16BufferAttribute() instead."),new Pr(t,e)}function Hp(t,e){return console.warn("THREE.Uint16Attribute has been removed. Use new THREE.Uint16BufferAttribute() instead."),new Lr(t,e)}function Zp(t,e){return console.warn("THREE.Int32Attribute has been removed. Use new THREE.Int32BufferAttribute() instead."),new Ir(t,e)}function Wp(t,e){return console.warn("THREE.Uint32Attribute has been removed. Use new THREE.Uint32BufferAttribute() instead."),new Rr(t,e)}function qp(t,e){return console.warn("THREE.Float32Attribute has been removed. Use new THREE.Float32BufferAttribute() instead."),new kr(t,e)}function Xp(t,e){return console.warn("THREE.Float64Attribute has been removed. Use new THREE.Float64BufferAttribute() instead."),new Or(t,e)}function Yp(t){console.warn("THREE.ClosedSplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),Oh.call(this,t),this.type="catmullrom",this.closed=!0}function $p(t){console.warn("THREE.SplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),Oh.call(this,t),this.type="catmullrom"}function Jp(t){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),Oh.call(this,t),this.type="catmullrom"}function Kp(t){return console.warn("THREE.AxisHelper has been renamed to THREE.AxesHelper."),new Yd(t)}function Qp(t,e){return console.warn("THREE.BoundingBoxHelper has been deprecated. Creating a THREE.BoxHelper instead."),new Ud(t,e)}function tf(t,e){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new Ll(new Kl(t.geometry),new bl({color:void 0!==e?e:16777215}))}function ef(t,e){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new Ll(new Gc(t.geometry),new bl({color:void 0!==e?e:16777215}))}function nf(t){return console.warn("THREE.XHRLoader has been renamed to THREE.FileLoader."),new xh(t)}function rf(t){return console.warn("THREE.BinaryTextureLoader has been renamed to THREE.DataTextureLoader."),new Sh(t)}function of(t,e,i){return console.warn("THREE.WebGLRenderTargetCube( width, height, options ) is now WebGLCubeRenderTarget( size, options )."),new wo(t,i)}Ch.create=function(t,e){return console.log("THREE.Curve.create() has been deprecated"),t.prototype=Object.create(Ch.prototype),t.prototype.constructor=t,t.prototype.getPoint=e,t},Object.assign(Xh.prototype,{fromPoints:function(t){return console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(t)}}),Yp.prototype=Object.create(Oh.prototype),$p.prototype=Object.create(Oh.prototype),Jp.prototype=Object.create(Oh.prototype),Object.assign(Jp.prototype,{initFromArray:function(){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}}),Id.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},Sd.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")},Object.assign(_h.prototype,{extractUrlBase:function(t){return console.warn("THREE.Loader: .extractUrlBase() has been deprecated. Use THREE.LoaderUtils.extractUrlBase() instead."),uu.extractUrlBase(t)}}),_h.Handlers={add:function(){console.error("THREE.Loader: Handlers.add() has been removed. Use LoadingManager.addHandler() instead.")},get:function(){console.error("THREE.Loader: Handlers.get() has been removed. Use LoadingManager.getHandler() instead.")}},Object.assign(md.prototype,{center:function(t){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(t)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(t){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},size:function(t){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(t)}}),Object.assign(Qi.prototype,{center:function(t){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(t)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(t){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},isIntersectionSphere:function(t){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(t)},size:function(t){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(t)}}),Object.assign(gn.prototype,{empty:function(){return console.warn("THREE.Sphere: .empty() has been renamed to .isEmpty()."),this.isEmpty()}}),Eo.prototype.setFromMatrix=function(t){return console.warn("THREE.Frustum: .setFromMatrix() has been renamed to .setFromProjectionMatrix()."),this.setFromProjectionMatrix(t)},_d.prototype.center=function(t){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(t)},Object.assign(Fi,{random16:function(){return console.warn("THREE.Math: .random16() has been deprecated. Use Math.random() instead."),Math.random()},nearestPowerOfTwo:function(t){return console.warn("THREE.Math: .nearestPowerOfTwo() has been renamed to .floorPowerOfTwo()."),Fi.floorPowerOfTwo(t)},nextPowerOfTwo:function(t){return console.warn("THREE.Math: .nextPowerOfTwo() has been renamed to .ceilPowerOfTwo()."),Fi.ceilPowerOfTwo(t)}}),Object.assign(ji.prototype,{flattenToArrayOffset:function(t,e){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(t,e)},multiplyVector3:function(t){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),t.applyMatrix3(this)},multiplyVector3Array:function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},applyToBufferAttribute:function(t){return console.warn("THREE.Matrix3: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix3( matrix ) instead."),t.applyMatrix3(this)},applyToVector3Array:function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")},getInverse:function(t){return console.warn("THREE.Matrix3: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(t).invert()}}),Object.assign(Sn.prototype,{extractPosition:function(t){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(t)},flattenToArrayOffset:function(t,e){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(t,e)},getPosition:function(){return console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),(new $i).setFromMatrixColumn(this,3)},setRotationFromQuaternion:function(t){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(t)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(t){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector4:function(t){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector3Array:function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},rotateAxis:function(t){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),t.transformDirection(this)},crossVector:function(t){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBufferAttribute:function(t){return console.warn("THREE.Matrix4: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},applyToVector3Array:function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(t,e,i,n,r,o){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(t,e,n,i,r,o)},getInverse:function(t){return console.warn("THREE.Matrix4: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(t).invert()}}),tr.prototype.isIntersectionLine=function(t){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(t)},Object.assign(Yi.prototype,{multiplyVector3:function(t){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),t.applyQuaternion(this)},inverse:function(){return console.warn("THREE.Quaternion: .inverse() has been renamed to invert()."),this.invert()}}),Object.assign(Tn.prototype,{isIntersectionBox:function(t){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},isIntersectionPlane:function(t){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(t)},isIntersectionSphere:function(t){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(t)}}),Object.assign(ur.prototype,{area:function(){return console.warn("THREE.Triangle: .area() has been renamed to .getArea()."),this.getArea()},barycoordFromPoint:function(t,e){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),this.getBarycoord(t,e)},midpoint:function(t){return console.warn("THREE.Triangle: .midpoint() has been renamed to .getMidpoint()."),this.getMidpoint(t)},normal:function(t){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),this.getNormal(t)},plane:function(t){return console.warn("THREE.Triangle: .plane() has been renamed to .getPlane()."),this.getPlane(t)}}),Object.assign(ur,{barycoordFromPoint:function(t,e,i,n,r){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),ur.getBarycoord(t,e,i,n,r)},normal:function(t,e,i,n){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),ur.getNormal(t,e,i,n)}}),Object.assign(Yh.prototype,{extractAllPoints:function(t){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(t)},extrude:function(t){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new Cc(this,t)},makeGeometry:function(t){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new kc(this,t)}}),Object.assign(Ni.prototype,{fromAttribute:function(t,e,i){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,i)},distanceToManhattan:function(t){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(t)},lengthManhattan:function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign($i.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(t){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(t)},getScaleFromMatrix:function(t){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(t)},getColumnFromMatrix:function(t,e){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(e,t)},applyProjection:function(t){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(t)},fromAttribute:function(t,e,i){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,i)},distanceToManhattan:function(t){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(t)},lengthManhattan:function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(Wi.prototype,{fromAttribute:function(t,e,i){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,i)},lengthManhattan:function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign($n.prototype,{getChildByName:function(t){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(t)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(t,e){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(e,t)},getWorldRotation:function(){console.error("THREE.Object3D: .getWorldRotation() has been removed. Use THREE.Object3D.getWorldQuaternion( target ) instead.")},applyMatrix:function(t){return console.warn("THREE.Object3D: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(t)}}),Object.defineProperties($n.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(t){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=t}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.assign(ho.prototype,{setDrawMode:function(){console.error("THREE.Mesh: .setDrawMode() has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}),Object.defineProperties(ho.prototype,{drawMode:{get:function(){return console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode."),qe},set:function(){console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}}),Object.defineProperties(ol.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(ml.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),ul.prototype.initBones=function(){console.error("THREE.SkinnedMesh: initBones() has been removed.")},Object.defineProperty(Ch.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(t){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=t}}),vo.prototype.setLens=function(t,e){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==e&&(this.filmGauge=e),this.setFocalLength(t)},Object.defineProperties($h.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(t){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=t}},shadowCameraLeft:{set:function(t){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=t}},shadowCameraRight:{set:function(t){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=t}},shadowCameraTop:{set:function(t){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=t}},shadowCameraBottom:{set:function(t){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=t}},shadowCameraNear:{set:function(t){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=t}},shadowCameraFar:{set:function(t){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=t}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(t){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=t}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(t){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=t}},shadowMapHeight:{set:function(t){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=t}}}),Object.defineProperties(Sr.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}},dynamic:{get:function(){return console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.usage===Si},set:function(){console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.setUsage(Si)}}}),Object.assign(Sr.prototype,{setDynamic:function(t){return console.warn("THREE.BufferAttribute: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(!0===t?Si:Ti),this},copyIndicesArray:function(){console.error("THREE.BufferAttribute: .copyIndicesArray() has been removed.")},setArray:function(){console.error("THREE.BufferAttribute: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")}}),Object.assign(Wr.prototype,{addIndex:function(t){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(t)},addAttribute:function(t,e){return console.warn("THREE.BufferGeometry: .addAttribute() has been renamed to .setAttribute()."),e&&e.isBufferAttribute||e&&e.isInterleavedBufferAttribute?"index"===t?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(e),this):this.setAttribute(t,e):(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.setAttribute(t,new Sr(arguments[1],arguments[2])))},addDrawCall:function(t,e,i){void 0!==i&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(t,e)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")},removeAttribute:function(t){return console.warn("THREE.BufferGeometry: .removeAttribute() has been renamed to .deleteAttribute()."),this.deleteAttribute(t)},applyMatrix:function(t){return console.warn("THREE.BufferGeometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(t)}}),Object.defineProperties(Wr.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(du.prototype,{maxInstancedCount:{get:function(){return console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount},set:function(t){console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount=t}}}),Object.defineProperties(cd.prototype,{linePrecision:{get:function(){return console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold},set:function(t){console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold=t}}}),Object.defineProperties(Fs.prototype,{dynamic:{get:function(){return console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.usage===Si},set:function(t){console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.setUsage(t)}}}),Object.assign(Fs.prototype,{setDynamic:function(t){return console.warn("THREE.InterleavedBuffer: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(!0===t?Si:Ti),this},setArray:function(){console.error("THREE.InterleavedBuffer: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")}}),Object.assign(Cc.prototype,{getArrays:function(){console.error("THREE.ExtrudeGeometry: .getArrays() has been removed.")},addShapeList:function(){console.error("THREE.ExtrudeGeometry: .addShapeList() has been removed.")},addShape:function(){console.error("THREE.ExtrudeGeometry: .addShape() has been removed.")}}),Object.assign(Bs.prototype,{dispose:function(){console.error("THREE.Scene: .dispose() has been removed.")}}),Object.defineProperties(ad.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(br.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},overdraw:{get:function(){console.warn("THREE.Material: .overdraw has been removed.")},set:function(){console.warn("THREE.Material: .overdraw has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new _r}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(t){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=t===y}},stencilMask:{get:function(){return console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask},set:function(t){console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask=t}}}),Object.defineProperties(qc.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(Wc.prototype,{transparency:{get:function(){return console.warn("THREE.MeshPhysicalMaterial: .transparency has been renamed to .transmission."),this.transmission},set:function(t){console.warn("THREE.MeshPhysicalMaterial: .transparency has been renamed to .transmission."),this.transmission=t}}}),Object.defineProperties(yo.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(t){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=t}}}),Object.assign(Ds.prototype,{clearTarget:function(t,e,i,n){console.warn("THREE.WebGLRenderer: .clearTarget() has been deprecated. Use .setRenderTarget() and .clear() instead."),this.setRenderTarget(t),this.clear(e,i,n)},animate:function(t){console.warn("THREE.WebGLRenderer: .animate() is now .setAnimationLoop()."),this.setAnimationLoop(t)},getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},getMaxAnisotropy:function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},getPrecision:function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},resetGLState:function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(t){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(t)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")},setFaceCulling:function(){console.warn("THREE.WebGLRenderer: .setFaceCulling() has been removed.")},allocTextureUnit:function(){console.warn("THREE.WebGLRenderer: .allocTextureUnit() has been removed.")},setTexture:function(){console.warn("THREE.WebGLRenderer: .setTexture() has been removed.")},setTexture2D:function(){console.warn("THREE.WebGLRenderer: .setTexture2D() has been removed.")},setTextureCube:function(){console.warn("THREE.WebGLRenderer: .setTextureCube() has been removed.")},getActiveMipMapLevel:function(){return console.warn("THREE.WebGLRenderer: .getActiveMipMapLevel() is now .getActiveMipmapLevel()."),this.getActiveMipmapLevel()}}),Object.defineProperties(Ds.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(t){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=t}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(t){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=t}},shadowMapCullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")}},context:{get:function(){return console.warn("THREE.WebGLRenderer: .context has been removed. Use .getContext() instead."),this.getContext()}},vr:{get:function(){return console.warn("THREE.WebGLRenderer: .vr has been renamed to .xr"),this.xr}},gammaInput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead."),!1},set:function(){console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),!1},set:function(t){console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),this.outputEncoding=!0===t?Je:$e}},toneMappingWhitePoint:{get:function(){return console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed."),1},set:function(){console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed.")}}}),Object.defineProperties(Ts.prototype,{cullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")}},renderReverseSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")}},renderSingleSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")}}}),Object.defineProperties(qi.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(t){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=t}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(t){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=t}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(t){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=t}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(t){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=t}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(t){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=t}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(t){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=t}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(t){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=t}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(t){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=t}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(t){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=t}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(t){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=t}}}),Object.defineProperties(Nu.prototype,{load:{value:function(t){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");const e=this;return(new Eu).load(t,(function(t){e.setBuffer(t)})),this}},startTime:{set:function(){console.warn("THREE.Audio: .startTime is now .play( delay ).")}}}),Zu.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()},xo.prototype.updateCubeMap=function(t,e){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(t,e)},xo.prototype.clear=function(t,e,i,n){return console.warn("THREE.CubeCamera: .clear() is now .renderTarget.clear()."),this.renderTarget.clear(t,e,i,n)};const af={merge:function(t,e,i){let n;console.warn("THREE.GeometryUtils: .merge() has been moved to Geometry. Use geometry.merge( geometry2, matrix, materialIndexOffset ) instead."),e.isMesh&&(e.matrixAutoUpdate&&e.updateMatrix(),n=e.matrix,e=e.geometry),t.merge(e,n,i)},center:function(t){return console.warn("THREE.GeometryUtils: .center() has been moved to Geometry. Use geometry.center() instead."),t.center()}};function sf(){console.error("THREE.CanvasRenderer has been removed")}function lf(){console.error("THREE.JSONLoader has been removed.")}Ui.crossOrigin=void 0,Ui.loadTexture=function(t,e,i,n){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");const r=new Eh;r.setCrossOrigin(this.crossOrigin);const o=r.load(t,i,void 0,n);return e&&(o.mapping=e),o},Ui.loadTextureCube=function(t,e,i,n){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");const r=new Th;r.setCrossOrigin(this.crossOrigin);const o=r.load(t,i,void 0,n);return e&&(o.mapping=e),o},Ui.loadCompressedTexture=function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},Ui.loadCompressedTextureCube=function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")};const cf={createMultiMaterialObject:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")},detach:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")},attach:function(){console.error("THREE.SceneUtils has been moved to /examples/jsm/utils/SceneUtils.js")}};function hf(){console.error("THREE.LensFlare has been moved to /examples/jsm/objects/Lensflare.js")}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:n}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=n)},function(t,e,i){"use strict";(function(e){t.exports=function(){if("object"==typeof globalThis)return globalThis;var t;try{t=this||new Function("return this")()}catch(t){if("object"==typeof window)return window;if("object"==typeof self)return self;if(void 0!==e)return e}return t}()}).call(this,i(17))},function(t,e,i){(function(t){var n=void 0!==t&&t||"undefined"!=typeof self&&self||window,r=Function.prototype.apply;function o(t,e){this._id=t,this._clearFn=e}e.setTimeout=function(){return new o(r.call(setTimeout,n,arguments),clearTimeout)},e.setInterval=function(){return new o(r.call(setInterval,n,arguments),clearInterval)},e.clearTimeout=e.clearInterval=function(t){t&&t.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(n,this._id)},e.enroll=function(t,e){clearTimeout(t._idleTimeoutId),t._idleTimeout=e},e.unenroll=function(t){clearTimeout(t._idleTimeoutId),t._idleTimeout=-1},e._unrefActive=e.active=function(t){clearTimeout(t._idleTimeoutId);var e=t._idleTimeout;e>=0&&(t._idleTimeoutId=setTimeout((function(){t._onTimeout&&t._onTimeout()}),e))},i(29),e.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==t&&t.setImmediate||this&&this.setImmediate,e.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==t&&t.clearImmediate||this&&this.clearImmediate}).call(this,i(17))},function(t,e,i){(function(t,e){!function(t,i){"use strict";if(!t.setImmediate){var n,r,o,a,s,l=1,c={},h=!1,u=t.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(t);d=d&&d.setTimeout?d:t,"[object process]"==={}.toString.call(t.process)?n=function(t){e.nextTick((function(){f(t)}))}:!function(){if(t.postMessage&&!t.importScripts){var e=!0,i=t.onmessage;return t.onmessage=function(){e=!1},t.postMessage("","*"),t.onmessage=i,e}}()?t.MessageChannel?((o=new MessageChannel).port1.onmessage=function(t){f(t.data)},n=function(t){o.port2.postMessage(t)}):u&&"onreadystatechange"in u.createElement("script")?(r=u.documentElement,n=function(t){var e=u.createElement("script");e.onreadystatechange=function(){f(t),e.onreadystatechange=null,r.removeChild(e),e=null},r.appendChild(e)}):n=function(t){setTimeout(f,0,t)}:(a="setImmediate$"+Math.random()+"$",s=function(e){e.source===t&&"string"==typeof e.data&&0===e.data.indexOf(a)&&f(+e.data.slice(a.length))},t.addEventListener?t.addEventListener("message",s,!1):t.attachEvent("onmessage",s),n=function(e){t.postMessage(a+e,"*")}),d.setImmediate=function(t){"function"!=typeof t&&(t=new Function(""+t));for(var e=new Array(arguments.length-1),i=0;i<e.length;i++)e[i]=arguments[i+1];var r={callback:t,args:e};return c[l]=r,n(l),l++},d.clearImmediate=p}function p(t){delete c[t]}function f(t){if(h)setTimeout(f,0,t);else{var e=c[t];if(e){h=!0;try{!function(t){var e=t.callback,i=t.args;switch(i.length){case 0:e();break;case 1:e(i[0]);break;case 2:e(i[0],i[1]);break;case 3:e(i[0],i[1],i[2]);break;default:e.apply(void 0,i)}}(e)}finally{p(t),h=!1}}}}}("undefined"==typeof self?void 0===t?this:t:self)}).call(this,i(17),i(20))},function(t,e,i){"use strict";i.r(e),i.d(e,"default",(function(){return Ra}));var n={};i.r(n),i.d(n,"reversed",(function(){return lt})),i.d(n,"mirrored",(function(){return ct})),i.d(n,"createReversedEasing",(function(){return ht})),i.d(n,"createMirroredEasing",(function(){return ut})),i.d(n,"createExpoIn",(function(){return dt})),i.d(n,"createBackIn",(function(){return pt})),i.d(n,"createAnticipateEasing",(function(){return ft})),i.d(n,"linear",(function(){return mt})),i.d(n,"easeIn",(function(){return gt})),i.d(n,"easeOut",(function(){return yt})),i.d(n,"easeInOut",(function(){return _t})),i.d(n,"circIn",(function(){return vt})),i.d(n,"circOut",(function(){return xt})),i.d(n,"circInOut",(function(){return bt})),i.d(n,"backIn",(function(){return wt})),i.d(n,"backOut",(function(){return Mt})),i.d(n,"backInOut",(function(){return Tt})),i.d(n,"anticipate",(function(){return St})),i.d(n,"bounceOut",(function(){return Et})),i.d(n,"bounceIn",(function(){return Ct})),i.d(n,"bounceInOut",(function(){return At})),i.d(n,"cubicBezier",(function(){return Ot}));var r=i(4),o=i(15);function a(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=Object(o.a)(t))){var e=0,i=function(){};return{s:i,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r,a=!0,s=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,r=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw r}}}}var s=i(5),l=i(6),c=i(10),h=i(9),u=i(12),d=i.n(u),p=i(13),f=i(2),m=function(t,e){return(m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function g(t,e){function i(){this.constructor=t}m(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var y=function(){return(y=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function v(t,e){var i={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(t,n[r])&&(i[n[r]]=t[n[r]])}return i}function x(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),r=0;for(e=0;e<i;e++)for(var o=arguments[e],a=0,s=o.length;a<s;a++,r++)n[r]=o[a];return n}var b=function(t,e){return function(i){return Math.max(Math.min(i,e),t)}},w=function(t){return t%1?Number(t.toFixed(5)):t},M=/(-)?(\d[\d\.]*)/g,T=/(#[0-9a-f]{6}|#[0-9a-f]{3}|#(?:[0-9a-f]{2}){2,4}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2,3}\s*\/*\s*[\d\.]+%?\))/gi,S=/^(#[0-9a-f]{3}|#(?:[0-9a-f]{2}){2,4}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2,3}\s*\/*\s*[\d\.]+%?\))$/i,E={test:function(t){return"number"==typeof t},parse:parseFloat,transform:function(t){return t}},C=y(y({},E),{transform:b(0,1)}),A=(y(y({},E),{default:1}),function(t){return{test:function(e){return"string"==typeof e&&e.endsWith(t)&&1===e.split(" ").length},parse:parseFloat,transform:function(e){return""+e+t}}}),P=A("deg"),L=A("%"),I=A("px"),R=A("vh"),D=A("vw"),k=(y(y({},L),{parse:function(t){return L.parse(t)/100},transform:function(t){return L.transform(100*t)}}),b(0,255)),O=function(t){return void 0!==t.red},z=function(t){return void 0!==t.hue};var B=function(t){return function(e){if("string"!=typeof e)return e;for(var i={},n=function(t){return t.substring(t.indexOf("(")+1,t.lastIndexOf(")"))}(e).replace(/(,|\/)/g," ").split(/ \s*/),r=0;r<4;r++)i[t[r]]=void 0!==n[r]?parseFloat(n[r]):1;return i}},F=y(y({},E),{transform:function(t){return Math.round(k(t))}});function N(t,e){return t.startsWith(e)&&S.test(t)}var j={test:function(t){return"string"==typeof t?N(t,"rgb"):O(t)},parse:B(["red","green","blue","alpha"]),transform:function(t){var e=t.red,i=t.green,n=t.blue,r=t.alpha,o=void 0===r?1:r;return function(t){var e=t.red,i=t.green,n=t.blue,r=t.alpha;return"rgba("+e+", "+i+", "+n+", "+(void 0===r?1:r)+")"}({red:F.transform(e),green:F.transform(i),blue:F.transform(n),alpha:w(C.transform(o))})}},G={test:function(t){return"string"==typeof t?N(t,"hsl"):z(t)},parse:B(["hue","saturation","lightness","alpha"]),transform:function(t){var e=t.hue,i=t.saturation,n=t.lightness,r=t.alpha,o=void 0===r?1:r;return function(t){var e=t.hue,i=t.saturation,n=t.lightness,r=t.alpha;return"hsla("+e+", "+i+", "+n+", "+(void 0===r?1:r)+")"}({hue:Math.round(e),saturation:L.transform(w(i)),lightness:L.transform(w(n)),alpha:w(C.transform(o))})}},U=y(y({},j),{test:function(t){return"string"==typeof t&&N(t,"#")},parse:function(t){var e="",i="",n="";return t.length>4?(e=t.substr(1,2),i=t.substr(3,2),n=t.substr(5,2)):(e=t.substr(1,1),i=t.substr(2,1),n=t.substr(3,1),e+=e,i+=i,n+=n),{red:parseInt(e,16),green:parseInt(i,16),blue:parseInt(n,16),alpha:1}}}),V={test:function(t){return"string"==typeof t&&S.test(t)||O(t)||z(t)},parse:function(t){return j.test(t)?j.parse(t):G.test(t)?G.parse(t):U.test(t)?U.parse(t):t},transform:function(t){return O(t)?j.transform(t):z(t)?G.transform(t):t}},H=function(t){return"number"==typeof t?0:t},Z={test:function(t){if("string"!=typeof t||!isNaN(t))return!1;var e=0,i=t.match(M),n=t.match(T);return i&&(e+=i.length),n&&(e+=n.length),e>0},parse:function(t){var e=t,i=[],n=e.match(T);n&&(e=e.replace(T,"${c}"),i.push.apply(i,n.map(V.parse)));var r=e.match(M);return r&&i.push.apply(i,r.map(E.parse)),i},createTransformer:function(t){var e=t,i=0,n=t.match(T),r=n?n.length:0;if(n)for(var o=0;o<r;o++)e=e.replace(n[o],"${c}"),i++;var a=e.match(M),s=a?a.length:0;if(a)for(o=0;o<s;o++)e=e.replace(a[o],"${n}"),i++;return function(t){for(var n=e,o=0;o<i;o++)n=n.replace(o<r?"${c}":"${n}",o<r?V.transform(t[o]):w(t[o]));return n}},getAnimatableNone:function(t){var e=Z.parse(t);return Z.createTransformer(t)(e.map(H))}};var W=0,q="undefined"!=typeof window&&void 0!==window.requestAnimationFrame?function(t){return window.requestAnimationFrame(t)}:function(t){var e=Date.now(),i=Math.max(0,16.7-(e-W));W=e+i,setTimeout((function(){return t(W)}),i)},X=1/60*1e3,Y=!0,$=!1,J=!1,K={delta:0,timestamp:0},Q=["read","update","preRender","render","postRender"],tt=function(t){return $=t},et=Q.reduce((function(t,e){var i,n,r,o,a,s,l,c,h;return t[e]=(i=tt,n=[],r=[],o=0,a=!1,s=0,l=new WeakSet,c=new WeakSet,h={cancel:function(t){var e=r.indexOf(t);l.add(t),-1!==e&&r.splice(e,1)},process:function(t){var e,u;if(a=!0,n=(e=[r,n])[0],(r=e[1]).length=0,o=n.length)for(s=0;s<o;s++)(u=n[s])(t),!0!==c.has(u)||l.has(u)||(h.schedule(u),i(!0));a=!1},schedule:function(t,e,i){void 0===e&&(e=!1),void 0===i&&(i=!1);var s=i&&a,h=s?n:r;l.delete(t),e&&c.add(t),-1===h.indexOf(t)&&(h.push(t),s&&(o=n.length))}}),t}),{}),it=Q.reduce((function(t,e){var i=et[e];return t[e]=function(t,e,n){return void 0===e&&(e=!1),void 0===n&&(n=!1),$||at(),i.schedule(t,e,n),t},t}),{}),nt=Q.reduce((function(t,e){return t[e]=et[e].cancel,t}),{}),rt=function(t){return et[t].process(K)},ot=function(t){$=!1,K.delta=Y?X:Math.max(Math.min(t-K.timestamp,40),1),Y||(X=K.delta),K.timestamp=t,J=!0,Q.forEach(rt),J=!1,$&&(Y=!1,q(ot))},at=function(){$=!0,Y=!0,J||q(ot)},st=it,lt=function(t){return function(e){return 1-t(1-e)}},ct=function(t){return function(e){return e<=.5?t(2*e)/2:(2-t(2*(1-e)))/2}},ht=lt,ut=ct,dt=function(t){return function(e){return Math.pow(e,t)}},pt=function(t){return function(e){return e*e*((t+1)*e-t)}},ft=function(t){var e=pt(t);return function(t){return(t*=2)<1?.5*e(t):.5*(2-Math.pow(2,-10*(t-1)))}},mt=function(t){return t},gt=dt(2),yt=lt(gt),_t=ct(gt),vt=function(t){return 1-Math.sin(Math.acos(t))},xt=lt(vt),bt=ct(xt),wt=pt(1.525),Mt=lt(wt),Tt=ct(wt),St=ft(1.525),Et=function(t){var e=t*t;return t<4/11?7.5625*e:t<8/11?9.075*e-9.9*t+3.4:t<.9?4356/361*e-35442/1805*t+16061/1805:10.8*t*t-20.52*t+10.72},Ct=function(t){return 1-Et(1-t)},At=function(t){return t<.5?.5*(1-Et(1-2*t)):.5*Et(2*t-1)+.5},Pt="undefined"!=typeof Float32Array,Lt=function(t,e){return 1-3*e+3*t},It=function(t,e){return 3*e-6*t},Rt=function(t){return 3*t},Dt=function(t,e,i){return 3*Lt(e,i)*t*t+2*It(e,i)*t+Rt(e)},kt=function(t,e,i){return((Lt(e,i)*t+It(e,i))*t+Rt(e))*t};function Ot(t,e,i,n){var r=Pt?new Float32Array(11):new Array(11),o=function(e){for(var n,o,a,s=0,l=1;10!==l&&r[l]<=e;++l)s+=.1;return--l,n=(e-r[l])/(r[l+1]-r[l]),(a=Dt(o=s+.1*n,t,i))>=.001?function(e,n){for(var r=0,o=0;r<8;++r){if(0===(o=Dt(n,t,i)))return n;n-=(kt(n,t,i)-e)/o}return n}(e,o):0===a?o:function(e,n,r){var o,a,s=0;do{(o=kt(a=n+(r-n)/2,t,i)-e)>0?r=a:n=a}while(Math.abs(o)>1e-7&&++s<10);return a}(e,s,s+.1)};!function(){for(var e=0;e<11;++e)r[e]=kt(.1*e,t,i)}();return function(r){return t===e&&i===n?r:0===r?0:1===r?1:kt(o(r),e,n)}}var zt=function(t){return"number"==typeof t},Bt=function(t){return function(e,i,n){return void 0!==n?t(e,i,n):function(n){return t(e,i,n)}}},Ft=Bt((function(t,e,i){return Math.min(Math.max(i,t),e)})),Nt=function(t,e,i){var n=e-t;return 0===n?1:(i-t)/n},jt=function(t,e,i){return-i*t+i*e+t},Gt=function(){return(Gt=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},Ut=function(t,e,i){var n=t*t,r=e*e;return Math.sqrt(Math.max(0,i*(r-n)+n))},Vt=[U,j,G],Ht=function(t){return Vt.find((function(e){return e.test(t)}))},Zt=function(t){return"'"+t+"' is not an animatable color. Use the equivalent color code instead."},Wt=function(t,e){var i=Ht(t),n=Ht(e);Zt(t),Zt(e),i.transform,n.transform;var r=i.parse(t),o=n.parse(e),a=Gt({},r),s=i===G?jt:Ut;return function(t){for(var e in a)"alpha"!==e&&(a[e]=s(r[e],o[e],t));return a.alpha=jt(r.alpha,o.alpha,t),i.transform(a)}},qt=function(t,e){return function(i){return e(t(i))}},Xt=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t.reduce(qt)};function Yt(t,e){return zt(t)?function(i){return jt(t,e,i)}:V.test(t)?Wt(t,e):Kt(t,e)}var $t=function(t,e){var i=t.slice(),n=i.length,r=t.map((function(t,i){return Yt(t,e[i])}));return function(t){for(var e=0;e<n;e++)i[e]=r[e](t);return i}};function Jt(t){for(var e=Z.parse(t),i=e.length,n=0,r=0,o=0,a=0;a<i;a++)n||"number"==typeof e[a]?n++:void 0!==e[a].hue?o++:r++;return{parsed:e,numNumbers:n,numRGB:r,numHSL:o}}var Kt=function(t,e){var i=Z.createTransformer(e),n=Jt(t),r=Jt(e);return n.numHSL===r.numHSL&&n.numRGB===r.numRGB&&(n.numNumbers,r.numNumbers),Xt($t(n.parsed,r.parsed),i)};var Qt=function(t){return t},te=function(t){return void 0===t&&(t=Qt),Bt((function(e,i,n){var r=i-n,o=-(0-e+1)*(0-t(Math.abs(r)));return r<=0?i+o:i-o}))};te(),te(Math.sqrt),Bt((function(t,e,i){var n=e-t;return((i-t)%n+n)%n+t})),Ft(0,1);Math.round;var ee=function(){function t(t){void 0===t&&(t={}),this.props=t}return t.prototype.applyMiddleware=function(t){return this.create(y(y({},this.props),{middleware:this.props.middleware?x([t],this.props.middleware):[t]}))},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=1===t.length?t[0]:Xt.apply(void 0,t);return this.applyMiddleware((function(t){return function(e){return t(i(e))}}))},t.prototype.while=function(t){return this.applyMiddleware((function(e,i){return function(n){return t(n)?e(n):i()}}))},t.prototype.filter=function(t){return this.applyMiddleware((function(e){return function(i){return t(i)&&e(i)}}))},t}(),ie=function(){return function(t,e){var i=this,n=t.middleware,r=t.onComplete;this.isActive=!0,this.update=function(t){i.observer.update&&i.updateObserver(t)},this.complete=function(){i.observer.complete&&i.isActive&&i.observer.complete(),i.onComplete&&i.onComplete(),i.isActive=!1},this.error=function(t){i.observer.error&&i.isActive&&i.observer.error(t),i.isActive=!1},this.observer=e,this.updateObserver=function(t){return e.update(t)},this.onComplete=r,e.update&&n&&n.length&&n.forEach((function(t){return i.updateObserver=t(i.updateObserver,i.complete)}))}}(),ne=function(t,e,i){var n=e.middleware;return new ie({middleware:n,onComplete:i},"function"==typeof t?{update:t}:t)},re=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return g(e,t),e.prototype.create=function(t){return new e(t)},e.prototype.start=function(t){void 0===t&&(t={});var e=!1,i={stop:function(){}},n=this.props,r=n.init,o=v(n,["init"]),a=r(ne(t,o,(function(){e=!0,i.stop()})));return i=a?y(y({},i),a):i,t.registerParent&&t.registerParent(i),e&&i.stop(),i},e}(ee),oe=function(t){return new re({init:t})},ae=function(t){var e=t.getCount,i=t.getFirst,n=t.getOutput,r=t.mapApi,o=t.setProp,a=t.startActions;return function(t){return oe((function(s){var l=s.update,c=s.complete,h=s.error,u=e(t),d=n(),p=function(){return l(d)},f=0,m=a(t,(function(t,e){var i=!1;return t.start({complete:function(){i||(i=!0,++f===u&&st.update(c))},error:h,update:function(t){o(d,e,t),st.update(p,!1,!0)}})}));return Object.keys(i(m)).reduce((function(t,e){return t[e]=r(m,e),t}),{})}))}},se=ae({getOutput:function(){return{}},getCount:function(t){return Object.keys(t).length},getFirst:function(t){return t[Object.keys(t)[0]]},mapApi:function(t,e){return function(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];return Object.keys(t).reduce((function(n,r){var o;return t[r][e]&&(i[0]&&void 0!==i[0][r]?n[r]=t[r][e](i[0][r]):n[r]=(o=t[r])[e].apply(o,i)),n}),{})}},setProp:function(t,e,i){return t[e]=i},startActions:function(t,e){return Object.keys(t).reduce((function(i,n){return i[n]=e(t[n],n),i}),{})}}),le=ae({getOutput:function(){return[]},getCount:function(t){return t.length},getFirst:function(t){return t[0]},mapApi:function(t,e){return function(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];return t.map((function(t,n){if(t[e])return Array.isArray(i[0])?t[e](i[0][n]):t[e].apply(t,i)}))}},setProp:function(t,e,i){return t[e]=i},startActions:function(t,e){return t.map((function(t,i){return e(t,i)}))}}),ce=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return le(t)},he=[I,L,P,R,D],ue=function(t){return he.find((function(e){return e.test(t)}))},de=function(t,e){return t(e)},pe=function(t,e,i){var n=i[0],r=e[n].map((function(n,r){var o=i.reduce(function(t){return function(e,i){return e[i]=e[i][t],e}}(r),y({},e));return xe(n)(t,o)}));return ce.apply(void 0,r)},fe=function(t,e,i){var n=i[0],r=Object.keys(e[n]).reduce((function(r,o){var a=i.reduce(function(t){return function(e,i){return e[i]=e[i][t],e}}(o),y({},e));return r[o]=xe(e[n][o])(t,a),r}),{});return se(r)},me=function(t,e){var i=e.from,n=e.to,r=v(e,["from","to"]),o=ue(i)||ue(n),a=o.transform,s=o.parse;return t(y(y({},r),{from:"string"==typeof i?s(i):i,to:"string"==typeof n?s(n):n})).pipe(a)},ge=function(t){return function(e,i){var n=i.from,r=i.to,o=v(i,["from","to"]);return e(y(y({},o),{from:0,to:1})).pipe(t(n,r))}},ye=ge(Wt),_e=ge(Kt),ve=function(t,e){var i=function(t){var e=Object.keys(t),i=function(e,i){return void 0!==e&&!t[i](e)};return{getVectorKeys:function(t){return e.reduce((function(e,n){return i(t[n],n)&&e.push(n),e}),[])},testVectorProps:function(t){return t&&e.some((function(e){return i(t[e],e)}))}}}(e),n=i.testVectorProps,r=i.getVectorKeys;return function(e){if(!n(e))return t(e);var i=r(e),o=e[i[0]];return xe(o)(t,e,i)}},xe=function(t){return"number"==typeof t?de:Array.isArray(t)?pe:function(t){return Boolean(ue(t))}(t)?me:V.test(t)?ye:Z.test(t)?_e:"object"==typeof t?fe:de},be=ve((function(t){var e=t.from,i=void 0===e?0:e,n=t.to,r=void 0===n?1:n,o=t.ease,a=void 0===o?mt:o,s=t.reverseEase;return void 0!==s&&s&&(a=ht(a)),oe((function(t){var e=t.update;return{seek:function(t){return e(t)}}})).pipe(a,(function(t){return jt(i,r,t)}))}),{ease:function(t){return"function"==typeof t},from:E.test,to:E.test}),we=Ft(0,1),Me=function(t){return void 0===t&&(t={}),oe((function(e){var i,n=e.update,r=e.complete,o=t.duration,a=void 0===o?300:o,s=t.ease,l=void 0===s?yt:s,c=t.flip,h=void 0===c?0:c,u=t.loop,d=void 0===u?0:u,p=t.yoyo,f=void 0===p?0:p,m=t.repeatDelay,g=void 0===m?0:m,y=t.from,_=void 0===y?0:y,v=t.to,x=void 0===v?1:v,b=t.elapsed,w=void 0===b?0:b,M=t.flipCount,T=void 0===M?0:M,S=t.yoyoCount,E=void 0===S?0:S,C=t.loopCount,A=void 0===C?0:C,P=be({from:_,to:x,ease:l}).start(n),L=0,I=!1,R=function(t){var e;void 0===t&&(t=!1),P=be({from:_=(e=[x,_])[0],to:x=e[1],ease:l,reverseEase:t}).start(n)},D=function(){L=we(Nt(0,a,w)),P.seek(L)},k=function(){I=!0,i=st.update((function(t){var e,n=t.delta;w+=n,D(),!(e=I&&w>a+g)||(!e||d||h||f)&&(w=a-(w-g),d&&A<d?(A++,1):h&&T<h?(T++,R(),1):f&&E<f&&(E++,R(E%2!=0),1))||(nt.update(i),r&&st.update(r,!1,!0))}),!0)},O=function(){I=!1,i&&nt.update(i)};return k(),{isActive:function(){return I},getElapsed:function(){return Ft(0,a,w)},getProgress:function(){return L},stop:function(){O()},pause:function(){return O(),this},resume:function(){return I||k(),this},seek:function(t){return w=jt(0,a,t),st.update(D,!1,!0),this},reverse:function(){return R(),this}}}))},Te=function(t,e,i){return oe((function(n){var r=n.update,o=e.split(" ").map((function(e){return t.addEventListener(e,r,i),e}));return{stop:function(){return o.forEach((function(e){return t.removeEventListener(e,r,i)}))}}}))},Se=function(){return{clientX:0,clientY:0,pageX:0,pageY:0,x:0,y:0}},Ee=function(t,e){return void 0===e&&(e={clientX:0,clientY:0,pageX:0,pageY:0,x:0,y:0}),e.clientX=e.x=t.clientX,e.clientY=e.y=t.clientY,e.pageX=t.pageX,e.pageY=t.pageY,e},Ce=[Se()];if("undefined"!=typeof document){Te(document,"touchstart touchmove",{passive:!0,capture:!0}).start((function(t){var e=t.touches;!0;var i=e.length;Ce.length=0;for(var n=0;n<i;n++){var r=e[n];Ce.push(Ee(r))}}))}var Ae=Se();if("undefined"!=typeof document){Te(document,"mousedown mousemove",!0).start((function(t){!0,Ee(t,Ae)}))}var Pe,Le,Ie,Re=i(0),De={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tgl_FragColor = opacity * texel;","}"].join("\n")};function ke(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}Object.assign(ke.prototype,{setSize:function(){},render:function(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),ke.FullScreenQuad=(Pe=new Re.OrthographicCamera(-1,1,1,-1,0,1),Le=new Re.PlaneGeometry(2,2),Ie=function(t){this._mesh=new Re.Mesh(Le,t)},Object.defineProperty(Ie.prototype,"material",{get:function(){return this._mesh.material},set:function(t){this._mesh.material=t}}),Object.assign(Ie.prototype,{dispose:function(){this._mesh.geometry.dispose()},render:function(t){t.render(this._mesh,Pe)}}),Ie);var Oe=function(t,e){ke.call(this),this.textureID=void 0!==e?e:"tDiffuse",t instanceof Re.ShaderMaterial?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=Re.UniformsUtils.clone(t.uniforms),this.material=new Re.ShaderMaterial({defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.fsQuad=new ke.FullScreenQuad(this.material)};Oe.prototype=Object.assign(Object.create(ke.prototype),{constructor:Oe,render:function(t,e,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}});var ze=function(t,e){ke.call(this),this.scene=t,this.camera=e,this.clear=!0,this.needsSwap=!1,this.inverse=!1};ze.prototype=Object.assign(Object.create(ke.prototype),{constructor:ze,render:function(t,e,i){var n,r,o=t.getContext(),a=t.state;a.buffers.color.setMask(!1),a.buffers.depth.setMask(!1),a.buffers.color.setLocked(!0),a.buffers.depth.setLocked(!0),this.inverse?(n=0,r=1):(n=1,r=0),a.buffers.stencil.setTest(!0),a.buffers.stencil.setOp(o.REPLACE,o.REPLACE,o.REPLACE),a.buffers.stencil.setFunc(o.ALWAYS,n,4294967295),a.buffers.stencil.setClear(r),a.buffers.stencil.setLocked(!0),t.setRenderTarget(i),this.clear&&t.clear(),t.render(this.scene,this.camera),t.setRenderTarget(e),this.clear&&t.clear(),t.render(this.scene,this.camera),a.buffers.color.setLocked(!1),a.buffers.depth.setLocked(!1),a.buffers.stencil.setLocked(!1),a.buffers.stencil.setFunc(o.EQUAL,1,4294967295),a.buffers.stencil.setOp(o.KEEP,o.KEEP,o.KEEP),a.buffers.stencil.setLocked(!0)}});var Be=function(){ke.call(this),this.needsSwap=!1};Be.prototype=Object.create(ke.prototype),Object.assign(Be.prototype,{render:function(t){t.state.buffers.stencil.setLocked(!1),t.state.buffers.stencil.setTest(!1)}});var Fe=function(t,e){if(this.renderer=t,void 0===e){var i={minFilter:Re.LinearFilter,magFilter:Re.LinearFilter,format:Re.RGBAFormat},n=t.getSize(new Re.Vector2);this._pixelRatio=t.getPixelRatio(),this._width=n.width,this._height=n.height,(e=new Re.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,i)).texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=e.width,this._height=e.height;this.renderTarget1=e,this.renderTarget2=e.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],void 0===De&&console.error("THREE.EffectComposer relies on CopyShader"),void 0===Oe&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new Oe(De),this.clock=new Re.Clock};Object.assign(Fe.prototype,{swapBuffers:function(){var t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t},addPass:function(t){this.passes.push(t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)},insertPass:function(t,e){this.passes.splice(e,0,t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)},removePass:function(t){const e=this.passes.indexOf(t);-1!==e&&this.passes.splice(e,1)},isLastEnabledPass:function(t){for(var e=t+1;e<this.passes.length;e++)if(this.passes[e].enabled)return!1;return!0},render:function(t){void 0===t&&(t=this.clock.getDelta());var e,i,n=this.renderer.getRenderTarget(),r=!1,o=this.passes.length;for(i=0;i<o;i++)if(!1!==(e=this.passes[i]).enabled){if(e.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(i),e.render(this.renderer,this.writeBuffer,this.readBuffer,t,r),e.needsSwap){if(r){var a=this.renderer.getContext(),s=this.renderer.state.buffers.stencil;s.setFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),s.setFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==ze&&(e instanceof ze?r=!0:e instanceof Be&&(r=!1))}this.renderer.setRenderTarget(n)},reset:function(t){if(void 0===t){var e=this.renderer.getSize(new Re.Vector2);this._pixelRatio=this.renderer.getPixelRatio(),this._width=e.width,this._height=e.height,(t=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(t,e){this._width=t,this._height=e;var i=this._width*this._pixelRatio,n=this._height*this._pixelRatio;this.renderTarget1.setSize(i,n),this.renderTarget2.setSize(i,n);for(var r=0;r<this.passes.length;r++)this.passes[r].setSize(i,n)},setPixelRatio:function(t){this._pixelRatio=t,this.setSize(this._width,this._height)}});var Ne=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1};Object.assign(Ne.prototype,{setSize:function(){},render:function(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),Ne.FullScreenQuad=function(){var t=new Re.OrthographicCamera(-1,1,1,-1,0,1),e=new Re.PlaneGeometry(2,2),i=function(t){this._mesh=new Re.Mesh(e,t)};return Object.defineProperty(i.prototype,"material",{get:function(){return this._mesh.material},set:function(t){this._mesh.material=t}}),Object.assign(i.prototype,{dispose:function(){this._mesh.geometry.dispose()},render:function(e){e.render(this._mesh,t)}}),i}();var je=function(t,e,i,n,r){ke.call(this),this.scene=t,this.camera=e,this.overrideMaterial=i,this.clearColor=n,this.clearAlpha=void 0!==r?r:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new Re.Color};je.prototype=Object.assign(Object.create(ke.prototype),{constructor:je,render:function(t,e,i){var n,r,o=t.autoClear;t.autoClear=!1,void 0!==this.overrideMaterial&&(r=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(t.getClearColor(this._oldClearColor),n=t.getClearAlpha(),t.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&t.clearDepth(),t.setRenderTarget(this.renderToScreen?null:i),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),t.render(this.scene,this.camera),this.clearColor&&t.setClearColor(this._oldClearColor,n),void 0!==this.overrideMaterial&&(this.scene.overrideMaterial=r),t.autoClear=o}});var Ge={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new Re.Color(0)},defaultOpacity:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec3 defaultColor;","uniform float defaultOpacity;","uniform float luminosityThreshold;","uniform float smoothWidth;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tvec3 luma = vec3( 0.299, 0.587, 0.114 );","\tfloat v = dot( texel.xyz, luma );","\tvec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );","\tfloat alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );","\tgl_FragColor = mix( outputColor, texel, alpha );","}"].join("\n")},Ue=function(t,e,i,n){ke.call(this),this.strength=void 0!==e?e:1,this.radius=i,this.threshold=n,this.resolution=void 0!==t?new Re.Vector2(t.x,t.y):new Re.Vector2(256,256),this.clearColor=new Re.Color(0,0,0);var r={minFilter:Re.LinearFilter,magFilter:Re.LinearFilter,format:Re.RGBAFormat};this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;var o=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);this.renderTargetBright=new Re.WebGLRenderTarget(o,a,r),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(var s=0;s<this.nMips;s++){var l=new Re.WebGLRenderTarget(o,a,r);l.texture.name="UnrealBloomPass.h"+s,l.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(l);var c=new Re.WebGLRenderTarget(o,a,r);c.texture.name="UnrealBloomPass.v"+s,c.texture.generateMipmaps=!1,this.renderTargetsVertical.push(c),o=Math.round(o/2),a=Math.round(a/2)}void 0===Ge&&console.error("UnrealBloomPass relies on LuminosityHighPassShader");var h=Ge;this.highPassUniforms=Re.UniformsUtils.clone(h.uniforms),this.highPassUniforms.luminosityThreshold.value=n,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new Re.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:h.vertexShader,fragmentShader:h.fragmentShader,defines:{}}),this.separableBlurMaterials=[];var u=[3,5,7,9,11];for(o=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2),s=0;s<this.nMips;s++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(u[s])),this.separableBlurMaterials[s].uniforms.texSize.value=new Re.Vector2(o,a),o=Math.round(o/2),a=Math.round(a/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=e,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0;this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new Re.Vector3(1,1,1),new Re.Vector3(1,1,1),new Re.Vector3(1,1,1),new Re.Vector3(1,1,1),new Re.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,void 0===De&&console.error("BloomPass relies on CopyShader");var d=De;this.copyUniforms=Re.UniformsUtils.clone(d.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new Re.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:d.vertexShader,fragmentShader:d.fragmentShader,blending:Re.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new Re.Color,this.oldClearAlpha=1,this.basic=new Re.MeshBasicMaterial,this.fsQuad=new ke.FullScreenQuad(null)};Ue.prototype=Object.assign(Object.create(ke.prototype),{constructor:Ue,dispose:function(){for(var t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose()},setSize:function(t,e){var i=Math.round(t/2),n=Math.round(e/2);this.renderTargetBright.setSize(i,n);for(var r=0;r<this.nMips;r++)this.renderTargetsHorizontal[r].setSize(i,n),this.renderTargetsVertical[r].setSize(i,n),this.separableBlurMaterials[r].uniforms.texSize.value=new Re.Vector2(i,n),i=Math.round(i/2),n=Math.round(n/2)},render:function(t,e,i,n,r){this.oldClearColor.copy(t.getClearColor(new Re.Color)),this.oldClearAlpha=t.getClearAlpha();var o=t.autoClear;t.autoClear=!1,t.setClearColor(this.clearColor,0),r&&t.context.disable(t.context.STENCIL_TEST),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=i.texture,t.setRenderTarget(null),t.clear(),this.fsQuad.render(t)),this.highPassUniforms.tDiffuse.value=i.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,t.setRenderTarget(this.renderTargetBright),t.clear(),this.fsQuad.render(t);for(var a=this.renderTargetBright,s=0;s<this.nMips;s++)this.fsQuad.material=this.separableBlurMaterials[s],this.separableBlurMaterials[s].uniforms.colorTexture.value=a.texture,this.separableBlurMaterials[s].uniforms.direction.value=Ue.BlurDirectionX,t.setRenderTarget(this.renderTargetsHorizontal[s]),t.clear(),this.fsQuad.render(t),this.separableBlurMaterials[s].uniforms.colorTexture.value=this.renderTargetsHorizontal[s].texture,this.separableBlurMaterials[s].uniforms.direction.value=Ue.BlurDirectionY,t.setRenderTarget(this.renderTargetsVertical[s]),t.clear(),this.fsQuad.render(t),a=this.renderTargetsVertical[s];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.setRenderTarget(this.renderTargetsHorizontal[0]),t.clear(),this.fsQuad.render(t),this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,r&&t.context.enable(t.context.STENCIL_TEST),this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(i),this.fsQuad.render(t)),t.setClearColor(this.oldClearColor,this.oldClearAlpha),t.autoClear=o},getSeperableBlurMaterial:function(t){return new Re.ShaderMaterial({defines:{KERNEL_RADIUS:t,SIGMA:t},uniforms:{colorTexture:{value:null},texSize:{value:new Re.Vector2(.5,.5)},direction:{value:new Re.Vector2(.5,.5)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat fSigma = float(SIGMA);\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, fSigma);\t\t\t\t\tfloat alphaSum = 0.0;\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\t\t\t\t\t\tfloat x = float(i);\t\t\t\t\t\tfloat w = gaussianPdf(x, fSigma);\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\t\t\t\t\t\tvec4 sample1 = texture2D( colorTexture, vUv + uvOffset);\t\t\t\t\t\tvec4 sample2 = texture2D( colorTexture, vUv - uvOffset);\t\t\t\t\t\tdiffuseSum += (sample1.rgb + sample2.rgb) * w;\t\t\t\t\t\talphaSum += (sample1.a + sample2.a) * w;\t\t\t\t\t\tweightSum += 2.0 * w;\t\t\t\t\t}\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, alphaSum/weightSum);\n\t\t\t\t}"})},getCompositeMaterial:function(t){return new Re.ShaderMaterial({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},dirtTexture:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D blurTexture1;\t\t\t\tuniform sampler2D blurTexture2;\t\t\t\tuniform sampler2D blurTexture3;\t\t\t\tuniform sampler2D blurTexture4;\t\t\t\tuniform sampler2D blurTexture5;\t\t\t\tuniform sampler2D dirtTexture;\t\t\t\tuniform float bloomStrength;\t\t\t\tuniform float bloomRadius;\t\t\t\tuniform float bloomFactors[NUM_MIPS];\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\t\t\t\t\t\t\t\tfloat lerpBloomFactor(const in float factor) { \t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\t\t\t\t}\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\t\t\t\t}"})}}),Ue.BlurDirectionX=new Re.Vector2(1,0),Ue.BlurDirectionY=new Re.Vector2(0,1);var Ve=i(1);const He=parseInt(Re.REVISION.replace("dev",""));function Ze(t,e,i){return He>109?t.setAttribute(e,i):t.addAttribute(e,i),t}function We(){return!Re.VertexColors||Re.VertexColors}console.log("maptalks.three log: current three.js version is %c"+He,"color:red;font-size: 16px;font-weight: bold;");class qe extends Re.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),Ze(this,"position",new Re.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),Ze(this,"uv",new Re.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix(t){var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(i),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new Re.InstancedInterleavedBuffer(e,6,1);return Ze(this,"instanceStart",new Re.InterleavedBufferAttribute(i,3,0)),Ze(this,"instanceEnd",new Re.InterleavedBufferAttribute(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new Re.InstancedInterleavedBuffer(e,6,1);return Ze(this,"instanceColorStart",new Re.InterleavedBufferAttribute(i,3,0)),Ze(this,"instanceColorEnd",new Re.InterleavedBufferAttribute(i,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new Re.WireframeGeometry(t.geometry)),this}fromLineSegements(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}computeBoundingBox(){var t=new Re.Box3;null===this.boundingBox&&(this.boundingBox=new Re.Box3);var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;void 0!==e&&void 0!==i&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(i),this.boundingBox.union(t))}computeBoundingSphere(){var t=new Re.Vector3;null===this.boundingSphere&&(this.boundingSphere=new Re.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;if(void 0!==e&&void 0!==i){var n=this.boundingSphere.center;this.boundingBox.getCenter(n);for(var r=0,o=0,a=e.count;o<a;o++)t.fromBufferAttribute(e,o),r=Math.max(r,n.distanceToSquared(t)),t.fromBufferAttribute(i,o),r=Math.max(r,n.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}copy(t){return this}}var Xe=qe;const Ye={},$e={};Ye.line={linewidth:{value:1},resolution:{value:new Re.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},$e.line={uniforms:Re.UniformsUtils.merge([Re.UniformsLib.common,Re.UniformsLib.fog,Ye.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class Je extends Re.ShaderMaterial{constructor(t){super({uniforms:Re.UniformsUtils.clone($e.line.uniforms),vertexShader:$e.line.vertexShader,fragmentShader:$e.line.fragmentShader}),this.dashed=!0,this.isLineMaterial=!0,this.type="LineMaterial",Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}}var Ke=Je;class Qe extends Re.Mesh{constructor(t,e){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==t?t:new Xe,this.material=void 0!==e?e:new Ke({color:16777215*Math.random()})}computeLineDistances(){for(var t=new Re.Vector3,e=new Re.Vector3,i=this.geometry,n=i.attributes.instanceStart,r=i.attributes.instanceEnd,o=new Float32Array(2*n.data.count),a=0,s=0,l=n.data.count;a<l;a++,s+=2)t.fromBufferAttribute(n,a),e.fromBufferAttribute(r,a),o[s]=0===s?0:o[s-1],o[s+1]=o[s]+t.distanceTo(e);var c=new Re.InstancedInterleavedBuffer(o,2,1);return Ze(i,"instanceDistanceStart",new Re.InterleavedBufferAttribute(c,1,0)),Ze(i,"instanceDistanceEnd",new Re.InterleavedBufferAttribute(c,1,1)),this}}var ti=Qe;var ei=class extends Xe{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}fromLine(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}};var ii=class extends ti{constructor(t,e){super(t,e),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==t?t:new ei,this.material=void 0!==e?e:new Ke({color:16777215*Math.random()})}copy(t){return this}};const ni={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1};function ri(){}class oi extends(Ve.f(ri)){constructor(t){super(),this.isAdd=!1,this._mouseover=!1,this._visible=!0,this._zoomVisible=!0,this.picked=!1,this.isBaseObject=!0,void 0===t&&(t=Ve.o.GUID()),this.id=t}addTo(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this}remove(){const t=this.getLayer();return t&&t.removeMesh([this]),this}getObject3d(){return this.object3d}getId(){return this.id}setId(t){const e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this}getType(){return this.type}getOptions(){return this.options}getProperties(){return(this.options||{}).properties}setProperties(t){const e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this}getLayer(){return this.options.layer}getMap(){const t=this.getLayer();if(t)return t.getMap()}getCenter(){const t=this.getOptions(),{coordinate:e,lineString:i,polygon:n}=t;if(e)return e instanceof Ve.d?e:new Ve.d(e);{const t=n||i;if(t&&t.getCenter)return t.getCenter()}}getAltitude(){return this.getOptions().altitude}setAltitude(t){if(Ve.o.isNumber(t)){const e=this.getLayer().distanceToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(let t=0,i=this._baseObjects.length;t<i;t++)this._baseObjects[t]&&(this._baseObjects[t].getObject3d().position.z=e)}return this}show(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this}hide(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this}isVisible(){return!!this.getObject3d().visible}getSymbol(){return this.getObject3d().material}setSymbol(t){if(t&&t instanceof Re.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;const e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this}setInfoWindow(t){return this.removeInfoWindow(),this.infoWindow=new Ve.s.InfoWindow(t),this.infoWindow.addTo(this),this}getInfoWindow(){return this.infoWindow}openInfoWindow(t){return(t=t||this.getCenter())instanceof Ve.d||(t=new Ve.d(t)),t&&this.infoWindow&&this.infoWindow.show(t),this}closeInfoWindow(){return this.infoWindow&&this.infoWindow.hide(),this}removeInfoWindow(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this}setToolTip(t,e){return this.removeToolTip(),this.toolTip=new Ve.s.ToolTip(t,e),this.toolTip.addTo(this),this}getToolTip(){return this.toolTip}openToolTip(t){return(t=t||this.getCenter())instanceof Ve.d||(t=new Ve.d(t)),t&&this.toolTip&&this.toolTip.show(t),this}closeToolTip(){return this.toolTip&&this.toolTip.hide(),this}removeToolTip(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this}animateShow(t={},e){this._showPlayer&&this._showPlayer.cancel(),Ve.o.isFunction(t)&&(e=t={});const i=t.duration||1e3,n=t.easing||"out",r=this._showPlayer=Ve.p.Animation.animate({scale:1},{duration:i,easing:n},t=>{const i=t.styles.scale;i>0&&this.getObject3d().scale.set(1,1,i),e&&e(t,i)});return r.play(),r}getMinZoom(){return this.getOptions().minZoom}getMaxZoom(){return this.getOptions().maxZoom}isAsynchronous(){return this.getOptions().asynchronous}fire(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this}config(){return this}setPickObject3d(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this}_initOptions(t){return this.options=Ve.o.extend({},ni,t),this}_createMesh(t,e){return this.object3d=new Re.Mesh(t,e),this.object3d.__parent=this,this}_createGroup(){return this.object3d=new Re.Group,this.object3d.__parent=this,this}_createLine(t,e){return this.object3d=new Re.Line(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}_createLine2(t,e){return this.object3d=new ii(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}_createPoints(t,e){return this.object3d=new Re.Points(t,e),this.object3d.__parent=this,this}_createLineSegments(t,e){return this.object3d=new Re.LineSegments(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}}var ai=oi;function si(t){const{position:e,normal:i,uv:n,indices:r}=li(t),o=new Re.BufferGeometry,a=new Float32Array(e.length);return a.fill(1,0,e.length),Ze(o,"color",new Re.BufferAttribute(a,3)),Ze(o,"normal",new Re.BufferAttribute(i,3)),Ze(o,"position",new Re.BufferAttribute(e,3)),n&&n.length&&Ze(o,"uv",new Re.BufferAttribute(n,2)),o.setIndex(new Re.BufferAttribute(r,1)),o}function li(t){const e={},i={};for(let n=0;n<t.length;++n){const r=t[n];for(const t in r)void 0===e[t]&&(e[t]=[],i[t]=0),e[t].push(r[t]),i[t]+=r[t].length}const n={};let r=0;const o=[];for(const t in e)if("indices"===t){const i=e[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];for(let t=0,e=n.length;t<e;t++)o.push(n[t]+r);r+=e.position[t].length/3}}else{const r=ci(e[t],i[t]);if(!r)return null;n[t]=r}return n.indices=new Uint32Array(o),n}function ci(t,e){const i=new Float32Array(e);let n=0;for(let e=0;e<t.length;++e)i.set(t[e],n),n+=t[e].length;return i}function hi(t){const{position:e,normal:i,uv:n,indices:r}=t,o=new Float32Array(e.length);o.fill(1,0,e.length);const a=new Re.BufferGeometry;return Ze(a,"color",new Re.BufferAttribute(o,3)),Ze(a,"normal",new Re.BufferAttribute(new Float32Array(i),3)),Ze(a,"position",new Re.BufferAttribute(new Float32Array(e),3)),Ze(a,"uv",new Re.BufferAttribute(new Float32Array(n),2)),a.setIndex(new Re.BufferAttribute(new Uint32Array(r),1)),a}let ui;function di(){if(!ui){const t=1e-6;ui=new Re.BoxBufferGeometry(t,t,t)}return ui}const pi={},fi=new Re.BoxBufferGeometry(1,1,1);fi.translate(0,0,.5);const mi=new Re.Color("#fff"),gi=new Re.Color("#fff");function yi(t){const{height:e,radialSegments:i,radius:n}=t,r=function(t=6){if(!pi[t]){const e=new Re.CylinderBufferGeometry(1,1,1,t,1);e.rotateX(Math.PI/2),e.translate(0,0,.5),e.rotateZ(Math.PI/6),pi[t]=e}return pi[t]}(i).clone();return r.scale(n,n,e),r}function _i(t,e,i,n="y",r=0){let o=0;"y"===n?o=1:"z"===n&&(o=2);const a=t.attributes.position.array,s=a.length;gi.setStyle(e),mi.setStyle(i);const l=[];for(let t=0;t<s;t+=3){a[t+o]>r?l.push(mi.r,mi.g,mi.b):l.push(gi.r,gi.g,gi.b)}return Ze(t,"color",new Re.Float32BufferAttribute(l,3,!0)),l}function vi(t){const e=[],i=[];for(let n=0,r=t.length;n<r;n++){const{color:r,normal:o,position:a,uv:s}=t[n].attributes,l=t[n].index;if(r)for(let t=0,e=r.array.length;t<e;t++)i.push(r.array[t]);e.push({normal:o.array,uv:s.array,position:a.array,indices:l.array})}const n=si(e);i.length&&Ze(n,"color",new Re.Float32BufferAttribute(i,3,!0));for(let e=0,i=t.length;e<i;e++)t[e].dispose();return n}function xi(){return fi}const bi={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};var wi=class extends ai{constructor(t,e,i,n){e=Ve.o.extend({},bi,e,{layer:n,coordinate:t}),super(),this._initOptions(e);const{height:r,radius:o,topColor:a,bottomColor:s,altitude:l}=e;e.height=n.distanceToVector3(r,r).x,e.radius=n.distanceToVector3(o,o).x,e._radius=this.options.radius,e._height=this.options.height;const c=yi(e);a&&(_i(c,s,a,"z",e.height/2),i.vertexColors=We()),this._createMesh(c,i);const h=n.distanceToVector3(l,l).x,u=n.coordinateToVector3(t,h);this.getObject3d().position.copy(u),this.type="Bar"}};function Mi(t,e,i={}){return void 0===i[t]&&(i[t]=e.distanceToVector3(t,t).x),i[t]}function Ti(t=[]){let e=1/0,i=1/0,n=-1/0,r=-1/0;for(let o=0,a=t.length;o<a;o++){const{coordinate:a,lnglat:s,lnglats:l,xy:c,xys:h}=t[o],u=a||s||l||c||h||t[o];let d,p;Array.isArray(u)?(d=u[0],p=u[1]):u instanceof Ve.d&&(d=u.x,p=u.y),e=Math.min(e,d),i=Math.min(i,p),n=Math.max(n,d),r=Math.max(r,p)}return new Ve.d((e+n)/2,(i+r)/2)}function Si(t,e,i,n){if(void 0===e||"number"!=typeof e||0===e)return 0;let r;r=t instanceof Re.BufferGeometry?t.attributes.position.array:Array.isArray(t)?t:t.position;let o=0;if(r){n?(void 0===n[e]&&(n[e]=i.distanceToVector3(e,e).x),o=n[e]):o=i.distanceToVector3(e,e).x;const t=r.length;if(r[0]instanceof Re.Vector3)for(let e=0;e<t;e++)r[e].z+=o;else for(let e=0;e<t;e+=3)r[e+2]+=o}return o}var Ei=i(18),Ci=i.n(Ei);function Ai(t,e,i){var n=e[0],r=e[1],o=i[0]-n,a=i[1]-r;if(0!==o||0!==a){var s=((t[0]-n)*o+(t[1]-r)*a)/(o*o+a*a);s>1?(n=i[0],r=i[1]):s>0&&(n+=o*s,r+=a*s)}return(o=t[0]-n)*o+(a=t[1]-r)*a}function Pi(t,e){var i=t.length-1,n=[t[0]];return function t(e,i,n,r,o){for(var a,s=r,l=i+1;l<n;l++){var c=Ai(e[l],e[i],e[n]);c>s&&(a=l,s=c)}s>r&&(a-i>1&&t(e,i,a,r,o),o.push(e[a]),n-a>1&&t(e,a,n,r,o))}(t,0,i,e,n),n.push(t[i]),n}var Li=function(t,e,i){if(t.length<=2)return t;var n=void 0!==e?e*e:1;return t=Pi(t=i?t:function(t,e){for(var i,n,r,o,a,s=t[0],l=[s],c=1,h=t.length;c<h;c++)i=t[c],r=s,o=void 0,a=void 0,o=(n=i)[0]-r[0],a=n[1]-r[1],o*o+a*a>e&&(l.push(i),s=i);return s!==i&&l.push(i),l}(t,n),n)};function Ii(t,e){return t[0]*e[0]+t[1]*e[1]}function Ri(t,e){const i=e[0],n=e[1],r=Math.sqrt(i*i+n*n);return t[0]=i/r,t[1]=n/r,t}function Di(t,e,i,n){return t[0]=e[0]+i[0]*n,t[1]=e[1]+i[1]*n,t[2]=e[2]+i[2]*n,t}function ki(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t}function Oi(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function zi(t,e){const i=e[0],n=e[1],r=e[2],o=Math.sqrt(i*i+n*n+r*r);return t[0]=i/o,t[1]=n/o,t[2]=r/o,t}const Bi=[];function Fi(t,e,i,n){const r=(a=i,(o=e)[0]*a[0]+o[1]*a[1]+o[2]*a[2]);var o,a;const s=Math.acos(r)*n;return Di(Bi,i,e,-r),function(t,e){const i=e[0],n=e[1],r=e[2],o=Math.sqrt(i*i+n*n+r*r);t[0]=i/o,t[1]=n/o,t[2]=r/o}(Bi,Bi),function(t,e,i){t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}(t,e,Math.cos(s)),Di(t,t,Bi,Math.sin(s)),t}function Ni(t,e,i,n,r,o,a,s,l,c){const h=a-r,u=s-o,d=(h*(e-o)-u*(t-r))/(u*(i-t)-h*(n-e));return l&&(l[c=c||0]=t+d*(i-t),l[c+1]=e+d*(n-e)),d}function ji(t,e,i){if(i-e<3)return 0;let n=0;for(let r=2*(i-1),o=2*e;o<2*i;){const e=t[r],i=t[r+1],a=t[o],s=t[o+1];r=o,o+=2,n+=e*s-a*i}return n}function Gi(t,e,i=2){return Ci()(t,e,i)}const Ui=[],Vi=[],Hi=[];function Zi(t,e,i,n,r,o,a,s,l){const c=null!=a;let h,u,d,p=r,f=null;c&&(f=new Uint32Array(n-i));let m=[];for(let r=i;r<n;r++){const g=r===n-1?i:r+1,y=r===i?n-1:r-1,_=t[2*y],v=t[2*y+1],x=t[2*r],b=t[2*r+1],w=t[2*g],M=t[2*g+1];Ui[0]=x-_,Ui[1]=b-v,Vi[0]=w-x,Vi[1]=M-b,Ri(Ui,Ui),Ri(Vi,Vi),c&&(f[r]=p);let T,S,E=!1;if(s||r!==i)if(s||r!==n-1){ki(Hi,Vi,Ui);const t=Hi[1];Hi[1]=-Hi[0],Hi[0]=t,Ri(Hi,Hi);const i=Ii(Hi,Vi),n=Math.sqrt(1-i*i),r=o*Math.min(10,1/n),s=o*i<0;if(c&&1/n>a&&s){const t=x+Hi[0]*o,i=b+Hi[1]*o,r=Math.acos(n)/2,a=Math.tan(r)*Math.abs(o);e[2*p]=t+Hi[1]*a,e[2*p+1]=i-Hi[0]*a,p++,e[2*p]=t-Hi[1]*a,e[2*p+1]=i+Hi[0]*a,p++}else T=x+Hi[0]*r,S=b+Hi[1]*r,E=!0;if(E){if(l&&null!=h){const t=Ni(_,v,h,u,x,b,T,S,m,0);t>=-.01&&t<=1.01&&(e[2*d]=T=m[0],e[2*d+1]=S=m[1])}h=e[2*p]=T,u=e[2*p+1]=S,d=p,p++}}else Hi[0]=Ui[1],Hi[1]=-Ui[0],Ri(Hi,Hi),T=x+Hi[0]*o,S=b+Hi[1]*o,E=!0;else Hi[0]=Vi[1],Hi[1]=-Vi[0],Ri(Hi,Hi),h=e[2*p]=x+Hi[0]*o,u=e[2*p+1]=b+Hi[1]*o,d=p,p++}return f}function Wi(t,e,i,n,r,o,a,s){const l=null!=a;let c=r,h=null;l&&(h=new Uint32Array(n-i));for(let r=i;r<n;r++){const u=r===n-1?i:r+1,d=r===i?n-1:r-1,p=t[2*d],f=t[2*d+1],m=t[2*r],g=t[2*r+1],y=t[2*u],_=t[2*u+1];if(Ui[0]=m-p,Ui[1]=g-f,Vi[0]=y-m,Vi[1]=_-g,Ri(Ui,Ui),Ri(Vi,Vi),l&&(h[r]=c),s||r!==i)if(s||r!==n-1){ki(Hi,Vi,Ui);const t=Hi[1];Hi[1]=-Hi[0],Hi[0]=t,Ri(Hi,Hi);const i=Ii(Hi,Vi),n=Math.sqrt(1-i*i),r=o*Math.min(10,1/n),s=o*i<0;if(l&&1/n>a&&s){const t=m+Hi[0]*o,i=g+Hi[1]*o,r=Math.acos(n)/2,a=Math.tan(r)*Math.abs(o);e[2*c]=t+Hi[1]*a,e[2*c+1]=i-Hi[0]*a,c++,e[2*c]=t-Hi[1]*a,e[2*c+1]=i+Hi[0]*a,c++}else e[2*c]=m+Hi[0]*r,e[2*c+1]=g+Hi[1]*r,c++}else Hi[0]=Ui[1],Hi[1]=-Ui[0],Ri(Hi,Hi),e[2*c]=m+Hi[0]*o,e[2*c+1]=g+Hi[1]*o,c++;else Hi[0]=Vi[1],Hi[1]=-Vi[0],Ri(Hi,Hi),e[2*c]=m+Hi[0]*o,e[2*c+1]=g+Hi[1]*o,c++}return h}function qi(t,e,i,n,r){const o=null!=n?[]:new Float32Array(t.length);if(Zi(t,o,0,e&&e.length?e[0]:t.length/2,0,i,n,r,!0),e)for(let a=0;a<e.length;a++){const s=e[a];Zi(t,o,s,e[a+1]||t.length/2,null!=n?o.length/2:s,i,n,r,!1)}return o}function Xi(t,e,i,n){for(let r=0;r<Math.floor((n-i)/2);r++)for(let o=0;o<e;o++){const a=(r+i)*e+o,s=(n-r-1)*e+o,l=t[a];t[a]=t[s],t[s]=l}return t}function Yi(t,e){let i=t.length/2,n=0,r=e&&e.length?e[0]:i;ji(t,n,r)>0&&Xi(t,2,n,r);for(let o=1;o<(e?e.length:0)+1;o++)n=e[o-1],r=e[o]||i,ji(t,n,r)<0&&Xi(t,2,n,r)}function $i(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,null==t.smoothSide&&(t.smoothSide="auto"),null==t.smoothSideThreshold&&(t.smoothSideThreshold=.9),"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);const e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){let i=null==t.fitRect.x?e.x||0:t.fitRect.x,n=null==t.fitRect.y?e.y||0:t.fitRect.y,r=t.fitRect.width,o=t.fitRect.height;null==r?null!=o?r=o/e.height*e.width:(r=e.width,o=e.height):null==o&&(o=r/e.width*e.height),t.scale=[r/e.width,o/e.height],t.translate=[(i-e.x)*t.scale[0],(n-e.y)*t.scale[1]]}}const Ji=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function Ki(t,e,i){let n=0,r=t[e],o=t[e+1];const a=r,s=o;for(let a=e+2;a<i;a+=2){const e=t[a],i=t[a+1];n+=Math.sqrt((e-r)*(e-r)+(i-o)*(i-o)),r=e,o=i}return n+=Math.sqrt((r-a)*(r-a)+(o-s)*(o-s)),n}function Qi(t,{vertices:e,topVertices:i,splittedMap:n,depth:r,rect:o},a,s,l,c){const h=s-a,u=c.smoothBevel?1:2,d=Math.min(r/2,c.bevelSize),p=c.bevelSegments,f=l.vertex,m=l.ringPerimeter,g=Math.max(o.width,o.height,r,m);function y(t){const i=(t+1)%h,n=e[2*t],r=e[2*t+1],o=e[2*i],a=e[2*i+1];return n===o&&r===a}if(d>0){const o=[0,0,1],s=[],c=[0,0,-1],m=[];let _=0,v=new Float32Array(h);for(let x=0;x<2;x++){const b=0===x?r-d:d;for(let r=0;r<=p*u;r++){let w,M,T=0;for(let S=0;S<h;S++){const E=2*(S%h+a),C=n?2*n[E/2]:E;s[0]=e[E]-i[C],s[1]=e[E+1]-i[C+1],s[2]=0;const A=Math.sqrt(s[0]*s[0]+s[1]*s[1]);s[0]/=A,s[1]/=A;const P=(Math.floor(r/u)+r%u)/p;0===x?Fi(m,o,s,P):Fi(m,s,c,P);const L=0===x?P:1-P,I=d*Math.sin(L*Math.PI/2),R=A*Math.cos(L*Math.PI/2),D=d*A/Math.sqrt(I*I+R*R),k=m[0]*D+i[C],O=m[1]*D+i[C+1],z=m[2]*D+b;if(t.position[3*l.vertex]=k,t.position[3*l.vertex+1]=O,t.position[3*l.vertex+2]=z,S>0&&(T+=Math.sqrt((w-k)*(w-k)+(M-O)*(M-O))),r>0||x>0){let e=3*(l.vertex-h),i=t.position[e],n=t.position[e+1],r=t.position[e+2];v[S]+=Math.sqrt((i-k)*(i-k)+(n-O)*(n-O)+(r-z)*(r-z))}if(t.uv[2*l.vertex]=T/g,t.uv[2*l.vertex+1]=v[S]/g,w=k,M=O,l.vertex++,!y(S)&&(u>1&&r%u||1===u&&r>=1))for(let e=0;e<6;e++){const i=(Ji[e][0]+S)%h,n=Ji[e][1]+_;t.indices[l.index++]=(n-1)*h+i+f}}_++}}}else for(let i=0;i<2;i++){const n=0===i?r-d:d;let o,s,c=0;for(let i=0;i<h;i++){const r=2*(i%h+a),u=e[r],d=e[r+1];t.position[3*l.vertex]=u,t.position[3*l.vertex+1]=d,t.position[3*l.vertex+2]=n,i>0&&(c+=Math.sqrt((o-u)*(o-u)+(s-d)*(s-d))),t.uv[2*l.vertex]=c/g,t.uv[2*l.vertex+1]=n/g,o=u,s=d,l.vertex++}}const _=d>0?p*u+1:1;for(let e=0;e<h;e++)if(!y(e))for(let i=0;i<6;i++){const n=(Ji[i][0]+e)%h,r=Ji[i][1]+_;t.indices[l.index++]=(r-1)*h+n+f}}function tn({indices:t,topVertices:e,rect:i,depth:n},r,o,a){if(e.length<=4)return;const s=o.vertex,l=t.length;for(let e=0;e<l;e++)r.indices[o.index++]=s+t[e];const c=Math.max(i.width,i.height);for(let t=0;t<(a.excludeBottom?1:2);t++)for(let a=0;a<e.length;a+=2){const s=e[a],l=e[a+1];r.position[3*o.vertex]=s,r.position[3*o.vertex+1]=l,r.position[3*o.vertex+2]=(1-t)*n,r.uv[2*o.vertex]=(s-i.x)/c,r.uv[2*o.vertex+1]=(l-i.y)/c,o.vertex++}if(!a.excludeBottom){const i=e.length/2;for(let e=0;e<l;e+=3)for(let n=0;n<3;n++)r.indices[o.index++]=s+i+t[e+2-n]}}function en(t,e,i,n){const r=null==i||"auto"===i;if(!0===i)return{vertices:t,holes:e};const o=[],a=e&&[],s=t.length/2,l=[],c=[],h=[];let u=0,d=0;const p=(e?e.length:0)+1;for(let i=0;i<p;i++){0===i?d=e&&e.length?e[0]:s:(u=e[i-1],d=e[i]||s);for(let e=u;e<d;e++){const i=t[2*e],a=t[2*e+1],s=e===d-1?u:e+1,p=t[2*s],f=t[2*s+1];if(r){const r=e===u?d-1:e-1,s=t[2*r],m=t[2*r+1];l[0]=s-i,l[1]=m-a,c[0]=p-i,c[1]=f-a,Ri(l,l),Ri(c,c);1-(.5*Ii(l,c)+.5)>n?(o.push(i,a),h.push(e)):(o.push(i,a,i,a),h.push(e,e))}else o.push(i,a,i,a),h.push(e,e)}i<p-1&&a&&a.push(o.length/2)}return{vertices:new Float32Array(o),splittedMap:h,holes:a}}function nn(t,e){let i=0,n=0;for(let r=0;r<t.length;r++){const{indices:o,vertices:a,splittedMap:s,topVertices:l,depth:c}=t[r],h=Math.min(c/2,e.bevelSize)>0?e.bevelSegments:0,u=t[r].holes||[];i+=o.length*(e.excludeBottom?1:2),n+=l.length/2*(e.excludeBottom?1:2);const d=2+2*h;let p=0,f=0;for(let t=0;t<u.length+1;t++){0===t?f=u.length?u[0]:a.length/2:(p=u[t-1],f=u[t]||a.length/2);i+=6*((s?s[f-1]+1:f)-(s?s[p]:p))*(d-1);const r=f-p;n+=r*d+(e.smoothBevel?0:h*r*2)}}const r={position:new Float32Array(3*n),indices:new(n>65535?Uint32Array:Uint16Array)(i),uv:new Float32Array(2*n)},o={vertex:0,index:0,ringPerimeter:0};for(let i=0;i<t.length;i++)tn(t[i],r,o,e);for(let i=0;i<t.length;i++){const{holes:n,vertices:a}=t[i],s=a.length/2;let l=0,c=n&&n.length?n[0]:s;if(o.ringPerimeter=Ki(t[i].topVertices,l,c),Qi(r,t[i],l,c,o,e),n)for(let a=0;a<n.length;a++)l=n[a],c=n[a+1]||s,o.ringPerimeter=Ki(t[i].topVertices,l,c),Qi(r,t[i],l,c,o,e)}for(let t=0;t<r.uv.length;t++){const e=r.uv[t];e>0&&Math.round(e)===e?r.uv[t]=1:r.uv[t]=e%1}return r.normal=function(t,e){function i(t,e,i,n){t[0]=e,t[1]=i,t[2]=n}const n=[],r=[],o=[],a=[],s=[],l=[],c=t.length,h=new Float32Array(e.length);for(let x=0;x<c;){const c=3*t[x++],b=3*t[x++],w=3*t[x++];i(n,e[c],e[c+1],e[c+2]),i(r,e[b],e[b+1],e[b+2]),i(o,e[w],e[w+1],e[w+2]),Oi(a,n,r),Oi(s,r,o),u=l,p=s,f=void 0,m=void 0,g=void 0,y=void 0,_=void 0,v=void 0,f=(d=a)[0],m=d[1],g=d[2],y=p[0],_=p[1],v=p[2],u[0]=m*v-g*_,u[1]=g*y-f*v,u[2]=f*_-m*y;for(let t=0;t<3;t++)h[c+t]=h[c+t]+l[t],h[b+t]=h[b+t]+l[t],h[w+t]=h[w+t]+l[t]}for(var u,d,p,f,m,g,y,_,v,x=0;x<h.length;)i(l,h[x],h[x+1],h[x+2]),zi(l,l),h[x++]=l[0],h[x++]=l[1],h[x++]=l[2];return h}(r.indices,r.position),r.boundingRect=t[0]&&t[0].rect,r}function rn(t,e,i){const n=i.lineWidth,r=t.length,o=new Float32Array(2*r),a=i.translate||[0,0],s=i.scale||[1,1];for(let e=0,i=0;e<r;e++)o[i++]=t[e][0]*s[0]+a[0],o[i++]=t[e][1]*s[1]+a[1];ji(o,0,r)<0&&Xi(o,2,0,r);const l=[],c=[],h=i.miterLimit,u=Wi(o,c,0,r,0,-n/2,h,!1);Xi(o,2,0,r);const d=Wi(o,l,0,r,0,-n/2,h,!1),p=(l.length+c.length)/2,f=new Float32Array(2*p);let m=0;const g=c.length/2;for(let t=0;t<c.length;t++)f[m++]=c[t];for(let t=0;t<l.length;t++)f[m++]=l[t];const y=new(p>65535?Uint32Array:Uint16Array)(3*(2*(r-1)+(p-2*r)));let _=0;for(let t=0;t<r-1;t++){const e=t+1;y[_++]=g-1-u[t],y[_++]=g-1-u[t]-1,y[_++]=d[t]+1+g,y[_++]=g-1-u[t],y[_++]=d[t]+1+g,y[_++]=d[t]+g,d[e]-d[t]==2?(y[_++]=d[t]+2+g,y[_++]=d[t]+1+g,y[_++]=g-u[e]-1):u[e]-u[t]==2&&(y[_++]=d[e]+g,y[_++]=g-1-(u[t]+1),y[_++]=g-1-(u[t]+2))}const v=i.bevelSize>0?qi(f,[],i.bevelSize,null,!0):f,x=i.boundingRect,b=en(f,null,i.smoothSide,i.smoothSideThreshold);return{vertices:b.vertices,rawVertices:v,splittedMap:b.splittedMap,indices:y,topVertices:v,rect:{x:x.x*s[0]+a[0],y:x.y*s[1]+a[1],width:x.width*s[0],height:x.height*s[1]},depth:"function"==typeof i.depth?i.depth(e):i.depth,holes:[]}}function on(t,e){const i=[];for(let n=0;n<t.length;n++){const r=t[n],o=[],a=r.length;let s=r[a-1][0],l=r[a-1][1],c=0;for(let t=0;t<a;t++){let i=r[t][0],n=r[t][1];const a=i-s,h=n-l;c+=Math.sqrt(a*a+h*h),c>e&&(o.push(r[t]),c=0),s=i,l=n}o.length>=3&&i.push(o)}return i.length>0?i:null}function an(t,e){const i=[];for(let n=0;n<t.length;n++){let r=t[n];r=Li(r,e,!0),r.length>=3&&i.push(r)}return i.length>0?i:null}function sn(t,e){e=Object.assign({},e);const i=[1/0,1/0],n=[-1/0,-1/0];for(let e=0;e<t.length;e++)cn(t[e][0],i,n);e.boundingRect=e.boundingRect||{x:i[0],y:i[1],width:n[0]-i[0],height:n[1]-i[1]},$i(e);const r=[],o=e.translate||[0,0],a=e.scale||[1,1],s=e.boundingRect,l={x:s.x*a[0]+o[0],y:s.y*a[1]+o[1],width:s.width*a[0],height:s.height*a[1]},c=Math.min(s.width,s.height)/1e5;for(let i=0;i<t.length;i++){let n=on(t[i],c);if(!n)continue;const s=e.simplify/Math.max(a[0],a[1]);if(s>0&&(n=an(n,s)),!n)continue;const{vertices:h,holes:u,dimensions:d}=Ci.a.flatten(n);for(let t=0;t<h.length;)h[t]=h[t++]*a[0]+o[0],h[t]=h[t++]*a[1]+o[1];if(Yi(h,u),2!==d)throw new Error("Only 2D polygon points are supported");const p=e.bevelSize>0?qi(h,u,e.bevelSize,null,!0):h,f=Gi(p,u,d),m=en(h,u,e.smoothSide,e.smoothSideThreshold);r.push({indices:f,vertices:m.vertices,rawVertices:h,topVertices:p,holes:m.holes,splittedMap:m.splittedMap,rect:l,depth:"function"==typeof e.depth?e.depth(i):e.depth})}return nn(r,e)}function ln(t,e){e=Object.assign({},e);const i=[1/0,1/0],n=[-1/0,-1/0];for(let e=0;e<t.length;e++)cn(t[e],i,n);e.boundingRect=e.boundingRect||{x:i[0],y:i[1],width:n[0]-i[0],height:n[1]-i[1]},$i(e);const r=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);const o=[];for(let i=0;i<t.length;i++){let n=t[i];const a=e.simplify/Math.max(r[0],r[1]);a>0&&(n=Li(n,a,!0)),o.push(rn(n,i,e))}return nn(o,e)}function cn(t,e,i){for(let n=0;n<t.length;n++)e[0]=Math.min(t[n][0],e[0]),e[1]=Math.min(t[n][1],e[1]),i[0]=Math.max(t[n][0],i[0]),i[1]=Math.max(t[n][1],i[1])}const hn=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function un(t){return t.geometry?t.geometry.type:null}function dn(t){const e=un(t);if(e)for(let t=0,i=hn.length;t<i;t++)if(hn[t]===e)return!0;return!1}function pn(t){const e=un(t);return!(!e||e!==hn[4]&&e!==hn[5])}function fn(t){const e=un(t);return!(!e||e!==hn[2]&&e!==hn[3])}function mn(t){const e=un(t);return!(!e||e!==hn[0]&&e!==hn[1])}function gn(t){const e=un(t);return!!(e&&e.indexOf("Multi")>-1)}function yn(t){return t.geometry?t.geometry.coordinates:[]}function _n(t){const e=un(t);if(!e||!t.geometry)return null;const i=t.geometry.coordinates;if(!i)return null;const n=[];switch(e){case"Point":n.push(i);break;case"MultiPoint":case"LineString":for(let t=0,e=i.length;t<e;t++)n.push(i[t]);break;case"MultiLineString":case"Polygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,r=i[t].length;e<r;e++)n.push(i[t][e]);break;case"MultiPolygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,r=i[t].length;e<r;e++)for(let r=0,o=i[t][e].length;r<o;r++)n.push(i[t][e][r])}let r=1/0,o=1/0,a=-1/0,s=-1/0;for(let t=0,e=n.length;t<e;t++){const e=n[t],i=e[0],l=e[1];r=Math.min(r,i),o=Math.min(o,l),a=Math.max(a,i),s=Math.max(s,l)}return new Ve.d((r+a)/2,(o+s)/2)}function vn(t){const e=un(t);if(!e||!t.geometry)return null;const i=t.geometry,n=t.properties||{},r=i.coordinates;if(!r)return null;const o=[];let a;switch(e){case"MultiPoint":a="Point";break;case"MultiLineString":a="LineString";break;case"MultiPolygon":a="Polygon"}if(a)for(let t=0,e=r.length;t<e;t++)o.push({type:"Feature",geometry:{type:a,coordinates:r[t]},properties:n});else o.push(t);return o}function xn(t,e,i){const n=[],r=[];if(Array.isArray(t)&&t[0]instanceof Re.Vector3)for(let e=0,i=t.length;e<i;e++){const i=t[e];n.push(i.x,i.y,i.z),r.push(i)}else{Array.isArray(t)&&(t=new Ve.i(t));const o=0;let a,s;dn(t)?(a=yn(t),s=_n(t)):t instanceof Ve.i&&(a=t.getCoordinates(),s=t.getCenter());const l=e.coordinateToVector3(i||s);for(let t=0,i=a.length;t<i;t++){let i=a[t];Array.isArray(i)&&(i=new Ve.d(i));const s=e.coordinateToVector3(i,o).sub(l);n.push(s.x,s.y,s.z),r.push(s)}}return{positions:n,positionsV:r}}function bn(t,e,i,n){const r=[],o=[],a=[];for(let e=0,i=t.length;e<i;e++){const i=t[e];for(let t=0,e=i.length;t<e;t++){const e=i[t];if(a.length>0){e.join(",").toString()!==a[a.length-1].join(",").toString()&&a.push(e)}else a.push(e)}}for(let t=0,s=a.length;t<s;t++){const s=a[t];let l;const c=s.join(",").toString();l=i&&i[c]?i[c]:e.coordinateToVector3(s,0).sub(n),o.push(l),r.push(l.x,l.y,l.z)}return{positions:r,positionsV:o,lnglats:a}}function wn(t,e=1,i=1,n,r){const o=xn(t,n,r).positionsV,a=[];for(let t=0,e=o.length;t<e;t++){const e=o[t];a.push([e.x,e.y])}const{indices:s,position:l,normal:c,uv:h}=ln([a],{lineWidth:e,depth:i});return{position:l,normal:c,indices:s,uv:h}}function Mn(t){let e,i=[];return t instanceof Ve.k?(i=t.getGeometries(),e=t.getCenter()):t instanceof Ve.i?(i.push(t),e=t.getCenter()):dn(t)&&(e=_n(t),gn(t)?i=vn(t):i.push(t)),{lineStrings:i,center:e}}const Tn={altitude:0,bottomHeight:0,colors:null};var Sn=class extends ai{constructor(t,e,i,n){e=Ve.o.extend({},Tn,e,{layer:n,lineString:t}),super(),this._initOptions(e);const{lineStrings:r,center:o}=Mn(t),a=[];for(let t=0,e=r.length;t<e;t++){const e=r[t],{positionsV:i}=xn(e,n,o);for(let t=0,e=i.length;t<e;t++){const n=i[t];t>0&&t<e-1&&a.push(n.x,n.y,n.z),a.push(n.x,n.y,n.z)}}const s=new Re.BufferGeometry;Ze(s,"position",new Re.Float32BufferAttribute(a,3)),Si(s,e.bottomHeight,n);const l=function(t){const e=[];return t&&t.length&&t.forEach(t=>{t=t instanceof Re.Color?t:new Re.Color(t),e.push(t.r,t.g,t.b)}),e}(e.colors);l&&l.length&&(Ze(s,"color",new Re.Float32BufferAttribute(l,3)),i.vertexColors=We()),this._createLineSegments(s,i);const{altitude:c}=e,h=n.distanceToVector3(c,c).x,u=n.coordinateToVector3(o,h);this.getObject3d().position.copy(u),this.type="Line"}};const En=new Re.Color("#fff"),Cn=new Re.Color("#fff");function An(t,e,i,n,r){const o=Ln(t,i,n);if(!o)return null;r?(null==r[e]&&(r[e]=i.distanceToVector3(e,e).x),e=r[e]):e=i.distanceToVector3(e,e).x;const{position:a,normal:s,uv:l,indices:c}=sn(o,{depth:e});return{position:a,normal:s,uv:l,indices:c}}function Pn(t,e,i,n){void 0===n&&(n=0);const r=t.attributes.position.array,o=r.length;Cn.setStyle(e),En.setStyle(i);const a=[];if(Array.isArray(n))for(let t=0,e=n.length;t<e;t++){const{middleZ:e,start:i,end:o}=n[t].position;for(let t=i;t<o;t+=3){r[t+2]>e?(a[t]=En.r,a[t+1]=En.g,a[t+2]=En.b):(a[t]=Cn.r,a[t+1]=Cn.g,a[t+2]=Cn.b)}}else for(let t=0;t<o;t+=3){r[t+2]>n?a.push(En.r,En.g,En.b):a.push(Cn.r,Cn.g,Cn.b)}return Ze(t,"color",new Re.Float32BufferAttribute(a,3,!0)),a}function Ln(t,e,i,n=!1){if(!t)return null;let r=[];if(t instanceof Ve.l)r=t.getGeometries().map(r=>In(r,e,i||t.getCenter(),n));else if(t instanceof Ve.m){const o=In(t,e,i||t.getCenter(),n);r.push(o)}else if(pn(t)){const o=_n(t);if(gn(t)){const a=vn(t);for(let t=0,s=a.length;t<s;t++)r.push(In(a[t],e,i||o,n))}else{const a=In(t,e,i||o,n);r.push(a)}}return r}function In(t,e,i,n=!1){let r,o;if(pn(t)){const e=yn(t);r=e[0],o=e.slice(1,e.length),i=i||_n(t)}else t instanceof Ve.m&&(r=t.getShell(),o=t.getHoles(),i=i||t.getCenter());const a=e.coordinateToVector3(i);let s;s=n?new Float32Array(2*r.length):[];for(let t=0,i=r.length;t<i;t++){const i=r[t],o=e.coordinateToVector3(i).sub(a);if(n){const e=2*t;s[e]=o.x,s[e+1]=o.y}else s.push([o.x,o.y])}const l=[n?s.buffer:s];if(o&&o.length>0)for(let t=0,i=o.length;t<i;t++){const i=n?new Float32Array(2*o[t].length):[];for(let r=0,s=o[t].length;r<s;r++){const s=o[t][r],l=e.coordinateToVector3(s).sub(a);if(n){const t=2*r;i[t]=l.x,i[t+1]=l.y}else i.push([l.x,l.y])}l.push(n?i.buffer:i)}return l}const Rn={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};var Dn=class extends ai{constructor(t,e,i,n){e=Ve.o.extend({},Rn,e,{layer:n,lineString:t}),super(),this._initOptions(e);const{height:r,width:o,bottomColor:a,topColor:s,bottomHeight:l,altitude:c}=e,h=n.distanceToVector3(r,r).x,u=n.distanceToVector3(o,o).x,{lineStrings:d,center:p}=Mn(t),f=[];let m=0;const g={};for(let t=0,e=d.length;t<e;t++){const e=wn(d[t],u,h,n,p);m=Si(e,l,n,g),f.push(e)}const y=si(f);s&&(Pn(y,a,s,m+h/2),i.vertexColors=We()),this._createMesh(y,i);const _=n.distanceToVector3(c,c).x,v=n.coordinateToVector3(p,_);this.getObject3d().position.copy(v),this.type="ExtrudeLine"}};const kn={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"};var On=class extends ai{constructor(t,e,i,n){e=Ve.o.extend({},kn,e,{layer:n,polygon:t}),super(),this._initOptions(e);const{height:r,topColor:o,bottomColor:a,altitude:s,bottomHeight:l}=e,c=function(t,e,i,n){const{position:r,normal:o,uv:a,indices:s}=An(t,e,i,n),l=new Float32Array(r.length);l.fill(1,0,r.length);const c=new Re.BufferGeometry;return Ze(c,"color",new Re.BufferAttribute(l,3)),Ze(c,"normal",new Re.BufferAttribute(o,3)),Ze(c,"position",new Re.BufferAttribute(r,3)),Ze(c,"uv",new Re.BufferAttribute(a,2)),c.setIndex(new Re.Uint32BufferAttribute(s,1)),c}(t,r,n),h=pn(t)?_n(t):t.getCenter(),u=Si(c,l,n);if(o){Pn(c,a,o,u+n.distanceToVector3(r,r).x/2),i.vertexColors=We()}this._createMesh(c,i);const d=n.distanceToVector3(s,s).x,p=n.coordinateToVector3(h,d);this.getObject3d().position.copy(p),this.type="ExtrudePolygon"}};const zn={altitude:0,coordinate:null};var Bn=class extends ai{constructor(t,e={},i){e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=i.getMap().getCenter()),e=Ve.o.extend({},zn,e,{layer:i,model:t}),super(),this._initOptions(e),this._createGroup(),this.getObject3d().add(t);const{altitude:n,coordinate:r}=e,o=i.distanceToVector3(n,n).x,a=i.coordinateToVector3(r,o);this.getObject3d().position.copy(a),this.type="Model"}};const Fn=Math.PI/180;function Nn(t){return t.getCoordinates().map(t=>t.toArray())}function jn(t){return t*Fn}function Gn(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());let i=jn(t[1]);const n=jn(e[1]),r=i-n,o=jn(t[0])-jn(e[0]);return i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(i)*Math.cos(n)*Math.pow(Math.sin(o/2),2))),i*=6378137,Math.round(1e5*i)/1e5}function Un(t,e){const{len:i,c1:n,c2:r}=t,o=r[0]-n[0],a=r[1]-n[1],s=e/i;return[n[0]+s*o,n[1]+s*a]}function Vn(t,e,i,n){const r=e.length;t.attributes.normal.count=r,t.attributes.position.count=r;const o=t.attributes.position.array,a=t.attributes.normal.array;for(let t=0;t<r;t++)o[t]=e[t],a[t]=i[t];t.index.count=n.length;for(let e=0,i=n.length;e<i;e++)t.index.array[e]=n[e]}const Hn={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1};var Zn=class extends ai{constructor(t,e,i,n){e=Ve.o.extend({},Hn,e,{layer:n,lineString:t}),super(),this._initOptions(e);const{width:r,height:o,altitude:a,speed:s,chunkLength:l,trail:c}=e;let h,u;dn(t)?(h=_n(t),u=yn(t)):(h=t.getCenter(),u=t);const d=function(t,e=10){e=Math.max(e,1),Array.isArray(t)||(t=Nn(t));const i=t.length;let n=[],r=0;for(let e=0;e<i-1;e++){const i=Gn(t[e],t[e+1]),o=Math.floor(i);n.push({c1:t[e],len:o,c2:t[e+1]}),r+=o}if(r<=e){return n.map(t=>[t.c1,t.c2])}if(1===n.length&&n[0].len<=e)return[[n[0].c1,n[0].c2]];const o=n.length;let a,s=0,l=0;const c=[];let h=[n[0].c1];for(;s<o;){const{len:t,c2:i}=n[s];if(l+=t,l<e&&(h.push(i),s===o-1&&c.push(h),s++),l===e&&(h.push(i),l=0,c.push(h),h=[i],s++),l>e){const i=t-l+e;a=Un(n[s],i),h.push(a),c.push(h),l=0,n[s].c1=a,n[s].len=t-i,h=[],h.push(a)}}return c}(u,l),p=n.coordinateToVector3(h),f={};for(let t=0,e=d.length;t<e;t++){const e=d[t];for(let t=0,i=e.length;t<i;t++){const i=e[t],r=i.join(",").toString();f[r]||(f[r]=n.coordinateToVector3(i).sub(p))}}const m=bn(d.slice(0,1),n,f,p).positionsV,g=new Re.BufferGeometry,y=new Float32Array(3e3),_=new Float32Array(3e3),v=new Uint16Array(1e3);Ze(g,"position",new Re.BufferAttribute(y,3)),Ze(g,"normal",new Re.BufferAttribute(_,3)),g.setIndex(new Re.BufferAttribute(v,1));const x=n.distanceToVector3(r,r).x,b=n.distanceToVector3(o,o).x,w=wn(m,x,b,n);Vn(g,w.position,w.normal,w.indices),this._createMesh(g,i);const M=n.distanceToVector3(a,a).x,T=n.coordinateToVector3(h,M);this.getObject3d().position.copy(T),this._params={index:0,chunkLines:d,geometries:[],layer:n,trail:Math.max(1,c),lineWidth:x,depth:b,speed:Math.min(1,s),idx:0,loaded:!1,positionMap:f,centerPt:p},this._init(this._params),this.type="ExtrudeLineTrail"}_init(t){const{layer:e,trail:i,lineWidth:n,depth:r,chunkLines:o,positionMap:a,centerPt:s}=t,l=o.length,c=[];for(let t=0;t<l;t++){const l=bn(o.slice(t,t+i),e,a,s).positionsV;c.push(wn(l,n,r,e))}this._params.geometries=c,this._params.loaded=!0}_animation(){const{index:t,geometries:e,speed:i,idx:n,chunkLines:r,trail:o,lineWidth:a,depth:s,loaded:l,layer:c,positionMap:h,centerPt:u}=this._params;if(!l)return;const d=Math.round(t);if(d>n){this._params.idx++;let t=e[d];if(!t){t=wn(bn(r.slice(d,d+o),c,h,u).positionsV,a,s,c),e[d]=t}const i=this.getObject3d();Vn(i.geometry,t.position,t.normal,t.indices),i.geometry.attributes.position.needsUpdate=!0,i.geometry.attributes.normal.needsUpdate=!0,i.geometry.index.needsUpdate=!0}t>=r.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=i}};const Wn=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),qn=new Re.MeshBasicMaterial;qn.vertexColors=We();var Xn=t=>class extends t{_initBaseObjectsEvent(t){if(t&&Array.isArray(t)&&t.length)for(let e=0,i=t.length;e<i;e++){const i=t[e];this._proxyEvent(i)}return this}_proxyEvent(t){t.on("add",t=>{this._showGeometry(t.target,!0)}),t.on("remove",t=>{this._showGeometry(t.target,!1)}),t.on("mouseout",t=>{this._mouseover=!1,this.fire("mouseout",Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))}),t.on(Wn,t=>{this.fire(t.type,Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))})}_getHideGeometryIndex(t){const e=[];let i=0;for(let n=0,r=this._geometriesAttributes.length;n<r;n++)!0===this._geometriesAttributes[n].hide&&(e.push(n),i+=this._geometriesAttributes[n][t].count);return{indexs:e,count:i}}_updateAttribute(t,e){const{indexs:i}=this._getHideGeometryIndex(e),n=this._geometryCache.attributes[e].array,r=n.length;for(let e=0;e<r;e++)t.array[e]=n[e];let o=NaN;this.getObject3d()instanceof Re.LineSegments&&(o=0);for(let n=0;n<i.length;n++){const r=i[n],{start:a,end:s}=this._geometriesAttributes[r][e];for(let e=a;e<s;e++)t.array[e]=o}return this}_showGeometry(t,e){let i;if(t&&(i=t.getOptions().index),null!=i){const t=this._geometriesAttributes[i],{hide:n}=t;if(n===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.position,"position"),r.attributes.position.needsUpdate=!0,this.isHide=e}return this}getSelectMesh(){const t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}}_getIndex(t){return null==t&&(t=this.faceIndex||this.index),t}_init(){const t=this.getLayer().getPick();this.on("add",()=>{t.add(this.pickObject3d)}),this.on("remove",()=>{t.remove(this.pickObject3d)})}_setPickObject3d(){const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:i}=this,n=[];for(let t=0,r=i.length;t<r;t++){const r=e.getColor(),o=r.getHex();this._colorMap[o]=t;const{count:a}=i[t].position;this._datas[t].colorIndex=o;for(let t=0;t<a;t++)n.push(r.r,r.g,r.b)}Ze(t,"color",new Re.Float32BufferAttribute(n,3,!0));const r=e.getColor().getHex(),o=new Re.Mesh(t,qn);o.position.copy(this.getObject3d().position),o._colorIndex=r,this.setPickObject3d(o)}};let Yn;var $n;function Jn(){return Ve.t||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),$n||($n=new Yn("__maptalks.three__")),$n}Ve.t&&(Yn=class extends Ve.t.Actor{test(t,e){this.send(t,null,e)}pushQueue(t={}){const{type:e,data:i,callback:n,layer:r,key:o,center:a,lineStrings:s}=t;let l;"Polygon"===e?l=function(t=[],e,i){const n=t.length,r=[],o=[],a={};for(let s=0;s<n;s++){const n=t[s],l=Ln(n,i,e,!0);for(let t=0,e=l.length;t<e;t++){const e=l[t];for(let t=0,i=e.length;t<i;t++)o.push(e[t])}const c=pn(n)?n.properties:n.getProperties()||{};let h=c.height||1,u=c.bottomHeight||0;void 0!==u&&"number"==typeof u&&0!==u&&(void 0===a[u]&&(a[u]=i.distanceToVector3(u,u).x),u=a[u]),void 0===a[h]&&(a[h]=i.distanceToVector3(h,h).x),h=a[h],r.push({data:l,height:h,bottomHeight:u})}return{datas:r,transfer:o}}(i,a,r):"LineString"===e&&(l=function(t,e,i,n){const r=[],o=[],a={},s=t.length;for(let l=0;l<s;l++){const s=t[l],c=fn(n[l])?n[l].properties:n[l].getProperties()||{},h=c.width||1,u=c.height||1;let d=c.bottomHeight||0;void 0!==d&&"number"==typeof d&&0!==d&&(void 0===a[d]&&(a[d]=i.distanceToVector3(d,d).x),d=a[d]),void 0===a[u]&&(a[u]=i.distanceToVector3(u,u).x),void 0===a[h]&&(a[h]=i.distanceToVector3(h,h).x);const p=[];for(let t=0,n=s.length;t<n;t++){const n=xn(s[t],i,e).positionsV,r=new Float32Array(2*n.length);for(let t=0,e=n.length;t<e;t++)r[2*t]=n[t].x,r[2*t+1]=n[t].y;o.push(r),p.push(r)}r.push({data:p,height:a[u],width:a[h],bottomHeight:d})}return{datas:r,transfer:o}}(i,a,r,s)),this.send({type:e,datas:l.datas},l.transfe,(function(t,e){t&&console.error(t),e.key=o,n(e)}))}});const Kn={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"};class Qn extends(Xn(ai)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=t.length;0===r&&console.error("polygons is empty");let o=1/0,a=1/0,s=-1/0,l=-1/0;for(let e=0;e<r;e++){const i=t[e],n=i.getCenter?i.getCenter():_n(i);let r,c;Array.isArray(n)?(r=n[0],c=n[1]):n instanceof Ve.d&&(r=n.x,c=n.y),o=Math.min(o,r),a=Math.min(a,c),s=Math.max(s,r),l=Math.max(l,c)}const c=new Ve.d((o+s)/2,(a+l)/2);e=Ve.o.extend({},Kn,e,{layer:n,polygons:t,coordinate:c});const{topColor:h,bottomColor:u,altitude:d,asynchronous:p}=e;let f;const m=[],g=[],y=[];if(p){var _=Jn();f=di(),_.pushQueue({type:"Polygon",layer:n,key:e.key,center:c,data:t,callback:t=>{const{faceMap:e,geometriesAttributes:n}=t;this._faceMap=e,this._geometriesAttributes=n;const r=hi(t);h&&(Pn(r,u,h,n),i.vertexColors=We());const o=this.getObject3d();if(o.geometry=r,o.material.needsUpdate=!0,this._geometryCache=r.clone(),this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}})}else{const e=[];let o=0,a=0,s=0,l=0;const d={};for(let i=0;i<r;i++){const r=t[i],h=pn(r)?r.properties:r.getProperties()||{},u=h.height||1,p=h.bottomHeight||0,f=An(r,u,n,c,d);e.push(f);const m=Si(f,p,n,d),{position:_,normal:v,uv:x,indices:b}=f,w=b.length/3;g[i]=[o+1,o+w],o+=w;const M=_.length/3,T=v.length/3,S=x.length/2;y[i]={position:{middleZ:m+d[u]/2,count:M,start:a,end:a+3*M},normal:{count:T,start:s,end:s+3*T},uv:{count:S,start:l,end:l+2*S},hide:!1},a+=3*M,s+=3*T,l+=2*S}f=si(e),h&&(Pn(f,u,h,y),i.vertexColors=We())}super(),this._initOptions(e),this._createMesh(f,i);const v=n.distanceToVector3(d,d).x,x=n.coordinateToVector3(c,v);this.getObject3d().position.copy(x),this._faceMap=g,this._baseObjects=m,this._datas=t,this._geometriesAttributes=y,this.faceIndex=null,this._geometryCache=f.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(m),p||(this._setPickObject3d(),this._init()),this.type="ExtrudePolygons"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],i=Object.assign({},this.options,pn(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new On(e,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}}var tr=Qn;function er(t,e,i){const n=t.project(i),r=e.width/2,o=e.height/2;return{x:Math.round(n.x*r+r),y:Math.round(-n.y*o+o)}}const ir={altitude:0,height:0,color:null},nr=new Re.Vector3;var rr=class extends ai{constructor(t,e,i,n){e=Ve.o.extend({},ir,e,{layer:n,coordinate:t}),super();let{height:r,altitude:o,color:a,size:s}=e;const l=[],c=[];a&&(a=a instanceof Re.Color?a:new Re.Color(a),c.push(a.r,a.g,a.b));const h=n.distanceToVector3(r,r).x,u=n.coordinateToVector3(t,h);l.push(0,0,u.z);const d=new Re.BufferGeometry;Ze(d,"position",new Re.Float32BufferAttribute(l,3,!0)),c.length&&Ze(d,"color",new Re.Float32BufferAttribute(c,3,!0)),void 0!==s&&Ze(d,"size",new Re.Float32BufferAttribute([s],1,!0)),e.positions=u,this._initOptions(e),this._createPoints(d,i);const p=n.distanceToVector3(o,o).x,f=new Re.Vector3(u.x,u.y,p);this.getObject3d().position.copy(f),this.type="Point"}identify(t){const e=this.getLayer(),i=this.getMap().getSize(),n=this.getLayer().getCamera(),r=this.getOptions().positions,o=this.getOptions().altitude;let a=this.getObject3d().material.size;void 0===a&&(a=this.options.size||1);const s=this.getMap().coordToContainerPoint(t),l=e.distanceToVector3(o,o).x;nr.x=r.x,nr.y=r.y,nr.z=r.z+l;const c=er(nr,i,n);return Math.sqrt(Math.pow(s.x-c.x,2)+Math.pow(s.y-c.y,2))<=a/2}};function or(t,e){const{minx:i,miny:n,maxx:r,maxy:o}=t,[a,s]=e;return i<=a&&a<=r&&n<=s&&s<=o}class ar{constructor(t,e,i,n){this.minlng=t,this.minlat=e,this.maxlng=i,this.maxlat=n,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}updateBBoxPixel(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;const{minlng:o,minlat:a,maxlng:s,maxlat:l}=this;return[[o,a],[o,l],[s,a],[s,l]].map(t=>new Ve.d(t)).map(e=>t.coordToContainerPoint(e)).forEach(t=>{e=Math.min(e,t.x),i=Math.min(i,t.y),n=Math.max(n,t.x),r=Math.max(r,t.y)}),this.minx=e,this.miny=i,this.maxx=n,this.maxy=r,this}containsCoordinate(t){let e,i;Array.isArray(t)?(e=t[0],i=t[1]):t instanceof Ve.d&&(e=t.x,i=t.y);const{minlng:n,minlat:r,maxlng:o,maxlat:a}=this;return n<=e&&e<=o&&r<=i&&i<=a}isRecCross(t,e){const{x:i,y:n}=t,r={minx:i-e/2,miny:n-e/2,maxx:i+e/2,maxy:n+e/2},{minx:o,miny:a,maxx:s,maxy:l}=r;return!!(or(this,[o,a])||or(this,[o,l])||or(this,[s,a])||or(this,[s,l])||or(r,[this.minx,this.miny])||or(r,[this.minx,this.maxy])||or(r,[this.maxx,this.miny])||or(r,[this.maxx,this.maxy]))}static initGrids(t,e,i,n){const r=[],o=(i-t)/30,a=(n-e)/30;let s=t,l=e;for(let i=0;i<30;i++){s=t+i*o;for(let t=0;t<30;t++){l=e+t*a;const n=new ar(s,l,s+o,l+a);n.key=t+"-"+i,r.push(n)}}return r}}var sr=ar;const lr={altitude:0},cr=new Re.Vector3;class hr extends(Xn(ai)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]),e=Ve.o.extend({},lr,e,{layer:n,points:t});let r=1/0,o=1/0,a=-1/0,s=-1/0;for(let e=0,i=t.length;e<i;e++){const{coordinate:i}=t[e];let n,l;Array.isArray(i)?(n=i[0],l=i[1]):i instanceof Ve.d&&(n=i.x,l=i.y),r=Math.min(r,n),o=Math.min(o,l),a=Math.max(a,n),s=Math.max(s,l)}const l=n.coordinateToVector3([(r+a)/2,(o+s)/2]),c=sr.initGrids(r,o,a,s),h=c.length,u=[],d=[],p=[],f=[],m=[],g=[],y={};let _=0;for(let e=0,i=t.length;e<i;e++){let{coordinate:i,height:r,color:o,size:a}=t[e];o&&(o=o instanceof Re.Color?o:new Re.Color(o),p.push(o.r,o.g,o.b)),a&&(f.push(a),_=Math.max(_,a));const s=Mi(r,n,y),m=n.coordinateToVector3(i,s),v=m.clone().sub(l);u.push(v.x,v.y,v.z),d.push(m),g[e]={position:{count:1,start:3*e,end:3*e+3},hide:!1};for(let t=0;t<h;t++)if(c[t].containsCoordinate(i)){c[t].positions.push(m),c[t].indexs.push(e);break}}const v=new Re.BufferGeometry;Ze(v,"position",new Re.Float32BufferAttribute(u,3,!0)),p.length&&Ze(v,"color",new Re.Float32BufferAttribute(p,3,!0)),f.length&&Ze(v,"size",new Re.Float32BufferAttribute(f,1,!0)),e.positions=d,super(),this._initOptions(e),this._createPoints(v,i);const x=e.altitude,b=n.distanceToVector3(x,x).x,w=l.clone();w.z=b,this.getObject3d().position.copy(w),this._baseObjects=m,this._datas=t,this.faceIndex=null,this._geometriesAttributes=g,this._geometryCache=v.clone(),this.isHide=!1,this._initBaseObjectsEvent(m),this._grids=c,this._bindMapEvents(),this.type="Points",this.maxSize=_}_bindMapEvents(){const t=this.getMap(),e="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",()=>{this._updateGrids(),t.on(e,this._updateGrids,this)}),this.on("remove",()=>{t.off(e,this._updateGrids,this)})}_updateGrids(){const t=this.getMap();this._grids.forEach(e=>{e.indexs.length&&e.updateBBoxPixel(t)})}getSelectMesh(){const t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],{coordinate:i,height:n,color:r,size:o}=e;this._baseObjects[t]=new rr(i,{height:n,index:t,color:r,size:o},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){const e=this.getLayer(),i=this.getMap().getSize(),n=this.getLayer().getCamera(),r=this.getOptions().altitude,o=this.getMap(),a=e.distanceToVector3(r,r).x;let s=this.getObject3d().material.size;const l=void 0===s,c=o.coordToContainerPoint(t),h=[];if(this._grids.forEach(t=>{t.indexs.length&&t.isRecCross(c,l?this.maxSize:s)&&h.push(t)}),h.length<1)return!1;for(let t=0,e=h.length;t<e;t++)for(let e=h[t].positions.length-1;e>=0;e--){l&&(s=this._datas[h[t].indexs[e]].size||1);const r=h[t].positions[e];cr.x=r.x,cr.y=r.y,cr.z=r.z+a;const o=er(cr,i,n);if(Math.sqrt(Math.pow(c.x-o.x,2)+Math.pow(c.y-o.y,2))<=s/2)return this.faceIndex=h[t].indexs[e],!0}return!1}}var ur=hr;const dr={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};class pr extends(Xn(ai)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=t.length,o=Ti(t),a=n.coordinateToVector3(o),s=[],l=[],c=[],h=[];let u=0,d=0,p=0,f=0;const m={};for(let e=0;e<r;e++){const r=Ve.o.extend({index:e},dr,t[e]),{radius:o,radialSegments:g,altitude:y,topColor:_,bottomColor:v,height:x,coordinate:b}=r,w=Mi(o,n,m),M=Mi(x,n,m),T=Mi(y,n,m),S=yi({radius:w,height:M,radialSegments:g});_&&(_i(S,v,_,"z",M/2),i.vertexColors=We());const E=n.coordinateToVector3(b).sub(a),C=S.attributes.position.array;for(let t=0,e=C.length;t<e;t+=3)C[t+2]+=T,C[t]+=E.x,C[t+1]+=E.y,C[t+2]+=E.z;s.push(S);const A=new wi(b,r,i,n);l.push(A);const P=S.index.count/3;h[e]=[u+1,u+P],u+=P;const L=S.attributes.position.count,I=S.attributes.normal.count,R=S.attributes.uv.count;c[e]={position:{count:L,start:d,end:d+3*L},normal:{count:I,start:p,end:p+3*I},uv:{count:R,start:f,end:f+2*R},hide:!1},d+=3*L,p+=3*I,f+=2*R}super(),e=Ve.o.extend({},{altitude:0,layer:n,points:t},e),this._initOptions(e);const g=vi(s);this._createMesh(g,i);const y=e.altitude,_=n.distanceToVector3(y,y).x,v=a.clone();v.z=_,this.getObject3d().position.copy(v),this._faceMap=h,this._baseObjects=l,this._datas=t,this._geometriesAttributes=c,this.faceIndex=null,this._geometryCache=g.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(l),this._setPickObject3d(),this._init(),this.type="Bars"}identify(){return this.picked}}var fr=pr;const mr={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};class gr extends(Xn(ai)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=[],o=[],a=t.length;for(let e=0;e<a;e++){const i=Mn(t[e]);r.push(i.center),o.push(i.lineStrings)}const s=Ti(r);e=Ve.o.extend({},mr,e,{layer:n,lineStrings:t,coordinate:s});const{altitude:l,topColor:c,bottomColor:h,asynchronous:u}=e;let d;const p=[],f=[];if(u){var m=Jn();d=di(),m.pushQueue({type:"LineString",layer:n,key:e.key,center:s,data:o,lineStrings:t,callback:t=>{const{faceMap:e,geometriesAttributes:n}=t;this._faceMap=e,this._geometriesAttributes=n;const r=hi(t);if(c&&(Pn(r,h,c,n),i.vertexColors=We()),this.getObject3d().geometry=r,this.getObject3d().material.needsUpdate=!0,this._geometryCache=r.clone(),this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}})}else{const e=[];let r=0,l=[],u=0,p=0;const m={};for(let i=0;i<a;i++){const a=t[i],c=Ve.o.extend({},mr,dn(a)?a.properties:a.getProperties(),{index:i}),{height:h,width:d,bottomHeight:g}=c,y=Mi(d,n,m),_=Mi(h,n,m),v=o[i],x=[];let b=0;for(let t=0,e=v.length;t<e;t++){const e=wn(v[t],y,_,n,s);b=Si(e,g,n,m),x.push(e)}const w=li(x);e.push(w);const{position:M,normal:T,indices:S}=w,E=S.length/3;l[i]=[r+1,r+E],r+=E;const C=M.length/3,A=T.length/3;f[i]={position:{middleZ:b+_/2,count:C,start:u,end:u+3*C},normal:{count:A,start:p,end:p+3*A},hide:!1},u+=3*C,p+=3*A}d=si(e),c&&(Pn(d,h,c,f),i.vertexColors=We())}super(),this._initOptions(e),this._createMesh(d,i);const g=n.distanceToVector3(l,l).x,y=n.coordinateToVector3(s,g);this.getObject3d().position.copy(y),this._faceMap=[],this._baseObjects=p,this._datas=t,this._geometriesAttributes=f,this.faceIndex=null,this._geometryCache=d.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(p),u||(this._setPickObject3d(),this._init()),this.type="ExtrudeLines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],i=Object.assign({},this.options,fn(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new Dn(e,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}}var yr=gr;const _r={altitude:0,colors:null};class vr extends(Xn(ai)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=[],o=[],a=t.length;for(let e=0;e<a;e++){const i=Mn(t[e]);r.push(i.center),o.push(i.lineStrings)}const s=Ti(r);e=Ve.o.extend({},_r,e,{layer:n,lineStrings:t,coordinate:s});const l=[],c={};let h=0,u=[],d=[],p=0,f=[];for(let t=0;t<a;t++){const e=o[t];let i=0;for(let t=0,r=e.length;t<r;t++){const r=fn(e[t])?e[t].properties:e[t].getProperties()||{},{positionsV:o}=xn(e[t],n,s);Si(o,r.bottomHeight,n,c),i+=2*o.length-2;for(let t=0,e=o.length;t<e;t++){const i=o[t];t>0&&t<e-1&&f.push(i.x,i.y,i.z),f.push(i.x,i.y,i.z)}}const r=i;u[t]=[h,h+r],h+=r,d[t]={position:{count:i,start:p,end:p+3*i},hide:!1},p+=3*i}const m=new Re.BufferGeometry;Ze(m,"position",new Re.Float32BufferAttribute(f,3)),super(),this._initOptions(e),this._createLineSegments(m,i);const{altitude:g}=e,y=n.distanceToVector3(g,g).x,_=n.coordinateToVector3(s,y);this.getObject3d().position.copy(_),this._faceMap=u,this._baseObjects=l,this._datas=t,this._geometriesAttributes=d,this.faceIndex=null,this.index=null,this._geometryCache=m.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(l),this._setPickObject3d(),this._init(),this.type="Lines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],i=Ve.o.extend({},this.getOptions(),{index:t},fn(e)?e.properties:e.getProperties());this._baseObjects[t]=new Sn(e,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_setPickObject3d(){const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:i}=this,n=[];for(let t=0,r=i.length;t<r;t++){const r=e.getColor(),o=r.getHex();this._colorMap[o]=t;const{count:a}=i[t].position;this._datas[t].colorIndex=o;for(let t=0;t<a;t++)n.push(r.r,r.g,r.b)}Ze(t,"color",new Re.Float32BufferAttribute(n,3,!0));const r=this.getObject3d().material.clone();r.color.set("#fff"),r.vertexColors=We();const o=e.getColor().getHex(),a=new Re.LineSegments(t,r);a.position.copy(this.getObject3d().position),a._colorIndex=o,this.setPickObject3d(a)}identify(t){return this.picked}}var xr=vr;const br=[],wr=[];function Mr(t,e){for(let i=0,n=t.length;i<n;i++){const n=t[i];if(n){const{key:r,callback:o}=n;if(e===r)return t.splice(i,1),o}}return null}const Tr=document.createElement("canvas");function Sr(t,e=!1){const i=Tr.getContext("2d");if(i.clearRect(0,0,256,256),i.save(),e){i.fillStyle="red",i.strokeStyle="rgba(255,0,0,0.4)",i.lineWidth=.2;const e=t||"tile";i.font="18px sans-serif",i.rect(0,0,256,256),i.stroke(),i.fillText(e,15,128)}return Tr.toDataURL()}function Er(t=1,e=1){let i;return"undefined"==typeof document||(i=document.createElement("canvas"),t&&(i.width=t),e&&(i.height=e)),i}Tr.width=Tr.height=256;class Cr extends Ve.n{constructor(t,e={}){super(Ve.o.GUID(),Ve.o.extend({urlTemplate:t},e)),this._opts=null,this._layer=null,this.material=null,this.getMaterial=null,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime()}isAsynchronous(){return this._opts.worker}getBaseObjects(){const t=this._loadTiles,e=[];for(let i in t){const t=this._baseObjectKeys[i];if(t&&Array.isArray(t)&&t.length)for(let i=0,n=t.length;i<n;i++)e.push(t[i])}return e}onSelectMesh(t,e){}formatBaseObjects(t,e){return[]}loopMessage(t){}getTileData(t){const{key:e,url:i,callback:n,img:r}=t;Ve.a.getJSON(i,{},(function(t,i){t?(console.error(t),n(e,null,r)):n(e,i,r)}))}_getCurentTileKeys(){const t=this.getTiles().tileGrids||[],e=[],i={};for(let n=0,r=t.length;n<r;n++){const r=t[n].tiles||[];for(let t=0,n=r.length;t<n;t++){const{id:n}=r[t];e.push(n),i[n]=!0}}return{keys:e,keysMap:i}}_isLoad(){const{keys:t}=this._getCurentTileKeys(),e=Object.keys(this._renderer.tilesInView);return t.length===e.length}_layerOnLoad(){const t=(new Date).getTime();if(t-this._layerLaodTime<20)return;this._layerLaodTime=t;const e=this._renderer.tilesInView,i=this._loadTiles,n=this._layer,r=this._baseObjectKeys,o=Object.keys(e).length,a=Object.keys(i).length,s=[];if(o&&a)for(let t in i)e[t]||r[t]&&(r[t]||[]).forEach(t=>{s.push(t)});if(s.length&&n.removeMesh(s,!1),o&&a)for(let t in e)if(!i[t])if(r[t]){const e=r[t];n.addMesh(e)}else{const{x:e,y:i,z:n}=this._getXYZOfIndex(t);this.getTileUrl(e,i,n)}this._loadTiles=Object.assign({},e),this._diffCache()}_init(){}_workerLoad(t){const e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=Sr(e._key,this._opts.debug))}_generateBaseObjects(t,e,i){if(e&&i){const{keysMap:n}=this._getCurentTileKeys();if(!n[t])return void(i.src=Sr(t,this._opts.debug));const r=this.formatBaseObjects(t,e);if(r.length){i.needCount=r.length,i.currentCount=0;for(let e=0,n=r.length;e<n;e++){const n=r[e];n._img=i,n._vt=this,this.isVisible()||n.hide(),this._cachetile(t,n),n.isAsynchronous()||i.currentCount++}this._layer.addMesh(r,!1),i.needCount===i.currentCount&&(i.src=Sr(t,this._opts.debug)),this.isAsynchronous()?r.filter(t=>t.isAsynchronous()).forEach(t=>{t.on("workerload",this._workerLoad,this)}):i.src=Sr(t,this._opts.debug)}else i.src=Sr(t,this._opts.debug);this._loadTiles[t]=!0}else i&&(i.src=Sr(t,this._opts.debug))}_diffCache(){if(Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max){const t=this._renderer.tileCache.data,e=this._renderer.tilesInView,i=[];for(let n in this._baseObjectKeys)t[n]||e[n]||((this._baseObjectKeys[n]||[]).forEach(t=>{t.isAdd&&i.push(t)}),this._diposeBaseObject(n),delete this._baseObjectKeys[n]);i.length&&this._layer.removeMesh(i,!1)}}_diposeBaseObject(t){const e=this._baseObjectKeys[t];e&&e.length&&e.forEach(t=>{t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();const e=t._baseObjects;e&&e.length&&e.forEach(t=>{t.getObject3d().geometry.dispose(),t=null}),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null})}_cachetile(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)}_getXYZOfIndex(t){const e=t.indexOf("_")>-1?"_":"-";let[i,n,r]=t.split(e).slice(1,4);return{x:parseInt(n),y:parseInt(i),z:parseInt(r)}}_getTileExtent(t,e,i){const n=this.getMap()._getResolution(i);return this._getTileConfig().getTilePrjExtent(t,e,n)}_getTileLngLatExtent(t,e,i){const n=this._getTileExtent(t,e,i);let r=n.getMax(),o=n.getMin();const a=this.getMap().getProjection();return o=a.unproject(o),r=a.unproject(r),new Ve.g(o,r)}}var Ar=Cr;const Pr={worker:!1};var Lr=class extends Ar{constructor(t,e={},i,n){super(Ve.o.GUID(),Ve.o.extend({urlTemplate:t},Pr,e)),this._opts=e,this._layer=n,this.getMaterial=i,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime(),this._init()}formatBaseObjects(t,e){const i=this._opts,n=[],r=this.isAsynchronous();for(let o in e){const a=e[o]||{};let s;if(Array.isArray(a)?s=a:"FeatureCollection"===a.type&&(s=a.features),s&&s.length){const e=[],l=[],c=[];for(let t=0,i=s.length;t<i;t++){const i=s[t];if(pn(i))e.push(i);else if(fn(i)){const t=vn(i);for(let e=0,i=t.length;e<i;e++)l.push(t[e])}else if(mn(i)){const t=vn(i);for(let e=0,i=t.length;e<i;e++)c.push(Ve.o.extend({},t[e].properties,t[e],{coordinate:yn(t[e])}))}}if(e.length){const s=this._getMaterial(o,e,t,a);if(s){const a=this._layer.toExtrudePolygons(e,Ve.o.extend({},{topColor:"#fff",layerName:o,asynchronous:r,key:t},i),s);n.push(a)}}if(l.length){const e=this._getMaterial(o,l,t,a);if(e&&(e instanceof Re.LineBasicMaterial||e instanceof Re.LineDashedMaterial)){const t=this._layer.toLines(l,Ve.o.extend({},{layerName:o},i),e);n.push(t)}}if(c.length){const e=this._getMaterial(o,c,t,a);if(e&&e instanceof Re.PointsMaterial){const t=this._layer.toPoints(c,Ve.o.extend({},{layerName:o},i),e);n.push(t)}}}}return n}loopMessage(t){const{currentQueue:e}={waitingQueue:br,currentQueue:wr};e.length>0&&this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval(()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")},1e3)}),this.on("remove",()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)}),this.on("show",()=>{this.getBaseObjects().forEach(t=>{t.show()});for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach(t=>{t.show()})}}),this.on("hide",()=>{this.getBaseObjects().forEach(t=>{t.hide()});for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach(t=>{t.hide()})}}),this.on("renderercreate",t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),i=new Image;return i.width=e.width,i.height=e.height,i.onload=this.onTileLoad.bind(this,i,t),i.onerror=this.onTileError.bind(this,i,t),this.loadTileImage(i,t.url,t.id),i},t.renderer.deleteTile=function(t){if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;!function(t){const e=Mr(br,t);e&&e(t)}((t.info||{}).id)},t.renderer.loadTileImage=(t,e,i)=>{t._key=i,function(t,e,i,n,r){const o={key:t,url:e,callback:i,img:n,vt:r};wr.length<10?(wr.push(o),r.loopMessage(o)):br.push(o)}(i,e,(t,e,i)=>{this._generateBaseObjects(t,e,i),function(t,e){if(Mr(wr,t),br.length){wr.push(br[0]),br.splice(0,1);const t=wr[wr.length-1];e.loopMessage(t)}}(t,this)},t,this)}})}_getMaterial(t,e,i,n){return this.getMaterial&&Ve.o.isFunction(this.getMaterial)?this.getMaterial(t,e,i,n):null}};const Ir=new Re.TextureLoader,Rr=document.createElement("canvas");function Dr(t){if(!t)return null;let e;return"string"==typeof t?(e=new Image,e.src=t):t instanceof HTMLCanvasElement?(e=new Image,e.src=t.toDataURL()):t instanceof Image&&(e=new Image,e.src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e}const kr={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null};var Or=class extends ai{constructor(t,e,i,n){e=Ve.o.extend({},kr,e,{layer:n,extent:t});const{texture:r,image:o,altitude:a,imageHeight:s,imageWidth:l}=e;o||console.error("not find image"),t instanceof Ve.g||(t=new Ve.g(t));const{xmin:c,ymin:h,xmax:u,ymax:d}=t;let p=1/0,f=1/0,m=-1/0,g=-1/0;[[c,h],[c,d],[u,d],[u,h]].forEach(t=>{const e=n.coordinateToVector3(t),{x:i,y:r}=e;p=Math.min(i,p),f=Math.min(r,f),m=Math.max(i,m),g=Math.max(r,g)});const y=Math.abs(m-p),_=Math.abs(g-f),v=Dr(o),x=Dr(r),b=new Re.PlaneBufferGeometry(y,_,l-1,s-1);super(),this._initOptions(e),this._createMesh(b,i);const w=n.distanceToVector3(a,a).x,M=n.coordinateToVector3(t.getCenter(),w);this.getObject3d().position.copy(M),i.transparent=!0,v&&(i.opacity=0,v.onload=()=>{const t=function(t,e=256,i=256){Rr.width=e,Rr.height=i;const n=Rr.getContext("2d");return n.drawImage(t,0,0,e,i),n.getImageData(0,0,e,i).data}(v,l,s);let e=0;const r={};for(let i=0,o=t.length;i<o;i+=4){const o=Mi(.1*(256*t[i]*256+256*t[i+1]+t[i+2])-1e4,n,r);b.attributes.position.array[3*e+2]=o,e++}b.attributes.position.needsUpdate=!0,x?Ir.load(x.src,t=>{i.map=t,i.opacity=1,i.needsUpdate=!0}):i.opacity=1},v.onerror=function(){console.error("not load "+v.src)}),this.type="Terrain"}};const zr={scale:1,tileDivisor:4};var Br=class extends Ar{constructor(t,e={},i,n){super(Ve.o.GUID(),Ve.o.extend({urlTemplate:t},zr,e)),this._opts=e,this._layer=n,this.material=i,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._imgQueue={},this._layerLaodTime=(new Date).getTime(),this._init()}isAsynchronous(){return!1}formatBaseObjects(t,e){const i=this.options,n=[],{scale:r,tileDivisor:o}=i,{x:a,y:s,z:l}=this._getXYZOfIndex(t),c=this.getMap().getZoom(),h=this.getTileUrl(a,s,l),[u,d]=this.options.tileSize,p=this._getTileLngLatExtent(a,s,l),f=this.material.clone();if(l+1>=Math.round(c)){const t=new Or(p,{image:e,imageWidth:u/o,imageHeight:d/o,texture:h},f,this._layer);t.getObject3d().scale.set(r,r,1),n.push(t)}return n}loopMessage(t){this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval(()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")},1e3)}),this.on("remove",()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)}),this.on("show",()=>{this.getBaseObjects().forEach(t=>{t.show()});for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach(t=>{t.show()})}}),this.on("hide",()=>{this.getBaseObjects().forEach(t=>{t.hide()});for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach(t=>{t.hide()})}}),this.on("renderercreate",t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),i=new Image;return i.width=e.width,i.height=e.height,i.onload=this.onTileLoad.bind(this,i,t),i.onerror=this.onTileError.bind(this,i,t),this.loadTileImage(i,t.url,t.id),i},t.renderer.deleteTile=t=>{if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;const e=t.info||{},i=this._imgQueue[e.id];i&&(i.src="",i.onload=null,i.onerror=null,delete this._imgQueue[e.id])},t.renderer.loadTileImage=(t,e,i)=>{t._key=i;const n=new Image;this._imgQueue[i]=n;const r={key:i,url:e,rgbImage:n,callback:(t,e,i)=>{this._generateBaseObjects(t,e,i)},img:t,vt:this};this.loopMessage(r)}})}};
/*!
 * Code from baidu mapv
 * License: BSD-3
 * https://github.com/huiyan-fe/mapv
 *
 */function Fr(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}Fr.prototype.setMax=function(t){this.max=t||100},Fr.prototype.setMin=function(t){this.min=t||0},Fr.prototype.setMaxSize=function(t){this.maxSize=t||35},Fr.prototype.setMinSize=function(t){this.minSize=t||0},Fr.prototype.initPalette=function(){var t=this.gradient,e=Er(256,1),i=this.paletteCtx=e.getContext("2d"),n=i.createLinearGradient(0,0,256,1);for(var r in t)n.addColorStop(parseFloat(r),t[r]);i.fillStyle=n,i.fillRect(0,0,256,1)},Fr.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},Fr.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var i=this.max,n=this.min;t>i&&(t=i),t<n&&(t=n);var r=4*Math.floor((t-n)/(i-n)*255);return[e[r],e[r+1],e[r+2],e[r+3]]},Fr.prototype.getSize=function(t){var e=this.max,i=this.min,n=this.maxSize,r=this.minSize;return t>e&&(t=e),t<i&&(t=i),e>i?r+(t-i)/(e-i)*(n-r):n},Fr.prototype.getLegend=function(t){var e=this.gradient,i=t.width||20,n=t.height||180,r=Er(i,n),o=r.getContext("2d"),a=o.createLinearGradient(0,n,0,0);for(var s in e)a.addColorStop(parseFloat(s),e[s]);return o.fillStyle=a,o.fillRect(0,0,i,n),r};var Nr=Fr;
/*!
 * Code from baidu mapv
 * License: BSD-3
 * https://github.com/huiyan-fe/mapv
 *
 */function jr(t,e,i){var n=Gr(i),r=function(t){return t.min||0}(i),o=n-r,a=i.range||null,s=0,l=1024;a&&2===a.length&&(s=(a[0]-r)/o*1024),a&&2===a.length&&(l=(a[1]-r)/o*1024);for(var c,h=i.maxOpacity||.8,u=i.minOpacity||0,d=3,p=t.length;d<p;d+=4)c=4*t[d],t[d]/256>h&&(t[d]=256*h),t[d]/256<u&&(t[d]=256*u),c&&c>=s&&c<=l?(t[d-3]=e[c],t[d-2]=e[c+1],t[d-1]=e[c+2]):t[d]=0}function Gr(t){return t.max||100}function Ur(t,e,i){var n=Gr(i),r=function(t){var e=t/2,i=t+e,n=Er(2*i,2*i),r=n.getContext("2d");return r.shadowBlur=e,r.shadowColor="black",r.shadowOffsetX=r.shadowOffsetY=1e4,r.beginPath(),r.arc(i-1e4,i-1e4,t,0,2*Math.PI,!0),r.closePath(),r.fill(),n}(i._size||i.size||13),o=r.width/2,a=r.height/2,s=e,l={};for(var c in s.forEach((function(t){var e=void 0===t.count?1:t.count,i=Math.min(1,e/n).toFixed(2);l[i]=l[i]||[],l[i].push(t)})),l)if(!isNaN(c)){var h=l[c];t.beginPath(),i.withoutAlpha||(t.globalAlpha=c),h.forEach((function(e){var i=e.coordinate,s=void 0===e.count?1:e.count;t.globalAlpha=s/n,t.drawImage(r,i[0]-o,i[1]-a)}))}}var Vr={draw:function(t,e,i){if(!(t.canvas.width<=0||t.canvas.height<=0)){var n=i.strength||.3;t.strokeStyle="rgba(0,0,0,"+n+")";var r=Er(t.canvas.width,t.canvas.height),o=r.getContext("2d");o.scale(devicePixelRatio,devicePixelRatio),i=i||{},t.save();var a=new Nr({gradient:i.gradient});if(Ur(o,e,i),!i.absolute){var s=o.getImageData(0,0,t.canvas.width,t.canvas.height);jr(s.data,a.getImageData(),i),t.putImageData(s,0,0),t.restore()}a=null,r=null}},drawGray:Ur,colorize:jr};const Hr={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5};var Zr=class extends ai{constructor(t,e,i,n){Array.isArray(t)||(t=[t]);let r=1/0,o=1/0,a=-1/0,s=-1/0;const l=[];for(let e=0,i=t.length;e<i;e++){const{coordinate:i,lnglat:c,xy:h}=t[e],u=i||c||h;if(!u){console.warn("not find coordinate");continue}const d=n.coordinateToVector3(u);l.push(d);const{x:p,y:f}=d;r=Math.min(r,p),o=Math.min(o,f),a=Math.max(a,p),s=Math.max(s,f)}e=Ve.o.extend({},Hr,e,{layer:n,points:t});let{gridScale:c,altitude:h}=e;const u=Math.abs(a-r),d=Math.abs(s-o),p=Math.max(u*c,d*c);if(p>2048){console.warn(`gridScale: ${c} it's too big. I hope it's a smaller value,canvas max size is 2048* 2048`);c=2048/(p/c)}const f=Math.ceil(u*c),m=Math.ceil(d*c),g=f/u,y=m/d,_=[];for(let e=0,i=l.length;e<i;e++){const i=l[e];i.x-=r,i.y-=o,i.x*=g,i.y*=y,i.y=m-i.y,_.push({coordinate:[i.x,i.y],count:t[e].count})}let v=Er(f,m),x=v.getContext("2d");Vr.drawGray(x,_,e);const b=x.getImageData(0,0,x.canvas.width,x.canvas.height);let w=-1/0;const M={},T=[];for(let t=3,e=b.data.length,i=0;t<e;t+=4){const e=b.data[t];w=Math.max(w,e),T.push(e),e<=0&&(M[i]=1),i++}const S=new Nr({gradient:e.gradient});Vr.colorize(b.data,S.getImageData(),e),v=null,x=null;const E=new Re.PlaneBufferGeometry(u,d,f-1,m-1),C=E.getIndex().array,A=E.attributes.position.array,P=[],L=[],I=new Re.Color;for(let t=0,e=A.length,i=0,n=C.length,r=0,o=b.data.length,a=0;t<Math.max(e,n,o);t+=3){if(t<e){const e=T[a];e>0&&(A[t+2]=e/w)}if(i<n){const t=C[i],e=C[i+1],n=C[i+2];M[t]&&M[e]&&M[n]||P.push(t,e,n)}if(r<o){const t=`rgb(${b.data[r]},${b.data[r+1]},${b.data[r+2]})`;I.setStyle(t),L.push(I.r,I.g,I.b)}i+=3,r+=4,a++}E.setIndex(new Re.Uint32BufferAttribute(P,1)),Ze(E,"color",new Re.Float32BufferAttribute(L,3,!0)),i.vertexColors=We(),super(),this._initOptions(e),this._createMesh(E,i);const R=n.distanceToVector3(h,h).x;this.getObject3d().position.copy(new Re.Vector3((r+a)/2,(o+s)/2,R)),this.type="HeatMap"}};const Wr=new Re.Color;let qr=1;var Xr=class{constructor(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new Re.WebGLRenderTarget(1,1),this.pickingScene=new Re.Scene}getColor(){return Wr.setHex(qr),qr++,Wr}add(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this}remove(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this}isEmpty(){if(0===this.pickingScene.children.length)return!0;for(let t=0,e=this.pickingScene.children.length;t<e;t++){const e=this.pickingScene.children[t];if(e){const t=e.__parent;if(t&&!0===t.getOptions().interactive)return!1}}return!0}pick(t){if(!t)return;if(this.isEmpty())return;const{camera:e,renderer:i,pickingTexture:n,pickingScene:r,object3ds:o,layer:a}=this,s=this.pickingScene.children.length;for(let t=0;t<s;t++){const e=this.pickingScene.children[t];e&&e.__parent&&(e.__parent.picked=!1)}const{width:l,height:c}=a._getRenderer().canvas,h=n.width,u=n.height;l===h&&c===u||n.setSize(l,c),i.setRenderTarget(n),i.clear(),i.render(r,e);const d=new Uint8Array(4),{x:p,y:f}=t,m=window.devicePixelRatio,g=p*m,y=n.height-f*m;i.readRenderTargetPixels(n,Math.round(g),Math.round(y),1,1,d);const _=d[0]<<16|d[1]<<8|d[2],v=o[_];if(v)v.__parent&&(o[_].__parent.picked=!0);else for(let t=0;t<s;t++){const e=this.pickingScene.children[t];if(e&&e.__parent){const t=e.__parent;if(t._colorMap&&null!=t._colorMap[_]){t.picked=!0,t.index=t._colorMap[_];break}}}i.setRenderTarget(null)}};const Yr={bottomHeight:0,altitude:0};var $r=class extends ai{constructor(t,e,i,n){e=Ve.o.extend({},Yr,e,{layer:n,lineString:t}),super(),this._initOptions(e);const{lineStrings:r,center:o}=Mn(t),a=[],s={};for(let t=0,i=r.length;t<i;t++){const i=xn(r[t],n,o).positionsV;Si(i,e.bottomHeight,n,s);for(let t=0,e=i.length;t<e;t++){const n=i[t];t>0&&t<e-1&&a.push(n.x,n.y,n.z),a.push(n.x,n.y,n.z)}}const l=new ei;l.setPositions(a),this._setMaterialRes(n,i),this._createLine2(l,i);const{altitude:c}=e,h=n.distanceToVector3(c,c).x,u=n.coordinateToVector3(o,h);this.getObject3d().position.copy(u),this._setPickObject3d(a,i.linewidth),this._init(),this.type="FatLine"}_init(){const t=this.getLayer().getPick();this.on("add",()=>{t.add(this.pickObject3d)}),this.on("remove",()=>{t.remove(this.pickObject3d)})}_setMaterialRes(t,e){const i=t.getMap().getSize(),n=i.width,r=i.height;e.resolution.set(n,r)}_setPickObject3d(t,e){const i=new ei;i.setPositions(t);const n=this.getLayer().getPick().getColor(),r=[];for(let e=0,i=t.length/3;e<i;e++)r.push(n.r,n.g,n.b);i.setColors(r);const o=new Ke({color:"#fff",linewidth:e,vertexColors:We()});this._setMaterialRes(this.getLayer(),o);const a=n.getHex(),s=new ii(i,o);s.position.copy(this.getObject3d().position),s._colorIndex=a,this.setPickObject3d(s)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof Re.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),i=e.width,n=e.height;t.resolution.set(i,n),this.getObject3d().material=t}return this}};const Jr={altitude:0,colors:null};class Kr extends(Xn(ai)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=[],o=[],a=t.length;for(let e=0;e<a;e++){const i=Mn(t[e]);r.push(i.center),o.push(i.lineStrings)}const s=Ti(r);e=Ve.o.extend({},Jr,e,{layer:n,lineStrings:t,coordinate:s});const l=[],c={};let h=0,u=[],d=[],p=0,f=[];for(let t=0;t<a;t++){const e=o[t];let i=0;for(let t=0,r=e.length;t<r;t++){const r=fn(e[t])?e[t].properties:e[t].getProperties()||{},{positionsV:o}=xn(e[t],n,s);Si(o,r.bottomHeight,n,c),i+=2*o.length-2;for(let t=0,e=o.length;t<e;t++){const i=o[t];t>0&&t<e-1&&f.push(i.x,i.y,i.z),f.push(i.x,i.y,i.z)}}const r=i;u[t]=[h,h+r],h+=r,d[t]={position:{count:i,start:p,end:p+3*i},instanceStart:{count:i,start:p,end:p+3*i},instanceEnd:{count:i,start:p,end:p+3*i},hide:!1},p+=3*i}super(),this._initOptions(e);const m=new ei;m.setPositions(f),this._setMaterialRes(n,i),this._createLine2(m,i);const{altitude:g}=e,y=n.distanceToVector3(g,g).x,_=n.coordinateToVector3(s,y);this.getObject3d().position.copy(_),this._faceMap=u,this._baseObjects=l,this._datas=t,this._geometriesAttributes=d,this.faceIndex=null,this.index=null,this._geometryCache=new ei,this._geometryCache.setPositions(f),this._colorMap={},this.isHide=!1,this._initBaseObjectsEvent(l),this._setPickObject3d(f,i.linewidth),this._init(),this.type="FatLines"}_setMaterialRes(t,e){const i=t.getMap().getSize(),n=i.width,r=i.height;e.resolution.set(n,r)}_setPickObject3d(t,e){const i=this._geometryCache||new ei;i.setPositions(t);const n=this.getLayer().getPick(),{_geometriesAttributes:r}=this,o=[];for(let t=0,e=r.length;t<e;t++){const e=n.getColor(),i=e.getHex();this._colorMap[i]=t;const{count:a}=r[t].position;this._datas[t].colorIndex=i;for(let t=0;t<a;t++)o.push(e.r,e.g,e.b)}i.setColors(o);const a=new Ke({color:"#fff",linewidth:e,vertexColors:We()});this._setMaterialRes(this.getLayer(),a);const s=n.getColor().getHex(),l=new ii(i,a);l.position.copy(this.getObject3d().position),l._colorIndex=s,this.setPickObject3d(l)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof Re.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),i=e.width,n=e.height;t.resolution.set(i,n),this.getObject3d().material=t}return this}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],i=Ve.o.extend({},this.getOptions(),{index:t},fn(e)?e.properties:e.getProperties());this._baseObjects[t]=new $r(e,i,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_updateAttribute(t,e){const{indexs:i}=this._getHideGeometryIndex(e),n=this._geometryCache.attributes[e].array,r=n.length;for(let e=0;e<r;e++)t.array[e]=n[e];for(let n=0;n<i.length;n++){const r=i[n],{start:o,end:a}=this._geometriesAttributes[r][e];for(let e=o;e<a;e++)t.array[e]=-1e5}return this}_showGeometry(t,e){let i;if(t&&(i=t.getOptions().index),null!=i){const t=this._geometriesAttributes[i],{hide:n}=t;if(n===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.instanceStart,"instanceStart"),this._updateAttribute(r.attributes.instanceEnd,"instanceEnd"),r.attributes.instanceStart.data.needsUpdate=!0,r.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this}}var Qr=Kr;const to={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61"};var eo=class extends ai{constructor(t,e,i,n){e=Ve.o.extend({},to,e,{layer:n,coordinate:t}),super(),this._initOptions(e);const{height:r,radius:o,topColor:a,bottomColor:s,altitude:l}=e,c=n.distanceToVector3(r,r).x,h=n.distanceToVector3(o,o).x,u=xi().clone();u.scale(2*h,2*h,c),a&&(_i(u,s,a,"z",c/2),i.vertexColors=We()),this._createMesh(u,i);const d=n.distanceToVector3(l,l).x,p=n.coordinateToVector3(t,d);this.getObject3d().position.copy(p),this.type="Box"}};const io={radius:10,height:100,altitude:0,topColor:null,bottomColor:"#2d2f61"};class no extends(Xn(ai)){constructor(t,e,i,n){Array.isArray(t)||(t=[t]);const r=t.length,o=Ti(t),a=n.coordinateToVector3(o),s=[],l=[],c=[],h=[];let u=0,d=0,p=0,f=0;const m={};for(let e=0;e<r;e++){const r=Ve.o.extend({index:e},io,t[e]),{radius:o,altitude:g,topColor:y,bottomColor:_,height:v,coordinate:x}=r,b=Mi(o,n,m),w=Mi(v,n,m),M=Mi(g,n,m),T=xi().clone();T.scale(2*b,2*b,w),y&&(_i(T,_,y,"z",w/2),i.vertexColors=We());const S=n.coordinateToVector3(x).sub(a),E=T.attributes.position.array;for(let t=0,e=E.length;t<e;t+=3)E[t+2]+=M,E[t]+=S.x,E[t+1]+=S.y,E[t+2]+=S.z;s.push(T);const C=new eo(x,r,i,n);l.push(C);const A=T.index.count/3;h[e]=[u+1,u+A],u+=A;const P=T.attributes.position.count,L=T.attributes.normal.count,I=T.attributes.uv.count;c[e]={position:{count:P,start:d,end:d+3*P},normal:{count:L,start:p,end:p+3*L},uv:{count:I,start:f,end:f+2*I},hide:!1},d+=3*P,p+=3*L,f+=2*I}super(),e=Ve.o.extend({},{altitude:0,layer:n,points:t},e),this._initOptions(e);const g=vi(s);this._createMesh(g,i);const y=e.altitude,_=n.distanceToVector3(y,y).x,v=a.clone();v.z=_,this.getObject3d().position.copy(v),this._faceMap=h,this._baseObjects=l,this._datas=t,this._geometriesAttributes=c,this.faceIndex=null,this._geometryCache=g.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(l),this._setPickObject3d(),this._init(),this.type="Boxs"}identify(t){return this.picked}}var ro=no;const oo=Math.PI/180,ao=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02]],so=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"];class lo extends Ve.c{constructor(t,e){super(t,e),this._animationBaseObjectMap={},this._needsUpdate=!0,this._mousemoveTimeOut=0,this._baseObjects=[],this._delayMeshes=[],this.type="ThreeLayer"}isRendering(){const t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())}prepareToDraw(...t){}draw(){this.renderScene()}drawOnInteracting(){this.renderScene()}coordinateToVector3(t,e=0){const i=this.getMap();if(!i)return null;t instanceof Ve.d||(t=new Ve.d(t));const n=i.coordinateToPoint(t,ho(i));return new Re.Vector3(n.x,n.y,e)}distanceToVector3(t,e,i){if(0===t&&0===e||!Ve.o.isNumber(t)||!Ve.o.isNumber(e))return new Re.Vector3(0,0,0);const n=this.getMap(),r=ho(n);let o=i||n.getCenter();o instanceof Ve.d||(o=new Ve.d(o));const a=n.locate(o,t,e),s=n.coordinateToPoint(o,r),l=n.coordinateToPoint(a,r),c=Math.abs(l.x-s.x)*Ve.o.sign(t),h=Math.abs(l.y-s.y)*Ve.o.sign(e);return new Re.Vector3(c,h,0)}toShape(t){if(!t)return null;if(t instanceof Ve.l)return t.getGeometries().map(t=>this.toShape(t));const e=t.getCenter(),i=this.coordinateToVector3(e),n=t.getShell().map(t=>{const e=this.coordinateToVector3(t).sub(i);return new Re.Vector2(e.x,e.y)}),r=new Re.Shape(n),o=t.getHoles();return o&&o.length>0&&(r.holes=o.map(t=>{const e=t.map(t=>{const e=this.coordinateToVector3(t).sub(i);return new Re.Vector2(e.x,e.y)});return new Re.Shape(e)})),r}toExtrudeMesh(t,e,i,n){if(!t)return null;if(t instanceof Ve.l)return t.getGeometries().map(t=>this.toExtrudeMesh(t,e,i,n));const r=t.getCoordinates();r.forEach(t=>{for(let e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)}),t.setCoordinates(r);const o=this.toShape(t),a=this.coordinateToVector3(t.getCenter());n=Ve.o.isNumber(n)?n:e,n=this.distanceToVector3(n,n).x;const s=this.distanceToVector3(e,e).x,l={bevelEnabled:!1,bevelSize:1};l[parseInt(Re.REVISION)>=93?"depth":"amount"]=n;const c=new Re.ExtrudeGeometry(o,l);let h=c;Re.BufferGeometry.prototype.fromGeometry&&(h=new Re.BufferGeometry,h.fromGeometry(c));const u=new Re.Mesh(h,i);return u.position.set(a.x,a.y,s-n),u}toExtrudePolygon(t,e,i){return new On(t,e,i,this)}toBar(t,e,i){return new wi(t,e,i,this)}toLine(t,e,i){return new Sn(t,e,i,this)}toExtrudeLine(t,e,i){return new Dn(t,e,i,this)}toModel(t,e){return new Bn(t,e,this)}toExtrudeLineTrail(t,e,i){return new Zn(t,e,i,this)}toExtrudePolygons(t,e,i){return new tr(t,e,i,this)}toPoint(t,e,i){return new rr(t,e,i,this)}toPoints(t,e,i){return new ur(t,e,i,this)}toBars(t,e,i){return new fr(t,e,i,this)}toExtrudeLines(t,e,i){return new yr(t,e,i,this)}toLines(t,e,i){return new xr(t,e,i,this)}toThreeVectorTileLayer(t,e,i){return new Lr(t,e,i,this)}toTerrain(t,e,i){return new Or(t,e,i,this)}toTerrainVectorTileLayer(t,e,i){return new Br(t,e,i,this)}toHeatMap(t,e,i){return new Zr(t,e,i,this)}toFatLine(t,e,i){return new $r(t,e,i,this)}toFatLines(t,e,i){return new Qr(t,e,i,this)}toBox(t,e,i){return new eo(t,e,i,this)}toBoxs(t,e,i){return new ro(t,e,i,this)}getBaseObjects(){return this.getMeshes().filter(t=>t instanceof ai)}getMeshes(){const t=this.getScene();if(!t)return[];const e=[];for(let i=0,n=t.children.length;i<n;i++){const n=t.children[i];n instanceof Re.Object3D&&!(n instanceof Re.Camera)&&e.push(n.__parent||n)}return e}clear(){return this.clearMesh()}clearMesh(){const t=this.getScene();if(!t)return this;for(let e=t.children.length-1;e>=0;e--){const i=t.children[e];if(i instanceof Re.Object3D&&!(i instanceof Re.Camera)){t.remove(i);const e=i.__parent;e&&e instanceof ai&&(e.isAdd=!1,e._fire("remove",{target:e}),delete this._animationBaseObjectMap[i.uuid])}}return this}lookAt(t){const e=this._getRenderer();return e&&e.context.lookAt(t),this}getCamera(){const t=this._getRenderer();return t?t.camera:null}getScene(){const t=this._getRenderer();return t?t.scene:null}renderScene(){const t=this._getRenderer();return t&&(t.clearCanvas(),t.renderScene()),this}loop(t=!1){const e=this._delayMeshes;if(!e.length)return;const i=this.getMap();if(!i||i.isAnimating()||i.isInteracting())return;const n=this.options.loopRenderCount||50,r=e.slice(0,n);r&&this.addMesh(r,t),e.splice(0,n)}renderPickScene(){const t=this._getRenderer();if(t){const e=t.pick;e&&e.pick(this._containerPoint)}return this}getThreeRenderer(){const t=this._getRenderer();return t?t.context:null}getPick(){const t=this._getRenderer();return t?t.pick:null}delayAddMesh(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(let e=0,i=t.length;e<i;e++)this._delayMeshes.push(t[e]);return this}addMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const i=this.getScene();return t.forEach(t=>{t instanceof ai?(i.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&Ve.o.isFunction(t._animation)&&(this._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof Re.Object3D&&i.add(t)}),this._zoomend(),e&&this.renderScene(),this}removeMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const i=this.getScene();return t.forEach(t=>{if(t instanceof ai){i.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&Ve.o.isFunction(t._animation)&&delete this._animationBaseObjectMap[t.getObject3d().uuid];const e=this._delayMeshes;if(e.length)for(let i=0,n=e.length;i<n;i++)if(e[i]===t){e.splice(i,1);break}}else t instanceof Re.Object3D&&i.remove(t)}),e&&this.renderScene(),this}_initRaycaster(){return this._raycaster||(this._raycaster=new Re.Raycaster,this._mouse=new Re.Vector2),this}identify(t,e){if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new Ve.d(t)),!(t instanceof Ve.d))return console.error("coordinate type is error,it should be Coordinate"),[];const i=this.getMap().coordToContainerPoint(t);this._containerPoint=i;const{x:n,y:r}=i;this._initRaycaster();const o=this._raycaster,a=this._mouse,s=this.getCamera(),l=this.getScene(),c=this.getMap().getSize();if(!l)return[];const h=c.width,u=c.height;a.x=n/h*2-1,a.y=-r/u*2+1,o.setFromCamera(a,s),function(t,e){He>113?t.params.Line.threshold=e:t.linePrecision=e}(o,this._getLinePrecision(this.getMap().getResolution()));const d=[],p=[];l.children.forEach(t=>{const e=t.__parent;if(e&&e.getOptions){const i=e;i.getOptions().interactive&&i.isVisible()&&(i.identify&&Ve.o.isFunction(i.identify)?p.push(i):d.push(t))}else(t instanceof Re.Mesh||t instanceof Re.Group)&&d.push(t)});let f=[];const m=o.intersectObjects(d,!0);m&&Array.isArray(m)&&m.length&&(f=m.map(t=>{let e=t.object;e=this._recursionMesh(e)||{};const i=e.__parent||e;return i.faceIndex=t.faceIndex,i.index=t.index,i})),this.renderPickScene(),p.length&&p.forEach(e=>{e.identify(t)&&f.push(e)});const g=f.length;for(let t=0;t<g;t++)if(f[t])for(let e=t+1;e<g;e++)f[t]===f[e]&&f.splice(e,1);const y=(e=Ve.o.extend({},e)).count;return Ve.o.isNumber(y)&&y>0?f.slice(0,y):f}_recursionMesh(t){for(;t&&t.parent!==this.getScene();)t=t.parent;return t}_getLinePrecision(t=10){for(let e=0,i=ao.length;e<i;e++){const[i,n]=ao[e];if(t>i)return n}return.01}_identifyBaseObjectEvents(t){if(!this.options.geometryEvents)return this;const e=this.map||this.getMap();if(e.isInteracting()||!e.options.geometryEvents)return this;const{type:i,coordinate:n}=t,r=Ve.o.now();if(this._mousemoveTimeOut&&"mousemove"===i&&r-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=r,e.resetCursor("default");const o=this.options.identifyCountOnEvent;let a=Math.max(0,Ve.o.isNumber(o)?o:0);0===a&&(a=1/0);const s=this.identify(n,{count:a}),l=this.getScene();if(0===s.length&&l)for(let e=0,i=l.children.length;e<i;e++){const i=(l.children[e]||{}).__parent;i&&i.fire("empty",Object.assign({},t,{target:i}))}if("mousemove"===i){s.length&&e.setCursor("pointer");const r=[];this._baseObjects&&this._baseObjects.forEach(t=>{let e=!0;s.forEach(i=>{t===i&&(e=!1)}),e&&r.push(t)}),r.forEach(e=>{e&&e instanceof ai&&(e.getSelectMesh?e.isHide||(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout",selectMesh:null})),e.closeToolTip()):(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout"})),e.closeToolTip()))}),s.forEach(e=>{if(e instanceof ai){e._mouseover||(e.fire("mouseover",Object.assign({},t,{target:e,type:"mouseover",selectMesh:e.getSelectMesh?e.getSelectMesh():null})),e._mouseover=!0),e.fire(i,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}));const r=e.getToolTip();r&&!r._owner&&r.addTo(e),e.openToolTip(n)}}),this._baseObjects=s}else s.forEach(e=>{if(e instanceof ai&&(e.fire(i,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null})),"click"===i)){const t=e.getInfoWindow();t&&!t._owner&&t.addTo(e),e.openInfoWindow(n)}});return this}_zoomend(){const t=this.getScene();if(!t)return;const e=this.getMap().getZoom();t.children.forEach(t=>{const i=t.__parent;if(i&&i.getOptions){const t=i;t.zoomChange&&Ve.o.isFunction(t.zoomChange)&&t.zoomChange(e);const n=t.getMinZoom(),r=t.getMaxZoom();e<n||e>r?(t.isVisible()&&(t.getObject3d().visible=!1),t._zoomVisible=!1):n<=e&&e<=r&&(t._visible&&(t.getObject3d().visible=!0),t._zoomVisible=!0)}})}onAdd(){super.onAdd();const t=this.map||this.getMap();return t?(so.forEach(e=>{t.on(e,this._identifyBaseObjectEvents,this)}),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),t.on("zooming zoomend",this._zoomend,this),this):this}onRemove(){super.onRemove();const t=this.map||this.getMap();return t?(so.forEach(e=>{t.off(e,this._identifyBaseObjectEvents,this)}),t.off("zooming zoomend",this._zoomend,this),this):this}_callbackBaseObjectAnimation(){const t=this;if(t._animationBaseObjectMap)for(const e in t._animationBaseObjectMap){t._animationBaseObjectMap[e]._animation()}return this}_getFovRatio(){const t=this.getMap().getFov();return Math.tan(t/2*oo)}}lo.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});class co extends Ve.r.CanvasLayerRenderer{constructor(){super(...arguments),this._renderTime=0}getPrepareParams(){return[this.scene,this.camera]}getDrawParams(){return[this.scene,this.camera]}_drawLayer(){super._drawLayer.apply(this,arguments)}hitDetect(){return!1}createCanvas(){super.createCanvas(),this.createContext()}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)}_initThreeRenderer(){this.matrix4=new Re.Matrix4;const t=new Re.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new Re.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;const e=this.scene=new Re.Scene,i=this.layer.getMap(),n=i.getFov()*Math.PI/180,r=this.camera=new Re.PerspectiveCamera(n,i.width/i.height,i.cameraNear,i.cameraFar);r.matrixAutoUpdate=!1,this._syncCamera(),e.add(r),this.pick=new Xr(this.layer)}onCanvasCreate(){super.onCanvasCreate()}resizeCanvas(t){if(!this.canvas)return;let e,i=this.getMap();e=t||i.getSize();const n=i.getDevicePixelRatio?i.getDevicePixelRatio():Ve.b.retina?2:1,r=this.canvas;r.height=n*e.height,r.width=n*e.width,this.layer._canvas&&r.style&&(r.style.width=e.width+"px",r.style.height=e.height+"px"),this.context.setSize(r.width,r.height)}clearCanvas(){this.canvas&&this.context.clear()}prepareCanvas(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null}renderScene(){const t=Ve.o.now();t-this._renderTime>=16&&(this.layer._callbackBaseObjectAnimation(),this._renderTime=t),this._syncCamera(),this.context.render(this.scene,this.camera),this.completeRender()}remove(){delete this._drawContext,super.remove()}_syncCamera(){const t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements}_createGLContext(t,e){const i=["webgl2","webgl","experimental-webgl"];let n=null;for(let r=0;r<i.length;++r){try{n=t.getContext(i[r],e)}catch(t){}if(n)break}return n}}function ho(t){return t.getGLZoom()}lo.registerRenderer("gl",co),Ve.q&&Ve.q("__maptalks.three__",'function(e){"use strict";var d=n,t=n;function n(e,t,n){n=n||2;var r,i,o,a,v,h=t&&t.length,l=h?t[0]*n:e.length,u=p(e,0,l,n,!0),x=[];if(!u||u.next===u.prev)return x;if(h&&(u=function(e,t,n,r){var i,o,a,v,h=[];for(i=0,o=t.length;i<o;i++)a=t[i]*r,v=i<o-1?t[i+1]*r:e.length,(v=p(e,a,v,r,!1))===v.next&&(v.steiner=!0),h.push(function(e){var t=e,n=e;for(;(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next,t!==e;);return n}(v));for(h.sort(m),i=0;i<h.length;i++)!function(e,t){(t=function(e,t){var n,r=t,i=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var v=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(v<=i&&a<v){if((a=v)===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}}while(r=r.next,r!==t);if(!n)return null;if(i===a)return n;var h,l=n,u=n.x,x=n.y,f=1/0;r=n;for(;i>=r.x&&r.x>=u&&i!==r.x&&M(o<x?i:a,o,u,x,o<x?a:i,o,r.x,r.y)&&(h=Math.abs(o-r.y)/(i-r.x),Z(r,e)&&(h<f||h===f&&(r.x>n.x||r.x===n.x&&function(e,t){return w(e.prev,e,t.prev)<0&&w(t.next,e,e.next)<0}(n,r)))&&(n=r,f=h)),r=r.next,r!==l;);return n}(e,t))&&(e=S(t,e),g(t,t.next),g(e,e.next))}(h[i],n),n=g(n,n.next);return n}(e,t,u,n)),e.length>80*n){for(var f=r=e[0],s=i=e[1],c=n;c<l;c+=n)(o=e[c])<f&&(f=o),(a=e[c+1])<s&&(s=a),r<o&&(r=o),i<a&&(i=a);v=0!==(v=Math.max(r-f,i-s))?1/v:0}return y(u,x,n,f,s,v),x}function p(e,t,n,r,i){var o,a;if(i===0<z(e,t,n,r))for(o=t;o<n;o+=r)a=v(o,e[o],e[o+1],a);else for(o=n-r;t<=o;o-=r)a=v(o,e[o],e[o+1],a);return a&&u(a,a.next)&&(f(a),a=a.next),a}function g(e,t){if(!e)return e;t=t||e;var n,r=e;do{if(n=!1,r.steiner||!u(r,r.next)&&0!==w(r.prev,r,r.next))r=r.next;else{if(f(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function y(e,t,n,r,i,o,a){if(e){!a&&o&&function(e,t,n,r){for(var i=e;null===i.z&&(i.z=b(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==e;);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,o,a,v,h,l=1;do{for(n=e,o=e=null,a=0;n;){for(a++,r=n,t=v=0;t<l&&(v++,r=r.nextZ);t++);for(h=l;0<v||0<h&&r;)0!==v&&(0===h||!r||n.z<=r.z)?(n=(i=n).nextZ,v--):(r=(i=r).nextZ,h--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}}while(o.nextZ=null,l*=2,1<a)}(i)}(e,r,i,o);for(var v,h,l=e;e.prev!==e.next;)if(v=e.prev,h=e.next,o?function(e,t,n,r){var i=e.prev,o=e,a=e.next;if(0<=w(i,o,a))return!1;var v=(i.x<o.x?i.x<a.x?i:a:o.x<a.x?o:a).x,h=(i.y<o.y?i.y<a.y?i:a:o.y<a.y?o:a).y,l=(i.x>o.x?i.x>a.x?i:a:o.x>a.x?o:a).x,u=(i.y>o.y?i.y>a.y?i:a:o.y>a.y?o:a).y,x=b(v,h,t,n,r),f=b(l,u,t,n,r),s=e.prevZ,c=e.nextZ;for(;s&&s.z>=x&&c&&c.z<=f;){if(s!==e.prev&&s!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,s.x,s.y)&&0<=w(s.prev,s,s.next))return!1;if(s=s.prevZ,c!==e.prev&&c!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,c.x,c.y)&&0<=w(c.prev,c,c.next))return!1;c=c.nextZ}for(;s&&s.z>=x;){if(s!==e.prev&&s!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,s.x,s.y)&&0<=w(s.prev,s,s.next))return!1;s=s.prevZ}for(;c&&c.z<=f;){if(c!==e.prev&&c!==e.next&&M(i.x,i.y,o.x,o.y,a.x,a.y,c.x,c.y)&&0<=w(c.prev,c,c.next))return!1;c=c.nextZ}return!0}(e,r,i,o):function(e){var t=e.prev,n=e,r=e.next;if(0<=w(t,n,r))return!1;var i=e.next.next;for(;i!==e.prev;){if(M(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&0<=w(i.prev,i,i.next))return!1;i=i.next}return!0}(e))t.push(v.i/n),t.push(e.i/n),t.push(h.i/n),f(e),e=h.next,l=h.next;else if((e=h)===l){a?1===a?y(e=function(e,t,n){var r=e;do{var i=r.prev,o=r.next.next}while(!u(i,o)&&x(i,r,r.next,o)&&Z(i,o)&&Z(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),f(r),f(r.next),r=e=o),r=r.next,r!==e);return g(r)}(g(e),t,n),t,n,r,i,o,2):2===a&&function(e,t,n,r,i,o){var a=e;do{for(var v=a.next.next;v!==a.prev;){if(a.i!==v.i&&function(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&x(n,n.next,e,t))return!0}while(n=n.next,n!==e);return!1}(e,t)&&(Z(e,t)&&Z(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;for(;n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next,n!==e;);return r}(e,t)&&(w(e.prev,e,t.prev)||w(e,t.prev,t))||u(e,t)&&0<w(e.prev,e,e.next)&&0<w(t.prev,t,t.next))}(a,v)){var h=S(a,v);return a=g(a,a.next),h=g(h,h.next),y(a,t,n,r,i,o),y(h,t,n,r,i,o)}v=v.next}}while((a=a.next)!==e)}(e,t,n,r,i,o):y(g(e),t,n,r,i,o,1);break}}}function m(e,t){return e.x-t.x}function b(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function M(e,t,n,r,i,o,a,v){return 0<=(i-a)*(t-v)-(e-a)*(o-v)&&0<=(e-a)*(r-v)-(n-a)*(t-v)&&0<=(n-a)*(o-v)-(i-a)*(r-v)}function w(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function u(e,t){return e.x===t.x&&e.y===t.y}function x(e,t,n,r){var i=l(w(e,t,n)),o=l(w(e,t,r)),a=l(w(n,r,e)),v=l(w(n,r,t));return i!==o&&a!==v||(0===i&&h(e,n,t)||(0===o&&h(e,r,t)||(0===a&&h(n,e,r)||!(0!==v||!h(n,t,r)))))}function h(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function l(e){return 0<e?1:e<0?-1:0}function Z(e,t){return w(e.prev,e,e.next)<0?0<=w(e,t,e.next)&&0<=w(e,e.prev,t):w(e,t,e.prev)<0||w(e,e.next,t)<0}function S(e,t){var n=new a(e.i,e.x,e.y),r=new a(t.i,t.x,t.y),i=e.next,o=t.prev;return(e.next=t).prev=e,(n.next=i).prev=n,(r.next=n).prev=r,(o.next=r).prev=o,r}function v(e,t,n,r){n=new a(e,t,n);return r?(n.next=r.next,(n.prev=r).next.prev=n,r.next=n):(n.prev=n).next=n,n}function f(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function a(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function z(e,t,n,r){for(var i=0,o=t,a=n-r;o<n;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}function r(e,t){var n=e.length-1,r=[e[0]];return function e(t,n,r,i,o){for(var a,v,h,l,u,x,f,s=i,c=n+1;c<r;c++){var p=(v=t[c],h=t[n],l=t[r],p=f=x=u=void 0,u=h[0],x=h[1],f=l[0]-u,p=l[1]-x,0===f&&0===p||(1<(h=((v[0]-u)*f+(v[1]-x)*p)/(f*f+p*p))?(u=l[0],x=l[1]):0<h&&(u+=f*h,x+=p*h)),(f=v[0]-u)*f+(p=v[1]-x)*p);s<p&&(a=c,s=p)}i<s&&(1<a-n&&e(t,n,a,i,o),o.push(t[a]),1<r-a&&e(t,a,r,i,o))}(e,0,n,t,r),r.push(e[n]),r}function A(e,t,n){if(e.length<=2)return e;t=void 0!==t?t*t:1;return e=r(e=n?e:function(e,t){for(var n,r,i,o,a=e[0],v=[a],h=1,l=e.length;h<l;h++)n=e[h],i=a,o=void 0,o=(r=n)[0]-i[0],i=r[1]-i[1],t<o*o+i*i&&(v.push(n),a=n);return a!==n&&v.push(n),v}(e,t),t)}function R(e,t){var n=t[0],r=t[1],t=Math.sqrt(n*n+r*r);return e[0]=n/t,e[1]=r/t,e}function s(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}function F(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}n.deviation=function(e,t,n,r){var i=t&&t.length,o=i?t[0]*n:e.length,a=Math.abs(z(e,0,o,n));if(i)for(var v=0,h=t.length;v<h;v++){var l=t[v]*n,u=v<h-1?t[v+1]*n:e.length;a-=Math.abs(z(e,l,u,n))}for(var x=0,v=0;v<r.length;v+=3){var f=r[v]*n,s=r[v+1]*n,c=r[v+2]*n;x+=Math.abs((e[f]-e[c])*(e[1+s]-e[1+f])-(e[f]-e[s])*(e[1+c]-e[1+f]))}return 0===a&&0===x?0:Math.abs((x-a)/a)},n.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<t;a++)n.vertices.push(e[i][o][a]);0<i&&(r+=e[i-1].length,n.holes.push(r))}return n},d.default=t;var c=[];function ee(e,t,n,r){var i,o,a=(o=n,(i=t)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),v=Math.acos(a)*r;return s(c,n,t,-a),r=(o=i=c)[0],n=o[1],a=o[2],o=Math.sqrt(r*r+n*n+a*a),i[0]=r/o,i[1]=n/o,i[2]=a/o,a=e,o=t,t=Math.cos(v),a[0]=o[0]*t,a[1]=o[1]*t,a[2]=o[2]*t,s(e,e,c,Math.sin(v)),e}function q(e,t,n){if(n-t<3)return 0;for(var r=0,i=2*(n-1),o=2*t;o<2*n;){var a=e[i],v=e[i+1],h=e[o],l=e[o+1],i=o;o+=2,r+=a*l-h*v}return r}var B=[],U=[],L=[];function O(e,t,n,r,i,o,a,v){var h=null!=a,l=i,u=null;h&&(u=new Uint32Array(r-n));for(var x=n;x<r;x++){var f=x===r-1?n:x+1,s=x===n?r-1:x-1,c=e[2*s],p=e[2*s+1],g=e[2*x],d=e[2*x+1],s=e[2*f],f=e[2*f+1];B[0]=g-c,B[1]=d-p,U[0]=s-g,U[1]=f-d,R(B,B),R(U,U),h&&(u[x]=l),v||x!==n?v||x!==r-1?(c=U,p=B,(s=L)[0]=c[0]+p[0],s[1]=c[1]+p[1],f=L[1],L[1]=-L[0],L[0]=f,R(L,L),s=U,p=(c=L)[0]*s[0]+c[1]*s[1],f=Math.sqrt(1-p*p),c=o*Math.min(10,1/f),h&&a<1/f&&o*p<0?(s=g+L[0]*o,p=d+L[1]*o,f=Math.acos(f)/2,f=Math.tan(f)*Math.abs(o),t[2*l]=s+L[1]*f,t[2*l+1]=p-L[0]*f,t[2*++l]=s-L[1]*f,t[2*l+1]=p+L[0]*f):(t[2*l]=g+L[0]*c,t[2*l+1]=d+L[1]*c)):(L[0]=B[1],L[1]=-B[0],R(L,L),t[2*l]=g+L[0]*o,t[2*l+1]=d+L[1]*o):(L[0]=U[1],L[1]=-U[0],R(L,L),t[2*l]=g+L[0]*o,t[2*l+1]=d+L[1]*o),l++}return u}function P(e,t,n,r,i){var o=null!=r?[]:new Float32Array(e.length);if(O(e,o,0,t&&t.length?t[0]:e.length/2,0,n,r,i),t)for(var a=0;a<t.length;a++){var v=t[a];O(e,o,v,t[a+1]||e.length/2,null!=r?o.length/2:v,n,r,i)}return o}function V(e,t,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var o=0;o<t;o++){var a=(i+n)*t+o,v=(r-i-1)*t+o,h=e[a];e[a]=e[v],e[v]=h}return e}function W(e){e.depth=e.depth||1,e.bevelSize=e.bevelSize||0,e.bevelSegments=null==e.bevelSegments?2:e.bevelSegments,e.smoothSide=e.smoothSide||!1,e.smoothBevel=e.smoothBevel||!1,e.simplify=e.simplify||0,"number"==typeof e.depth&&(e.bevelSize=Math.min(0<e.bevelSegments?e.bevelSize:0,e.depth/2)),0<e.bevelSize||(e.bevelSegments=0),e.bevelSegments=Math.round(e.bevelSegments);var t,n,r,i,o=e.boundingRect;e.translate=e.translate||[0,0],e.scale=e.scale||[1,1],e.fitRect&&(t=null==e.fitRect.x?o.x||0:e.fitRect.x,n=null==e.fitRect.y?o.y||0:e.fitRect.y,r=e.fitRect.width,i=e.fitRect.height,null==r?null!=i?r=i/o.height*o.width:(r=o.width,i=o.height):null==i&&(i=r/o.width*o.height),e.scale=[r/o.width,i/o.height],e.translate=[(t-o.x)*e.scale[0],(n-o.y)*e.scale[1]])}function j(e,t){function n(e,t,n,r){e[0]=t,e[1]=n,e[2]=r}for(var r,i,o,a,v,h,l,u=[],x=[],f=[],s=[],c=[],p=[],g=e.length,d=new Float32Array(t.length),y=0;y<g;){var m=3*e[y++],b=3*e[y++],M=3*e[y++];n(u,t[m],t[1+m],t[2+m]),n(x,t[b],t[1+b],t[2+b]),n(f,t[M],t[1+M],t[2+M]),F(s,u,x),F(c,x,f),r=p,o=c,l=h=v=a=void 0,a=(i=s)[0],v=i[1],h=i[2],l=o[0],i=o[1],o=o[2],r[0]=v*o-h*i,r[1]=h*l-a*o,r[2]=a*i-v*l;for(var w=0;w<3;w++)d[m+w]=d[m+w]+p[w],d[b+w]=d[b+w]+p[w],d[M+w]=d[M+w]+p[w]}for(var Z,S,z,A,R,q=0;q<d.length;)n(p,d[q],d[q+1],d[q+2]),R=A=z=void 0,z=(S=Z=p)[0],A=S[1],R=S[2],S=Math.sqrt(z*z+A*A+R*R),Z[0]=z/S,Z[1]=A/S,Z[2]=R/S,d[q++]=p[0],d[q++]=p[1],d[q++]=p[2];return d}var te=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function H(e,t,n,r,i,o){var a=t.vertices,v=t.topVertices,h=t.depth,t=t.rect,l=r-n,u=o.smoothSide?1:2,x=l*u,f=o.smoothBevel?1:2,s=Math.min(h/2,o.bevelSize),c=o.bevelSegments,p=i.vertex,g=Math.max(t.width,t.height,h);if(0<s)for(var d=[0,0,1],y=[],m=[0,0,-1],b=[],M=0,w=new Float32Array(l),Z=0;Z<2;Z++)for(var S=0===Z?h-s:s,z=0;z<=c*f;z++){for(var A=0,R=void 0,q=void 0,F=0;F<l;F++){for(var B=0;B<u;B++){var U=2*((F+B)%l+n);y[0]=a[U]-v[U],y[1]=a[1+U]-v[1+U],y[2]=0;var L=Math.sqrt(y[0]*y[0]+y[1]*y[1]);y[0]/=L,y[1]/=L;var O=(Math.floor(z/f)+z%f)/c;0===Z?ee(b,d,y,O):ee(b,y,m,O);var P=0===Z?O:1-O,V=s*Math.sin(P*Math.PI/2),W=L*Math.cos(P*Math.PI/2),O=s*L/Math.sqrt(V*V+W*W),P=b[0]*O+v[U],L=b[1]*O+v[1+U],V=b[2]*O+S;e.position[3*i.vertex]=P,e.position[3*i.vertex+1]=L,e.position[3*i.vertex+2]=V,(0<F||0<B)&&(A+=Math.sqrt((R-P)*(R-P)+(q-L)*(q-L))),(0<z||0<Z)&&(W=3*(i.vertex-x),U=e.position[W],O=e.position[1+W],W=e.position[2+W],w[F]+=Math.sqrt((U-P)*(U-P)+(O-L)*(O-L)+(W-V)*(W-V))),e.uv[2*i.vertex]=A/g,e.uv[2*i.vertex+1]=w[F]/g,R=P,q=L,i.vertex++}if(1<f&&z%f||1==f&&1<=z)for(var j=0;j<6;j++){var H=(te[j][0]+F*u)%x,k=te[j][1]+M;e.indices[i.index++]=(k-1)*x+H+p}}M++}else for(var I=0;I<2;I++)for(var _=0===I?h-s:s,D=0,E=void 0,C=void 0,G=0;G<l;G++)for(var J=0;J<u;J++){var K=2*((G+J)%l+n),N=a[K],K=a[1+K];e.position[3*i.vertex]=N,e.position[3*i.vertex+1]=K,e.position[3*i.vertex+2]=_,(0<G||0<J)&&(D+=Math.sqrt((E-N)*(E-N)+(C-K)*(C-K))),e.uv[2*i.vertex]=D/g,e.uv[2*i.vertex+1]=_/g,E=N,C=K,i.vertex++}for(var Q=0<s?c*f+1:1,T=0;T<l;T++)for(var X=0;X<6;X++){var Y=(te[X][0]+T*u)%x,$=te[X][1]+Q;e.indices[i.index++]=($-1)*x+Y+p}}function k(e,t){for(var n=0,r=0,i=0;i<e.length;i++){var o=e[i],a=o.indices,v=o.vertices,h=o.holes,o=o.depth,l=v.length/2,u=0<Math.min(o/2,t.bevelSize)?t.bevelSegments:0;n+=a.length*(t.excludeBottom?1:2),r+=l*(t.excludeBottom?1:2);for(var x=2+2*u,f=0,s=0,c=0;c<(h?h.length:0)+1;c++){n+=6*((s=0===c?h&&h.length?h[0]:l:(f=h[c-1],h[c]||l))-f)*(x-1);var p=(s-f)*(t.smoothSide?1:2);r+=p*x+(t.smoothBevel?0:u*p*2)}}for(var g={position:new Float32Array(3*r),indices:new(65535<r?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},d={vertex:0,index:0},y=0;y<e.length;y++)!function(e,t,n,r){var i=e.indices,o=e.vertices,a=e.topVertices,v=e.rect,h=e.depth;if(!(o.length<=4)){for(var l=n.vertex,u=i.length,x=0;x<u;x++)t.indices[n.index++]=l+i[x];for(var f=Math.max(v.width,v.height),s=0;s<(r.excludeBottom?1:2);s++)for(var c=0;c<a.length;c+=2){var p=a[c],g=a[c+1];t.position[3*n.vertex]=p,t.position[3*n.vertex+1]=g,t.position[3*n.vertex+2]=(1-s)*h,t.uv[2*n.vertex]=(p-v.x)/f,t.uv[2*n.vertex+1]=(g-v.y)/f,n.vertex++}if(!r.excludeBottom)for(var d=o.length/2,y=0;y<u;y+=3)for(var m=0;m<3;m++)t.indices[n.index++]=l+d+i[y+2-m]}}(e[y],g,d,t);for(var m=0;m<e.length;m++){var b,M=e[m],w=M.holes,Z=M.vertices.length/2,S=w&&w.length?w[0]:Z;if(H(g,e[m],0,S,d,t),w)for(var z=0;z<w.length;z++)b=w[z],S=w[z+1]||Z,H(g,e[m],b,S,d,t)}for(var A=0;A<g.uv.length;A++){var R=g.uv[A];0<R&&Math.round(R)===R?g.uv[A]=1:g.uv[A]=R%1}return g.normal=j(g.indices,g.position),g.boundingRect=e[0]&&e[0].rect,g}function I(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)D(e[i][0],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},W(t);for(var o=[],a=t.translate||[0,0],v=t.scale||[1,1],h=t.boundingRect,l={x:h.x*v[0]+a[0],y:h.y*v[1]+a[1],width:h.width*v[0],height:h.height*v[1]},u=Math.min(h.width,h.height)/1e5,x=0;x<e.length;x++){var f=function(e,t){for(var n=[],r=0;r<e.length;r++){for(var i=e[r],o=[],a=i.length,v=i[a-1][0],h=i[a-1][1],l=0,u=0;u<a;u++){var x=i[u][0],f=i[u][1],s=x-v,c=f-h;t<(l+=Math.sqrt(s*s+c*c))&&(o.push(i[u]),l=0),v=x,h=f}3<=o.length&&n.push(o)}return 0<n.length?n:null}(e[x],u);if(f){var s=t.simplify/Math.max(v[0],v[1]);if(f=0<s?function(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r];3<=(i=A(i,t,!0)).length&&n.push(i)}return 0<n.length?n:null}(f,s):f){for(var c=d.flatten(f),p=c.vertices,s=c.holes,f=c.dimensions,g=0;g<p.length;)p[g]=p[g++]*v[0]+a[0],p[g]=p[g++]*v[1]+a[1];if(!function(e,t){var n=e.length/2,r=0,i=t&&t.length?t[0]:n;0<q(e,r,i)&&V(e,2,r,i);for(var o=1;o<(t?t.length:0)+1;o++)q(e,r=t[o-1],i=t[o]||n)<0&&V(e,2,r,i)}(p,s),2!==f)throw new Error("Only 2D polygon points are supported");c=0<t.bevelSize?P(p,s,t.bevelSize,null,!0):p,f=d(c,s,f=void 0===(f=f)?2:f);o.push({indices:f,vertices:p,topVertices:c,holes:s,rect:l,depth:"function"==typeof t.depth?t.depth(x):t.depth})}}}return k(o,t)}function _(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)D(e[i],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},W(t);var o=t.scale||[1,1];null==t.lineWidth&&(t.lineWidth=1),null==t.miterLimit&&(t.miterLimit=2);for(var a=[],v=0;v<e.length;v++){var h=e[v],l=t.simplify/Math.max(o[0],o[1]);0<l&&(h=A(h,l,!0)),a.push(function(e,t,n){for(var r=n.lineWidth,i=e.length,o=new Float32Array(2*i),a=n.translate||[0,0],v=n.scale||[1,1],h=0,l=0;h<i;h++)o[l++]=e[h][0]*v[0]+a[0],o[l++]=e[h][1]*v[1]+a[1];q(o,0,i)<0&&V(o,2,0,i);var u=[],x=[],f=n.miterLimit,s=O(o,x,0,i,0,-r/2,f,!1);V(o,2,0,i);for(var c=O(o,u,0,i,0,-r/2,f,!1),r=(u.length+x.length)/2,p=new Float32Array(2*r),g=0,d=x.length/2,y=0;y<x.length;y++)p[g++]=x[y];for(var m=0;m<u.length;m++)p[g++]=u[m];for(var b=new(65535<r?Uint32Array:Uint16Array)(3*(2*(i-1)+(r-2*i))),M=0,w=0;w<i-1;w++){var Z=w+1;b[M++]=d-1-s[w],b[M++]=d-1-s[w]-1,b[M++]=c[w]+1+d,b[M++]=d-1-s[w],b[M++]=c[w]+1+d,b[M++]=c[w]+d,c[Z]-c[w]==2?(b[M++]=c[w]+2+d,b[M++]=c[w]+1+d,b[M++]=d-s[Z]-1):s[Z]-s[w]==2&&(b[M++]=c[Z]+d,b[M++]=d-1-(s[w]+1),b[M++]=d-1-(s[w]+2))}return f=0<n.bevelSize?P(p,[],n.bevelSize,null,!0):p,r=n.boundingRect,{vertices:p,indices:b,topVertices:f,rect:{x:r.x*v[0]+a[0],y:r.y*v[1]+a[1],width:r.width*v[0],height:r.height*v[1]},depth:"function"==typeof n.depth?n.depth(t):n.depth,holes:[]}}(h,v,t))}return k(a,t)}function D(e,t,n){for(var r=0;r<e.length;r++)t[0]=Math.min(e[r][0],t[0]),t[1]=Math.min(e[r][1],t[1]),n[0]=Math.max(e[r][0],n[0]),n[1]=Math.max(e[r][1],n[1])}function E(e){for(var t=new Float32Array(e),n=[],r=0,i=t.length;r<i;r+=2){var o=t[r],a=t[r+1];n.push([o,a])}return n}function C(e,t){void 0===t&&(t=!1);for(var n,r,i,o,a=e.length,v=[],h=[],l=[],u=0,x=0,f=0,s=0,c=0;c<a;c++){var p=t?(p=e[c],r=i=n=o=i=r=n=void 0,n=p.data,r=p.height,i=p.width,o=p.bottomHeight,p=_(n,{lineWidth:i,depth:r}),n=p.position,i=p.normal,r=p.uv,p=p.indices,G(n,o),{position:n,normal:i,uv:r,indices:p}):(d=e[c],b=m=y=b=g=m=y=void 0,y=d.data,m=d.height,g=d.bottomHeight,b=I(y,{depth:m}),d=b.position,y=b.normal,m=b.uv,b=b.indices,G(d,g),{position:d,normal:y,uv:m,indices:b}),g=e[c].bottomHeight||0,d=p.position,y=p.normal,m=p.uv,b=p.indices;h.push(p);b=b.length/3;l[c]=[u+1,u+b],u+=b;d=d.length/3,y=y.length/3,m=m.length/2;v[c]={position:{middleZ:g+(e[c].height||0)/2,count:d,start:x,end:x+3*d},normal:{count:y,start:f,end:f+3*y},uv:{count:m,start:s,end:s+2*m},hide:!1},x+=3*d,f+=3*y,s+=2*m}var M=function(e){for(var t={},n={},r=0;r<e.length;++r){var i,o=e[r];for(i in o)void 0===t[i]&&(t[i]=[],n[i]=0),t[i].push(o[i]),n[i]+=o[i].length}var a,v={},h=0,l=[];for(a in t)if("indices"===a)for(var u=t[a],x=0,f=u.length;x<f;x++){for(var s=u[x],c=0,p=s.length;c<p;c++)l.push(s[c]+h);h+=t.position[x].length/3}else{var g=function(e,t){for(var n=new Float32Array(t),r=0,i=0;i<e.length;++i)n.set(e[i],r),r+=e[i].length;return n}(t[a],n[a]);if(!g)return null;v[a]=g}return v.indices=new Uint32Array(l),v}(h),w=M.position,Z=M.normal,S=M.uv,M=M.indices;return{position:w.buffer,normal:Z.buffer,uv:S.buffer,indices:M.buffer,faceMap:l,geometriesAttributes:v}}function G(e,t){if(void 0!==t&&"number"==typeof t&&0!==t)for(var n=0,r=e.length;n<r;n+=3)e[n+2]+=t}e.initialize=function(){},e.onmessage=function(e,t){var n=e.data,e=n.type,r=n.datas;if("Polygon"===e){!function(e){for(var t=e.length,n=0;n<t;n++)for(var r=e[n].data,i=0,o=r.length;i<o;i++)for(var a=r[i],v=0,h=a.length;v<h;v++)e[n].data[i][v]=E(a[v])}(r);n=C(r);t(null,n,[n.position,n.normal,n.uv,n.indices])}else if("LineString"===e){for(var i=0,o=r.length;i<o;i++)for(var a=0,v=r[i].data.length;a<v;a++)r[i].data[a]=E(r[i].data[a]);e=C(r,!0);t(null,e,[e.position,e.normal,e.uv,e.indices])}},Object.defineProperty(e,"__esModule",{value:!0})}');var uo=i(19),po=i.n(uo);function fo(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function mo(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function go(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):
/*!
 * maptalks.mapboxgl v0.3.3
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@>=0.29.0 
 */
function(t,e){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=i[n],o=Object.getOwnPropertyDescriptor(e,r);o&&o.configurable&&void 0===t[r]&&Object.defineProperty(t,r,o)}}(t,e))}var yo=function(t){function e(){return fo(this,e),mo(this,t.apply(this,arguments))}return go(e,t),e.fromJSON=function(t){return t&&"MapboxglLayer"===t.type?new e(t.id,t.options):null},e.prototype.getGlMap=function(){var t=this._getRenderer();return t?t.glmap:null},e.prototype.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}},e}(Ve.h);yo.mergeOptions({renderer:"dom",container:"back",glOptions:{style:"mapbox://styles/mapbox/streets-v9"}}),yo.registerJSONType("MapboxglLayer"),yo.registerRenderer("dom",function(){function t(e){fo(this,t),this.layer=e}return t.prototype.getMap=function(){return this.layer?this.layer.getMap():null},t.prototype.show=function(){this._container&&(this.render(),this._show())},t.prototype.hide=function(){this._container&&(this._hide(),this.clear())},t.prototype.remove=function(){delete this.layer,this.glmap&&this.glmap.remove(),this._container&&Ve.e.removeDomNode(this._container),delete this._container,delete this.glmap},t.prototype.clear=function(){this._container&&(this._container.innerHTML="")},t.prototype.setZIndex=function(t){this._zIndex=t,this._container&&(this._container.style.zIndex=t)},t.prototype.needToRedraw=function(){var t=this.getMap(),e=t._getRenderer();return t.isInteracting()||e&&e.isViewChanged()},t.prototype.render=function(){var t=this;if(this._container||this._createLayerContainer(),!this.glmap){var e=this.getMap(),i=e.getCenter(),n=Ve.o.extend({},this.layer.options.glOptions,{container:this._container,center:new po.a.LngLat(i.x,i.y),zoom:vo(e.getResolution())});this.glmap=new po.a.Map(n),this.glmap.on("load",(function(){t.layer.fire("layerload")}))}this._syncMap()},t.prototype.drawOnInteracting=function(){var t=this.getMap();this.glmap&&t&&this._syncMap()},t.prototype.getEvents=function(){return{resize:this.onResize}},t.prototype.onResize=function(){this._resize()},t.prototype._createLayerContainer=function(){var t=this._container=Ve.e.createEl("div","maptalks-mapboxgllayer");t.style.cssText="position:absolute;",this._resize(),this._zIndex&&(t.style.zIndex=this._zIndex),("front"===this.layer.options.container?this.getMap()._panels.frontStatic:this.getMap()._panels.backStatic).appendChild(t)},t.prototype._resize=function(){var t=this._container;if(t){var e=this.getMap().getSize();t.style.width=e.width+"px",t.style.height=e.height+"px",this.glmap&&this.glmap.resize()}},t.prototype._show=function(){this._container.style.display=""},t.prototype._hide=function(){this._container.style.display="none"},t.prototype._syncMap=function(){var t=this.getMap();if(this.glmap&&t){var e=t.getCenter(),i={center:new po.a.LngLat(e.x,e.y),zoom:vo(t.getResolution()),bearing:t.getBearing(),pitch:t.getPitch()};this.glmap.jumpTo(i)}},t}());var _o=12756274*Math.PI/(256*Math.pow(2,20));function vo(t){return 19-Math.log(t/_o)/Math.LN2}"undefined"!=typeof console&&console.log("maptalks.mapboxgl v0.3.3, requires maptalks@>=0.29.0.");var xo=i(22),bo=i.n(xo),wo=function(){function t(e,i,n){Object(s.a)(this,t),this.map=e,this.onBaseLayerChange=n,this.init(i)}return Object(l.a)(t,[{key:"init",value:function(t){var e=t.show,i=t.type,n=t.mapboxType,r=t.mapboxStyle,o=t.accessToken,a=t.style,s=t.xyzUrl;if(e){var l;if("mapbox"==i)l=new yo("tile","default"==n?{glOptions:{style:r,accessToken:"pk.eyJ1IjoiZWFzeXYiLCJhIjoiY2trM2Q0MGE2MTVrNjJycWRrbGZsYXF4MyJ9.KscWEGxP3mVPjlUJX0AJrA"}}:{glOptions:{style:a,accessToken:o}}),this.map.addLayer(l),l.getGlMap().addControl(new bo.a({defaultLanguage:"zh"})),this.layer=l;else if("xyz"==i){var c=new Ve.n("base",{urlTemplate:s,subdomains:["a","b","c","d"]});this.map.addLayer(c),this.layer=c}this.onBaseLayerChange(i)}}},{key:"update",value:function(t){this.layer&&this.map.removeLayer(this.layer),this.init(t)}},{key:"destory",value:function(){this.layer&&this.map.removeLayer(this.layer),this.layer=null,this.map=null}}]),t}();function Mo(t){var e=+t[0],i=+t[1],n=3.141592653589793,r=6378245,o=.006693421622965943;if(e<72.004||e>137.8347||i<.8293||i>55.8271)return[e,i];var a=function(t,e){var i=2*t-100+3*e+.2*e*e+.1*t*e+.2*Math.sqrt(Math.abs(t));return i+=2*(20*Math.sin(6*t*n)+20*Math.sin(2*t*n))/3,i+=2*(20*Math.sin(e*n)+40*Math.sin(e/3*n))/3,i+=2*(160*Math.sin(e/12*n)+320*Math.sin(e*n/30))/3}(e-105,i-35),s=function(t,e){var i=300+t+2*e+.1*t*t+.1*t*e+.1*Math.sqrt(Math.abs(t));return i+=2*(20*Math.sin(6*t*n)+20*Math.sin(2*t*n))/3,i+=2*(20*Math.sin(t*n)+40*Math.sin(t/3*n))/3,i+=2*(150*Math.sin(t/12*n)+300*Math.sin(t/30*n))/3}(e-105,i-35),l=i/180*n,c=Math.sin(l);c=1-o*c*c;var h=Math.sqrt(c);return a=180*a/(r*(1-o)/(c*h)*n),[2*e-(e+(s=180*s/(r/h*Math.cos(l)*n))),2*i-(i+a)]}function To(t){var e=+t[0],i=+t[1],n=3.141592653589793,r=6378245,o=.006693421622965943;if(e<72.004||e>137.8347||i<.8293||i>55.8271)return[e,i];var a=function(t,e){var i=2*t-100+3*e+.2*e*e+.1*t*e+.2*Math.sqrt(Math.abs(t));return i+=2*(20*Math.sin(6*t*n)+20*Math.sin(2*t*n))/3,i+=2*(20*Math.sin(e*n)+40*Math.sin(e/3*n))/3,i+=2*(160*Math.sin(e/12*n)+320*Math.sin(e*n/30))/3}(e-105,i-35),s=function(t,e){var i=300+t+2*e+.1*t*t+.1*t*e+.1*Math.sqrt(Math.abs(t));return i+=2*(20*Math.sin(6*t*n)+20*Math.sin(2*t*n))/3,i+=2*(20*Math.sin(t*n)+40*Math.sin(t/3*n))/3,i+=2*(150*Math.sin(t/12*n)+300*Math.sin(t/30*n))/3}(e-105,i-35),l=i/180*n,c=Math.sin(l);c=1-o*c*c;var h=Math.sqrt(c);return a=180*a/(r*(1-o)/(c*h)*n),[e+(s=180*s/(r/h*Math.cos(l)*n)),i+a]}var So=function(t){return 180*t/Math.PI},Eo=function(t){return t*Math.PI/180},Co=function(t){var e=t.zoom,i=t.bearing,n=t.pitch,r=t.center;return{zoom:e,bearing:i,pitch:n,lng:r[0],lat:r[1]}},Ao=function(t){return{zoom:t.zoom,bearing:t.bearing,pitch:t.pitch,center:[t.lng,t.lat]}},Po=function(){function t(e){var i=this;Object(s.a)(this,t),this.city=void 0,this.map=void 0,this.timer=void 0,this.tween_fly=void 0,this.cameraRotate=function(t){if(i.map){var e=i.map.getBearing();i.city.mouseDown||i.map.setBearing(e+t/60),i.timer=requestAnimationFrame((function(){i.cameraRotate(t)}))}},this.cameraFly=function(t){var e=t.target,r=t.time,o=t.callback;if(i.map){var a=i.map.getView();i.tween_fly=Me({from:Co(a),to:Co(e),ease:n.linear,duration:1e3*r}).start({update:function(t){var e=Ao(t);i.map.setView(e)},complete:function(){i.tween_fly=null,o&&o()}})}},this.cameraCruise=function(t){var e=t.cameras,r=t.loop,o=t.index;if(i.map){var a=i.map.getView(),s=e[o];i.tween_fly=Me({from:Co(a),to:Co(s),ease:n.linear,duration:e[o-1]?1e3*e[o-1].time:1e3*e[e.length-1].time}).start({update:function(t){var e=Ao(t);i.map.setView(e)},complete:function(){var t=o+1;t>e.length-1?r?(t=0,i.cameraCruise({cameras:e,loop:r,index:t})):i.tween_fly=null:i.cameraCruise({cameras:e,loop:r,index:t})}})}},this.cameraSwitch=function(t){i.map&&i.map.setView(t)},this.dispatchCameraUpdate=function(){var t=i.map.getView(),e=i.city.props.updateConfig;e&&e({type:"camera",payload:Co(t)})},this.getOptions=function(t){var e=t.sceneConfig.scenes;return Object.keys(e).map((function(t,e){return{name:"场景"+(e+1),value:t}}))},this.updateScenes=function(t){var e=i.city.props.updateConfig;e&&e({type:"actions",payload:{path:["sceneId"],value:i.getOptions(t),field:"options",actionName:"animateScene"}})},this.handleStateUpdate=function(t){var e=t.data,n=e.value,r=e.type;if(i.city.props.edit)if("camera"===r)i.stopFly(),i.stopRotate(),i.cameraSwitch(n);else if("animation"===r){var o=n.type,a=n.value;"play"===o?i.tween_fly?"rotate"===a.type?i.cameraRotate(a.speed):i.resumeFly():i.animateScene(a):"pause"===o?(i.pauseFly(),i.stopRotate()):"reset"===o&&(i.stopFly(),i.stopRotate(),i.switchScene(a))}},this.handlerAction=function(t){var e=t.data,n=void 0===e?{}:e,r=i.city.config.sceneConfig.scenes[n.sceneId];i.animateScene(r)},this.city=e,this.map=e.map,this.timer=null,this.tween_fly=null,this.addListener()}return Object(l.a)(t,[{key:"stopRotate",value:function(){this.timer&&cancelAnimationFrame(this.timer),this.timer=null}},{key:"stopFly",value:function(){this.tween_fly&&this.tween_fly.stop(),this.tween_fly=null}},{key:"pauseFly",value:function(){this.tween_fly&&this.tween_fly.pause()}},{key:"resumeFly",value:function(){this.tween_fly&&this.tween_fly.resume()}},{key:"animateScene",value:function(t){var e=this;if(t){this.stopFly(),this.stopRotate();var i=t.open,n=t.type,r=t.entranceTime,o=t.defaultCamera,a=t.rotateCamera,s=t.speed,l=t.flyCameras,c=t.loop;i?"rotate"==n?this.cameraFly({target:a,time:r,callback:function(){e.cameraRotate(s)}}):this.cameraFly({target:l[0],time:r,callback:function(){e.cameraCruise({cameras:l,loop:c,index:1})}}):this.cameraFly({target:o,time:r})}}},{key:"switchScene",value:function(t){if(t){var e,i=t.open,n=t.type,r=t.defaultCamera,o=t.rotateCamera,a=t.flyCameras;(e=i?"rotate"==n?o:a[0]:r)&&this.cameraSwitch(e)}}},{key:"addListener",value:function(){document.addEventListener("updateState",this.handleStateUpdate,!1),document.addEventListener("animateScene_".concat(this.city.props.id),this.handlerAction,!1)}},{key:"removeListener",value:function(){document.removeEventListener("updateState",this.handleStateUpdate),document.removeEventListener("animateScene_".concat(this.city.props.id),this.handlerAction)}},{key:"dispose",value:function(){this.removeListener(),this.stopFly(),this.stopRotate(),this.map=null,this.city=null}}]),t}(),Lo={86:{11e4:{cname:"北京市",pyname:"Bei Jing Shi",lon:"116.40717",lat:"39.90469"},12e4:{cname:"天津市",pyname:"Tian Jin Shi",lon:"117.199371",lat:"39.0851"},13e4:{cname:"河北省",pyname:"He Bei Sheng",lon:"114.469789",lat:"38.03599"},14e4:{cname:"山西省",pyname:"Shan Xi Sheng",lon:"112.562719",lat:"37.873431"},15e4:{cname:"内蒙古自治区",pyname:"Nei Meng Gu Zi Zhi Qu",lon:"111.765219",lat:"40.817331"},21e4:{cname:"辽宁省",pyname:"Liao Ning Sheng",lon:"123.429249",lat:"41.835651"},22e4:{cname:"吉林省",pyname:"Ji Lin Sheng",lon:"125.326799",lat:"43.896161"},23e4:{cname:"黑龙江省",pyname:"Hei Long Jiang Sheng",lon:"126.662849",lat:"45.742079"},31e4:{cname:"上海市",pyname:"Shang Hai Shi",lon:"121.47375",lat:"31.23026"},32e4:{cname:"江苏省",pyname:"Jiang Su Sheng",lon:"118.762949",lat:"32.06071"},33e4:{cname:"浙江省",pyname:"Zhe Jiang Sheng",lon:"120.1536",lat:"30.265549"},34e4:{cname:"安徽省",pyname:"An Hui Sheng",lon:"117.285651",lat:"31.861569"},35e4:{cname:"福建省",pyname:"Fu Jian Sheng",lon:"119.296591",lat:"26.09982"},36e4:{cname:"江西省",pyname:"Jiang Xi Sheng",lon:"115.910039",lat:"28.674171"},37e4:{cname:"山东省",pyname:"Shan Dong Sheng",lon:"117.020579",lat:"36.668251"},41e4:{cname:"河南省",pyname:"He Nan Sheng",lon:"113.75322",lat:"34.76571"},42e4:{cname:"湖北省",pyname:"Hu Bei Sheng",lon:"114.342339",lat:"30.545391"},43e4:{cname:"湖南省",pyname:"Hu Nan Sheng",lon:"112.983381",lat:"28.11263"},44e4:{cname:"广东省",pyname:"Guang Dong Sheng",lon:"113.26627",lat:"23.13171"},45e4:{cname:"广西壮族自治区",pyname:"Guang Xi Zhuang Zu Zi Zhi Qu",lon:"108.327611",lat:"22.815341"},46e4:{cname:"海南省",pyname:"Hai Nan Sheng",lon:"110.348631",lat:"20.01997"},5e5:{cname:"重庆市",pyname:"Chong Qing Shi",lon:"106.550729",lat:"29.564709"},51e4:{cname:"四川省",pyname:"Si Chuan Sheng",lon:"104.07572",lat:"30.650881"},52e4:{cname:"贵州省",pyname:"Gui Zhou Sheng",lon:"106.70722",lat:"26.598201"},53e4:{cname:"云南省",pyname:"Yun Nan Sheng",lon:"102.709731",lat:"25.045299"},54e4:{cname:"西藏自治区",pyname:"Xi Zang Zi Zhi Qu",lon:"91.11748",lat:"29.64725"},61e4:{cname:"陕西省",pyname:"Shan Xi Sheng",lon:"108.95424",lat:"34.264859"},62e4:{cname:"甘肃省",pyname:"Gan Su Sheng",lon:"103.826339",lat:"36.059421"},63e4:{cname:"青海省",pyname:"Qing Hai Sheng",lon:"101.780111",lat:"36.62087"},64e4:{cname:"宁夏回族自治区",pyname:"Ning Xia Hui Zu Zi Zhi Qu",lon:"106.25849",lat:"38.47122"},65e4:{cname:"新疆维吾尔自治区",pyname:"Xin Jiang Wei Wu Er Zi Zhi Qu",lon:"87.627101",lat:"43.793431"},71e4:{cname:"台湾",pyname:"Taiwan",lon:"120.883939",lat:"23.266025"},81e4:{cname:"香港",pyname:"Xiang Gang",lon:"114.162952",lat:"22.282068"},82e4:{cname:"澳门",pyname:"AoMen",lon:"113.54909",lat:"22.198951"}},13e4:{130100:{cname:"石家庄市",pyname:"Shi Jia Zhuang Shi",lon:"114.514299",lat:"38.04276"},130200:{cname:"唐山市",pyname:"Tang Shan Shi",lon:"118.180579",lat:"39.63048"},130300:{cname:"秦皇岛市",pyname:"Qin Huang Dao Shi",lon:"119.59964",lat:"39.935449"},130400:{cname:"邯郸市",pyname:"Han Dan Shi",lon:"114.53918",lat:"36.62556"},130500:{cname:"邢台市",pyname:"Xing Tai Shi",lon:"114.504429",lat:"37.070549"},130600:{cname:"保定市",pyname:"Bao Ding Shi",lon:"115.46459",lat:"38.873961"},130700:{cname:"张家口市",pyname:"Zhang Jia Kou Shi",lon:"114.88755",lat:"40.82444"},130800:{cname:"承德市",pyname:"Cheng De Shi",lon:"117.963401",lat:"40.9515"},130900:{cname:"沧州市",pyname:"Cang Zhou Shi",lon:"116.838689",lat:"38.30441"},131e3:{cname:"廊坊市",pyname:"Lang Fang Shi",lon:"116.683761",lat:"39.53775"},131100:{cname:"衡水市",pyname:"Heng Shui Shi",lon:"115.67054",lat:"37.738861"}},14e4:{140100:{cname:"太原市",pyname:"Tai Yuan Shi",lon:"112.550671",lat:"37.87059"},140200:{cname:"大同市",pyname:"Da Tong Shi",lon:"113.300011",lat:"40.076369"},140300:{cname:"阳泉市",pyname:"Yang Quan Shi",lon:"113.580471",lat:"37.85668"},140400:{cname:"长治市",pyname:"Chang Zhi Shi",lon:"113.116491",lat:"36.195809"},140500:{cname:"晋城市",pyname:"Jin Cheng Shi",lon:"112.851131",lat:"35.490391"},140600:{cname:"朔州市",pyname:"Shuo Zhou Shi",lon:"112.43181",lat:"39.331591"},140700:{cname:"晋中市",pyname:"Jin Zhong Shi",lon:"112.75278",lat:"37.68702"},140800:{cname:"运城市",pyname:"Yun Cheng Shi",lon:"111.00699",lat:"35.02628"},140900:{cname:"忻州市",pyname:"Xin Zhou Shi",lon:"112.73418",lat:"38.416699"},141e3:{cname:"临汾市",pyname:"Lin Fen Shi",lon:"111.51962",lat:"36.08822"},141100:{cname:"吕梁市",pyname:"Lv Liang Shi",lon:"111.141649",lat:"37.51934"}},15e4:{150100:{cname:"呼和浩特市",pyname:"Hu He Hao Te Shi",lon:"111.75199",lat:"40.841491"},150200:{cname:"包头市",pyname:"Bao Tou Shi",lon:"109.84026",lat:"40.65737"},150300:{cname:"乌海市",pyname:"Wu Hai Shi",lon:"106.79546",lat:"39.653839"},150400:{cname:"赤峰市",pyname:"Chi Feng Shi",lon:"118.888941",lat:"42.2586"},150500:{cname:"通辽市",pyname:"Tong Liao Shi",lon:"122.24469",lat:"43.65247"},150600:{cname:"鄂尔多斯市",pyname:"E Er Duo Si Shi",lon:"109.78174",lat:"39.607849"},150700:{cname:"呼伦贝尔市",pyname:"Hu Lun Bei Er Shi",lon:"119.76584",lat:"49.21163"},150800:{cname:"巴彦淖尔市",pyname:"Ba Yan Nao Er Shi",lon:"107.38773",lat:"40.743171"},150900:{cname:"乌兰察布市",pyname:"Wu Lan Cha Bu Shi",lon:"113.133761",lat:"40.993911"},152200:{cname:"兴安盟",pyname:"Xing An Meng",lon:"122.038179",lat:"46.082079"},152500:{cname:"锡林郭勒盟",pyname:"Xi Lin Guo Le Meng",lon:"116.04775",lat:"43.933201"},152900:{cname:"阿拉善盟",pyname:"A La Shan Meng",lon:"105.72898",lat:"38.85153"}},21e4:{210100:{cname:"沈阳市",pyname:"Shen Yang Shi",lon:"123.432359",lat:"41.805629"},210200:{cname:"大连市",pyname:"Da Lian Shi",lon:"121.614759",lat:"38.913689"},210300:{cname:"鞍山市",pyname:"An Shan Shi",lon:"122.994601",lat:"41.107769"},210400:{cname:"抚顺市",pyname:"Fu Shun Shi",lon:"123.95722",lat:"41.879709"},210500:{cname:"本溪市",pyname:"Ben Xi Shi",lon:"123.76686",lat:"41.29413"},210600:{cname:"丹东市",pyname:"Dan Dong Shi",lon:"124.356009",lat:"39.9998"},210700:{cname:"锦州市",pyname:"Jin Zhou Shi",lon:"121.127029",lat:"41.09515"},210800:{cname:"营口市",pyname:"Ying Kou Shi",lon:"122.2349",lat:"40.666829"},210900:{cname:"阜新市",pyname:"Fu Xin Shi",lon:"121.670111",lat:"42.02166"},211e3:{cname:"辽阳市",pyname:"Liao Yang Shi",lon:"123.237359",lat:"41.26809"},211100:{cname:"盘锦市",pyname:"Pan Jin Shi",lon:"122.070779",lat:"41.119961"},211200:{cname:"铁岭市",pyname:"Tie Ling Shi",lon:"123.842411",lat:"42.2862"},211300:{cname:"朝阳市",pyname:"Chao Yang Shi",lon:"120.450801",lat:"41.57347"},211400:{cname:"葫芦岛市",pyname:"Hu Lu Dao Shi",lon:"120.83699",lat:"40.711"}},22e4:{220100:{cname:"长春市",pyname:"Chang Chun Shi",lon:"125.32357",lat:"43.81602"},220200:{cname:"吉林市",pyname:"Ji Lin Shi",lon:"126.54944",lat:"43.837841"},220300:{cname:"四平市",pyname:"Si Ping Shi",lon:"124.35036",lat:"43.166461"},220400:{cname:"辽源市",pyname:"Liao Yuan Shi",lon:"125.143681",lat:"42.888049"},220500:{cname:"通化市",pyname:"Tong Hua Shi",lon:"125.9399",lat:"41.72829"},220600:{cname:"白山市",pyname:"Bai Shan Shi",lon:"126.424429",lat:"41.940801"},220700:{cname:"松原市",pyname:"Song Yuan Shi",lon:"124.82515",lat:"45.1411"},220800:{cname:"白城市",pyname:"Bai Cheng Shi",lon:"122.838711",lat:"45.619601"},222400:{cname:"延边朝鲜族自治州",pyname:"Yan Bian Chao Xian Zu Zi Zhi Zhou",lon:"129.509099",lat:"42.891189"}},23e4:{230100:{cname:"哈尔滨市",pyname:"Ha Er Bin Shi",lon:"126.535801",lat:"45.802159"},230200:{cname:"齐齐哈尔市",pyname:"Qi Qi Ha Er Shi",lon:"123.91796",lat:"47.35431"},230300:{cname:"鸡西市",pyname:"Ji Xi Shi",lon:"130.96954",lat:"45.295241"},230400:{cname:"鹤岗市",pyname:"He Gang Shi",lon:"130.297849",lat:"47.349889"},230500:{cname:"双鸭山市",pyname:"Shuang Ya Shan Shi",lon:"131.159099",lat:"46.64658"},230600:{cname:"大庆市",pyname:"Da Qing Shi",lon:"125.103071",lat:"46.58758"},230700:{cname:"伊春市",pyname:"Yi Chun Shi",lon:"128.84049",lat:"47.72752"},230800:{cname:"佳木斯市",pyname:"Jia Mu Si Shi",lon:"130.320599",lat:"46.800191"},230900:{cname:"七台河市",pyname:"Qi Tai He Shi",lon:"131.00306",lat:"45.770651"},231e3:{cname:"牡丹江市",pyname:"Mu Dan Jiang Shi",lon:"129.632439",lat:"44.552691"},231100:{cname:"黑河市",pyname:"Hei He Shi",lon:"127.52852",lat:"50.24523"},231200:{cname:"绥化市",pyname:"Sui Hua Shi",lon:"126.969321",lat:"46.652461"},232700:{cname:"大兴安岭地区",pyname:"Da Xing An Ling Di Qu",lon:"124.592159",lat:"51.92398"}},32e4:{320100:{cname:"南京市",pyname:"Nan Jing Shi",lon:"118.796469",lat:"32.058381"},320200:{cname:"无锡市",pyname:"Wu Xi Shi",lon:"120.31237",lat:"31.49099"},320300:{cname:"徐州市",pyname:"Xu Zhou Shi",lon:"117.28577",lat:"34.204401"},320400:{cname:"常州市",pyname:"Chang Zhou Shi",lon:"119.97365",lat:"31.81072"},320500:{cname:"苏州市",pyname:"Su Zhou Shi",lon:"120.58319",lat:"31.29834"},320600:{cname:"南通市",pyname:"Nan Tong Shi",lon:"120.893711",lat:"31.979579"},320700:{cname:"连云港市",pyname:"Lian Yun Gang Shi",lon:"119.222949",lat:"34.596691"},320800:{cname:"淮安市",pyname:"Huai An Shi",lon:"119.015951",lat:"33.610161"},320900:{cname:"盐城市",pyname:"Yan Cheng Shi",lon:"120.161641",lat:"33.34951"},321e3:{cname:"扬州市",pyname:"Yang Zhou Shi",lon:"119.412691",lat:"32.393581"},321100:{cname:"镇江市",pyname:"Zhen Jiang Shi",lon:"119.425",lat:"32.18959"},321200:{cname:"泰州市",pyname:"Tai Zhou Shi",lon:"119.92554",lat:"32.45546"},321300:{cname:"宿迁市",pyname:"Su Qian Shi",lon:"118.27549",lat:"33.961929"}},33e4:{330100:{cname:"杭州市",pyname:"Hang Zhou Shi",lon:"120.15515",lat:"30.274149"},330200:{cname:"宁波市",pyname:"Ning Bo Shi",lon:"121.550269",lat:"29.873861"},330300:{cname:"温州市",pyname:"Wen Zhou Shi",lon:"120.69939",lat:"27.99492"},330400:{cname:"嘉兴市",pyname:"Jia Xing Shi",lon:"120.755499",lat:"30.745011"},330500:{cname:"湖州市",pyname:"Hu Zhou Shi",lon:"120.088049",lat:"30.893049"},330600:{cname:"绍兴市",pyname:"Shao Xing Shi",lon:"120.5802",lat:"30.03033"},330700:{cname:"金华市",pyname:"Jin Hua Shi",lon:"119.647589",lat:"29.078121"},330800:{cname:"衢州市",pyname:"Qu Zhou Shi",lon:"118.874191",lat:"28.93592"},330900:{cname:"舟山市",pyname:"Zhou Shan Shi",lon:"122.20778",lat:"29.985391"},331e3:{cname:"台州市",pyname:"Tai Zhou Shi",lon:"121.42056",lat:"28.656109"},331100:{cname:"丽水市",pyname:"Li Shui Shi",lon:"119.92293",lat:"28.467201"}},34e4:{340100:{cname:"合肥市",pyname:"He Fei Shi",lon:"117.22901",lat:"31.820571"},340200:{cname:"芜湖市",pyname:"Wu Hu Shi",lon:"118.43321",lat:"31.351569"},340300:{cname:"蚌埠市",pyname:"Beng Bu Shi",lon:"117.389321",lat:"32.91548"},340400:{cname:"淮南市",pyname:"Huai Nan Shi",lon:"116.9998",lat:"32.62549"},340500:{cname:"马鞍山市",pyname:"Ma An Shan Shi",lon:"118.506109",lat:"31.670671"},340600:{cname:"淮北市",pyname:"Huai Bei Shi",lon:"116.79834",lat:"33.954789"},340700:{cname:"铜陵市",pyname:"Tong Ling Shi",lon:"117.81232",lat:"30.944859"},340800:{cname:"安庆市",pyname:"An Qing Shi",lon:"117.063539",lat:"30.542941"},341e3:{cname:"黄山市",pyname:"Huang Shan Shi",lon:"118.338661",lat:"29.715169"},341100:{cname:"滁州市",pyname:"Chu Zhou Shi",lon:"118.316829",lat:"32.30181"},341200:{cname:"阜阳市",pyname:"Fu Yang Shi",lon:"115.81495",lat:"32.889631"},341300:{cname:"宿州市",pyname:"Su Zhou Shi",lon:"116.963911",lat:"33.646139"},341500:{cname:"六安市",pyname:"Lu An Shi",lon:"116.52324",lat:"31.734881"},341600:{cname:"亳州市",pyname:"Bo Zhou Shi",lon:"115.77931",lat:"33.844609"},341700:{cname:"池州市",pyname:"Chi Zhou Shi",lon:"117.491419",lat:"30.66469"},341800:{cname:"宣城市",pyname:"Xuan Cheng Shi",lon:"118.758661",lat:"30.940779"}},35e4:{350100:{cname:"福州市",pyname:"Fu Zhou Shi",lon:"119.296469",lat:"26.07421"},350200:{cname:"厦门市",pyname:"Xia Men Shi",lon:"118.089479",lat:"24.47951"},350300:{cname:"莆田市",pyname:"Pu Tian Shi",lon:"119.007711",lat:"25.454"},350400:{cname:"三明市",pyname:"San Ming Shi",lon:"117.639221",lat:"26.26385"},350500:{cname:"泉州市",pyname:"Quan Zhou Shi",lon:"118.67587",lat:"24.873891"},350600:{cname:"漳州市",pyname:"Zhang Zhou Shi",lon:"117.64725",lat:"24.51347"},350700:{cname:"南平市",pyname:"Nan Ping Shi",lon:"118.17783",lat:"26.641519"},350800:{cname:"龙岩市",pyname:"Long Yan Shi",lon:"117.01722",lat:"25.075039"},350900:{cname:"宁德市",pyname:"Ning De Shi",lon:"119.54819",lat:"26.66571"}},36e4:{360100:{cname:"南昌市",pyname:"Nan Chang Shi",lon:"115.857941",lat:"28.68202"},360200:{cname:"景德镇市",pyname:"Jing De Zhen Shi",lon:"117.17839",lat:"29.268689"},360300:{cname:"萍乡市",pyname:"Ping Xiang Shi",lon:"113.854271",lat:"27.622891"},360400:{cname:"九江市",pyname:"Jiu Jiang Shi",lon:"116.001461",lat:"29.70548"},360500:{cname:"新余市",pyname:"Xin Yu Shi",lon:"114.917131",lat:"27.81776"},360600:{cname:"鹰潭市",pyname:"Ying Tan Shi",lon:"117.069191",lat:"28.260191"},360700:{cname:"赣州市",pyname:"Gan Zhou Shi",lon:"114.934759",lat:"25.831089"},360800:{cname:"吉安市",pyname:"Ji An Shi",lon:"114.993761",lat:"27.113819"},360900:{cname:"宜春市",pyname:"Yi Chun Shi",lon:"114.41612",lat:"27.814429"},361e3:{cname:"抚州市",pyname:"Fu Zhou Shi",lon:"116.35809",lat:"27.94781"},361100:{cname:"上饶市",pyname:"Shang Rao Shi",lon:"117.94357",lat:"28.454631"}},37e4:{370100:{cname:"济南市",pyname:"Ji Nan Shi",lon:"116.994931",lat:"36.665291"},370200:{cname:"青岛市",pyname:"Qing Dao Shi",lon:"120.38299",lat:"36.06623"},370300:{cname:"淄博市",pyname:"Zi Bo Shi",lon:"118.0548",lat:"36.813099"},370400:{cname:"枣庄市",pyname:"Zao Zhuang Shi",lon:"117.32196",lat:"34.81071"},370500:{cname:"东营市",pyname:"Dong Ying Shi",lon:"118.674659",lat:"37.43365"},370600:{cname:"烟台市",pyname:"Yan Tai Shi",lon:"121.44801",lat:"37.463531"},370700:{cname:"潍坊市",pyname:"Wei Fang Shi",lon:"119.16176",lat:"36.70686"},370800:{cname:"济宁市",pyname:"Ji Ning Shi",lon:"116.58724",lat:"35.41459"},370900:{cname:"泰安市",pyname:"Tai An Shi",lon:"117.088401",lat:"36.199939"},371e3:{cname:"威海市",pyname:"Wei Hai Shi",lon:"122.12171",lat:"37.513481"},371100:{cname:"日照市",pyname:"Ri Zhao Shi",lon:"119.52719",lat:"35.416461"},371200:{cname:"莱芜市",pyname:"Lai Wu Shi",lon:"117.676671",lat:"36.213589"},371300:{cname:"临沂市",pyname:"Lin Yi Shi",lon:"118.356461",lat:"35.104651"},371400:{cname:"德州市",pyname:"De Zhou Shi",lon:"116.359271",lat:"37.435499"},371500:{cname:"聊城市",pyname:"Liao Cheng Shi",lon:"115.98549",lat:"36.45702"},371600:{cname:"滨州市",pyname:"Bin Zhou Shi",lon:"117.972791",lat:"37.382109"},371700:{cname:"菏泽市",pyname:"He Ze Shi",lon:"115.48115",lat:"35.233631"}},41e4:{410100:{cname:"郑州市",pyname:"Zheng Zhou Shi",lon:"113.624931",lat:"34.74725"},410200:{cname:"开封市",pyname:"Kai Feng Shi",lon:"114.307309",lat:"34.797259"},410300:{cname:"洛阳市",pyname:"Luo Yang Shi",lon:"112.453609",lat:"34.618121"},410400:{cname:"平顶山市",pyname:"Ping Ding Shan Shi",lon:"113.192411",lat:"33.766089"},410500:{cname:"安阳市",pyname:"An Yang Shi",lon:"114.393099",lat:"36.097711"},410600:{cname:"鹤壁市",pyname:"He Bi Shi",lon:"114.29745",lat:"35.747001"},410700:{cname:"新乡市",pyname:"Xin Xiang Shi",lon:"113.926749",lat:"35.303229"},410800:{cname:"焦作市",pyname:"Jiao Zuo Shi",lon:"113.24201",lat:"35.215629"},410900:{cname:"濮阳市",pyname:"Pu Yang Shi",lon:"115.029321",lat:"35.76189"},411e3:{cname:"许昌市",pyname:"Xu Chang Shi",lon:"113.852331",lat:"34.035701"},411100:{cname:"漯河市",pyname:"Luo He Shi",lon:"114.01681",lat:"33.581491"},411200:{cname:"三门峡市",pyname:"San Men Xia Shi",lon:"111.200299",lat:"34.772611"},411300:{cname:"南阳市",pyname:"Nan Yang Shi",lon:"112.528509",lat:"32.990729"},411400:{cname:"商丘市",pyname:"Shang Qiu Shi",lon:"115.65635",lat:"34.414271"},411500:{cname:"信阳市",pyname:"Xin Yang Shi",lon:"114.092791",lat:"32.14714"},411600:{cname:"周口市",pyname:"Zhou Kou Shi",lon:"114.696951",lat:"33.625829"},411700:{cname:"驻马店市",pyname:"Zhu Ma Dian Shi",lon:"114.02299",lat:"33.011419"},419001:{cname:"济源市",pyname:"Ji Yuan Shi",lon:"112.60273",lat:"35.06707"}},42e4:{420100:{cname:"武汉市",pyname:"Wu Han Shi",lon:"114.30525",lat:"30.59276"},420200:{cname:"黄石市",pyname:"Huang Shi Shi",lon:"115.0389",lat:"30.199529"},420300:{cname:"十堰市",pyname:"Shi Yan Shi",lon:"110.79801",lat:"32.62918"},420500:{cname:"宜昌市",pyname:"Yi Chang Shi",lon:"111.286419",lat:"30.69186"},420600:{cname:"襄阳市",pyname:"Xiang Yang Shi",lon:"112.12255",lat:"32.009"},420700:{cname:"鄂州市",pyname:"E Zhou Shi",lon:"114.89495",lat:"30.390851"},420800:{cname:"荆门市",pyname:"Jing Men Shi",lon:"112.199451",lat:"31.03546"},420900:{cname:"孝感市",pyname:"Xiao Gan Shi",lon:"113.91645",lat:"30.924831"},421e3:{cname:"荆州市",pyname:"Jing Zhou Shi",lon:"112.24069",lat:"30.334789"},421100:{cname:"黄冈市",pyname:"Huang Gang Shi",lon:"114.872381",lat:"30.45347"},421200:{cname:"咸宁市",pyname:"Xian Ning Shi",lon:"114.32245",lat:"29.841261"},421300:{cname:"随州市",pyname:"Sui Zhou Shi",lon:"113.382619",lat:"31.69013"},422800:{cname:"恩施土家族苗族自治州",pyname:"En Shi Tu Jia Zu Miao Zu Zi Zhi Zhou",lon:"109.488171",lat:"30.27217"},429004:{cname:"仙桃市",pyname:"Xian Tao Shi",lon:"113.454501",lat:"30.362511"},429005:{cname:"潜江市",pyname:"Qian Jiang Shi",lon:"112.899299",lat:"30.401469"},429006:{cname:"天门市",pyname:"Tian Men Shi",lon:"113.166139",lat:"30.66339"},429021:{cname:"神农架林区",pyname:"Shen Nong Jia Lin Qu",lon:"110.67556",lat:"31.74457"}},43e4:{430100:{cname:"长沙市",pyname:"Chang Sha Shi",lon:"112.938861",lat:"28.22778"},430200:{cname:"株洲市",pyname:"Zhu Zhou Shi",lon:"113.133961",lat:"27.827669"},430300:{cname:"湘潭市",pyname:"Xiang Tan Shi",lon:"112.94411",lat:"27.82975"},430400:{cname:"衡阳市",pyname:"Heng Yang Shi",lon:"112.571951",lat:"26.89324"},430500:{cname:"邵阳市",pyname:"Shao Yang Shi",lon:"111.4677",lat:"27.2389"},430600:{cname:"岳阳市",pyname:"Yue Yang Shi",lon:"113.129191",lat:"29.357281"},430700:{cname:"常德市",pyname:"Chang De Shi",lon:"111.698539",lat:"29.03158"},430800:{cname:"张家界市",pyname:"Zhang Jia Jie Shi",lon:"110.47839",lat:"29.116671"},430900:{cname:"益阳市",pyname:"Yi Yang Shi",lon:"112.355161",lat:"28.553911"},431e3:{cname:"郴州市",pyname:"Chen Zhou Shi",lon:"113.01485",lat:"25.770629"},431100:{cname:"永州市",pyname:"Yong Zhou Shi",lon:"111.61225",lat:"26.420341"},431200:{cname:"怀化市",pyname:"Huai Hua Shi",lon:"110.001599",lat:"27.56974"},431300:{cname:"娄底市",pyname:"Lou Di Shi",lon:"111.994579",lat:"27.697281"},433100:{cname:"湘西土家族苗族自治州",pyname:"Xiang Xi Tu Jia Zu Miao Zu Zi Zhi Zhou",lon:"109.73893",lat:"28.31173"}},44e4:{440100:{cname:"广州市",pyname:"Guang Zhou Shi",lon:"113.26388",lat:"23.12946"},440200:{cname:"韶关市",pyname:"Shao Guan Shi",lon:"113.597231",lat:"24.810391"},440300:{cname:"深圳市",pyname:"Shen Zhen Shi",lon:"114.059559",lat:"22.54286"},440400:{cname:"珠海市",pyname:"Zhu Hai Shi",lon:"113.57668",lat:"22.270729"},440500:{cname:"汕头市",pyname:"Shan Tou Shi",lon:"116.682209",lat:"23.3535"},440600:{cname:"佛山市",pyname:"Fo Shan Shi",lon:"113.121921",lat:"23.021849"},440700:{cname:"江门市",pyname:"Jiang Men Shi",lon:"113.08161",lat:"22.57865"},440800:{cname:"湛江市",pyname:"Zhan Jiang Shi",lon:"110.358941",lat:"21.271339"},440900:{cname:"茂名市",pyname:"Mao Ming Shi",lon:"110.92523",lat:"21.66329"},441200:{cname:"肇庆市",pyname:"Zhao Qing Shi",lon:"112.46528",lat:"23.046901"},441300:{cname:"惠州市",pyname:"Hui Zhou Shi",lon:"114.41679",lat:"23.110751"},441400:{cname:"梅州市",pyname:"Mei Zhou Shi",lon:"116.122641",lat:"24.28844"},441500:{cname:"汕尾市",pyname:"Shan Wei Shi",lon:"115.375141",lat:"22.78566"},441600:{cname:"河源市",pyname:"He Yuan Shi",lon:"114.700651",lat:"23.74365"},441700:{cname:"阳江市",pyname:"Yang Jiang Shi",lon:"111.98288",lat:"21.858739"},441800:{cname:"清远市",pyname:"Qing Yuan Shi",lon:"113.05615",lat:"23.68201"},441900:{cname:"东莞市",pyname:"Dong Guan Shi",lon:"113.75161",lat:"23.02"},442e3:{cname:"中山市",pyname:"Zhong Shan Shi",lon:"113.3926",lat:"22.515951"},445100:{cname:"潮州市",pyname:"Chao Zhou Shi",lon:"116.62296",lat:"23.656699"},445200:{cname:"揭阳市",pyname:"Jie Yang Shi",lon:"116.372711",lat:"23.54972"},445300:{cname:"云浮市",pyname:"Yun Fu Shi",lon:"112.044559",lat:"22.915169"}},45e4:{450100:{cname:"南宁市",pyname:"Nan Ning Shi",lon:"108.366901",lat:"22.81673"},450200:{cname:"柳州市",pyname:"Liu Zhou Shi",lon:"109.415521",lat:"24.32543"},450300:{cname:"桂林市",pyname:"Gui Lin Shi",lon:"110.29002",lat:"25.273609"},450400:{cname:"梧州市",pyname:"Wu Zhou Shi",lon:"111.27913",lat:"23.477029"},450500:{cname:"北海市",pyname:"Bei Hai Shi",lon:"109.12008",lat:"21.48112"},450600:{cname:"防城港市",pyname:"Fang Cheng Gang Shi",lon:"108.354019",lat:"21.68712"},450700:{cname:"钦州市",pyname:"Qin Zhou Shi",lon:"108.65431",lat:"21.979701"},450800:{cname:"贵港市",pyname:"Gui Gang Shi",lon:"109.597641",lat:"23.11306"},450900:{cname:"玉林市",pyname:"Yu Lin Shi",lon:"110.180981",lat:"22.65451"},451e3:{cname:"百色市",pyname:"Bai Se Shi",lon:"106.618381",lat:"23.902159"},451100:{cname:"贺州市",pyname:"He Zhou Shi",lon:"111.566549",lat:"24.403459"},451200:{cname:"河池市",pyname:"He Chi Shi",lon:"108.085399",lat:"24.69291"},451300:{cname:"来宾市",pyname:"Lai Bin Shi",lon:"109.222381",lat:"23.752101"},451400:{cname:"崇左市",pyname:"Chong Zuo Shi",lon:"107.36485",lat:"22.37895"}},46e4:{460100:{cname:"海口市",pyname:"Hai Kou Shi",lon:"110.199889",lat:"20.044221"},460200:{cname:"三亚市",pyname:"San Ya Shi",lon:"109.51209",lat:"18.25248"},460300:{cname:"三沙市",pyname:"San Sha Shi",lon:"112.333559",lat:"16.832719"},469001:{cname:"五指山市",pyname:"Wu Zhi Shan Shi",lon:"109.51696",lat:"18.77515"},469002:{cname:"琼海市",pyname:"Qiong Hai Shi",lon:"110.47464",lat:"19.258381"},469003:{cname:"儋州市",pyname:"Dan Zhou Shi",lon:"109.58069",lat:"19.520931"},469005:{cname:"文昌市",pyname:"Wen Chang Shi",lon:"110.797741",lat:"19.54329"},469006:{cname:"万宁市",pyname:"Wan Ning Shi",lon:"110.38975",lat:"18.795319"},469007:{cname:"东方市",pyname:"Dong Fang Shi",lon:"108.65367",lat:"19.096139"},469021:{cname:"定安县",pyname:"Ding An Xian",lon:"110.359299",lat:"19.681211"},469022:{cname:"屯昌县",pyname:"Tun Chang Xian",lon:"110.10347",lat:"19.351821"},469023:{cname:"澄迈县",pyname:"Cheng Mai Xian",lon:"110.00487",lat:"19.73849"},469024:{cname:"临高县",pyname:"Lin Gao Xian",lon:"109.69077",lat:"19.912431"},469025:{cname:"白沙黎族自治县",pyname:"Bai Sha Li Zu Zi Zhi Xian",lon:"109.451519",lat:"19.22492"},469026:{cname:"昌江黎族自治县",pyname:"Chang Jiang Li Zu Zi Zhi Xian",lon:"109.05559",lat:"19.298279"},469027:{cname:"乐东黎族自治县",pyname:"Le Dong Li Zu Zi Zhi Xian",lon:"109.173609",lat:"18.749859"},469028:{cname:"陵水黎族自治县",pyname:"Ling Shui Li Zu Zi Zhi Xian",lon:"110.037201",lat:"18.505959"},469029:{cname:"保亭黎族苗族自治县",pyname:"Bao Ting Li Zu Miao Zu Zi Zhi Xian",lon:"109.702589",lat:"18.639049"},469030:{cname:"琼中黎族苗族自治县",pyname:"Qiong Zhong Li Zu Miao Zu Zi Zhi Xian",lon:"109.83839",lat:"19.03334"}},51e4:{510100:{cname:"成都市",pyname:"Cheng Du Shi",lon:"104.064759",lat:"30.5702"},510300:{cname:"自贡市",pyname:"Zi Gong Shi",lon:"104.77844",lat:"29.339199"},510400:{cname:"攀枝花市",pyname:"Pan Zhi Hua Shi",lon:"101.71872",lat:"26.582281"},510500:{cname:"泸州市",pyname:"Lu Zhou Shi",lon:"105.442569",lat:"28.871699"},510600:{cname:"德阳市",pyname:"De Yang Shi",lon:"104.397899",lat:"31.12679"},510700:{cname:"绵阳市",pyname:"Mian Yang Shi",lon:"104.679019",lat:"31.467439"},510800:{cname:"广元市",pyname:"Guang Yuan Shi",lon:"105.84357",lat:"32.43549"},510900:{cname:"遂宁市",pyname:"Sui Ning Shi",lon:"105.59273",lat:"30.53286"},511e3:{cname:"内江市",pyname:"Nei Jiang Shi",lon:"105.05844",lat:"29.58015"},511100:{cname:"乐山市",pyname:"Le Shan Shi",lon:"103.765391",lat:"29.552209"},511300:{cname:"南充市",pyname:"Nan Chong Shi",lon:"106.110729",lat:"30.837309"},511400:{cname:"眉山市",pyname:"Mei Shan Shi",lon:"103.84855",lat:"30.075521"},511500:{cname:"宜宾市",pyname:"Yi Bin Shi",lon:"104.641699",lat:"28.7513"},511600:{cname:"广安市",pyname:"Guang An Shi",lon:"106.63322",lat:"30.455959"},511700:{cname:"达州市",pyname:"Da Zhou Shi",lon:"107.46791",lat:"31.208639"},511800:{cname:"雅安市",pyname:"Ya An Shi",lon:"103.0398",lat:"30.01543"},511900:{cname:"巴中市",pyname:"Ba Zhong Shi",lon:"106.747331",lat:"31.867151"},512e3:{cname:"资阳市",pyname:"Zi Yang Shi",lon:"104.62798",lat:"30.128589"},513200:{cname:"阿坝藏族羌族自治州",pyname:"A Ba Zang Zu Qiang Zu Zi Zhi Zhou",lon:"102.22477",lat:"31.899401"},513300:{cname:"甘孜藏族自治州",pyname:"Gan Zi Zang Zu Zi Zhi Zhou",lon:"101.962539",lat:"30.049321"},513400:{cname:"凉山彝族自治州",pyname:"Liang Shan Yi Zu Zi Zhi Zhou",lon:"102.267461",lat:"27.881641"}},52e4:{520100:{cname:"贵阳市",pyname:"Gui Yang Shi",lon:"106.630241",lat:"26.64702"},520200:{cname:"六盘水市",pyname:"Liu Pan Shui Shi",lon:"104.83023",lat:"26.593359"},520300:{cname:"遵义市",pyname:"Zun Yi Shi",lon:"106.927231",lat:"27.725449"},520400:{cname:"安顺市",pyname:"An Shun Shi",lon:"105.9462",lat:"26.25367"},520500:{cname:"毕节市",pyname:"Bi Jie Shi",lon:"105.305039",lat:"27.29847"},520600:{cname:"铜仁市",pyname:"Tong Ren Shi",lon:"109.18099",lat:"27.69066"},522300:{cname:"黔西南布依族苗族自治州",pyname:"Qian Xi Nan Bu Yi Zu Miao Zu Zi Zhi Zhou",lon:"104.904371",lat:"25.089881"},522600:{cname:"黔东南苗族侗族自治州",pyname:"Qian Dong Nan Miao Zu Dong Zu Zi Zhi Zhou",lon:"107.98416",lat:"26.583639"},522700:{cname:"黔南布依族苗族自治州",pyname:"Qian Nan Bu Yi Zu Miao Zu Zi Zhi Zhou",lon:"107.522259",lat:"26.254271"}},53e4:{530100:{cname:"昆明市",pyname:"Kun Ming Shi",lon:"102.83322",lat:"24.879659"},530300:{cname:"曲靖市",pyname:"Qu Jing Shi",lon:"103.79625",lat:"25.49002"},530400:{cname:"玉溪市",pyname:"Yu Xi Shi",lon:"102.546599",lat:"24.351929"},530500:{cname:"保山市",pyname:"Bao Shan Shi",lon:"99.16181",lat:"25.112051"},530600:{cname:"昭通市",pyname:"Zhao Tong Shi",lon:"103.716799",lat:"27.338171"},530700:{cname:"丽江市",pyname:"Li Jiang Shi",lon:"100.227101",lat:"26.85648"},530800:{cname:"普洱市",pyname:"Pu Er Shi",lon:"100.966239",lat:"22.825211"},530900:{cname:"临沧市",pyname:"Lin Cang Shi",lon:"100.088839",lat:"23.88426"},532300:{cname:"楚雄彝族自治州",pyname:"Chu Xiong Yi Zu Zi Zhi Zhou",lon:"101.527669",lat:"25.04495"},532500:{cname:"红河哈尼族彝族自治州",pyname:"Hong He Ha Ni Zu Yi Zu Zi Zhi Zhou",lon:"103.375599",lat:"23.364221"},532600:{cname:"文山壮族苗族自治州",pyname:"Wen Shan Zhuang Zu Miao Zu Zi Zhi Zhou",lon:"104.215039",lat:"23.39849"},532800:{cname:"西双版纳傣族自治州",pyname:"Xi Shuang Ban Na Dai Zu Zi Zhi Zhou",lon:"100.797389",lat:"22.007489"},532900:{cname:"大理白族自治州",pyname:"Da Li Bai Zu Zi Zhi Zhou",lon:"100.267641",lat:"25.60648"},533100:{cname:"德宏傣族景颇族自治州",pyname:"De Hong Dai Zu Jing Po Zu Zi Zhi Zhou",lon:"98.584859",lat:"24.43232"},533300:{cname:"怒江傈僳族自治州",pyname:"Nu Jiang Li Su Zu Zi Zhi Zhou",lon:"98.856699",lat:"25.81763"},533400:{cname:"迪庆藏族自治州",pyname:"Di Qing Zang Zu Zi Zhi Zhou",lon:"99.703049",lat:"27.81908"}},54e4:{540100:{cname:"拉萨市",pyname:"La Sa Shi",lon:"91.114529",lat:"29.644141"},542100:{cname:"昌都地区",pyname:"Chang Du Di Qu",lon:"97.17225",lat:"31.140729"},542200:{cname:"山南地区",pyname:"Shan Nan Di Qu",lon:"91.773129",lat:"29.237051"},542300:{cname:"日喀则地区",pyname:"Ri Ka Ze Di Qu",lon:"88.881369",lat:"29.266849"},542400:{cname:"那曲地区",pyname:"Na Qu Di Qu",lon:"92.051361",lat:"31.476139"},542500:{cname:"阿里地区",pyname:"A Li Di Qu",lon:"81.15763",lat:"30.40199"},542600:{cname:"林芝地区",pyname:"Lin Zhi Di Qu",lon:"94.361549",lat:"29.64895"}},61e4:{610100:{cname:"西安市",pyname:"Xi An Shi",lon:"108.939839",lat:"34.34127"},610200:{cname:"铜川市",pyname:"Tong Chuan Shi",lon:"108.94515",lat:"34.89673"},610300:{cname:"宝鸡市",pyname:"Bao Ji Shi",lon:"107.23732",lat:"34.36194"},610400:{cname:"咸阳市",pyname:"Xian Yang Shi",lon:"108.70929",lat:"34.329321"},610500:{cname:"渭南市",pyname:"Wei Nan Shi",lon:"109.51015",lat:"34.49997"},610600:{cname:"延安市",pyname:"Yan An Shi",lon:"109.489781",lat:"36.585291"},610700:{cname:"汉中市",pyname:"Han Zhong Shi",lon:"107.02377",lat:"33.067611"},610800:{cname:"榆林市",pyname:"Yu Lin Shi",lon:"109.734579",lat:"38.2852"},610900:{cname:"安康市",pyname:"An Kang Shi",lon:"109.029321",lat:"32.684859"},611e3:{cname:"商洛市",pyname:"Shang Luo Shi",lon:"109.94041",lat:"33.87036"}},62e4:{620100:{cname:"兰州市",pyname:"Lan Zhou Shi",lon:"103.834171",lat:"36.06138"},620200:{cname:"嘉峪关市",pyname:"Jia Yu Guan Shi",lon:"98.290111",lat:"39.77201"},620300:{cname:"金昌市",pyname:"Jin Chang Shi",lon:"102.187589",lat:"38.520061"},620400:{cname:"白银市",pyname:"Bai Yin Shi",lon:"104.13773",lat:"36.544701"},620500:{cname:"天水市",pyname:"Tian Shui Shi",lon:"105.724859",lat:"34.580851"},620600:{cname:"武威市",pyname:"Wu Wei Shi",lon:"102.637971",lat:"37.928201"},620700:{cname:"张掖市",pyname:"Zhang Ye Shi",lon:"100.449809",lat:"38.92592"},620800:{cname:"平凉市",pyname:"Ping Liang Shi",lon:"106.665299",lat:"35.54303"},620900:{cname:"酒泉市",pyname:"Jiu Quan Shi",lon:"98.493941",lat:"39.73255"},621e3:{cname:"庆阳市",pyname:"Qing Yang Shi",lon:"107.642921",lat:"35.709781"},621100:{cname:"定西市",pyname:"Ding Xi Shi",lon:"104.625241",lat:"35.581131"},621200:{cname:"陇南市",pyname:"Long Nan Shi",lon:"104.92166",lat:"33.401"},622900:{cname:"临夏回族自治州",pyname:"Lin Xia Hui Zu Zi Zhi Zhou",lon:"103.210909",lat:"35.60122"},623e3:{cname:"甘南藏族自治州",pyname:"Gan Nan Zang Zu Zi Zhi Zhou",lon:"102.91102",lat:"34.98326"}},63e4:{630100:{cname:"西宁市",pyname:"Xi Ning Shi",lon:"101.777819",lat:"36.617289"},632100:{cname:"海东市",pyname:"Hai Dong Shi",lon:"102.40173",lat:"36.48209"},632200:{cname:"海北藏族自治州",pyname:"Hai Bei Zang Zu Zi Zhi Zhou",lon:"100.900959",lat:"36.95454"},632300:{cname:"黄南藏族自治州",pyname:"Huang Nan Zang Zu Zi Zhi Zhou",lon:"102.015069",lat:"35.519911"},632500:{cname:"海南藏族自治州",pyname:"Hai Nan Zang Zu Zi Zhi Zhou",lon:"100.620211",lat:"36.28643"},632600:{cname:"果洛藏族自治州",pyname:"Guo Luo Zang Zu Zi Zhi Zhou",lon:"100.24475",lat:"34.471411"},632700:{cname:"玉树藏族自治州",pyname:"Yu Shu Zang Zu Zi Zhi Zhou",lon:"97.0065",lat:"33.00528"},632800:{cname:"海西蒙古族藏族自治州",pyname:"Hai Xi Meng Gu Zu Zang Zu Zi Zhi Zhou",lon:"97.37122",lat:"37.377101"}},64e4:{640100:{cname:"银川市",pyname:"Yin Chuan Shi",lon:"106.23248",lat:"38.486441"},640200:{cname:"石嘴山市",pyname:"Shi Zui Shan Shi",lon:"106.38418",lat:"38.984099"},640300:{cname:"吴忠市",pyname:"Wu Zhong Shi",lon:"106.198789",lat:"37.99755"},640400:{cname:"固原市",pyname:"Gu Yuan Shi",lon:"106.242589",lat:"36.015801"},640500:{cname:"中卫市",pyname:"Zhong Wei Shi",lon:"105.19676",lat:"37.50026"}},65e4:{650100:{cname:"乌鲁木齐市",pyname:"Wu Lu Mu Qi Shi",lon:"87.616879",lat:"43.82663"},650200:{cname:"克拉玛依市",pyname:"Ke La Ma Yi Shi",lon:"84.889271",lat:"45.579989"},652100:{cname:"吐鲁番地区",pyname:"Tu Lu Fan Di Qu",lon:"89.18954",lat:"42.9513"},652200:{cname:"哈密地区",pyname:"Ha Mi Di Qu",lon:"93.516261",lat:"42.818739"},652300:{cname:"昌吉回族自治州",pyname:"Chang Ji Hui Zu Zi Zhi Zhou",lon:"87.30822",lat:"44.01117"},652700:{cname:"博尔塔拉蒙古自治州",pyname:"Bo Er Ta La Meng Gu Zi Zhi Zhou",lon:"82.066649",lat:"44.90597"},652800:{cname:"巴音郭楞蒙古自治州",pyname:"Ba Yin Guo Leng Meng Gu Zi Zhi Zhou",lon:"86.145169",lat:"41.764041"},652900:{cname:"阿克苏地区",pyname:"A Ke Su Di Qu",lon:"80.26008",lat:"41.16842"},653e3:{cname:"克孜勒苏柯尔克孜自治州",pyname:"Ke Zi Le Su Ke Er Ke Zi Zi Zhi Zhou",lon:"76.16661",lat:"39.715299"},653100:{cname:"喀什地区",pyname:"Ka Shi Di Qu",lon:"75.989759",lat:"39.470421"},653200:{cname:"和田地区",pyname:"He Tian Di Qu",lon:"79.92247",lat:"37.11431"},654e3:{cname:"伊犁哈萨克自治州",pyname:"Yi Li Ha Sa Ke Zi Zhi Zhou",lon:"81.32416",lat:"43.91689"},654200:{cname:"塔城地区",pyname:"Ta Cheng Di Qu",lon:"82.98046",lat:"46.745319"},654300:{cname:"阿勒泰地区",pyname:"A Le Tai Di Qu",lon:"88.14023",lat:"47.84564"},659001:{cname:"石河子市",pyname:"Shi He Zi Shi",lon:"86.07893",lat:"44.30653"},659002:{cname:"阿拉尔市",pyname:"A La Er Shi",lon:"81.280671",lat:"40.54798"},659003:{cname:"图木舒克市",pyname:"Tu Mu Shu Ke Shi",lon:"79.069019",lat:"39.86495"},659004:{cname:"五家渠市",pyname:"Wu Jia Qu Shi",lon:"87.540169",lat:"44.16799"}}},Io=function(){function t(e){Object(s.a)(this,t),this.options=Object.assign({},{theme:"light",placeholder:"请选择",hot:["440100","440300","330100","510100"],zoom:10},e),this._onCityClick=this._onCityClick.bind(this),this._onInfoClick=this._onInfoClick.bind(this),this._onLetterClick=this._onLetterClick.bind(this)}return Object(l.a)(t,[{key:"add",value:function(t,e){this._map=t,this._container=document.createElement("div"),this._container.className="city-selector-wrap",this._citySelectContainer=this._createNode("div","city-selector-box "+this.options.theme,"",this._container),this._cityInfoContainer=this._createNode("div","city-info-box",this.options.placeholder,this._citySelectContainer,"",this._onInfoClick),this._cityListContainer=this._createNode("div","city-list-box","",this._citySelectContainer),this._active=!1,this._render(),e.appendChild(this._container)}},{key:"remove",value:function(){this._container.parentNode.removeChild(this._container),this._map=void 0}},{key:"_render",value:function(){var t=this.options.hot,e=["110000","120000","310000","500000","810000","820000","710000"],i=["A","F","G","H","J","L","N","Q","S","X","Y","Z"];if(t.length>0)for(var n=this._createNode("div","city-list city-list-hot","",this._cityListContainer),r=0;r<t.length;r++){var o=t[r],a=this._getCity(o);this._createNode("a","city-link",a.cname,n,o,this._onCityClick)}for(var s=Lo[86],l=this._createNode("div","city-list city-list-mp","",this._cityListContainer),c=0;c<e.length;c++){var h=e[c],u=s[h];this._createNode("a","city-link",u.cname,l,h,this._onCityClick)}for(var d=this._createNode("div","city-list city-list-lt","",this._cityListContainer),p=0;p<i.length;p++)this._createNode("div","letter-link",i[p],d,"",this._onLetterClick);this.cityListboxContainer=this._createNode("div","city-list city-list-pv","",this._cityListContainer);for(var f=Object.keys(s).sort((function(t,e){return s[t].pyname.charCodeAt()-s[e].pyname.charCodeAt()})),m=0;m<f.length;m++){var g=f[m];if(!(e.indexOf(g)>-1)){var y=s[g],_=Lo[g],v=this._createNode("dl","city-list-dl letter-"+y.pyname[0],"",this.cityListboxContainer);this._createNode("dt","city-list-dt city-link",y.cname,v,g,this._onCityClick);var x=this._createNode("dd","city-list-dd","",v);for(var b in _)if(_.hasOwnProperty(b)){var w=_[b];this._createNode("a","city-link",w.cname,x,b,this._onCityClick)}}}}},{key:"_onCityClick",value:function(t){var e=t.target.getAttribute("data-code");this._cityInfoContainer.innerText=t.target.innerText;var i=this._getCity(e);this._map.setView({center:[i.lon,i.lat],zoom:this.options.zoom})}},{key:"_onLetterClick",value:function(t){var e=t.target.innerText,i=this.cityListboxContainer.querySelector(".letter-"+e);this.cityListboxContainer.scrollTop=i.offsetTop}},{key:"_onInfoClick",value:function(){this._active=!this._active,this._active?this._cityListContainer.classList.add("active"):this._cityListContainer.classList.remove("active")}},{key:"_getCity",value:function(t){if(Lo[86][t])return Lo[86][t];var e=t.substring(0,2).padEnd(6,"0");return Lo[e][t]}},{key:"_createNode",value:function(t,e,i,n,r,o){var a=document.createElement(t);return a.className=e,a.textContent=i,r&&a.setAttribute("data-code",r),o&&a.addEventListener("click",o),n.appendChild(a),a}},{key:"_removeNode",value:function(t,e){t.remove(),e&&t.removeEventListener("click",e)}}]),t}(),Ro=function t(){var e=t.SkyShader,i=new Re.ShaderMaterial({name:"SkyShader",fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:Re.UniformsUtils.clone(e.uniforms),side:Re.BackSide,depthWrite:!1}),n=new Re.CylinderGeometry(1,1,1,64,1,!0);n.applyMatrix4((new Re.Matrix4).makeRotationX(Math.PI/2)),Re.Mesh.call(this,n,i)};Ro.prototype=Object.create(Re.Mesh.prototype),Ro.SkyShader={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new Re.Vector3},up:{value:new Re.Vector3(0,1,0)},pitch:{value:1},height:{value:1e3},clip:{value:!1}},vertexShader:["uniform vec3 sunPosition;","uniform float rayleigh;","uniform float turbidity;","uniform float mieCoefficient;","uniform vec3 up;","varying vec3 vWorldPosition;","varying vec2 vUv;","varying vec4 vPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );","const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );","const float v = 4.0;","const vec3 K = vec3( 0.686, 0.678, 0.666 );","const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );","const float cutoffAngle = 1.6110731556870734;","const float steepness = 1.5;","const float EE = 1000.0;","float sunIntensity( float zenithAngleCos ) {","\tzenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );","\treturn EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );","}","vec3 totalMie( float T ) {","\tfloat c = ( 0.2 * T ) * 10E-18;","\treturn 0.434 * c * MieConst;","}","void main() {","\tvUv = uv;"," vPosition = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","\tvWorldPosition = worldPosition.xyz;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","\tgl_Position.z = gl_Position.w;","\tvSunDirection = normalize( sunPosition );","\tvSunE = sunIntensity( dot( vSunDirection, up ) );","\tvSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );","\tfloat rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );","\tvBetaR = totalRayleigh * rayleighCoefficient;","\tvBetaM = totalMie( turbidity ) * mieCoefficient;","}"].join("\n"),fragmentShader:["varying vec3 vWorldPosition;","varying vec2 vUv;","varying vec4 vPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","uniform float mieDirectionalG;","uniform vec3 up;","uniform float pitch;","uniform float height;","uniform bool clip;","const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );","const float pi = 3.141592653589793238462643383279502884197169;","const float n = 1.0003;","const float N = 2.545E25;","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","const float THREE_OVER_SIXTEENPI = 0.05968310365946075;","const float ONE_OVER_FOURPI = 0.07957747154594767;","float rayleighPhase( float cosTheta ) {","\treturn THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );","}","float hgPhase( float cosTheta, float g ) {","\tfloat g2 = pow( g, 2.0 );","\tfloat inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );","\treturn ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );","}","void main() {","\tvec3 direction = normalize( vWorldPosition - cameraPos );","\tfloat zenithAngle = acos( max( 0.0, dot( up, direction ) ) );","\tfloat inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );","\tfloat sR = rayleighZenithLength * inverse;","\tfloat sM = mieZenithLength * inverse;","\tvec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );","\tfloat cosTheta = dot( direction, vSunDirection );","\tfloat rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );","\tvec3 betaRTheta = vBetaR * rPhase;","\tfloat mPhase = hgPhase( cosTheta, mieDirectionalG );","\tvec3 betaMTheta = vBetaM * mPhase;","\tvec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );","\tLin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );","\tfloat theta = acos( direction.y ); // elevation --\x3e y-axis, [-pi/2, pi/2]","\tfloat phi = atan( direction.z, direction.x ); // azimuth --\x3e x-axis [-pi/2, pi/2]","\tvec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );","\tvec3 L0 = vec3( 0.1 ) * Fex;","\tfloat sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );","\tL0 += ( vSunE * 19000.0 * Fex ) * sundisk;","\tvec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );","\tvec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );","\tgl_FragColor = vec4( retColor, 1.0 );"," if(clip) {","  float rate =  gl_FragCoord.y / height;","  float maxOffset = 0.265;","  if(pitch < 70. || rate < 1. - (pitch - 70.) / 10. * maxOffset) discard;"," };","#include <tonemapping_fragment>","#include <encodings_fragment>","}"].join("\n")};var Do={style1:[3.3,.27,.04,.15,60,-84.5,.1514],style2:[6.1,3.18,.05,.15,60,-87.3,.1514],style3:[0,.08,.04,.07,-82,80,.2192],style4:[6.7,.06,0,.31,90,114.5,.0379],style5:[.8,.06,.09,.09,-60,68.2,.1741],style6:[.8,.06,.09,.09,-79.1,79.1,.1741],style7:[.8,.36,.04,.14,54.5,79.1,.1741]},ko=function(){function t(e){var i=this;Object(s.a)(this,t),this.parent=void 0,this.sky=void 0,this.sun=void 0,this.renderer=void 0,this.scene=void 0,this.layer=void 0,this.clip=void 0,this.updateUniforms=function(){var t=i.parent.map.getPitch(),e=i.sky.material.uniforms,n=i.parent.map.getSize().height*window.devicePixelRatio;e.pitch.value=t,e.height.value=n,e.clip.value=i.clip},this.updateClip=function(t){i.sky.material.uniforms.clip.value=t,i.clip=t},this.parent=e,this.clip="mapbox"==e.config.chart.baseLayer.type,this.init()}return Object(l.a)(t,[{key:"init",value:function(){var t=this.parent.map,e=new lo("sky",{forceRenderOnMoving:!0,forceRenderOnRotating:!0,animation:!0}),i=this;e.prepareToDraw=function(e,n,r){i.scene=n,i.renderer=e,this.setZIndex(-1e3);var o=new Ro;o.scale.setScalar(45e4),n.add(o),i.sky=o,i.sun=new Re.Vector3,i.updateUniforms(),t.on("pitchEnd",i.updateUniforms),i.update()},this.layer=e,e.addTo(t)}},{key:"update",value:function(){var t=this.parent.config.effectConfig.skyConfig.timeInterval;console.log("defaultStyle",Do),console.log("timeInterval",t),console.log("defaultStyle[timeInterval]",Do[t]);var e=Object(r.a)(Do[t],7),i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],l=e[5],c=e[6],h=this.sky.material.uniforms;h.turbidity.value=i,h.rayleigh.value=n,h.mieCoefficient.value=o,h.mieDirectionalG.value=a;var u=Re.MathUtils.degToRad(90-s),d=Re.MathUtils.degToRad(l);this.sun.setFromSphericalCoords(1,u,d),h.sunPosition.value.copy(this.sun),this.renderer.toneMappingExposure=c,h.up.value.copy(new Re.Vector3(0,0,1))}},{key:"dispose",value:function(){this.layer.remove(),this.scene.remove(this.sky),this.sky=null,this.sun=null,this.parent.map.off("pitchEnd",this.updateUniforms)}}]),t}(),Oo=function(t,e,i){return t.filter((function(t){return t[e]===i}))},zo=function(t){return t?t.map((function(t){return t.id})):[]},Bo=function(t,e){for(var i=[],n=0,r=t.length;n<r;n++)e.indexOf(t[n])<0&&i.push(t[n]);return i},Fo=function(t){var e=t.childrenConfig;return(void 0===e?[]:e).map((function(t){return Object.assign({},t,{configuration:Object(p.reduceConfig2)(t.configuration)})}))},No=function(t,e){return function(t,e){var i=e.childrenData,n=void 0===i?[]:i;return t.map((function(t){var e=n.filter((function(e){return void 0!==e.id&&void 0!==t.id&&e.id===t.id}));if(e&&e.length>0)return Object.assign({},t,{data:e[0].data})})).filter((function(t){return!!t}))}(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1?arguments[1]:void 0,i=Fo(e);return i.filter((function(e){return t===(e&&e.base&&e.base.module_name)})).filter((function(t){return!!t}))}(t,e),e)},jo=function(t,e,i,n){var r=new e(i,n);n.childrenCommponentMap.set(t,r)},Go=function(t){t.children.forEach((function(e){var i=No(e.moduleName,t.props);i&&i.length>0&&i.forEach((function(i){jo(i.id,e.componentName,i,t)}))}))},Uo=i(23),Vo=i(24),Ho=i(16);function Zo(t){return function(t){if(Array.isArray(t))return Object(Ho.a)(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||Object(o.a)(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var Wo=i(8),qo=i(14),Xo=i(11),Yo={computeTangents:function(t){t.computeTangents(),console.warn("THREE.BufferGeometryUtils: .computeTangents() has been removed. Use BufferGeometry.computeTangents() instead.")},mergeBufferGeometries:function(t,e){for(var i=null!==t[0].index,n=new Set(Object.keys(t[0].attributes)),r=new Set(Object.keys(t[0].morphAttributes)),o={},a={},s=t[0].morphTargetsRelative,l=new Re.BufferGeometry,c=0,h=0;h<t.length;++h){var u=t[h],d=0;if(i!==(null!==u.index))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(var p in u.attributes){if(!n.has(p))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+'. All geometries must have compatible attributes; make sure "'+p+'" attribute exists among all geometries, or in none of them.'),null;void 0===o[p]&&(o[p]=[]),o[p].push(u.attributes[p]),d++}if(d!==n.size)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". Make sure all geometries have the same number of attributes."),null;if(s!==u.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(var p in u.morphAttributes){if(!r.has(p))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===a[p]&&(a[p]=[]),a[p].push(u.morphAttributes[p])}if(l.userData.mergedUserData=l.userData.mergedUserData||[],l.userData.mergedUserData.push(u.userData),e){var f;if(i)f=u.index.count;else{if(void 0===u.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+h+". The geometry must have either an index or a position attribute"),null;f=u.attributes.position.count}l.addGroup(c,f,h),c+=f}}if(i){var m=0,g=[];for(h=0;h<t.length;++h){for(var y=t[h].index,_=0;_<y.count;++_)g.push(y.getX(_)+m);m+=t[h].attributes.position.count}l.setIndex(g)}for(var p in o){var v=this.mergeBufferAttributes(o[p]);if(!v)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+p+" attribute."),null;l.setAttribute(p,v)}for(var p in a){var x=a[p][0].length;if(0===x)break;l.morphAttributes=l.morphAttributes||{},l.morphAttributes[p]=[];for(h=0;h<x;++h){var b=[];for(_=0;_<a[p].length;++_)b.push(a[p][_][h]);var w=this.mergeBufferAttributes(b);if(!w)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+p+" morphAttribute."),null;l.morphAttributes[p].push(w)}}return l},mergeBufferAttributes:function(t){for(var e,i,n,r=0,o=0;o<t.length;++o){var a=t[o];if(a.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(void 0===e&&(e=a.array.constructor),e!==a.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===i&&(i=a.itemSize),i!==a.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===n&&(n=a.normalized),n!==a.normalized)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;r+=a.array.length}var s=new e(r),l=0;for(o=0;o<t.length;++o)s.set(t[o].array,l),l+=t[o].array.length;return new Re.BufferAttribute(s,i,n)},interleaveAttributes:function(t){for(var e,i=0,n=0,r=0,o=t.length;r<o;++r){var a=t[r];if(void 0===e&&(e=a.array.constructor),e!==a.array.constructor)return console.error("AttributeBuffers of different types cannot be interleaved"),null;i+=a.array.length,n+=a.itemSize}var s=new Re.InterleavedBuffer(new e(i),n),l=0,c=[],h=["getX","getY","getZ","getW"],u=["setX","setY","setZ","setW"],d=0;for(o=t.length;d<o;d++){var p=(a=t[d]).itemSize,f=a.count,m=new Re.InterleavedBufferAttribute(s,p,l,a.normalized);c.push(m),l+=p;for(var g=0;g<f;g++)for(var y=0;y<p;y++)m[u[y]](g,a[h[y]](g))}return c},estimateBytesUsed:function(t){var e=0;for(var i in t.attributes){var n=t.getAttribute(i);e+=n.count*n.itemSize*n.array.BYTES_PER_ELEMENT}var r=t.getIndex();return e+=r?r.count*r.itemSize*r.array.BYTES_PER_ELEMENT:0},mergeVertices:function(t,e=1e-4){e=Math.max(e,Number.EPSILON);for(var i={},n=t.getIndex(),r=t.getAttribute("position"),o=n?n.count:r.count,a=0,s=Object.keys(t.attributes),l={},c={},h=[],u=["getX","getY","getZ","getW"],d=0,p=s.length;d<p;d++){l[v=s[d]]=[],(M=t.morphAttributes[v])&&(c[v]=new Array(M.length).fill().map(()=>[]))}var f=Math.log10(1/e),m=Math.pow(10,f);for(d=0;d<o;d++){var g=n?n.getX(d):d,y="",_=0;for(p=s.length;_<p;_++)for(var v=s[_],x=(w=t.getAttribute(v)).itemSize,b=0;b<x;b++)y+=~~(w[u[b]](g)*m)+",";if(y in i)h.push(i[y]);else{for(_=0,p=s.length;_<p;_++){v=s[_];var w=t.getAttribute(v),M=t.morphAttributes[v],T=(x=w.itemSize,l[v]),S=c[v];for(b=0;b<x;b++){var E=u[b];if(T.push(w[E](g)),M)for(var C=0,A=M.length;C<A;C++)S[C].push(M[C][E](g))}}i[y]=a,h.push(a),a++}}const P=t.clone();for(d=0,p=s.length;d<p;d++){v=s[d];var L=t.getAttribute(v),I=new L.array.constructor(l[v]);w=new Re.BufferAttribute(I,L.itemSize,L.normalized);if(P.setAttribute(v,w),v in c)for(_=0;_<c[v].length;_++){var R=t.morphAttributes[v][_],D=(I=new R.array.constructor(c[v][_]),new Re.BufferAttribute(I,R.itemSize,R.normalized));P.morphAttributes[v][_]=D}}return P.setIndex(h),P},toTrianglesDrawMode:function(t,e){if(e===Re.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),t;if(e===Re.TriangleFanDrawMode||e===Re.TriangleStripDrawMode){var i=t.getIndex();if(null===i){var n=[],r=t.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(var o=0;o<r.count;o++)n.push(o);t.setIndex(n),i=t.getIndex()}var a=i.count-2,s=[];if(e===Re.TriangleFanDrawMode)for(o=1;o<=a;o++)s.push(i.getX(0)),s.push(i.getX(o)),s.push(i.getX(o+1));else for(o=0;o<a;o++)o%2==0?(s.push(i.getX(o)),s.push(i.getX(o+1)),s.push(i.getX(o+2))):(s.push(i.getX(o+2)),s.push(i.getX(o+1)),s.push(i.getX(o)));s.length/3!==a&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=t.clone();return l.setIndex(s),l.clearGroups(),l}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),t},computeMorphedAttributes:function(t){if(!0!==t.geometry.isBufferGeometry)return console.error("THREE.BufferGeometryUtils: Geometry is not of type BufferGeometry."),null;var e=new Re.Vector3,i=new Re.Vector3,n=new Re.Vector3,r=new Re.Vector3,o=new Re.Vector3,a=new Re.Vector3,s=new Re.Vector3,l=new Re.Vector3,c=new Re.Vector3;function h(t,h,u,d,p,f,m,g,y){e.fromBufferAttribute(u,f),i.fromBufferAttribute(u,m),n.fromBufferAttribute(u,g);var _=t.morphTargetInfluences;if(h.morphTargets&&d&&_){s.set(0,0,0),l.set(0,0,0),c.set(0,0,0);for(var v=0,x=d.length;v<x;v++){var b=_[v];d=d[v];0!==b&&(r.fromBufferAttribute(d,f),o.fromBufferAttribute(d,m),a.fromBufferAttribute(d,g),p?(s.addScaledVector(r,b),l.addScaledVector(o,b),c.addScaledVector(a,b)):(s.addScaledVector(r.sub(e),b),l.addScaledVector(o.sub(i),b),c.addScaledVector(a.sub(n),b)))}e.add(s),i.add(l),n.add(c)}t.isSkinnedMesh&&(t.boneTransform(f,e),t.boneTransform(m,i),t.boneTransform(g,n)),y[3*f+0]=e.x,y[3*f+1]=e.y,y[3*f+2]=e.z,y[3*m+0]=i.x,y[3*m+1]=i.y,y[3*m+2]=i.z,y[3*g+0]=n.x,y[3*g+1]=n.y,y[3*g+2]=n.z}var u,d,p,f,m,g,y,_,v,x=t.geometry,b=t.material,w=x.index,M=x.attributes.position,T=x.morphAttributes.position,S=x.morphTargetsRelative,E=x.attributes.normal,C=x.morphAttributes.position,A=x.groups,P=x.drawRange,L=new Float32Array(M.count*M.itemSize),I=new Float32Array(E.count*E.itemSize);if(null!==w)if(Array.isArray(b))for(f=0,g=A.length;f<g;f++)for(v=b[(_=A[f]).materialIndex],m=Math.max(_.start,P.start),y=Math.min(_.start+_.count,P.start+P.count);m<y;m+=3)h(t,v,M,T,S,u=w.getX(m),d=w.getX(m+1),p=w.getX(m+2),L),h(t,v,E,C,S,u,d,p,I);else for(f=Math.max(0,P.start),g=Math.min(w.count,P.start+P.count);f<g;f+=3)h(t,b,M,T,S,u=w.getX(f),d=w.getX(f+1),p=w.getX(f+2),L),h(t,b,E,C,S,u,d,p,I);else if(void 0!==M)if(Array.isArray(b))for(f=0,g=A.length;f<g;f++)for(v=b[(_=A[f]).materialIndex],m=Math.max(_.start,P.start),y=Math.min(_.start+_.count,P.start+P.count);m<y;m+=3)h(t,v,M,T,S,u=m,d=m+1,p=m+2,L),h(t,v,E,C,S,u,d,p,I);else for(f=Math.max(0,P.start),g=Math.min(M.count,P.start+P.count);f<g;f+=3)h(t,b,M,T,S,u=f,d=f+1,p=f+2,L),h(t,b,E,C,S,u,d,p,I);return{positionAttribute:M,normalAttribute:E,morphedPositionAttribute:new Re.Float32BufferAttribute(L,3),morphedNormalAttribute:new Re.Float32BufferAttribute(I,3)}}},$o=i(7),Jo={uniforms:Re.UniformsUtils.merge([Re.ShaderLib.lambert.uniforms]),vertexShader:"\n    #define LAMBERT\n\n    varying vec3 vLightFront;\n    varying vec3 vIndirectFront;\n    varying vec2 vUv;\n\n    #ifdef DOUBLE_SIDED\n      varying vec3 vLightBack;\n      varying vec3 vIndirectBack;\n    #endif\n\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <uv2_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <bsdfs>\n    #include <lights_pars_begin>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <shadowmap_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n\n    void main() {\n      \n      #include <uv_vertex>\n      #include <uv2_vertex>\n      #include <color_vertex>\n   \n      vUv = uv;\n\n      #include <beginnormal_vertex>\n      #include <morphnormal_vertex>\n      #include <skinbase_vertex>\n      #include <skinnormal_vertex>\n      #include <defaultnormal_vertex>\n\n      #include <begin_vertex>\n      #include <morphtarget_vertex>\n      #include <skinning_vertex>\n      #include <project_vertex>\n      #include <logdepthbuf_vertex>\n      #include <clipping_planes_vertex>\n\n      #include <worldpos_vertex>\n      #include <envmap_vertex>\n      #include <lights_lambert_vertex>\n      #include <shadowmap_vertex>\n      #include <fog_vertex>\n    }\n  ",fragmentShader:"\n    // uniform vec3 diffuse;\n    // uniform float opacity;\n    uniform vec3 emissive;\n\n    uniform vec3 bottomColor;\n    uniform vec3 topColor;\n    uniform float bottomOpacity;\n    uniform float topOpacity;\n\n    varying vec3 vLightFront;\n    varying vec3 vIndirectFront;\n    varying vec2 vUv;\n\n    #ifdef DOUBLE_SIDED\n      varying vec3 vLightBack;\n      varying vec3 vIndirectBack;\n    #endif\n\n\n    #include <common>\n    #include <packing>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <uv2_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <emissivemap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <cube_uv_reflection_fragment>\n    #include <bsdfs>\n    #include <lights_pars_begin>\n    #include <fog_pars_fragment>\n    #include <shadowmap_pars_fragment>\n    #include <shadowmask_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n\n    void main() {\n      vec3 diffuse = mix(bottomColor, topColor, vUv.y);\n      float opacity = mix(bottomOpacity, topOpacity, vUv.y);\n\n      #include <clipping_planes_fragment>\n\n      vec4 diffuseColor = vec4( diffuse, opacity );\n      ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n      vec3 totalEmissiveRadiance = emissive;\n\n      #include <logdepthbuf_fragment>\n      #include <map_fragment>\n      #include <color_fragment>\n      #include <alphamap_fragment>\n      #include <alphatest_fragment>\n      #include <specularmap_fragment>\n      #include <emissivemap_fragment>\n\n      // accumulation\n\n      #ifdef DOUBLE_SIDED\n\n        reflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\n      #else\n\n        reflectedLight.indirectDiffuse += vIndirectFront;\n\n      #endif\n\n      #include <lightmap_fragment>\n\n      reflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\n      #ifdef DOUBLE_SIDED\n\n        reflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\n      #else\n\n        reflectedLight.directDiffuse = vLightFront;\n\n      #endif\n\n      reflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\n      // modulation\n\n      #include <aomap_fragment>\n\n      vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\n      #include <envmap_fragment>\n\n      gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n      #include <tonemapping_fragment>\n      #include <encodings_fragment>\n      #include <fog_fragment>\n      #include <premultiplied_alpha_fragment>\n      #include <dithering_fragment>\n    }\n  "},Ko=i(3);function Qo(){this.array=null}var ta=function(t,e,i,n,r){var o=[],a=n*i,s=e*i,l=[],c=[],h=[],u="default"==r?1:s/a,d=0,p=t.length;t.forEach((function(e,i){if(l.push(e.x,e.y,0),l.push(e.x,e.y,s),o.push(new Re.Vector3(e.x,e.y,0),new Re.Vector3(e.x,e.y,s)),0!==i){var n=t[i-1],r=new Re.Vector2(n.x,n.y).distanceTo(new Re.Vector2(e.x,e.y));d+=r/a,o.push(new Re.Vector3(n.x,n.y,0),new Re.Vector3(e.x,e.y,0),new Re.Vector3(n.x,n.y,s),new Re.Vector3(e.x,e.y,s))}h.push(d,0,d,u),0!==i&&c.push(2*i-2,2*i,2*i-1,2*i-1,2*i,2*i+1)}));var f=t[0],m=t[p-1];l.push(f.x,f.y,0),l.push(f.x,f.y,s);var g=new Re.Vector2(f.x,f.y).distanceTo(new Re.Vector2(m.x,m.y));d+=g/a,h.push(d,0,d,u),c.push(2*p-2,2*p,2*p-1,2*p-1,2*p,2*p+1);var y=new Re.BufferGeometry;return y.setIndex(c),y.setAttribute("position",new Re.Float32BufferAttribute(l,3).onUpload(Qo)),y.setAttribute("uv",new Re.Float32BufferAttribute(h,2).onUpload(Qo)),[y,o]},ea=function(t,e,i){var n,r,o=t.length;return 0==e?(n=t[o-2],r=t[e+1]):e==o-1?(n=t[e-1],r=t[1]):(n=t[e-1],r=t[e+1]),function(t,e,i,n){var r=Math.atan2(e.y-t.y,e.x-t.x),o=Math.atan2(i.y-t.y,i.x-t.x)-r;o<0?o+=2*Math.PI:o>2*Math.PI&&(o-=2*Math.PI);var a=o/2+r,s=n/Math.sin(o/2);Math.abs(s)>2*n&&(s=n);var l=s*Math.cos(a)+t.x,c=s*Math.sin(a)+t.y;return{x:2*t.x-l,y:2*t.y-c}}(t[e],n,r,i)},ia=function(t,e,i,n){if(0==e||0==n){var r=new Re.ShapeBufferGeometry(new Re.Shape(t)),o=new Re.Matrix4;return o.makeTranslation(0,0,i),r.applyMatrix4(o),[null,r,null]}var a=[],s=[],l=t.length,c=[],h=[],u=t.map((function(r,o){var u=ea(t,o,e),d=new Re.Vector3(r.x,r.y,i),p=new Re.Vector3(u.x,u.y,i),f=new Re.Vector3(p.x,p.y,p.z-n);return a.push(d.x,d.y,d.z,p.x,p.y,p.z,f.x,f.y,f.z),h.length&&c.push(h[0],p,h[1],f),c.push(d,p,p,f),h[0]=p,h[1]=f,o!=l-1?s.push(3*o,3*o+1,3*(o+1)+1,3*(o+1)+1,3*(o+1),3*o,3*o+1,3*o+2,3*(o+1)+2,3*(o+1)+2,3*(o+1)+1,3*o+1):s.push(3*o,3*o+1,1,1,0,3*o,3*o+1,3*o+2,2,2,1,3*o+1),u})),d=new Re.BufferGeometry;d.setIndex(s),d.setAttribute("position",new Re.Float32BufferAttribute(a,3));var p=new Re.ShapeBufferGeometry(new Re.Shape(u)),f=new Re.Matrix4;return f.makeTranslation(0,0,i-n),p.applyMatrix4(f),[d,p,c]},na=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n){var o;Object(s.a)(this,i),(o=e.call(this)).id=void 0,o.config=void 0,o.interaction=void 0,o.data=void 0,o.parent=void 0,o.scene=void 0,o.group=void 0,o.mapJson=void 0,o.buildings=void 0,o.meterScale=void 0,o.loadItem=void 0,o.fetchMapJson=function(){o.loadItem=Object(Ko.d)(Object(qo.a)(o));var t=o.config.styleConfig.url,e=o.data&&o.data[0]&&o.data[0].url||window.appConfig.ASSETS_URL+t;fetch(e).then((function(t){if(200==t.status)return t.json();var e=new Error(t.statusText);throw Object(Wo.a)(Object(Wo.a)({},e),{},{response:t})})).then((function(t){t&&(console.log("mapJson",t),o.mapJson=t,o.addCustomBuilding())})).catch((function(t){console.error("区域数据异常!",t)}))},o.onZoom=function(t){var e=t&&null!=t.to?t.to:o.parent.map.getZoom(),i=Object(r.a)(o.config.baseConfig.showLevel,2),n=i[0],a=i[1];o.group.visible=!(e<n||e>a)},o.id=t.id,o.config=t.configuration,o.data=t.data,o.parent=n,o.interaction=t.configuration.interaction,o.scene=n.extend.scene,o.group=new Re.Group,o.group.name="建筑",o.group.interactive=!0,o.group.componentId=o.id,o.scene.add(o.group),o.meterScale=n.threeLayer.distanceToVector3(0,1).y;var a=o.config.baseConfig.altitude;return o.group.position.z=o.meterScale*a,o.parent.map.on("zooming",o.onZoom),o.showData(),o}return Object(l.a)(i,[{key:"showData",value:function(){this.fetchMapJson()}},{key:"disposeMat",value:function(){this.buildings&&Object.values(this.buildings).map((function(t){var e=t.mat;e.sideMat&&Object($o.disposeMaterial)(e.sideMat),e.topMat&&Object($o.disposeMaterial)(e.topMat),e.wireMat&&Object($o.disposeMaterial)(e.wireMat)}))}},{key:"getBuildingConfig",value:function(){var t=this;this.disposeMat(),this.buildings={};var e=this.config.styleConfig,i=e.styleType,n=e.defaultStyle,r=e.styleName,o=e.serises;("default"==i?Object.values(n[r]):Object.values(o)).map((function(e){var i=e.floorRange,n=e.sideConfig,r=e.topConfig,o=e.wireConfig,a="".concat(i.min,"_").concat(i.max);t.buildings[a]={mat:{sideMat:t.createSideMat(n),topMat:t.createTopMat(r),wireMat:t.createWireMat(o)},seriseConfig:e}}))}},{key:"createSideMat",value:function(t){var e;if("gradient"==t.fillType){var i=Object(r.a)(t.color.rangeColor,2),n=i[0].color,o=i[1].color,a=Object(Ko.c)(n),s=Object(Ko.c)(o);e=new Re.ShaderMaterial(Object(Wo.a)(Object(Wo.a)({},Jo),{},{uniforms:Object(Wo.a)(Object(Wo.a)({},Jo.uniforms),{},{topColor:{value:new Re.Color(a[0])},bottomColor:{value:new Re.Color(s[0])},topOpacity:{value:a[1]},bottomOpacity:{value:s[1]},fogColor:{value:new Re.Color},fogDensity:{value:0}}),fog:!0,transparent:!0,side:Re.DoubleSide,lights:!0}))}else if("pattern"==t.fillType&&(e=new Re.MeshLambertMaterial({side:Re.DoubleSide,transparent:!0}),t.map)){var l=(new Re.TextureLoader).load(window.appConfig.ASSETS_URL+t.map);l.wrapS=Re.RepeatWrapping,l.wrapT=Re.RepeatWrapping,e.map=l}return e}},{key:"createTopMat",value:function(t){var e=t.color,i=Object(Ko.c)(e);return new Re.MeshLambertMaterial({color:i[0],transparent:!0,opacity:i[1],side:Re.DoubleSide})}},{key:"createWireMat",value:function(t){var e=Object(Ko.c)(t.color);return new Re.MeshBasicMaterial({color:e[0],transparent:!0,opacity:e[1]})}},{key:"addBuilding",value:function(t){var e,i,n=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=this.config.styleConfig,s=a.styleType,l=a.defaultStyle,c=a.styleName,h=a.serises,u=a.itemHeight,d=("default"==s?Object.values(l[c]):Object.values(h)).find((function(t){return o>=t.floorRange.min&&o<t.floorRange.max}));if(d){var p=d,f=p.floorRange,m=p.sideConfig,g=p.topConfig,y=t.map((function(t){var e=Object(r.a)(t,2),i=e[0],o=e[1];return n.parent.threeLayer.coordinateToVector3([i,o],0)})),_=this.parent.threeLayer.distanceToVector3(0,1).y,v=m.mapTrueSize,x=m.uvType,b=g.offset_s,w=g.offset_h,M=ta(y,o*u,_,v,x),T=Object(r.a)(M,2),S=T[0],E=T[1],C=ia(y,-b*_,o*u*_,w*_),A="".concat(f.min,"_").concat(f.max);this.buildings[A].geo||(this.buildings[A].geo={sideGeos:[],topGeos:[],topGeos2:[],wireGeos:[]});var P=this.buildings[A].geo;P.sideGeos.push(S),C[0]&&P.topGeos.push(C[0]),C[1]&&P.topGeos2.push(C[1]),(e=P.wireGeos).push.apply(e,Zo(E)),C[2]&&(i=P.wireGeos).push.apply(i,Zo(C[2]))}}},{key:"addCustomBuilding",value:function(){var t=this;this.onZoom();var e=this.config.baseConfig.system,i=this.config.styleConfig,n=i.floorField,r=i.bloom;this.getBuildingConfig(),this.mapJson&&this.mapJson.features.forEach((function(i){var r=i.geometry,o=i.properties;"MultiPolygon"===r.type?r.coordinates.forEach((function(i){i.forEach((function(i){var r=i.map((function(i){return t.parent.matchSystem(e,i)}));t.addBuilding(r,o[n])}))})):"Polygon"===r.type&&r.coordinates.forEach((function(i){var r=i.map((function(i){return t.parent.matchSystem(e,i)}));t.addBuilding(r,o[n])}))})),Object.values(this.buildings).map((function(e){var i=e.mat,n=e.geo,o=e.seriseConfig;if(n){var a=Yo.mergeBufferGeometries(n.sideGeos);if(a.computeVertexNormals(),n.topGeos&&n.topGeos.length){var s=Yo.mergeBufferGeometries(n.topGeos);s.computeVertexNormals();var l=new Re.Mesh(s,i.topMat);l.receiveShadow=!0,r&&l.layers.enable(1),Object(Ko.f)(l),t.group.add(l)}var c=Yo.mergeBufferGeometries(n.topGeos2);c.computeVertexNormals();var h=new Re.Mesh(a,i.sideMat);h.receiveShadow=!0;var u=new Re.Mesh(c,i.topMat);if(u.receiveShadow=!0,r&&(h.layers.enable(1),u.layers.enable(1)),Object(Ko.f)(h),Object(Ko.f)(u),t.group.add(h,u),o.wireConfig.show){var d=(new Re.BufferGeometry).setFromPoints(n.wireGeos),p=new Re.LineSegments(d,i.wireMat);Object(Ko.f)(p),t.group.add(p)}}})),this.loadItem.loaded=!0,this.parent.checkLoading()}},{key:"getSupportObjects",value:function(){return this.group}},{key:"selectAction",value:function(t){if(t&&t.componentId&&t.componentId===this.id){var e=this.parent.props,i=(e.id,e.onRelative,e.emit);i&&i("click",this.data,this.id)}}},{key:"updateComponent",value:function(t){var e=this.config,i=this.data;if(this.config=t.configuration,this.data=t.data,Object(f.isEqual)(i,this.data)||(Object($o.deepDisposeGroup)(this.group),this.group.children.length=0,this.fetchMapJson()),!Object(f.isEqual)(e,this.config)){var n=e.baseConfig.altitude,r=this.config.baseConfig.altitude,o=e.styleConfig.url,a=this.config.styleConfig.url;n!==r?this.group.position.z=this.meterScale*r:Object(f.isEqual)(o,a)?(Object($o.deepDisposeGroup)(this.group),this.group.children.length=0,this.addCustomBuilding()):this.data[0]&&this.data[0].url||(Object($o.deepDisposeGroup)(this.group),this.group.children.length=0,this.fetchMapJson())}}},{key:"destroy",value:function(){this.disposeMat(),this.buildings=null,this.group.parent.remove(this.group),Object($o.deepDisposeGroup)(this.group),this.group=null,this.parent.map.off("zooming",this.onZoom)}}]),i}(Xo.a),ra=function(t,e){var i=new Re.BufferGeometry,n=[],r=[];if("triangle"==t){var o=e/2*Math.tan(Math.PI/6),a=[-e/2,-o,0],s=[e/2,-o,0],l=[0,e/2/Math.cos(Math.PI/6),0];r.push.apply(r,a.concat(s,l)),n.push(0,1,2)}else if("rect"==t){var c=[-e/2,-e/2,0],h=[e/2,-e/2,0],u=[e/2,e/2,0],d=[-e/2,e/2,0];r.push.apply(r,c.concat(h,u,d)),n.push(0,1,2,2,3,0)}else if("circle"==t){var p=Math.PI/32*2;r.push(0,0,0);for(var f=0;f<32;f++){var m=p*f;31==f?n.push(0,f+1,1):n.push(0,f+1,f+2),r.push(Math.cos(m)*e,Math.sin(m)*e,0)}}return i.setIndex(n),i.setAttribute("position",new Re.BufferAttribute(new Float32Array(r),3)),i},oa=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n,r,o){var a;Object(s.a)(this,i),n=Ve.o.extend({},n,{layer:o,data:t}),(a=e.call(this))._initOptions(n);var l=n,c=l.altitude,h=l.sprite,u=l.rotate,d=l.sizeMode,p=l.size,f=l.direct,m=l.shape,g=l.fillType;a._createGroup();var y=a.getMap(),_="screen"==d?y.getScale(y.getZoom())/20/25*p:p,v=a.getObject3d(),x="color"==g?ra(m,_):new Re.PlaneBufferGeometry(_,_),b=new Re.Mesh(x,r);if(v.add(b),"stand"==f){var w=a.getMap(),M=w.getBearing(),T=w.getPitch();1==h?(b.rotation.x=T*Math.PI/180,b.parent.rotation.z=-M*Math.PI/180):(b.rotation.x=Math.PI/2,b.parent.rotation.z=u*Math.PI/180)}var S=o.distanceToVector3(c,c).x,E=o.coordinateToVector3(t.coordinate,S);return v.position.copy(E),a}return Object(l.a)(i,[{key:"_animation",value:function(){var t=this.getOptions(),e=this.getObject3d();if("screen"==t.sizeMode){var i=this.getMap(),n=i.getScale(i.getZoom())/20/25*t.size,r=e.children[0];r.geometry.dispose(),"color"==t.fillType?r.geometry=ra(t.shape,n):r.geometry=new Re.PlaneBufferGeometry(n,n)}if("stand"==t.direct){var o=this.getMap(),a=o.getBearing(),s=o.getPitch();1==t.sprite&&(e.children[0].rotation.x=s*Math.PI/180,e.rotation.z=-a*Math.PI/180)}}},{key:"dispose",value:function(){Object($o.deepDispose)(this.getObject3d())}}]),i}(ai),aa=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n){var o;return Object(s.a)(this,i),(o=e.call(this)).id=void 0,o.config=void 0,o.interaction=void 0,o.data=void 0,o.parent=void 0,o.points=void 0,o.onZoom=function(t){var e=t&&null!=t.to?t.to:o.parent.map.getZoom(),i=Object(r.a)(o.config.baseConfig.showLevel,2),n=i[0],a=i[1];e<n||e>a?o.points.map((function(t){return t.hide()})):o.points.map((function(t){return t.show()}))},o.triggerEvent=function(t){var e=o.parent.props,i=e.id,n=e.onRelative,r=e.emit,a=o.interaction.callback;if(n){var s=Object.values(a),l={};s.map((function(e){l[e.target]=t[e.origin]||null})),n(i,l)}r&&r("click",[Object(Wo.a)({},t)],o.id)},o.id=t.id,o.config=t.configuration,o.interaction=t.configuration.interaction,o.data=t.data,o.parent=n,o.points=[],o.showData(),o.parent.map.on("zooming",o.onZoom),o}return Object(l.a)(i,[{key:"transData",value:function(t){var e=this,i=this.config.baseConfig.system;return t.map((function(t){var n=e.parent.matchSystem(i,[t.lng,t.lat]);return Object(Wo.a)(Object(Wo.a)({},t),{},{coordinate:n})}))}},{key:"createShapeTextue",value:function(t,e){var i=document.createElement("canvas");i.width=i.height=64;var n=i.getContext("2d");if("circle"==t)n.fillStyle=e,n.arc(32,32,30,0,2*Math.PI),n.fill();else if("triangle"==t){var r=32*Math.tan(Math.PI/6);n.moveTo(0,r+32),n.lineTo(64,r+32),n.lineTo(32,0),n.fill()}else"cube"==t&&n.fill();var o=new Re.Texture(i);return o.needsUpdate=!0,o}},{key:"createMaterial",value:function(t){var e=t.depthTest,i=t.fillType,n=t.color,r=t.image,o=t.video,a={color:16777215,opacity:1,transparent:!0,depthTest:e,depthWrite:!1,map:null,side:Re.DoubleSide};if("color"==i){var s=Object(Ko.c)(n);a.color=s[0],a.opacity=s[1]}else if("image"==i){var l=(new Re.TextureLoader).load(window.appConfig.ASSETS_URL+r);l.encoding=Re.sRGBEncoding,a.map=l}else"video"==i&&(a.map=function(t){var e=document.createElement("video");e.muted=!0,e.preload="auto",e.loop=!0,e.autoplay=!0,e.controls=!0,e.crossOrigin="anonymous",e.src=window.appConfig.ASSETS_URL+t,e.addEventListener("canplay",(function(t){return t.target.play()}));var i=new Re.VideoTexture(e);return i.minFilter=Re.LinearFilter,i.magFilter=Re.LinearFilter,i.format=Re.RGBAFormat,i.encoding=Re.sRGBEncoding,i}(o));return new Re.MeshBasicMaterial(a)}},{key:"showData",value:function(){var t=this,e=this.config.baseConfig,i=e.depthTest,n=e.renderOrder,o=e.altitude,a=this.config.styleConfig,s=a.direct,l=a.sprite,c=a.rotate,h=a.sizeMode,u=a.size,d=a.fillType,p=a.shape,f=a.color,m=a.image,g=a.video,y=this.parent.threeLayer,_=u.sizeType,v=u.fixValue,x=u.rangeMin,b=u.rangeMax,w={altitude:o,direct:s,depthTest:i,sprite:l,rotate:c,sizeMode:h,fillType:d,color:f,image:m,video:g,shape:p},M=this.createMaterial(w),T=this.transData(this.data),S=T.map((function(t){return t.value})),E=Math.min.apply(Math,Zo(S))||1,C=Math.max.apply(Math,Zo(S))||1,A=function(t,e){var i=Object(r.a)(t,2),n=i[0],o=i[1],a=Object(r.a)(e,2),s=a[0],l=a[1],c=o-n,h=l-s;return function(t){var e=Number(t);return"number"!=typeof e?1:n+(e-s)/h*c}}(["valueMin"==x?E:+x,"valueMax"==b?C:+b],[E,C]);T.map((function(e){var r=v;"range"==_&&(r=A(e.value));var a=new oa(e,{altitude:o,sprite:l,rotate:c,sizeMode:h,size:r,direct:s,shape:p,fillType:d},M,y);a.on("click",(function(){return t.triggerEvent(e)})),a.getObject3d().renderOrder=i?0:n,t.points.push(a)})),y.addMesh(this.points),this.onZoom()}},{key:"updateComponent",value:function(t){var e=this.config,i=this.data;this.config=t.configuration,this.data=t.data,Object(f.isEqual)(e,this.config)&&Object(f.isEqual)(i,this.data)||(this.dispose(),this.showData())}},{key:"dispose",value:function(){this.parent.threeLayer.removeMesh(this.points),this.points.map((function(t){return t.dispose()})),this.points=[]}},{key:"destroy",value:function(){this.parent.map.off("zooming",this.onZoom),this.dispose(),this.parent=null,this.config=null,this.data=[]}}]),i}(Xo.a),sa=(new Re.Color("#0000ff"),new Re.Color("#F5D827"),new Re.Color("#FFFFFF"),"\n    #include <common>\n    #include <fog_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n\n    varying vec2 vUv;\n\n    void main(){\n      #include <begin_vertex>\n      #include <project_vertex>\n      \n      vUv = uv;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\n      #include <logdepthbuf_vertex>\n      #include <fog_vertex>\n    }\n  "),la="\n    #include <fog_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n\n    varying vec2 vUv;\n    uniform float time;\n    uniform float offset;\n\n    uniform vec3 lineColor;\n    uniform float lineOpacity;\n\n    uniform vec3 bottomColor;\n    uniform float bottomOpacity;\n\n    uniform vec3 topColor;\n\t\tuniform float topOpacity;\n\n\t\tuniform float lineLength;\n\t\tuniform bool animation;\n\n    void main(){\n      #include <logdepthbuf_fragment>\n      float start = time * 0.0005 + offset;\n      start = fract(start) * (1.0 + lineLength) - lineLength;\n      float end = start + lineLength;\n      float offset = end - vUv.y;\n\n\t\t\tif(animation) {\n\t\t\t\tif(offset < 0.0 || offset > lineLength) {\n\t\t\t\t\tgl_FragColor = vec4(mix(bottomColor, topColor, vUv.y), mix(bottomOpacity, topOpacity, vUv.y));\n\t\t\t\t} else {\n\t\t\t\t\tgl_FragColor = vec4(lineColor, lineOpacity);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tgl_FragColor = vec4(mix(bottomColor, topColor, vUv.y), mix(bottomOpacity, topOpacity, vUv.y));\n\t\t\t}\n\n\t\t  #include <fog_fragment>\n\t\t}\n  ",ca=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n){var o;return Object(s.a)(this,i),(o=e.call(this)).id=void 0,o.config=void 0,o.interaction=void 0,o.data=void 0,o.parent=void 0,o.scene=void 0,o.group=void 0,o.mapJson=void 0,o.buildings=void 0,o.material=void 0,o.fences=void 0,o.loadItem=void 0,o.onZoom=function(t){var e=t&&null!=t.to?t.to:o.parent.map.getZoom(),i=Object(r.a)(o.config.baseConfig.showLevel,2),n=i[0],a=i[1];e<n||e>a?o.fences.map((function(t){return t.hide()})):o.fences.map((function(t){return t.show()}))},o.triggerEvent=function(t){var e=o.parent.props,i=e.id,n=e.onRelative,r=e.emit,a=o.interaction.callback;if(n){var s=Object.values(a),l={};s.map((function(e){l[e.target]=t[e.origin]||null})),n(i,l)}r&&r("click",[Object(Wo.a)({},t)],o.id)},o.id=t.id,o.config=t.configuration,o.data=t.data,o.parent=n,o.interaction=t.configuration.interaction,o.scene=n.extend.scene,o.fences=[],o.showData(),o.parent.map.on("zooming",o.onZoom),o}return Object(l.a)(i,[{key:"showData",value:function(){var t=this,e=this.config.styleConfig.url;e?(this.loadItem=Object(Ko.d)(this),fetch("".concat(window.appConfig.ASSETS_URL).concat(e)).then((function(t){return t.json()})).then((function(e){var i,n=a(e.features);try{for(n.s();!(i=n.n()).done;){var r,o=i.value,s=t.createMultipleFence(o);(r=t.fences).push.apply(r,Zo(s))}}catch(t){n.e(t)}finally{n.f()}t.parent.threeLayer.addMesh(t.fences),t.onZoom(),t.loadItem.loaded=!0,t.parent.checkLoading()}))):(this.data.forEach((function(e){e.features&&e.features.map((function(e){var i,n=t.createMultipleFence(e);(i=t.fences).push.apply(i,Zo(n))}))})),this.parent.threeLayer.addMesh(this.fences),this.onZoom())}},{key:"createMultipleFence",value:function(t){var e=this,i=[],n=t.geometry.type,r=t.properties,o=void 0===r?{}:r,a=this.config,s=a.baseConfig,l=a.styleConfig,c=l.styleType,h=l.styles,u=l.defaultStyle,d=l;switch("default"==c&&(d=Object(p.reduceConfig2)(u[h])),n){case"MultiPolygon":t.geometry.coordinates.forEach((function(t){t.forEach((function(t){var n=new ha(t,s,d,e.parent);n.on("click",(function(){return e.triggerEvent(o)})),i.push(n)}))}));break;case"Polygon":t.geometry.coordinates.forEach((function(t){var n=new ha(t,s,d,e.parent);n.on("click",(function(){return e.triggerEvent(o)})),i.push(n)}))}return i}},{key:"updateComponent",value:function(t){var e=this.config,i=this.data;this.config=t.configuration,this.data=t.data,Object(f.isEqual)(e,this.config)&&Object(f.isEqual)(i,this.data)||(this.dispose(),this.showData())}},{key:"dispose",value:function(){this.parent.threeLayer.removeMesh(this.fences),this.fences.map((function(t){return t.dispose()})),this.fences=[]}},{key:"destroy",value:function(){this.dispose(),this.parent.map.off("zooming",this.onZoom)}}]),i}(Xo.a),ha=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n,o,a){var l;Object(s.a)(this,i),(l=e.call(this)).createMat=function(t,e){var i=t.depthTest,n=e.fillType;return"color"==n?function(t,e){var i=e.colors,n=e.animationConfig,o=n.show,a=n.lineColor,s=n.lineHeight,l=Object(r.a)(i.linear.stops,2),c=l[0].color,h=l[1].color,u=Object(Ko.c)(h),d=Object(Ko.c)(c),p=Object(Ko.c)(a);return new Re.ShaderMaterial({vertexShader:sa,fragmentShader:la,side:Re.DoubleSide,transparent:!0,depthWrite:!1,depthTest:t,uniforms:{time:{value:0},offset:{value:0},lineColor:{value:new Re.Color(p[0])},lineOpacity:{value:p[1]},bottomColor:{value:new Re.Color(d[0])},bottomOpacity:{value:d[1]},topColor:{value:new Re.Color(u[0])},topOpacity:{value:u[1]},lineLength:{value:s},animation:{value:o}}})}(i,e):"video"==n?function(t,e){var i=e.video,n=e.wire,r=Object(Ko.b)(i);return new Re.MeshBasicMaterial({color:"#fff",wireframe:n,map:n?null:r,transparent:!0,opacity:1,side:Re.DoubleSide,depthWrite:!1,depthTest:t,blending:Re.AdditiveBlending})}(i,e):void 0},l.createGeo=function(t,e,i,n){var r=e.system,o=i.fillType,a=i.height,s=i.width,l=[],c=[],h=[],u=0;if("color"==o)for(var d=0;d<t.length;d++){var p=n.matchSystem(r,t[d]),f=n.threeLayer.coordinateToVector3(p,a/10);l.push(f.x,f.y,0),h.push(0,0),l.push(f.x,f.y,f.z),h.push(0,1),d<t.length-1&&(c.push(u,u+1,u+2),u++,c.push(u+2,u+1,u),u++)}else if("video"==o){var m=[];t.map((function(t,e){var i=n.threeLayer.coordinateToVector3(t,a/10);if(0!=e){var r=m[e-1].distanceTo(i);r}m.push(i)}));for(var g=0,y=0,_=m[0],v=1,x=0;x<m.length;x++){var b=m[x];0!=x&&(g+=y=m[x-1].distanceTo(b));var w=g/s;if(w>1){for(var M=b.clone().sub(m[x-1]).normalize(),T=m[x-1].distanceTo(_),S=(y+T)/s,E=void 0,C=1;C<S;C++){var A=m[x-1].clone().addScaledVector(M,s*C-T);l.push(A.x,A.y,0),l.push(A.x,A.y,A.z),c.push(u,u+1,u+2),u++,c.push(u+2,u+1,u),u++,h.push(v,0),h.push(v,1),v=0==v?1:0,E=A}_=E||_}l.push(b.x,b.y,0),l.push(b.x,b.y,b.z),1==v?(h.push(w%1,0),h.push(w%1,1)):(h.push(1-w%1,0),h.push(1-w%1,1)),x!=m.length-1&&(c.push(u,u+1,u+2),u++,c.push(u+2,u+1,u),u++)}}var P=new Re.BufferGeometry;return P.setIndex(c),P.setAttribute("position",new Re.Float32BufferAttribute(l,3)),P.setAttribute("uv",new Re.Float32BufferAttribute(h,2)),P},l.createFence=function(t,e,i,n){var r=e.depthTest,o=e.renderOrder,a=i.bloom,s=l.createGeo(t,e,i,n),c=l.createMat(e,i),h=new Re.Mesh(s,c);return a&&h.layers.enable(1),Object(Ko.f)(h),h.renderOrder=r?0:o,h};var c=Ve.o.extend({},{lnglats:t,baseConfig:n,styleConfig:o,parent:a});l._initOptions(c),l._createGroup();var h=l.getObject3d(),u=l.createFence(t,n,o,a);h.add(u);var d=n.altitude,p=a.threeLayer.distanceToVector3(0,1).y;return h.position.z=p*d,l.mesh=u,l}return Object(l.a)(i,[{key:"_animation",value:function(){var t=this.getOptions().styleConfig,e=t.fillType,i=t.animationConfig,n=i.show,r=i.speed;"color"==e&&n&&(this.mesh.material.uniforms.time.value+=r)}},{key:"dispose",value:function(){Object($o.deepDispose)(this.mesh),this.mesh=null}}]),i}(ai),ua={uniforms:{time:{value:0,interval:1},offset:{value:0},backColor:{value:new Re.Color("#FFFF00")},backOpacity:{value:.3},startColor:{value:new Re.Color("#F5D827")},startOpacity:{value:1},endColor:{value:new Re.Color("#FFFFFF")},endOpacity:{value:.3},lineLength:{value:.3}},vertexShader:["#include <common>","#include <fog_pars_vertex>","#include <logdepthbuf_pars_vertex>","varying vec2 vUv;","void main(){","#include <begin_vertex>","#include <project_vertex>"," vUv = uv;"," gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);"," #include <logdepthbuf_vertex>","#include <fog_vertex>","}"].join("\n"),fragmentShader:"\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\tvarying vec2 vUv;\n\t\tuniform float time;\n\t\tuniform float offset;\n\n\t\tuniform vec3 backColor;\n\t\tuniform float backOpacity;\n\n\t\tuniform vec3 startColor;\n\t\tuniform float startOpacity;\n\n\t\tuniform vec3 endColor;\n\t\tuniform float endOpacity;\n\n\t\tuniform float lineLength;\n\n\t\tvoid main(){\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t\n\t\t\tfloat start = time * 0.0005 + offset;\n\t\t\tstart = fract(start) * (1.0 + lineLength) - lineLength;\n\n\t\t\tfloat end = start + lineLength;\n\t\t\tfloat offset = end - vUv.x;\n\n\t\t\tif(offset < 0.0 || offset > lineLength) {\n\t\t\t\tgl_FragColor = vec4(backColor, backOpacity);\n\t\t\t} else {\n\t\t\t\tfloat intensity = 1.0;\n\t\t\t\tintensity = 1.0 - abs(offset / lineLength);\n\t\t\t\tgl_FragColor = vec4(vec3(mix(endColor, startColor, intensity)), mix(endOpacity, startOpacity, intensity));\n\t\t\t}\n\n\t\t\t#include <fog_fragment>\n\t\t}\n\t"},da=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n){var o;return Object(s.a)(this,i),(o=e.call(this)).id=void 0,o.config=void 0,o.interaction=void 0,o.data=void 0,o.parent=void 0,o.scene=void 0,o.mapJson=void 0,o.buildings=void 0,o.material=void 0,o.flyLines=void 0,o.onZoom=function(t){var e=t&&null!=t.to?t.to:o.parent.map.getZoom(),i=Object(r.a)(o.config.baseConfig.showLevel,2),n=i[0],a=i[1];e<n||e>a?o.flyLines.map((function(t){return t.hide()})):o.flyLines.map((function(t){return t.show()}))},o.triggerEvent=function(t){var e=o.parent.props,i=e.id,n=e.onRelative,r=e.emit,a=o.interaction.callback;if(n){var s=Object.values(a),l={};s.map((function(e){l[e.target]=t[e.origin]||null})),n(i,l)}r&&r("click",[Object(Wo.a)({},t)],o.id)},o.id=t.id,o.config=t.configuration,o.data=t.data,o.parent=n,o.interaction=t.configuration.interaction,o.scene=n.extend.scene,o.flyLines=[],o.showData(),o.parent.map.on("zooming",o.onZoom),o}return Object(l.a)(i,[{key:"showData",value:function(){var t=this;this.data.forEach((function(e){var i=new pa(e,t.config,t.parent);i.on("click",(function(){return t.triggerEvent(e)})),t.flyLines.push(i)})),this.parent.threeLayer.addMesh(this.flyLines),this.onZoom()}},{key:"updateComponent",value:function(t){var e=this.config,i=this.data;this.config=t.configuration,this.data=t.data,Object(f.isEqual)(e,this.config)&&Object(f.isEqual)(i,this.data)||(this.dispose(),this.showData())}},{key:"dispose",value:function(){this.parent.threeLayer.removeMesh(this.flyLines),this.flyLines.map((function(t){return t.dispose()})),this.flyLines=[]}},{key:"destroy",value:function(){this.dispose(),this.parent.map.off("zooming",this.onZoom)}}]),i}(Xo.a),pa=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n,o){var a;Object(s.a)(this,i),(a=e.call(this)).createMat=function(t){var e=t.baseConfig.depthTest,i=t.animateConfig.startRandom,n=t.styleConfig,o=n.lineConfig,a=n.backConfig,s=o.colors.linear,l=s.stops,c=s.opacity,h=o.lineLength,u=a.show,d=a.color,p=Object(r.a)(l,2),f=p[0].color,m=p[1].color,g=Object(Ko.c)(f),y=Object(Ko.c)(m),_=Object(Ko.c)(d);return new Re.ShaderMaterial({vertexShader:ua.vertexShader,fragmentShader:ua.fragmentShader,side:Re.DoubleSide,transparent:!0,depthWrite:!1,depthTest:e,uniforms:{time:{value:0},offset:{value:i?.1*Math.round(10*Math.random()):0},startColor:{value:new Re.Color(g[0])},startOpacity:{value:g[1]*c},endColor:{value:new Re.Color(y[0])},endOpacity:{value:y[1]*c},backColor:{value:new Re.Color(_[0])},backOpacity:{value:u?_[1]:0},lineLength:{value:h}}})},a.createGeo=function(t,e,i){var n=e.baseConfig.system,r=e.styleConfig.lineConfig,o=r.lineHeight,a=r.lineWidth,s=t.startLng,l=t.startLat,c=t.endLng,h=t.endLat,u=i.matchSystem(n,[s,l]),d=i.matchSystem(n,[c,h]);s=u[0],l=u[1],c=d[0],h=d[1];var p=new Re.Vector2(Number(s),Number(l)),f=new Re.Vector2(Number(c),Number(h)),m=p.clone().lerp(f,.35),g=p.clone().lerp(f,.65),y=i.threeLayer.coordinateToVector3([s,l],0),_=i.threeLayer.coordinateToVector3([m.x,m.y],o/10),v=i.threeLayer.coordinateToVector3([g.x,g.y],o/10),x=i.threeLayer.coordinateToVector3([c,h,0]),b=new Re.CubicBezierCurve3(new Re.Vector3(y.x,y.y,y.z),new Re.Vector3(_.x,_.y,_.z),new Re.Vector3(v.x,v.y,v.z),new Re.Vector3(x.x,x.y,x.z));return new Re.TubeBufferGeometry(b,50,a/100,3,!1)},a.createFlyLine=function(t,e,i){var n=e.baseConfig,r=n.depthTest,o=n.renderOrder,s=e.styleConfig.bloom,l=a.createGeo(t,e,i),c=a.createMat(e),h=new Re.Mesh(l,c);return Object(Ko.f)(h),s&&h.layers.enable(1),h.renderOrder=r?0:o,h};var l=Ve.o.extend({},{data:t,config:n,parent:o});a._initOptions(l),a._createGroup();var c=a.getObject3d(),h=a.createFlyLine(t,n,o);c.add(h);var u=n.baseConfig.altitude,d=o.threeLayer.distanceToVector3(0,1).y;return c.position.z=d*u,a.mesh=h,a}return Object(l.a)(i,[{key:"_animation",value:function(){var t=this,e=this.getOptions().config,i=e.styleConfig.lineConfig.lineLength,n=e.animateConfig,r=n.speed,o=n.interval,a=this.mesh.material.uniforms,s=a.time,l=a.offset,c=5e-4*(s.value+r)+l.value;c=c%1*(1+i)-i,this.mesh.pause||(this.mesh.material.uniforms.time.value+=r),c>1-.001*r&&(this.mesh.pause=!0,setTimeout((function(){t.mesh&&(t.mesh.pause=!1)}),1e3*o))}},{key:"dispose",value:function(){Object($o.deepDispose)(this.mesh),this.mesh=null}}]),i}(ai),fa=i(21),ma=i.n(fa),ga=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n){var o;Object(s.a)(this,i),(o=e.call(this)).id=void 0,o.config=void 0,o.interaction=void 0,o.data=void 0,o.parent=void 0,o.scene=void 0,o.group=void 0,o.mapJson=void 0,o.buildings=void 0,o.material=void 0,o.heatmap=void 0,o.meterScale=void 0,o.loadItem=void 0,o.onZoom=function(t){var e=t&&null!=t.to?t.to:o.parent.map.getZoom(),i=Object(r.a)(o.config.baseConfig.showLevel,2),n=i[0],a=i[1];o.heatmap.visible=!(e<n||e>a)},o.id=t.id,o.config=t.configuration,o.data=t.data,o.parent=n,o.interaction=t.configuration.interaction,o.scene=n.extend.scene,o.group=new Re.Group,o.group.name="热力",o.meterScale=n.threeLayer.distanceToVector3(0,1).y;var a=o.config.baseConfig.altitude;return o.group.position.z=o.meterScale*a,o.scene.add(o.group),o.showData(),o.parent.map.on("zooming",o.onZoom),o}return Object(l.a)(i,[{key:"showData",value:function(){var t=this;this.loadItem=Object(Ko.d)(this);var e,i,n,r,o,a,s=this.config.baseConfig.system,l=this.parent.threeLayer,c=this.config.showConfig,h=c.radius,u=c.blur,d=c.height,p=c.valueRange,f=c.colors.linear.stops,m=this.data.map((function(c){var h=t.parent.matchSystem(s,[c.lng,c.lat]),u=l.coordinateToVector3(h);return e=null!=e&&e<u.x?e:u.x,i=null!=i&&i>u.x?i:u.x,n=null!=n&&n<u.y?n:u.y,r=null!=r&&r>u.y?r:u.y,o=null!=o&&o<c.value?o:c.value,a=null!=a&&a>c.value?a:c.value,Object(Wo.a)(Object(Wo.a)({},u),{},{value:c.value})})),g={x:(e+i)/2,y:(n+r)/2,z:0},y=i-e+2*h,_=r-n+2*h,v=1;(y>512||_>512)&&(y>_?(v=y/512,y=512,_/=v):(v=_/512,_=512,y/=v));var x=m.map((function(t){return{x:Math.round((t.x-e+h)/v),y:Math.round((t.y-n+h)/v),value:t.value}})),b=document.createElement("div"),w=document.createElement("div"),M=document.createElement("canvas"),T=document.createElement("canvas"),S={};f.map((function(t){var e=t.offset,i=t.color;S[1-e/100]=i}));var E={data:x,min:"valueMin"==p.min?o:p.min,max:"valueMax"==p.max?a:p.max};ma.a.create({width:y,height:_,container:b,canvas:M,blur:u,minOpacity:1,maxOpacity:1,radius:h/v,useGradientOpacity:!0,gradient:S}).setData(E),ma.a.create({width:y,height:_,container:w,canvas:T,blur:u,minOpacity:0,maxOpacity:1,radius:h/v,gradient:{"0.0":"#000000","1.0":"#ffffff"}}).setData(E);for(var C=[],A=T.getContext("2d").getImageData(0,0,y,_).data,P=0;P<A.length;P+=4){var L=A[P+3]/255,I=L<0?0:L-0;C.push(I)}for(var R=new Re.PlaneBufferGeometry(y,_,y-1,_-1),D=R.attributes.position.array,k=[],O=0;O<D.length;O++){var z=(O+1)%3==0?-C[(O-2)/3]*d:D[O];k.push(z)}R.setAttribute("position",new Re.Float32BufferAttribute(k,3,!0));var B=new Re.MeshBasicMaterial({transparent:!0,map:new Re.CanvasTexture(M),color:"#fff",side:Re.BackSide});this.heatmap=new Re.Mesh(R,B),this.heatmap.position.copy(g),this.heatmap.rotation.x=-Math.PI,this.heatmap.scale.x=v,this.heatmap.scale.y=v,this.group.add(this.heatmap),this.onZoom(),this.loadItem.loaded=!0,this.parent.checkLoading()}},{key:"updateComponent",value:function(t){var e=this.config,i=this.data,n=e.baseConfig.altitude;this.config=t.configuration,this.data=t.data;var r=this.config.baseConfig.altitude;n!==r?this.group.position.z=this.meterScale*r:Object(f.isEqual)(e,this.config)&&Object(f.isEqual)(i,this.data)||(this.dispose(),this.showData())}},{key:"dispose",value:function(){this.heatmap&&this.group.remove(this.heatmap),Object($o.deepDispose)(this.heatmap),this.heatmap=null}},{key:"destroy",value:function(){this.dispose(),this.scene.remove(this.group),this.group=null,this.parent.map.off("zooming",this.onZoom)}}]),i}(Xo.a),ya=function(){function t(t){Re.Loader.call(this,t),this.dracoLoader=null,this.ddsLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(t){return new a(t)})),this.register((function(t){return new l(t)})),this.register((function(t){return new c(t)})),this.register((function(t){return new s(t)})),this.register((function(t){return new r(t)})),this.register((function(t){return new h(t)}))}function e(){var t={};return{get:function(e){return t[e]},add:function(e,i){t[e]=i},remove:function(e){delete t[e]},removeAll:function(){t={}}}}t.prototype=Object.assign(Object.create(Re.Loader.prototype),{constructor:t,load:function(t,e,i,n){var r,o=this;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:Re.LoaderUtils.extractUrlBase(t),this.manager.itemStart(t);var a=function(e){n?n(e):console.error(e),o.manager.itemError(t),o.manager.itemEnd(t)},s=new Re.FileLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(t,(function(i){try{o.parse(i,r,(function(i){e(i),o.manager.itemEnd(t)}),a)}catch(t){a(t)}}),i,a)},setDRACOLoader:function(t){return this.dracoLoader=t,this},setDDSLoader:function(t){return this.ddsLoader=t,this},setKTX2Loader:function(t){return this.ktx2Loader=t,this},setMeshoptDecoder:function(t){return this.meshoptDecoder=t,this},register:function(t){return-1===this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.push(t),this},unregister:function(t){return-1!==this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this},parse:function(t,e,r,a){var s,l={},c={};if("string"==typeof t)s=t;else if(Re.LoaderUtils.decodeText(new Uint8Array(t,0,4))===u){try{l[i.KHR_BINARY_GLTF]=new f(t)}catch(t){return void(a&&a(t))}s=l[i.KHR_BINARY_GLTF].content}else s=Re.LoaderUtils.decodeText(new Uint8Array(t));var h=JSON.parse(s);if(void 0===h.asset||h.asset.version[0]<2)a&&a(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var d=new V(h,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});d.fileLoader.setRequestHeader(this.requestHeader);for(var p=0;p<this.pluginCallbacks.length;p++){var y=this.pluginCallbacks[p](d);c[y.name]=y,l[y.name]=!0}if(h.extensionsUsed)for(p=0;p<h.extensionsUsed.length;++p){var x=h.extensionsUsed[p],b=h.extensionsRequired||[];switch(x){case i.KHR_MATERIALS_UNLIT:l[x]=new o;break;case i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:l[x]=new _;break;case i.KHR_DRACO_MESH_COMPRESSION:l[x]=new m(h,this.dracoLoader);break;case i.MSFT_TEXTURE_DDS:l[x]=new n(this.ddsLoader);break;case i.KHR_TEXTURE_TRANSFORM:l[x]=new g;break;case i.KHR_MESH_QUANTIZATION:l[x]=new v;break;default:b.indexOf(x)>=0&&void 0===c[x]&&console.warn('THREE.GLTFLoader: Unknown extension "'+x+'".')}}d.setExtensions(l),d.setPlugins(c),d.parse(r,a)}}});var i={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function n(t){if(!t)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=i.MSFT_TEXTURE_DDS,this.ddsLoader=t}function r(t){this.parser=t,this.name=i.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function o(){this.name=i.KHR_MATERIALS_UNLIT}function a(t){this.parser=t,this.name=i.KHR_MATERIALS_CLEARCOAT}function s(t){this.parser=t,this.name=i.KHR_MATERIALS_TRANSMISSION}function l(t){this.parser=t,this.name=i.KHR_TEXTURE_BASISU}function c(t){this.parser=t,this.name=i.EXT_TEXTURE_WEBP,this.isSupported=null}function h(t){this.name=i.EXT_MESHOPT_COMPRESSION,this.parser=t}r.prototype._markDefs=function(){for(var t=this.parser,e=this.parser.json.nodes||[],i=0,n=e.length;i<n;i++){var r=e[i];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&t._addNodeRef(this.cache,r.extensions[this.name].light)}},r.prototype._loadLight=function(t){var e=this.parser,i="light:"+t,n=e.cache.get(i);if(n)return n;var r,o=e.json,a=((o.extensions&&o.extensions[this.name]||{}).lights||[])[t],s=new Re.Color(16777215);void 0!==a.color&&s.fromArray(a.color);var l=void 0!==a.range?a.range:0;switch(a.type){case"directional":(r=new Re.DirectionalLight(s)).target.position.set(0,0,-1),r.add(r.target);break;case"point":(r=new Re.PointLight(s)).distance=l;break;case"spot":(r=new Re.SpotLight(s)).distance=l,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,r.angle=a.spot.outerConeAngle,r.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,r.target.position.set(0,0,-1),r.add(r.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return r.position.set(0,0,0),r.decay=2,void 0!==a.intensity&&(r.intensity=a.intensity),r.name=e.createUniqueName(a.name||"light_"+t),n=Promise.resolve(r),e.cache.add(i,n),n},r.prototype.createNodeAttachment=function(t){var e=this,i=this.parser,n=i.json.nodes[t],r=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(t){return i._getNodeRef(e.cache,r,t)}))},o.prototype.getMaterialType=function(){return Re.MeshBasicMaterial},o.prototype.extendParams=function(t,e,i){var n=[];t.color=new Re.Color(1,1,1),t.opacity=1;var r=e.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){var o=r.baseColorFactor;t.color.fromArray(o),t.opacity=o[3]}void 0!==r.baseColorTexture&&n.push(i.assignTexture(t,"map",r.baseColorTexture))}return Promise.all(n)},a.prototype.getMaterialType=function(t){var e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?Re.MeshPhysicalMaterial:null},a.prototype.extendMaterialParams=function(t,e){var i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var r=[],o=n.extensions[this.name];if(void 0!==o.clearcoatFactor&&(e.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&r.push(i.assignTexture(e,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(e.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&r.push(i.assignTexture(e,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(r.push(i.assignTexture(e,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){var a=o.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new Re.Vector2(a,-a)}return Promise.all(r)},s.prototype.getMaterialType=function(t){var e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?Re.MeshPhysicalMaterial:null},s.prototype.extendMaterialParams=function(t,e){var i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var r=[],o=n.extensions[this.name];return void 0!==o.transmissionFactor&&(e.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&r.push(i.assignTexture(e,"transmissionMap",o.transmissionTexture)),Promise.all(r)},l.prototype.loadTexture=function(t){var e=this.parser,i=e.json,n=i.textures[t];if(!n.extensions||!n.extensions[this.name])return null;var r=n.extensions[this.name],o=i.images[r.source],a=e.options.ktx2Loader;if(!a){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,o,a)},c.prototype.loadTexture=function(t){var e=this.name,i=this.parser,n=i.json,r=n.textures[t];if(!r.extensions||!r.extensions[e])return null;var o=r.extensions[e],a=n.images[o.source],s=a.uri?i.options.manager.getHandler(a.uri):i.textureLoader;return this.detectSupport().then((function(r){if(r)return i.loadTextureImage(t,a,s);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(t)}))},c.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(t){var e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported},h.prototype.loadBufferView=function(t){var e=this.parser.json,i=e.bufferViews[t];if(i.extensions&&i.extensions[this.name]){var n=i.extensions[this.name],r=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([r,o.ready]).then((function(t){var e=n.byteOffset||0,i=n.byteLength||0,r=n.count,a=n.byteStride,s=new ArrayBuffer(r*a),l=new Uint8Array(t[0],e,i);return o.decodeGltfBuffer(new Uint8Array(s),r,a,l,n.mode,n.filter),s}))}return null};var u="glTF",d=1313821514,p=5130562;function f(t){this.name=i.KHR_BINARY_GLTF,this.content=null,this.body=null;var e=new DataView(t,0,12);if(this.header={magic:Re.LoaderUtils.decodeText(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==u)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var n=this.header.length-12,r=new DataView(t,12),o=0;o<n;){var a=r.getUint32(o,!0);o+=4;var s=r.getUint32(o,!0);if(o+=4,s===d){var l=new Uint8Array(t,12+o,a);this.content=Re.LoaderUtils.decodeText(l)}else if(s===p){var c=12+o;this.body=t.slice(c,c+a)}o+=a}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function m(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=i.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}function g(){this.name=i.KHR_TEXTURE_TRANSFORM}function y(t){Re.MeshStandardMaterial.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var e=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),r=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),o=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),a={specular:{value:(new Re.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(t){for(var s in a)t.uniforms[s]=a[s];t.fragmentShader=t.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",e).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",r).replace("#include <lights_physical_fragment>",o)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(t){a.specular.value=t}},specularMap:{get:function(){return a.specularMap.value},set:function(t){a.specularMap.value=t,t?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(t){a.glossiness.value=t}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(t){a.glossinessMap.value=t,t?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(t)}function _(){return{name:i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return y},extendParams:function(t,e,i){var n=e.extensions[this.name];t.color=new Re.Color(1,1,1),t.opacity=1;var r=[];if(Array.isArray(n.diffuseFactor)){var o=n.diffuseFactor;t.color.fromArray(o),t.opacity=o[3]}if(void 0!==n.diffuseTexture&&r.push(i.assignTexture(t,"map",n.diffuseTexture)),t.emissive=new Re.Color(0,0,0),t.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,t.specular=new Re.Color(1,1,1),Array.isArray(n.specularFactor)&&t.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var a=n.specularGlossinessTexture;r.push(i.assignTexture(t,"glossinessMap",a)),r.push(i.assignTexture(t,"specularMap",a))}return Promise.all(r)},createMaterial:function(t){var e=new y(t);return e.fog=!0,e.color=t.color,e.map=void 0===t.map?null:t.map,e.lightMap=null,e.lightMapIntensity=1,e.aoMap=void 0===t.aoMap?null:t.aoMap,e.aoMapIntensity=1,e.emissive=t.emissive,e.emissiveIntensity=1,e.emissiveMap=void 0===t.emissiveMap?null:t.emissiveMap,e.bumpMap=void 0===t.bumpMap?null:t.bumpMap,e.bumpScale=1,e.normalMap=void 0===t.normalMap?null:t.normalMap,e.normalMapType=Re.TangentSpaceNormalMap,t.normalScale&&(e.normalScale=t.normalScale),e.displacementMap=null,e.displacementScale=1,e.displacementBias=0,e.specularMap=void 0===t.specularMap?null:t.specularMap,e.specular=t.specular,e.glossinessMap=void 0===t.glossinessMap?null:t.glossinessMap,e.glossiness=t.glossiness,e.alphaMap=null,e.envMap=void 0===t.envMap?null:t.envMap,e.envMapIntensity=1,e.refractionRatio=.98,e}}}function v(){this.name=i.KHR_MESH_QUANTIZATION}function x(t,e,i,n){Re.Interpolant.call(this,t,e,i,n)}m.prototype.decodePrimitive=function(t,e){var i=this.json,n=this.dracoLoader,r=t.extensions[this.name].bufferView,o=t.extensions[this.name].attributes,a={},s={},l={};for(var c in o){var h=R[c]||c.toLowerCase();a[h]=o[c]}for(c in t.attributes){h=R[c]||c.toLowerCase();if(void 0!==o[c]){var u=i.accessors[t.attributes[c]],d=A[u.componentType];l[h]=d,s[h]=!0===u.normalized}}return e.getDependency("bufferView",r).then((function(t){return new Promise((function(e){n.decodeDracoFile(t,(function(t){for(var i in t.attributes){var n=t.attributes[i],r=s[i];void 0!==r&&(n.normalized=r)}e(t)}),a,l)}))}))},g.prototype.extendTexture=function(t,e){return t=t.clone(),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),void 0!==e.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),t.needsUpdate=!0,t},y.prototype=Object.create(Re.MeshStandardMaterial.prototype),y.prototype.constructor=y,y.prototype.copy=function(t){return Re.MeshStandardMaterial.prototype.copy.call(this,t),this.specularMap=t.specularMap,this.specular.copy(t.specular),this.glossinessMap=t.glossinessMap,this.glossiness=t.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},x.prototype=Object.create(Re.Interpolant.prototype),x.prototype.constructor=x,x.prototype.copySampleValue_=function(t){for(var e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,r=t*n*3+n,o=0;o!==n;o++)e[o]=i[r+o];return e},x.prototype.beforeStart_=x.prototype.copySampleValue_,x.prototype.afterEnd_=x.prototype.copySampleValue_,x.prototype.interpolate_=function(t,e,i,n){for(var r=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=2*a,l=3*a,c=n-e,h=(i-e)/c,u=h*h,d=u*h,p=t*l,f=p-l,m=-2*d+3*u,g=d-u,y=1-m,_=g-u+h,v=0;v!==a;v++){var x=o[f+v+a],b=o[f+v+s]*c,w=o[p+v+a],M=o[p+v]*c;r[v]=y*x+_*b+m*w+g*M}return r};var b=0,w=1,M=2,T=3,S=4,E=5,C=6,A={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},P={9728:Re.NearestFilter,9729:Re.LinearFilter,9984:Re.NearestMipmapNearestFilter,9985:Re.LinearMipmapNearestFilter,9986:Re.NearestMipmapLinearFilter,9987:Re.LinearMipmapLinearFilter},L={33071:Re.ClampToEdgeWrapping,33648:Re.MirroredRepeatWrapping,10497:Re.RepeatWrapping},I={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},R={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},D={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},k={CUBICSPLINE:void 0,LINEAR:Re.InterpolateLinear,STEP:Re.InterpolateDiscrete},O="OPAQUE",z="MASK",B="BLEND";function F(t,e){return"string"!=typeof t||""===t?"":(/^https?:\/\//i.test(e)&&/^\//.test(t)&&(e=e.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(t)||/^data:.*,.*$/i.test(t)||/^blob:.*$/i.test(t)?t:e+t)}function N(t,e,i){for(var n in i.extensions)void 0===t[n]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=i.extensions[n])}function j(t,e){void 0!==e.extras&&("object"==typeof e.extras?Object.assign(t.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function G(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(var i=0,n=e.weights.length;i<n;i++)t.morphTargetInfluences[i]=e.weights[i];if(e.extras&&Array.isArray(e.extras.targetNames)){var r=e.extras.targetNames;if(t.morphTargetInfluences.length===r.length){t.morphTargetDictionary={};for(i=0,n=r.length;i<n;i++)t.morphTargetDictionary[r[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function U(t){for(var e="",i=Object.keys(t).sort(),n=0,r=i.length;n<r;n++)e+=i[n]+":"+t[i[n]]+";";return e}function V(t,i){this.json=t||{},this.extensions={},this.plugins={},this.options=i||{},this.cache=new e,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new Re.ImageBitmapLoader(this.options.manager):this.textureLoader=new Re.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new Re.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function H(t,e,i){var n=e.attributes,r=[];function o(e,n){return i.getDependency("accessor",e).then((function(e){t.setAttribute(n,e)}))}for(var a in n){var s=R[a]||a.toLowerCase();s in t.attributes||r.push(o(n[a],s))}if(void 0!==e.indices&&!t.index){var l=i.getDependency("accessor",e.indices).then((function(e){t.setIndex(e)}));r.push(l)}return j(t,e),function(t,e,i){var n=e.attributes,r=new Re.Box3;if(void 0!==n.POSITION){var o=(p=i.json.accessors[n.POSITION]).min,a=p.max;if(void 0!==o&&void 0!==a){r.set(new Re.Vector3(o[0],o[1],o[2]),new Re.Vector3(a[0],a[1],a[2]));var s=e.targets;if(void 0!==s){for(var l=new Re.Vector3,c=new Re.Vector3,h=0,u=s.length;h<u;h++){var d=s[h];if(void 0!==d.POSITION){var p;o=(p=i.json.accessors[d.POSITION]).min,a=p.max;void 0!==o&&void 0!==a?(c.setX(Math.max(Math.abs(o[0]),Math.abs(a[0]))),c.setY(Math.max(Math.abs(o[1]),Math.abs(a[1]))),c.setZ(Math.max(Math.abs(o[2]),Math.abs(a[2]))),l.max(c)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(l)}t.boundingBox=r;var f=new Re.Sphere;r.getCenter(f.center),f.radius=r.min.distanceTo(r.max)/2,t.boundingSphere=f}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(t,e,i),Promise.all(r).then((function(){return void 0!==e.targets?function(t,e,i){for(var n=!1,r=!1,o=0,a=e.length;o<a;o++){if(void 0!==(c=e[o]).POSITION&&(n=!0),void 0!==c.NORMAL&&(r=!0),n&&r)break}if(!n&&!r)return Promise.resolve(t);var s=[],l=[];for(o=0,a=e.length;o<a;o++){var c=e[o];if(n){var h=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):t.attributes.position;s.push(h)}if(r){h=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):t.attributes.normal;l.push(h)}}return Promise.all([Promise.all(s),Promise.all(l)]).then((function(e){var i=e[0],o=e[1];return n&&(t.morphAttributes.position=i),r&&(t.morphAttributes.normal=o),t.morphTargetsRelative=!0,t}))}(t,e.targets,i):t}))}function Z(t,e){var i=t.getIndex();if(null===i){var n=[],r=t.getAttribute("position");if(void 0===r)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(var o=0;o<r.count;o++)n.push(o);t.setIndex(n),i=t.getIndex()}var a=i.count-2,s=[];if(e===Re.TriangleFanDrawMode)for(o=1;o<=a;o++)s.push(i.getX(0)),s.push(i.getX(o)),s.push(i.getX(o+1));else for(o=0;o<a;o++)o%2==0?(s.push(i.getX(o)),s.push(i.getX(o+1)),s.push(i.getX(o+2))):(s.push(i.getX(o+2)),s.push(i.getX(o+1)),s.push(i.getX(o)));s.length/3!==a&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=t.clone();return l.setIndex(s),l}return V.prototype.setExtensions=function(t){this.extensions=t},V.prototype.setPlugins=function(t){this.plugins=t},V.prototype.parse=function(t,e){var i=this,n=this.json,r=this.extensions;this.cache.removeAll(),this._invokeAll((function(t){return t._markDefs&&t._markDefs()})),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(e){var o={scene:e[0][n.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:n.asset,parser:i,userData:{}};N(r,o,n),j(o,n),t(o)})).catch(e)},V.prototype._markDefs=function(){for(var t=this.json.nodes||[],e=this.json.skins||[],i=this.json.meshes||[],n=0,r=e.length;n<r;n++)for(var o=e[n].joints,a=0,s=o.length;a<s;a++)t[o[a]].isBone=!0;for(var l=0,c=t.length;l<c;l++){var h=t[l];void 0!==h.mesh&&(this._addNodeRef(this.meshCache,h.mesh),void 0!==h.skin&&(i[h.mesh].isSkinnedMesh=!0)),void 0!==h.camera&&this._addNodeRef(this.cameraCache,h.camera)}},V.prototype._addNodeRef=function(t,e){void 0!==e&&(void 0===t.refs[e]&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)},V.prototype._getNodeRef=function(t,e,i){if(t.refs[e]<=1)return i;var n=i.clone();return n.name+="_instance_"+t.uses[e]++,n},V.prototype._invokeOne=function(t){var e=Object.values(this.plugins);e.push(this);for(var i=0;i<e.length;i++){var n=t(e[i]);if(n)return n}},V.prototype._invokeAll=function(t){var e=Object.values(this.plugins);e.unshift(this);for(var i=[],n=0;n<e.length;n++){var r=t(e[n]);r&&i.push(r)}return i},V.prototype.getDependency=function(t,e){var i=t+":"+e,n=this.cache.get(i);if(!n){switch(t){case"scene":n=this.loadScene(e);break;case"node":n=this.loadNode(e);break;case"mesh":n=this._invokeOne((function(t){return t.loadMesh&&t.loadMesh(e)}));break;case"accessor":n=this.loadAccessor(e);break;case"bufferView":n=this._invokeOne((function(t){return t.loadBufferView&&t.loadBufferView(e)}));break;case"buffer":n=this.loadBuffer(e);break;case"material":n=this._invokeOne((function(t){return t.loadMaterial&&t.loadMaterial(e)}));break;case"texture":n=this._invokeOne((function(t){return t.loadTexture&&t.loadTexture(e)}));break;case"skin":n=this.loadSkin(e);break;case"animation":n=this.loadAnimation(e);break;case"camera":n=this.loadCamera(e);break;default:throw new Error("Unknown type: "+t)}this.cache.add(i,n)}return n},V.prototype.getDependencies=function(t){var e=this.cache.get(t);if(!e){var i=this,n=this.json[t+("mesh"===t?"es":"s")]||[];e=Promise.all(n.map((function(e,n){return i.getDependency(t,n)}))),this.cache.add(t,e)}return e},V.prototype.loadBuffer=function(t){var e=this.json.buffers[t],n=this.fileLoader;if(e.type&&"arraybuffer"!==e.type)throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(void 0===e.uri&&0===t)return Promise.resolve(this.extensions[i.KHR_BINARY_GLTF].body);var r=this.options;return new Promise((function(t,i){n.load(F(e.uri,r.path),t,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))}))}))},V.prototype.loadBufferView=function(t){var e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then((function(t){var i=e.byteLength||0,n=e.byteOffset||0;return t.slice(n,n+i)}))},V.prototype.loadAccessor=function(t){var e=this,i=this.json,n=this.json.accessors[t];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var r=[];return void 0!==n.bufferView?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),void 0!==n.sparse&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then((function(t){var r,o,a=t[0],s=I[n.type],l=A[n.componentType],c=l.BYTES_PER_ELEMENT,h=c*s,u=n.byteOffset||0,d=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,p=!0===n.normalized;if(d&&d!==h){var f=Math.floor(u/d),m="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+f+":"+n.count,g=e.cache.get(m);g||(r=new l(a,f*d,n.count*d/c),g=new Re.InterleavedBuffer(r,d/c),e.cache.add(m,g)),o=new Re.InterleavedBufferAttribute(g,s,u%d/c,p)}else r=null===a?new l(n.count*s):new l(a,u,n.count*s),o=new Re.BufferAttribute(r,s,p);if(void 0!==n.sparse){var y=I.SCALAR,_=A[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,x=n.sparse.values.byteOffset||0,b=new _(t[1],v,n.sparse.count*y),w=new l(t[2],x,n.sparse.count*s);null!==a&&(o=new Re.BufferAttribute(o.array.slice(),o.itemSize,o.normalized));for(var M=0,T=b.length;M<T;M++){var S=b[M];if(o.setX(S,w[M*s]),s>=2&&o.setY(S,w[M*s+1]),s>=3&&o.setZ(S,w[M*s+2]),s>=4&&o.setW(S,w[M*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return o}))},V.prototype.loadTexture=function(t){var e,n,r=this.json,o=this.options,a=r.textures[t],s=a.extensions||{};return(e=s[i.MSFT_TEXTURE_DDS]?r.images[s[i.MSFT_TEXTURE_DDS].source]:r.images[a.source]).uri&&(n=o.manager.getHandler(e.uri)),n||(n=s[i.MSFT_TEXTURE_DDS]?this.extensions[i.MSFT_TEXTURE_DDS].ddsLoader:this.textureLoader),this.loadTextureImage(t,e,n)},V.prototype.loadTextureImage=function(t,e,i){var n=this,r=this.json,o=this.options,a=r.textures[t],s=self.URL||self.webkitURL,l=e.uri,c=!1,h=!0;return"image/jpeg"===e.mimeType&&(h=!1),void 0!==e.bufferView&&(l=n.getDependency("bufferView",e.bufferView).then((function(t){if("image/png"===e.mimeType){var i=new DataView(t,25,1).getUint8(0,!1);h=6===i||4===i||3===i}c=!0;var n=new Blob([t],{type:e.mimeType});return l=s.createObjectURL(n)}))),Promise.resolve(l).then((function(t){return new Promise((function(e,n){var r=e;!0===i.isImageBitmapLoader&&(r=function(t){e(new Re.CanvasTexture(t))}),i.load(F(t,o.path),r,void 0,n)}))})).then((function(e){!0===c&&s.revokeObjectURL(l),e.flipY=!1,a.name&&(e.name=a.name),h||(e.format=Re.RGBFormat);var i=(r.samplers||{})[a.sampler]||{};return e.magFilter=P[i.magFilter]||Re.LinearFilter,e.minFilter=P[i.minFilter]||Re.LinearMipmapLinearFilter,e.wrapS=L[i.wrapS]||Re.RepeatWrapping,e.wrapT=L[i.wrapT]||Re.RepeatWrapping,n.associations.set(e,{type:"textures",index:t}),e}))},V.prototype.assignTexture=function(t,e,n){var r=this;return this.getDependency("texture",n.index).then((function(o){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===e&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+e+" not yet supported."),r.extensions[i.KHR_TEXTURE_TRANSFORM]){var a=void 0!==n.extensions?n.extensions[i.KHR_TEXTURE_TRANSFORM]:void 0;if(a){var s=r.associations.get(o);o=r.extensions[i.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),r.associations.set(o,s)}}t[e]=o}))},V.prototype.assignFinalMaterial=function(t){var e=t.geometry,i=t.material,n=void 0!==e.attributes.tangent,r=void 0!==e.attributes.color,o=void 0===e.attributes.normal,a=!0===t.isSkinnedMesh,s=Object.keys(e.morphAttributes).length>0,l=s&&void 0!==e.morphAttributes.normal;if(t.isPoints){var c="PointsMaterial:"+i.uuid,h=this.cache.get(c);h||(h=new Re.PointsMaterial,Re.Material.prototype.copy.call(h,i),h.color.copy(i.color),h.map=i.map,h.sizeAttenuation=!1,this.cache.add(c,h)),i=h}else if(t.isLine){c="LineBasicMaterial:"+i.uuid;var u=this.cache.get(c);u||(u=new Re.LineBasicMaterial,Re.Material.prototype.copy.call(u,i),u.color.copy(i.color),this.cache.add(c,u)),i=u}if(n||r||o||a||s){c="ClonedMaterial:"+i.uuid+":";i.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),a&&(c+="skinning:"),n&&(c+="vertex-tangents:"),r&&(c+="vertex-colors:"),o&&(c+="flat-shading:"),s&&(c+="morph-targets:"),l&&(c+="morph-normals:");var d=this.cache.get(c);d||(d=i.clone(),a&&(d.skinning=!0),r&&(d.vertexColors=!0),o&&(d.flatShading=!0),s&&(d.morphTargets=!0),l&&(d.morphNormals=!0),n&&(d.vertexTangents=!0,d.normalScale&&(d.normalScale.y*=-1),d.clearcoatNormalScale&&(d.clearcoatNormalScale.y*=-1)),this.cache.add(c,d),this.associations.set(d,this.associations.get(i))),i=d}i.aoMap&&void 0===e.attributes.uv2&&void 0!==e.attributes.uv&&e.setAttribute("uv2",e.attributes.uv),t.material=i},V.prototype.getMaterialType=function(){return Re.MeshStandardMaterial},V.prototype.loadMaterial=function(t){var e,n=this,r=this.json,o=this.extensions,a=r.materials[t],s={},l=a.extensions||{},c=[];if(l[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=o[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];e=h.getMaterialType(),c.push(h.extendParams(s,a,n))}else if(l[i.KHR_MATERIALS_UNLIT]){var u=o[i.KHR_MATERIALS_UNLIT];e=u.getMaterialType(),c.push(u.extendParams(s,a,n))}else{var d=a.pbrMetallicRoughness||{};if(s.color=new Re.Color(1,1,1),s.opacity=1,Array.isArray(d.baseColorFactor)){var p=d.baseColorFactor;s.color.fromArray(p),s.opacity=p[3]}void 0!==d.baseColorTexture&&c.push(n.assignTexture(s,"map",d.baseColorTexture)),s.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,s.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(c.push(n.assignTexture(s,"metalnessMap",d.metallicRoughnessTexture)),c.push(n.assignTexture(s,"roughnessMap",d.metallicRoughnessTexture))),e=this._invokeOne((function(e){return e.getMaterialType&&e.getMaterialType(t)})),c.push(Promise.all(this._invokeAll((function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,s)}))))}!0===a.doubleSided&&(s.side=Re.DoubleSide);var f=a.alphaMode||O;return f===B?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,f===z&&(s.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&e!==Re.MeshBasicMaterial&&(c.push(n.assignTexture(s,"normalMap",a.normalTexture)),s.normalScale=new Re.Vector2(1,-1),void 0!==a.normalTexture.scale&&s.normalScale.set(a.normalTexture.scale,-a.normalTexture.scale)),void 0!==a.occlusionTexture&&e!==Re.MeshBasicMaterial&&(c.push(n.assignTexture(s,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(s.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&e!==Re.MeshBasicMaterial&&(s.emissive=(new Re.Color).fromArray(a.emissiveFactor)),void 0!==a.emissiveTexture&&e!==Re.MeshBasicMaterial&&c.push(n.assignTexture(s,"emissiveMap",a.emissiveTexture)),Promise.all(c).then((function(){var r;return r=e===y?o[i.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(s):new e(s),a.name&&(r.name=a.name),r.map&&(r.map.encoding=Re.sRGBEncoding),r.emissiveMap&&(r.emissiveMap.encoding=Re.sRGBEncoding),j(r,a),n.associations.set(r,{type:"materials",index:t}),a.extensions&&N(o,r,a),r}))},V.prototype.createUniqueName=function(t){for(var e=Re.PropertyBinding.sanitizeNodeName(t||""),i=e,n=1;this.nodeNamesUsed[i];++n)i=e+"_"+n;return this.nodeNamesUsed[i]=!0,i},V.prototype.loadGeometries=function(t){var e=this,n=this.extensions,r=this.primitiveCache;function o(t){return n[i.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,e).then((function(i){return H(i,t,e)}))}for(var a,s,l=[],c=0,h=t.length;c<h;c++){var u,d=t[c],p=(s=void 0,(s=(a=d).extensions&&a.extensions[i.KHR_DRACO_MESH_COMPRESSION])?"draco:"+s.bufferView+":"+s.indices+":"+U(s.attributes):a.indices+":"+U(a.attributes)+":"+a.mode),f=r[p];if(f)l.push(f.promise);else u=d.extensions&&d.extensions[i.KHR_DRACO_MESH_COMPRESSION]?o(d):H(new Re.BufferGeometry,d,e),r[p]={primitive:d,promise:u},l.push(u)}return Promise.all(l)},V.prototype.loadMesh=function(t){for(var e,i=this,n=this.json,r=this.extensions,o=n.meshes[t],a=o.primitives,s=[],l=0,c=a.length;l<c;l++){var h=void 0===a[l].material?(void 0===(e=this.cache).DefaultMaterial&&(e.DefaultMaterial=new Re.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Re.FrontSide})),e.DefaultMaterial):this.getDependency("material",a[l].material);s.push(h)}return s.push(i.loadGeometries(a)),Promise.all(s).then((function(e){for(var n=e.slice(0,e.length-1),s=e[e.length-1],l=[],c=0,h=s.length;c<h;c++){var u,d=s[c],p=a[c],f=n[c];if(p.mode===S||p.mode===E||p.mode===C||void 0===p.mode)u=!0===o.isSkinnedMesh?new Re.SkinnedMesh(d,f):new Re.Mesh(d,f),!0===f.isMeshStandardMaterial&&f.side===Re.DoubleSide&&null!==d.getIndex()&&!0===d.hasAttribute("position")&&!0===d.hasAttribute("normal")&&!0===d.hasAttribute("uv")&&!1===d.hasAttribute("tangent")&&(d.computeTangents(),f.vertexTangents=!0),!0!==u.isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),p.mode===E?u.geometry=Z(u.geometry,Re.TriangleStripDrawMode):p.mode===C&&(u.geometry=Z(u.geometry,Re.TriangleFanDrawMode));else if(p.mode===w)u=new Re.LineSegments(d,f);else if(p.mode===T)u=new Re.Line(d,f);else if(p.mode===M)u=new Re.LineLoop(d,f);else{if(p.mode!==b)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);u=new Re.Points(d,f)}Object.keys(u.geometry.morphAttributes).length>0&&G(u,o),u.name=i.createUniqueName(o.name||"mesh_"+t),j(u,o),p.extensions&&N(r,u,p),i.assignFinalMaterial(u),l.push(u)}if(1===l.length)return l[0];var m=new Re.Group;for(c=0,h=l.length;c<h;c++)m.add(l[c]);return m}))},V.prototype.loadCamera=function(t){var e,i=this.json.cameras[t],n=i[i.type];if(n)return"perspective"===i.type?e=new Re.PerspectiveCamera(Re.MathUtils.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(e=new Re.OrthographicCamera(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(e.name=this.createUniqueName(i.name)),j(e,i),Promise.resolve(e);console.warn("THREE.GLTFLoader: Missing camera parameters.")},V.prototype.loadSkin=function(t){var e=this.json.skins[t],i={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",e.inverseBindMatrices).then((function(t){return i.inverseBindMatrices=t,i}))},V.prototype.loadAnimation=function(t){for(var e=this.json.animations[t],i=[],n=[],r=[],o=[],a=[],s=0,l=e.channels.length;s<l;s++){var c=e.channels[s],h=e.samplers[c.sampler],u=c.target,d=void 0!==u.node?u.node:u.id,p=void 0!==e.parameters?e.parameters[h.input]:h.input,f=void 0!==e.parameters?e.parameters[h.output]:h.output;i.push(this.getDependency("node",d)),n.push(this.getDependency("accessor",p)),r.push(this.getDependency("accessor",f)),o.push(h),a.push(u)}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(r),Promise.all(o),Promise.all(a)]).then((function(i){for(var n=i[0],r=i[1],o=i[2],a=i[3],s=i[4],l=[],c=0,h=n.length;c<h;c++){var u=n[c],d=r[c],p=o[c],f=a[c],m=s[c];if(void 0!==u){var g;switch(u.updateMatrix(),u.matrixAutoUpdate=!0,D[m.path]){case D.weights:g=Re.NumberKeyframeTrack;break;case D.rotation:g=Re.QuaternionKeyframeTrack;break;case D.position:case D.scale:default:g=Re.VectorKeyframeTrack}var y=u.name?u.name:u.uuid,_=void 0!==f.interpolation?k[f.interpolation]:Re.InterpolateLinear,v=[];D[m.path]===D.weights?u.traverse((function(t){!0===t.isMesh&&t.morphTargetInfluences&&v.push(t.name?t.name:t.uuid)})):v.push(y);var b=p.array;if(p.normalized){var w;if(b.constructor===Int8Array)w=1/127;else if(b.constructor===Uint8Array)w=1/255;else if(b.constructor==Int16Array)w=1/32767;else{if(b.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");w=1/65535}for(var M=new Float32Array(b.length),T=0,S=b.length;T<S;T++)M[T]=b[T]*w;b=M}for(T=0,S=v.length;T<S;T++){var E=new g(v[T]+"."+D[m.path],d.array,b,_);"CUBICSPLINE"===f.interpolation&&(E.createInterpolant=function(t){return new x(this.times,this.values,this.getValueSize()/3,t)},E.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(E)}}}var C=e.name?e.name:"animation_"+t;return new Re.AnimationClip(C,void 0,l)}))},V.prototype.loadNode=function(t){var e,i=this.json,n=this.extensions,r=this,o=i.nodes[t],a=o.name?r.createUniqueName(o.name):"";return(e=[],void 0!==o.mesh&&e.push(r.getDependency("mesh",o.mesh).then((function(t){var e=r._getNodeRef(r.meshCache,o.mesh,t);return void 0!==o.weights&&e.traverse((function(t){if(t.isMesh)for(var e=0,i=o.weights.length;e<i;e++)t.morphTargetInfluences[e]=o.weights[e]})),e}))),void 0!==o.camera&&e.push(r.getDependency("camera",o.camera).then((function(t){return r._getNodeRef(r.cameraCache,o.camera,t)}))),r._invokeAll((function(e){return e.createNodeAttachment&&e.createNodeAttachment(t)})).forEach((function(t){e.push(t)})),Promise.all(e)).then((function(e){var i;if((i=!0===o.isBone?new Re.Bone:e.length>1?new Re.Group:1===e.length?e[0]:new Re.Object3D)!==e[0])for(var s=0,l=e.length;s<l;s++)i.add(e[s]);if(o.name&&(i.userData.name=o.name,i.name=a),j(i,o),o.extensions&&N(n,i,o),void 0!==o.matrix){var c=new Re.Matrix4;c.fromArray(o.matrix),i.applyMatrix4(c)}else void 0!==o.translation&&i.position.fromArray(o.translation),void 0!==o.rotation&&i.quaternion.fromArray(o.rotation),void 0!==o.scale&&i.scale.fromArray(o.scale);return r.associations.set(i,{type:"nodes",index:t}),i}))},V.prototype.loadScene=function(){function t(e,i,n,r){var o=n.nodes[e];return r.getDependency("node",e).then((function(t){return void 0===o.skin?t:r.getDependency("skin",o.skin).then((function(t){for(var i=[],n=0,o=(e=t).joints.length;n<o;n++)i.push(r.getDependency("node",e.joints[n]));return Promise.all(i)})).then((function(i){return t.traverse((function(t){if(t.isMesh){for(var n=[],r=[],o=0,a=i.length;o<a;o++){var s=i[o];if(s){n.push(s);var l=new Re.Matrix4;void 0!==e.inverseBindMatrices&&l.fromArray(e.inverseBindMatrices.array,16*o),r.push(l)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[o])}t.bind(new Re.Skeleton(n,r),t.matrixWorld)}})),t}));var e})).then((function(e){i.add(e);var a=[];if(o.children)for(var s=o.children,l=0,c=s.length;l<c;l++){var h=s[l];a.push(t(h,e,n,r))}return Promise.all(a)}))}return function(e){var i=this.json,n=this.extensions,r=this.json.scenes[e],o=new Re.Group;r.name&&(o.name=this.createUniqueName(r.name)),j(o,r),r.extensions&&N(n,o,r);for(var a=r.nodes||[],s=[],l=0,c=a.length;l<c;l++)s.push(t(a[l],o,i,this));return Promise.all(s).then((function(){return o}))}}(),t}(),_a=function(t){Re.Loader.call(this,t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};_a.prototype=Object.assign(Object.create(Re.Loader.prototype),{constructor:_a,setDecoderPath:function(t){return this.decoderPath=t,this},setDecoderConfig:function(t){return this.decoderConfig=t,this},setWorkerLimit:function(t){return this.workerLimit=t,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(t,e,i,n){var r=new Re.FileLoader(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(t,t=>{var i={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(t,i).then(e).catch(n)},i,n)},decodeDracoFile:function(t,e,i,n){var r={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(t,r).then(e)},decodeGeometry:function(t,e){for(var i in e.attributeTypes){var n=e.attributeTypes[i];void 0!==n.BYTES_PER_ELEMENT&&(e.attributeTypes[i]=n.name)}var r,o=JSON.stringify(e);if(_a.taskCache.has(t)){var a=_a.taskCache.get(t);if(a.key===o)return a.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var s=this.workerNextTaskID++,l=t.byteLength,c=this._getWorker(s,l).then(i=>(r=i,new Promise((i,n)=>{r._callbacks[s]={resolve:i,reject:n},r.postMessage({type:"decode",id:s,taskConfig:e,buffer:t},[t])}))).then(t=>this._createGeometry(t.geometry));return c.catch(()=>!0).then(()=>{r&&s&&this._releaseTask(r,s)}),_a.taskCache.set(t,{key:o,promise:c}),c},_createGeometry:function(t){var e=new Re.BufferGeometry;t.index&&e.setIndex(new Re.BufferAttribute(t.index.array,1));for(var i=0;i<t.attributes.length;i++){var n=t.attributes[i],r=n.name,o=n.array,a=n.itemSize;e.setAttribute(r,new Re.BufferAttribute(o,a))}return e},_loadLibrary:function(t,e){var i=new Re.FileLoader(this.manager);return i.setPath(this.decoderPath),i.setResponseType(e),i.setWithCredentials(this.withCredentials),new Promise((e,n)=>{i.load(t,e,void 0,n)})},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;var t="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,e=[];return t?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then(e=>{var i=e[0];t||(this.decoderConfig.wasmBinary=e[1]);var n=_a.DRACOWorker.toString(),r=["/* draco decoder */",i,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([r]))}),this.decoderPending},_getWorker:function(t,e){return this._initDecoder().then(()=>{var i;this.workerPool.length<this.workerLimit?((i=new Worker(this.workerSourceURL))._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(t){var e=t.data;switch(e.type){case"decode":i._callbacks[e.id].resolve(e);break;case"error":i._callbacks[e.id].reject(e);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+e.type+'"')}},this.workerPool.push(i)):this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));return(i=this.workerPool[this.workerPool.length-1])._taskCosts[t]=e,i._taskLoad+=e,i})},_releaseTask:function(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]},debug:function(){console.log("Task load: ",this.workerPool.map(t=>t._taskLoad))},dispose:function(){for(var t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,this}}),_a.DRACOWorker=function(){var t,e;function i(t,e,i,n,r,o){var a=o.num_components(),s=i.num_points()*a,l=s*r.BYTES_PER_ELEMENT,c=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,r),h=t._malloc(l);e.GetAttributeDataArrayForAllPoints(i,o,c,l,h);var u=new r(t.HEAPF32.buffer,h,s).slice();return t._free(h),{name:n,array:u,itemSize:a}}onmessage=function(n){var r=n.data;switch(r.type){case"init":t=r.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":var o=r.buffer,a=r.taskConfig;e.then(t=>{var e=t.draco,n=new e.Decoder,s=new e.DecoderBuffer;s.Init(new Int8Array(o),o.byteLength);try{var l=function(t,e,n,r){var o,a,s=r.attributeIDs,l=r.attributeTypes,c=e.GetEncodedGeometryType(n);if(c===t.TRIANGULAR_MESH)o=new t.Mesh,a=e.DecodeBufferToMesh(n,o);else{if(c!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new t.PointCloud,a=e.DecodeBufferToPointCloud(n,o)}if(!a.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+a.error_msg());var h={index:null,attributes:[]};for(var u in s){var d,p,f=self[l[u]];if(r.useUniqueIDs)p=s[u],d=e.GetAttributeByUniqueId(o,p);else{if(-1===(p=e.GetAttributeId(o,t[s[u]])))continue;d=e.GetAttribute(o,p)}h.attributes.push(i(t,e,o,u,f,d))}c===t.TRIANGULAR_MESH&&(h.index=function(t,e,i){var n=3*i.num_faces(),r=4*n,o=t._malloc(r);e.GetTrianglesUInt32Array(i,r,o);var a=new Uint32Array(t.HEAPF32.buffer,o,n).slice();return t._free(o),{array:a,itemSize:1}}(t,e,o));return t.destroy(o),h}(e,n,s,a),c=l.attributes.map(t=>t.array.buffer);l.index&&c.push(l.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:l},c)}catch(t){console.error(t),self.postMessage({type:"error",id:r.id,error:t.message})}finally{e.destroy(s),e.destroy(n)}})}}},_a.taskCache=new WeakMap,_a.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},_a.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},_a.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},_a.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};var va=function(t,e){void 0===e&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),e=document),Re.Object3D.call(this),this.visible=!1,this.domElement=e;var i=new xa;this.add(i);var n=new ba;this.add(n);var r=this;N("camera",t),N("object",void 0),N("enabled",!0),N("axis",null),N("mode","translate"),N("translationSnap",null),N("rotationSnap",null),N("scaleSnap",null),N("space","world"),N("size",1),N("dragging",!1),N("showX",!0),N("showY",!0),N("showZ",!0);var o={type:"change"},a={type:"mouseDown"},s={type:"mouseUp",mode:r.mode},l={type:"objectChange"},c=new Re.Raycaster,h=new Re.Vector3,u=new Re.Vector3,d=new Re.Quaternion,p={X:new Re.Vector3(1,0,0),Y:new Re.Vector3(0,1,0),Z:new Re.Vector3(0,0,1)},f=new Re.Vector3,m=new Re.Vector3,g=new Re.Vector3,y=new Re.Vector3,_=new Re.Vector3,v=new Re.Vector3,x=0,b=new Re.Vector3,w=new Re.Quaternion,M=new Re.Vector3,T=new Re.Vector3,S=new Re.Quaternion,E=new Re.Quaternion,C=new Re.Vector3,A=new Re.Vector3,P=new Re.Quaternion,L=new Re.Vector3,I=new Re.Vector3,R=new Re.Quaternion,D=new Re.Quaternion,k=new Re.Vector3,O=new Re.Vector3,z=new Re.Vector3,B=new Re.Quaternion,F=new Re.Vector3;function N(t,e){var a=e;Object.defineProperty(r,t,{get:function(){return void 0!==a?a:e},set:function(e){a!==e&&(a=e,n[t]=e,i[t]=e,r.dispatchEvent({type:t+"-changed",value:e}),r.dispatchEvent(o))}}),r[t]=e,n[t]=e,i[t]=e}function j(t){if(document.pointerLockElement)return{x:0,y:0,button:t.button};var i=t.changedTouches?t.changedTouches[0]:t,n=e.getBoundingClientRect();return{x:(i.clientX-n.left)/n.width*2-1,y:-(i.clientY-n.top)/n.height*2+1,button:t.button}}function G(t){r.enabled&&r.pointerHover(j(t))}function U(t){r.enabled&&(document.addEventListener("mousemove",V,!1),r.pointerHover(j(t)),r.pointerDown(j(t)))}function V(t){r.enabled&&r.pointerMove(j(t))}function H(t){r.enabled&&(document.removeEventListener("mousemove",V,!1),r.pointerUp(j(t)))}N("worldPosition",I),N("worldPositionStart",A),N("worldQuaternion",R),N("worldQuaternionStart",P),N("cameraPosition",b),N("cameraQuaternion",w),N("pointStart",f),N("pointEnd",m),N("rotationAxis",y),N("rotationAngle",x),N("eye",O),e.addEventListener("mousedown",U,!1),e.addEventListener("touchstart",U,!1),e.addEventListener("mousemove",G,!1),e.addEventListener("touchmove",G,!1),e.addEventListener("touchmove",V,!1),document.addEventListener("mouseup",H,!1),e.addEventListener("touchend",H,!1),e.addEventListener("touchcancel",H,!1),e.addEventListener("touchleave",H,!1),this.dispose=function(){e.removeEventListener("mousedown",U),e.removeEventListener("touchstart",U),e.removeEventListener("mousemove",G),document.removeEventListener("mousemove",V),e.removeEventListener("touchmove",G),e.removeEventListener("touchmove",V),document.removeEventListener("mouseup",H),e.removeEventListener("touchend",H),e.removeEventListener("touchcancel",H),e.removeEventListener("touchleave",H),this.traverse((function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}))},this.attach=function(t){return this.object=t,this.visible=!0,this},this.detach=function(){return this.object=void 0,this.visible=!1,this.axis=null,this},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),null===this.object.parent?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(T,S,C),this.object.matrixWorld.decompose(I,R,k),E.copy(S).invert(),D.copy(R).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(b,w,M),O.copy(b).sub(I).normalize(),Re.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(t){if(void 0!==this.object&&!0!==this.dragging&&(void 0===t.button||0===t.button)){c.setFromCamera(t,this.camera);var e=c.intersectObjects(i.picker[this.mode].children,!0)[0]||!1;this.axis=e?e.object.name:null}},this.pointerDown=function(t){if(!(void 0===this.object||!0===this.dragging||void 0!==t.button&&0!==t.button||0!==t.button&&void 0!==t.button||null===this.axis)){c.setFromCamera(t,this.camera);var e=c.intersectObjects([n],!0)[0]||!1;if(e){var i=this.space;if("scale"===this.mode?i="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(i="world"),"local"===i&&"rotate"===this.mode){var r=this.rotationSnap;"X"===this.axis&&r&&(this.object.rotation.x=Math.round(this.object.rotation.x/r)*r),"Y"===this.axis&&r&&(this.object.rotation.y=Math.round(this.object.rotation.y/r)*r),"Z"===this.axis&&r&&(this.object.rotation.z=Math.round(this.object.rotation.z/r)*r)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),z.copy(this.object.position),B.copy(this.object.quaternion),F.copy(this.object.scale),this.object.matrixWorld.decompose(A,P,L),f.copy(e.point).sub(A)}this.dragging=!0,a.mode=this.mode,this.dispatchEvent(a)}},this.pointerMove=function(t){var e=this.axis,i=this.mode,r=this.object,a=this.space;if("scale"===i?a="local":"E"!==e&&"XYZE"!==e&&"XYZ"!==e||(a="world"),void 0!==r&&null!==e&&!1!==this.dragging&&(void 0===t.button||0===t.button)){c.setFromCamera(t,this.camera);var s=c.intersectObjects([n],!0)[0]||!1;if(!1!==s){if(m.copy(s.point).sub(A),"translate"===i)g.copy(m).sub(f),"local"===a&&"XYZ"!==e&&g.applyQuaternion(D),-1===e.indexOf("X")&&(g.x=0),-1===e.indexOf("Y")&&(g.y=0),-1===e.indexOf("Z")&&(g.z=0),"local"===a&&"XYZ"!==e?g.applyQuaternion(B).divide(C):g.applyQuaternion(E).divide(C),r.position.copy(g).add(z),this.translationSnap&&("local"===a&&(r.position.applyQuaternion(d.copy(B).invert()),-1!==e.search("X")&&(r.position.x=Math.round(r.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(r.position.y=Math.round(r.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(r.position.z=Math.round(r.position.z/this.translationSnap)*this.translationSnap),r.position.applyQuaternion(B)),"world"===a&&(r.parent&&r.position.add(h.setFromMatrixPosition(r.parent.matrixWorld)),-1!==e.search("X")&&(r.position.x=Math.round(r.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(r.position.y=Math.round(r.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(r.position.z=Math.round(r.position.z/this.translationSnap)*this.translationSnap),r.parent&&r.position.sub(h.setFromMatrixPosition(r.parent.matrixWorld))));else if("scale"===i){if(-1!==e.search("XYZ")){var b=m.length()/f.length();m.dot(f)<0&&(b*=-1),u.set(b,b,b)}else h.copy(f),u.copy(m),h.applyQuaternion(D),u.applyQuaternion(D),u.divide(h),-1===e.search("X")&&(u.x=1),-1===e.search("Y")&&(u.y=1),-1===e.search("Z")&&(u.z=1);r.scale.copy(F).multiply(u),this.scaleSnap&&(-1!==e.search("X")&&(r.scale.x=Math.round(r.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Y")&&(r.scale.y=Math.round(r.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Z")&&(r.scale.z=Math.round(r.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===i){g.copy(m).sub(f);var w=20/I.distanceTo(h.setFromMatrixPosition(this.camera.matrixWorld));"E"===e?(y.copy(O),x=m.angleTo(f),_.copy(f).normalize(),v.copy(m).normalize(),x*=v.cross(_).dot(O)<0?1:-1):"XYZE"===e?(y.copy(g).cross(O).normalize(),x=g.dot(h.copy(y).cross(this.eye))*w):"X"!==e&&"Y"!==e&&"Z"!==e||(y.copy(p[e]),h.copy(p[e]),"local"===a&&h.applyQuaternion(R),x=g.dot(h.cross(O).normalize())*w),this.rotationSnap&&(x=Math.round(x/this.rotationSnap)*this.rotationSnap),this.rotationAngle=x,"local"===a&&"E"!==e&&"XYZE"!==e?(r.quaternion.copy(B),r.quaternion.multiply(d.setFromAxisAngle(y,x)).normalize()):(y.applyQuaternion(E),r.quaternion.copy(d.setFromAxisAngle(y,x)),r.quaternion.multiply(B).normalize())}this.dispatchEvent(o),this.dispatchEvent(l)}}},this.pointerUp=function(t){void 0!==t.button&&0!==t.button||(this.dragging&&null!==this.axis&&(s.mode=this.mode,this.dispatchEvent(s)),this.dragging=!1,void 0===t.button&&(this.axis=null))},this.getMode=function(){return r.mode},this.setMode=function(t){r.mode=t},this.setTranslationSnap=function(t){r.translationSnap=t},this.setRotationSnap=function(t){r.rotationSnap=t},this.setScaleSnap=function(t){r.scaleSnap=t},this.setSize=function(t){r.size=t},this.setSpace=function(t){r.space=t},this.update=function(){console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}};va.prototype=Object.assign(Object.create(Re.Object3D.prototype),{constructor:va,isTransformControls:!0});var xa=function(){Re.Object3D.call(this),this.type="TransformControlsGizmo";var t=new Re.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:Re.DoubleSide,fog:!1}),e=new Re.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),i=t.clone();i.opacity=.15;var n=t.clone();n.opacity=.33;var r=t.clone();r.color.set(16711680);var o=t.clone();o.color.set(65280);var a=t.clone();a.color.set(255);var s=t.clone();s.opacity=.25;var l=s.clone();l.color.set(16776960);var c=s.clone();c.color.set(65535);var h=s.clone();h.color.set(16711935),t.clone().color.set(16776960);var u=e.clone();u.color.set(16711680);var d=e.clone();d.color.set(65280);var p=e.clone();p.color.set(255);var f=e.clone();f.color.set(65535);var m=e.clone();m.color.set(16711935);var g=e.clone();g.color.set(16776960);var y=e.clone();y.color.set(7895160);var _=g.clone();_.opacity=.25;var v=new Re.CylinderBufferGeometry(0,.05,.2,12,1,!1),x=new Re.BoxBufferGeometry(.125,.125,.125),b=new Re.BufferGeometry;b.setAttribute("position",new Re.Float32BufferAttribute([0,0,0,1,0,0],3));var w=function(t,e){for(var i=new Re.BufferGeometry,n=[],r=0;r<=64*e;++r)n.push(0,Math.cos(r/32*Math.PI)*t,Math.sin(r/32*Math.PI)*t);return i.setAttribute("position",new Re.Float32BufferAttribute(n,3)),i},M={X:[[new Re.Mesh(v,r),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new Re.Mesh(v,r),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new Re.Line(b,u)]],Y:[[new Re.Mesh(v,o),[0,1,0],null,null,"fwd"],[new Re.Mesh(v,o),[0,1,0],[Math.PI,0,0],null,"bwd"],[new Re.Line(b,d),null,[0,0,Math.PI/2]]],Z:[[new Re.Mesh(v,a),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new Re.Mesh(v,a),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new Re.Line(b,p),null,[0,-Math.PI/2,0]]],XYZ:[[new Re.Mesh(new Re.OctahedronBufferGeometry(.1,0),s.clone()),[0,0,0],[0,0,0]]],XY:[[new Re.Mesh(new Re.PlaneBufferGeometry(.295,.295),l.clone()),[.15,.15,0]],[new Re.Line(b,g),[.18,.3,0],null,[.125,1,1]],[new Re.Line(b,g),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Re.Mesh(new Re.PlaneBufferGeometry(.295,.295),c.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new Re.Line(b,f),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new Re.Line(b,f),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Re.Mesh(new Re.PlaneBufferGeometry(.295,.295),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new Re.Line(b,m),[.18,0,.3],null,[.125,1,1]],[new Re.Line(b,m),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},T={X:[[new Re.Mesh(new Re.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new Re.Mesh(new Re.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new Re.Mesh(new Re.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new Re.Mesh(new Re.OctahedronBufferGeometry(.2,0),i)]],XY:[[new Re.Mesh(new Re.PlaneBufferGeometry(.4,.4),i),[.2,.2,0]]],YZ:[[new Re.Mesh(new Re.PlaneBufferGeometry(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new Re.Mesh(new Re.PlaneBufferGeometry(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},S={START:[[new Re.Mesh(new Re.OctahedronBufferGeometry(.01,2),n),null,null,null,"helper"]],END:[[new Re.Mesh(new Re.OctahedronBufferGeometry(.01,2),n),null,null,null,"helper"]],DELTA:[[new Re.Line(function(){var t=new Re.BufferGeometry;return t.setAttribute("position",new Re.Float32BufferAttribute([0,0,0,1,1,1],3)),t}(),n),null,null,null,"helper"]],X:[[new Re.Line(b,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Re.Line(b,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Re.Line(b,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},E={X:[[new Re.Line(w(1,.5),u)],[new Re.Mesh(new Re.OctahedronBufferGeometry(.04,0),r),[0,0,.99],null,[1,3,1]]],Y:[[new Re.Line(w(1,.5),d),null,[0,0,-Math.PI/2]],[new Re.Mesh(new Re.OctahedronBufferGeometry(.04,0),o),[0,0,.99],null,[3,1,1]]],Z:[[new Re.Line(w(1,.5),p),null,[0,Math.PI/2,0]],[new Re.Mesh(new Re.OctahedronBufferGeometry(.04,0),a),[.99,0,0],null,[1,3,1]]],E:[[new Re.Line(w(1.25,1),_),null,[0,Math.PI/2,0]],[new Re.Mesh(new Re.CylinderBufferGeometry(.03,0,.15,4,1,!1),_),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new Re.Mesh(new Re.CylinderBufferGeometry(.03,0,.15,4,1,!1),_),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new Re.Mesh(new Re.CylinderBufferGeometry(.03,0,.15,4,1,!1),_),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new Re.Mesh(new Re.CylinderBufferGeometry(.03,0,.15,4,1,!1),_),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new Re.Line(w(1,1),y),null,[0,Math.PI/2,0]]]},C={AXIS:[[new Re.Line(b,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},A={X:[[new Re.Mesh(new Re.TorusBufferGeometry(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new Re.Mesh(new Re.TorusBufferGeometry(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new Re.Mesh(new Re.TorusBufferGeometry(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new Re.Mesh(new Re.TorusBufferGeometry(1.25,.1,2,24),i)]],XYZE:[[new Re.Mesh(new Re.SphereBufferGeometry(.7,10,8),i)]]},P={XYZX:[[new Re.Mesh(new Re.BoxBufferGeometry(.125,.125,.125),s.clone()),[1.1,0,0]]],XYZY:[[new Re.Mesh(new Re.BoxBufferGeometry(.125,.125,.125),s.clone()),[0,1.1,0]]],XYZZ:[[new Re.Mesh(new Re.BoxBufferGeometry(.125,.125,.125),s.clone()),[0,0,1.1]]]},L={X:[[new Re.Mesh(new Re.CylinderBufferGeometry(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new Re.Mesh(new Re.CylinderBufferGeometry(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new Re.Mesh(new Re.CylinderBufferGeometry(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new Re.Mesh(x,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new Re.Mesh(x,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new Re.Mesh(x,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new Re.Mesh(new Re.BoxBufferGeometry(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new Re.Mesh(new Re.BoxBufferGeometry(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new Re.Mesh(new Re.BoxBufferGeometry(.2,.2,.2),i),[0,0,1.1]]]},I={X:[[new Re.Line(b,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Re.Line(b,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Re.Line(b,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},R=function(t){var e=new Re.Object3D;for(var i in t)for(var n=t[i].length;n--;){var r=t[i][n][0].clone(),o=t[i][n][1],a=t[i][n][2],s=t[i][n][3],l=t[i][n][4];r.name=i,r.tag=l,o&&r.position.set(o[0],o[1],o[2]),a&&r.rotation.set(a[0],a[1],a[2]),s&&r.scale.set(s[0],s[1],s[2]),r.updateMatrix();var c=r.geometry.clone();c.applyMatrix4(r.matrix),r.geometry=c,r.renderOrder=1/0,r.position.set(0,0,0),r.rotation.set(0,0,0),r.scale.set(1,1,1),e.add(r)}return e},D=new Re.Vector3(0,0,0),k=new Re.Euler,O=new Re.Vector3(0,1,0),z=new Re.Vector3(0,0,0),B=new Re.Matrix4,F=new Re.Quaternion,N=new Re.Quaternion,j=new Re.Quaternion,G=new Re.Vector3(1,0,0),U=new Re.Vector3(0,1,0),V=new Re.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=R(M)),this.add(this.gizmo.rotate=R(E)),this.add(this.gizmo.scale=R(P)),this.add(this.picker.translate=R(T)),this.add(this.picker.rotate=R(A)),this.add(this.picker.scale=R(L)),this.add(this.helper.translate=R(S)),this.add(this.helper.rotate=R(C)),this.add(this.helper.scale=R(I)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var t=this.space;"scale"===this.mode&&(t="local");var e="local"===t?this.worldQuaternion:j;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var i=[];i=(i=(i=i.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var n=0;n<i.length;n++){var r=i[n];r.visible=!0,r.rotation.set(0,0,0),r.position.copy(this.worldPosition);var o=this.worldPosition.distanceTo(this.cameraPosition);if(r.scale.set(1,1,1).multiplyScalar(o*this.size/7),"helper"!==r.tag){if(r.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){"X"!==r.name&&"XYZX"!==r.name||Math.abs(O.copy(G).applyQuaternion(e).dot(this.eye))>.99&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),"Y"!==r.name&&"XYZY"!==r.name||Math.abs(O.copy(U).applyQuaternion(e).dot(this.eye))>.99&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),"Z"!==r.name&&"XYZZ"!==r.name||Math.abs(O.copy(V).applyQuaternion(e).dot(this.eye))>.99&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),"XY"===r.name&&Math.abs(O.copy(V).applyQuaternion(e).dot(this.eye))<.2&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),"YZ"===r.name&&Math.abs(O.copy(G).applyQuaternion(e).dot(this.eye))<.2&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),"XZ"===r.name&&Math.abs(O.copy(U).applyQuaternion(e).dot(this.eye))<.2&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),-1!==r.name.search("X")&&(O.copy(G).applyQuaternion(e).dot(this.eye)<0?"fwd"===r.tag?r.visible=!1:r.scale.x*=-1:"bwd"===r.tag&&(r.visible=!1)),-1!==r.name.search("Y")&&(O.copy(U).applyQuaternion(e).dot(this.eye)<0?"fwd"===r.tag?r.visible=!1:r.scale.y*=-1:"bwd"===r.tag&&(r.visible=!1)),-1!==r.name.search("Z")&&(O.copy(V).applyQuaternion(e).dot(this.eye)<0?"fwd"===r.tag?r.visible=!1:r.scale.z*=-1:"bwd"===r.tag&&(r.visible=!1))}else"rotate"===this.mode&&(N.copy(e),O.copy(this.eye).applyQuaternion(F.copy(e).invert()),-1!==r.name.search("E")&&r.quaternion.setFromRotationMatrix(B.lookAt(this.eye,z,U)),"X"===r.name&&(F.setFromAxisAngle(G,Math.atan2(-O.y,O.z)),F.multiplyQuaternions(N,F),r.quaternion.copy(F)),"Y"===r.name&&(F.setFromAxisAngle(U,Math.atan2(O.x,O.z)),F.multiplyQuaternions(N,F),r.quaternion.copy(F)),"Z"===r.name&&(F.setFromAxisAngle(V,Math.atan2(O.y,O.x)),F.multiplyQuaternions(N,F),r.quaternion.copy(F)));r.visible=r.visible&&(-1===r.name.indexOf("X")||this.showX),r.visible=r.visible&&(-1===r.name.indexOf("Y")||this.showY),r.visible=r.visible&&(-1===r.name.indexOf("Z")||this.showZ),r.visible=r.visible&&(-1===r.name.indexOf("E")||this.showX&&this.showY&&this.showZ),r.material._opacity=r.material._opacity||r.material.opacity,r.material._color=r.material._color||r.material.color.clone(),r.material.color.copy(r.material._color),r.material.opacity=r.material._opacity,this.enabled?this.axis&&(r.name===this.axis||this.axis.split("").some((function(t){return r.name===t}))?(r.material.opacity=1,r.material.color.lerp(new Re.Color(1,1,1),.5)):(r.material.opacity*=.25,r.material.color.lerp(new Re.Color(1,1,1),.5))):(r.material.opacity*=.5,r.material.color.lerp(new Re.Color(1,1,1),.5))}else r.visible=!1,"AXIS"===r.name?(r.position.copy(this.worldPositionStart),r.visible=!!this.axis,"X"===this.axis&&(F.setFromEuler(k.set(0,0,0)),r.quaternion.copy(e).multiply(F),Math.abs(O.copy(G).applyQuaternion(e).dot(this.eye))>.9&&(r.visible=!1)),"Y"===this.axis&&(F.setFromEuler(k.set(0,0,Math.PI/2)),r.quaternion.copy(e).multiply(F),Math.abs(O.copy(U).applyQuaternion(e).dot(this.eye))>.9&&(r.visible=!1)),"Z"===this.axis&&(F.setFromEuler(k.set(0,Math.PI/2,0)),r.quaternion.copy(e).multiply(F),Math.abs(O.copy(V).applyQuaternion(e).dot(this.eye))>.9&&(r.visible=!1)),"XYZE"===this.axis&&(F.setFromEuler(k.set(0,Math.PI/2,0)),O.copy(this.rotationAxis),r.quaternion.setFromRotationMatrix(B.lookAt(z,O,U)),r.quaternion.multiply(F),r.visible=this.dragging),"E"===this.axis&&(r.visible=!1)):"START"===r.name?(r.position.copy(this.worldPositionStart),r.visible=this.dragging):"END"===r.name?(r.position.copy(this.worldPosition),r.visible=this.dragging):"DELTA"===r.name?(r.position.copy(this.worldPositionStart),r.quaternion.copy(this.worldQuaternionStart),D.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),D.applyQuaternion(this.worldQuaternionStart.clone().invert()),r.scale.copy(D),r.visible=this.dragging):(r.quaternion.copy(e),this.dragging?r.position.copy(this.worldPositionStart):r.position.copy(this.worldPosition),this.axis&&(r.visible=-1!==this.axis.search(r.name)))}Re.Object3D.prototype.updateMatrixWorld.call(this)}};xa.prototype=Object.assign(Object.create(Re.Object3D.prototype),{constructor:xa,isTransformControlsGizmo:!0});var ba=function(){Re.Mesh.call(this,new Re.PlaneBufferGeometry(1e5,1e5,2,2),new Re.MeshBasicMaterial({visible:!1,wireframe:!0,side:Re.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var t=new Re.Vector3(1,0,0),e=new Re.Vector3(0,1,0),i=new Re.Vector3(0,0,1),n=new Re.Vector3,r=new Re.Vector3,o=new Re.Vector3,a=new Re.Matrix4,s=new Re.Quaternion;this.updateMatrixWorld=function(){var l=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(l="local"),t.set(1,0,0).applyQuaternion("local"===l?this.worldQuaternion:s),e.set(0,1,0).applyQuaternion("local"===l?this.worldQuaternion:s),i.set(0,0,1).applyQuaternion("local"===l?this.worldQuaternion:s),o.copy(e),this.mode){case"translate":case"scale":switch(this.axis){case"X":o.copy(this.eye).cross(t),r.copy(t).cross(o);break;case"Y":o.copy(this.eye).cross(e),r.copy(e).cross(o);break;case"Z":o.copy(this.eye).cross(i),r.copy(i).cross(o);break;case"XY":r.copy(i);break;case"YZ":r.copy(t);break;case"XZ":o.copy(i),r.copy(e);break;case"XYZ":case"E":r.set(0,0,0)}break;case"rotate":default:r.set(0,0,0)}0===r.length()?this.quaternion.copy(this.cameraQuaternion):(a.lookAt(n.set(0,0,0),r,o),this.quaternion.setFromRotationMatrix(a)),Re.Object3D.prototype.updateMatrixWorld.call(this)}};ba.prototype=Object.assign(Object.create(Re.Mesh.prototype),{constructor:ba,isTransformControlsPlane:!0});var wa=i(25),Ma=function(){function t(e,i,n){Object(s.a)(this,t),this.container=void 0,this.wrap=void 0,this.onChange=void 0,this.buttons=void 0,this.activeTab=void 0,this.container=e,this.onChange=n,this.buttons=i,this.activeTab=null,this.init()}return Object(l.a)(t,[{key:"init",value:function(){var t=document.createElement("div");t.style.position="absolute",t.style.top="20px",t.style.left="50%",t.style.transform="translate(-50%)",this.container.appendChild(t),this.wrap=t,this.render(),this.handleChange(this.buttons[0].value)}},{key:"handleChange",value:function(t){t!=this.activeTab&&(this.activeTab=t,this.onChange(t),this.render())}},{key:"render",value:function(){var t=this;Object(wa.render)(d.a.createElement("div",{style:{display:"flex",fontSize:"14px"}},this.buttons.map((function(e,i){var n=e.text,r=e.value,o=e.icon;return d.a.createElement("div",{key:i,style:{width:116,height:40,backgroundColor:t.activeTab==r?"#2491F7":"#32323A",marginLeft:0==i?"none":"10px",borderRadius:"2px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},onClick:function(){return t.handleChange(r)}},d.a.createElement("img",{style:{marginRight:"8px",width:20,height:20},src:"".concat(window.appConfig.ASSETS_URL,"components/static-image/smartCity3D2/image/").concat(o,".png")}),n)}))),this.wrap)}},{key:"remove",value:function(){this.wrap&&this.wrap.remove(),this.wrap=null}}]),t}(),Ta=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n){var o;Object(s.a)(this,i),(o=e.call(this)).id=void 0,o.config=void 0,o.interaction=void 0,o.data=void 0,o.parent=void 0,o.scene=void 0,o.group=void 0,o.mapJson=void 0,o.buildings=void 0,o.meterScale=void 0,o.wrap=void 0,o.props=void 0,o.container=void 0,o.camera=void 0,o.transformControls=void 0,o.tabContainer=void 0,o.buttons=void 0,o.loadItem=void 0,o.topButton=void 0,o.addModel=function(t){var e=o.config.styleConfig.bloom;t.traverse((function(t){e&&t.layers.enable(1),t.material&&(t.material.clippingPlanes=[new Re.Plane(new Re.Vector3(0,0,1),.1)])}));var i=new Re.Box3;i.setFromObject(t),t.rotation.x=Math.PI/2,t.position.z=-i.min.y;var n=new Re.Group;n.add(t),o.group.add(n),n.interactive=!0,n.componentId=o.id,o.wrap=n,o.configModel(),o.loadItem.loaded=!0,o.parent.checkLoading()},o.onTabChange=function(t){o.transformControls.setMode(t)},o.onZoom=function(t){var e=t&&null!=t.to?t.to:o.parent.map.getZoom(),i=Object(r.a)(o.config.baseConfig.showLevel,2),n=i[0],a=i[1];o.group.visible=!(e<n||e>a)},o.selectAction=function(t){if(t&&t.componentId&&t.componentId===o.id){var e=o.parent,i=e.id,n=e.onRelative,r=e.emit,a=o.interaction.callback;if(n){var s=Object.values(a),l={};s.map((function(t){l[t.target]=o.data[0]&&o.data[0][t.origin]||null})),n(i,l)}r&&r("click",o.data,o.id)}},o.props=t,o.id=t.id,o.config=t.configuration,o.data=t.data,o.parent=n,o.interaction=t.configuration.interaction,o.scene=n.extend.scene,o.camera=n.extend.camera,o.container=n.container,o.buttons=[{text:"移动",value:"translate",icon:"translate"},{text:"旋转",value:"rotate",icon:"rotation"},{text:"缩放",value:"scale",icon:"scale"}],o.group=new Re.Group,o.group.name="自定义模型",o.scene.add(o.group),o.meterScale=n.threeLayer.distanceToVector3(0,1).y;var a=o.config.baseConfig.altitude;return o.group.position.z=o.meterScale*a,o.parent.map.on("zooming",o.onZoom),o.loadModel(o.addModel),o.transformControls=new va(o.camera,o.container),o.scene.add(o.transformControls),o.transformControls.addEventListener("dragging-changed",(function(t){t.value?o.parent.map.config("draggable",!1):(o.parent.map.config("draggable",!0),o.dispatchModelUpdate(),o.animateToWrap())})),o}return Object(l.a)(i,[{key:"loadModel",value:function(t){var e=this.config.styleConfig,i=e.type,n=e.glb,r=e.gltf;if("glb"==i||"gltf"==i){this.loadItem=Object(Ko.d)(this);var o="glb"==i?n:JSON.parse(r).entry,a=new _a;a.setDecoderPath(window.appConfig.ASSETS_URL+"components/static-image/smartCity3D/draco/"),(new ya).setDRACOLoader(a).load(window.appConfig.ASSETS_URL+o,(function(e){t(e.scene)}),(function(t){}),(function(t){console.log("模型加载异常",t)}))}}},{key:"animateToWrap",value:function(){var t=this.wrap.position,e=this.config.baseConfig.system,i=this.VectorToLngLat(t),n=this.parent.reverseSystem(e,i);this.parent.map.animateTo({center:n})}},{key:"configModel",value:function(){var t=this.config.baseConfig,e=t.system,i=(t.depthTest,t.renderOrder,this.wrap),n=this.config.modelConfig,r=n.position,o=n.rotation,a=n.scale,s=r.lng,l=r.lat,c=r.height,h=this.parent.matchSystem(e,[s,l]),u=this.parent.threeLayer.coordinateToVector3(h,c*this.meterScale);i.position.copy(u),i.scale.set(a.x,a.y,a.z),i.rotation.set(Eo(o.x),Eo(o.y),Eo(o.z)),this.props.edit&&this.parent.map.animateTo({center:h}),this.onZoom()}},{key:"switchMode",value:function(t,e){if(e.edit){if(t.edit)return;this.transformControls.attach(this.wrap);var i=this.config.baseConfig.system,n=this.config.modelConfig.position,r=n.lng,o=n.lat;this.parent.map.animateTo({center:this.parent.matchSystem(i,[r,o])}),this.topButton=new Ma(this.parent.container,this.buttons,this.onTabChange)}else this.transformControls&&this.transformControls.detach(),this.topButton&&this.topButton.remove()}},{key:"VectorToLngLat",value:function(t){var e=t.x,i=t.y,n=this.parent.map.getGLZoom(),r=this.parent.map.pointToCoordinate({x:e,y:i},n);return[r.x,r.y]}},{key:"getModelConfig",value:function(){var t=this.wrap,e=t.position,i=t.rotation,n=t.scale,o=e.z/this.meterScale,a=this.config.baseConfig.system,s=this.VectorToLngLat(e),l=this.parent.reverseSystem(a,s),c=Object(r.a)(l,2),h=c[0],u=c[1];return{scale:{x:n.x,y:n.y,z:n.z},position:{lng:h,lat:u,height:o},rotation:{x:So(i.x),y:So(i.y),z:So(i.z)}}}},{key:"dispatchModelUpdate",value:function(){var t=this.getModelConfig(),e=this.parent.updateConfig;e&&e({id:this.id,type:"config",payload:[{path:["modelConfig","position","lng"],value:t.position.lng},{path:["modelConfig","position","lat"],value:t.position.lat},{path:["modelConfig","position","height"],value:t.position.height},{path:["modelConfig","scale","x"],value:t.scale.x},{path:["modelConfig","scale","y"],value:t.scale.y},{path:["modelConfig","scale","z"],value:t.scale.z},{path:["modelConfig","rotation","x"],value:t.rotation.x},{path:["modelConfig","rotation","y"],value:t.rotation.y},{path:["modelConfig","rotation","z"],value:t.rotation.z}]})}},{key:"getSupportObjects",value:function(){return this.wrap}},{key:"updateComponent",value:function(t){var e=this.config,i=this.props;if(this.props=t,this.config=t.configuration,this.data=t.data,!Object(f.isEqual)(e,this.config)){var n=e.baseConfig.altitude,r=this.config.baseConfig.altitude,o=e.styleConfig.bloom,a=this.config.styleConfig.bloom;n!==r?this.group.position.z=this.meterScale*r:o!==a?this.wrap.traverse((function(t){a?t.layers.enable(1):t.layers.disable(1)})):Object(f.isEqual)(e.styleConfig,this.config.styleConfig)?this.configModel():(this.dispose(),this.loadModel(this.addModel))}this.switchMode(i,t)}},{key:"dispose",value:function(){this.wrap&&(this.wrap.parent.remove(this.wrap),Object($o.deepDispose)(this.wrap),this.wrap=null)}},{key:"destroy",value:function(){this.group.parent.remove(this.group),Object($o.deepDisposeGroup)(this.group),this.group=null,this.scene.remove(this.transformControls),Object($o.deepDispose)(this.transformControls),this.transformControls=null,this.topButton&&this.topButton.remove(),this.topButton=null,this.parent.map.off("zooming",this.onZoom)}}]),i}(Xo.a),Sa=new Re.Vector3;function Ea(t,e,i){Re.Object3D.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,void 0===e&&(e=1);var n=new Re.BufferGeometry;n.setAttribute("position",new Re.Float32BufferAttribute([-e,e,0,e,e,0,e,-e,0,-e,-e,0,-e,e,0],3));var r=new Re.LineBasicMaterial({fog:!1,toneMapped:!1});this.lightPlane=new Re.Line(n,r),this.add(this.lightPlane),this.update()}Ea.prototype=Object.create(Re.Object3D.prototype),Ea.prototype.constructor=Ea,Ea.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose()},Ea.prototype.update=function(t){t&&(this.lightPlane.geometry.dispose(),this.lightPlane.geometry.setAttribute("position",new Re.Float32BufferAttribute([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3))),Sa.setFromMatrixPosition(this.light.target.matrixWorld),this.lightPlane.lookAt(Sa),void 0!==this.color?this.lightPlane.material.color.set(this.color):this.lightPlane.material.color.copy(this.light.color)};var Ca=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n){var r;return Object(s.a)(this,i),(r=e.call(this)).id=void 0,r.config=void 0,r.parent=void 0,r.scene=void 0,r.meterScale=void 0,r.wrap=void 0,r.props=void 0,r.container=void 0,r.camera=void 0,r.transformControls=void 0,r.edit=void 0,r.tabContainer=void 0,r.controlTarget=void 0,r.light=void 0,r.helper=void 0,r.line=void 0,r.buttons=void 0,r.topButton=void 0,r.getHelperSize=function(){var t=r.parent.map.getZoom();return 7e7/Math.pow(t,6)},r.addHelper=function(){if(r.light){var t=r.getHelperSize();r.light.updateMatrixWorld(),r.light.target.updateMatrixWorld();var e=new Ea(r.light,t);r.helper=e,r.scene.add(e);var i=new Re.Line((new Re.BufferGeometry).setFromPoints([r.light.position,r.light.target.position]),new Re.LineBasicMaterial);r.line=i,r.scene.add(i)}},r.removeHelper=function(){r.helper&&(r.scene.remove(r.helper),r.helper.dispose(),r.helper=null),r.line&&(r.scene.remove(r.line),Object($o.deepDispose)(r.line),r.line=null)},r.updateLine=function(){r.line&&r.light&&r.line.geometry.setFromPoints([r.light.position,r.light.target.position])},r.onTabChange=function(t){if("light"==t){r.transformControls.attach(r.light);var e=r.config.modalConfig.direction.position,i=e.lng,n=e.lat;r.parent.map.animateTo({center:[i,n]})}else{r.transformControls.attach(r.light.target);var o=r.config.modalConfig.direction.target,a=o.lng,s=o.lat;r.parent.map.animateTo({center:[a,s]})}r.controlTarget=t},r.props=t,r.id=t.id,r.config=t.configuration,r.edit=t.edit,r.parent=n,r.scene=n.extend.scene,r.camera=n.extend.camera,r.container=n.container,r.buttons=[{text:"光源",value:"light",icon:"light"},{text:"目标",value:"target",icon:"target"}],r.controlTarget="light",r.meterScale=n.threeLayer.distanceToVector3(0,1).y,r.addLight(),r.transformControls=new va(r.camera,r.container),r.scene.add(r.transformControls),r.transformControls.addEventListener("dragging-changed",(function(t){t.value?r.parent.map.config("draggable",!1):(r.parent.map.config("draggable",!0),r.dispatchDirectionUpdate(),r.animateToCenter())})),r.transformControls.addEventListener("change",(function(t){r.light&&r.light.updateMatrixWorld(),r.helper&&r.helper.update(),r.updateLine()})),r}return Object(l.a)(i,[{key:"addLight",value:function(){var t=this.config.modalConfig,e=t.baseConfig,i=t.direction,n=e.color,r=e.intensity,o=i.position,a=i.target;this.light=new Re.DirectionalLight(Object(Ko.c)(n)[0],r),this.light.layers.enableAll();var s=this.parent.threeLayer.coordinateToVector3([o.lng,o.lat],o.height*this.meterScale);this.light.position.copy(s),this.scene.add(this.light);var l=new Re.Object3D,c=this.parent.threeLayer.coordinateToVector3([a.lng,a.lat],a.height*this.meterScale);l.position.copy(c),this.light.target=l,l.updateMatrixWorld(),this.scene.add(l)}},{key:"animateToCenter",value:function(){var t=this.light,e=t.position,i=t.target,n="light"==this.controlTarget?e:i.position,r=this.VectorToLngLat(n);this.parent.map.animateTo({center:r})}},{key:"switchMode",value:function(t){if(this.edit){if(t.edit)return;!this.helper&&this.addHelper(),this.transformControls.attach(this.light),this.topButton=new Ma(this.parent.container,this.buttons,this.onTabChange);var e=this.config.modalConfig.direction.position,i=e.lng,n=e.lat;this.parent.map.animateTo({center:[i,n]})}else this.transformControls&&this.transformControls.detach(),this.removeHelper(),this.topButton&&this.topButton.remove()}},{key:"VectorToLngLat",value:function(t){var e=t.x,i=t.y,n=this.parent.map.getGLZoom(),r=this.parent.map.pointToCoordinate({x:e,y:i},n);return[r.x,r.y]}},{key:"getDirectionConfig",value:function(){var t=this.light,e=t.position,i=t.target,n=e.z/this.meterScale,o=i.position.z/this.meterScale,a=this.VectorToLngLat(e),s=Object(r.a)(a,2),l=s[0],c=s[1],h=this.VectorToLngLat(i.position),u=Object(r.a)(h,2);return{position:{lng:l,lat:c,height:n},target:{lng:u[0],lat:u[1],height:o}}}},{key:"dispatchDirectionUpdate",value:function(){var t=this.getDirectionConfig(),e=this.parent.updateConfig;e&&e({id:this.id,type:"config",payload:[{path:["modalConfig","direction","position","lng"],value:t.position.lng},{path:["modalConfig","direction","position","lat"],value:t.position.lat},{path:["modalConfig","direction","position","height"],value:t.position.height},{path:["modalConfig","direction","target","lng"],value:t.target.lng},{path:["modalConfig","direction","target","lat"],value:t.target.lat},{path:["modalConfig","direction","target","height"],value:t.target.height}]})}},{key:"updateComponent",value:function(t){var e=this.config,i=this.props;this.config=t.configuration,this.edit=t.edit,this.props=t,Object(f.isEqual)(e,this.config)||(this.dispose(),this.addLight(),this.removeHelper(),this.addHelper(),"light"==this.controlTarget?this.transformControls.attach(this.light):this.transformControls.attach(this.light.target)),this.switchMode(i)}},{key:"dispose",value:function(){this.light&&(this.scene.remove(this.light),Object($o.deepDispose)(this.light),this.light=null)}},{key:"destroy",value:function(){this.dispose(),this.scene.remove(this.transformControls),Object($o.deepDispose)(this.transformControls),this.transformControls=null,this.removeHelper(),this.topButton&&this.topButton.remove(),this.topButton=null}}]),i}(Xo.a),Aa=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n){var o;return Object(s.a)(this,i),(o=e.call(this)).id=void 0,o.config=void 0,o.interaction=void 0,o.data=void 0,o.parent=void 0,o.scene=void 0,o.mapJson=void 0,o.buildings=void 0,o.material=void 0,o.loadItem=void 0,o.streamers=void 0,o.addStreamer=function(t){switch(t.geometry.type){case"MultiPolygon":t.geometry.coordinates.forEach((function(t){t.forEach((function(t){var e=new Pa(t,o.config,o.parent);o.streamers.push(e)}))}));break;case"Polygon":case"MultiLineString":t.geometry.coordinates.forEach((function(t){var e=new Pa(t,o.config,o.parent);o.streamers.push(e)}));break;case"LineString":var e=new Pa(t.geometry.coordinates,o.config,o.parent);o.streamers.push(e)}},o.onZoom=function(t){var e=t&&null!=t.to?t.to:o.parent.map.getZoom(),i=Object(r.a)(o.config.baseConfig.showLevel,2),n=i[0],a=i[1];e<n||e>a?o.streamers.map((function(t){return t.hide()})):o.streamers.map((function(t){return t.show()}))},o.id=t.id,o.config=t.configuration,o.data=t.data,o.parent=n,o.interaction=t.configuration.interaction,o.scene=n.extend.scene,o.streamers=[],o.showData(),o.parent.map.on("zooming",o.onZoom),o}return Object(l.a)(i,[{key:"showData",value:function(){var t=this,e=this.config.styleConfig.url;e?(this.loadItem=Object(Ko.d)(this),fetch("".concat(window.appConfig.ASSETS_URL).concat(e)).then((function(t){return t.json()})).then((function(e){console.log("流光数据已加载");var i,n=a(e.features);try{for(n.s();!(i=n.n()).done;){var r=i.value;t.addStreamer(r)}}catch(t){n.e(t)}finally{n.f()}t.parent.threeLayer.addMesh(t.streamers),t.onZoom(),t.loadItem.loaded=!0,t.parent.checkLoading()}))):(this.data.forEach((function(e){e.features&&e.features.map((function(e){t.addStreamer(e)}))})),this.parent.threeLayer.addMesh(this.streamers),this.onZoom())}},{key:"updateComponent",value:function(t){var e=this.config,i=this.data;this.config=t.configuration,this.data=t.data,Object(f.isEqual)(e,this.config)&&Object(f.isEqual)(i,this.data)||(this.dispose(),this.showData())}},{key:"dispose",value:function(){this.parent.threeLayer.removeMesh(this.streamers),this.streamers.map((function(t){return t.dispose()})),this.streamers=[]}},{key:"destroy",value:function(){this.dispose(),this.parent.map.off("zooming",this.onZoom)}}]),i}(Xo.a),Pa=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n,o){var a;Object(s.a)(this,i),(a=e.call(this)).createMat=function(t){var e=t.baseConfig.depthTest,i=t.animateConfig.startRandom,n=t.styleConfig,o=n.lineConfig,a=n.backConfig,s=o.colors.linear,l=s.stops,c=s.opacity,h=o.lineLength,u=a.show,d=a.color,p=Object(r.a)(l,2),f=p[0].color,m=p[1].color,g=Object(Ko.c)(f),y=Object(Ko.c)(m),_=Object(Ko.c)(d);return new Re.ShaderMaterial({vertexShader:ua.vertexShader,fragmentShader:ua.fragmentShader,side:Re.DoubleSide,transparent:!0,depthWrite:!1,depthTest:e,uniforms:{time:{value:0},offset:{value:i?.1*Math.round(10*Math.random()):0},startColor:{value:new Re.Color(g[0])},startOpacity:{value:g[1]*c},endColor:{value:new Re.Color(y[0])},endOpacity:{value:y[1]*c},backColor:{value:new Re.Color(_[0])},backOpacity:{value:u?_[1]:0},lineLength:{value:h}}})},a.createGeo=function(t,e,i){var n=e.baseConfig.system,r=e.styleConfig.lineConfig.lineWidth;return function(t,e){var i=[],n=[],r=[],o=t.length;t.forEach((function(a,s){if(r.push(s/o,0),r.push(s/o,1),0===s){var l=t[s+1],c={x:2*a.x-l.x,y:2*a.y-l.y},h=La(a,c,l,-e),u=La(a,c,l,e);i.push(h.x,h.y,0),i.push(u.x,u.y,0)}else if(s===o-1){var d=t[s-1],p={x:2*a.x-d.x,y:2*a.y-d.y},f=La(a,d,p,-e),m=La(a,d,p,e);i.push(f.x,f.y,0),i.push(m.x,m.y,0),n.push(2*s-2,2*s,2*s-1,2*s-1,2*s,2*s+1)}else{var g=t[s-1],y=t[s+1],_=La(a,g,y,-e),v=La(a,g,y,e);i.push(_.x,_.y,0),i.push(v.x,v.y,0),n.push(2*s-2,2*s,2*s-1,2*s-1,2*s,2*s+1)}}));var a=new Re.BufferGeometry;return a.setIndex(n),a.setAttribute("position",new Re.Float32BufferAttribute(i,3)),a.setAttribute("uv",new Re.Float32BufferAttribute(r,2)),a}(t.map((function(t){var e=i.matchSystem(n,t);return i.threeLayer.coordinateToVector3(e,0)})),.5*r*.01)},a.createStreamer=function(t,e,i){var n=e.baseConfig,r=n.depthTest,o=n.renderOrder,s=e.styleConfig.bloom,l=a.createGeo(t,e,i),c=a.createMat(e),h=new Re.Mesh(l,c);return Object(Ko.f)(h),s&&h.layers.enable(1),h.renderOrder=r?0:o,h};var l=Ve.o.extend({},{data:t,config:n,parent:o});a._initOptions(l),a._createGroup();var c=a.getObject3d(),h=a.createStreamer(t,n,o);c.add(h);var u=n.baseConfig.altitude,d=o.threeLayer.distanceToVector3(0,1).y;return c.position.z=d*u,a.mesh=h,a}return Object(l.a)(i,[{key:"_animation",value:function(){var t=this.getOptions().config,e=(t.styleConfig.lineConfig.lineLength,t.animateConfig),i=e.speed;e.interval;this.mesh.material.uniforms.time.value+=i}},{key:"dispose",value:function(){Object($o.deepDispose)(this.mesh),this.mesh=null}}]),i}(ai);function La(t,e,i,n){var r=Math.atan2(e.y-t.y,e.x-t.x),o=Math.atan2(i.y-t.y,i.x-t.x)-r;o<0?o+=2*Math.PI:o>2*Math.PI&&(o-=2*Math.PI);var a=o/2+r,s=n*Math.cos(a)+t.x,l=n*Math.sin(a)+t.y;return{x:2*t.x-s,y:2*t.y-l}}var Ia=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t,n){var o;Object(s.a)(this,i),(o=e.call(this)).id=void 0,o.config=void 0,o.interaction=void 0,o.data=void 0,o.parent=void 0,o.scene=void 0,o.group=void 0,o.mapJson=void 0,o.buildings=void 0,o.meterScale=void 0,o.wrap=void 0,o.props=void 0,o.camera=void 0,o.loadItem=void 0,o.onZoom=function(t){var e=t&&null!=t.to?t.to:o.parent.map.getZoom(),i=Object(r.a)(o.config.baseConfig.showLevel,2),n=i[0],a=i[1];o.group.visible=!(e<n||e>a)},o.addSprite=function(t){var e=t.canvas,i=t.grid,n=t.position,r=t.data,a=e.width,s=e.height,l=o.config.baseConfig,c=l.depthTest,h=l.renderOrder,u=new Re.Texture(e);u.needsUpdate=!0,u.encoding=Re.sRGBEncoding;var d=new Re.SpriteMaterial({map:u,side:Re.DoubleSide,depthWrite:!1,transparent:!0,depthTest:!c}),p=new Re.Sprite(d);p.renderOrder=h,p.userData=Object(Wo.a)({},r);var f=Object(Ko.e)(i);p.center.set(f[0],f[1]);p.scale.set(.01*a,.01*s,1),p.interactive=!0,p.componentId=o.id,p.position.copy(n),o.group.add(p)},o.showData=function(){var t=o.config,e=t.baseConfig,i=t.contentConfig,n=t.stateConfig,r=e.system,a=Object.values(i.lines),s=Object.values(n.states),l={},c=[];s.map((function(t){var e=t.type,i=t.url,n=new Image;n.setAttribute("crossOrigin","anonymous"),n.src="".concat(window.appConfig.ASSETS_URL).concat(i),l[e]=Object(Wo.a)(Object(Wo.a)({},t),{},{image:n});var r=new Promise((function(t,e){n.onload=function(){t(n)},n.onerror=function(){e(n)}}));c.push(r)})),Promise.all(c).then((function(){o.data.map((function(t){var e=t.state,i=t.lng,n=t.lat,s=l[e];if(s){var c=s.size,h=c.width,u=c.height,d=s.image,p=s.center,f=(s.offset,Object(Ko.a)({item:t,lines:a,width:h,height:u,image:d}));f.style.position="absolute",f.style.top="0px";var m=o.parent.threeLayer.coordinateToVector3(o.parent.matchSystem(r,[i,n]),0);o.addSprite({canvas:f,grid:p,position:m,data:t})}})),o.onZoom(),o.loadItem.loaded=!0,o.parent.checkLoading()}))},o.props=t,o.id=t.id,o.config=t.configuration,o.data=t.data,o.parent=n,o.interaction=t.configuration.interaction,o.scene=n.extend.scene,o.camera=n.extend.camera,o.group=new Re.Group,o.group.name="信息面板",o.meterScale=n.threeLayer.distanceToVector3(0,1).y;var a=o.config.baseConfig.altitude;return o.group.position.z=o.meterScale*a,o.scene.add(o.group),o.parent.map.on("zooming",o.onZoom),o.loadItem=Object(Ko.d)(Object(qo.a)(o)),o.showData(),o}return Object(l.a)(i,[{key:"updateComponent",value:function(t){var e=this.config,i=this.data,n=e.baseConfig.altitude;this.config=t.configuration,this.interaction=t.configuration.interaction,this.data=t.data;var r=this.config.baseConfig.altitude;n!==r?this.group.position.z=this.meterScale*r:Object(f.isEqual)(e,this.config)&&Object(f.isEqual)(i,this.data)||(this.dispose(),this.showData())}},{key:"getSupportObjects",value:function(){return this.group}},{key:"selectAction",value:function(t){if(t&&t.componentId&&t.componentId===this.id){var e=this.parent.props,i=e.id,n=e.onRelative,r=e.emit,o=this.interaction.callback;if(n){var a=Object.values(o),s={};a.map((function(e){s[e.target]=t.userData[e.origin]||null})),n(i,s)}r&&r("click",[Object(Wo.a)({},t.userData)],this.id)}}},{key:"update",value:function(){}},{key:"dispose",value:function(){Object($o.deepDispose)(this.group),this.group.children.length=0}},{key:"destroy",value:function(){this.scene.remove(this.group),this.dispose(),this.group=null,this.parent.map.off("zooming",this.onZoom)}}]),i}(Xo.a);lo.prototype.initBloom=function(t){var e=t.show,i={exposure:1,bloomStrength:t.strength,bloomThreshold:0,bloomRadius:t.radius,debug:!1},n=this.getThreeRenderer(),r=this.getMap().getSize();this.composer=new Fe(n),this.composer.setSize(r.width,r.height);var o=this.getScene(),a=this.getCamera();this.renderPass=new je(o,a),this.composer.addPass(this.renderPass);var s=this.bloomPass=new Ue(new Re.Vector2(r.width,r.height));s.renderToScreen=!0,s.threshold=i.bloomThreshold,s.strength=i.bloomStrength,s.radius=i.bloomRadius,this.composer.addPass(s),this.bloomEnable=e},lo.prototype.setRendererRenderScene=function(){this.getRenderer().renderScene=function(){var t=this.layer;t._callbackBaseObjectAnimation(),this._syncCamera();var e=this.context,i=this.camera,n=this.scene;t.bloomEnable&&t.composer&&t.composer.passes.length>1?(e.autoClear&&(e.autoClear=!1),t.bloomPass&&i.layers.set(1),t&&t.composer&&t.composer.render(0),e.clearDepth(),i.layers.set(0),e.render(n,i)):(e.autoClear||(e.autoClear=!0),e.render(n,i)),this.completeRender()}};var Ra=function(t){Object(c.a)(i,t);var e=Object(h.a)(i);function i(t){var r;return Object(s.a)(this,i),(r=e.call(this,t)).dispatchCameraUpdate=function(){var t=r.getCamera();console.log("dispatchCameraUpdate",t);var e=r.props.updateConfig;e&&e({type:"camera",payload:t})},r.cameraRotate=function(t){if(r.map){var e=r.map.getBearing();r.mouseDown||r.map.setBearing(e+t/60),r.timer=requestAnimationFrame((function(){r.cameraRotate(t)}))}},r.cameraFly=function(t){var e=t.target,i=t.time,o=t.callback;if(r.map){var a=r.getCamera();r.tween_fly=Me({from:{zoom:a.zoom,pitch:a.pitch,lng:a.center.lng,lat:a.center.lat,bearing:a.bearing},to:{zoom:e.zoom,pitch:e.pitch,lng:e.center.lng,lat:e.center.lat,bearing:e.bearing},ease:n.linear,duration:1e3*i}).start({update:function(t){var e={zoom:t.zoom,pitch:t.pitch,bearing:t.bearing,center:[t.lng,t.lat]};r.map.setView(e)},complete:function(){r.tween_fly=null,o&&o()}})}},r.cameraCruise=function(t){var e=t.cameras,i=t.loop,o=t.index;if(r.map){var a=r.getCamera(),s=e[o];r.tween_fly=Me({from:{zoom:a.zoom,pitch:a.pitch,lng:a.center.lng,lat:a.center.lat,bearing:a.bearing},to:{zoom:s.zoom,pitch:s.pitch,lng:s.center.lng,lat:s.center.lat,bearing:s.bearing},ease:n.linear,duration:e[o-1]?1e3*e[o-1].time:1e3*e[e.length-1].time}).start({update:function(t){var e={zoom:t.zoom,pitch:t.pitch,bearing:t.bearing,center:[t.lng,t.lat]};r.map.setView(e)},complete:function(){var t=o+1;t>e.length-1?i?(t=0,r.cameraCruise({cameras:e,loop:i,index:t})):r.tween_fly=null:r.cameraCruise({cameras:e,loop:i,index:t})}})}},r.cameraSwitch=function(t){r.map&&r.map.setView(t)},r.getOptions=function(t){var e=t.configuration.filter((function(t){return"sceneConfig"===t._name}))[0]._value.filter((function(t){return"scenes"===t._name}))[0];return console.log("scenes",e),e._value.map((function(t,e){return{name:t._displayName+(e+1),value:t._name}}))},r.updateScenes=function(t){var e=r.props.updateConfig;e&&e({type:"actions",payload:{path:["sceneId"],value:r.getOptions(t),field:"_options",actionName:"animateScene"}})},r.handleStateUpdate=function(t){var e=t.data,i=e.value,n=e.type;if(r.props.edit)if("camera"===n)r.stopFly(),r.stopRotate(),r.cameraSwitch(i);else if("animation"===n){var o=i.type,a=i.value;"play"===o?r.tween_fly?"rotate"===a.type?r.cameraRotate(a.speed):r.resumeFly():r.animateScene(a):"pause"===o?(r.pauseFly(),r.stopRotate()):"reset"===o&&(r.stopFly(),r.stopRotate(),r.switchScene(a))}},r.handlerAction=function(t){var e=t.data,i=void 0===e?{}:e,n=r.config.sceneConfig.scenes[i.sceneId];r.animateScene(n)},r.onBaseLayerChange=function(t){r.sky&&r.sky.updateClip("mapbox"==t)},r.id=t.id,r.emit=t.emit,r.onRelative=t.onRelative,r.updateConfig=t.updateConfig,r.childrenCommponentMap=new Map,r.loading=[],r.children=[{moduleName:"billboard",componentName:Uo.a},{moduleName:"imageLayer",componentName:Vo.a},{moduleName:"building",componentName:na},{moduleName:"point",componentName:aa},{moduleName:"fence",componentName:ca},{moduleName:"flyLine",componentName:da},{moduleName:"heat",componentName:ga},{moduleName:"customModel",componentName:Ta},{moduleName:"directionalLight",componentName:Ca},{moduleName:"streamer",componentName:Aa},{moduleName:"infoPanel",componentName:Ia}],r.mouseDown=!1,r.extend={renderer:null,scene:null,camera:null},r.config=Object(p.reduceConfig2)(t.configuration),r.addListener(),r}return Object(l.a)(i,[{key:"checkLoading",value:function(){var t=this,e=!0;this.loading.map((function(t){return!t.loaded&&(e=!1)})),e&&Me({from:1,to:0,duration:1e3,ease:n.easeIn}).start({update:function(e){return t.loadingDom.style.opacity=e},complete:function(){return t.loadingDom.style.display="none"}})}},{key:"insertStyle",value:function(){var t=document.createElement("style");t.id="city_selector_css",document.getElementsByTagName("head")[0].append(t),t.appendChild(document.createTextNode("\n.city-selector-wrap {\n  position: absolute;\n  top: 10px;\n  right: 10px;\n  z-index: 1;\n}\n\n.city-selector-box {\n  position: relative;\n  transform: scale(1.5);\n  transform-origin: 100% 0 0;\n}\n\n.city-selector-box .city-link {\n  text-decoration: none;\n  margin-right: 8px;\n  cursor: pointer;\n}\n\n.city-selector-box .city-info-box {\n  width: 50px;\n  padding: 3px 5px;\n  margin-left: 140px;\n  text-align: center;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  cursor: pointer;\n}\n\n.city-selector-box .city-list-box {\n  position: relative;\n  display: none;\n  width: 200px;\n  margin-top: 9px;\n  animation: fadeIn .5s;\n}\n\n@keyframes fadeIn {\n  0% {\n    opacity: 0;\n  }\n\n  100% {\n    opacity: 1;\n  }\n}\n\n.city-selector-box .city-info-box,\n.city-selector-box .city-list-box {\n  border-radius: 4px;\n}\n\n.city-selector-box .city-list-box:before {\n  content: '';\n  position: absolute;\n  top: -4px;\n  right: 25px;\n  width: 0;\n  height: 0;\n  border-style: solid;\n  border-width: 0 5px 5px;\n  border-color: transparent;\n}\n\n.city-selector-box .city-list-box.active {\n  display: block;\n}\n\n.city-selector-box .city-list {\n  padding: 6px 8px;\n}\n\n.city-selector-box .city-list-lt {\n  position: absolute;\n  z-index: 1;\n  right: 0;\n  margin-top: 3px;\n  border: none !important;\n}\n\n.city-selector-box .city-list-lt .letter-link {\n  cursor: pointer;\n  line-height: 15px;\n}\n\n.city-selector-box .city-list-lt .letter-link:hover {\n  text-decoration: underline;\n}\n\n.city-selector-box .city-list-pv {\n  padding-top: 0;\n  padding-right: 16px;\n  height: 190px;\n  overflow-x: hidden;\n  overflow-y: auto;\n  position: relative;\n}\n\n.city-selector-box .city-list-dl {\n  margin: 0;\n}\n\n.city-selector-box .city-list-dl {\n  padding-top: 6px;\n}\n\n.city-selector-box .city-list-dl dt {\n  float: left;\n  width: 50px;\n  margin-right: 0;\n  font-weight: 700;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.city-selector-box .city-list-dl dd {\n  margin-left: 50px;\n}\n\n.city-selector-box .city-list-pv::-webkit-scrollbar {\n  width: 4px;\n  height: 4px;\n}\n\n.city-selector-box .city-list-pv::-webkit-scrollbar-thumb,\n.city-selector-box .city-list-pv::-webkit-scrollbar-track {\n  border-radius: 4px;\n}\n\n\n/* theme light */\n.city-selector-box.light .city-link,\n.city-selector-box.light .letter-link {\n  color: #333;\n}\n\n.city-selector-box.light .city-info-box,\n.city-selector-box.light .city-list-box {\n  box-shadow: 0 8px 20px 6px rgba(31, 51, 73, .1);\n  background: #fff;\n}\n\n.city-selector-box.light .city-list-box:before {\n  border-bottom-color: #fff;\n}\n\n.city-selector-box.light .city-list:not(:first-child) {\n  border-top: 1px solid rgba(0, 0, 0, .1);\n}\n\n.city-selector-box.light .city-list-pv::-webkit-scrollbar-thumb {\n  background: rgba(0, 0, 0, 0.2);\n}\n\n.city-selector-box.light .city-list-pv::-webkit-scrollbar-track {\n  background: rgba(0, 0, 0, 0.1);\n}\n\n/* theme dark */\n.city-selector-box.dark .city-link,\n.city-selector-box.dark .letter-link,\n.city-selector-box.dark .city-info-box {\n  color: #e5e5e5;\n}\n\n.city-selector-box.dark .city-info-box,\n.city-selector-box.dark .city-list-box {\n  box-shadow: 0 8px 20px 6px rgba(31, 51, 73, .1);\n  background: #313d4f;\n}\n\n.city-selector-box.dark .city-list-box:before {\n  border-bottom-color: #313d4f;\n}\n\n.city-selector-box.dark .city-list:not(:first-child) {\n  border-top: 1px solid rgba(255, 255, 255, .1);\n}\n\n.city-selector-box.dark .city-list-pv::-webkit-scrollbar-thumb {\n  background: rgba(255, 255, 255, 0.2);\n}\n\n.city-selector-box.dark .city-list-pv::-webkit-scrollbar-track {\n  background: rgba(255, 255, 255, 0.1);\n}\n")),this.citySelectorStyle=t}},{key:"removeStyle",value:function(){this.citySelectorStyle&&this.citySelectorStyle.remove()}},{key:"upForInteractiveObject",value:function(t){return!!t&&(t.interactive?t:!!t.parent&&this.upForInteractiveObject(t.parent))}},{key:"getSupportObjectArray",value:function(){var t,e=[],i=a(this.childrenCommponentMap.values());try{for(i.s();!(t=i.n()).done;){var n=t.value.getSupportObjects();n&&e.push(n)}}catch(t){i.e(t)}finally{i.f()}return e}},{key:"executeChildrenCommponentSelect",value:function(t,e){var i,n=a(this.childrenCommponentMap.values());try{for(n.s();!(i=n.n()).done;){var r=i.value;r&&r.selectAction&&r.selectAction(t,e)}}catch(t){n.e(t)}finally{n.f()}}},{key:"createSystemMatch",value:function(){var t=this;return function(e,i){return t.system==e?i:"WGS84"==e?To(i):Mo(i)}}},{key:"createSystemReverse",value:function(){var t=this;return function(e,i){return t.system==e?i:"WGS84"==e?Mo(i):To(i)}}},{key:"getCamera",value:function(){return this.map.getView()}},{key:"stopRotate",value:function(){this.timer&&cancelAnimationFrame(this.timer),this.timer=null}},{key:"stopFly",value:function(){this.tween_fly&&this.tween_fly.stop(),this.tween_fly=null}},{key:"pauseFly",value:function(){this.tween_fly&&this.tween_fly.pause()}},{key:"resumeFly",value:function(){this.tween_fly&&this.tween_fly.resume()}},{key:"animateScene",value:function(t){var e=this;if(t){this.stopFly(),this.stopRotate();var i=t.open,n=t.type,r=t.entranceTime,o=t.defaultCamera,a=t.rotateCamera,s=t.speed,l=t.flyCameras,c=t.loop;i?"rotate"==n?this.cameraFly({target:a,time:r,callback:function(){e.cameraRotate(s)}}):this.cameraFly({target:l[0],time:r,callback:function(){e.cameraCruise({cameras:l,loop:c,index:1})}}):this.cameraFly({target:o,time:r})}}},{key:"switchScene",value:function(t){if(t){var e,i=t.open,n=t.type,r=t.defaultCamera,o=t.rotateCamera,a=t.flyCameras;(e=i?"rotate"==n?o:a[0]:r)&&this.cameraSwitch(e)}}},{key:"addListener",value:function(){document.addEventListener("updateState",this.handleStateUpdate,!1),document.addEventListener("animateScene_".concat(this.props.id),this.handlerAction,!1)}},{key:"removeListener",value:function(){document.removeEventListener("updateState",this.handleStateUpdate),document.removeEventListener("animateScene_".concat(this.props.id),this.handlerAction)}},{key:"addALight",value:function(t){t.show&&(this.light=new Re.AmbientLight(t.color.toLocaleLowerCase(),t.intensity),this.light.layers.enableAll(),this.extend.scene.add(this.light))}},{key:"addDLight",value:function(){this.dLight=new Re.DirectionalLight("#fff",1),this.dLight.layers.enableAll();var t=this.threeLayer.coordinateToVector3([0,50],1e6);console.log("v",t),this.dLight.position.copy(t),this.extend.scene.add(this.dLight)}},{key:"componentDidMount",value:function(){var t=this;this.insertStyle();var e=this.config,i=e.chart,n=i.baseLayer,r=i.scaleRange,o=e.effectConfig,a=o.aLight,s=o.bloom,l=o.skyConfig;this.system=n.system,this.matchSystem=this.createSystemMatch(),this.reverseSystem=this.createSystemReverse(),this.map=new Ve.j(this.container,{center:[120.158,30.262],zoom:15,pitch:70,bearing:120,minZoom:r[0],maxZoom:r[1],seamlessZoom:!0}),this.baseLayer=new wo(this.map,n,this.onBaseLayerChange);var c=document.querySelector(".maptalks-attribution");c&&c.remove(),this.map.on("click",(function(e){var i=e.containerPoint,n=i.x,r=i.y,o=new Re.Raycaster,a=new Re.Vector2,s=t.config.chart.dimension.chartDimension,l=s.width,c=s.height;a.x=n/l*2-1,a.y=1-r/c*2,o.setFromCamera(a,t.threeLayer.getCamera());var h=o.intersectObjects(t.getSupportObjectArray(),!0);if(h[0]){var u=h[0].object,d=t.upForInteractiveObject(u);t.executeChildrenCommponentSelect(d,e)}})),this.map.on("mousedown",(function(){t.mouseDown=!0})),this.map.on("mouseup",(function(){t.mouseDown=!1})),this.map.on("moveend",(function(){t.props.edit&&t.dispatchCameraUpdate()})),this.cameraControl=new Po(this),this.threeLayer=new lo("three",{forceRenderOnMoving:!0,forceRenderOnRotating:!0,animation:!0});var h=this;this.threeLayer.prepareToDraw=function(t,e,i){this.setZIndex(1e3),t.outputEncoding=Re.sRGBEncoding,this.initBloom(s),this.setRendererRenderScene(),h.extend={renderer:t,scene:e,camera:i},h.addALight(a),Go(h),h.checkLoading()},this.threeLayer.addTo(this.map);var u=this.config.sceneConfig.scenes,d=Object.values(u)[0];d&&(this.cameraControl.switchScene(d),this.cameraControl.animateScene(d)),l.show&&(this.sky=new ko(this))}},{key:"removeChildren",value:function(){var t,e=a(this.childrenCommponentMap.keys());try{for(e.s();!(t=e.n()).done;){var i=t.value,n=this.childrenCommponentMap.get(i);n&&n.destroy()}}catch(t){e.e(t)}finally{e.f()}this.childrenCommponentMap=new Map}},{key:"componentWillReceiveProps",value:function(t){var e=this.config;if(this.config=Object(p.reduceConfig2)(t.configuration),!Object(f.isEqual)(e.chart,this.config.chart)||!Object(f.isEqual)(e.effectConfig,this.config.effectConfig)){var i=e.chart,n=i.baseLayer,o=i.scaleRange,s=e.effectConfig,l=s.aLight,c=s.bloom,h=s.skyConfig,u=this.config,d=u.chart,m=d.baseLayer,g=d.scaleRange,y=u.effectConfig,v=y.aLight,x=y.bloom,b=y.skyConfig;if(!Object(f.isEqual)(n,m)){var w=n.system,M=m.system;Object(f.isEqual)(w,M)?this.baseLayer&&this.baseLayer.update(m):(this.system=M,this.removeChildren(),Go(this))}if(!Object(f.isEqual)(o,g)){var T=Object(r.a)(g,2),S=T[0],E=T[1];this.map.setMinZoom(S),this.map.setMaxZoom(E)}if(Object(f.isEqual)(l,v)||(v.show?this.light?(this.light.intensity=v.intensity,this.light.color=new Re.Color(v.color.toLocaleLowerCase())):this.addALight(v):(this.light&&this.extend.scene.remove(this.light),this.light=null)),!Object(f.isEqual)(c,x)){var C=this.threeLayer,A=C.bloomPass;C.bloomEnable=x.show,A.strength=x.strength,A.radius=x.radius}Object(f.isEqual)(h,b)||(b.show?this.sky?this.sky.update():this.sky=new ko(this):(this.sky&&this.sky.dispose(),this.sky=null))}var P=e.sceneConfig,L=this.config.sceneConfig;if(Object(f.isEqual)(P.scenes,L.scenes)||this.cameraControl&&(this.cameraControl.stopFly(),this.cameraControl.stopRotate(),this.cameraControl.updateScenes(this.config)),this.props.edit&&!t.edit){var I=this.config.sceneConfig.scenes,R=Object.values(I)[0];this.cameraControl.switchScene(R),this.cameraControl.animateScene(R),this.citySelectorControl&&this.citySelectorControl.remove(),this.citySelectorControl=null}if(!this.props.edit&&t.edit){this.dispatchCameraUpdate();this.citySelectorControl=new Io({theme:"dark",placeholder:"全国",hot:["110000","310000","330100"],zoom:12}),this.citySelectorControl.add(this.map,this.controlWrap)}!function(t,e,i,n){var r=i.childrenCommponentMap,o=zo(t.childrenConfig),s=zo(e.childrenConfig),l=Bo(o,s),c=Bo(s,o);l&&l.length>0&&l.forEach((function(t){var e=r.get(t);e&&e.destroy(),r.delete(t)}));var h,u=a(r.keys());try{for(u.s();!(h=u.n()).done;){var d=h.value,f=Oo(t.childrenConfig,"id",d)[0],m=Oo(t.childrenData,"id",d)[0],g=Oo(e.childrenConfig,"id",d)[0],y=Oo(e.childrenData,"id",d)[0];if(!_.isEqual(f,g)||!_.isEqual(m,y)||n){var v=r.get(d);v&&v.updateComponent(Object.assign({},g,{configuration:Object(p.reduceConfig2)(g.configuration),data:y.data}),{})}}}catch(t){u.e(t)}finally{u.f()}c&&c.length>0&&c.forEach((function(t){var n=Oo(e.childrenConfig,"id",t)[0],r=Oo(e.childrenData,"id",t)[0],o=n.base,a=n.configuration,s=Oo(i.children,"moduleName",o.module_name)[0].componentName;jo(t,s,Object.assign({},n,{configuration:Object(p.reduceConfig2)(a),data:r.data}),i)}))}(this.props,t,this)}},{key:"componentWillUnmount",value:function(){this.removeStyle(),this.baseLayer&&this.baseLayer.destory(),this.map&&this.map.remove(),this.cameraControl&&this.cameraControl.dispose(),this.cameraControl=null,this.sky&&this.sky.dispose(),this.removeListener()}},{key:"render",value:function(){var t=this,e=this.props.id,i=this.config,n=i.chart.dimension.chartPosition,r=n.left,o=n.top,a=i.chart.dimension.chartDimension,s={position:"absolute",left:r,top:o,width:a.width,height:a.height,textAlign:"center"};return d.a.createElement("div",{className:"__easyv-component",style:s,id:e},d.a.createElement("div",{ref:function(e){return t.controlWrap=e}}),d.a.createElement("div",{ref:function(e){return t.container=e},style:{width:"100%",height:"100%"}}),d.a.createElement("div",{style:{position:"absolute",top:0,width:"100%",height:"100%",display:this.config.chart.loading?"flex":"none",justifyContent:"center",alignItems:"center",fontSize:"90px",backgroundColor:"#052238"},ref:function(e){return t.loadingDom=e}},d.a.createElement("video",{src:window.appConfig.ASSETS_URL+"components/static-image/smartCity3D2/image/loading.webm",muted:"muted",autoPlay:!0,loop:!0})))}}]),i}(u.Component);Ra.getDefaultConfig=function(){return{base:{name:"3D城市-抢先版",module_name:"smartCity3D2",version:"1.0.2",show:1},configuration:[{name:"chart",displayName:"基础配置",config:{layout:"horizontal"},value:[{name:"dimension",displayName:"位置尺寸",value:[{name:"chartPosition",displayName:"图表位置",value:[{name:"left",displayName:"X轴坐标",labelPosition:"bottom",value:0},{name:"top",labelLayout:24,labelPosition:"bottom",displayName:"Y轴坐标",value:0}]},{name:"chartDimension",displayName:"图表尺寸",value:[{name:"width",displayName:"宽度",labelPosition:"bottom",value:1920},{name:"height",displayName:"高度",labelPosition:"bottom",value:1080}]}]},{name:"baseLayer",displayName:"地图底图",value:[{name:"show",displayName:"显示",value:!0,type:"boolean"},{rule:[["show","$eq",!0]],type:"radio",name:"type",displayName:"底图类型",value:"mapbox",config:{options:[{name:"mapbox",value:"mapbox"},{name:"XYZ",value:"xyz"}]}},{rule:[["show","$eq",!0],["type","$eq","mapbox"]],name:"mapboxType",displayName:"样式类别",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"自定义",value:"custom"}]}},{rule:[["show","$eq",!0],["type","$eq","mapbox"],["mapboxType","$eq","default"]],type:"selectCard",name:"mapboxStyle",displayName:"样式",value:"mapbox://styles/easyv/cky9qxzzp44cv14nn1lgb58qw",config:{options:[{name:"黑色",value:"mapbox://styles/mapbox/dark-v9",cover:"https://easyv-test.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/黑色.png"},{name:"浅色",value:"mapbox://styles/easyv/ckmctkbn90f0i17rqptn7bpzc",cover:"https://easyv-test.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/浅色.png"},{name:"卫星图",value:"mapbox://styles/easyv/ckmec5bmk7jjm17o30306kubf",cover:"https://easyv-test.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/卫星图.png"},{name:"深色地形",value:"mapbox://styles/easyv/ckmehoac600so17mke9j3x2ai",cover:"https://easyv-test.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/深色地形.png"},{name:"墨绿",value:"mapbox://styles/easyv/cky9qxzzp44cv14nn1lgb58qw",cover:"https://easyv-test.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/墨绿.png"}]}},{rule:[["show","$eq",!0],["type","$eq","mapbox"],["mapboxType","$eq","custom"]],type:"input",name:"accessToken",displayName:"Access token",value:"pk.eyJ1IjoiMTM1ODgyMDQyMzAiLCJhIjoiY2trbm9lZXA1MXBmcjJwcW5mdTVuM2t1NCJ9.ay1FKWom67649aOCCiTNhQ"},{rule:[["show","$eq",!0],["type","$eq","mapbox"],["mapboxType","$eq","custom"]],type:"input",name:"style",displayName:"Style URL",value:"mapbox://styles/13588204230/cky18smwirbbx14ud4s5kh8bc"},{rule:[["show","$eq",!0],["type","$neq","mapbox"]],type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{rule:[["show","$eq",!0],["type","$eq","xyz"]],type:"input",name:"xyzUrl",displayName:"地址",value:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"}]},{type:"range",name:"scaleRange",displayName:"缩放范围",value:[0,18],config:{min:0,max:20,step:.1}},{name:"loading",displayName:"加载页",type:"boolean",value:!0}]},{name:"effectConfig",displayName:"场景效果",value:[{name:"aLight",displayName:"环境光",value:[{type:"boolean",name:"show",displayName:"",value:!0},{rule:[["show","$eq",!0]],type:"color",name:"color",displayName:"颜色",value:"#fff"},{rule:[["show","$eq",!0]],type:"number",name:"intensity",displayName:"强度",value:1}]},{name:"skyConfig",displayName:"天空",value:[{type:"boolean",name:"show",displayName:"",value:!0},{name:"timeInterval",displayName:"时段",type:"select",value:"style1",config:{options:[{name:"清晨",value:"style1"},{name:"傍晚",value:"style2"},{name:"夜晚",value:"style3"},{name:"漆黑的夜",value:"style4"},{name:"阴天",value:"style5"},{name:"暴雨将至",value:"style6"},{name:"晴天",value:"style7"}]}},{rule:[["defaultStyle","$eq","此处不显示"]],type:"range",name:"turbidity",displayName:"turbidity",value:.8,config:{step:.1,min:0,max:20}},{rule:[["defaultStyle","$eq","此处不显示"]],type:"range",name:"rayleigh",displayName:"rayleigh",value:.36,config:{step:.01,min:0,max:4}},{rule:[["defaultStyle","$eq","此处不显示"]],type:"range",name:"mieCoefficient",displayName:"mieCoefficient",value:.04,config:{min:0,max:.1,step:.01}},{rule:[["defaultStyle","$eq","此处不显示"]],type:"range",name:"mieDirectionalG",displayName:"mieDirectionalG",value:.14,config:{min:0,max:1,step:.01}},{rule:[["defaultStyle","$eq","此处不显示"]],type:"range",name:"elevation",displayName:"elevation",value:54.5,config:{min:-180,max:180,step:.1}},{rule:[["defaultStyle","$eq","此处不显示"]],type:"range",name:"azimuth",displayName:"azimuth",value:79.1,config:{min:-180,max:180,step:.1}},{rule:[["defaultStyle","$eq","此处不显示"]],type:"range",name:"exposure",displayName:"exposure",value:.1741,config:{min:0,max:1,step:1e-4}}]},{name:"bloom",displayName:"辉光",value:[{type:"boolean",name:"show",displayName:"开启",value:!1},{type:"number",name:"strength",displayName:"强度",value:1},{type:"number",name:"radius",displayName:"半径",value:0}]}]},{type:"modal",name:"sceneConfig",displayName:"场景管理",value:[{name:"scenes",displayName:"多场景",type:"array",defaultOpen:!0,clickAction:"reset",config:{template:{name:"scene",displayName:"场景",type:"object",value:[{name:"open",displayName:"开启动画",value:!0,type:"boolean"},{name:"entranceTime",displayName:"入场时间(s)",value:0},{rule:[["open","$eq",!0]],name:"type",displayName:"动画类型",type:"radio",value:"rotate",config:{options:[{name:"环绕",value:"rotate"},{name:"多点巡航",value:"fly"}]}},{rule:[["open","$eq",!1]],name:"defaultCamera",displayName:"镜头视角",type:"camera",template:{zoom:12,bearing:40,pitch:60,center:[120.158,30.262]},value:{zoom:12,bearing:40,pitch:60,center:[120.158,30.262]}},{rule:[["open","$eq",!0],["type","$eq","rotate"]],name:"rotateCamera",displayName:"镜头视角",type:"camera",template:{time:1,zoom:12,bearing:40,pitch:60,center:[120.158,30.262]},value:{zoom:12,bearing:40,pitch:60,center:[120.158,30.262]}},{rule:[["open","$eq",!0],["type","$eq","rotate"]],name:"speed",displayName:"环绕速度",value:10},{rule:[["open","$eq",!0],["type","$eq","fly"]],type:"cameras",name:"flyCameras",value:[{id:1,time:1,zoom:16,bearing:40,pitch:60,center:[120.158,30.262]},{id:2,time:1,zoom:16,bearing:40,pitch:60,center:[120.158,30.268]}],config:{template:{time:1,zoom:16,bearing:40,pitch:60,center:[121.488935,31.241675]},min:2}},{rule:[["open","$eq",!0],["type","$eq","fly"]],name:"loop",displayName:"循环播放",value:!0,type:"boolean"},{rule:[["open","$eq",!0]],name:"previewAction",displayName:"动画预览",type:"previewAction"}]}},value:[{name:"scene_npt3hl0r1",displayName:"场景",type:"object",value:[{name:"open",displayName:"开启动画",value:!0,type:"boolean"},{name:"entranceTime",displayName:"入场时间(s)",value:0},{rule:[["open","$eq",!0]],name:"type",displayName:"动画类型",type:"radio",value:"rotate",config:{options:[{name:"环绕",value:"rotate"},{name:"多点巡航",value:"fly"}]}},{rule:[["open","$eq",!1]],name:"defaultCamera",displayName:"镜头视角",type:"camera",template:{zoom:12,bearing:40,pitch:60,center:[120.158,30.262]},value:{center:[121.15090990914359,30.031499573669777],zoom:15,pitch:70,bearing:119.99999999999999}},{rule:[["open","$eq",!0],["type","$eq","rotate"]],name:"rotateCamera",displayName:"镜头视角",type:"camera",template:{time:1,zoom:12,bearing:40,pitch:60,center:[120.158,30.262]},value:{center:[121.13202381603844,30.031685915607994],zoom:15.952115057359578,pitch:80,bearing:-175.10000000001918}},{rule:[["open","$eq",!0],["type","$eq","rotate"]],name:"speed",displayName:"环绕速度",value:10},{rule:[["open","$eq",!0],["type","$eq","fly"]],type:"cameras",name:"flyCameras",value:[{id:1,time:1,zoom:16,bearing:40,pitch:60,center:[120.158,30.262]},{id:2,time:1,zoom:16,bearing:40,pitch:60,center:[120.158,30.268]}],config:{template:{time:1,zoom:16,bearing:40,pitch:60,center:[121.488935,31.241675]},min:2}},{rule:[["open","$eq",!0],["type","$eq","fly"]],name:"loop",displayName:"循环播放",value:!0,type:"boolean"},{rule:[["open","$eq",!0]],name:"previewAction",displayName:"动画预览",type:"previewAction"}]}]},{name:"position",displayName:"视角信息",defaultOpen:!0,value:[{name:"center",displayName:"中心点",value:[{name:"lng",displayName:"经度",value:121.1534},{name:"lat",displayName:"纬度",value:30.03867}]},{name:"zoom",displayName:"缩放",value:10}]}]},{name:"children",displayName:"子组件",value:[{name:"component",displayName:"管理",value:[{name:"list",displayName:"",value:[{label:"方向光",name:"directionalLight"},{label:"3D建筑",name:"building"},{label:"自定义模型",name:"customModel"},{label:"飞线",name:"flyLine"},{label:"围栏",name:"fence"},{label:"流光",name:"streamer"},{label:"信息面板",name:"infoPanel"}],type:"children",children:[{name:"标牌",value:"billboard"},{name:"3D建筑",value:"building"},{name:"自定义模型",value:"customModel"},{name:"方向光",value:"directionalLight"},{name:"围栏",value:"fence"},{name:"飞线",value:"flyLine"},{name:"热力",value:"heat"},{name:"图片层",value:"imageLayer"},{name:"信息面板",value:"infoPanel"},{name:"点标记",value:"point"},{name:"流光",value:"streamer"}]}]}]}],actions:[{name:"切换场景",value:"animateScene",config:[{name:"sceneId",displayName:"场景id",value:"",type:"select",config:{options:[{name:"场景1",value:"scene"}]}}]}]}},Ra.getDefaultData=function(){return{data:[],fields:[]}},Ra.getDefaultChildrenConfig=function(){return[{id:"9bb9a521956a3",base:{key:"__billboard__IoJs4l7",name:"标牌",module_name:"billboard",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[13,20],config:{min:0,max:20,step:.1,suffix:"",prefix:""}},{type:"number",name:"altitude",displayName:"抬升高度",value:0},{name:"depthTest",displayName:"自动排序",value:!0,type:"boolean"},{rule:[["depthTest","$eq",!1]],name:"renderOrder",displayName:"层级序号",tip:"数值大的物体会遮盖数值小的物体",value:0}]},{name:"styleConfig",displayName:"样式配置",type:"menu",value:[{name:"backStyle",displayName:"背景样式",value:[{name:"url",displayName:"图片上传",value:"data/8872/67152/img/a7dGKG_S2_1605010191717__vumPwMs8Y.png",type:"image"},{name:"scale",displayName:"缩放比例",value:.01},{type:"group",name:"size",displayName:"尺寸",value:[{name:"width",displayName:"宽度",value:600,type:"number",config:{span:12}},{name:"height",displayName:"高度",value:400,type:"number",config:{span:12}}]},{type:"position",name:"center",displayName:"基准点",value:[.5,1],tip:"标牌背景与定位点经纬度的位置关系"}]},{name:"contentStyle",displayName:"内容样式",value:[{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"Mircosoft Yahei",config:{span:16}},{name:"fontSize",displayName:"",value:42,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]},{name:"textAlign",displayName:"水平对齐",value:"center",type:"radio",config:{options:[{name:"左对齐",value:"left",icon:"align-left"},{name:"居中对齐",value:"center",icon:"align-center"},{name:"右对齐",value:"right",icon:"align-right"}],mode:"icon"}},{type:"group",name:"offset",displayName:"偏移",value:[{name:"x",displayName:"X",value:0,type:"number",config:{span:12}},{name:"y",displayName:"Y",value:130,type:"number",config:{span:12}}]}]}]},{name:"animateConfig",displayName:"动画配置",value:[{name:"drill",displayName:"聚焦",value:[{name:"show",displayName:"显示",value:!0,type:"boolean"},{name:"duration",displayName:"时长",value:1e3}]}]},{name:"interaction",displayName:"交互",value:[{name:"callback",displayName:"回调参数",type:"array",value:[],config:{template:{name:"callback",displayName:"回调",type:"object",value:[{type:"select",name:"action",displayName:"匹配动作",value:"click",config:{options:[{name:"鼠标点击",value:"click"}]}},{name:"origin",displayName:"字段值",type:"input",value:""},{name:"target",displayName:"变量名",type:"input",value:"",config:{callback:!0}}]}}}]}],triggers:[{name:"鼠标点击",value:"click"}]},{id:"14291e1c7ed0e",base:{key:"__building__IcJb2l6",name:"3D建筑",module_name:"building",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[0,20],config:{min:0,max:20,step:.1,suffix:"",prefix:""}},{type:"number",name:"altitude",displayName:"抬升高度",value:0},{name:"depthTest",displayName:"自动排序",value:!0,type:"boolean"},{rule:[["depthTest","$eq",!1]],name:"renderOrder",displayName:"层级序号",tip:"数值大的物体会遮盖数值小的物体",value:0}]},{name:"styleConfig",displayName:"样式配置",value:[{name:"bloom",displayName:"辉光",value:!1,tip:"主体组件开启辉光时才有效",type:"boolean"},{name:"url",displayName:"数据",value:"data/12147/638535/model/o82h5h5ylt_1639452546097_p8w54pp6ea.geojson",type:"model",tip:"组件会优先使用数据面板中配置的数据，未配置数据面板中的数据时使用此处数据"},{name:"floorField",displayName:"层高字段",value:"height",type:"input"},{name:"itemHeight",displayName:"每层高度",value:1},{type:"radio",name:"styleType",displayName:"样式类别",value:"default",config:{options:[{name:"默认",value:"default"},{name:"自定义",value:"custom"}]}},{rule:[["styleType","$eq","default"]],type:"selectCard",name:"styleName",displayName:"样式",value:"style4",config:{options:[{name:"落日黄",value:"style1",cover:"https://easyv-develop.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/building/落日黄.png"},{name:"薄荷绿",value:"style2",cover:"https://easyv-develop.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/building/薄荷绿.png"},{name:"浅色",value:"style3",cover:"https://easyv-develop.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/building/浅色.png"},{name:"蓝绿",value:"style4",cover:"https://easyv-develop.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/building/蓝绿.png"}]}},{rule:[["styleType","$eq","custom"]],type:"array",name:"serises",displayName:"样式配置",config:{template:{type:"object",name:"serise",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:0,config:{span:12}},{type:"number",name:"max",displayName:"<",value:10,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:0,color:"rgba(255, 221, 0, 1)"},{offset:100,color:"rgba(255, 110, 0, 1)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"rgba(255, 185, 0, 1)"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"#fff",type:"color"}]}]}},value:[{type:"object",name:"serise_ca757t25kw8",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:0,config:{span:12}},{type:"number",name:"max",displayName:"<",value:100,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:100,color:"RGBA(63,70,83,0.4)"},{offset:0,color:"RGBA(17,20,25,0.1)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"#747d8e"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]},{type:"object",name:"serise_199elh3ar",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:100,config:{span:12}},{type:"number",name:"max",displayName:"<",value:500,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:98.66666666666667,color:"RGBA(47,86,113,0.4)"},{offset:0,color:"RGBA(93,152,217,0.8)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"#bedff3"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]}]},{rule:[["defaultStyle","$eq","此处不显示，仅用于配置提取"]],name:"defaultStyle",displayName:"默认样式",value:[{name:"style1",displayName:"落日黄",value:[{type:"object",name:"serise_ca757t25kw8",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:0,config:{span:12}},{type:"number",name:"max",displayName:"<",value:100,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:100,color:"RGBA(70,70,70,0.5)"},{offset:0,color:"RGBA(63,63,57,0)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"RGBA(196,202,204,0.46)"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]},{type:"object",name:"serise_199elh3ar",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:100,config:{span:12}},{type:"number",name:"max",displayName:"<",value:180,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:100,color:"RGBA(172,77,3,0.92)"},{offset:0,color:"RGBA(31,66,90,0.08)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"#fcbf80"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]},{type:"object",name:"serise_b1i7i046mr",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:180,config:{span:12}},{type:"number",name:"max",displayName:"<",value:500,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:100,color:"RGBA(255,46,0,0.94)"},{offset:0,color:"RGBA(36,50,59,0.08)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"#fc8d67"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]}]},{name:"style2",displayName:"薄荷绿",value:[{type:"object",name:"serise_ca757t25kw8",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:0,config:{span:12}},{type:"number",name:"max",displayName:"<",value:100,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:100,color:"RGBA(38,65,76,0.53)"},{offset:0,color:"RGBA(19,44,61,0.1)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"RGBA(70,114,136,0.5)"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]},{type:"object",name:"serise_199elh3ar",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:100,config:{span:12}},{type:"number",name:"max",displayName:"<",value:500,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:100,color:"RGBA(109,220,255,0.92)"},{offset:0,color:"RGBA(31,66,90,0.08)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"#c5f6ff"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]}]},{name:"style3",displayName:"浅色",value:[{type:"object",name:"serise_ca757t25kw8",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:0,config:{span:12}},{type:"number",name:"max",displayName:"<",value:100,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:100,color:"RGBA(32,56,75,0.88)"},{offset:0,color:"RGBA(58,65,70,0.1)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"#8a979e"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]},{type:"object",name:"serise_199elh3ar",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:100,config:{span:12}},{type:"number",name:"max",displayName:"<",value:500,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:100,color:"RGBA(15,34,48,0.88)"},{offset:0,color:"RGBA(26,42,53,0.08)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"#bedff3"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]}]},{name:"style4",displayName:"蓝绿",value:[{type:"object",name:"serise_ca757t25kw8",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:0,config:{span:12}},{type:"number",name:"max",displayName:"<",value:100,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:100,color:"RGBA(63,70,83,0.4)"},{offset:0,color:"RGBA(17,20,25,0.1)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"#747d8e"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]},{type:"object",name:"serise_199elh3ar",displayName:"样式",value:[{type:"group",name:"floorRange",displayName:"层数范围",value:[{type:"number",name:"min",displayName:">=",value:100,config:{span:12}},{type:"number",name:"max",displayName:"<",value:500,config:{span:12}}]},{name:"sideConfig",displayName:"侧边",value:[{name:"uvType",displayName:"uv类型",value:"default",type:"radio",config:{options:[{name:"默认",value:"default"},{name:"实际尺寸",value:"trueSize"}]}},{rule:[["uvType","$eq","trueSize"]],name:"mapTrueSize",displayName:"尺寸",tip:"纹理对应现实世界的实际尺寸",value:80},{name:"fillType",displayName:"填充方式",value:"gradient",type:"select",config:{options:[{name:"颜色",value:"gradient"},{name:"材质贴图",value:"pattern"}]}},{rule:[["fillType","$eq","gradient"]],type:"group",name:"color",displayName:"颜色",value:[{name:"rangeColor",displayName:"顶部颜色 -> 底部颜色",type:"rangeColor",value:[{offset:98.66666666666667,color:"RGBA(47,86,113,0.4)"},{offset:0,color:"RGBA(93,152,217,0.8)"}]}]},{rule:[["fillType","$eq","pattern"]],name:"map",displayName:"材质贴图",value:"data/8872/79590/img/M9CzMHn1o_1606977590273_n70azwN6jP.png",type:"uploadImage"}]},{name:"topConfig",displayName:"顶部",value:[{name:"color",displayName:"颜色",type:"color",value:"#bedff3"},{name:"offset_s",displayName:"内凹",value:0},{name:"offset_h",displayName:"沉降",value:0}]},{name:"wireConfig",displayName:"线框",value:[{name:"show",displayName:"显示",value:!1,type:"boolean"},{name:"color",displayName:"颜色",value:"RGBA(255,255,255,0.4)",type:"color"}]}]}]}]}]}],triggers:[{name:"鼠标点击",value:"click"}]},{id:"b16f3e7dff851",base:{key:"__customModel__IcAb5l6",name:"自定义模型",module_name:"customModel",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[0,20],config:{min:0,max:20,step:.1,suffix:"",prefix:""}},{type:"number",name:"altitude",displayName:"抬升高度",value:0}]},{name:"styleConfig",displayName:"样式配置",value:[{name:"bloom",displayName:"辉光",value:!0,tip:"主体组件开启辉光时才有效",type:"boolean"},{type:"radio",name:"type",displayName:"模型格式",value:"glb",config:{options:[{name:"GLB",value:"glb"},{name:"GLTF",value:"gltf"}],mode:"button"}},{rule:[["type","$eq","glb"]],type:"model",name:"glb",displayName:"模型文件",value:"data/12147/707885/model/v8gbm5o34c_1641978978236_tzi0b52aai.glb"},{rule:[["type","$eq","gltf"]],type:"folder",name:"gltf",tip:"上传含gltf模型文件的压缩包，上传后选择后缀为gltf的文件",displayName:"模型文件",value:'{\n\t\t\t\t\t\t"entry": "components/static-image/smartCity3D2/model/gltf/DamagedHelmet.gltf",\n\t\t\t\t\t\t"options": [\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/DamagedHelmet.gltf",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/DamagedHelmet.bin",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_AO.jpg",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_albedo.jpg",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_emissive.jpg",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_metalRoughness.jpg",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_normal.jpg"\n\t\t\t\t\t\t]\n\t\t\t\t\t}'},{rule:[["type","$eq","fbx"]],type:"folder",name:"fbx",tip:"上传含gltf模型文件的压缩包，上传后选择后缀为gltf的文件",displayName:"模型文件",value:'{\n\t\t\t\t\t\t"entry": "components/static-image/smartCity3D2/model/fbx/DamagedHelmet.gltf",\n\t\t\t\t\t\t"options": [\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/DamagedHelmet.gltf",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/DamagedHelmet.bin",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_AO.jpg",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_albedo.jpg",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_emissive.jpg",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_metalRoughness.jpg",\n\t\t\t\t\t\t\t"components/static-image/smartCity3D2/model/gltf/Default_normal.jpg"\n\t\t\t\t\t\t]\n\t\t\t\t\t}'}]},{name:"modelConfig",displayName:"模型调试",type:"modal",value:[{name:"position",displayName:"定位",config:{defaultOpen:!0},value:[{name:"lng",displayName:"经度",value:121.13266000029637},{name:"lat",displayName:"纬度",value:30.038309608516755},{name:"height",displayName:"高度",value:0}]},{name:"rotation",displayName:"旋转",type:"group",value:[{name:"x",displayName:"x",value:0,config:{span:8,showStep:!1,suffix:"°"}},{name:"y",displayName:"y",value:0,config:{span:8,showStep:!1,suffix:"°"}},{name:"z",displayName:"z",value:180,config:{span:8,showStep:!1,suffix:"°"}}]},{name:"scale",displayName:"缩放",type:"group",value:[{name:"x",displayName:"x",value:.3,config:{span:8,showStep:!1}},{name:"y",displayName:"y",value:.3,config:{span:8,showStep:!1}},{name:"z",displayName:"z",value:.32,config:{span:8,showStep:!1}}]}]},{name:"interaction",displayName:"交互",value:[{name:"callback",displayName:"回调参数",type:"array",value:[],config:{template:{name:"callback",displayName:"回调",type:"object",value:[{type:"select",name:"action",displayName:"匹配动作",value:"click",config:{options:[{name:"鼠标点击",value:"click"}]}},{name:"origin",displayName:"字段值",type:"input",value:""},{name:"target",displayName:"变量名",type:"input",value:"",config:{callback:!0}}]}}}]}],triggers:[{name:"鼠标点击",value:"click"}]},{id:"94d944633e6d1",base:{key:"__directionalLight__IaAb5l6",name:"方向光",module_name:"directionalLight",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"modalConfig",displayName:"光照调试",type:"modal",value:[{name:"baseConfig",displayName:"样式配置",config:{layout:"horizontal"},value:[{name:"color",displayName:"颜色",value:"#49a3fa",type:"color"},{name:"intensity",displayName:"强度",value:2}]},{name:"direction",displayName:"方向配置",config:{defaultOpen:!0},value:[{name:"position",displayName:"光源",config:{defaultOpen:!0},value:[{name:"lng",displayName:"经度",value:121.15194197684775},{name:"lat",displayName:"纬度",value:30.036862681982342},{name:"height",displayName:"高度",value:583.6763636189061}]},{name:"target",displayName:"目标",config:{defaultOpen:!0},value:[{name:"lng",displayName:"经度",value:120.16275106631929},{name:"lat",displayName:"纬度",value:30.268777803582196},{name:"height",displayName:"高度",value:322.65980399937644}]}]}]}]},{id:"0bc38c5cebc97",base:{key:"__fence__WcAt4l3",name:"围栏",module_name:"fence",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[0,20],config:{min:0,max:20,step:.1,suffix:"",prefix:""}},{type:"number",name:"altitude",displayName:"抬升高度",value:0},{name:"depthTest",displayName:"自动排序",value:!0,type:"boolean"},{rule:[["depthTest","$eq",!1]],name:"renderOrder",displayName:"层级序号",tip:"数值大的物体会遮盖数值小的物体",value:0}]},{name:"styleConfig",displayName:"样式配置",value:[{name:"bloom",displayName:"辉光",value:!1,type:"boolean",tip:"主体组件开启辉光时才有效"},{type:"model",name:"url",displayName:"数据",value:"data/12147/638535/model/y9ifgkfyzi_1640937098251_yrilsifh57.geojson",tip:"数据格式为 geojson，类型为面/区域（组件优先使用数据面板中配置的数据，未配置数据面板中的数据时使用此处数据）"},{type:"number",name:"height",displayName:"高度",value:40},{type:"radio",name:"styleType",displayName:"样式类别",value:"default",config:{options:[{name:"默认",value:"default"},{name:"自定义",value:"custom"}],mode:"normal"}},{rule:[["styleType","$eq","custom"]],type:"radio",name:"fillType",displayName:"填充方式",value:"color",config:{options:[{name:"颜色",value:"color"},{name:"视频",value:"video"}],mode:"normal"}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"colors",displayName:"颜色",type:"multicolor",value:{type:"linear",pure:"#e93b3b",linear:{stops:[{offset:0,color:"RGBA(17,208,255,0.6)"},{offset:100,color:"RGBA(29,100,120,0)"}],angle:0,opacity:1}}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"animationConfig",displayName:"动画",value:[{type:"boolean",name:"show",displayName:"启用",value:!0},{type:"color",name:"lineColor",displayName:"条形颜色",value:"#64c8f5"},{type:"range",name:"lineHeight",displayName:"条形占比",value:.04,config:{min:0,max:1,step:.01}},{type:"number",name:"speed",displayName:"速度",value:10}]},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"video",name:"video",displayName:"视频",value:"data/10122/712823/video/jbhwzvu80l_1642063201162_iot592a03i.webm"},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"number",name:"width",displayName:"宽度",value:2},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"boolean",name:"wire",displayName:"线框",value:!1},{rule:[["styleType","$eq","default"]],type:"selectCard",name:"styles",displayName:"样式",value:"style2",config:{options:[{name:"样式1",value:"style1",cover:"https://easyv-develop.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/fence/style1.png"},{name:"样式2",value:"style2",cover:"https://easyv-develop.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/fence/style2.png"},{name:"样式3",value:"style3",cover:"https://easyv-develop.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/fence/style3.png"},{name:"样式4",value:"style4",cover:"https://easyv-develop.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/fence/style4.png"}],placeholder:"请选择",allowInput:!0}},{rule:[["defaultStyle","$eq","此处不显示，仅用于配置提取"]],name:"defaultStyle",value:[{name:"style1",displayName:"样式1",value:[{name:"bloom",displayName:"辉光",value:!1,type:"boolean",tip:"主体组件开启辉光时才有效"},{type:"model",name:"url",displayName:"数据",value:"data/10122/712823/model/xtwzzogh9p_1642062062833_q7ehasvpag.geojson",tip:"数据格式为 geojson，类型为面/区域（组件优先使用数据面板中配置的数据，未配置数据面板中的数据时使用此处数据）"},{type:"number",name:"height",displayName:"高度",value:40},{type:"radio",name:"styleType",displayName:"样式类别",value:"custom",config:{options:[{name:"默认",value:"default"},{name:"自定义",value:"custom"}],mode:"normal"}},{rule:[["styleType","$eq","custom"]],type:"radio",name:"fillType",displayName:"填充方式",value:"color",config:{options:[{name:"颜色",value:"color"},{name:"视频",value:"video"}],mode:"normal"}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"colors",displayName:"颜色",type:"multicolor",value:{type:"linear",pure:"#e93b3b",linear:{stops:[{offset:0,color:"RGBA(53,148,255,0.6)"},{offset:98.5498888643171,color:"RGBA(61,78,83,0)"}],angle:0,opacity:1}}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"animationConfig",displayName:"动画",value:[{type:"boolean",name:"show",displayName:"启用",value:!0},{type:"color",name:"lineColor",displayName:"条形颜色",value:"#64a9f5"},{type:"range",name:"lineHeight",displayName:"条形占比",value:.04,config:{min:0,max:1,step:.01}},{type:"number",name:"speed",displayName:"速度",value:10}]},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"video",name:"video",displayName:"视频",value:"data/12147/638535/video/5bru9bptku_1641368757299_7yiyw859qt.webm"},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"number",name:"width",displayName:"宽度",value:10},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"boolean",name:"wire",displayName:"线框",value:!1},{rule:[["styleType","$eq","default"]],type:"selectCard",name:"styles",displayName:"样式",value:"style1",config:{options:[{name:"样式1",value:"style1",cover:"template/S4NcbB0Ie_1600333577795_qposcvVE59.jpg"},{name:"样式2",value:"style2",cover:"template/S4NcbB0Ie_1600333577795_qposcvVE59.jpg"}],placeholder:"请选择",allowInput:!0}}]},{name:"style2",displayName:"样式2",value:[{name:"bloom",displayName:"辉光",value:!1,type:"boolean",tip:"主体组件开启辉光时才有效"},{type:"model",name:"url",displayName:"数据",value:"data/10122/712823/model/xtwzzogh9p_1642062062833_q7ehasvpag.geojson",tip:"数据格式为 geojson，类型为面/区域（组件优先使用数据面板中配置的数据，未配置数据面板中的数据时使用此处数据）"},{type:"number",name:"height",displayName:"高度",value:40},{type:"radio",name:"styleType",displayName:"样式类别",value:"custom",config:{options:[{name:"默认",value:"default"},{name:"自定义",value:"custom"}],mode:"normal"}},{rule:[["styleType","$eq","custom"]],type:"radio",name:"fillType",displayName:"填充方式",value:"color",config:{options:[{name:"颜色",value:"color"},{name:"视频",value:"video"}],mode:"normal"}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"colors",displayName:"颜色",type:"multicolor",value:{type:"linear",pure:"#e93b3b",linear:{stops:[{offset:0,color:"RGBA(17,208,255,0.6)"},{offset:98.5498888643171,color:"RGBA(29,100,120,0)"}],angle:0,opacity:1}}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"animationConfig",displayName:"动画",value:[{type:"boolean",name:"show",displayName:"启用",value:!0},{type:"color",name:"lineColor",displayName:"条形颜色",value:"#64c8f5"},{type:"range",name:"lineHeight",displayName:"条形占比",value:.04,config:{min:0,max:1,step:.01}},{type:"number",name:"speed",displayName:"速度",value:10}]},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"video",name:"video",displayName:"视频",value:"data/12147/638535/video/5bru9bptku_1641368757299_7yiyw859qt.webm"},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"number",name:"width",displayName:"宽度",value:10},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"boolean",name:"wire",displayName:"线框",value:!1},{rule:[["styleType","$eq","default"]],type:"selectCard",name:"styles",displayName:"样式",value:"style1",config:{options:[{name:"样式1",value:"style1",cover:"template/S4NcbB0Ie_1600333577795_qposcvVE59.jpg"},{name:"样式2",value:"style2",cover:"template/S4NcbB0Ie_1600333577795_qposcvVE59.jpg"}],placeholder:"请选择",allowInput:!0}}]},{name:"style3",displayName:"样式3",value:[{name:"bloom",displayName:"辉光",value:!1,type:"boolean",tip:"主体组件开启辉光时才有效"},{type:"model",name:"url",displayName:"数据",value:"data/10122/712823/model/xtwzzogh9p_1642062062833_q7ehasvpag.geojson",tip:"数据格式为 geojson，类型为面/区域（组件优先使用数据面板中配置的数据，未配置数据面板中的数据时使用此处数据）"},{type:"number",name:"height",displayName:"高度",value:40},{type:"radio",name:"styleType",displayName:"样式类别",value:"custom",config:{options:[{name:"默认",value:"default"},{name:"自定义",value:"custom"}],mode:"normal"}},{rule:[["styleType","$eq","custom"]],type:"radio",name:"fillType",displayName:"填充方式",value:"video",config:{options:[{name:"颜色",value:"color"},{name:"视频",value:"video"}],mode:"normal"}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"colors",displayName:"颜色",type:"multicolor",value:{type:"linear",pure:"#e93b3b",linear:{stops:[{offset:0,color:"RGBA(53,148,255,0.6)"},{offset:98.5498888643171,color:"RGBA(61,78,83,0)"}],angle:0,opacity:1}}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"animationConfig",displayName:"动画",value:[{type:"boolean",name:"show",displayName:"启用",value:!0},{type:"color",name:"lineColor",displayName:"条形颜色",value:"#64a9f5"},{type:"range",name:"lineHeight",displayName:"条形占比",value:.04,config:{min:0,max:1,step:.01}},{type:"number",name:"speed",displayName:"速度",value:10}]},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"video",name:"video",displayName:"视频",value:"data/12147/638535/video/5bru9bptku_1641368757299_7yiyw859qt.webm"},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"number",name:"width",displayName:"宽度",value:10},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"boolean",name:"wire",displayName:"线框",value:!1},{rule:[["styleType","$eq","default"]],type:"selectCard",name:"styles",displayName:"样式",value:"style1",config:{options:[{name:"样式1",value:"style1",cover:"template/S4NcbB0Ie_1600333577795_qposcvVE59.jpg"},{name:"样式2",value:"style2",cover:"template/S4NcbB0Ie_1600333577795_qposcvVE59.jpg"}],placeholder:"请选择",allowInput:!0}}]},{name:"style4",displayName:"样式4",value:[{name:"bloom",displayName:"辉光",value:!1,type:"boolean",tip:"主体组件开启辉光时才有效"},{type:"model",name:"url",displayName:"数据",value:"data/10122/712823/model/xtwzzogh9p_1642062062833_q7ehasvpag.geojson",tip:"数据格式为 geojson，类型为面/区域（组件优先使用数据面板中配置的数据，未配置数据面板中的数据时使用此处数据）"},{type:"number",name:"height",displayName:"高度",value:40},{type:"radio",name:"styleType",displayName:"样式类别",value:"custom",config:{options:[{name:"默认",value:"default"},{name:"自定义",value:"custom"}],mode:"normal"}},{rule:[["styleType","$eq","custom"]],type:"radio",name:"fillType",displayName:"填充方式",value:"video",config:{options:[{name:"颜色",value:"color"},{name:"视频",value:"video"}],mode:"normal"}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"colors",displayName:"颜色",type:"multicolor",value:{type:"linear",pure:"#e93b3b",linear:{stops:[{offset:0,color:"RGBA(17,208,255,0.6)"},{offset:98.5498888643171,color:"RGBA(29,100,120,0)"}],angle:0,opacity:1}}},{rule:[["styleType","$eq","custom"],["fillType","$eq","color"]],name:"animationConfig",displayName:"动画",value:[{type:"boolean",name:"show",displayName:"启用",value:!0},{type:"color",name:"lineColor",displayName:"条形颜色",value:"#64c8f5"},{type:"range",name:"lineHeight",displayName:"条形占比",value:.04,config:{min:0,max:1,step:.01}},{type:"number",name:"speed",displayName:"速度",value:10}]},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"video",name:"video",displayName:"视频",value:"data/10122/712823/video/jbhwzvu80l_1642063201162_iot592a03i.webm"},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"number",name:"width",displayName:"宽度",value:10},{rule:[["styleType","$eq","custom"],["fillType","$eq","video"]],type:"boolean",name:"wire",displayName:"线框",value:!1},{rule:[["styleType","$eq","default"]],type:"selectCard",name:"styles",displayName:"样式",value:"style1",config:{options:[{name:"样式1",value:"style1",cover:"template/S4NcbB0Ie_1600333577795_qposcvVE59.jpg"},{name:"样式2",value:"style2",cover:"template/S4NcbB0Ie_1600333577795_qposcvVE59.jpg"}],placeholder:"请选择",allowInput:!0}}]}]}]},{name:"interaction",displayName:"交互",value:[{name:"callback",displayName:"回调参数",type:"array",value:[],config:{template:{name:"callback",displayName:"回调",type:"object",value:[{type:"select",name:"action",displayName:"匹配动作",value:"click",config:{options:[{name:"鼠标点击",value:"click"}]}},{name:"origin",displayName:"字段值",type:"input",value:""},{name:"target",displayName:"变量名",type:"input",value:"",config:{callback:!0}}]}}}]}],triggers:[{name:"鼠标点击",value:"click"}]},{id:"96ce4813a99f4",base:{key:"__flyLine__WcAc2l1",name:"飞线",module_name:"flyLine",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[0,20],config:{min:0,max:20,step:.1,suffix:"",prefix:""}},{type:"number",name:"altitude",displayName:"抬升高度",value:0},{name:"depthTest",displayName:"自动排序",value:!0,type:"boolean"},{rule:[["depthTest","$eq",!1]],name:"renderOrder",displayName:"层级序号",tip:"数值大的物体会遮盖数值小的物体",value:0}]},{name:"styleConfig",displayName:"样式配置",value:[{type:"boolean",name:"bloom",displayName:"辉光",tip:"主体组件开启辉光时才有效",value:!1},{name:"lineConfig",displayName:"飞线样式",value:[{type:"range",name:"lineLength",displayName:"长度",value:.9,config:{min:0,max:1,step:.01}},{type:"number",name:"lineHeight",displayName:"最大高度",value:200},{type:"number",name:"lineWidth",displayName:"粗细",value:10},{name:"colors",displayName:"颜色",type:"multicolor",value:{type:"linear",pure:"#fff",linear:{stops:[{offset:0,color:"#ffc048"},{offset:100,color:"RGBA(255,251,233,0)"}],angle:0,opacity:1}}}]},{name:"backConfig",displayName:"底线样式",value:[{type:"boolean",name:"show",displayName:"",value:!1},{rule:[["show","$eq",!0]],type:"color",name:"color",displayName:"颜色",value:"rgba(206, 190, 78, 100)"}]}]},{name:"animateConfig",displayName:"动画",value:[{type:"number",name:"speed",displayName:"速度",value:10},{type:"number",name:"interval",displayName:"间隔",value:2,config:{suffix:"s"}},{name:"startRandom",displayName:"随机开始",value:!0,type:"boolean"}]},{name:"interaction",displayName:"交互",value:[{name:"callback",displayName:"回调参数",type:"array",value:[],config:{template:{name:"callback",displayName:"回调",type:"object",value:[{type:"select",name:"action",displayName:"匹配动作",value:"click",config:{options:[{name:"鼠标点击",value:"click"}]}},{name:"origin",displayName:"字段值",type:"input",value:""},{name:"target",displayName:"变量名",type:"input",value:"",config:{callback:!0}}]}}}]}],triggers:[{name:"鼠标点击",value:"click"}]},{id:"634893fc8a322",base:{key:"__heat__QwCt3l2",name:"热力",module_name:"heat",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[0,20],config:{min:0,max:20,step:.1,suffix:"",prefix:""}},{type:"number",name:"altitude",displayName:"抬升高度",value:0},{name:"depthTest",displayName:"自动排序",value:!0,type:"boolean"},{rule:[["depthTest","$eq",!1]],name:"renderOrder",displayName:"层级序号",tip:"数值大的物体会遮盖数值小的物体",value:0}]},{name:"showConfig",displayName:"样式配置",value:[{type:"number",name:"height",displayName:"最大高度",value:2e3},{type:"number",name:"radius",displayName:"半径",value:800},{type:"range",name:"blur",displayName:"模糊因子",value:1,config:{min:0,max:1,step:.1}},{type:"group",name:"valueRange",displayName:"数值范围",value:[{type:"select",name:"min",displayName:"",value:"valueMin",config:{options:[{name:"数据最小值",value:"valueMin"}],span:12,allowInput:!0}},{type:"select",name:"max",displayName:"",value:"valueMax",config:{options:[{name:"数据最大值",value:"valueMax"}],span:12,allowInput:!0}}]},{name:"colors",displayName:"颜色",type:"multicolor",value:{type:"linear",pure:"#fff",linear:{stops:[{offset:0,color:"#fded1c"},{offset:10,color:"#fff0d5"},{offset:40,color:"#05f7ff"},{offset:60,color:"#0080ff"},{offset:100,color:"rgba(0, 108, 255, 0.12)"}],angle:0,opacity:.7}}}]}]},{id:"9d8428d00513c",base:{key:"__imageLayer__CwAs4l3",name:"图片层",module_name:"imageLayer",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"GCJ02",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[0,15],config:{min:0,max:20,step:.1,suffix:"",prefix:""}}]},{name:"styleConfig",displayName:"样式配置",value:[{name:"url",displayName:"图片",value:"components/static-image/smartCity3D2/image/world.jpg",type:"image",tip:"组件会优先使用数据面板中配置的数据，未配置数据面板中的数据时使用此处数据"},{name:"bound",type:"group",displayName:"边界",value:[{name:"lngMin",displayName:"最小经度",value:120.151275,config:{span:12,showStep:!1}},{name:"latMin",displayName:"最小纬度",value:30.258151,config:{span:12,showStep:!1}},{name:"lngMax",displayName:"最大经度",value:120.152348,config:{span:12,showStep:!1}},{name:"latMax",displayName:"最大纬度",value:30.259337,config:{span:12,showStep:!1}}]},{name:"opacity",displayName:"透明度",type:"range",value:1,config:{min:0,max:1,step:.1}}]},{name:"interaction",displayName:"交互",value:[{name:"callback",displayName:"回调参数",type:"array",value:[],config:{template:{name:"callback",displayName:"回调",type:"object",value:[{type:"select",name:"action",displayName:"匹配动作",value:"click",config:{options:[{name:"鼠标点击",value:"click"}]}},{name:"origin",displayName:"字段值",type:"input",value:""},{name:"target",displayName:"变量名",type:"input",value:"",config:{callback:!0}}]}}}]}],triggers:[{name:"鼠标点击",value:"click"}]},{id:"8e844ae0911d1",base:{key:"__infoPanel__IcJs3l1",name:"信息面板",module_name:"infoPanel",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[0,20],config:{min:0,max:20,step:.1,suffix:"",prefix:""}},{type:"number",name:"altitude",displayName:"抬升高度",value:0},{name:"depthTest",displayName:"自动排序",value:!0,type:"boolean"},{rule:[["depthTest","$eq",!1]],name:"renderOrder",displayName:"层级序号",tip:"数值大的物体会遮盖数值小的物体",value:0}]},{name:"contentConfig",displayName:"内容样式",value:[{name:"lines",displayName:"行配置",type:"array",config:{defaultOpen:!0,template:{name:"line",displayName:"行",type:"object",value:[{type:"group",name:"mapping",displayName:"映射",value:[{name:"field",displayName:"字段名",value:"",type:"input",config:{span:12}},{name:"showName",displayName:"显示名",value:"",type:"input",config:{span:12}}]},{type:"group",name:"position",displayName:"位置",value:[{name:"x",displayName:"X",value:0,type:"number",config:{span:12}},{name:"y",displayName:"Y",value:0,type:"number",config:{span:12}}]},{name:"labelConfig",displayName:"标签样式",value:[{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"Mircosoft Yahei",config:{span:16}},{name:"fontSize",displayName:"",value:24,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]},{name:"paddingRight",displayName:"右边距",value:45,config:{}}]},{name:"valueConfig",displayName:"值样式",value:[{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"Mircosoft Yahei",config:{span:16}},{name:"fontSize",displayName:"",value:24,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]}]},{name:"suffixConfig",displayName:"后缀",value:[{type:"boolean",name:"show",displayName:"",value:!0},{type:"input",name:"content",displayName:"内容",value:""},{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"Mircosoft Yahei",config:{span:16}},{name:"fontSize",displayName:"",value:24,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]},{name:"paddingLeft",displayName:"左边距",value:45,config:{}}]}]}},value:[{name:"line1",displayName:"行",type:"object",value:[{type:"group",name:"mapping",displayName:"映射",value:[{name:"field",displayName:"字段名",value:"name",type:"input",config:{span:12}},{name:"showName",displayName:"显示名",value:"区域：",type:"input",config:{span:12}}]},{type:"group",name:"position",displayName:"位置",value:[{name:"x",displayName:"X",value:90,type:"number",config:{span:12}},{name:"y",displayName:"Y",value:120,type:"number",config:{span:12}}]},{name:"labelConfig",displayName:"标签样式",value:[{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"思源黑体 CN-Bold",config:{span:16}},{name:"fontSize",displayName:"",value:46,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]},{name:"paddingRight",displayName:"右边距",value:10,config:{}}]},{name:"valueConfig",displayName:"值样式",value:[{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"思源黑体 CN-Bold",config:{span:16}},{name:"fontSize",displayName:"",value:46,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]}]},{name:"suffixConfig",displayName:"后缀",value:[{type:"boolean",name:"show",displayName:"",value:!0},{type:"input",name:"content",displayName:"内容",value:""},{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"Mircosoft Yahei",config:{span:16}},{name:"fontSize",displayName:"",value:24,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]},{name:"paddingLeft",displayName:"左边距",value:45,config:{}}]}]},{name:"line2",displayName:"行",type:"object",value:[{type:"group",name:"mapping",displayName:"映射",value:[{name:"field",displayName:"字段名",value:"state",type:"input",config:{span:12}},{name:"showName",displayName:"显示名",value:"状态：",type:"input",config:{span:12}}]},{type:"group",name:"position",displayName:"位置",value:[{name:"x",displayName:"X",value:90,type:"number",config:{span:12}},{name:"y",displayName:"Y",value:200,type:"number",config:{span:12}}]},{name:"labelConfig",displayName:"标签样式",value:[{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"思源黑体 CN-Bold",config:{span:16}},{name:"fontSize",displayName:"",value:46,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]},{name:"paddingRight",displayName:"右边距",value:10,config:{}}]},{name:"valueConfig",displayName:"值样式",value:[{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"思源黑体 CN-Bold",config:{span:16}},{name:"fontSize",displayName:"",value:46,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]}]},{name:"suffixConfig",displayName:"后缀",value:[{type:"boolean",name:"show",displayName:"",value:!0},{type:"input",name:"content",displayName:"内容",value:""},{name:"simpleTextStyle",type:"group",displayName:"文本样式",value:[{type:"font",name:"fontFamily",displayName:"",value:"Mircosoft Yahei",config:{span:16}},{name:"fontSize",displayName:"",value:24,config:{span:8}},{type:"color",name:"color",displayName:"",value:"#fff"}]},{name:"paddingLeft",displayName:"左边距",value:45,config:{}}]}]}]}]},{name:"stateConfig",displayName:"状态背景",value:[{name:"states",displayName:"状态背景",type:"array",config:{defaultOpen:!0,template:{name:"state",displayName:"状态",value:[{name:"field",displayName:"状态值",type:"input",value:"state"},{name:"url",displayName:"图片上传",type:"image",value:""},{type:"group",name:"size",displayName:"尺寸",value:[{name:"width",displayName:"宽度",value:600,type:"number",config:{span:12}},{name:"height",displayName:"高度",value:400,type:"number",config:{span:12}}]},{type:"position",name:"center",displayName:"基准点",value:[.5,1],tip:"标牌背景与定位点经纬度的位置关系"}]}},value:[{name:"state1",displayName:"状态",value:[{name:"type",displayName:"状态值",type:"input",value:"正常"},{name:"url",displayName:"图片上传",type:"image",value:"data/8872/67152/img/a7dGKG_S2_1605010191717__vumPwMs8Y.png"},{type:"group",name:"size",displayName:"尺寸",value:[{name:"width",displayName:"宽度",value:600,type:"number",config:{span:12}},{name:"height",displayName:"高度",value:400,type:"number",config:{span:12}}]},{type:"position",name:"center",displayName:"基准点",value:[.5,1],tip:"标牌背景与定位点经纬度的位置关系"}]},{name:"state2",displayName:"状态",value:[{name:"type",displayName:"状态值",type:"input",value:"异常"},{name:"url",displayName:"图片上传",type:"image",value:"data/12147/638535/img/vdb5n2ooss_1639463481496_nn12u8dnak.png"},{type:"group",name:"size",displayName:"尺寸",value:[{name:"width",displayName:"宽度",value:600,type:"number",config:{span:12}},{name:"height",displayName:"高度",value:400,type:"number",config:{span:12}}]},{type:"position",name:"center",displayName:"基准点",value:[.5,1],tip:"标牌背景与定位点经纬度的位置关系"}]}]}]},{name:"interaction",displayName:"交互",value:[{name:"callback",displayName:"回调参数",type:"array",value:[],config:{template:{name:"callback",displayName:"回调",type:"object",value:[{type:"select",name:"action",displayName:"匹配动作",value:"click",config:{options:[{name:"鼠标点击",value:"click"}]}},{name:"origin",displayName:"字段值",type:"input",value:""},{name:"target",displayName:"变量名",type:"input",value:"",config:{callback:!0}}]}}}]}],triggers:[{name:"鼠标点击",value:"click"}]},{id:"a04f01669ed5e",base:{key:"__point__IoJa3l7",name:"点标记",module_name:"point",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[0,20],config:{min:0,max:20,step:.1,suffix:"",prefix:""}},{type:"number",name:"altitude",displayName:"抬升高度",value:0},{name:"depthTest",displayName:"自动排序",value:!0,type:"boolean"},{rule:[["depthTest","$eq",!1]],name:"renderOrder",displayName:"层级序号",tip:"数值大的物体会遮盖数值小的物体",value:0}]},{name:"styleConfig",displayName:"样式配置",value:[{type:"radio",name:"direct",displayName:"方向",value:"stand",config:{options:[{name:"水平",value:"land"},{name:"竖立",value:"stand"}],mode:"button"}},{rule:[["direct","$eq","stand"]],type:"boolean",name:"sprite",displayName:"始终面向镜头",value:!0},{rule:[["direct","$eq","stand"],["sprite","$eq",!1]],name:"rotate",displayName:"旋转角度",value:0},{type:"radio",name:"sizeMode",displayName:"尺寸模式",value:"screen",config:{options:[{name:"世界尺寸",value:"world"},{name:"屏幕尺寸",value:"screen"}],mode:"button"},tip:"世界尺寸随镜头深度改变，屏幕尺寸不随镜头深度改变"},{type:"group",name:"size",displayName:"尺寸类型",value:[{type:"radio",name:"sizeType",displayName:"",value:"fix",config:{options:[{name:"固定尺寸",value:"fix"},{name:"数据映射",value:"range"}],mode:"normal"}},{rule:[["sizeType","$eq","fix"]],type:"number",name:"fixValue",displayName:"",value:50},{rule:[["sizeType","$eq","range"]],type:"select",name:"rangeMin",displayName:"最小值",value:"valueMin",config:{options:[{name:"数据最小值",value:"valueMin"}],span:12,allowInput:!0}},{rule:[["sizeType","$eq","range"]],type:"select",name:"rangeMax",displayName:"最大值",value:"valueMax",config:{options:[{name:"数据最大值",value:"valueMax"}],span:12,allowInput:!0}}]},{type:"radio",name:"fillType",displayName:"填充类型",value:"color",config:{options:[{name:"矢量形状",value:"color"},{name:"图片",value:"image"},{name:"视频",value:"video"}],mode:"button"}},{rule:[["fillType","$eq","color"]],type:"radio",name:"shape",displayName:"形状",value:"triangle",config:{options:[{name:"三角",value:"triangle",icon:"triangle"},{name:"矩形",value:"rect",icon:"rect"},{name:"圆形",value:"circle",icon:"circle"}],mode:"icon"}},{rule:[["fillType","$eq","color"]],type:"color",name:"color",displayName:"颜色",value:"#ff0000"},{rule:[["fillType","$eq","image"]],type:"image",name:"image",displayName:"图片",value:"components/static-image/earth3DNew/point3.png"},{rule:[["fillType","$eq","video"]],type:"video",name:"video",displayName:"视频",value:"components/static-image/smartCity3D/地图大转盘.webm"}]},{name:"interaction",displayName:"交互",value:[{name:"callback",displayName:"回调参数",type:"array",value:[],config:{template:{name:"callback",displayName:"回调",type:"object",value:[{type:"select",name:"action",displayName:"匹配动作",value:"click",config:{options:[{name:"鼠标点击",value:"click"}]}},{name:"origin",displayName:"字段值",type:"input",value:""},{name:"target",displayName:"变量名",type:"input",value:"",config:{callback:!0}}]}}}]}],triggers:[{name:"鼠标点击",value:"click"}]},{id:"1777aa7379ed7",base:{key:"__streamer__Wawc2l1",name:"流光",module_name:"streamer",category:"辅助组件",version:"1.0.0",thumb:"",show:1},configuration:[{name:"baseConfig",displayName:"基础配置",config:{layout:"horizontal"},value:[{type:"radio",name:"system",displayName:"坐标系",value:"WGS84",config:{options:[{name:"WGS84",value:"WGS84"},{name:"GCJ02",value:"GCJ02"}],mode:"button"}},{type:"range",name:"showLevel",displayName:"可见级别",value:[0,20],config:{min:0,max:20,step:.1,suffix:"",prefix:""}},{type:"number",name:"altitude",displayName:"抬升高度",value:0},{name:"depthTest",displayName:"自动排序",value:!0,type:"boolean"},{rule:[["depthTest","$eq",!1]],name:"renderOrder",displayName:"层级序号",tip:"数值大的物体会遮盖数值小的物体",value:0}]},{name:"styleConfig",displayName:"样式配置",value:[{type:"boolean",name:"bloom",displayName:"辉光",tip:"主体组件开启辉光时才有效",value:!1},{type:"model",name:"url",displayName:"数据",value:"data/12147/638535/model/tx3zaeywg_1639462349801_w3nia612zn.geojson",tip:"数据格式为 geojson，类型为线（组件会优先使用数据面板中配置的数据，未配置数据面板中的数据时使用此处数据）"},{name:"lineConfig",displayName:"线样式",value:[{type:"range",name:"lineLength",displayName:"长度",value:.8,config:{min:0,max:1,step:.01}},{type:"number",name:"lineHeight",displayName:"最大高度",value:50},{type:"number",name:"lineWidth",displayName:"粗细",value:16},{name:"colors",displayName:"颜色",type:"multicolor",value:{type:"linear",pure:"#fff",linear:{stops:[{offset:0,color:"#ff6f3f"},{offset:100,color:"RGBA(236,227,62,0)"}],angle:0,opacity:1}}}]},{name:"backConfig",displayName:"底线样式",value:[{type:"boolean",name:"show",displayName:"",value:!1},{rule:[["show","$eq",!0]],type:"color",name:"color",displayName:"颜色",value:"rgba(206, 190, 78, 100)"}]}]},{name:"animateConfig",displayName:"动画",value:[{type:"number",name:"speed",displayName:"速度",value:8},{type:"number",name:"interval",displayName:"间隔",value:1,config:{suffix:"s"}},{name:"startRandom",displayName:"随机开始",value:!0,type:"boolean"}]}]}]},Ra.getDefaultChildrenData=function(){return[{data:[{name:"杭州嘉里中心",lng:120.158,lat:30.262,height:0,zoom:17},{name:"黄龙体育馆",lng:120.129,lat:30.269,height:0,zoom:17},{name:"西湖文化广场",lng:120.158,lat:30.28,height:0,zoom:17}],fields:[],id:"9bb9a521956a3"},{data:[{url:""}],fields:[{name:"url",value:"url",desc:"数据地址"}],id:"14291e1c7ed0e"},{data:[{id:1}],fields:[],id:"b16f3e7dff851"},{data:[{id:1}],fields:[],id:"94d944633e6d1"},{data:[],fields:[],id:"0bc38c5cebc97"},{data:[{startLng:121.130475,startLat:30.040064,endLng:121.138414,endLat:30.058213},{startLng:121.130475,startLat:30.040064,endLng:121.150142,endLat:30.018194},{startLng:121.130475,startLat:30.040064,endLng:121.16693,endLat:30.032512},{startLng:121.130475,startLat:30.040064,endLng:121.12106,endLat:30.034512}],fields:[{name:"startLng",value:"startLng",desc:"开始经度"},{name:"startLat",value:"startLat",desc:"结束纬度"},{name:"endLng",value:"endLng",desc:"开始经度"},{name:"endLat",value:"endLat",desc:"结束纬度"}],id:"96ce4813a99f4"},{data:[{lng:116.339362,lat:39.724042,value:100},{lng:123.504194,lat:43.52114,value:80},{lng:121.137429,lat:41.097683,value:50},{lng:123.323188,lat:41.417706,value:10},{lng:108.646282,lat:40.721718,value:76},{lng:125.329582,lat:46.410636,value:62},{lng:121.601698,lat:39.018619,value:32},{lng:121.532743,lat:38.860338,value:80},{lng:121.78076,lat:39.04809,value:10},{lng:125.145264,lat:42.901402,value:33},{lng:116.657118,lat:36.939804,value:60},{lng:104.057432,lat:30.674023,value:90},{lng:115.870889,lat:39.053455,value:95},{lng:111.70165,lat:41.522506,value:98},{lng:120.099913,lat:30.865839,value:23},{lng:116.292059,lat:39.817946,value:66},{lng:116.227996,lat:39.90506,value:88},{lng:112.566635,lat:37.865722,value:99},{lng:108.307045,lat:22.787902,value:50},{lng:121.425611,lat:31.180283,value:20},{lng:116.347479,lat:39.9071,value:18},{lng:111.679602,lat:40.846019,value:10},{lng:125.094824,lat:46.593936,value:1},{lng:122.172169,lat:37.422716,value:99},{lng:117.28933,lat:31.861992,value:88},{lng:122.827894,lat:41.994793,value:40},{lng:126.625255,lat:45.770159,value:60},{lng:127.109319,lat:46.440103,value:90},{lng:115.467197,lat:38.893683,value:80},{lng:105.666293,lat:38.833411,value:80},{lng:115.86392,lat:39.323538,value:80},{lng:116.846109,lat:40.373815,value:70},{lng:121.963882,lat:39.400762,value:90},{lng:114.49438,lat:36.61134,value:20},{lng:129.618026,lat:44.586399,value:60},{lng:116.340998,lat:39.731628,value:55},{lng:121.579443,lat:31.133919,value:34},{lng:121.482023,lat:31.23805,value:90},{lng:123.620154,lat:41.844007,value:80},{lng:123.344981,lat:41.803142,value:80},{lng:125.300852,lat:43.870351,value:40},{lng:114.48455,lat:38.04405,value:20},{lng:122.070973,lat:41.123676,value:30},{lng:131.00485,lat:45.771203,value:60},{lng:114.517395,lat:36.608954,value:50},{lng:116.670943,lat:39.908379,value:90},{lng:123.806879,lat:41.849382,value:80},{lng:121.492872,lat:31.184648,value:65},{lng:125.71194,lat:42.53574,value:66},{lng:109.969568,lat:39.819141,value:88},{lng:121.532724,lat:38.862515,value:99},{lng:116.280681,lat:39.911227,value:32},{lng:116.334921,lat:40.079066,value:56},{lng:117.15323,lat:38.903156,value:99},{lng:118.788774,lat:32.049346,value:40},{lng:111.735571,lat:40.836354,value:60},{lng:125.989524,lat:46.070877,value:44},{lng:121.425195,lat:31.172281,value:66},{lng:120.460944,lat:32.84657,value:55},{lng:127.104257,lat:46.440756,value:33},{lng:118.366384,lat:31.310879,value:20},{lng:117.350932,lat:38.365381,value:60},{lng:111.60427,lat:26.434827,value:40},{lng:116.412,lat:39.914967,value:50},{lng:111.466215,lat:27.320078,value:20},{lng:126.566819,lat:43.849729,value:10},{lng:106.56378,lat:29.526104,value:1},{lng:111.985122,lat:43.63984,value:1},{lng:105.973687,lat:31.577775,value:1},{lng:126.483804,lat:46.831892,value:1},{lng:87.259625,lat:44.015248,value:1},{lng:115.687475,lat:37.73053,value:1},{lng:118.117393,lat:24.471433,value:1},{lng:124.824829,lat:45.116115,value:1},{lng:114.006319,lat:22.733638,value:1},{lng:126.694425,lat:45.726527,value:1},{lng:113.344505,lat:23.123434,value:1},{lng:123.401978,lat:41.791284,value:1},{lng:81.671645,lat:36.85593,value:1},{lng:116.6468,lat:40.132487,value:1},{lng:118.355531,lat:34.527699,value:1},{lng:121.966453,lat:39.399619,value:1},{lng:112.978697,lat:28.19251,value:1},{lng:116.534278,lat:39.80107,value:1},{lng:116.731957,lat:24.720795,value:1},{lng:126.25115,lat:48.037239,value:1},{lng:114.344614,lat:30.586784,value:1},{lng:116.520746,lat:39.940198,value:1},{lng:117.850354,lat:25.693283,value:1},{lng:130.398787,lat:48.892923,value:1},{lng:114.321674,lat:30.364957,value:1},{lng:124.07229,lat:40.45884,value:1},{lng:114.300583,lat:30.547577,value:1},{lng:100.798852,lat:22.00249,value:1},{lng:116.640619,lat:39.906542,value:1},{lng:112.150747,lat:32.041325,value:1},{lng:116.666153,lat:39.883834,value:1},{lng:106.93653,lat:30.33507,value:1},{lng:122.365509,lat:40.403364,value:1},{lng:108.94334,lat:34.232124,value:1},{lng:114.01536,lat:34.721252,value:1},{lng:116.040676,lat:40.326879,value:1},{lng:113.038047,lat:22.519859,value:1},{lng:109.963339,lat:39.822507,value:1},{lng:113.627207,lat:28.158423,value:1},{lng:116.288183,lat:39.958263,value:1},{lng:108.76914,lat:36.822025,value:1},{lng:122.353119,lat:40.406072,value:1},{lng:103.843671,lat:36.052007,value:1},{lng:119.747162,lat:49.214012,value:1},{lng:115.892233,lat:28.676271,value:1},{lng:123.900367,lat:41.859985,value:1},{lng:100.5535,lat:25.472493,value:1},{lng:124.371017,lat:43.169384,value:1},{lng:115.589808,lat:32.634584,value:1},{lng:121.51388,lat:31.300404,value:1},{lng:87.516855,lat:43.838059,value:1},{lng:121.757621,lat:41.369826,value:1},{lng:125.939058,lat:41.7225,value:1},{lng:80.74716,lat:44.184077,value:1},{lng:122.069897,lat:41.158678,value:1},{lng:127.158254,lat:44.917229,value:1},{lng:126.806582,lat:42.3915,value:1},{lng:120.462758,lat:41.590669,value:1},{lng:124.89925,lat:46.601439,value:1},{lng:131.010253,lat:45.7728,value:1},{lng:120.03429,lat:36.256094,value:1},{lng:99.423821,lat:26.445785,value:1},{lng:102.734253,lat:25.081585,value:1},{lng:104.536171,lat:32.408316,value:1},{lng:116.505767,lat:40.035314,value:1},{lng:104.750396,lat:31.457849,value:1},{lng:112.556381,lat:37.818839,value:1},{lng:120.324637,lat:31.557511,value:1},{lng:118.703665,lat:41.928365,value:1},{lng:114.1207,lat:22.54708,value:1},{lng:120.092658,lat:43.879393,value:1},{lng:124.824035,lat:45.115764,value:1},{lng:117.179937,lat:39.135044,value:1},{lng:125.299533,lat:48.87669,value:1},{lng:116.185822,lat:39.763197,value:1},{lng:126.540966,lat:43.833445,value:1},{lng:113.864215,lat:22.57465,value:1},{lng:124.040746,lat:42.54465,value:1},{lng:113.218369,lat:33.971399,value:1},{lng:124.893707,lat:46.637432,value:1},{lng:121.578522,lat:31.256856,value:1},{lng:121.556182,lat:29.871856,value:1},{lng:125.293523,lat:43.872491,value:1},{lng:113.921491,lat:22.532768,value:1},{lng:121.514011,lat:31.14031,value:1},{lng:126.647462,lat:45.76184,value:1},{lng:126.625429,lat:45.742234,value:1},{lng:107.04393,lat:39.390117,value:1},{lng:115.464224,lat:38.456056,value:1},{lng:126.975657,lat:45.539109,value:1},{lng:121.60947,lat:38.930722,value:1},{lng:120.441691,lat:40.367574,value:1},{lng:116.358376,lat:39.850994,value:1},{lng:116.326726,lat:39.786505,value:1},{lng:108.320068,lat:22.815542,value:1},{lng:117.15323,lat:38.903156,value:1},{lng:116.35371,lat:40.009626,value:1},{lng:115.497509,lat:39.349398,value:1},{lng:123.508416,lat:43.514185,value:1},{lng:123.400614,lat:41.792633,value:1},{lng:123.779995,lat:41.289629,value:1},{lng:120.853284,lat:40.757815,value:1},{lng:126.666895,lat:45.7129,value:1},{lng:115.491279,lat:38.857851,value:1},{lng:115.984561,lat:39.699903,value:1},{lng:121.43613,lat:31.153806,value:1},{lng:121.783101,lat:39.059898,value:1},{lng:117.264531,lat:39.067224,value:33},{lng:112.694372,lat:22.363969,value:90},{lng:112.19491,lat:30.35138,value:90},{lng:117.197299,lat:39.126915,value:90},{lng:115.154511,lat:38.695736,value:1},{lng:116.188961,lat:39.908942,value:90},{lng:124.823036,lat:45.113947,value:100},{lng:111.958768,lat:21.848977,value:1},{lng:120.859617,lat:40.754347,value:90},{lng:114.47452,lat:38.04131,value:100},{lng:121.445134,lat:31.037495,value:1},{lng:117.065831,lat:38.83432,value:1},{lng:121.506007,lat:31.083023,value:50},{lng:131.225769,lat:45.257356,value:1},{lng:124.071833,lat:40.454184,value:1},{lng:121.278425,lat:31.386506,value:1},{lng:114.240166,lat:30.625578,value:100},{lng:123.958016,lat:47.342534,value:100},{lng:114.086225,lat:22.545679,value:100},{lng:113.123291,lat:36.197235,value:60},{lng:119.492404,lat:31.402682,value:50},{lng:125.319095,lat:43.891209,value:100},{lng:112.570732,lat:37.869263,value:100},{lng:104.742665,lat:31.463939,value:40},{lng:124.463417,lat:47.797626,value:100},{lng:115.323022,lat:38.42085,value:100},{lng:113.156322,lat:23.032312,value:20},{lng:123.469765,lat:41.802888,value:100},{lng:123.369594,lat:41.793154,value:1},{lng:113.664767,lat:34.766986,value:10},{lng:120.100617,lat:30.865842,value:1},{lng:113.373,lat:34.536138,value:1},{lng:127.484116,lat:42.175549,value:1},{lng:112.941049,lat:27.78016,value:80},{lng:118.311992,lat:29.709533,value:1},{lng:115.243365,lat:37.528638,value:70},{lng:114.196513,lat:36.688914,value:80},{lng:103.835482,lat:30.047892,value:1},{lng:122.06964,lat:41.127429,value:60},{lng:117.449588,lat:28.378044,value:1},{lng:108.31981,lat:22.817332,value:60},{lng:114.985784,lat:27.111114,value:1},{lng:117.241669,lat:39.117846,value:60},{lng:114.363958,lat:35.921147,value:1},{lng:116.60551,lat:35.40768,value:60},{lng:121.600767,lat:37.385351,value:60},{lng:116.096261,lat:39.943603,value:1},{lng:114.386667,lat:38.309229,value:1},{lng:116.141442,lat:39.728711,value:60},{lng:103.003707,lat:29.984718,value:1},{lng:117.07129,lat:39.37008,value:40},{lng:102.708621,lat:25.035939,value:50},{lng:117.68344,lat:36.210906,value:100},{lng:113.297241,lat:22.211096,value:1},{lng:115.716943,lat:39.571432,value:1},{lng:115.7182,lat:39.39175,value:1},{lng:116.22685,lat:39.905888,value:100},{lng:118.704956,lat:39.740176,value:100}],fields:[{name:"lng",value:"lng",desc:"经度"},{name:"lat",value:"lat",desc:"纬度"},{name:"value",value:"value",desc:"数值"}],id:"634893fc8a322"},{data:[{url:"https://easyv-test.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/area1.jpg",lngMin:120.13532148844196,latMin:30.254920182017155,lngMax:120.1500640894245,latMax:30.26600929375097,opacity:1},{url:"https://easyv-test.oss-cn-hangzhou.aliyuncs.com/components/static-image/smartCity3D2/image/area2.jpg",lngMin:120.14275711092705,latMin:30.25991156873724,lngMax:120.1577055422898,latMax:30.27156671401663,opacity:.3}],fields:[{name:"url",value:"url",desc:"图片地址"},{name:"lngMin",value:"lngMin",desc:"最小经度"},{name:"latMin",value:"latMin",desc:"最小纬度"},{name:"lngMax",value:"lngMax",desc:"最大经度"},{name:"latMax",value:"latMax",desc:"最大纬度"},{name:"opacity",value:"opacity",desc:"透明度"}],id:"9d8428d00513c"},{data:[{name:"地方分部",state:"正常",lng:121.138414,lat:30.058213,height:60,zoom:17},{name:"地方分部",state:"异常",lng:121.150142,lat:30.018194,height:60,zoom:17},{name:"地方分部",state:"正常",lng:121.16693,lat:30.032512,height:60,zoom:17},{name:"地方分部",state:"正常",lng:121.12106,lat:30.034512,height:60,zoom:17}],fields:[{name:"state",value:"state",desc:"状态"}],id:"8e844ae0911d1"},{data:[{name:"杭州嘉里中心",lng:120.158,lat:30.262,value:10},{name:"黄龙体育馆",lng:120.129,lat:30.269,value:30},{name:"西湖文化广场",lng:120.158,lat:30.28,value:50}],fields:[],id:"a04f01669ed5e"},{data:[],fields:[],id:"1777aa7379ed7"}]}}])}));