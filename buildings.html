<!DOCTYPE html>
<html>

<head>
    <title>建筑性能优化</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.6/build/dat.gui.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maptalks/dist/maptalks.css">
    <script type="text/javascript" src="https://unpkg.com/maptalks/dist/maptalks.js"></script>
    <!-- <script type="text/javascript" src="./js/maptalks.js"></script> -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/three@0.124.0/build/three.min.js"></script>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/libs/stats.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/maptalks.three@latest/dist/maptalks.three.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/mapbox-gl/2.9.1/mapbox-gl.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/mapbox-gl/2.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="./js/maptalks.mapboxgl.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@maptalks/gl/dist/maptalksgl.js"></script>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/libs/stats.min.js"></script>

    <style>
        html,
        body {
            margin: 0px;
            height: 100%;
            width: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: #232630;
        }
        .maptalks-attribution,
        .mapboxgl-ctrl-bottom-left,
        .mapboxgl-ctrl-bottom-right
        {
        display: none ;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        //mapbox地图加载
        mapboxgl.accessToken = 'pk.eyJ1Ijoid2FuZ2p1bjEzMDMiLCJhIjoiY2l4OHBscnYwMDAwdTJ5cWY5cnRrZGM0ZSJ9.FQy75sTd5x1dujqvTsLzvA';
        var baseLayer = new maptalks.MapboxglLayer('tile', {
            glOptions: {
                'style': 'mapbox://styles/mapbox/navigation-guidance-night-v2',
            }
        })
        var map = new maptalks.Map("map", {
            maxPitch: 60,
            center: [121.148931, 30.050727],
            zoom: 14,
            pitch: 80,
            bearing: 180,
            baseLayer: baseLayer
        });

       //自定义地图
        // const map = new maptalks.Map('map', {
        //        center: [121.148931, 30.050727],
        //         zoom: 14,
        //         pitch: 80,
        //         bearing: 180,
        //         centerCross: true,
        //         doubleClickZoom: false,

        //     });
        //     // 自定义底图
        //         var imageLayer = new maptalks.ImageLayer('images', [
        //             {
        //                 url: './data/pic/4.jpg', // 图片的路径，Vue写法
        //                 extent: [-2, -1, 0, 1], // 图片的范围四个参数分别是[xMin,yMin,xMax,yMax]
        //                 opacity: 1 //透明度
        //             },
                    
        //         ]);
        //         map.addLayer(imageLayer);


        // the ThreeLayer to draw buildings
        var threeLayer = new maptalks.ThreeLayer('t', {
            forceRenderOnMoving: true,
            forceRenderOnRotating: true,
            // animation: true
        });
        var stats;
        threeLayer.prepareToDraw = function (gl, scene, camera) {
            stats = new Stats();
            stats.domElement.style.zIndex = 100;
            document.getElementById('map').appendChild(stats.domElement);
            //设置方向光源
            var light = new THREE.DirectionalLight(0xffffff);
            // light.position.set(0, -10, 10).normalize();
            scene.add(light);
            //设置环境光源
            scene.add(new THREE.AmbientLight(0xD0DCD2, 1));
            //设置点光源
            // camera.add(new THREE.SpotLight(0xffffff, 0.2, 0, Math.PI));
            // camera.add(new THREE.PointLight('#fff', 0.5))
            loadBuilding();
            animation();
        };           
        threeLayer.addTo(map);
       

var stats
//设置建筑颜色
var buildingMeshes1 = [];
        var buildingMeshes2 = [];
        var material3 = getBuildingsMaterial3();
        function getBuildingsMaterial3() {
            //建筑贴图
            // const texture = new THREE.TextureLoader().load('./model/11.png');
            // texture.needsUpdate = true; //使用贴图时进行更新
            // texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            // // texture.repeat.set(4, 10);
            // const material = new THREE.MeshBasicMaterial({
            const material = new THREE.MeshPhongMaterial({
                // map: texture,
                transparent: true,
                // opacity:0.5,
                color:'#3f4653'
            });
            return material;
        }
        var material4 = getBuildingsMaterial4();
        function getBuildingsMaterial4() {
            // const texture2 = new THREE.TextureLoader().load('./model/11.png');
            // texture2.needsUpdate = true; //使用贴图时进行更新
            // texture2.wrapS = texture2.wrapT = THREE.RepeatWrapping;
            // texture2.repeat.set(4, 10);
             const material = new THREE.MeshPhongMaterial({
            // const material = new THREE.MeshLambertMaterial({
                // map: texture2,
                transparent: true,
                opacity: 0.8,
                color:'#2f5671',
            });
            return material;
        }
        //加载建筑geojson数据       
        const polygons = [];
        function loadBuilding() {
            fetch('./data/geojson/city.geojson').then(function (res) {
                return res.text();
            }).then(function (text) {
                return JSON.parse(text).features;
            }).then(function (features) {
                
                // var polygons =features.map(f => {
                // const polygon = maptalks.GeoJSON.toGeometry(f);
                // var heightPerLevel = 1;
                // var height= f.properties.height || 1;
                // polygon.setProperties({
                //     height: heightPerLevel * height,
                // });
                // return polygon;
            
             features.forEach(function (g) {
                var heightPerLevel = 1;
                var height = g.properties.height || 1;
                // const polygon = maptalks.GeoJSON.toGeometry(g);
                // polygons.push(polygon)
                if(height < 50) {
                var mesh3 = threeLayer.toExtrudePolygon(maptalks.GeoJSON.toGeometry(g), {
                    // var mesh3 = threeLayer.toExtrudePolygons(polygons, {
                    height: heightPerLevel * height,
                    // topColor: '#bbb',
                    // bottomColor:'#fff',
                    interactive: false
                }, material3);
                mesh3.getObject3d().layers.enable(1);
                buildingMeshes1.push(mesh3);
                
            }
             
             else if (height >= 50) {
                var mesh4 = threeLayer.toExtrudePolygon(maptalks.GeoJSON.toGeometry(g), {
                        height: heightPerLevel * height,
                        // topColor: '#fff',
                        interactive: false
                    }, material4);
                    mesh4.getObject3d().layers.enable(1);
                    buildingMeshes2.push(mesh4);        
             } 
            }); 
                threeLayer.addMesh(buildingMeshes1)
                threeLayer.addMesh(buildingMeshes2)
            });
                    }
        

        //查看fps频率渲染
        function animation() {
            // layer animation support Skipping frames
            threeLayer._needsUpdate = !threeLayer._needsUpdate;
            if (threeLayer._needsUpdate) {
                threeLayer.renderScene();
            }
            stats.update();
            requestAnimationFrame(animation);
        }


        
    </script>
</body>

</html>